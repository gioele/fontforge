<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - FontForge coverage report 2017-08-04 01:21:11+02:00 (commit d35f7e4107a9e1db65cce47c468fcc914cecb8fd) - fontforge/encoding.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">fontforge</a> - encoding.c<span style="font-size: 80%;"> (source / <a href="encoding.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">FontForge coverage report 2017-08-04 01:21:11+02:00 (commit d35f7e4107a9e1db65cce47c468fcc914cecb8fd)</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">393</td>
            <td class="headerCovTableEntry">1668</td>
            <td class="headerCovTableEntryLo">23.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-08-04</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">20</td>
            <td class="headerCovTableEntry">60</td>
            <td class="headerCovTableEntryLo">33.3 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* Copyright (C) 2000-2012 by George Williams */</a>
<span class="lineNum">       2 </span>            : /*
<span class="lineNum">       3 </span>            :  * Redistribution and use in source and binary forms, with or without
<span class="lineNum">       4 </span>            :  * modification, are permitted provided that the following conditions are met:
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            :  * Redistributions of source code must retain the above copyright notice, this
<span class="lineNum">       7 </span>            :  * list of conditions and the following disclaimer.
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            :  * Redistributions in binary form must reproduce the above copyright notice,
<span class="lineNum">      10 </span>            :  * this list of conditions and the following disclaimer in the documentation
<span class="lineNum">      11 </span>            :  * and/or other materials provided with the distribution.
<span class="lineNum">      12 </span>            : 
<span class="lineNum">      13 </span>            :  * The name of the author may not be used to endorse or promote products
<span class="lineNum">      14 </span>            :  * derived from this software without specific prior written permission.
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            :  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED
<span class="lineNum">      17 </span>            :  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
<span class="lineNum">      18 </span>            :  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO
<span class="lineNum">      19 </span>            :  * EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<span class="lineNum">      20 </span>            :  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
<span class="lineNum">      21 </span>            :  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
<span class="lineNum">      22 </span>            :  * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
<span class="lineNum">      23 </span>            :  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
<span class="lineNum">      24 </span>            :  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
<span class="lineNum">      25 </span>            :  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">      26 </span>            :  */
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #include &quot;encoding.h&quot;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &quot;bitmapchar.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;bvedit.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;dumppfa.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;fontforgevw.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;fvfonts.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;namelist.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;psread.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;splinefont.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;splinefill.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;splinesaveafm.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;splineutil.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;splineutil2.h&quot;
<span class="lineNum">      42 </span>            : #include &lt;ustring.h&gt;
<span class="lineNum">      43 </span>            : #include &lt;utype.h&gt;
<span class="lineNum">      44 </span>            : #include &lt;math.h&gt;
<span class="lineNum">      45 </span>            : #include &lt;unistd.h&gt;
<span class="lineNum">      46 </span>            : #include &lt;sys/types.h&gt;
<span class="lineNum">      47 </span>            : #include &lt;dirent.h&gt;
<span class="lineNum">      48 </span>            : #include &lt;gfile.h&gt;
<span class="lineNum">      49 </span>            : #include &quot;plugins.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;encoding.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;psfont.h&quot;
<span class="lineNum">      52 </span>            : #include &quot;ffglib.h&quot;
<span class="lineNum">      53 </span>            : #include &lt;glib/gprintf.h&gt;
<span class="lineNum">      54 </span>            : #include &quot;xvasprintf.h&quot;
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            : Encoding *default_encoding = NULL;
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span>            : static int32 tex_base_encoding[] = {
<span class="lineNum">      59 </span>            :     0x0000, 0x02d9, 0xfb01, 0xfb02, 0x2044, 0x02dd, 0x0141, 0x0142,
<span class="lineNum">      60 </span>            :     0x02db, 0x02da, 0x000a, 0x02d8, 0x2212, 0x000d, 0x017d, 0x017e,
<span class="lineNum">      61 </span>            :     0x02c7, 0x0131, 0xf6be, 0xfb00, 0xfb03, 0xfb04, 0x2260, 0x221e,
<span class="lineNum">      62 </span>            :     0x2264, 0x2265, 0x2202, 0x2211, 0x220f, 0x03c0, 0x0060, 0x0027,
<span class="lineNum">      63 </span>            :     0x0020, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x2019,
<span class="lineNum">      64 </span>            :     0x0028, 0x0029, 0x002a, 0x002b, 0x002c, 0x002d, 0x002e, 0x002f,
<span class="lineNum">      65 </span>            :     0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,
<span class="lineNum">      66 </span>            :     0x0038, 0x0039, 0x003a, 0x003b, 0x003c, 0x003d, 0x003e, 0x003f,
<span class="lineNum">      67 </span>            :     0x0040, 0x0041, 0x0042, 0x0043, 0x0044, 0x0045, 0x0046, 0x0047,
<span class="lineNum">      68 </span>            :     0x0048, 0x0049, 0x004a, 0x004b, 0x004c, 0x004d, 0x004e, 0x004f,
<span class="lineNum">      69 </span>            :     0x0050, 0x0051, 0x0052, 0x0053, 0x0054, 0x0055, 0x0056, 0x0057,
<span class="lineNum">      70 </span>            :     0x0058, 0x0059, 0x005a, 0x005b, 0x005c, 0x005d, 0x005e, 0x005f,
<span class="lineNum">      71 </span>            :     0x2018, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,
<span class="lineNum">      72 </span>            :     0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f,
<span class="lineNum">      73 </span>            :     0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,
<span class="lineNum">      74 </span>            :     0x0078, 0x0079, 0x007a, 0x007b, 0x007c, 0x007d, 0x007e, 0x007f,
<span class="lineNum">      75 </span>            :     0x20ac, 0x222b, 0x201a, 0x0192, 0x201e, 0x2026, 0x2020, 0x2021,
<span class="lineNum">      76 </span>            :     0x02c6, 0x2030, 0x0160, 0x2039, 0x0152, 0x2126, 0x221a, 0x2248,
<span class="lineNum">      77 </span>            :     0x0090, 0x0091, 0x0092, 0x201c, 0x201d, 0x2022, 0x2013, 0x2014,
<span class="lineNum">      78 </span>            :     0x02dc, 0x2122, 0x0161, 0x203a, 0x0153, 0x2206, 0x25ca, 0x0178,
<span class="lineNum">      79 </span>            :     0x0000, 0x00a1, 0x00a2, 0x00a3, 0x00a4, 0x00a5, 0x00a6, 0x00a7,
<span class="lineNum">      80 </span>            :     0x00a8, 0x00a9, 0x00aa, 0x00ab, 0x00ac, 0x002d, 0x00ae, 0x00af,
<span class="lineNum">      81 </span>            :     0x00b0, 0x00b1, 0x00b2, 0x00b3, 0x00b4, 0x00b5, 0x00b6, 0x00b7,
<span class="lineNum">      82 </span>            :     0x00b8, 0x00b9, 0x00ba, 0x00bb, 0x00bc, 0x00bd, 0x00be, 0x00bf,
<span class="lineNum">      83 </span>            :     0x00c0, 0x00c1, 0x00c2, 0x00c3, 0x00c4, 0x00c5, 0x00c6, 0x00c7,
<span class="lineNum">      84 </span>            :     0x00c8, 0x00c9, 0x00ca, 0x00cb, 0x00cc, 0x00cd, 0x00ce, 0x00cf,
<span class="lineNum">      85 </span>            :     0x00d0, 0x00d1, 0x00d2, 0x00d3, 0x00d4, 0x00d5, 0x00d6, 0x00d7,
<span class="lineNum">      86 </span>            :     0x00d8, 0x00d9, 0x00da, 0x00db, 0x00dc, 0x00dd, 0x00de, 0x00df,
<span class="lineNum">      87 </span>            :     0x00e0, 0x00e1, 0x00e2, 0x00e3, 0x00e4, 0x00e5, 0x00e6, 0x00e7,
<span class="lineNum">      88 </span>            :     0x00e8, 0x00e9, 0x00ea, 0x00eb, 0x00ec, 0x00ed, 0x00ee, 0x00ef,
<span class="lineNum">      89 </span>            :     0x00f0, 0x00f1, 0x00f2, 0x00f3, 0x00f4, 0x00f5, 0x00f6, 0x00f7,
<span class="lineNum">      90 </span>            :     0x00f8, 0x00f9, 0x00fa, 0x00fb, 0x00fc, 0x00fd, 0x00fe, 0x00ff
<span class="lineNum">      91 </span>            : };
<span class="lineNum">      92 </span>            : 
<span class="lineNum">      93 </span>            : static int32 unicode_from_MacSymbol[] = {
<span class="lineNum">      94 </span>            :   0x0000, 0x0001, 0x0002, 0x0003, 0x0004, 0x0005, 0x0006, 0x0007,
<span class="lineNum">      95 </span>            :   0x0008, 0x0009, 0x000a, 0x000b, 0x000c, 0x000d, 0x000e, 0x000f,
<span class="lineNum">      96 </span>            :   0x0010, 0x0011, 0x0012, 0x0013, 0x0014, 0x0015, 0x0016, 0x0017,
<span class="lineNum">      97 </span>            :   0x0018, 0x0019, 0x001a, 0x001b, 0x001c, 0x001d, 0x001e, 0x001f,
<span class="lineNum">      98 </span>            :   0x0020, 0x0021, 0x2200, 0x0023, 0x2203, 0x0025, 0x0026, 0x220d,
<span class="lineNum">      99 </span>            :   0x0028, 0x0029, 0x2217, 0x002b, 0x002c, 0x2212, 0x002e, 0x002f,
<span class="lineNum">     100 </span>            :   0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,
<span class="lineNum">     101 </span>            :   0x0038, 0x0039, 0x003a, 0x003b, 0x003c, 0x003d, 0x003e, 0x003f,
<span class="lineNum">     102 </span>            :   0x2245, 0x0391, 0x0392, 0x03a7, 0x0394, 0x0395, 0x03a6, 0x0393,
<span class="lineNum">     103 </span>            :   0x0397, 0x0399, 0x03d1, 0x039a, 0x039b, 0x039c, 0x039d, 0x039f,
<span class="lineNum">     104 </span>            :   0x03a0, 0x0398, 0x03a1, 0x03a3, 0x03a4, 0x03a5, 0x03c2, 0x03a9,
<span class="lineNum">     105 </span>            :   0x039e, 0x03a8, 0x0396, 0x005b, 0x2234, 0x005d, 0x22a5, 0x005f,
<span class="lineNum">     106 </span>            :   0xf8e5, 0x03b1, 0x03b2, 0x03c7, 0x03b4, 0x03b5, 0x03c6, 0x03b3,
<span class="lineNum">     107 </span>            :   0x03b7, 0x03b9, 0x03d5, 0x03ba, 0x03bb, 0x03bc, 0x03bd, 0x03bf,
<span class="lineNum">     108 </span>            :   0x03c0, 0x03b8, 0x03c1, 0x03c3, 0x03c4, 0x03c5, 0x03d6, 0x03c9,
<span class="lineNum">     109 </span>            :   0x03be, 0x03c8, 0x03b6, 0x007b, 0x007c, 0x007d, 0x223c, 0x007f,
<span class="lineNum">     110 </span>            :   0x0080, 0x0081, 0x0082, 0x0083, 0x0084, 0x0085, 0x0086, 0x0087,
<span class="lineNum">     111 </span>            :   0x0088, 0x0089, 0x008a, 0x008b, 0x008c, 0x008d, 0x008e, 0x008f,
<span class="lineNum">     112 </span>            :   0x0090, 0x0091, 0x0092, 0x0093, 0x0094, 0x0095, 0x0096, 0x0097,
<span class="lineNum">     113 </span>            :   0x0098, 0x0099, 0x009a, 0x009b, 0x009c, 0x009d, 0x009e, 0x009f,
<span class="lineNum">     114 </span>            :   0x0000, 0x03d2, 0x2032, 0x2264, 0x2044, 0x221e, 0x0192, 0x2663,
<span class="lineNum">     115 </span>            :   0x2666, 0x2665, 0x2660, 0x2194, 0x2190, 0x2191, 0x2192, 0x2193,
<span class="lineNum">     116 </span>            :   0x00b0, 0x00b1, 0x2033, 0x2265, 0x00d7, 0x221d, 0x2202, 0x2022,
<span class="lineNum">     117 </span>            :   0x00f7, 0x2260, 0x2261, 0x2248, 0x2026, 0xf8e6, 0xf8e7, 0x21b5,
<span class="lineNum">     118 </span>            :   0x2135, 0x2111, 0x211c, 0x2118, 0x2297, 0x2295, 0x2205, 0x2229,
<span class="lineNum">     119 </span>            :   0x222a, 0x2283, 0x2287, 0x2284, 0x2282, 0x2286, 0x2208, 0x2209,
<span class="lineNum">     120 </span>            :   0x2220, 0x2207, 0x00ae, 0x00a9, 0x2122, 0x220f, 0x221a, 0x22c5,
<span class="lineNum">     121 </span>            :   0x00ac, 0x2227, 0x2228, 0x21d4, 0x21d0, 0x21d1, 0x21d2, 0x21d3,
<span class="lineNum">     122 </span>            :   0x22c4, 0x2329, 0xf8e8, 0xf8e9, 0xf8ea, 0x2211, 0xf8eb, 0xf8ec,
<span class="lineNum">     123 </span>            :   0xf8ed, 0xf8ee, 0xf8ef, 0xf8f0, 0xf8f1, 0xf8f2, 0xf8f3, 0xf8f4,
<span class="lineNum">     124 </span>            :   0xf8ff, 0x232a, 0x222b, 0x2320, 0xf8f5, 0x2321, 0xf8f6, 0xf8f7,
<span class="lineNum">     125 </span>            :   0xf8f8, 0xf8f9, 0xf8fa, 0xf8fb, 0xf8fc, 0xf8fd, 0xf8fe, 0x02c7
<span class="lineNum">     126 </span>            : };
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span>            : /* I don't think iconv provides encodings for zapfdingbats nor jis201 */
<span class="lineNum">     129 </span>            : /*  Perhaps I should list them here for compatability, but I think I'll just */
<span class="lineNum">     130 </span>            : /*  leave them out. I doubt they get used. */
<span class="lineNum">     131 </span>            : static Encoding texbase = { &quot;TeX-Base-Encoding&quot;, 256, tex_base_encoding, NULL, NULL, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &quot;&quot;, 0, 0, 0, NULL, NULL, NULL, NULL, NULL, 0, 0 };
<span class="lineNum">     132 </span>            :        Encoding custom = { &quot;Custom&quot;, 0, NULL, NULL, &amp;texbase,                        1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, &quot;&quot;, 0, 0, 0, NULL, NULL, NULL, NULL, NULL, 0, 0 };
<span class="lineNum">     133 </span>            : static Encoding original = { &quot;Original&quot;, 0, NULL, NULL, &amp;custom,                     1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, &quot;&quot;, 0, 0, 0, NULL, NULL, NULL, NULL, NULL, 0, 0 };
<span class="lineNum">     134 </span>            : static Encoding unicodebmp = { &quot;UnicodeBmp&quot;, 65536, NULL, NULL, &amp;original,           1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, &quot;&quot;, 0, 0, 0, NULL, NULL, NULL, NULL, NULL, 0, 0 };
<span class="lineNum">     135 </span>            : static Encoding unicodefull = { &quot;UnicodeFull&quot;, 17*65536, NULL, NULL, &amp;unicodebmp,    1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, &quot;&quot;, 0, 0, 0, NULL, NULL, NULL, NULL, NULL, 0, 0 };
<span class="lineNum">     136 </span>            : static Encoding adobestd = { &quot;AdobeStandard&quot;, 256, unicode_from_adobestd, (char**)AdobeStandardEncoding, &amp;unicodefull,
<span class="lineNum">     137 </span>            :                                                                                      1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &quot;&quot;, 0, 0, 0, NULL, NULL, NULL, NULL, NULL, 0, 0 };
<span class="lineNum">     138 </span>            : static Encoding symbol = { &quot;Symbol&quot;, 256, unicode_from_MacSymbol, NULL, &amp;adobestd,   1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &quot;&quot;, 0, 0, 0, NULL, NULL, NULL, NULL, NULL, 0, 0 };
<span class="lineNum">     139 </span>            : 
<a name="140"><span class="lineNum">     140 </span>            : Encoding *enclist = &amp;symbol;</a>
<span class="lineNum">     141 </span>            : 
<span class="lineNum">     142 </span><span class="lineCov">        100 : const char *FindUnicharName(void) {</span>
<span class="lineNum">     143 </span>            :     /* Iconv and libiconv use different names for UCS2. Just great. Perhaps */
<span class="lineNum">     144 </span>            :     /*  different versions of each use still different names? */
<span class="lineNum">     145 </span>            :     /* Even worse, both accept UCS-2, but under iconv it means native byte */
<span class="lineNum">     146 </span>            :     /*  ordering and under libiconv it means big-endian */
<span class="lineNum">     147 </span>            :     iconv_t test;
<span class="lineNum">     148 </span>            :     static const char *goodname = NULL;
<span class="lineNum">     149 </span>            :     static const char *names[] = { &quot;UCS-4-INTERNAL&quot;, &quot;UCS-4&quot;, &quot;UCS4&quot;, &quot;ISO-10646-UCS-4&quot;, &quot;UTF-32&quot;, NULL };
<span class="lineNum">     150 </span>            :     static const char *namesle[] = { &quot;UCS-4LE&quot;, &quot;UTF-32LE&quot;, NULL };
<span class="lineNum">     151 </span>            :     static const char *namesbe[] = { &quot;UCS-4BE&quot;, &quot;UTF-32BE&quot;, NULL };
<span class="lineNum">     152 </span>            :     const char **testnames;
<span class="lineNum">     153 </span>            :     int i;
<span class="lineNum">     154 </span>            :     union {
<span class="lineNum">     155 </span>            :         short s;
<span class="lineNum">     156 </span>            :         char c[2];
<span class="lineNum">     157 </span>            :     } u;
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span><span class="lineCov">        100 :     if ( goodname!=NULL )</span>
<span class="lineNum">     160 </span><span class="lineCov">         60 : return( goodname );</span>
<span class="lineNum">     161 </span>            : 
<span class="lineNum">     162 </span><span class="lineCov">         40 :     u.c[0] = 0x1; u.c[1] = 0x2;</span>
<span class="lineNum">     163 </span><span class="lineCov">         40 :     if ( u.s==0x201 ) {         /* Little endian */</span>
<span class="lineNum">     164 </span><span class="lineCov">         40 :         testnames = namesle;</span>
<span class="lineNum">     165 </span>            :     } else {
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :         testnames = namesbe;</span>
<span class="lineNum">     167 </span>            :     }
<span class="lineNum">     168 </span><span class="lineCov">         40 :     for ( i=0; testnames[i]!=NULL; ++i ) {</span>
<span class="lineNum">     169 </span><span class="lineCov">         40 :         test = iconv_open(testnames[i],&quot;ISO-8859-1&quot;);</span>
<span class="lineNum">     170 </span><span class="lineCov">         40 :         if ( test!=(iconv_t) -1 &amp;&amp; test!=NULL ) {</span>
<span class="lineNum">     171 </span><span class="lineCov">         40 :             iconv_close(test);</span>
<span class="lineNum">     172 </span><span class="lineCov">         40 :             goodname = testnames[i];</span>
<span class="lineNum">     173 </span><span class="lineCov">         40 :     break;</span>
<span class="lineNum">     174 </span>            :         }
<span class="lineNum">     175 </span>            :     }
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span><span class="lineCov">         40 :     if ( goodname==NULL ) {</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :         for ( i=0; names[i]!=NULL; ++i ) {</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :             test = iconv_open(names[i],&quot;ISO-8859-1&quot;);</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :             if ( test!=(iconv_t) -1 &amp;&amp; test!=NULL ) {</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :                 iconv_close(test);</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :                 goodname = names[i];</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     184 </span>            :             }
<span class="lineNum">     185 </span>            :         }
<span class="lineNum">     186 </span>            :     }
<span class="lineNum">     187 </span>            : 
<span class="lineNum">     188 </span><span class="lineCov">         40 :     if ( goodname==NULL ) {</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :         IError( &quot;I can't figure out your version of iconv(). I need a name for the UCS-4 encoding and I can't find one. Reconfigure --without-iconv. Bye.&quot;);</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :         exit( 1 );</span>
<span class="lineNum">     191 </span>            :     }
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span><span class="lineCov">         40 :     test = iconv_open(goodname,&quot;Mac&quot;);</span>
<span class="lineNum">     194 </span><span class="lineCov">         40 :     if ( test==(iconv_t) -1 || test==NULL ) {</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :         IError( &quot;Your version of iconv does not support the \&quot;Mac Roman\&quot; encoding.\nIf this causes problems, reconfigure --without-iconv.&quot; );</span>
<span class="lineNum">     196 </span>            :     } else
<span class="lineNum">     197 </span><span class="lineCov">         40 :         iconv_close(test);</span>
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span>            :     /* I really should check for ISO-2022-JP, KR, CN, and all the other encodings */
<span class="lineNum">     200 </span>            :     /*  I might find in a ttf 'name' table. But those tables take too long to build */
<span class="lineNum">     201 </span><span class="lineCov">         40 : return( goodname );</span>
<a name="202"><span class="lineNum">     202 </span>            : }</a>
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span><span class="lineNoCov">          0 : static int TryEscape( Encoding *enc, const char *escape_sequence ) {</span>
<span class="lineNum">     205 </span>            :     char from[20], ucs[20];
<span class="lineNum">     206 </span>            :     size_t fromlen, tolen;
<span class="lineNum">     207 </span>            :     ICONV_CONST char *fpt;
<span class="lineNum">     208 </span>            :     char *upt;
<span class="lineNum">     209 </span>            :     int i, j, low;
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :     int esc_len = strlen(escape_sequence);</span>
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :     strcpy(from,escape_sequence);</span>
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :     enc-&gt;has_2byte = false;</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :     low = -1;</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;256; ++i ) if ( i!=escape_sequence[0] ) {</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;256; ++j ) {</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :             from[esc_len] = i; from[esc_len+1] = j; from[esc_len+2] = 0;</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :             fromlen = esc_len+2;</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :             fpt = from;</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :             upt = ucs;</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :             tolen = sizeof(ucs);</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :             if ( iconv( enc-&gt;tounicode , &amp;fpt, &amp;fromlen, &amp;upt, &amp;tolen )!= (size_t) (-1) &amp;&amp;</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :                     upt-ucs==sizeof(unichar_t) /* Exactly one character */ ) {</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :                 if ( low==-1 ) {</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :                     enc-&gt;low_page = low = i;</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :                     enc-&gt;has_2byte = true;</span>
<span class="lineNum">     228 </span>            :                 }
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :                 enc-&gt;high_page = i;</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     231 </span>            :             }
<span class="lineNum">     232 </span>            :         }
<span class="lineNum">     233 </span>            :     }
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :     if ( enc-&gt;low_page==enc-&gt;high_page )</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :         enc-&gt;has_2byte = false;</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :     if ( enc-&gt;has_2byte ) {</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :         strcpy(enc-&gt;iso_2022_escape, escape_sequence);</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :         enc-&gt;iso_2022_escape_len = esc_len;</span>
<span class="lineNum">     239 </span>            :     }
<span class="lineNum">     240 </span><span class="lineNoCov">          0 : return( enc-&gt;has_2byte );</span>
<a name="241"><span class="lineNum">     241 </span>            : }</a>
<span class="lineNum">     242 </span>            : 
<span class="lineNum">     243 </span><span class="lineCov">        540 : Encoding *_FindOrMakeEncoding(const char *name,int make_it) {</span>
<span class="lineNum">     244 </span>            :     Encoding *enc;
<span class="lineNum">     245 </span>            :     char buffer[20];
<span class="lineNum">     246 </span>            :     const char *iconv_name;
<span class="lineNum">     247 </span>            :     Encoding temp;
<span class="lineNum">     248 </span>            :     uint8 good[256];
<span class="lineNum">     249 </span>            :     int i, j, any, all;
<span class="lineNum">     250 </span>            :     char from[8], ucs[20];
<span class="lineNum">     251 </span>            :     size_t fromlen, tolen;
<span class="lineNum">     252 </span>            :     ICONV_CONST char *fpt;
<span class="lineNum">     253 </span>            :     char *upt;
<span class="lineNum">     254 </span>            :     /* iconv is not case sensitive */
<span class="lineNum">     255 </span>            : 
<span class="lineNum">     256 </span><span class="lineCov">        540 :     if ( strncasecmp(name,&quot;iso8859_&quot;,8)==0 || strncasecmp(name,&quot;koi8_&quot;,5)==0 ) {</span>
<span class="lineNum">     257 </span>            :             /* Fixup for old naming conventions */
<span class="lineNum">     258 </span><span class="lineCov">          3 :             strncpy(buffer,name,sizeof(buffer));</span>
<span class="lineNum">     259 </span><span class="lineCov">          3 :         buffer[sizeof(buffer)-1] = '\0';</span>
<span class="lineNum">     260 </span><span class="lineCov">          3 :             *strchr(buffer,'_') = '-';</span>
<span class="lineNum">     261 </span><span class="lineCov">          3 :             name = buffer;</span>
<span class="lineNum">     262 </span><span class="lineCov">        537 :     } else if ( strcasecmp(name,&quot;iso-8859&quot;)==0 ) {</span>
<span class="lineNum">     263 </span>            :             /* Fixup for old naming conventions */
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :             strncpy(buffer,name,3);</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :             strncpy(buffer+3,name+4,sizeof(buffer)-3);</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :         buffer[sizeof(buffer)-1] = '\0';</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :             name = buffer;</span>
<span class="lineNum">     268 </span><span class="lineCov">        537 :     } else if ( strcasecmp(name,&quot;isolatin10&quot;)==0 || strcasecmp(name,&quot;latin10&quot;)==0 ) {</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :         name = &quot;iso8859-16&quot;;  /* try 10 before trying 1 */</span>
<span class="lineNum">     270 </span><span class="lineCov">        537 :     } else if ( strcasecmp(name,&quot;isolatin1&quot;)==0 ) {</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :         name = &quot;iso8859-1&quot;;</span>
<span class="lineNum">     272 </span><span class="lineCov">        537 :     } else if ( strcasecmp(name,&quot;isocyrillic&quot;)==0 ) {</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         name = &quot;iso8859-5&quot;;</span>
<span class="lineNum">     274 </span><span class="lineCov">        537 :     } else if ( strcasecmp(name,&quot;isoarabic&quot;)==0 ) {</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :         name = &quot;iso8859-6&quot;;</span>
<span class="lineNum">     276 </span><span class="lineCov">        537 :     } else if ( strcasecmp(name,&quot;isogreek&quot;)==0 ) {</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :         name = &quot;iso8859-7&quot;;</span>
<span class="lineNum">     278 </span><span class="lineCov">        537 :     } else if ( strcasecmp(name,&quot;isohebrew&quot;)==0 ) {</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :         name = &quot;iso8859-8&quot;;</span>
<span class="lineNum">     280 </span><span class="lineCov">        537 :     } else if ( strcasecmp(name,&quot;isothai&quot;)==0 ) {</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :         name = &quot;tis-620&quot;;     /* TIS doesn't define non-breaking space in 0xA0 */</span>
<span class="lineNum">     282 </span><span class="lineCov">        537 :     } else if ( strcasecmp(name,&quot;latin0&quot;)==0 || strcasecmp(name,&quot;latin9&quot;)==0 ) {</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :         name = &quot;iso8859-15&quot;;  /* &quot;latin-9&quot; is supported (libiconv bug?) */</span>
<span class="lineNum">     284 </span><span class="lineCov">        537 :     } else if ( strcasecmp(name,&quot;koi8r&quot;)==0 ) {</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :         name = &quot;koi8-r&quot;;</span>
<span class="lineNum">     286 </span><span class="lineCov">        537 :     } else if ( strncasecmp(name,&quot;jis201&quot;,6)==0 || strncasecmp(name,&quot;jisx0201&quot;,8)==0 ) {</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :         name = &quot;jis_x0201&quot;;</span>
<span class="lineNum">     288 </span><span class="lineCov">        537 :     } else if ( strcasecmp(name,&quot;AdobeStandardEncoding&quot;)==0 || strcasecmp(name,&quot;Adobe&quot;)==0 )</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :         name = &quot;AdobeStandard&quot;;</span>
<span class="lineNum">     290 </span><span class="lineCov">       4758 :     for ( enc=enclist; enc!=NULL; enc=enc-&gt;next )</span>
<span class="lineNum">     291 </span><span class="lineCov">       8481 :         if ( strmatch(name,enc-&gt;enc_name)==0 ||</span>
<span class="lineNum">     292 </span><span class="lineCov">       4218 :                 (enc-&gt;iconv_name!=NULL &amp;&amp; strmatch(name,enc-&gt;iconv_name)==0))</span>
<span class="lineNum">     293 </span><span class="lineCov">         45 : return( enc );</span>
<span class="lineNum">     294 </span><span class="lineCov">        495 :     if ( strmatch(name,&quot;unicode&quot;)==0 || strmatch(name,&quot;iso10646&quot;)==0 || strmatch(name,&quot;iso10646-1&quot;)==0 )</span>
<span class="lineNum">     295 </span><span class="lineCov">        445 : return( &amp;unicodebmp );</span>
<span class="lineNum">     296 </span><span class="lineCov">         50 :     if ( strmatch(name,&quot;unicode4&quot;)==0 || strmatch(name,&quot;ucs4&quot;)==0 )</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 : return( &amp;unicodefull );</span>
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span><span class="lineCov">         50 :     iconv_name = name;</span>
<span class="lineNum">     300 </span>            :     /* Mac seems to work ok */
<span class="lineNum">     301 </span><span class="lineCov">         50 :     if ( strcasecmp(name,&quot;win&quot;)==0 || strcasecmp(name,&quot;ansi&quot;)==0 )</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :         iconv_name = &quot;MS-ANSI&quot;;               /* &quot;WINDOWS-1252&quot;;*/</span>
<span class="lineNum">     303 </span><span class="lineCov">         50 :     else if ( strncasecmp(name,&quot;jis208&quot;,6)==0 || strncasecmp(name,&quot;jisx0208&quot;,8)==0 )</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :         iconv_name = &quot;ISO-2022-JP&quot;;</span>
<span class="lineNum">     305 </span><span class="lineCov">         50 :     else if ( strncasecmp(name,&quot;jis212&quot;,6)==0 || strncasecmp(name,&quot;jisx0212&quot;,8)==0 )</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :         iconv_name = &quot;ISO-2022-JP-2&quot;;</span>
<span class="lineNum">     307 </span><span class="lineCov">         50 :     else if ( strncasecmp(name,&quot;ksc5601&quot;,7)==0 )</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :         iconv_name = &quot;ISO-2022-KR&quot;;</span>
<span class="lineNum">     309 </span><span class="lineCov">         50 :     else if ( strcasecmp(name,&quot;gb2312pk&quot;)==0 || strcasecmp(name,&quot;gb2312packed&quot;)==0 )</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :         iconv_name = &quot;EUC-CN&quot;;</span>
<span class="lineNum">     311 </span><span class="lineCov">         50 :     else if ( strncasecmp(name,&quot;gb2312&quot;,6)==0 )</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :         iconv_name = &quot;ISO-2022-CN&quot;;</span>
<span class="lineNum">     313 </span><span class="lineCov">         50 :     else if ( strcasecmp(name,&quot;wansung&quot;)==0 )</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :         iconv_name = &quot;EUC-KR&quot;;</span>
<span class="lineNum">     315 </span><span class="lineCov">         50 :     else if ( strcasecmp(name,&quot;EUC-CN&quot;)==0 ) {</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :         iconv_name = name;</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :         name = &quot;gb2312pk&quot;;</span>
<span class="lineNum">     318 </span><span class="lineCov">         50 :     } else if ( strcasecmp(name,&quot;EUC-KR&quot;)==0 ) {</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :         iconv_name = name;</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :         name = &quot;wansung&quot;;</span>
<span class="lineNum">     321 </span>            :     }
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span>            : /* Escape sequences:                                    */
<span class="lineNum">     324 </span>            : /*      ISO-2022-CN:     \e $ ) A ^N                    */
<span class="lineNum">     325 </span>            : /*      ISO-2022-KR:     \e $ ) C ^N                    */
<span class="lineNum">     326 </span>            : /*      ISO-2022-JP:     \e $ B                         */
<span class="lineNum">     327 </span>            : /*      ISO-2022-JP-2:   \e $ ( D                       */
<span class="lineNum">     328 </span>            : /*      ISO-2022-JP-3:   \e $ ( O                       */ /* Capital &quot;O&quot;, not zero */
<span class="lineNum">     329 </span>            : /*      ISO-2022-CN-EXT: \e $ ) E ^N                    */ /* Not sure about this, also uses CN escape */
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span><span class="lineCov">         50 :     memset(&amp;temp,0,sizeof(temp));</span>
<span class="lineNum">     332 </span><span class="lineCov">         50 :     temp.builtin = true;</span>
<span class="lineNum">     333 </span><span class="lineCov">         50 :     temp.tounicode = iconv_open(FindUnicharName(),iconv_name);</span>
<span class="lineNum">     334 </span><span class="lineCov">         50 :     if ( temp.tounicode==(iconv_t) -1 || temp.tounicode==NULL )</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 : return( NULL );                 /* Iconv doesn't recognize this name */</span>
<span class="lineNum">     336 </span><span class="lineCov">         50 :     temp.fromunicode = iconv_open(iconv_name,FindUnicharName());</span>
<span class="lineNum">     337 </span><span class="lineCov">         50 :     if ( temp.fromunicode==(iconv_t) -1 || temp.fromunicode==NULL ) {</span>
<span class="lineNum">     338 </span>            :         /* This should never happen, but if it does... */
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :         iconv_close(temp.tounicode);</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     341 </span>            :     }
<span class="lineNum">     342 </span>            : 
<span class="lineNum">     343 </span><span class="lineCov">         50 :     memset(good,0,sizeof(good));</span>
<span class="lineNum">     344 </span><span class="lineCov">         50 :     any = false; all = true;</span>
<span class="lineNum">     345 </span><span class="lineCov">      12800 :     for ( i=1; i&lt;256; ++i ) {</span>
<span class="lineNum">     346 </span><span class="lineCov">      12750 :         from[0] = i; from[1] = 0;</span>
<span class="lineNum">     347 </span><span class="lineCov">      12750 :         fromlen = 1;</span>
<span class="lineNum">     348 </span><span class="lineCov">      12750 :         fpt = from;</span>
<span class="lineNum">     349 </span><span class="lineCov">      12750 :         upt = ucs;</span>
<span class="lineNum">     350 </span><span class="lineCov">      12750 :         tolen = sizeof(ucs);</span>
<span class="lineNum">     351 </span><span class="lineCov">      12750 :         if ( iconv( temp.tounicode , &amp;fpt, &amp;fromlen, &amp;upt, &amp;tolen )!= (size_t) (-1)) {</span>
<span class="lineNum">     352 </span><span class="lineCov">      12750 :             good[i] = true;</span>
<span class="lineNum">     353 </span><span class="lineCov">      12750 :             any = true;</span>
<span class="lineNum">     354 </span>            :         } else
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :             all = false;</span>
<span class="lineNum">     356 </span>            :     }
<span class="lineNum">     357 </span><span class="lineCov">         50 :     if ( any )</span>
<span class="lineNum">     358 </span><span class="lineCov">         50 :         temp.has_1byte = true;</span>
<span class="lineNum">     359 </span><span class="lineCov">         50 :     if ( all )</span>
<span class="lineNum">     360 </span><span class="lineCov">         50 :         temp.only_1byte = true;</span>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineCov">         50 :     if ( !all ) {</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :         if ( strstr(iconv_name,&quot;2022&quot;)==NULL ) {</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :             for ( i=temp.has_1byte; i&lt;256; ++i ) if ( !good[i] ) {</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :                 for ( j=0; j&lt;256; ++j ) {</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :                     from[0] = i; from[1] = j; from[2] = 0;</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :                     fromlen = 2;</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :                     fpt = from;</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :                     upt = ucs;</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :                     tolen = sizeof(ucs);</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :                     if ( iconv( temp.tounicode , &amp;fpt, &amp;fromlen, &amp;upt, &amp;tolen )!= (size_t) (-1) &amp;&amp;</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :                             upt-ucs==sizeof(unichar_t) /* Exactly one character */ ) {</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :                         if ( temp.low_page==-1 )</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :                             temp.low_page = i;</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :                         temp.high_page = i;</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :                         temp.has_2byte = true;</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     378 </span>            :                     }
<span class="lineNum">     379 </span>            :                 }
<span class="lineNum">     380 </span>            :             }
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :             if ( temp.low_page==temp.high_page ) {</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :                 temp.has_2byte = false;</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :                 temp.low_page = temp.high_page = -1;</span>
<span class="lineNum">     384 </span>            :             }
<span class="lineNum">     385 </span>            :         }
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :         if ( !temp.has_2byte &amp;&amp; !good[033]/* escape */ ) {</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :             if ( strstr(iconv_name,&quot;2022&quot;)!=NULL &amp;&amp;</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :                     strstr(iconv_name,&quot;JP3&quot;)!=NULL &amp;&amp;</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :                     TryEscape( &amp;temp,&quot;\33$(O&quot; )) {</span>
<span class="lineNum">     390 </span>            :                 ;
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :             } else if ( strstr(iconv_name,&quot;2022&quot;)!=NULL &amp;&amp;</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :                     strstr(iconv_name,&quot;JP2&quot;)!=NULL &amp;&amp;</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :                     TryEscape( &amp;temp,&quot;\33$(D&quot; )) {</span>
<span class="lineNum">     394 </span>            :                 ;
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :             } else if ( strstr(iconv_name,&quot;2022&quot;)!=NULL &amp;&amp;</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                     strstr(iconv_name,&quot;JP&quot;)!=NULL &amp;&amp;</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :                     TryEscape( &amp;temp,&quot;\33$B&quot; )) {</span>
<span class="lineNum">     398 </span>            :                 ;
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :             } else if ( strstr(iconv_name,&quot;2022&quot;)!=NULL &amp;&amp;</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :                     strstr(iconv_name,&quot;KR&quot;)!=NULL &amp;&amp;</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :                     TryEscape( &amp;temp,&quot;\33$)C\16&quot; )) {</span>
<span class="lineNum">     402 </span>            :                 ;
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :             } else if ( strstr(iconv_name,&quot;2022&quot;)!=NULL &amp;&amp;</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :                     strstr(iconv_name,&quot;CN&quot;)!=NULL &amp;&amp;</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :                     TryEscape( &amp;temp,&quot;\33$)A\16&quot; )) {</span>
<span class="lineNum">     406 </span>            :                 ;
<span class="lineNum">     407 </span>            :             }
<span class="lineNum">     408 </span>            :         }
<span class="lineNum">     409 </span>            :     }
<span class="lineNum">     410 </span><span class="lineCov">         50 :     if ( !temp.has_1byte &amp;&amp; !temp.has_2byte )</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     412 </span><span class="lineCov">         50 :     if ( !make_it )</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span><span class="lineCov">         50 :     enc = chunkalloc(sizeof(Encoding));</span>
<span class="lineNum">     416 </span><span class="lineCov">         50 :     *enc = temp;</span>
<span class="lineNum">     417 </span><span class="lineCov">         50 :     enc-&gt;enc_name = copy(name);</span>
<span class="lineNum">     418 </span><span class="lineCov">         50 :     if ( iconv_name!=name )</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :         enc-&gt;iconv_name = copy(iconv_name);</span>
<span class="lineNum">     420 </span><span class="lineCov">         50 :     enc-&gt;next = enclist;</span>
<span class="lineNum">     421 </span><span class="lineCov">         50 :     enc-&gt;builtin = true;</span>
<span class="lineNum">     422 </span><span class="lineCov">         50 :     enclist = enc;</span>
<span class="lineNum">     423 </span><span class="lineCov">         50 :     if ( enc-&gt;has_2byte )</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :         enc-&gt;char_cnt = (enc-&gt;high_page&lt;&lt;8) + 256;</span>
<span class="lineNum">     425 </span>            :     else {
<span class="lineNum">     426 </span><span class="lineCov">         50 :         enc-&gt;char_cnt = 256;</span>
<span class="lineNum">     427 </span><span class="lineCov">         50 :         enc-&gt;only_1byte = true;</span>
<span class="lineNum">     428 </span>            :     }
<span class="lineNum">     429 </span><span class="lineCov">        100 :     if ( strstrmatch(iconv_name,&quot;JP&quot;)!=NULL ||</span>
<span class="lineNum">     430 </span><span class="lineCov">        100 :             strstrmatch(iconv_name,&quot;sjis&quot;)!=NULL ||</span>
<span class="lineNum">     431 </span><span class="lineCov">         50 :             strstrmatch(iconv_name,&quot;cp932&quot;)!=NULL )</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :         enc-&gt;is_japanese = true;</span>
<span class="lineNum">     433 </span><span class="lineCov">         50 :     else if ( strstrmatch(iconv_name,&quot;KR&quot;)!=NULL )</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :         enc-&gt;is_korean = true;</span>
<span class="lineNum">     435 </span><span class="lineCov">         50 :     else if ( strstrmatch(iconv_name,&quot;CN&quot;)!=NULL )</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :         enc-&gt;is_simplechinese = true;</span>
<span class="lineNum">     437 </span><span class="lineCov">         50 :     else if ( strstrmatch(iconv_name,&quot;BIG&quot;)!=NULL &amp;&amp; strstrmatch(iconv_name,&quot;5&quot;)!=NULL )</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :         enc-&gt;is_tradchinese = true;</span>
<span class="lineNum">     439 </span>            : 
<span class="lineNum">     440 </span><span class="lineCov">         90 :     if ( strstrmatch(name,&quot;ISO8859&quot;)!=NULL &amp;&amp;</span>
<span class="lineNum">     441 </span><span class="lineCov">         40 :             strtol(name+strlen(name)-2,NULL,10)&gt;=16 )</span>
<span class="lineNum">     442 </span>            :         /* Not in our menu, don't hide */;
<span class="lineNum">     443 </span><span class="lineCov">         50 :     else if ( iconv_name!=name || strmatch(name,&quot;mac&quot;)==0 || strstrmatch(name,&quot;ISO8859&quot;)!=NULL ||</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :             strmatch(name,&quot;koi8-r&quot;)==0 || strmatch(name,&quot;sjis&quot;)==0 ||</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :             strmatch(name,&quot;big5&quot;)==0 || strmatch(name,&quot;big5hkscs&quot;)==0 )</span>
<span class="lineNum">     446 </span><span class="lineCov">         50 :         enc-&gt;hidden = true;</span>
<span class="lineNum">     447 </span>            : 
<span class="lineNum">     448 </span><span class="lineCov">         50 : return( enc );</span>
<a name="449"><span class="lineNum">     449 </span>            : }</a>
<span class="lineNum">     450 </span>            : 
<span class="lineNum">     451 </span><span class="lineCov">        540 : Encoding *FindOrMakeEncoding(const char *name) {</span>
<span class="lineNum">     452 </span><span class="lineCov">        540 : return( _FindOrMakeEncoding(name,true));</span>
<span class="lineNum">     453 </span>            : }
<a name="454"><span class="lineNum">     454 </span>            : </a>
<span class="lineNum">     455 </span>            : /* Plugin API */
<span class="lineNum">     456 </span><span class="lineNoCov">          0 : int AddEncoding(char *name,EncFunc enc_to_uni,EncFunc uni_to_enc,int max) {</span>
<span class="lineNum">     457 </span>            :     Encoding *enc;
<span class="lineNum">     458 </span>            :     int i;
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :     for ( enc=enclist; enc!=NULL; enc=enc-&gt;next ) {</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :         if ( strmatch(name,enc-&gt;enc_name)==0 ||</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :                 (enc-&gt;iconv_name!=NULL &amp;&amp; strmatch(name,enc-&gt;iconv_name)==0)) {</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :             if ( enc-&gt;tounicode_func==NULL )</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 : return( 0 );                    /* Failure */</span>
<span class="lineNum">     465 </span>            :             else {
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                 enc-&gt;tounicode_func   = enc_to_uni;</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :                 enc-&gt;fromunicode_func = uni_to_enc;</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :                 enc-&gt;char_cnt              = max;</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 : return( 2 );</span>
<span class="lineNum">     470 </span>            :             }
<span class="lineNum">     471 </span>            :         }
<span class="lineNum">     472 </span>            :     }
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     if ( strmatch(name,&quot;unicode&quot;)==0 || strmatch(name,&quot;iso10646&quot;)==0 || strmatch(name,&quot;iso10646-1&quot;)==0 )</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 : return( 0 );                    /* Failure */</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :     if ( strmatch(name,&quot;unicode4&quot;)==0 || strmatch(name,&quot;ucs4&quot;)==0 )</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 : return( 0 );                    /* Failure */</span>
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :     enc = chunkalloc(sizeof(Encoding));</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :     enc-&gt;enc_name = copy(name);</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :     enc-&gt;next = enclist;</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :     enclist = enc;</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :     enc-&gt;tounicode_func   = enc_to_uni;</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :     enc-&gt;fromunicode_func = uni_to_enc;</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :     enc-&gt;char_cnt          = max;</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;256 &amp;&amp; i&lt;max; ++i )</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :         if ( enc_to_uni(i)!=-1 )</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :     if ( i&lt;256 &amp;&amp; i&lt;max )</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :         enc-&gt;has_1byte = true;</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :     if ( max&lt;256 )</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :         enc-&gt;only_1byte = true;</span>
<span class="lineNum">     494 </span>            :     else
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :         enc-&gt;has_2byte = true;</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 : return( 1 );</span>
<a name="497"><span class="lineNum">     497 </span>            : }</a>
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span><span class="lineCov">          1 : static char *getPfaEditEncodings(void) {</span>
<span class="lineNum">     500 </span>            :     static char *encfile=NULL;
<span class="lineNum">     501 </span>            :     char buffer[1025];
<span class="lineNum">     502 </span>            :     char *ffdir;
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span><span class="lineCov">          1 :     if ( encfile!=NULL )</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :         return encfile;</span>
<span class="lineNum">     506 </span><span class="lineCov">          1 :     ffdir = getFontForgeUserDir(Config);</span>
<span class="lineNum">     507 </span><span class="lineCov">          1 :     if ( ffdir==NULL )</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">     509 </span><span class="lineCov">          1 :     sprintf(buffer,&quot;%s/Encodings.ps&quot;, ffdir);</span>
<span class="lineNum">     510 </span><span class="lineCov">          1 :     free(ffdir);</span>
<span class="lineNum">     511 </span><span class="lineCov">          1 :     encfile = copy(buffer);</span>
<span class="lineNum">     512 </span><span class="lineCov">          1 :     return encfile;</span>
<a name="513"><span class="lineNum">     513 </span>            : }</a>
<span class="lineNum">     514 </span>            : 
<span class="lineNum">     515 </span><span class="lineNoCov">          0 : void EncodingFree(Encoding *item) {</span>
<span class="lineNum">     516 </span>            :     int i;
<span class="lineNum">     517 </span>            : 
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :     if ( item==NULL )</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     520 </span>            : 
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :     free(item-&gt;enc_name);</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :     if ( item-&gt;psnames!=NULL ) {</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;item-&gt;char_cnt; ++i )</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :             free(item-&gt;psnames[i]);</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :         free(item-&gt;psnames);</span>
<span class="lineNum">     526 </span>            :     }
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :     free(item-&gt;unicode);</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :     free(item);</span>
<a name="529"><span class="lineNum">     529 </span>            : }</a>
<span class="lineNum">     530 </span>            : 
<span class="lineNum">     531 </span><span class="lineNoCov">          0 : void DeleteEncoding(Encoding *me) {</span>
<span class="lineNum">     532 </span>            :     FontViewBase *fv;
<span class="lineNum">     533 </span>            :     Encoding *prev;
<span class="lineNum">     534 </span>            : 
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :     if ( me-&gt;builtin )</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     537 </span>            : 
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :     for ( fv = FontViewFirst(); fv!=NULL; fv = fv-&gt;next ) {</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :         if ( fv-&gt;map-&gt;enc==me )</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :             fv-&gt;map-&gt;enc = &amp;custom;</span>
<span class="lineNum">     541 </span>            :     }
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :     if ( me==enclist )</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :         enclist = me-&gt;next;</span>
<span class="lineNum">     544 </span>            :     else {
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :         for ( prev = enclist; prev!=NULL &amp;&amp; prev-&gt;next!=me; prev=prev-&gt;next );</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :         if ( prev!=NULL ) prev-&gt;next = me-&gt;next;</span>
<span class="lineNum">     547 </span>            :     }
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :     EncodingFree(me);</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :     if ( default_encoding == me )</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :         default_encoding = FindOrMakeEncoding(&quot;ISO8859-1&quot;);</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :     if ( default_encoding == NULL )</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :         default_encoding = &amp;custom;</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :     DumpPfaEditEncodings();</span>
<span class="lineNum">     554 </span>            : }
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span>            : /* Parse a TXT file from the unicode consortium */
<span class="lineNum">     557 </span>            :     /* Unicode Consortium Format A */
<span class="lineNum">     558 </span>            :     /* List of lines with several fields, */
<a name="559"><span class="lineNum">     559 </span>            :         /* first is the encoding value (in hex), second the Unicode value (in hex) */</a>
<span class="lineNum">     560 </span>            :     /* # is a comment character (to eol) */
<span class="lineNum">     561 </span><span class="lineNoCov">          0 : static Encoding *ParseConsortiumEncodingFile(FILE *file) {</span>
<span class="lineNum">     562 </span>            :     char buffer[200];
<span class="lineNum">     563 </span>            :     int32 encs[0x10000];
<span class="lineNum">     564 </span>            :     int enc, unienc, max;
<span class="lineNum">     565 </span>            :     Encoding *item;
<span class="lineNum">     566 </span>            : 
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :     memset(encs, 0, sizeof(encs));</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :     max = -1;</span>
<span class="lineNum">     569 </span>            : 
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :     while ( fgets(buffer,sizeof(buffer),file)!=NULL ) {</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :         if ( ishexdigit(buffer[0]) ) {</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :             if ( sscanf(buffer, &quot;%x %x&quot;, (unsigned *) &amp;enc, (unsigned *) &amp;unienc)==2 &amp;&amp;</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :                     enc&lt;0x10000 &amp;&amp; enc&gt;=0 ) {</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :                 encs[enc] = unienc;</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :                 if ( enc&gt;max ) max = enc;</span>
<span class="lineNum">     576 </span>            :             }
<span class="lineNum">     577 </span>            :         }
<span class="lineNum">     578 </span>            :     }
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :     if ( max==-1 )</span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     582 </span>            : 
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :     ++max;</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :     if ( max&lt;256 ) max = 256;</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :     item = calloc(1,sizeof(Encoding));</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :     item-&gt;only_1byte = item-&gt;has_1byte = true;</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :     item-&gt;char_cnt = max;</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :     item-&gt;unicode = malloc(max*sizeof(int32));</span>
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :     memcpy(item-&gt;unicode,encs,max*sizeof(int32));</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 : return( item );</span>
<span class="lineNum">     591 </span>            : }
<span class="lineNum">     592 </span>            : 
<span class="lineNum">     593 </span>            : /**
<span class="lineNum">     594 </span>            :  *  \brief Parses a GlyphOrderAndAliasDB encoding file
<span class="lineNum">     595 </span>            :  *
<span class="lineNum">     596 </span>            :  *  \param [in] file The file handle to the encoding file
<span class="lineNum">     597 </span>            :  *  \return The encoding, or NULL if none could be made
<span class="lineNum">     598 </span>            :  *
<span class="lineNum">     599 </span>            :  *  \details Each line in the file contains one glyph name (equating to one slot).
<span class="lineNum">     600 </span>            :  *           It is assumed that values are tab separated. There
<span class="lineNum">     601 </span>            :  *           are at least two columns, with a third column being optional.
<span class="lineNum">     602 </span>            :  *           The first column is the glyph name to be used on output. This
<span class="lineNum">     603 </span>            :  *           is what will normally be used to determine the unicode value for
<span class="lineNum">     604 </span>            :  *           this slot.
<span class="lineNum">     605 </span>            :  *           The second column is the 'friendly' name - this is what will
<span class="lineNum">     606 </span>            :  *           be used for the slot's name.
<span class="lineNum">     607 </span>            :  *           The third, optional column specifies the unicode value that the
<span class="lineNum">     608 </span>            :  *           slot should map to. When available, this will be used in preference
<a name="609"><span class="lineNum">     609 </span>            :  *           to the first column.</a>
<span class="lineNum">     610 </span>            :  */
<span class="lineNum">     611 </span><span class="lineNoCov">          0 : static Encoding *ParseGlyphOrderAndAliasDB(FILE *file) {</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :     GArray *enc_arr = g_array_sized_new(FALSE, TRUE, sizeof(int32), 256);</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :     GArray *names_arr = g_array_sized_new(FALSE, TRUE, sizeof(char *), 256);</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :     Encoding *item = NULL;</span>
<span class="lineNum">     615 </span>            :     char buffer[BUFSIZ];
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :     int enc, any = FALSE, has_1byte = FALSE;</span>
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :     while (fgets(buffer, sizeof(buffer), file)) {</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :         char *split = strchr(buffer, '\t'), *split2, *enc_name = NULL;</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :         if (split == NULL) {</span>
<span class="lineNum">     621 </span>            :             // Skip entries that do not contain at least two (tab separated) values
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :             LogError(_(&quot;ParseGlyphOrderAndAliasDB: Invalid (non-tab separated entry) at index %d: %s\n&quot;), enc_arr-&gt;len, g_strstrip(buffer));</span>
<span class="lineNum">     623 </span>            :             //enc = -1;
<span class="lineNum">     624 </span>            :             //g_array_append_val(enc_arr, enc);
<span class="lineNum">     625 </span>            :             //g_array_append_val(names_arr, enc_name);
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     627 </span>            :         }
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :         *split++ = '\0';</span>
<span class="lineNum">     629 </span>            :         // Buffer now contains the first column
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :         g_strstrip(buffer);</span>
<span class="lineNum">     631 </span>            :         // split contains the second, and possibly the third column
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :         g_strstrip(split);</span>
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span>            :         // Optional third column
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :         split2 = strchr(split, '\t');</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :         if (split2 != NULL) {</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :             *split2++ = '\0';</span>
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :             g_strstrip(split2);</span>
<span class="lineNum">     639 </span>            :         }
<span class="lineNum">     640 </span>            : 
<span class="lineNum">     641 </span>            :         // Use the third column in preference to the first
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :         enc = UniFromName((split2 != NULL) ? split2 : buffer, ui_none, &amp;custom);</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :         if (split[0] != '\0') {</span>
<span class="lineNum">     644 </span>            :             /* Used not to do this, but there are several legal names */
<span class="lineNum">     645 </span>            :             /*  for some slots and people get unhappy (rightly) if we */
<span class="lineNum">     646 </span>            :             /*  use the wrong one */
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :             enc_name = copy(split);</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :             any = TRUE;</span>
<span class="lineNum">     649 </span>            :         }
<span class="lineNum">     650 </span>            : 
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :         if (enc != -1 &amp;&amp; enc_arr-&gt;len &lt; 256) {</span>
<span class="lineNum">     652 </span>            :             // We have a valid encoding within the first 256 entries
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :             has_1byte = TRUE;</span>
<span class="lineNum">     654 </span>            :         }
<span class="lineNum">     655 </span>            : 
<span class="lineNum">     656 </span>            :         // Append entry to our arrays
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :         g_array_append_val(enc_arr, enc);</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :         g_array_append_val(names_arr, enc_name);</span>
<span class="lineNum">     659 </span>            :     }
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :     if (enc_arr-&gt;len &gt; 0) {</span>
<span class="lineNum">     662 </span>            :         // If we have mappings, we make an encoding.
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :         char *tmp_name = ff_ask_string(_(&quot;Encoding name&quot;), &quot;GlyphOrderAndAliasDB&quot;, _(&quot;Please name this encoding&quot;));</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :         if (tmp_name != NULL) {</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :             if (tmp_name[0] == '\0') {</span>
<span class="lineNum">     666 </span>            :                 // Encodings must be named.
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :                 free(tmp_name);</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :                 tmp_name = NULL;</span>
<span class="lineNum">     669 </span>            :             } else {
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :                 item = calloc(1, sizeof(Encoding));</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :                 item-&gt;enc_name = tmp_name;</span>
<span class="lineNum">     672 </span>            :                 // We pad the map in accordance with existing code in FindOrMakeEncoding and elsewhere.
<span class="lineNum">     673 </span>            :                 // Nobody knows why.
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :                 item-&gt;char_cnt = (enc_arr-&gt;len &lt; 256) ? 256 : enc_arr-&gt;len;</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :                 item-&gt;unicode = malloc(item-&gt;char_cnt * sizeof(int32));</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :                 memcpy(item-&gt;unicode, enc_arr-&gt;data, enc_arr-&gt;len * sizeof(int32));</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :                 if (item-&gt;char_cnt &gt; enc_arr-&gt;len) {</span>
<span class="lineNum">     678 </span>            :                     // Pad the unfilled entries with -1
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :                     memset(item-&gt;unicode + enc_arr-&gt;len, -1, sizeof(int32) * (enc_arr-&gt;len - item-&gt;char_cnt));</span>
<span class="lineNum">     680 </span>            :                 }
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :                 if (any) {</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :                     item-&gt;psnames = calloc(item-&gt;char_cnt, sizeof(char *));</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :                     memcpy(item-&gt;psnames, names_arr-&gt;data, names_arr-&gt;len * sizeof(char *));</span>
<span class="lineNum">     684 </span>            :                 }
<span class="lineNum">     685 </span>            : 
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :                 item-&gt;is_custom = TRUE;</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :                 item-&gt;has_1byte = has_1byte;</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :                 if (enc_arr-&gt;len &lt; 256) {</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :                     item-&gt;only_1byte = TRUE;</span>
<span class="lineNum">     690 </span>            :                 } else {
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :                     item-&gt;has_2byte = TRUE;</span>
<span class="lineNum">     692 </span>            :                 }
<span class="lineNum">     693 </span>            :             }
<span class="lineNum">     694 </span>            :         }
<span class="lineNum">     695 </span>            :     }
<span class="lineNum">     696 </span>            : 
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :     g_array_free(enc_arr, TRUE);</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :     g_array_free(names_arr, TRUE);</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :     return item;</span>
<a name="700"><span class="lineNum">     700 </span>            : }</a>
<span class="lineNum">     701 </span>            : 
<span class="lineNum">     702 </span><span class="lineNoCov">          0 : void RemoveMultiples(Encoding *item) {</span>
<span class="lineNum">     703 </span>            :     Encoding *test;
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :     for ( test=enclist; test!=NULL; test = test-&gt;next ) {</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :         if ( strcmp(test-&gt;enc_name,item-&gt;enc_name)==0 )</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     708 </span>            :     }
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :     if ( test!=NULL )</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :         DeleteEncoding(test);</span>
<a name="711"><span class="lineNum">     711 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     712 </span>            : 
<span class="lineNum">     713 </span><span class="lineCov">          1 : char *ParseEncodingFile(char *filename, char *encodingname) {</span>
<span class="lineNum">     714 </span>            :     FILE *file;
<span class="lineNum">     715 </span><span class="lineCov">          1 :     char *orig = filename;</span>
<span class="lineNum">     716 </span>            :     Encoding *head, *item, *prev, *next;
<span class="lineNum">     717 </span>            :     char *buf, *name;
<span class="lineNum">     718 </span>            :     int i,ch;
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span><span class="lineCov">          1 :     if ( filename==NULL ) filename = getPfaEditEncodings();</span>
<span class="lineNum">     721 </span><span class="lineCov">          1 :     file = fopen(filename,&quot;r&quot;);</span>
<span class="lineNum">     722 </span><span class="lineCov">          1 :     if ( file==NULL ) {</span>
<span class="lineNum">     723 </span><span class="lineCov">          1 :         if ( orig!=NULL )</span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :             ff_post_error(_(&quot;Couldn't open file&quot;), _(&quot;Couldn't open file %.200s&quot;), orig);</span>
<span class="lineNum">     725 </span><span class="lineCov">          1 : return( NULL );</span>
<span class="lineNum">     726 </span>            :     }
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :     ch = getc(file);</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :     if ( ch==EOF ) {</span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :         fclose(file);</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     731 </span>            :     }
<span class="lineNum">     732 </span>            : 
<span class="lineNum">     733 </span>            :     /* Here we detect file format and decide which format
<span class="lineNum">     734 </span>            :        parsing routine to actually use.
<span class="lineNum">     735 </span>            :     */
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :     ungetc(ch, file);</span>
<span class="lineNum">     737 </span>            : 
<span class="lineNum">     738 </span>            : 
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :     if(strlen(filename) &gt;= 20</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :        &amp;&amp; !strcmp(filename + strlen(filename) - 20, &quot;GlyphOrderAndAliasDB&quot;)){</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :         head = ParseGlyphOrderAndAliasDB(file);</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :     } else if (ch=='#' || ch=='0') {</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :         head = ParseConsortiumEncodingFile(file);</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :         if(encodingname)</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :             head-&gt;enc_name = copy(encodingname);</span>
<span class="lineNum">     746 </span>            :     } else {
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :         head = PSSlurpEncodings(file);</span>
<span class="lineNum">     748 </span>            :     }
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :     fclose(file);</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :     if ( head==NULL ) {</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :         ff_post_error(_(&quot;Bad encoding file format&quot;),_(&quot;Bad encoding file format&quot;) );</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :         return( NULL );</span>
<span class="lineNum">     753 </span>            :     }
<span class="lineNum">     754 </span>            : 
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :     for ( i=0, prev=NULL, item=head; item!=NULL; prev = item, item=next, ++i ) {</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :         next = item-&gt;next;</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :         if ( item-&gt;enc_name==NULL ) {</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :             if ( no_windowing_ui ) {</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :                 ff_post_error(_(&quot;Bad encoding file format&quot;),_(&quot;This file contains an unnamed encoding, which cannot be named in a script&quot;));</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :                 return( NULL );</span>
<span class="lineNum">     761 </span>            :             }
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :             if ( item==head &amp;&amp; item-&gt;next==NULL )</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :                 buf = strdup(_( &quot;Please name this encoding&quot; ));</span>
<span class="lineNum">     764 </span>            :             else
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :                 buf = xasprintf(_( &quot;Please name encoding %d in this file&quot; ), i );</span>
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :             name = ff_ask_string( buf, NULL, buf );</span>
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :             if ( name!=NULL ) {</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :                 item-&gt;enc_name = copy(name);</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :                 free(name);</span>
<span class="lineNum">     772 </span>            :             } else {
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :                 if ( prev==NULL )</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :                     head = item-&gt;next;</span>
<span class="lineNum">     775 </span>            :                 else
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :                     prev-&gt;next = item-&gt;next;</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :                 EncodingFree(item);</span>
<span class="lineNum">     778 </span>            :             }
<span class="lineNum">     779 </span>            :         }
<span class="lineNum">     780 </span>            :     }
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :     for ( item=head; item!=NULL; item=item-&gt;next )</span>
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :         RemoveMultiples(item);</span>
<span class="lineNum">     783 </span>            : 
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :     if ( enclist == NULL )</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :         enclist = head;</span>
<span class="lineNum">     786 </span>            :     else {
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :         for ( item=enclist; item-&gt;next!=NULL; item=item-&gt;next );</span>
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :         item-&gt;next = head;</span>
<span class="lineNum">     789 </span>            :     }
<span class="lineNum">     790 </span><span class="lineNoCov">          0 : return( copy( head-&gt;enc_name ) );</span>
<a name="791"><span class="lineNum">     791 </span>            : }</a>
<span class="lineNum">     792 </span>            : 
<span class="lineNum">     793 </span><span class="lineCov">          1 : void LoadPfaEditEncodings(void) {</span>
<span class="lineNum">     794 </span><span class="lineCov">          1 :     free(ParseEncodingFile(NULL, NULL));</span>
<a name="795"><span class="lineNum">     795 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     796 </span>            : 
<span class="lineNum">     797 </span><span class="lineNoCov">          0 : void DumpPfaEditEncodings(void) {</span>
<span class="lineNum">     798 </span>            :     FILE *file;
<span class="lineNum">     799 </span>            :     Encoding *item;
<span class="lineNum">     800 </span>            :     int i;
<span class="lineNum">     801 </span>            :     char buffer[80];
<span class="lineNum">     802 </span>            : 
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :     for ( item=enclist; item!=NULL &amp;&amp; item-&gt;builtin; item=item-&gt;next );</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :     if ( item==NULL ) {</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :         unlink(getPfaEditEncodings());</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     807 </span>            :     }
<span class="lineNum">     808 </span>            : 
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :     file = fopen( getPfaEditEncodings(), &quot;w&quot;);</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :     if ( file==NULL ) {</span>
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :         LogError( _(&quot;couldn't write encodings file\n&quot;) );</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     813 </span>            :     }
<span class="lineNum">     814 </span>            : 
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :     for ( item=enclist; item!=NULL; item = item-&gt;next ) if ( !item-&gt;builtin &amp;&amp; item-&gt;tounicode_func==NULL ) {</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :         fprintf( file, &quot;/%s [\n&quot;, item-&gt;enc_name );</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :         if ( item-&gt;psnames==NULL )</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :             fprintf( file, &quot;%% Use codepoints.\n&quot; );</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;item-&gt;char_cnt; ++i ) {</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :             if ( item-&gt;psnames!=NULL &amp;&amp; item-&gt;psnames[i]!=NULL )</span>
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :                 fprintf( file, &quot; /%s&quot;, item-&gt;psnames[i]);</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :             else if ( item-&gt;unicode[i]&lt;' ' || (item-&gt;unicode[i]&gt;=0x7f &amp;&amp; item-&gt;unicode[i]&lt;0xa0))</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :                 fprintf( file, &quot; /.notdef&quot; );</span>
<span class="lineNum">     824 </span>            :             else
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :                 fprintf( file, &quot; /%s&quot;, StdGlyphName(buffer,item-&gt;unicode[i],ui_none,(NameList *) -1));</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :             if ( (i&amp;0xf)==0 )</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :                 fprintf( file, &quot;\t\t%% 0x%02x\n&quot;, i );</span>
<span class="lineNum">     828 </span>            :             else
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :                 putc('\n',file);</span>
<span class="lineNum">     830 </span>            :         }
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :         fprintf( file, &quot;] def\n\n&quot; );</span>
<span class="lineNum">     832 </span>            :     }
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :     fclose(file);</span>
<span class="lineNum">     834 </span>            : }
<span class="lineNum">     835 </span>            : 
<span class="lineNum">     836 </span>            : /* ************************************************************************** */
<span class="lineNum">     837 </span>            : /* ****************************** CID Encodings ***************************** */
<span class="lineNum">     838 </span>            : /* ************************************************************************** */
<a name="839"><span class="lineNum">     839 </span>            : struct cidmap *cidmaps = NULL;</a>
<span class="lineNum">     840 </span>            : 
<span class="lineNum">     841 </span><span class="lineNoCov">          0 : int CIDFromName(char *name,SplineFont *cidmaster) {</span>
<span class="lineNum">     842 </span>            :     /* We've had various conventions for encoding a cid inside a name */
<span class="lineNum">     843 </span>            :     /* I'm primarily interested in this when the name is something like */
<span class="lineNum">     844 </span>            :     /*  Japan1.504.vert */
<span class="lineNum">     845 </span>            :     /* which tells me that the current glyph is the rotated version of */
<span class="lineNum">     846 </span>            :     /*  cid 504 */
<span class="lineNum">     847 </span>            :     /* Other convention &quot;cid-504.vert&quot; */
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :     int len = strlen( cidmaster-&gt;ordering );</span>
<span class="lineNum">     849 </span>            :     int cid;
<span class="lineNum">     850 </span>            :     char *end;
<span class="lineNum">     851 </span>            : 
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :     if ( strncmp(name,cidmaster-&gt;ordering,len)==0 ) {</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :         if ( name[len]=='.' ) ++len;</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :     } else if ( strncmp(name,&quot;cid-&quot;,4)==0 ) {</span>
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :         len = 4;</span>
<span class="lineNum">     856 </span>            :     } else
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :         len = 0;</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :     cid = strtol(name+len,&amp;end,10);</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :     if ( end==name+len )</span>
<span class="lineNum">     860 </span><span class="lineNoCov">          0 : return( -1 );</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :     if ( *end!='.' &amp;&amp; *end!='\0' )</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 : return( -1 );</span>
<span class="lineNum">     863 </span>            : 
<span class="lineNum">     864 </span><span class="lineNoCov">          0 : return ( cid );</span>
<a name="865"><span class="lineNum">     865 </span>            : }</a>
<span class="lineNum">     866 </span>            : 
<span class="lineNum">     867 </span><span class="lineNoCov">          0 : int CID2Uni(struct cidmap *map,int cid) {</span>
<span class="lineNum">     868 </span>            :     unsigned int uni;
<span class="lineNum">     869 </span>            : 
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :     if ( map==NULL )</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 : return( -1 );</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :     else if ( cid==0 )</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 : return( 0 );</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :     else if ( cid&lt;map-&gt;namemax &amp;&amp; map-&gt;unicode[cid]!=0 )</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 : return( map-&gt;unicode[cid] );</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :     else if ( cid&lt;map-&gt;namemax &amp;&amp; map-&gt;name[cid]!=NULL ) {</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :         if ( sscanf(map-&gt;name[cid],&quot;uni%x&quot;, &amp;uni )==1 )</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 : return( uni );</span>
<span class="lineNum">     879 </span>            :     }
<span class="lineNum">     880 </span>            : 
<span class="lineNum">     881 </span><span class="lineNoCov">          0 : return( -1 );</span>
<a name="882"><span class="lineNum">     882 </span>            : }</a>
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span><span class="lineCov">       2549 : int CID2NameUni(struct cidmap *map,int cid, char *buffer, int len) {</span>
<span class="lineNum">     885 </span><span class="lineCov">       2549 :     int enc = -1;</span>
<span class="lineNum">     886 </span>            :     const char *temp;
<span class="lineNum">     887 </span>            : 
<span class="lineNum">     888 </span><span class="lineCov">       2549 :     if ( map==NULL )</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :         snprintf(buffer,len,&quot;cid-%d&quot;, cid);</span>
<span class="lineNum">     890 </span><span class="lineCov">       2549 :     else if ( cid&lt;map-&gt;namemax &amp;&amp; map-&gt;name[cid]!=NULL ) {</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :         strncpy(buffer,map-&gt;name[cid],len);</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :         buffer[len-1] = '\0';</span>
<span class="lineNum">     893 </span><span class="lineCov">       2549 :     } else if ( cid==0 )</span>
<span class="lineNum">     894 </span><span class="lineCov">          1 :         strcpy(buffer,&quot;.notdef&quot;);</span>
<span class="lineNum">     895 </span><span class="lineCov">       2548 :     else if ( cid&lt;map-&gt;namemax &amp;&amp; map-&gt;unicode[cid]!=0 ) {</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :         if ( map-&gt;unicode==NULL || map-&gt;namemax==0 )</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :             enc = 0;</span>
<span class="lineNum">     898 </span>            :         else
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :             enc = map-&gt;unicode[cid];</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :         temp = StdGlyphName(buffer,enc,ui_none,(NameList *) -1);</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :         if ( temp!=buffer )</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :             strcpy(buffer,temp);</span>
<span class="lineNum">     903 </span>            :     } else
<span class="lineNum">     904 </span><span class="lineCov">       2548 :         snprintf(buffer,len,&quot;%s.%d&quot;, map-&gt;ordering, cid);</span>
<span class="lineNum">     905 </span><span class="lineCov">       2549 : return( enc );</span>
<a name="906"><span class="lineNum">     906 </span>            : }</a>
<span class="lineNum">     907 </span>            : 
<span class="lineNum">     908 </span><span class="lineCov">        517 : int NameUni2CID(struct cidmap *map, int uni, const char *name) {</span>
<span class="lineNum">     909 </span>            :     int i;
<span class="lineNum">     910 </span>            :     struct cidaltuni *alts;
<span class="lineNum">     911 </span>            : 
<span class="lineNum">     912 </span><span class="lineCov">        517 :     if ( map==NULL )</span>
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :                 return( -1 );</span>
<span class="lineNum">     914 </span><span class="lineCov">        517 :     if ( uni!=-1 ) {</span>
<span class="lineNum">     915 </span>            :                 // Search for a matching code.
<span class="lineNum">     916 </span><span class="lineCov">        517 :                 for ( i=0; i&lt;map-&gt;namemax; ++i )</span>
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :                     if ( map-&gt;unicode[i]==(uint32)uni )</span>
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :                                 return( i );</span>
<span class="lineNum">     919 </span><span class="lineCov">        517 :                 for ( alts=map-&gt;alts; alts!=NULL; alts=alts-&gt;next )</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :                     if ( alts-&gt;uni==uni )</span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :                                 return( alts-&gt;cid );</span>
<span class="lineNum">     922 </span>            :     } else {
<span class="lineNum">     923 </span>            :         // Search for a matching name.
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :         if ( name!=NULL )</span>
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;map-&gt;namemax; ++i )</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :                 if ( map-&gt;name[i]!=NULL &amp;&amp; strcmp(map-&gt;name[i],name)==0 )</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :                     return( i );</span>
<span class="lineNum">     928 </span>            :     }
<span class="lineNum">     929 </span><span class="lineCov">        517 :         return( -1 );</span>
<a name="930"><span class="lineNum">     930 </span>            : }</a>
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span><span class="lineCov">       2549 : struct altuni *CIDSetAltUnis(struct cidmap *map,int cid) {</span>
<span class="lineNum">     933 </span>            :     /* Some CIDs are mapped to several unicode code points, damn it */
<span class="lineNum">     934 </span><span class="lineCov">       2549 :     struct altuni *sofar = NULL, *alt;</span>
<span class="lineNum">     935 </span>            :     struct cidaltuni *alts;
<span class="lineNum">     936 </span>            : 
<span class="lineNum">     937 </span><span class="lineCov">       2549 :     for ( alts=map-&gt;alts; alts!=NULL; alts=alts-&gt;next ) {</span>
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :         if ( alts-&gt;cid==cid ) {</span>
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :             alt = chunkalloc(sizeof(struct altuni));</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :             alt-&gt;next = sofar;</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :             sofar = alt;</span>
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :             alt-&gt;unienc = alts-&gt;uni;</span>
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :             alt-&gt;vs = -1;</span>
<span class="lineNum">     944 </span>            :         }
<span class="lineNum">     945 </span>            :     }
<span class="lineNum">     946 </span><span class="lineCov">       2549 : return( sofar );</span>
<a name="947"><span class="lineNum">     947 </span>            : }</a>
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span><span class="lineNoCov">          0 : int MaxCID(struct cidmap *map) {</span>
<span class="lineNum">     950 </span><span class="lineNoCov">          0 : return( map-&gt;cidmax );</span>
<a name="951"><span class="lineNum">     951 </span>            : }</a>
<span class="lineNum">     952 </span>            : 
<span class="lineNum">     953 </span><span class="lineCov">          2 : static char *SearchDirForCidMap(const char *dir,char *registry,char *ordering,</span>
<span class="lineNum">     954 </span>            :         int supplement,char **maybefile) {
<span class="lineNum">     955 </span>            :     char maybe[FILENAME_MAX+1];
<span class="lineNum">     956 </span>            :     struct dirent *ent;
<span class="lineNum">     957 </span>            :     DIR *d;
<span class="lineNum">     958 </span><span class="lineCov">          2 :     int len, rlen = strlen(registry), olen=strlen(ordering);</span>
<span class="lineNum">     959 </span>            :     char *pt, *end, *ret;
<span class="lineNum">     960 </span><span class="lineCov">          2 :     int test, best = -1;</span>
<span class="lineNum">     961 </span>            : 
<span class="lineNum">     962 </span><span class="lineCov">          2 :     if ( dir==NULL )</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     964 </span>            : 
<span class="lineNum">     965 </span><span class="lineCov">          2 :     if ( *maybefile!=NULL ) {</span>
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :         char *pt = strrchr(*maybefile,'.');</span>
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :         while ( pt&gt;*maybefile &amp;&amp; isdigit(pt[-1]))</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :             --pt;</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :         best = strtol(pt,NULL,10);</span>
<span class="lineNum">     970 </span>            :     }
<span class="lineNum">     971 </span>            : 
<span class="lineNum">     972 </span><span class="lineCov">          2 :     d = opendir(dir);</span>
<span class="lineNum">     973 </span><span class="lineCov">          2 :     if ( d==NULL )</span>
<span class="lineNum">     974 </span><span class="lineCov">          1 : return( NULL );</span>
<span class="lineNum">     975 </span><span class="lineCov">          5 :     while ( (ent = readdir(d))!=NULL ) {</span>
<span class="lineNum">     976 </span><span class="lineCov">          3 :         if ( (len = strlen(ent-&gt;d_name))&lt;8 )</span>
<span class="lineNum">     977 </span><span class="lineCov">          2 :     continue;</span>
<span class="lineNum">     978 </span><span class="lineCov">          1 :         if ( strcmp(ent-&gt;d_name+len-7,&quot;.cidmap&quot;)!=0 )</span>
<span class="lineNum">     979 </span><span class="lineCov">          1 :     continue;</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :         if ( strncmp(ent-&gt;d_name,registry,rlen)!=0 || ent-&gt;d_name[rlen]!='-' )</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :         pt = ent-&gt;d_name+rlen+1;</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :         if ( strncmp(pt,ordering,olen)!=0 || pt[olen]!='-' )</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :         pt += olen+1;</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :         if ( !isdigit(*pt))</span>
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :         test = strtol(pt,&amp;end,10);</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :         if ( *end!='.' )</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :         if ( test&gt;=supplement ) {</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :             ret = malloc(strlen(dir)+1+len+1);</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :             strcpy(ret,dir);</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :             strcat(ret,&quot;/&quot;);</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :             strcat(ret,ent-&gt;d_name);</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :             closedir(d);</span>
<span class="lineNum">     997 </span><span class="lineNoCov">          0 : return( ret );</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :         } else if ( test&gt;best ) {</span>
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :             best = test;</span>
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :             strcpy(maybe,ent-&gt;d_name);</span>
<span class="lineNum">    1001 </span>            :         }
<span class="lineNum">    1002 </span>            :     }
<span class="lineNum">    1003 </span><span class="lineCov">          1 :     closedir(d);</span>
<span class="lineNum">    1004 </span><span class="lineCov">          1 :     if ( best&gt;-1 ) {</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :         ret = malloc(strlen(dir)+1+strlen(maybe)+1);</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :         strcpy(ret,dir);</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :         strcat(ret,&quot;/&quot;);</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :         strcat(ret,maybe);</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :         *maybefile = ret;</span>
<span class="lineNum">    1010 </span>            :     }
<span class="lineNum">    1011 </span><span class="lineCov">          1 : return( NULL );</span>
<a name="1012"><span class="lineNum">    1012 </span>            : }</a>
<span class="lineNum">    1013 </span>            : 
<span class="lineNum">    1014 </span><span class="lineCov">          1 : static struct cidmap *MakeDummyMap(char *registry,char *ordering,int supplement) {</span>
<span class="lineNum">    1015 </span><span class="lineCov">          1 :     struct cidmap *ret = malloc(sizeof(struct cidmap));</span>
<span class="lineNum">    1016 </span>            : 
<span class="lineNum">    1017 </span><span class="lineCov">          1 :     ret-&gt;registry = copy(registry);</span>
<span class="lineNum">    1018 </span><span class="lineCov">          1 :     ret-&gt;ordering = copy(ordering);</span>
<span class="lineNum">    1019 </span><span class="lineCov">          1 :     ret-&gt;supplement = ret-&gt;maxsupple = supplement;</span>
<span class="lineNum">    1020 </span><span class="lineCov">          1 :     ret-&gt;cidmax = ret-&gt;namemax = 0;</span>
<span class="lineNum">    1021 </span><span class="lineCov">          1 :     ret-&gt;unicode = NULL; ret-&gt;name = NULL;</span>
<span class="lineNum">    1022 </span><span class="lineCov">          1 :     ret-&gt;alts = NULL;</span>
<span class="lineNum">    1023 </span><span class="lineCov">          1 :     ret-&gt;next = cidmaps;</span>
<span class="lineNum">    1024 </span><span class="lineCov">          1 :     cidmaps = ret;</span>
<span class="lineNum">    1025 </span><span class="lineCov">          1 : return( ret );</span>
<a name="1026"><span class="lineNum">    1026 </span>            : }</a>
<span class="lineNum">    1027 </span>            : 
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 : struct cidmap *LoadMapFromFile(char *file,char *registry,char *ordering,</span>
<span class="lineNum">    1029 </span>            :         int supplement) {
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :     struct cidmap *ret = malloc(sizeof(struct cidmap));</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :     char *pt = strrchr(file,'.');</span>
<span class="lineNum">    1032 </span>            :     FILE *f;
<span class="lineNum">    1033 </span>            :     int cid1, cid2, uni, cnt, i, ch;
<span class="lineNum">    1034 </span>            :     char name[100];
<span class="lineNum">    1035 </span>            : 
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :     while ( pt&gt;file &amp;&amp; isdigit(pt[-1]))</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :         --pt;</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :     ret-&gt;supplement = ret-&gt;maxsupple = strtol(pt,NULL,10);</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :     if ( supplement&gt;ret-&gt;maxsupple )</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :         ret-&gt;maxsupple = supplement;</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :     ret-&gt;registry = copy(registry);</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :     ret-&gt;ordering = copy(ordering);</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :     ret-&gt;alts = NULL;</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :     ret-&gt;cidmax = ret-&gt;namemax = 0;</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :     ret-&gt;unicode = NULL; ret-&gt;name = NULL;</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :     ret-&gt;next = cidmaps;</span>
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :     cidmaps = ret;</span>
<span class="lineNum">    1048 </span>            : 
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :     f = fopen( file,&quot;r&quot; );</span>
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :     if ( f==NULL ) {</span>
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :         ff_post_error(_(&quot;Missing cidmap file&quot;),_(&quot;Couldn't open cidmap file: %s&quot;), file );</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :     } else if ( fscanf( f, &quot;%d %d&quot;, &amp;ret-&gt;cidmax, &amp;ret-&gt;namemax )!=2 ) {</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :         ff_post_error(_(&quot;Bad cidmap file&quot;),_(&quot;%s is not a cidmap file, please download\nhttp://fontforge.sourceforge.net/cidmaps.tgz&quot;), file );</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :         fprintf( stderr, _(&quot;%s is not a cidmap file, please download\nhttp://fontforge.sourceforge.net/cidmaps.tgz&quot;), file );</span>
<span class="lineNum">    1055 </span>            :     } else {
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :         ret-&gt;unicode = calloc(ret-&gt;namemax+1,sizeof(uint32));</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :         ret-&gt;name = calloc(ret-&gt;namemax+1,sizeof(char *));</span>
<span class="lineNum">    1058 </span>            :         while ( 1 ) {
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :             cnt=fscanf( f, &quot;%d..%d %x&quot;, &amp;cid1, &amp;cid2, (unsigned *) &amp;uni );</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :             if ( cnt&lt;=0 )</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :             if ( cid1&gt;ret-&gt;namemax )</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :             if ( cnt==3 ) {</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :                 if ( cid2&gt;ret-&gt;namemax ) cid2 = ret-&gt;namemax;</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :                 for ( i=cid1; i&lt;=cid2; ++i )</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :                     ret-&gt;unicode[i] = uni++;</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :             } else if ( cnt==1 ) {</span>
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :                 if ( fscanf(f,&quot;%x&quot;, (unsigned *) &amp;uni )==1 ) {</span>
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :                     ret-&gt;unicode[cid1] = uni;</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :                     ch = getc(f);</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :                     while ( ch==',' ) {</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :                         if ( fscanf(f,&quot;%x&quot;, (unsigned *) &amp;uni )==1 ) {</span>
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :                             struct cidaltuni *alt = chunkalloc(sizeof(struct cidaltuni));</span>
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :                             alt-&gt;next = ret-&gt;alts;</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :                             ret-&gt;alts = alt;</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :                             alt-&gt;uni = uni;</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :                             alt-&gt;cid = cid1;</span>
<span class="lineNum">    1079 </span>            :                         }
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :                         ch = getc(f);</span>
<span class="lineNum">    1081 </span>            :                     }
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :                     ungetc(ch,f);</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :                 } else if ( fscanf(f,&quot; /%s&quot;, name )==1 )</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :                     ret-&gt;name[cid1] = copy(name);</span>
<span class="lineNum">    1085 </span>            :             }
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :         fclose(f);</span>
<span class="lineNum">    1088 </span>            :     }
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 : return( ret );</span>
<a name="1090"><span class="lineNum">    1090 </span>            : }</a>
<span class="lineNum">    1091 </span>            : 
<span class="lineNum">    1092 </span><span class="lineCov">        518 : struct cidmap *FindCidMap(char *registry,char *ordering,int supplement,SplineFont *sf) {</span>
<span class="lineNum">    1093 </span><span class="lineCov">        518 :     struct cidmap *map, *maybe=NULL;</span>
<span class="lineNum">    1094 </span>            :     char *file;
<span class="lineNum">    1095 </span><span class="lineCov">        518 :     char *maybefile=NULL;</span>
<span class="lineNum">    1096 </span><span class="lineCov">        518 :     int maybe_sup = -1;</span>
<span class="lineNum">    1097 </span>            :     const char *buts[3], *buts2[3], *buts3[3];
<span class="lineNum">    1098 </span><span class="lineCov">        518 :     char *buf = NULL;</span>
<span class="lineNum">    1099 </span>            :     int ret;
<span class="lineNum">    1100 </span>            : 
<span class="lineNum">    1101 </span><span class="lineCov">        518 :     if ( sf!=NULL &amp;&amp; sf-&gt;cidmaster ) sf = sf-&gt;cidmaster;</span>
<span class="lineNum">    1102 </span><span class="lineCov">        518 :     if ( sf!=NULL &amp;&amp; sf-&gt;loading_cid_map )</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    1104 </span>            : 
<span class="lineNum">    1105 </span><span class="lineCov">        518 :     for ( map = cidmaps; map!=NULL; map = map-&gt;next ) {</span>
<span class="lineNum">    1106 </span><span class="lineCov">        517 :         if ( strcmp(map-&gt;registry,registry)==0 &amp;&amp; strcmp(map-&gt;ordering,ordering)==0 ) {</span>
<span class="lineNum">    1107 </span><span class="lineCov">        517 :             if ( supplement&lt;=map-&gt;supplement )</span>
<span class="lineNum">    1108 </span><span class="lineCov">        517 : return( map );</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :             else if ( maybe==NULL || maybe-&gt;supplement&lt;map-&gt;supplement )</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :                 maybe = map;</span>
<span class="lineNum">    1111 </span>            :         }
<span class="lineNum">    1112 </span>            :     }
<span class="lineNum">    1113 </span><span class="lineCov">          1 :     if ( maybe!=NULL &amp;&amp; supplement&lt;=maybe-&gt;maxsupple )</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 : return( maybe );        /* User has said it's ok to use maybe at this supplement level */</span>
<span class="lineNum">    1115 </span>            : 
<span class="lineNum">    1116 </span><span class="lineCov">          1 :     file = SearchDirForCidMap(&quot;.&quot;,registry,ordering,supplement,&amp;maybefile);</span>
<span class="lineNum">    1117 </span><span class="lineCov">          1 :     if ( file==NULL )</span>
<span class="lineNum">    1118 </span><span class="lineCov">          1 :         file = SearchDirForCidMap(getFontForgeShareDir(),registry,ordering,supplement,&amp;maybefile);</span>
<span class="lineNum">    1119 </span>            : 
<span class="lineNum">    1120 </span><span class="lineCov">          1 :     if ( file==NULL &amp;&amp; (maybe!=NULL || maybefile!=NULL)) {</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :         if ( maybefile!=NULL ) {</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :             char *pt = strrchr(maybefile,'.');</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :             while ( pt&gt;maybefile &amp;&amp; isdigit(pt[-1]))</span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :                 --pt;</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :             maybe_sup = strtol(pt,NULL,10);</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :             if ( maybe!=NULL &amp;&amp; maybe-&gt;supplement &gt;= maybe_sup ) {</span>
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :                 free(maybefile); maybefile = NULL;</span>
<span class="lineNum">    1128 </span><span class="lineNoCov">          0 :                 maybe_sup = maybe-&gt;supplement;</span>
<span class="lineNum">    1129 </span>            :             } else
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 :                 maybe = NULL;</span>
<span class="lineNum">    1131 </span>            :         }
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :         if ( maybe!=NULL )</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :             maybe_sup = maybe-&gt;supplement;</span>
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 :         if ( sf!=NULL ) sf-&gt;loading_cid_map = true;</span>
<span class="lineNum">    1135 </span><span class="lineNoCov">          0 :         buts[0] = _(&quot;_Use It&quot;); buts[1] = _(&quot;_Search&quot;); buts[2] = NULL;</span>
<span class="lineNum">    1136 </span><span class="lineNoCov">          0 :         ret = ff_ask(_(&quot;Use CID Map&quot;),(const char **) buts,0,1,_(&quot;This font is based on the charset %1$.20s-%2$.20s-%3$d, but the best I've been able to find is %1$.20s-%2$.20s-%4$d.\nShall I use that or let you search?&quot;),</span>
<span class="lineNum">    1137 </span>            :                 registry,ordering,supplement,maybe_sup);
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :         if ( sf!=NULL ) sf-&gt;loading_cid_map = false;</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :         if ( ret==0 ) {</span>
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :             if ( maybe!=NULL ) {</span>
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :                 maybe-&gt;maxsupple = supplement;</span>
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 : return( maybe );</span>
<span class="lineNum">    1143 </span>            :             } else {
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :                 file = maybefile;</span>
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 :                 maybefile = NULL;</span>
<span class="lineNum">    1146 </span>            :             }
<span class="lineNum">    1147 </span>            :         }
<span class="lineNum">    1148 </span>            :     }
<span class="lineNum">    1149 </span>            : 
<span class="lineNum">    1150 </span><span class="lineCov">          1 :     if ( file==NULL ) {</span>
<span class="lineNum">    1151 </span>            :         char *uret;
<span class="lineNum">    1152 </span><span class="lineCov">          1 :         buf = xasprintf( &quot;%s-%s-*.cidmap&quot;, registry, ordering );</span>
<span class="lineNum">    1153 </span><span class="lineCov">          1 :         if ( maybe==NULL &amp;&amp; maybefile==NULL ) {</span>
<span class="lineNum">    1154 </span><span class="lineCov">          1 :             buts3[0] = _(&quot;_Browse&quot;); buts3[1] = _(&quot;_Give Up&quot;); buts3[2] = NULL;</span>
<span class="lineNum">    1155 </span><span class="lineCov">          3 :             ret = ff_ask(_(&quot;No cidmap file...&quot;),(const char **)buts3,0,1,_(&quot;FontForge was unable to find a cidmap file for this font. It is not essential to have one, but some things will work better if you do. If you have not done so you might want to download the cidmaps from:\n   http://FontForge.sourceforge.net/cidmaps.tgz\nand then gunzip and untar them and move them to:\n  %.80s\n\nWould you like to search your local disk for an appropriate file?&quot;),</span>
<span class="lineNum">    1156 </span><span class="lineCov">          2 :                     getFontForgeShareDir()==NULL?&quot;/usr/share/fontforge&quot;:getFontForgeShareDir()</span>
<span class="lineNum">    1157 </span>            :                     );
<span class="lineNum">    1158 </span><span class="lineCov">          1 :             if ( ret==1 || no_windowing_ui )</span>
<span class="lineNum">    1159 </span><span class="lineCov">          1 :                 buf = NULL;</span>
<span class="lineNum">    1160 </span>            :         }
<span class="lineNum">    1161 </span><span class="lineCov">          1 :         uret = NULL;</span>
<span class="lineNum">    1162 </span><span class="lineCov">          1 :         if ( ( buf != NULL ) &amp;&amp; !no_windowing_ui ) {</span>
<span class="lineNum">    1163 </span><span class="lineNoCov">          0 :             if ( sf!=NULL ) sf-&gt;loading_cid_map = true;</span>
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :             uret = ff_open_filename(_(&quot;Find a cidmap file...&quot;), NULL, (char *) buf );</span>
<span class="lineNum">    1165 </span><span class="lineNoCov">          0 :             if ( sf!=NULL ) sf-&gt;loading_cid_map = false;</span>
<span class="lineNum">    1166 </span>            :         }
<span class="lineNum">    1167 </span><span class="lineCov">          1 :         if ( uret==NULL ) {</span>
<span class="lineNum">    1168 </span><span class="lineCov">          1 :             buts2[0] = &quot;_Use It&quot;; buts2[1] = &quot;_Search&quot;; buts2[2] = NULL;</span>
<span class="lineNum">    1169 </span><span class="lineCov">          1 :             if ( maybe==NULL &amp;&amp; maybefile==NULL )</span>
<span class="lineNum">    1170 </span>            :                 /* No luck */;
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :             else if ( no_windowing_ui &amp;&amp; maybe!=NULL ) {</span>
<span class="lineNum">    1172 </span><span class="lineNoCov">          0 :                 maybe-&gt;maxsupple = supplement;</span>
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 : return( maybe );</span>
<span class="lineNum">    1174 </span><span class="lineNoCov">          0 :             } else if ( no_windowing_ui ) {</span>
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :                 file = maybefile;</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :                 maybefile = NULL;</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :             } else if ( ff_ask(_(&quot;Use CID Map&quot;),(const char **)buts2,0,1,_(&quot;Are you sure you don't want to use the cidmap I found?&quot;))==0 ) {</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :                 if ( maybe!=NULL ) {</span>
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :                     maybe-&gt;maxsupple = supplement;</span>
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 : return( maybe );</span>
<span class="lineNum">    1181 </span>            :                 } else {
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :                     file = maybefile;</span>
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :                     maybefile = NULL;</span>
<span class="lineNum">    1184 </span>            :                 }
<span class="lineNum">    1185 </span>            :             }
<span class="lineNum">    1186 </span>            :         } else {
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :             file = utf82def_copy(uret);</span>
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :             free(uret);</span>
<span class="lineNum">    1189 </span>            :         }
<span class="lineNum">    1190 </span>            :     }
<span class="lineNum">    1191 </span>            : 
<span class="lineNum">    1192 </span><span class="lineCov">          1 :     free(maybefile);</span>
<span class="lineNum">    1193 </span><span class="lineCov">          1 :     if ( file!=NULL ) {</span>
<span class="lineNum">    1194 </span><span class="lineNoCov">          0 :         map = LoadMapFromFile(file,registry,ordering,supplement);</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :         free(file);</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 : return( map );</span>
<span class="lineNum">    1197 </span>            :     }
<span class="lineNum">    1198 </span>            : 
<span class="lineNum">    1199 </span><span class="lineCov">          1 : return( MakeDummyMap(registry,ordering,supplement));</span>
<a name="1200"><span class="lineNum">    1200 </span>            : }</a>
<span class="lineNum">    1201 </span>            : 
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 : static void SFApplyOrdering(SplineFont *sf, int glyphcnt) {</span>
<span class="lineNum">    1203 </span>            :     SplineChar **glyphs, *sc;
<span class="lineNum">    1204 </span>            :     int i;
<span class="lineNum">    1205 </span>            :     RefChar *refs, *rnext, *rprev;
<span class="lineNum">    1206 </span>            :     SplineSet *new, *spl;
<span class="lineNum">    1207 </span>            : 
<span class="lineNum">    1208 </span>            :     /* Remove references to characters which aren't in the new map (if any) */
<span class="lineNum">    1209 </span>            :     /* Don't need to fix up dependencies, because we throw the char away */
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( (sc = sf-&gt;glyphs[i])!=NULL ) {</span>
<span class="lineNum">    1211 </span><span class="lineNoCov">          0 :         for ( rprev = NULL, refs=sc-&gt;layers[ly_fore].refs; refs!=NULL; refs=rnext ) {</span>
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :             rnext = refs-&gt;next;</span>
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :             if ( refs-&gt;sc-&gt;orig_pos==-1 ) {</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :                 new = refs-&gt;layers[0].splines;</span>
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 :                 if ( new!=NULL ) {</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :                     for ( spl = new; spl-&gt;next!=NULL; spl = spl-&gt;next );</span>
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :                     spl-&gt;next = sc-&gt;layers[ly_fore].splines;</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :                     sc-&gt;layers[ly_fore].splines = new;</span>
<span class="lineNum">    1219 </span>            :                 }
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :                 refs-&gt;layers[0].splines=NULL;</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :                 RefCharFree(refs);</span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :                 if ( rprev==NULL )</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :                     sc-&gt;layers[ly_fore].refs = rnext;</span>
<span class="lineNum">    1224 </span>            :                 else
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :                     rprev-&gt;next = rnext;</span>
<span class="lineNum">    1226 </span>            :             } else
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :                 rprev = refs;</span>
<span class="lineNum">    1228 </span>            :         }
<span class="lineNum">    1229 </span>            :     }
<span class="lineNum">    1230 </span>            : 
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :     glyphs = calloc(glyphcnt+1,sizeof(SplineChar *));</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( (sc = sf-&gt;glyphs[i])!=NULL ) {</span>
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :         if ( sc-&gt;orig_pos==-1 )</span>
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :             SplineCharFree(sc);</span>
<span class="lineNum">    1235 </span>            :         else
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :             glyphs[sc-&gt;orig_pos] = sc;</span>
<span class="lineNum">    1237 </span>            :     }
<span class="lineNum">    1238 </span>            : 
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :     free(sf-&gt;glyphs);</span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :     sf-&gt;glyphcnt = sf-&gt;glyphmax = glyphcnt;</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :     sf-&gt;glyphs = glyphs;</span>
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 : }</span>
<a name="1243"><span class="lineNum">    1243 </span>            : </a>
<span class="lineNum">    1244 </span>            : /* Convert a normal font to a cid font, rearranging glyphs into cid order */
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 : void SFEncodeToMap(SplineFont *sf,struct cidmap *map) {</span>
<span class="lineNum">    1246 </span>            :     SplineChar *sc;
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :     int i,max=0, anyextras=0;</span>
<span class="lineNum">    1248 </span>            : 
<span class="lineNum">    1249 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( SCWorthOutputting(sc = sf-&gt;glyphs[i]) ) {</span>
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :         sc-&gt;orig_pos = NameUni2CID(map,sc-&gt;unicodeenc,sc-&gt;name);</span>
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :         if ( sc-&gt;orig_pos&gt;max ) max = sc-&gt;orig_pos;</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :         else if ( sc-&gt;orig_pos==-1 ) ++anyextras;</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :     } else if ( sc!=NULL )</span>
<span class="lineNum">    1254 </span><span class="lineNoCov">          0 :         sc-&gt;orig_pos = -1;</span>
<span class="lineNum">    1255 </span>            : 
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :     if ( anyextras ) {</span>
<span class="lineNum">    1257 </span>            :         char *buttons[3];
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :         buttons[0] = _(&quot;_Delete&quot;); buttons[1] = _(&quot;_Add&quot;); buttons[2] = NULL;</span>
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 :         if ( ff_ask(_(&quot;Extraneous glyphs&quot;),(const char **) buttons,0,1,_(&quot;The current encoding contains glyphs which I cannot map to CIDs.\nShould I delete them or add them to the end (where they may conflict with future ros definitions)?&quot;))==1 ) {</span>
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :             if ( map!=NULL &amp;&amp; max&lt;map-&gt;cidmax ) max = map-&gt;cidmax;</span>
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :             anyextras = 0;</span>
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( SCWorthOutputting(sc = sf-&gt;glyphs[i]) ) {</span>
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :                 if ( sc-&gt;orig_pos == -1 ) sc-&gt;orig_pos = max + anyextras++;</span>
<span class="lineNum">    1264 </span>            :             }
<span class="lineNum">    1265 </span><span class="lineNoCov">          0 :             max += anyextras;</span>
<span class="lineNum">    1266 </span>            :         }
<span class="lineNum">    1267 </span>            :     }
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :     SFApplyOrdering(sf, max+1);</span>
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1270 </span>            : 
<span class="lineNum">    1271 </span>            : enum cmaptype { cmt_out=-1, cmt_coderange, cmt_notdefs, cmt_cid, cmt_max };
<span class="lineNum">    1272 </span>            : struct coderange { uint32 first, last, cid; };
<span class="lineNum">    1273 </span>            : struct cmap {
<span class="lineNum">    1274 </span>            :     struct {
<span class="lineNum">    1275 </span>            :         int n;
<span class="lineNum">    1276 </span>            :         struct coderange *ranges;
<span class="lineNum">    1277 </span>            :     } groups[cmt_max];
<span class="lineNum">    1278 </span>            :     char *registry;
<span class="lineNum">    1279 </span>            :     char *ordering;
<span class="lineNum">    1280 </span>            :     int supplement;
<span class="lineNum">    1281 </span>            :     struct remap *remap;
<span class="lineNum">    1282 </span>            :     int total;
<a name="1283"><span class="lineNum">    1283 </span>            : };</a>
<span class="lineNum">    1284 </span>            : 
<span class="lineNum">    1285 </span><span class="lineNoCov">          0 : static void cmapfree(struct cmap *cmap) {</span>
<span class="lineNum">    1286 </span><span class="lineNoCov">          0 :     free(cmap-&gt;registry);</span>
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :     free(cmap-&gt;ordering);</span>
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :     free(cmap-&gt;groups[cmt_coderange].ranges);</span>
<span class="lineNum">    1289 </span><span class="lineNoCov">          0 :     free(cmap-&gt;groups[cmt_notdefs].ranges);</span>
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :     free(cmap-&gt;groups[cmt_cid].ranges);</span>
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :     free(cmap-&gt;remap);</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :     free(cmap);</span>
<a name="1293"><span class="lineNum">    1293 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1294 </span>            : 
<span class="lineNum">    1295 </span><span class="lineNoCov">          0 : static struct coderange *ExtendArray(struct coderange *ranges,int *n, int val) {</span>
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 :     if ( *n == 0 )</span>
<span class="lineNum">    1297 </span><span class="lineNoCov">          0 :         ranges = calloc(val,sizeof(struct coderange));</span>
<span class="lineNum">    1298 </span>            :     else {
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :         ranges = realloc(ranges,(*n+val)*sizeof(struct coderange));</span>
<span class="lineNum">    1300 </span><span class="lineNoCov">          0 :         memset(ranges+*n,0,val*sizeof(struct coderange));</span>
<span class="lineNum">    1301 </span>            :     }
<span class="lineNum">    1302 </span><span class="lineNoCov">          0 :     *n += val;</span>
<span class="lineNum">    1303 </span><span class="lineNoCov">          0 : return( ranges );</span>
<a name="1304"><span class="lineNum">    1304 </span>            : }</a>
<span class="lineNum">    1305 </span>            : 
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 : static char *readpsstr(char *str) {</span>
<span class="lineNum">    1307 </span>            :     char *eos;
<span class="lineNum">    1308 </span>            : 
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :     while ( isspace(*str)) ++str;</span>
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :     if ( *str=='(' ) ++str;</span>
<span class="lineNum">    1311 </span>            :     /* PostScript strings can be more complicated than this (hex, nested parens, Enc85...) */
<span class="lineNum">    1312 </span>            :     /*  but none of those should show up here */
<span class="lineNum">    1313 </span><span class="lineNoCov">          0 :     for ( eos = str; *eos!=')' &amp;&amp; *eos!='\0'; ++eos );</span>
<span class="lineNum">    1314 </span><span class="lineNoCov">          0 : return( copyn(str,eos-str));</span>
<a name="1315"><span class="lineNum">    1315 </span>            : }</a>
<span class="lineNum">    1316 </span>            : 
<span class="lineNum">    1317 </span><span class="lineNoCov">          0 : static struct cmap *ParseCMap(char *filename) {</span>
<span class="lineNum">    1318 </span>            :     char buf2[200];
<span class="lineNum">    1319 </span>            :     FILE *file;
<span class="lineNum">    1320 </span>            :     struct cmap *cmap;
<span class="lineNum">    1321 </span>            :     char *end, *pt;
<span class="lineNum">    1322 </span>            :     int val, pos;
<span class="lineNum">    1323 </span>            :     enum cmaptype in;
<span class="lineNum">    1324 </span>            :     int in_is_single; // We set this if we are to parse cidchars into cidranges.
<span class="lineNum">    1325 </span>            :     static const char *bcsr = &quot;begincodespacerange&quot;, *bndr = &quot;beginnotdefrange&quot;, *bcr = &quot;begincidrange&quot;, *bcc = &quot;begincidchar&quot;;
<span class="lineNum">    1326 </span>            :     static const char *reg = &quot;/Registry&quot;, *ord = &quot;/Ordering&quot;, *sup=&quot;/Supplement&quot;;
<span class="lineNum">    1327 </span>            : 
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :     file = fopen(filename,&quot;r&quot;);</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :     if ( file==NULL )</span>
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    1331 </span>            : 
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :     cmap = calloc(1,sizeof(struct cmap));</span>
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :     in = cmt_out;</span>
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :     while ( fgets(buf2,sizeof(buf2),file)!=NULL ) {</span>
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :         for ( pt=buf2; isspace(*pt); ++pt);</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :         if ( in==cmt_out ) {</span>
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :             if ( *pt=='/' ) {</span>
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :                 if ( strncmp(pt,reg,strlen(reg))==0 )</span>
<span class="lineNum">    1339 </span><span class="lineNoCov">          0 :                     cmap-&gt;registry = readpsstr(pt+strlen(reg));</span>
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :                 else if ( strncmp(pt,ord,strlen(ord))==0 )</span>
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :                     cmap-&gt;ordering = readpsstr(pt+strlen(ord));</span>
<span class="lineNum">    1342 </span><span class="lineNoCov">          0 :                 else if ( strncmp(pt,sup,strlen(sup))==0 ) {</span>
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :                     for ( pt += strlen(sup); isspace(*pt); ++pt );</span>
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :                     cmap-&gt;supplement = strtol(pt,NULL,10);</span>
<span class="lineNum">    1345 </span>            :                 }
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :             } else if ( !isdigit(*pt) )</span>
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :             val = strtol(pt,&amp;end,10);</span>
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :             while ( isspace(*end)) ++end;</span>
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :             in_is_single = 0;</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :             if ( strncmp(end,bcsr,strlen(bcsr))==0 ) {</span>
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :                 in = cmt_coderange;</span>
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :             } else if ( strncmp(end,bndr,strlen(bndr))==0 ) {</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :                 in = cmt_notdefs;</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :             } else if ( strncmp(end,bcr,strlen(bcr))==0 ) {</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :                 in = cmt_cid;</span>
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :             } else if ( strncmp(end,bcc,strlen(bcc))==0 ) {</span>
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :                 in = cmt_cid;</span>
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :                 in_is_single = 1;</span>
<span class="lineNum">    1361 </span>            :             }
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :             if ( in!=cmt_out ) {</span>
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :                 pos = cmap-&gt;groups[in].n;</span>
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :                 cmap-&gt;groups[in].ranges = ExtendArray(cmap-&gt;groups[in].ranges,&amp;cmap-&gt;groups[in].n,val);</span>
<span class="lineNum">    1365 </span>            :             }
<span class="lineNum">    1366 </span><span class="lineNoCov">          0 :         } else if ( strncmp(pt,&quot;end&quot;,3)== 0 )</span>
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :             in = cmt_out;</span>
<span class="lineNum">    1368 </span><span class="lineNoCov">          0 :     else if (pos &gt;= cmap-&gt;groups[in].n) {</span>
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :         LogError(_(&quot;cidmap entry out of bounds: %s&quot;), buf2);</span>
<span class="lineNum">    1370 </span>            :     }
<span class="lineNum">    1371 </span>            :         else {
<span class="lineNum">    1372 </span>            :             // Read the first bracketed code.
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :             if ( *pt!='&lt;' )</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :             cmap-&gt;groups[in].ranges[pos].first = strtoul(pt+1,&amp;end,16);</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :             if ( *end=='&gt;' ) ++end;</span>
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :             while ( isspace(*end)) ++end;</span>
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :             if (in_is_single) {</span>
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :               cmap-&gt;groups[in].ranges[pos].last = cmap-&gt;groups[in].ranges[pos].first;</span>
<span class="lineNum">    1380 </span>            :             } else {
<span class="lineNum">    1381 </span>            :               // Read the second bracketed code.
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :               if ( *end=='&lt;' ) ++end;</span>
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :               cmap-&gt;groups[in].ranges[pos].last = strtoul(end,&amp;end,16);</span>
<span class="lineNum">    1384 </span><span class="lineNoCov">          0 :               if ( *end=='&gt;' ) ++end;</span>
<span class="lineNum">    1385 </span>            :             }
<span class="lineNum">    1386 </span><span class="lineNoCov">          0 :             if ( in!=cmt_coderange ) {</span>
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :                 while ( isspace(*end)) ++end;</span>
<span class="lineNum">    1388 </span>            :                 // Read the unbracketed argument.
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :                 cmap-&gt;groups[in].ranges[pos].cid = strtol(end,&amp;end,10);</span>
<span class="lineNum">    1390 </span>            :             }
<span class="lineNum">    1391 </span><span class="lineNoCov">          0 :             ++pos;</span>
<span class="lineNum">    1392 </span>            :         }
<span class="lineNum">    1393 </span>            :     }
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :     fclose(file);</span>
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 : return( cmap );</span>
<a name="1396"><span class="lineNum">    1396 </span>            : }</a>
<span class="lineNum">    1397 </span>            : 
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 : static void CompressCMap(struct cmap *cmap) {</span>
<span class="lineNum">    1399 </span>            :     int32 i,j,k, pos, base;
<span class="lineNum">    1400 </span>            :     uint32 min, oldmax;
<span class="lineNum">    1401 </span>            :     /* we can't really deal with three and four byte encodings */
<span class="lineNum">    1402 </span>            :     /*  so if we get one arrange for the sf itself to do a remap */
<span class="lineNum">    1403 </span>            : 
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :     cmap-&gt;total = 0x10000;</span>
<span class="lineNum">    1405 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cmap-&gt;groups[cmt_coderange].n; ++i )</span>
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 :         if ( cmap-&gt;groups[cmt_coderange].ranges[i].last&gt;0xfffff )</span>
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :     if ( i==cmap-&gt;groups[cmt_coderange].n )  /* No need to remap */</span>
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1410 </span>            : 
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 :     cmap-&gt;remap = calloc(cmap-&gt;groups[cmt_coderange].n+1,sizeof(struct remap));</span>
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :     base = 0;</span>
<span class="lineNum">    1413 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cmap-&gt;groups[cmt_coderange].n; ++i )</span>
<span class="lineNum">    1414 </span><span class="lineNoCov">          0 :         if ( cmap-&gt;groups[cmt_coderange].ranges[i].last&lt;0xffff ) {</span>
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :             base = 0x10000;</span>
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    1417 </span>            :         }
<span class="lineNum">    1418 </span>            : 
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :     pos=0;</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :     oldmax = base==0?0:0xffff;</span>
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cmap-&gt;groups[cmt_coderange].n; ++i ) {</span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :         min = 0xffffffff; k=-1;</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;cmap-&gt;groups[cmt_coderange].n; ++j )</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :             if ( cmap-&gt;groups[cmt_coderange].ranges[j].first&gt;oldmax &amp;&amp;</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :                     cmap-&gt;groups[cmt_coderange].ranges[j].first&lt;min ) {</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :                 min = cmap-&gt;groups[cmt_coderange].ranges[j].first;</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :                 k = j;</span>
<span class="lineNum">    1428 </span>            :             }
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :         if ( k==-1 )</span>
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :         cmap-&gt;remap[pos].firstenc = cmap-&gt;groups[cmt_coderange].ranges[k].first&amp;~0xff;</span>
<span class="lineNum">    1432 </span><span class="lineNoCov">          0 :         cmap-&gt;remap[pos].lastenc = cmap-&gt;groups[cmt_coderange].ranges[k].last|0xff;</span>
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 :         cmap-&gt;remap[pos].infont = base;</span>
<span class="lineNum">    1434 </span><span class="lineNoCov">          0 :         base += cmap-&gt;remap[pos].lastenc-cmap-&gt;remap[pos].firstenc+1;</span>
<span class="lineNum">    1435 </span><span class="lineNoCov">          0 :         oldmax = cmap-&gt;remap[pos].lastenc;</span>
<span class="lineNum">    1436 </span><span class="lineNoCov">          0 :         ++pos;</span>
<span class="lineNum">    1437 </span>            :     }
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :     cmap-&gt;remap[pos].infont = -1;    /* Marks end */</span>
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :     cmap-&gt;total = base;</span>
<span class="lineNum">    1440 </span>            :     /* so cmap-&gt;remap will map sf indeces into the encoding in the cmap */
<span class="lineNum">    1441 </span>            : 
<span class="lineNum">    1442 </span>            :     /* And now we want to change the groups[cmt_cid].ranges so that they will */
<span class="lineNum">    1443 </span>            :     /*  map into sf indeces rather than into the encoding of the cmap */
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cmap-&gt;groups[cmt_cid].n; ++i ) {</span>
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :         for ( k=0; cmap-&gt;remap[k].infont!=-1; ++k )</span>
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :             if ( cmap-&gt;groups[cmt_cid].ranges[i].first&gt;=cmap-&gt;remap[k].firstenc &amp;&amp;</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :                     cmap-&gt;groups[cmt_cid].ranges[i].first&lt;=cmap-&gt;remap[k].lastenc )</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :         if ( cmap-&gt;remap[k].infont==-1 )</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :         cmap-&gt;groups[cmt_cid].ranges[i].first += cmap-&gt;remap[k].infont-cmap-&gt;remap[k].firstenc;</span>
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :         cmap-&gt;groups[cmt_cid].ranges[i].last += cmap-&gt;remap[k].infont-cmap-&gt;remap[k].firstenc;</span>
<span class="lineNum">    1453 </span>            :     }
<a name="1454"><span class="lineNum">    1454 </span>            : }</a>
<span class="lineNum">    1455 </span>            : 
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 : SplineFont *CIDFlatten(SplineFont *cidmaster,SplineChar **glyphs,int charcnt) {</span>
<span class="lineNum">    1457 </span>            :     FontViewBase *fvs;
<span class="lineNum">    1458 </span>            :     SplineFont *new;
<span class="lineNum">    1459 </span>            :     char buffer[20];
<span class="lineNum">    1460 </span>            :     BDFFont *bdf;
<span class="lineNum">    1461 </span>            :     int j;
<span class="lineNum">    1462 </span>            : 
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :     if ( cidmaster==NULL )</span>
<span class="lineNum">    1464 </span><span class="lineNoCov">          0 : return(NULL);</span>
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 :     new = SplineFontEmpty();</span>
<span class="lineNum">    1466 </span><span class="lineNoCov">          0 :     new-&gt;fontname = copy(cidmaster-&gt;fontname);</span>
<span class="lineNum">    1467 </span><span class="lineNoCov">          0 :     new-&gt;fullname = copy(cidmaster-&gt;fullname);</span>
<span class="lineNum">    1468 </span><span class="lineNoCov">          0 :     new-&gt;familyname = copy(cidmaster-&gt;familyname);</span>
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :     new-&gt;weight = copy(cidmaster-&gt;weight);</span>
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :     new-&gt;copyright = copy(cidmaster-&gt;copyright);</span>
<span class="lineNum">    1471 </span><span class="lineNoCov">          0 :     sprintf(buffer,&quot;%g&quot;, (double)cidmaster-&gt;cidversion);</span>
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :     new-&gt;version = copy(buffer);</span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :     new-&gt;italicangle = cidmaster-&gt;italicangle;</span>
<span class="lineNum">    1474 </span><span class="lineNoCov">          0 :     new-&gt;upos = cidmaster-&gt;upos;</span>
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :     new-&gt;uwidth = cidmaster-&gt;uwidth;</span>
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 :     new-&gt;ascent = cidmaster-&gt;ascent;</span>
<span class="lineNum">    1477 </span><span class="lineNoCov">          0 :     new-&gt;descent = cidmaster-&gt;descent;</span>
<span class="lineNum">    1478 </span><span class="lineNoCov">          0 :     new-&gt;changed = new-&gt;changed_since_autosave = true;</span>
<span class="lineNum">    1479 </span><span class="lineNoCov">          0 :     new-&gt;display_antialias = cidmaster-&gt;display_antialias;</span>
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 :     new-&gt;hasvmetrics = cidmaster-&gt;hasvmetrics;</span>
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :     new-&gt;fv = cidmaster-&gt;fv;</span>
<span class="lineNum">    1482 </span>            :     /* Don't copy the grid splines, there won't be anything meaningfull at top level */
<span class="lineNum">    1483 </span>            :     /*  and won't know which font to copy from below */
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 :     new-&gt;bitmaps = cidmaster-&gt;bitmaps;            /* should already be flattened */</span>
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :     cidmaster-&gt;bitmaps = NULL;                       /* don't free 'em */</span>
<span class="lineNum">    1486 </span><span class="lineNoCov">          0 :     for ( bdf=new-&gt;bitmaps; bdf!=NULL; bdf=bdf-&gt;next )</span>
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :         bdf-&gt;sf = new;</span>
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :     new-&gt;gpos_lookups = cidmaster-&gt;gpos_lookups;</span>
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :     cidmaster-&gt;gpos_lookups = NULL;</span>
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :     new-&gt;gsub_lookups = cidmaster-&gt;gsub_lookups;</span>
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :     cidmaster-&gt;gsub_lookups = NULL;</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :     new-&gt;kerns = cidmaster-&gt;kerns; new-&gt;vkerns = cidmaster-&gt;vkerns;</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :     cidmaster-&gt;kerns = cidmaster-&gt;vkerns = NULL;</span>
<span class="lineNum">    1494 </span><span class="lineNoCov">          0 :     new-&gt;names = cidmaster-&gt;names; cidmaster-&gt;names = NULL;</span>
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :     new-&gt;horiz_base = cidmaster-&gt;horiz_base; cidmaster-&gt;horiz_base = NULL;</span>
<span class="lineNum">    1496 </span><span class="lineNoCov">          0 :     new-&gt;vert_base = cidmaster-&gt;vert_base; cidmaster-&gt;vert_base = NULL;</span>
<span class="lineNum">    1497 </span><span class="lineNoCov">          0 :     new-&gt;pfminfo = cidmaster-&gt;pfminfo;</span>
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :     new-&gt;texdata = cidmaster-&gt;texdata;</span>
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :     new-&gt;possub = cidmaster-&gt;possub; cidmaster-&gt;possub = NULL;</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :     new-&gt;sm = cidmaster-&gt;sm; cidmaster-&gt;sm = NULL;</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :     new-&gt;features = cidmaster-&gt;features; cidmaster-&gt;features = NULL;</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :     new-&gt;macstyle = cidmaster-&gt;macstyle;</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :     new-&gt;origname = copy( cidmaster-&gt;origname );</span>
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :     new-&gt;display_size = cidmaster-&gt;display_size;</span>
<span class="lineNum">    1505 </span>            :     /* Don't copy private */
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :     new-&gt;xuid = copy(cidmaster-&gt;xuid);</span>
<span class="lineNum">    1507 </span><span class="lineNoCov">          0 :     new-&gt;glyphs = glyphs;</span>
<span class="lineNum">    1508 </span><span class="lineNoCov">          0 :     new-&gt;glyphcnt = new-&gt;glyphmax = charcnt;</span>
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 :     for ( j=0; j&lt;charcnt; ++j ) if ( glyphs[j]!=NULL ) {</span>
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :         glyphs[j]-&gt;parent = new;</span>
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 :         glyphs[j]-&gt;orig_pos = j;</span>
<span class="lineNum">    1512 </span>            :     }
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :     for ( fvs=new-&gt;fv; fvs!=NULL; fvs=fvs-&gt;nextsame ) {</span>
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :         fvs-&gt;cidmaster = NULL;</span>
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :         if ( fvs-&gt;sf-&gt;glyphcnt!=new-&gt;glyphcnt ) {</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :             free(fvs-&gt;selected);</span>
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :             fvs-&gt;selected = calloc(new-&gt;glyphcnt,sizeof(char));</span>
<span class="lineNum">    1518 </span><span class="lineNoCov">          0 :             if ( fvs-&gt;map-&gt;encmax &lt; new-&gt;glyphcnt )</span>
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :                 fvs-&gt;map-&gt;map = realloc(fvs-&gt;map-&gt;map,(fvs-&gt;map-&gt;encmax = new-&gt;glyphcnt)*sizeof(int32));</span>
<span class="lineNum">    1520 </span><span class="lineNoCov">          0 :             fvs-&gt;map-&gt;enccount = new-&gt;glyphcnt;</span>
<span class="lineNum">    1521 </span><span class="lineNoCov">          0 :             if ( fvs-&gt;map-&gt;backmax &lt; new-&gt;glyphcnt )</span>
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :                 fvs-&gt;map-&gt;backmap = realloc(fvs-&gt;map-&gt;backmap,(fvs-&gt;map-&gt;backmax = new-&gt;glyphcnt)*sizeof(int32));</span>
<span class="lineNum">    1523 </span><span class="lineNoCov">          0 :             for ( j=0; j&lt;new-&gt;glyphcnt; ++j )</span>
<span class="lineNum">    1524 </span><span class="lineNoCov">          0 :                 fvs-&gt;map-&gt;map[j] = fvs-&gt;map-&gt;backmap[j] = j;</span>
<span class="lineNum">    1525 </span>            :         }
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :         fvs-&gt;sf = new;</span>
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :         FVSetTitle(fvs);</span>
<span class="lineNum">    1528 </span>            :     }
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :     FontViewReformatAll(new);</span>
<span class="lineNum">    1530 </span><span class="lineNoCov">          0 :     SplineFontFree(cidmaster);</span>
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 : return( new );</span>
<a name="1532"><span class="lineNum">    1532 </span>            : }</a>
<span class="lineNum">    1533 </span>            : 
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 : void SFFlatten(SplineFont *cidmaster) {</span>
<span class="lineNum">    1535 </span>            :     SplineChar **glyphs;
<span class="lineNum">    1536 </span>            :     int i,j,max;
<span class="lineNum">    1537 </span>            : 
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :     if ( cidmaster==NULL )</span>
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :     if ( cidmaster-&gt;cidmaster!=NULL )</span>
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 :         cidmaster = cidmaster-&gt;cidmaster;</span>
<span class="lineNum">    1542 </span>            :     /* This doesn't change the ordering, so no need for special tricks to */
<span class="lineNum">    1543 </span>            :     /*  preserve scrolling location. */
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :     for ( i=max=0; i&lt;cidmaster-&gt;subfontcnt; ++i ) {</span>
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :         if ( max&lt;cidmaster-&gt;subfonts[i]-&gt;glyphcnt )</span>
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :             max = cidmaster-&gt;subfonts[i]-&gt;glyphcnt;</span>
<span class="lineNum">    1547 </span>            :     }
<span class="lineNum">    1548 </span><span class="lineNoCov">          0 :     glyphs = calloc(max,sizeof(SplineChar *));</span>
<span class="lineNum">    1549 </span><span class="lineNoCov">          0 :     for ( j=0; j&lt;max; ++j ) {</span>
<span class="lineNum">    1550 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;cidmaster-&gt;subfontcnt; ++i ) {</span>
<span class="lineNum">    1551 </span><span class="lineNoCov">          0 :             if ( j&lt;cidmaster-&gt;subfonts[i]-&gt;glyphcnt &amp;&amp; cidmaster-&gt;subfonts[i]-&gt;glyphs[j]!=NULL ) {</span>
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :                 glyphs[j] = cidmaster-&gt;subfonts[i]-&gt;glyphs[j];</span>
<span class="lineNum">    1553 </span><span class="lineNoCov">          0 :                 cidmaster-&gt;subfonts[i]-&gt;glyphs[j] = NULL;</span>
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1555 </span>            :             }
<span class="lineNum">    1556 </span>            :         }
<span class="lineNum">    1557 </span>            :     }
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :     CIDFlatten(cidmaster,glyphs,max);</span>
<a name="1559"><span class="lineNum">    1559 </span>            : }</a>
<span class="lineNum">    1560 </span>            : 
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 : int SFFlattenByCMap(SplineFont *sf,char *cmapname) {</span>
<span class="lineNum">    1562 </span>            :     struct cmap *cmap;
<span class="lineNum">    1563 </span>            :     int i,j,k,l,m, extras, max, curmax, warned;
<span class="lineNum">    1564 </span>            :     int found[4];
<span class="lineNum">    1565 </span><span class="lineNoCov">          0 :     SplineChar **glyphs = NULL, *sc;</span>
<span class="lineNum">    1566 </span>            :     FontViewBase *fvs;
<span class="lineNum">    1567 </span>            : 
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :     if ( sf-&gt;cidmaster!=NULL )</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :         sf = sf-&gt;cidmaster;</span>
<span class="lineNum">    1570 </span><span class="lineNoCov">          0 :     if ( sf-&gt;subfontcnt==0 ) {</span>
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :         ff_post_error(_(&quot;Not a CID-keyed font&quot;),_(&quot;Not a CID-keyed font&quot;));</span>
<span class="lineNum">    1572 </span><span class="lineNoCov">          0 : return( false );</span>
<span class="lineNum">    1573 </span>            :     }
<span class="lineNum">    1574 </span><span class="lineNoCov">          0 :     if ( cmapname==NULL )</span>
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 : return( false );</span>
<span class="lineNum">    1576 </span><span class="lineNoCov">          0 :     cmap = ParseCMap(cmapname);</span>
<span class="lineNum">    1577 </span><span class="lineNoCov">          0 :     if ( cmap==NULL )</span>
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 : return( false );</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :     CompressCMap(cmap);</span>
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :     max = 0;</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cmap-&gt;groups[cmt_cid].n; ++i ) {</span>
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :         if ( max&lt;cmap-&gt;groups[cmt_cid].ranges[i].last )</span>
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :             max = cmap-&gt;groups[cmt_cid].ranges[i].last;</span>
<span class="lineNum">    1584 </span><span class="lineNoCov">          0 :         if ( cmap-&gt;groups[cmt_cid].ranges[i].last&gt;0x100000 ) {</span>
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :             ff_post_error(_(&quot;Encoding Too Large&quot;),_(&quot;Encoding Too Large&quot;));</span>
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :             cmapfree(cmap);</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 : return( false );</span>
<span class="lineNum">    1588 </span>            :         }
<span class="lineNum">    1589 </span>            :     }
<span class="lineNum">    1590 </span>            : 
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :     curmax = 0;</span>
<span class="lineNum">    1592 </span><span class="lineNoCov">          0 :     for ( k=0; k&lt;sf-&gt;subfontcnt; ++k ) {</span>
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :         if ( curmax &lt; sf-&gt;subfonts[k]-&gt;glyphcnt )</span>
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :             curmax = sf-&gt;subfonts[k]-&gt;glyphcnt;</span>
<span class="lineNum">    1595 </span>            :     }
<span class="lineNum">    1596 </span>            : 
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :     glyphs = calloc(curmax,sizeof(SplineChar *));</span>
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;curmax; ++i ) {</span>
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 :         for ( k=0; k&lt;sf-&gt;subfontcnt; ++k )</span>
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :             if ( i&lt;sf-&gt;subfonts[k]-&gt;glyphcnt &amp;&amp; sf-&gt;subfonts[k]-&gt;glyphs[i]!=NULL ) {</span>
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :                 glyphs[i] = sf-&gt;subfonts[k]-&gt;glyphs[i];</span>
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :                 sf-&gt;subfonts[k]-&gt;glyphs[i] = NULL;</span>
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1604 </span>            :             }
<span class="lineNum">    1605 </span>            :     }
<span class="lineNum">    1606 </span><span class="lineNoCov">          0 :     sf = CIDFlatten(sf,glyphs,curmax);</span>
<span class="lineNum">    1607 </span>            : 
<span class="lineNum">    1608 </span><span class="lineNoCov">          0 :     warned = false;</span>
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :     for ( fvs=sf-&gt;fv; fvs!=NULL; fvs=fvs-&gt;nextsame ) {</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :         EncMap *map = fvs-&gt;map;</span>
<span class="lineNum">    1611 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;2; ++j ) {</span>
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :             extras = 0;</span>
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;curmax; ++i ) {</span>
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :                 sc = glyphs[i];</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :                 if ( sc!=NULL ) {</span>
<span class="lineNum">    1616 </span><span class="lineNoCov">          0 :                     m = 0;</span>
<span class="lineNum">    1617 </span><span class="lineNoCov">          0 :                     for ( l=0; l&lt;cmap-&gt;groups[cmt_cid].n; ++l ) {</span>
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :                         if ( i&gt;=cmap-&gt;groups[cmt_cid].ranges[l].cid &amp;&amp;</span>
<span class="lineNum">    1619 </span><span class="lineNoCov">          0 :                                 i&lt;=cmap-&gt;groups[cmt_cid].ranges[l].cid +</span>
<span class="lineNum">    1620 </span><span class="lineNoCov">          0 :                                    cmap-&gt;groups[cmt_cid].ranges[l].last -</span>
<span class="lineNum">    1621 </span><span class="lineNoCov">          0 :                                     cmap-&gt;groups[cmt_cid].ranges[l].first ) {</span>
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 :                             if ( m&lt;sizeof(found)/sizeof(found[0]) )</span>
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :                                 found[m++] = l;</span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :                             else if ( !warned ) {</span>
<span class="lineNum">    1625 </span><span class="lineNoCov">          0 :                                 ff_post_notice(_(&quot;MultipleEncodingIgnored&quot;),</span>
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :                                         _(&quot;The glyph at CID %d is mapped to more than %d encodings. Only the first %d are handled.&quot;), i,</span>
<span class="lineNum">    1627 </span>            :                                         sizeof(found)/sizeof(found[0]),
<span class="lineNum">    1628 </span>            :                                         sizeof(found)/sizeof(found[0]));
<span class="lineNum">    1629 </span><span class="lineNoCov">          0 :                                 warned = true;</span>
<span class="lineNum">    1630 </span>            :                             }
<span class="lineNum">    1631 </span>            :                         }
<span class="lineNum">    1632 </span>            :                     }
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :                     if ( m==0 ) {</span>
<span class="lineNum">    1634 </span><span class="lineNoCov">          0 :                         if ( j ) {</span>
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :                             map-&gt;map[max+extras] = sc-&gt;orig_pos;</span>
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :                             map-&gt;backmap[sc-&gt;orig_pos] = max+extras;</span>
<span class="lineNum">    1637 </span>            :                         }
<span class="lineNum">    1638 </span><span class="lineNoCov">          0 :                         ++extras;</span>
<span class="lineNum">    1639 </span>            :                     } else {
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :                         if ( j ) {</span>
<span class="lineNum">    1641 </span><span class="lineNoCov">          0 :                             int p = cmap-&gt;groups[cmt_cid].ranges[found[0]].first +</span>
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 :                                     i-cmap-&gt;groups[cmt_cid].ranges[found[0]].cid;</span>
<span class="lineNum">    1643 </span><span class="lineNoCov">          0 :                             map-&gt;map[p] = sc-&gt;orig_pos;</span>
<span class="lineNum">    1644 </span><span class="lineNoCov">          0 :                             map-&gt;backmap[sc-&gt;orig_pos] = p;</span>
<span class="lineNum">    1645 </span><span class="lineNoCov">          0 :                             for ( l=1; l&lt;m; ++l ) {</span>
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :                                 int pos = cmap-&gt;groups[cmt_cid].ranges[found[l]].first +</span>
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :                                         i-cmap-&gt;groups[cmt_cid].ranges[found[l]].cid;</span>
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :                                 map-&gt;map[pos] = sc-&gt;orig_pos;</span>
<span class="lineNum">    1649 </span>            :                             }
<span class="lineNum">    1650 </span>            :                         }
<span class="lineNum">    1651 </span>            :                     }
<span class="lineNum">    1652 </span>            :                 }
<span class="lineNum">    1653 </span>            :             }
<span class="lineNum">    1654 </span><span class="lineNoCov">          0 :             if ( !j ) {</span>
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :                 map-&gt;map = realloc(map-&gt;map,(map-&gt;encmax = map-&gt;enccount = max+extras)*sizeof(int32));</span>
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 :                 memset(map-&gt;map,-1,map-&gt;enccount*sizeof(int32));</span>
<span class="lineNum">    1657 </span><span class="lineNoCov">          0 :                 memset(map-&gt;backmap,-1,sf-&gt;glyphcnt*sizeof(int32));</span>
<span class="lineNum">    1658 </span><span class="lineNoCov">          0 :                 fvs-&gt;selected = realloc(fvs-&gt;selected, map-&gt;enccount*sizeof(char));</span>
<span class="lineNum">    1659 </span><span class="lineNoCov">          0 :                 if (map-&gt;enccount &gt; sf-&gt;glyphcnt) {</span>
<span class="lineNum">    1660 </span><span class="lineNoCov">          0 :                     memset(fvs-&gt;selected+sf-&gt;glyphcnt, 0, map-&gt;enccount-sf-&gt;glyphcnt);</span>
<span class="lineNum">    1661 </span>            :                 }
<span class="lineNum">    1662 </span><span class="lineNoCov">          0 :                 map-&gt;remap = cmap-&gt;remap; cmap-&gt;remap = NULL;</span>
<span class="lineNum">    1663 </span>            :             }
<span class="lineNum">    1664 </span><span class="lineNoCov">          0 :             warned = true;</span>
<span class="lineNum">    1665 </span>            :         }
<span class="lineNum">    1666 </span>            :     }
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :     cmapfree(cmap);</span>
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 :     FontViewReformatAll(sf);</span>
<span class="lineNum">    1669 </span><span class="lineNoCov">          0 : return( true );</span>
<a name="1670"><span class="lineNum">    1670 </span>            : }</a>
<span class="lineNum">    1671 </span>            : 
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 : static int Enc2CMap(struct cmap *cmap,int enc) {</span>
<span class="lineNum">    1673 </span>            :     int i;
<span class="lineNum">    1674 </span>            : 
<span class="lineNum">    1675 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cmap-&gt;groups[cmt_cid].n; ++i )</span>
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 :         if ( enc&gt;=cmap-&gt;groups[cmt_cid].ranges[i].first &amp;&amp;</span>
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :                 enc&lt;=cmap-&gt;groups[cmt_cid].ranges[i].last )</span>
<span class="lineNum">    1678 </span><span class="lineNoCov">          0 : return( enc-cmap-&gt;groups[cmt_cid].ranges[i].first+</span>
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 :             cmap-&gt;groups[cmt_cid].ranges[i].cid );</span>
<span class="lineNum">    1680 </span>            : 
<span class="lineNum">    1681 </span><span class="lineNoCov">          0 : return( -1 );</span>
<a name="1682"><span class="lineNum">    1682 </span>            : }</a>
<span class="lineNum">    1683 </span>            : 
<span class="lineNum">    1684 </span><span class="lineNoCov">          0 : static void SFEncodeToCMap(SplineFont *cidmaster,SplineFont *sf,EncMap *oldmap, struct cmap *cmap) {</span>
<span class="lineNum">    1685 </span><span class="lineNoCov">          0 :     SplineChar *sc, *GID0=NULL;</span>
<span class="lineNum">    1686 </span><span class="lineNoCov">          0 :     int i,max=0, anyextras=0;</span>
<span class="lineNum">    1687 </span>            : 
<span class="lineNum">    1688 </span><span class="lineNoCov">          0 :     cidmaster-&gt;cidregistry = cmap-&gt;registry; cmap-&gt;registry = NULL;</span>
<span class="lineNum">    1689 </span><span class="lineNoCov">          0 :     cidmaster-&gt;ordering = cmap-&gt;ordering; cmap-&gt;ordering = NULL;</span>
<span class="lineNum">    1690 </span><span class="lineNoCov">          0 :     cidmaster-&gt;supplement = cmap-&gt;supplement;</span>
<span class="lineNum">    1691 </span>            : 
<span class="lineNum">    1692 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( (sc = sf-&gt;glyphs[i])!=NULL ) {</span>
<span class="lineNum">    1693 </span><span class="lineNoCov">          0 :         if ( strcmp(sc-&gt;name,&quot;.notdef&quot;)==0 )</span>
<span class="lineNum">    1694 </span><span class="lineNoCov">          0 :             sc-&gt;orig_pos = 0;</span>
<span class="lineNum">    1695 </span><span class="lineNoCov">          0 :         else if ( oldmap-&gt;backmap[i]==-1 )</span>
<span class="lineNum">    1696 </span><span class="lineNoCov">          0 :             sc-&gt;orig_pos = -1;</span>
<span class="lineNum">    1697 </span>            :         else {
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :             sc-&gt;orig_pos = Enc2CMap(cmap,oldmap-&gt;backmap[i]);</span>
<span class="lineNum">    1699 </span><span class="lineNoCov">          0 :             if ( sc-&gt;orig_pos==0 ) {</span>
<span class="lineNum">    1700 </span><span class="lineNoCov">          0 :                 if ( GID0==NULL )</span>
<span class="lineNum">    1701 </span><span class="lineNoCov">          0 :                     GID0 = sc;</span>
<span class="lineNum">    1702 </span>            :                 else
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :                     sc-&gt;orig_pos = -1;</span>
<span class="lineNum">    1704 </span>            :             }
<span class="lineNum">    1705 </span>            :         }
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :         if ( sc-&gt;orig_pos&gt;max ) max = sc-&gt;orig_pos;</span>
<span class="lineNum">    1707 </span><span class="lineNoCov">          0 :         else if ( sc-&gt;orig_pos==-1 ) ++anyextras;</span>
<span class="lineNum">    1708 </span>            :     }
<span class="lineNum">    1709 </span><span class="lineNoCov">          0 :     if ( GID0!=NULL )</span>
<span class="lineNum">    1710 </span><span class="lineNoCov">          0 :         GID0-&gt;orig_pos = ++max;</span>
<span class="lineNum">    1711 </span>            : 
<span class="lineNum">    1712 </span><span class="lineNoCov">          0 :     if ( anyextras ) {</span>
<span class="lineNum">    1713 </span>            :         char *buttons[3];
<span class="lineNum">    1714 </span><span class="lineNoCov">          0 :         buttons[0] = _(&quot;_Delete&quot;);</span>
<span class="lineNum">    1715 </span><span class="lineNoCov">          0 :         buttons[1] = _(&quot;_Add&quot;);</span>
<span class="lineNum">    1716 </span><span class="lineNoCov">          0 :         buttons[2] = NULL;</span>
<span class="lineNum">    1717 </span><span class="lineNoCov">          0 :         if ( ff_ask(_(&quot;Extraneous glyphs&quot;),(const char **) buttons,0,1,_(&quot;The current encoding contains glyphs which I cannot map to CIDs.\nShould I delete them or add them to the end (where they may conflict with future ros definitions)?&quot;))==1 ) {</span>
<span class="lineNum">    1718 </span><span class="lineNoCov">          0 :             if ( cmap!=NULL &amp;&amp; max&lt;cmap-&gt;total ) max = cmap-&gt;total;</span>
<span class="lineNum">    1719 </span><span class="lineNoCov">          0 :             anyextras = 0;</span>
<span class="lineNum">    1720 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( (sc = sf-&gt;glyphs[i])!=NULL ) {</span>
<span class="lineNum">    1721 </span><span class="lineNoCov">          0 :                 if ( sc-&gt;orig_pos == -1 ) sc-&gt;orig_pos = max + anyextras++;</span>
<span class="lineNum">    1722 </span>            :             }
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :             max += anyextras;</span>
<span class="lineNum">    1724 </span>            :         }
<span class="lineNum">    1725 </span>            :     }
<span class="lineNum">    1726 </span><span class="lineNoCov">          0 :     SFApplyOrdering(sf, max+1);</span>
<span class="lineNum">    1727 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1728 </span>            : 
<span class="lineNum">    1729 </span>            : /* If we change the ascent/descent of a sub font then consider changing the */
<span class="lineNum">    1730 </span>            : /*  as/ds of the master font. I used to think this irrelevant, but as the */
<a name="1731"><span class="lineNum">    1731 </span>            : /*  typoAscent/Descent is based on the master's ascent/descent it actually */</a>
<span class="lineNum">    1732 </span>            : /*  is meaningful. Set the master to the subfont with the most glyphs */
<span class="lineNum">    1733 </span><span class="lineNoCov">          0 : void CIDMasterAsDes(SplineFont *sf) {</span>
<span class="lineNum">    1734 </span><span class="lineNoCov">          0 :     SplineFont *cidmaster = sf-&gt;cidmaster;</span>
<span class="lineNum">    1735 </span>            :     SplineFont *best;
<span class="lineNum">    1736 </span>            :     int i, cid, cnt, bcnt;
<span class="lineNum">    1737 </span>            : 
<span class="lineNum">    1738 </span><span class="lineNoCov">          0 :     if ( cidmaster==NULL )</span>
<span class="lineNum">    1739 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1740 </span><span class="lineNoCov">          0 :     best = NULL; bcnt = 0;</span>
<span class="lineNum">    1741 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cidmaster-&gt;subfontcnt; ++i ) {</span>
<span class="lineNum">    1742 </span><span class="lineNoCov">          0 :         sf = cidmaster-&gt;subfonts[i];</span>
<span class="lineNum">    1743 </span><span class="lineNoCov">          0 :         for ( cid=cnt=0; cid&lt;sf-&gt;glyphcnt; ++cid )</span>
<span class="lineNum">    1744 </span><span class="lineNoCov">          0 :             if ( sf-&gt;glyphs[cid]!=NULL )</span>
<span class="lineNum">    1745 </span><span class="lineNoCov">          0 :                 ++cnt;</span>
<span class="lineNum">    1746 </span><span class="lineNoCov">          0 :         if ( cnt&gt;bcnt ) {</span>
<span class="lineNum">    1747 </span><span class="lineNoCov">          0 :             best = sf;</span>
<span class="lineNum">    1748 </span><span class="lineNoCov">          0 :             bcnt = cnt;</span>
<span class="lineNum">    1749 </span>            :         }
<span class="lineNum">    1750 </span>            :     }
<span class="lineNum">    1751 </span><span class="lineNoCov">          0 :     if ( best==NULL &amp;&amp; cidmaster-&gt;subfontcnt&gt;0 )</span>
<span class="lineNum">    1752 </span><span class="lineNoCov">          0 :         best = cidmaster-&gt;subfonts[0];</span>
<span class="lineNum">    1753 </span><span class="lineNoCov">          0 :     if ( best!=NULL ) {</span>
<span class="lineNum">    1754 </span><span class="lineNoCov">          0 :         double ratio = 1000.0/(best-&gt;ascent+best-&gt;descent);</span>
<span class="lineNum">    1755 </span><span class="lineNoCov">          0 :         int ascent = rint(best-&gt;ascent*ratio);</span>
<span class="lineNum">    1756 </span><span class="lineNoCov">          0 :         if ( cidmaster-&gt;ascent!=ascent || cidmaster-&gt;descent!=1000-ascent ) {</span>
<span class="lineNum">    1757 </span><span class="lineNoCov">          0 :             cidmaster-&gt;ascent = ascent;</span>
<span class="lineNum">    1758 </span><span class="lineNoCov">          0 :             cidmaster-&gt;descent = 1000-ascent;</span>
<span class="lineNum">    1759 </span>            :         }
<span class="lineNum">    1760 </span>            :     }
<a name="1761"><span class="lineNum">    1761 </span>            : }</a>
<span class="lineNum">    1762 </span>            : 
<span class="lineNum">    1763 </span><span class="lineNoCov">          0 : SplineFont *MakeCIDMaster(SplineFont *sf,EncMap *oldmap,int bycmap,char *cmapfilename, struct cidmap *cidmap) {</span>
<span class="lineNum">    1764 </span>            :     SplineFont *cidmaster;
<span class="lineNum">    1765 </span>            :     struct cidmap *map;
<span class="lineNum">    1766 </span>            :     struct cmap *cmap;
<span class="lineNum">    1767 </span>            :     FontViewBase *fvs;
<span class="lineNum">    1768 </span>            : 
<span class="lineNum">    1769 </span><span class="lineNoCov">          0 :     cidmaster = SplineFontEmpty();</span>
<span class="lineNum">    1770 </span><span class="lineNoCov">          0 :     if ( bycmap ) {</span>
<span class="lineNum">    1771 </span><span class="lineNoCov">          0 :         if ( cmapfilename==NULL ) {</span>
<span class="lineNum">    1772 </span><span class="lineNoCov">          0 :             SplineFontFree(cidmaster);</span>
<span class="lineNum">    1773 </span><span class="lineNoCov">          0 : return(NULL);</span>
<span class="lineNum">    1774 </span>            :         }
<span class="lineNum">    1775 </span><span class="lineNoCov">          0 :         cmap = ParseCMap(cmapfilename);</span>
<span class="lineNum">    1776 </span><span class="lineNoCov">          0 :         if ( cmap==NULL ) {</span>
<span class="lineNum">    1777 </span><span class="lineNoCov">          0 :             SplineFontFree(cidmaster);</span>
<span class="lineNum">    1778 </span><span class="lineNoCov">          0 : return(NULL);</span>
<span class="lineNum">    1779 </span>            :         }
<span class="lineNum">    1780 </span><span class="lineNoCov">          0 :         CompressCMap(cmap);</span>
<span class="lineNum">    1781 </span><span class="lineNoCov">          0 :         SFEncodeToCMap(cidmaster,sf,oldmap,cmap);</span>
<span class="lineNum">    1782 </span><span class="lineNoCov">          0 :         cmapfree(cmap);</span>
<span class="lineNum">    1783 </span>            :     } else {
<span class="lineNum">    1784 </span><span class="lineNoCov">          0 :         map = cidmap;</span>
<span class="lineNum">    1785 </span><span class="lineNoCov">          0 :         if ( map==NULL ) {</span>
<span class="lineNum">    1786 </span><span class="lineNoCov">          0 :             SplineFontFree(cidmaster);</span>
<span class="lineNum">    1787 </span><span class="lineNoCov">          0 : return(NULL);</span>
<span class="lineNum">    1788 </span>            :         }
<span class="lineNum">    1789 </span><span class="lineNoCov">          0 :         cidmaster-&gt;cidregistry = copy(map-&gt;registry);</span>
<span class="lineNum">    1790 </span><span class="lineNoCov">          0 :         cidmaster-&gt;ordering = copy(map-&gt;ordering);</span>
<span class="lineNum">    1791 </span><span class="lineNoCov">          0 :         cidmaster-&gt;supplement = map-&gt;supplement;</span>
<span class="lineNum">    1792 </span><span class="lineNoCov">          0 :         SFEncodeToMap(sf,map);</span>
<span class="lineNum">    1793 </span>            :     }
<span class="lineNum">    1794 </span><span class="lineNoCov">          0 :     if ( sf-&gt;uni_interp!=ui_none &amp;&amp; sf-&gt;uni_interp!=ui_unset )</span>
<span class="lineNum">    1795 </span><span class="lineNoCov">          0 :         cidmaster-&gt;uni_interp = sf-&gt;uni_interp;</span>
<span class="lineNum">    1796 </span><span class="lineNoCov">          0 :     else if ( strstrmatch(cidmaster-&gt;ordering,&quot;japan&quot;)!=NULL )</span>
<span class="lineNum">    1797 </span><span class="lineNoCov">          0 :         cidmaster-&gt;uni_interp = ui_japanese;</span>
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 :     else if ( strstrmatch(cidmaster-&gt;ordering,&quot;CNS&quot;)!=NULL )</span>
<span class="lineNum">    1799 </span><span class="lineNoCov">          0 :         cidmaster-&gt;uni_interp = ui_trad_chinese;</span>
<span class="lineNum">    1800 </span><span class="lineNoCov">          0 :     else if ( strstrmatch(cidmaster-&gt;ordering,&quot;GB&quot;)!=NULL )</span>
<span class="lineNum">    1801 </span><span class="lineNoCov">          0 :         cidmaster-&gt;uni_interp = ui_simp_chinese;</span>
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :     else if ( strstrmatch(cidmaster-&gt;ordering,&quot;Korea&quot;)!=NULL )</span>
<span class="lineNum">    1803 </span><span class="lineNoCov">          0 :         cidmaster-&gt;uni_interp = ui_korean;</span>
<span class="lineNum">    1804 </span><span class="lineNoCov">          0 :     sf-&gt;uni_interp = cidmaster-&gt;uni_interp;</span>
<span class="lineNum">    1805 </span><span class="lineNoCov">          0 :     cidmaster-&gt;fontname = copy(sf-&gt;fontname);</span>
<span class="lineNum">    1806 </span><span class="lineNoCov">          0 :     cidmaster-&gt;fullname = copy(sf-&gt;fullname);</span>
<span class="lineNum">    1807 </span><span class="lineNoCov">          0 :     cidmaster-&gt;familyname = copy(sf-&gt;familyname);</span>
<span class="lineNum">    1808 </span><span class="lineNoCov">          0 :     cidmaster-&gt;weight = copy(sf-&gt;weight);</span>
<span class="lineNum">    1809 </span><span class="lineNoCov">          0 :     cidmaster-&gt;copyright = copy(sf-&gt;copyright);</span>
<span class="lineNum">    1810 </span><span class="lineNoCov">          0 :     cidmaster-&gt;cidversion = 1.0;</span>
<span class="lineNum">    1811 </span><span class="lineNoCov">          0 :     cidmaster-&gt;display_antialias = sf-&gt;display_antialias;</span>
<span class="lineNum">    1812 </span><span class="lineNoCov">          0 :     cidmaster-&gt;display_size = sf-&gt;display_size;</span>
<span class="lineNum">    1813 </span><span class="lineNoCov">          0 :     cidmaster-&gt;ascent = sf-&gt;ascent /*880*/;</span>
<span class="lineNum">    1814 </span><span class="lineNoCov">          0 :     cidmaster-&gt;descent = sf-&gt;descent /*120*/;</span>
<span class="lineNum">    1815 </span><span class="lineNoCov">          0 :     cidmaster-&gt;changed = cidmaster-&gt;changed_since_autosave = true;</span>
<span class="lineNum">    1816 </span><span class="lineNoCov">          0 :     for ( fvs=sf-&gt;fv; fvs!=NULL; fvs=fvs-&gt;nextsame )</span>
<span class="lineNum">    1817 </span><span class="lineNoCov">          0 :         fvs-&gt;cidmaster = cidmaster;</span>
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :     cidmaster-&gt;fv = sf-&gt;fv;</span>
<span class="lineNum">    1819 </span><span class="lineNoCov">          0 :     sf-&gt;cidmaster = cidmaster;</span>
<span class="lineNum">    1820 </span><span class="lineNoCov">          0 :     cidmaster-&gt;subfontcnt = 1;</span>
<span class="lineNum">    1821 </span><span class="lineNoCov">          0 :     cidmaster-&gt;subfonts = calloc(2,sizeof(SplineFont *));</span>
<span class="lineNum">    1822 </span><span class="lineNoCov">          0 :     cidmaster-&gt;subfonts[0] = sf;</span>
<span class="lineNum">    1823 </span><span class="lineNoCov">          0 :     cidmaster-&gt;gpos_lookups = sf-&gt;gpos_lookups; sf-&gt;gpos_lookups = NULL;</span>
<span class="lineNum">    1824 </span><span class="lineNoCov">          0 :     cidmaster-&gt;gsub_lookups = sf-&gt;gsub_lookups; sf-&gt;gsub_lookups = NULL;</span>
<span class="lineNum">    1825 </span><span class="lineNoCov">          0 :     cidmaster-&gt;horiz_base = sf-&gt;horiz_base; sf-&gt;horiz_base = NULL;</span>
<span class="lineNum">    1826 </span><span class="lineNoCov">          0 :     cidmaster-&gt;vert_base = sf-&gt;vert_base; sf-&gt;vert_base = NULL;</span>
<span class="lineNum">    1827 </span><span class="lineNoCov">          0 :     cidmaster-&gt;possub = sf-&gt;possub; sf-&gt;possub = NULL;</span>
<span class="lineNum">    1828 </span><span class="lineNoCov">          0 :     cidmaster-&gt;kerns = sf-&gt;kerns; sf-&gt;kerns = NULL;</span>
<span class="lineNum">    1829 </span><span class="lineNoCov">          0 :     cidmaster-&gt;vkerns = sf-&gt;vkerns; sf-&gt;vkerns = NULL;</span>
<span class="lineNum">    1830 </span><span class="lineNoCov">          0 :     if ( sf-&gt;private==NULL )</span>
<span class="lineNum">    1831 </span><span class="lineNoCov">          0 :         sf-&gt;private = calloc(1,sizeof(struct psdict));</span>
<span class="lineNum">    1832 </span><span class="lineNoCov">          0 :     if ( !PSDictHasEntry(sf-&gt;private,&quot;lenIV&quot;))</span>
<span class="lineNum">    1833 </span><span class="lineNoCov">          0 :         PSDictChangeEntry(sf-&gt;private,&quot;lenIV&quot;,&quot;1&quot;);              /* It's 4 by default, in CIDs the convention seems to be 1 */</span>
<span class="lineNum">    1834 </span><span class="lineNoCov">          0 :     for ( fvs=sf-&gt;fv; fvs!=NULL; fvs=fvs-&gt;nextsame ) {</span>
<span class="lineNum">    1835 </span><span class="lineNoCov">          0 :         free(fvs-&gt;selected);</span>
<span class="lineNum">    1836 </span><span class="lineNoCov">          0 :         fvs-&gt;selected = calloc(fvs-&gt;sf-&gt;glyphcnt,sizeof(char));</span>
<span class="lineNum">    1837 </span><span class="lineNoCov">          0 :         EncMapFree(fvs-&gt;map);</span>
<span class="lineNum">    1838 </span><span class="lineNoCov">          0 :         fvs-&gt;map = EncMap1to1(fvs-&gt;sf-&gt;glyphcnt);</span>
<span class="lineNum">    1839 </span><span class="lineNoCov">          0 :         FVSetTitle(fvs);</span>
<span class="lineNum">    1840 </span>            :     }
<span class="lineNum">    1841 </span><span class="lineNoCov">          0 :     CIDMasterAsDes(sf);</span>
<span class="lineNum">    1842 </span><span class="lineNoCov">          0 :     FontViewReformatAll(sf);</span>
<span class="lineNum">    1843 </span><span class="lineNoCov">          0 : return( cidmaster );</span>
<a name="1844"><span class="lineNum">    1844 </span>            : }</a>
<span class="lineNum">    1845 </span>            : 
<span class="lineNum">    1846 </span><span class="lineNoCov">          0 : int CountOfEncoding(Encoding *encoding_name) {</span>
<span class="lineNum">    1847 </span><span class="lineNoCov">          0 : return( encoding_name-&gt;char_cnt );</span>
<a name="1848"><span class="lineNum">    1848 </span>            : }</a>
<span class="lineNum">    1849 </span>            : 
<span class="lineNum">    1850 </span><span class="lineNoCov">          0 : char *SFEncodingName(SplineFont *sf,EncMap *map) {</span>
<span class="lineNum">    1851 </span>            :     char buffer[130];
<span class="lineNum">    1852 </span>            : 
<span class="lineNum">    1853 </span><span class="lineNoCov">          0 :     if ( sf-&gt;cidmaster!=NULL )</span>
<span class="lineNum">    1854 </span><span class="lineNoCov">          0 :         sf = sf-&gt;cidmaster;</span>
<span class="lineNum">    1855 </span><span class="lineNoCov">          0 :     if ( sf-&gt;subfontcnt!=0 ) {</span>
<span class="lineNum">    1856 </span><span class="lineNoCov">          0 :         sprintf( buffer, &quot;%.50s-%.50s-%d&quot;, sf-&gt;cidregistry, sf-&gt;ordering, sf-&gt;supplement );</span>
<span class="lineNum">    1857 </span><span class="lineNoCov">          0 : return( copy( buffer ));</span>
<span class="lineNum">    1858 </span>            :     }
<span class="lineNum">    1859 </span><span class="lineNoCov">          0 : return( copy( map-&gt;enc-&gt;enc_name ));</span>
<span class="lineNum">    1860 </span>            : }
<span class="lineNum">    1861 </span>            : 
<a name="1862"><span class="lineNum">    1862 </span>            : /* ************************** Reencoding  routines ************************** */</a>
<span class="lineNum">    1863 </span>            : 
<span class="lineNum">    1864 </span><span class="lineNoCov">          0 : void BDFOrigFixup(BDFFont *bdf,int orig_cnt,SplineFont *sf) {</span>
<span class="lineNum">    1865 </span>            :     BDFChar **glyphs;
<span class="lineNum">    1866 </span>            :     int i;
<span class="lineNum">    1867 </span>            : 
<span class="lineNum">    1868 </span><span class="lineNoCov">          0 :     if ( bdf-&gt;glyphmax&gt;=orig_cnt ) {</span>
<span class="lineNum">    1869 </span><span class="lineNoCov">          0 :         if ( bdf-&gt;glyphcnt&lt;orig_cnt ) {</span>
<span class="lineNum">    1870 </span><span class="lineNoCov">          0 :             for ( i=bdf-&gt;glyphcnt; i&lt;orig_cnt; ++i )</span>
<span class="lineNum">    1871 </span><span class="lineNoCov">          0 :                 bdf-&gt;glyphs[i] = NULL;</span>
<span class="lineNum">    1872 </span><span class="lineNoCov">          0 :             bdf-&gt;glyphcnt = orig_cnt;</span>
<span class="lineNum">    1873 </span>            :         }
<span class="lineNum">    1874 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1875 </span>            :     }
<span class="lineNum">    1876 </span>            : 
<span class="lineNum">    1877 </span><span class="lineNoCov">          0 :     glyphs = calloc(orig_cnt,sizeof(BDFChar *));</span>
<span class="lineNum">    1878 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;bdf-&gt;glyphcnt; ++i ) if ( sf-&gt;glyphs[i]!=NULL ) {</span>
<span class="lineNum">    1879 </span><span class="lineNoCov">          0 :         glyphs[sf-&gt;glyphs[i]-&gt;orig_pos] = bdf-&gt;glyphs[i];</span>
<span class="lineNum">    1880 </span><span class="lineNoCov">          0 :         if ( bdf-&gt;glyphs[i]!=NULL )  /* Not all glyphs exist in a piecemeal font */</span>
<span class="lineNum">    1881 </span><span class="lineNoCov">          0 :             bdf-&gt;glyphs[i]-&gt;orig_pos = sf-&gt;glyphs[i]-&gt;orig_pos;</span>
<span class="lineNum">    1882 </span>            :     }
<span class="lineNum">    1883 </span><span class="lineNoCov">          0 :     free(bdf-&gt;glyphs);</span>
<span class="lineNum">    1884 </span><span class="lineNoCov">          0 :     bdf-&gt;glyphs = glyphs;</span>
<span class="lineNum">    1885 </span><span class="lineNoCov">          0 :     bdf-&gt;glyphcnt = bdf-&gt;glyphmax = orig_cnt;</span>
<span class="lineNum">    1886 </span><span class="lineNoCov">          0 :     bdf-&gt;ticked = true;</span>
<a name="1887"><span class="lineNum">    1887 </span>            : }</a>
<span class="lineNum">    1888 </span>            : 
<span class="lineNum">    1889 </span><span class="lineNoCov">          0 : static int _SFForceEncoding(SplineFont *sf,EncMap *old, Encoding *new_enc) {</span>
<span class="lineNum">    1890 </span>            :     int enc_cnt,i;
<span class="lineNum">    1891 </span>            :     BDFFont *bdf;
<span class="lineNum">    1892 </span>            :     FontViewBase *fvs;
<span class="lineNum">    1893 </span>            : 
<span class="lineNum">    1894 </span>            :     /* Normally we base our encoding process on unicode code points. */
<span class="lineNum">    1895 </span>            :     /*  but encodings like AdobeStandard are more interested in names than */
<span class="lineNum">    1896 </span>            :     /*  code points. It is perfectly possible to have a font properly */
<span class="lineNum">    1897 </span>            :     /*  encoded by code point which is not properly encoded by name */
<span class="lineNum">    1898 </span>            :     /*  (might have f_i where it should have fi). So even if it's got */
<span class="lineNum">    1899 </span>            :     /*  the right encoding, we still may want to force the names */
<span class="lineNum">    1900 </span><span class="lineNoCov">          0 :     if ( new_enc-&gt;is_custom )</span>
<span class="lineNum">    1901 </span><span class="lineNoCov">          0 : return(false);                  /* Custom, it's whatever's there */</span>
<span class="lineNum">    1902 </span>            : 
<span class="lineNum">    1903 </span><span class="lineNoCov">          0 :     if ( new_enc-&gt;is_original ) {</span>
<span class="lineNum">    1904 </span>            :         SplineChar **glyphs;
<span class="lineNum">    1905 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( sf-&gt;glyphs[i]!=NULL )</span>
<span class="lineNum">    1906 </span><span class="lineNoCov">          0 :             sf-&gt;glyphs[i]-&gt;orig_pos = -1;</span>
<span class="lineNum">    1907 </span><span class="lineNoCov">          0 :         for ( i=enc_cnt=0; i&lt;old-&gt;enccount; ++i )</span>
<span class="lineNum">    1908 </span><span class="lineNoCov">          0 :             if ( old-&gt;map[i]!=-1 &amp;&amp; sf-&gt;glyphs[old-&gt;map[i]]!=NULL &amp;&amp;</span>
<span class="lineNum">    1909 </span><span class="lineNoCov">          0 :                     sf-&gt;glyphs[old-&gt;map[i]]-&gt;orig_pos == -1 )</span>
<span class="lineNum">    1910 </span><span class="lineNoCov">          0 :                 sf-&gt;glyphs[old-&gt;map[i]]-&gt;orig_pos = enc_cnt++;</span>
<span class="lineNum">    1911 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( sf-&gt;glyphs[i]!=NULL )</span>
<span class="lineNum">    1912 </span><span class="lineNoCov">          0 :             if ( sf-&gt;glyphs[i]-&gt;orig_pos==-1 )</span>
<span class="lineNum">    1913 </span><span class="lineNoCov">          0 :                 sf-&gt;glyphs[i]-&gt;orig_pos = enc_cnt++;</span>
<span class="lineNum">    1914 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( sf-&gt;glyphs[i]!=NULL ) {</span>
<span class="lineNum">    1915 </span>            :             struct splinecharlist *scl;
<span class="lineNum">    1916 </span>            :             int layer;
<span class="lineNum">    1917 </span>            :             RefChar *ref;
<span class="lineNum">    1918 </span>            : 
<span class="lineNum">    1919 </span><span class="lineNoCov">          0 :             for ( scl=sf-&gt;glyphs[i]-&gt;dependents; scl!=NULL; scl=scl-&gt;next ) {</span>
<span class="lineNum">    1920 </span><span class="lineNoCov">          0 :                 for ( layer=0; layer&lt;scl-&gt;sc-&gt;layer_cnt; ++layer )</span>
<span class="lineNum">    1921 </span><span class="lineNoCov">          0 :                     for ( ref = scl-&gt;sc-&gt;layers[layer].refs; ref!=NULL; ref=ref-&gt;next )</span>
<span class="lineNum">    1922 </span><span class="lineNoCov">          0 :                         ref-&gt;orig_pos = ref-&gt;sc-&gt;orig_pos;</span>
<span class="lineNum">    1923 </span>            :             }
<span class="lineNum">    1924 </span>            :         }
<span class="lineNum">    1925 </span><span class="lineNoCov">          0 :         for ( fvs=sf-&gt;fv; fvs!=NULL; fvs=fvs-&gt;nextsame ) {</span>
<span class="lineNum">    1926 </span><span class="lineNoCov">          0 :             fvs-&gt;map-&gt;ticked = false;</span>
<span class="lineNum">    1927 </span>            :             /*if ( fvs-&gt;filled!=NULL ) fvs-&gt;filled-&gt;ticked = false;*/
<span class="lineNum">    1928 </span>            :         }
<span class="lineNum">    1929 </span><span class="lineNoCov">          0 :         for ( fvs=sf-&gt;fv; fvs!=NULL; fvs=fvs-&gt;nextsame ) if ( !fvs-&gt;map-&gt;ticked ) {</span>
<span class="lineNum">    1930 </span><span class="lineNoCov">          0 :             EncMap *map = fvs-&gt;map;</span>
<span class="lineNum">    1931 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;map-&gt;enccount; ++i ) if ( map-&gt;map[i]!=-1 )</span>
<span class="lineNum">    1932 </span><span class="lineNoCov">          0 :                 map-&gt;map[i] = sf-&gt;glyphs[map-&gt;map[i]]-&gt;orig_pos;</span>
<span class="lineNum">    1933 </span><span class="lineNoCov">          0 :             if ( enc_cnt&gt;map-&gt;backmax ) {</span>
<span class="lineNum">    1934 </span><span class="lineNoCov">          0 :                 free(map-&gt;backmap);</span>
<span class="lineNum">    1935 </span><span class="lineNoCov">          0 :                 map-&gt;backmax = enc_cnt;</span>
<span class="lineNum">    1936 </span><span class="lineNoCov">          0 :                 map-&gt;backmap = malloc(enc_cnt*sizeof(int32));</span>
<span class="lineNum">    1937 </span>            :             }
<span class="lineNum">    1938 </span><span class="lineNoCov">          0 :             memset(map-&gt;backmap,-1,enc_cnt*sizeof(int32));</span>
<span class="lineNum">    1939 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;map-&gt;enccount; ++i ) if ( map-&gt;map[i]!=-1 )</span>
<span class="lineNum">    1940 </span><span class="lineNoCov">          0 :                 if ( map-&gt;backmap[map-&gt;map[i]]==-1 )</span>
<span class="lineNum">    1941 </span><span class="lineNoCov">          0 :                     map-&gt;backmap[map-&gt;map[i]] = i;</span>
<span class="lineNum">    1942 </span><span class="lineNoCov">          0 :             map-&gt;ticked = true;</span>
<span class="lineNum">    1943 </span>            :         }
<span class="lineNum">    1944 </span><span class="lineNoCov">          0 :         if ( !old-&gt;ticked )</span>
<span class="lineNum">    1945 </span><span class="lineNoCov">          0 :             IError( &quot;Unticked encmap&quot; );</span>
<span class="lineNum">    1946 </span><span class="lineNoCov">          0 :         for ( bdf=sf-&gt;bitmaps; bdf!=NULL; bdf=bdf-&gt;next )</span>
<span class="lineNum">    1947 </span><span class="lineNoCov">          0 :             BDFOrigFixup(bdf,enc_cnt,sf);</span>
<span class="lineNum">    1948 </span><span class="lineNoCov">          0 :         for ( fvs=sf-&gt;fv; fvs!=NULL ; fvs=fvs-&gt;nextsame )</span>
<span class="lineNum">    1949 </span><span class="lineNoCov">          0 :             FVBiggerGlyphCache(fvs,enc_cnt);</span>
<span class="lineNum">    1950 </span><span class="lineNoCov">          0 :         glyphs = calloc(enc_cnt,sizeof(SplineChar *));</span>
<span class="lineNum">    1951 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( sf-&gt;glyphs[i]!=NULL )</span>
<span class="lineNum">    1952 </span><span class="lineNoCov">          0 :             glyphs[sf-&gt;glyphs[i]-&gt;orig_pos] = sf-&gt;glyphs[i];</span>
<span class="lineNum">    1953 </span><span class="lineNoCov">          0 :         free(sf-&gt;glyphs);</span>
<span class="lineNum">    1954 </span><span class="lineNoCov">          0 :         sf-&gt;glyphs = glyphs;</span>
<span class="lineNum">    1955 </span><span class="lineNoCov">          0 :         sf-&gt;glyphcnt = sf-&gt;glyphmax = enc_cnt;</span>
<span class="lineNum">    1956 </span><span class="lineNoCov">          0 : return( true );</span>
<span class="lineNum">    1957 </span>            :     }
<span class="lineNum">    1958 </span>            : 
<span class="lineNum">    1959 </span><span class="lineNoCov">          0 :     enc_cnt = new_enc-&gt;char_cnt;</span>
<span class="lineNum">    1960 </span>            : 
<span class="lineNum">    1961 </span><span class="lineNoCov">          0 :     if ( old-&gt;enccount&lt;enc_cnt ) {</span>
<span class="lineNum">    1962 </span><span class="lineNoCov">          0 :         if ( old-&gt;encmax&lt;enc_cnt ) {</span>
<span class="lineNum">    1963 </span><span class="lineNoCov">          0 :             old-&gt;map = realloc(old-&gt;map,enc_cnt*sizeof(int32));</span>
<span class="lineNum">    1964 </span><span class="lineNoCov">          0 :             old-&gt;encmax = enc_cnt;</span>
<span class="lineNum">    1965 </span>            :         }
<span class="lineNum">    1966 </span><span class="lineNoCov">          0 :         memset(old-&gt;map+old-&gt;enccount,-1,(enc_cnt-old-&gt;enccount)*sizeof(int32));</span>
<span class="lineNum">    1967 </span><span class="lineNoCov">          0 :         old-&gt;enccount = enc_cnt;</span>
<span class="lineNum">    1968 </span>            :     }
<span class="lineNum">    1969 </span><span class="lineNoCov">          0 :     old-&gt;enc = new_enc;</span>
<span class="lineNum">    1970 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;old-&gt;enccount &amp;&amp; i&lt;enc_cnt; ++i ) if ( old-&gt;map[i]!=-1 &amp;&amp; sf-&gt;glyphs[old-&gt;map[i]]!=NULL ) {</span>
<span class="lineNum">    1971 </span>            :         SplineChar dummy;
<span class="lineNum">    1972 </span><span class="lineNoCov">          0 :         int j = old-&gt;map[i];</span>
<span class="lineNum">    1973 </span><span class="lineNoCov">          0 :         SCBuildDummy(&amp;dummy,sf,old,i);</span>
<span class="lineNum">    1974 </span><span class="lineNoCov">          0 :         sf-&gt;glyphs[j]-&gt;unicodeenc = dummy.unicodeenc;</span>
<span class="lineNum">    1975 </span><span class="lineNoCov">          0 :         free(sf-&gt;glyphs[j]-&gt;name);</span>
<span class="lineNum">    1976 </span><span class="lineNoCov">          0 :         sf-&gt;glyphs[j]-&gt;name = copy(dummy.name);</span>
<span class="lineNum">    1977 </span>            :     }
<span class="lineNum">    1978 </span>            :     /* We just changed the unicode values for most glyphs */
<span class="lineNum">    1979 </span>            :     /* but any references to them will have the old values, and that's bad, so fix 'em up */
<span class="lineNum">    1980 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( sf-&gt;glyphs[i]!=NULL ) {</span>
<span class="lineNum">    1981 </span>            :         struct splinecharlist *scl;
<span class="lineNum">    1982 </span>            :         int layer;
<span class="lineNum">    1983 </span>            :         RefChar *ref;
<span class="lineNum">    1984 </span>            : 
<span class="lineNum">    1985 </span><span class="lineNoCov">          0 :         for ( scl=sf-&gt;glyphs[i]-&gt;dependents; scl!=NULL; scl=scl-&gt;next ) {</span>
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :             for ( layer=0; layer&lt;scl-&gt;sc-&gt;layer_cnt; ++layer )</span>
<span class="lineNum">    1987 </span><span class="lineNoCov">          0 :                 for ( ref = scl-&gt;sc-&gt;layers[layer].refs; ref!=NULL; ref=ref-&gt;next )</span>
<span class="lineNum">    1988 </span><span class="lineNoCov">          0 :                     ref-&gt;unicode_enc = ref-&gt;sc-&gt;unicodeenc;</span>
<span class="lineNum">    1989 </span>            :         }
<span class="lineNum">    1990 </span>            :     }
<span class="lineNum">    1991 </span><span class="lineNoCov">          0 : return( true );</span>
<a name="1992"><span class="lineNum">    1992 </span>            : }</a>
<span class="lineNum">    1993 </span>            : 
<span class="lineNum">    1994 </span><span class="lineNoCov">          0 : int SFForceEncoding(SplineFont *sf,EncMap *old, Encoding *new_enc) {</span>
<span class="lineNum">    1995 </span><span class="lineNoCov">          0 :     if ( sf-&gt;mm!=NULL ) {</span>
<span class="lineNum">    1996 </span><span class="lineNoCov">          0 :         MMSet *mm = sf-&gt;mm;</span>
<span class="lineNum">    1997 </span>            :         int i;
<span class="lineNum">    1998 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;mm-&gt;instance_count; ++i )</span>
<span class="lineNum">    1999 </span><span class="lineNoCov">          0 :             _SFForceEncoding(mm-&gt;instances[i],old,new_enc);</span>
<span class="lineNum">    2000 </span><span class="lineNoCov">          0 :         _SFForceEncoding(mm-&gt;normal,old,new_enc);</span>
<span class="lineNum">    2001 </span>            :     } else
<span class="lineNum">    2002 </span><span class="lineNoCov">          0 : return( _SFForceEncoding(sf,old,new_enc));</span>
<span class="lineNum">    2003 </span>            : 
<span class="lineNum">    2004 </span><span class="lineNoCov">          0 : return( true );</span>
<a name="2005"><span class="lineNum">    2005 </span>            : }</a>
<span class="lineNum">    2006 </span>            : 
<span class="lineNum">    2007 </span><span class="lineCov">          4 : EncMap *EncMapFromEncoding(SplineFont *sf,Encoding *enc) {</span>
<span class="lineNum">    2008 </span>            :     int i,j, extras, found, base, unmax;
<span class="lineNum">    2009 </span>            :     int32 *encoded, *unencoded;
<span class="lineNum">    2010 </span>            :     EncMap *map;
<span class="lineNum">    2011 </span>            :     struct altuni *altuni;
<span class="lineNum">    2012 </span>            :     SplineChar *sc;
<span class="lineNum">    2013 </span>            : 
<span class="lineNum">    2014 </span><span class="lineCov">          4 :     if ( enc==NULL )</span>
<span class="lineNum">    2015 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2016 </span>            : 
<span class="lineNum">    2017 </span><span class="lineCov">          4 :     base = enc-&gt;char_cnt;</span>
<span class="lineNum">    2018 </span><span class="lineCov">          4 :     if ( enc-&gt;is_original )</span>
<span class="lineNum">    2019 </span><span class="lineCov">          3 :         base = 0;</span>
<span class="lineNum">    2020 </span><span class="lineCov">          1 :     else if ( enc-&gt;char_cnt&lt;=256 )</span>
<span class="lineNum">    2021 </span><span class="lineCov">          1 :         base = 256;</span>
<span class="lineNum">    2022 </span><span class="lineNoCov">          0 :     else if ( enc-&gt;char_cnt&lt;=0x10000 )</span>
<span class="lineNum">    2023 </span><span class="lineNoCov">          0 :         base = 0x10000;</span>
<span class="lineNum">    2024 </span><span class="lineCov">          4 :     encoded = malloc(base*sizeof(int32));</span>
<span class="lineNum">    2025 </span><span class="lineCov">          4 :     memset(encoded,-1,base*sizeof(int32));</span>
<span class="lineNum">    2026 </span><span class="lineCov">          4 :     unencoded = malloc(sf-&gt;glyphcnt*sizeof(int32));</span>
<span class="lineNum">    2027 </span><span class="lineCov">          4 :     unmax = sf-&gt;glyphcnt;</span>
<span class="lineNum">    2028 </span>            : 
<span class="lineNum">    2029 </span><span class="lineCov">      69247 :     for ( i=extras=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( (sc=sf-&gt;glyphs[i])!=NULL ) {</span>
<span class="lineNum">    2030 </span><span class="lineCov">       1692 :         found = false;</span>
<span class="lineNum">    2031 </span><span class="lineCov">       1692 :         if ( enc-&gt;psnames!=NULL ) {</span>
<span class="lineNum">    2032 </span><span class="lineCov">      59110 :             for ( j=enc-&gt;char_cnt-1; j&gt;=0; --j ) {</span>
<span class="lineNum">    2033 </span><span class="lineCov">     117760 :                 if ( enc-&gt;psnames[j]!=NULL &amp;&amp;</span>
<span class="lineNum">    2034 </span><span class="lineCov">      58880 :                         strcmp(enc-&gt;psnames[j],sc-&gt;name)==0 ) {</span>
<span class="lineNum">    2035 </span><span class="lineCov">        149 :                     found = true;</span>
<span class="lineNum">    2036 </span><span class="lineCov">        149 :                     encoded[j] = i;</span>
<span class="lineNum">    2037 </span>            :                 }
<span class="lineNum">    2038 </span>            :             }
<span class="lineNum">    2039 </span>            :         }
<span class="lineNum">    2040 </span><span class="lineCov">       1692 :         if ( !found ) {</span>
<span class="lineNum">    2041 </span><span class="lineCov">       3072 :             if ( sc-&gt;unicodeenc!=-1 &amp;&amp;</span>
<span class="lineNum">    2042 </span><span class="lineCov">       3058 :                  sc-&gt;unicodeenc &lt; (int)unicode4_size &amp;&amp;</span>
<span class="lineNum">    2043 </span><span class="lineCov">       1529 :                      (j = EncFromUni(sc-&gt;unicodeenc,enc))!= -1 )</span>
<span class="lineNum">    2044 </span><span class="lineCov">          1 :                 encoded[j] = i;</span>
<span class="lineNum">    2045 </span>            :             else {
<span class="lineNum">    2046 </span>            :                 /* I don't think extras can surpass unmax now, but it doesn't */
<span class="lineNum">    2047 </span>            :                 /*  hurt to leave the code (it's from when we encoded duplicates see below) */
<span class="lineNum">    2048 </span><span class="lineCov">       1542 :                 if ( extras&gt;=unmax ) unencoded = realloc(unencoded,(unmax+=300)*sizeof(int32));</span>
<span class="lineNum">    2049 </span><span class="lineCov">       1542 :                 unencoded[extras++] = i;</span>
<span class="lineNum">    2050 </span>            :             }
<span class="lineNum">    2051 </span><span class="lineCov">       1544 :             for ( altuni=sc-&gt;altuni; altuni!=NULL; altuni=altuni-&gt;next ) {</span>
<span class="lineNum">    2052 </span><span class="lineCov">          2 :                 if ( altuni-&gt;unienc!=-1 &amp;&amp;</span>
<span class="lineNum">    2053 </span><span class="lineCov">          2 :                      (uint32)altuni-&gt;unienc&lt;unicode4_size &amp;&amp;</span>
<span class="lineNum">    2054 </span><span class="lineCov">          2 :                          altuni-&gt;vs==-1 &amp;&amp;</span>
<span class="lineNum">    2055 </span><span class="lineCov">          2 :                          altuni-&gt;fid==0 &amp;&amp;</span>
<span class="lineNum">    2056 </span><span class="lineCov">          1 :                          (j = EncFromUni(altuni-&gt;unienc,enc))!= -1 )</span>
<span class="lineNum">    2057 </span><span class="lineNoCov">          0 :                     encoded[j] = i;</span>
<span class="lineNum">    2058 </span>            :                 /* I used to have code here to add these unencoded duplicates */
<span class="lineNum">    2059 </span>            :                 /*  but I don't really see any reason to do so. The main unicode */
<span class="lineNum">    2060 </span>            :                 /*  will occur, and any encoded duplicates so the glyph won't */
<span class="lineNum">    2061 </span>            :                 /*  vanish */
<span class="lineNum">    2062 </span>            :             }
<span class="lineNum">    2063 </span>            :         }
<span class="lineNum">    2064 </span>            :     }
<span class="lineNum">    2065 </span>            : 
<span class="lineNum">    2066 </span>            :     /* Some glyphs have both a pua encoding and an encoding in a non-bmp */
<span class="lineNum">    2067 </span>            :     /*  plane. Big5HK does and the AMS glyphs do */
<span class="lineNum">    2068 </span><span class="lineCov">          4 :     if ( enc-&gt;is_unicodefull &amp;&amp; (sf-&gt;uni_interp == ui_trad_chinese ||</span>
<span class="lineNum">    2069 </span><span class="lineNoCov">          0 :                                  sf-&gt;uni_interp == ui_ams )) {</span>
<span class="lineNum">    2070 </span>            :         extern const int cns14pua[], amspua[];
<span class="lineNum">    2071 </span><span class="lineNoCov">          0 :         const int *pua = sf-&gt;uni_interp == ui_ams? amspua : cns14pua;</span>
<span class="lineNum">    2072 </span><span class="lineNoCov">          0 :         for ( i=0xe000; i&lt;0xf8ff; ++i ) {</span>
<span class="lineNum">    2073 </span><span class="lineNoCov">          0 :             if ( pua[i-0xe000]!=0 )</span>
<span class="lineNum">    2074 </span><span class="lineNoCov">          0 :                 encoded[pua[i-0xe000]] = encoded[i];</span>
<span class="lineNum">    2075 </span>            :         }
<span class="lineNum">    2076 </span>            :     }
<span class="lineNum">    2077 </span>            : 
<span class="lineNum">    2078 </span><span class="lineCov">          4 :     if ( enc-&gt;psnames != NULL ) {</span>
<span class="lineNum">    2079 </span>            :         /* Names are more important than unicode code points for some encodings */
<span class="lineNum">    2080 </span>            :         /*  AdobeStandard for instance which won't work if you have a glyph  */
<span class="lineNum">    2081 </span>            :         /*  named &quot;f_i&quot; (must be &quot;fi&quot;) even though the code point is correct */
<span class="lineNum">    2082 </span>            :         /* The code above would match f_i where AS requires fi, so force the */
<span class="lineNum">    2083 </span>            :         /*  names to be correct. */
<span class="lineNum">    2084 </span><span class="lineCov">        257 :         for ( j=0; j&lt;enc-&gt;char_cnt; ++j ) {</span>
<span class="lineNum">    2085 </span><span class="lineCov">        406 :             if ( encoded[j]!=-1 &amp;&amp; enc-&gt;psnames[j]!=NULL &amp;&amp;</span>
<span class="lineNum">    2086 </span><span class="lineCov">        150 :                     strcmp(sf-&gt;glyphs[encoded[j]]-&gt;name,enc-&gt;psnames[j])!=0 ) {</span>
<span class="lineNum">    2087 </span><span class="lineCov">          1 :                 free(sf-&gt;glyphs[encoded[j]]-&gt;name);</span>
<span class="lineNum">    2088 </span><span class="lineCov">          1 :                 sf-&gt;glyphs[encoded[j]]-&gt;name = copy(enc-&gt;psnames[j]);</span>
<span class="lineNum">    2089 </span>            :             }
<span class="lineNum">    2090 </span>            :         }
<span class="lineNum">    2091 </span>            :     }
<span class="lineNum">    2092 </span>            : 
<span class="lineNum">    2093 </span><span class="lineCov">          4 :     map = chunkalloc(sizeof(EncMap));</span>
<span class="lineNum">    2094 </span><span class="lineCov">          4 :     map-&gt;enccount = map-&gt;encmax = base + extras;</span>
<span class="lineNum">    2095 </span><span class="lineCov">          4 :     map-&gt;map = malloc(map-&gt;enccount*sizeof(int32));</span>
<span class="lineNum">    2096 </span><span class="lineCov">          4 :     memcpy(map-&gt;map,encoded,base*sizeof(int32));</span>
<span class="lineNum">    2097 </span><span class="lineCov">          4 :     memcpy(map-&gt;map+base,unencoded,extras*sizeof(int32));</span>
<span class="lineNum">    2098 </span><span class="lineCov">          4 :     map-&gt;backmax = sf-&gt;glyphcnt;</span>
<span class="lineNum">    2099 </span><span class="lineCov">          4 :     map-&gt;backmap = malloc(sf-&gt;glyphcnt*sizeof(int32));</span>
<span class="lineNum">    2100 </span><span class="lineCov">          4 :     memset(map-&gt;backmap,-1,sf-&gt;glyphcnt*sizeof(int32));   /* Just in case there are some unencoded glyphs (duplicates perhaps) */</span>
<span class="lineNum">    2101 </span><span class="lineCov">       1802 :     for ( i = map-&gt;enccount-1; i&gt;=0; --i ) if ( map-&gt;map[i]!=-1 )</span>
<span class="lineNum">    2102 </span><span class="lineCov">       1692 :         map-&gt;backmap[map-&gt;map[i]] = i;</span>
<span class="lineNum">    2103 </span><span class="lineCov">          4 :     map-&gt;enc = enc;</span>
<span class="lineNum">    2104 </span>            : 
<span class="lineNum">    2105 </span><span class="lineCov">          4 :     free(encoded);</span>
<span class="lineNum">    2106 </span><span class="lineCov">          4 :     free(unencoded);</span>
<span class="lineNum">    2107 </span>            : 
<span class="lineNum">    2108 </span><span class="lineCov">          4 : return( map );</span>
<a name="2109"><span class="lineNum">    2109 </span>            : }</a>
<span class="lineNum">    2110 </span>            : 
<span class="lineNum">    2111 </span><span class="lineNoCov">          0 : EncMap *CompactEncMap(EncMap *map, SplineFont *sf) {</span>
<span class="lineNum">    2112 </span>            :     int i, inuse, gid;
<span class="lineNum">    2113 </span>            :     int32 *newmap;
<span class="lineNum">    2114 </span>            : 
<span class="lineNum">    2115 </span><span class="lineNoCov">          0 :     for ( i=inuse=0; i&lt;map-&gt;enccount ; ++i )</span>
<span class="lineNum">    2116 </span><span class="lineNoCov">          0 :         if ( (gid = map-&gt;map[i])!=-1 &amp;&amp; SCWorthOutputting(sf-&gt;glyphs[gid]))</span>
<span class="lineNum">    2117 </span><span class="lineNoCov">          0 :             ++inuse;</span>
<span class="lineNum">    2118 </span><span class="lineNoCov">          0 :     newmap = malloc(inuse*sizeof(int32));</span>
<span class="lineNum">    2119 </span><span class="lineNoCov">          0 :     for ( i=inuse=0; i&lt;map-&gt;enccount ; ++i )</span>
<span class="lineNum">    2120 </span><span class="lineNoCov">          0 :         if ( (gid = map-&gt;map[i])!=-1 &amp;&amp; SCWorthOutputting(sf-&gt;glyphs[gid]))</span>
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 :             newmap[inuse++] = gid;</span>
<span class="lineNum">    2122 </span><span class="lineNoCov">          0 :     free(map-&gt;map);</span>
<span class="lineNum">    2123 </span><span class="lineNoCov">          0 :     map-&gt;map = newmap;</span>
<span class="lineNum">    2124 </span><span class="lineNoCov">          0 :     map-&gt;enccount = inuse;</span>
<span class="lineNum">    2125 </span><span class="lineNoCov">          0 :     map-&gt;encmax = inuse;</span>
<span class="lineNum">    2126 </span><span class="lineNoCov">          0 :     map-&gt;enc = &amp;custom;</span>
<span class="lineNum">    2127 </span><span class="lineNoCov">          0 :     memset(map-&gt;backmap,-1,sf-&gt;glyphcnt*sizeof(int32));</span>
<span class="lineNum">    2128 </span><span class="lineNoCov">          0 :     for ( i=inuse-1; i&gt;=0; --i )</span>
<span class="lineNum">    2129 </span><span class="lineNoCov">          0 :         if ( (gid=map-&gt;map[i])!=-1 )</span>
<span class="lineNum">    2130 </span><span class="lineNoCov">          0 :             map-&gt;backmap[gid] = i;</span>
<span class="lineNum">    2131 </span><span class="lineNoCov">          0 : return( map );</span>
<a name="2132"><span class="lineNum">    2132 </span>            : }</a>
<span class="lineNum">    2133 </span>            : 
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 : static void BCProtectUndoes( Undoes *undo,BDFChar *bc ) {</span>
<span class="lineNum">    2135 </span><span class="lineNoCov">          0 :     BDFRefChar *brhead, *brprev=NULL, *brnext;</span>
<span class="lineNum">    2136 </span>            : 
<span class="lineNum">    2137 </span><span class="lineNoCov">          0 :     for ( ; undo!=NULL; undo=undo-&gt;next ) {</span>
<span class="lineNum">    2138 </span><span class="lineNoCov">          0 :         switch ( undo-&gt;undotype ) {</span>
<span class="lineNum">    2139 </span>            :           case ut_bitmap:
<span class="lineNum">    2140 </span><span class="lineNoCov">          0 :             for ( brhead=undo-&gt;u.bmpstate.refs; brhead != NULL; brhead=brnext ) {</span>
<span class="lineNum">    2141 </span><span class="lineNoCov">          0 :                 brnext = brhead-&gt;next;</span>
<span class="lineNum">    2142 </span><span class="lineNoCov">          0 :                 if ( brhead-&gt;bdfc == bc ) {</span>
<span class="lineNum">    2143 </span><span class="lineNoCov">          0 :                     BCPasteInto( &amp;undo-&gt;u.bmpstate,bc,brhead-&gt;xoff,brhead-&gt;yoff,false,false );</span>
<span class="lineNum">    2144 </span><span class="lineNoCov">          0 :                     if ( brprev == NULL )</span>
<span class="lineNum">    2145 </span><span class="lineNoCov">          0 :                         undo-&gt;u.bmpstate.refs = brnext;</span>
<span class="lineNum">    2146 </span>            :                     else
<span class="lineNum">    2147 </span><span class="lineNoCov">          0 :                         brprev-&gt;next = brnext;</span>
<span class="lineNum">    2148 </span><span class="lineNoCov">          0 :                     free( brhead );</span>
<span class="lineNum">    2149 </span>            :                 } else
<span class="lineNum">    2150 </span><span class="lineNoCov">          0 :                     brprev = brhead;</span>
<span class="lineNum">    2151 </span>            :             }
<span class="lineNum">    2152 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    2153 </span>            :           case ut_multiple:
<span class="lineNum">    2154 </span><span class="lineNoCov">          0 :             BCProtectUndoes( undo-&gt;u.multiple.mult,bc );</span>
<span class="lineNum">    2155 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    2156 </span>            :           case ut_composit:
<span class="lineNum">    2157 </span><span class="lineNoCov">          0 :             BCProtectUndoes( undo-&gt;u.composit.bitmaps,bc );</span>
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    2159 </span>            :         }
<span class="lineNum">    2160 </span>            :     }
<a name="2161"><span class="lineNum">    2161 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2162 </span>            : 
<span class="lineNum">    2163 </span><span class="lineCov">          3 : int SFReencode(SplineFont *sf, const char *encname, int force) {</span>
<span class="lineNum">    2164 </span>            :     Encoding *new_enc;
<span class="lineNum">    2165 </span><span class="lineCov">          3 :     FontViewBase *fv = sf-&gt;fv;</span>
<span class="lineNum">    2166 </span>            : 
<span class="lineNum">    2167 </span><span class="lineCov">          3 :     if ( strmatch(encname,&quot;compacted&quot;)==0 ) {</span>
<span class="lineNum">    2168 </span><span class="lineNoCov">          0 :         fv-&gt;normal = EncMapCopy(fv-&gt;map);</span>
<span class="lineNum">    2169 </span><span class="lineNoCov">          0 :         CompactEncMap(fv-&gt;map,sf);</span>
<span class="lineNum">    2170 </span>            :     } else {
<span class="lineNum">    2171 </span><span class="lineCov">          3 :         new_enc = FindOrMakeEncoding(encname);</span>
<span class="lineNum">    2172 </span><span class="lineCov">          3 :         if ( new_enc==NULL )</span>
<span class="lineNum">    2173 </span><span class="lineNoCov">          0 : return -1;</span>
<span class="lineNum">    2174 </span><span class="lineCov">          3 :         if ( force )</span>
<span class="lineNum">    2175 </span><span class="lineNoCov">          0 :             SFForceEncoding(sf,fv-&gt;map,new_enc);</span>
<span class="lineNum">    2176 </span><span class="lineCov">          3 :         else if ( new_enc==&amp;custom )</span>
<span class="lineNum">    2177 </span><span class="lineNoCov">          0 :             fv-&gt;map-&gt;enc = &amp;custom;</span>
<span class="lineNum">    2178 </span>            :         else {
<span class="lineNum">    2179 </span><span class="lineCov">          3 :             EncMap *map = EncMapFromEncoding(sf,new_enc);</span>
<span class="lineNum">    2180 </span><span class="lineCov">          3 :             EncMapFree(fv-&gt;map);</span>
<span class="lineNum">    2181 </span><span class="lineCov">          3 :             if (fv-&gt;sf != NULL &amp;&amp; fv-&gt;map == fv-&gt;sf-&gt;map) { fv-&gt;sf-&gt;map = map; }</span>
<span class="lineNum">    2182 </span><span class="lineCov">          3 :             fv-&gt;map = map;</span>
<span class="lineNum">    2183 </span><span class="lineCov">          3 :             if ( !no_windowing_ui )</span>
<span class="lineNum">    2184 </span><span class="lineNoCov">          0 :                 FVSetTitle(fv);</span>
<span class="lineNum">    2185 </span>            :         }
<span class="lineNum">    2186 </span><span class="lineCov">          3 :         if ( fv-&gt;normal!=NULL ) {</span>
<span class="lineNum">    2187 </span><span class="lineNoCov">          0 :             EncMapFree(fv-&gt;normal);</span>
<span class="lineNum">    2188 </span><span class="lineNoCov">          0 :             if (fv-&gt;sf != NULL &amp;&amp; fv-&gt;map == fv-&gt;sf-&gt;map) { fv-&gt;sf-&gt;map = NULL; }</span>
<span class="lineNum">    2189 </span><span class="lineNoCov">          0 :             fv-&gt;normal = NULL;</span>
<span class="lineNum">    2190 </span>            :         }
<span class="lineNum">    2191 </span><span class="lineCov">          3 :         SFReplaceEncodingBDFProps(sf,fv-&gt;map);</span>
<span class="lineNum">    2192 </span>            :     }
<span class="lineNum">    2193 </span><span class="lineCov">          3 :     free(fv-&gt;selected);</span>
<span class="lineNum">    2194 </span><span class="lineCov">          3 :     fv-&gt;selected = calloc(fv-&gt;map-&gt;enccount,sizeof(char));</span>
<span class="lineNum">    2195 </span><span class="lineCov">          3 :     if ( !no_windowing_ui )</span>
<span class="lineNum">    2196 </span><span class="lineNoCov">          0 :         FontViewReformatAll(sf);</span>
<span class="lineNum">    2197 </span>            : 
<span class="lineNum">    2198 </span><span class="lineCov">          3 : return 0;</span>
<a name="2199"><span class="lineNum">    2199 </span>            : }</a>
<span class="lineNum">    2200 </span>            : 
<span class="lineNum">    2201 </span><span class="lineNoCov">          0 : void SFRemoveGlyph( SplineFont *sf,SplineChar *sc ) {</span>
<span class="lineNum">    2202 </span>            :     struct splinecharlist *dep, *dnext;
<span class="lineNum">    2203 </span>            :     struct bdfcharlist *bdep, *bdnext;
<span class="lineNum">    2204 </span>            :     RefChar *rf, *refs, *rnext;
<span class="lineNum">    2205 </span>            :     BDFRefChar *bref, *brnext, *brprev;
<span class="lineNum">    2206 </span>            :     KernPair *kp, *kprev;
<span class="lineNum">    2207 </span>            :     int i;
<span class="lineNum">    2208 </span>            :     BDFFont *bdf;
<span class="lineNum">    2209 </span>            :     BDFChar *bfc, *dbc;
<span class="lineNum">    2210 </span>            :     int layer;
<span class="lineNum">    2211 </span>            : 
<span class="lineNum">    2212 </span><span class="lineNoCov">          0 :     if ( sc==NULL )</span>
<span class="lineNum">    2213 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2214 </span>            : 
<span class="lineNum">    2215 </span>            :     /* Close any open windows */
<span class="lineNum">    2216 </span><span class="lineNoCov">          0 :     SCCloseAllViews(sc);</span>
<span class="lineNum">    2217 </span>            : 
<span class="lineNum">    2218 </span>            :     /* Turn any references to this glyph into inline copies of it */
<span class="lineNum">    2219 </span><span class="lineNoCov">          0 :     for ( dep=sc-&gt;dependents; dep!=NULL; dep=dnext ) {</span>
<span class="lineNum">    2220 </span><span class="lineNoCov">          0 :         SplineChar *dsc = dep-&gt;sc;</span>
<span class="lineNum">    2221 </span><span class="lineNoCov">          0 :         dnext = dep-&gt;next;</span>
<span class="lineNum">    2222 </span>            :         /* May be more than one reference to us, colon has two refs to period */
<span class="lineNum">    2223 </span>            :         /*  but only one dlist entry */
<span class="lineNum">    2224 </span><span class="lineNoCov">          0 :         for ( layer=0; layer&lt;dsc-&gt;layer_cnt; ++layer ) {</span>
<span class="lineNum">    2225 </span><span class="lineNoCov">          0 :             for ( rf = dsc-&gt;layers[layer].refs; rf!=NULL; rf=rnext ) {</span>
<span class="lineNum">    2226 </span><span class="lineNoCov">          0 :                 rnext = rf-&gt;next;</span>
<span class="lineNum">    2227 </span><span class="lineNoCov">          0 :                 if ( rf-&gt;sc==sc )</span>
<span class="lineNum">    2228 </span><span class="lineNoCov">          0 :                     SCRefToSplines(dsc,rf,layer);</span>
<span class="lineNum">    2229 </span>            :             }
<span class="lineNum">    2230 </span>            :         }
<span class="lineNum">    2231 </span>            :     }
<span class="lineNum">    2232 </span>            : 
<span class="lineNum">    2233 </span><span class="lineNoCov">          0 :     for ( layer=0; layer&lt;sc-&gt;layer_cnt; ++layer ) {</span>
<span class="lineNum">    2234 </span><span class="lineNoCov">          0 :         for ( refs=sc-&gt;layers[layer].refs; refs!=NULL; refs = rnext ) {</span>
<span class="lineNum">    2235 </span><span class="lineNoCov">          0 :             rnext = refs-&gt;next;</span>
<span class="lineNum">    2236 </span><span class="lineNoCov">          0 :             SCRemoveDependent(sc,refs,layer);</span>
<span class="lineNum">    2237 </span>            :         }
<span class="lineNum">    2238 </span>            :     }
<span class="lineNum">    2239 </span>            : 
<span class="lineNum">    2240 </span>            :     /* Remove any kerning pairs that look at this character */
<span class="lineNum">    2241 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( sf-&gt;glyphs[i]!=NULL ) {</span>
<span class="lineNum">    2242 </span><span class="lineNoCov">          0 :         for ( kprev=NULL, kp=sf-&gt;glyphs[i]-&gt;kerns; kp!=NULL; kprev = kp, kp=kp-&gt;next ) {</span>
<span class="lineNum">    2243 </span><span class="lineNoCov">          0 :             if ( kp-&gt;sc==sc ) {</span>
<span class="lineNum">    2244 </span><span class="lineNoCov">          0 :                 if ( kprev==NULL )</span>
<span class="lineNum">    2245 </span><span class="lineNoCov">          0 :                     sf-&gt;glyphs[i]-&gt;kerns = kp-&gt;next;</span>
<span class="lineNum">    2246 </span>            :                 else
<span class="lineNum">    2247 </span><span class="lineNoCov">          0 :                     kprev-&gt;next = kp-&gt;next;</span>
<span class="lineNum">    2248 </span><span class="lineNoCov">          0 :                 kp-&gt;next = NULL;</span>
<span class="lineNum">    2249 </span><span class="lineNoCov">          0 :                 KernPairsFree(kp);</span>
<span class="lineNum">    2250 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    2251 </span>            :             }
<span class="lineNum">    2252 </span>            :         }
<span class="lineNum">    2253 </span>            :     }
<span class="lineNum">    2254 </span>            : 
<span class="lineNum">    2255 </span><span class="lineNoCov">          0 :     sf-&gt;glyphs[sc-&gt;orig_pos] = NULL;</span>
<span class="lineNum">    2256 </span>            : 
<span class="lineNum">    2257 </span><span class="lineNoCov">          0 :     for ( bdf=sf-&gt;bitmaps; bdf!=NULL; bdf = bdf-&gt;next ) {</span>
<span class="lineNum">    2258 </span><span class="lineNoCov">          0 :         if ( sc-&gt;orig_pos&lt;bdf-&gt;glyphcnt &amp;&amp; (bfc = bdf-&gt;glyphs[sc-&gt;orig_pos])!= NULL ) {</span>
<span class="lineNum">    2259 </span>            :             /* Turn any references to this glyph into inline copies of it */
<span class="lineNum">    2260 </span><span class="lineNoCov">          0 :             for ( bdep=bfc-&gt;dependents; bdep!=NULL; bdep=bdnext ) {</span>
<span class="lineNum">    2261 </span><span class="lineNoCov">          0 :                 dbc = bdep-&gt;bc;</span>
<span class="lineNum">    2262 </span><span class="lineNoCov">          0 :                 bdnext = bdep-&gt;next;</span>
<span class="lineNum">    2263 </span><span class="lineNoCov">          0 :                 brprev = NULL;</span>
<span class="lineNum">    2264 </span>            :                 /* May be more than one reference to us, colon has two refs to period */
<span class="lineNum">    2265 </span>            :                 /*  but only one dlist entry */
<span class="lineNum">    2266 </span><span class="lineNoCov">          0 :                 for ( bref = dbc-&gt;refs; bref!=NULL; bref=brnext ) {</span>
<span class="lineNum">    2267 </span><span class="lineNoCov">          0 :                     brnext = bref-&gt;next;</span>
<span class="lineNum">    2268 </span><span class="lineNoCov">          0 :                     if ( bref-&gt;bdfc==bfc ) {</span>
<span class="lineNum">    2269 </span><span class="lineNoCov">          0 :                         BCPasteInto( dbc,bref-&gt;bdfc,bref-&gt;xoff,bref-&gt;yoff,false,false );</span>
<span class="lineNum">    2270 </span><span class="lineNoCov">          0 :                         if ( brprev == NULL ) dbc-&gt;refs = brnext;</span>
<span class="lineNum">    2271 </span><span class="lineNoCov">          0 :                         else brprev-&gt;next = brnext;</span>
<span class="lineNum">    2272 </span><span class="lineNoCov">          0 :                         free( bref );</span>
<span class="lineNum">    2273 </span>            :                     } else
<span class="lineNum">    2274 </span><span class="lineNoCov">          0 :                         brprev = bref;</span>
<span class="lineNum">    2275 </span>            :                 }
<span class="lineNum">    2276 </span>            :             }
<span class="lineNum">    2277 </span>            :             /* Suppose we have deleted a reference from a composite glyph and than
<span class="lineNum">    2278 </span>            :              * going to remove the previously referenced glyph from the font. The
<span class="lineNum">    2279 </span>            :              * void reference still remains in the undoes stack, so that executing Undo/Redo
<span class="lineNum">    2280 </span>            :              * on the first glyph may lead to unpredictable effects. It is also
<span class="lineNum">    2281 </span>            :              * impossible to detect such problematic undoes checking just our
<span class="lineNum">    2282 </span>            :              * going-to-be-deleted glyph's dependents, because the composite character
<span class="lineNum">    2283 </span>            :              * no longer contains the problematic reference and so is not listed
<span class="lineNum">    2284 </span>            :              * in the dependents. Thus the only solution seems to be checking
<span class="lineNum">    2285 </span>            :              * every single glyph in the font.
<span class="lineNum">    2286 </span>            :              */
<span class="lineNum">    2287 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;bdf-&gt;glyphcnt; i++ ) if (( dbc = bdf-&gt;glyphs[i] ) != NULL ) {</span>
<span class="lineNum">    2288 </span><span class="lineNoCov">          0 :                 BCProtectUndoes( dbc-&gt;undoes,bfc );</span>
<span class="lineNum">    2289 </span><span class="lineNoCov">          0 :                 BCProtectUndoes( dbc-&gt;redoes,bfc );</span>
<span class="lineNum">    2290 </span>            :             }
<span class="lineNum">    2291 </span><span class="lineNoCov">          0 :             for ( bref=bfc-&gt;refs; refs!=NULL; bref = brnext ) {</span>
<span class="lineNum">    2292 </span><span class="lineNoCov">          0 :                 brnext = bref-&gt;next;</span>
<span class="lineNum">    2293 </span><span class="lineNoCov">          0 :                 BCRemoveDependent( bfc,bref );</span>
<span class="lineNum">    2294 </span>            :             }
<span class="lineNum">    2295 </span><span class="lineNoCov">          0 :             bdf-&gt;glyphs[sc-&gt;orig_pos] = NULL;</span>
<span class="lineNum">    2296 </span><span class="lineNoCov">          0 :             BDFCharFree(bfc);</span>
<span class="lineNum">    2297 </span>            :         }
<span class="lineNum">    2298 </span>            :     }
<span class="lineNum">    2299 </span>            : 
<span class="lineNum">    2300 </span><span class="lineNoCov">          0 :     SplineCharFree(sc);</span>
<span class="lineNum">    2301 </span><span class="lineNoCov">          0 :     GlyphHashFree(sf);</span>
<a name="2302"><span class="lineNum">    2302 </span>            : }</a>
<span class="lineNum">    2303 </span>            : 
<span class="lineNum">    2304 </span><span class="lineNoCov">          0 : static int MapAddEncodingSlot(EncMap *map,int gid) {</span>
<span class="lineNum">    2305 </span>            :     int enc;
<span class="lineNum">    2306 </span>            : 
<span class="lineNum">    2307 </span><span class="lineNoCov">          0 :     if ( map-&gt;enccount&gt;=map-&gt;encmax )</span>
<span class="lineNum">    2308 </span><span class="lineNoCov">          0 :         map-&gt;map = realloc(map-&gt;map,(map-&gt;encmax+=10)*sizeof(int32));</span>
<span class="lineNum">    2309 </span><span class="lineNoCov">          0 :     enc = map-&gt;enccount++;</span>
<span class="lineNum">    2310 </span><span class="lineNoCov">          0 :     map-&gt;map[enc] = gid;</span>
<span class="lineNum">    2311 </span><span class="lineNoCov">          0 :     map-&gt;backmap[gid] = enc;</span>
<span class="lineNum">    2312 </span><span class="lineNoCov">          0 : return( enc );</span>
<a name="2313"><span class="lineNum">    2313 </span>            : }</a>
<span class="lineNum">    2314 </span>            : 
<span class="lineNum">    2315 </span><span class="lineNoCov">          0 : void FVAddEncodingSlot(FontViewBase *fv,int gid) {</span>
<span class="lineNum">    2316 </span><span class="lineNoCov">          0 :     EncMap *map = fv-&gt;map;</span>
<span class="lineNum">    2317 </span>            :     int enc;
<span class="lineNum">    2318 </span>            : 
<span class="lineNum">    2319 </span><span class="lineNoCov">          0 :     enc = MapAddEncodingSlot(map,gid);</span>
<span class="lineNum">    2320 </span>            : 
<span class="lineNum">    2321 </span><span class="lineNoCov">          0 :     fv-&gt;selected = realloc(fv-&gt;selected,map-&gt;enccount);</span>
<span class="lineNum">    2322 </span><span class="lineNoCov">          0 :     fv-&gt;selected[enc] = 0;</span>
<span class="lineNum">    2323 </span><span class="lineNoCov">          0 :     FVAdjustScrollBarRows(fv,enc);</span>
<a name="2324"><span class="lineNum">    2324 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2325 </span>            : 
<span class="lineNum">    2326 </span><span class="lineNoCov">          0 : void SFAddEncodingSlot(SplineFont *sf,int gid) {</span>
<span class="lineNum">    2327 </span>            :     FontViewBase *fv;
<span class="lineNum">    2328 </span><span class="lineNoCov">          0 :     for ( fv=sf-&gt;fv; fv!=NULL; fv = fv-&gt;nextsame )</span>
<span class="lineNum">    2329 </span><span class="lineNoCov">          0 :         FVAddEncodingSlot(fv,gid);</span>
<a name="2330"><span class="lineNum">    2330 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2331 </span>            : 
<span class="lineNum">    2332 </span><span class="lineCov">        900 : static int MapAddEnc(SplineFont *sf,SplineChar *sc,EncMap *basemap, EncMap *map,int baseenc, int gid, FontViewBase *fv) {</span>
<span class="lineNum">    2333 </span><span class="lineCov">        900 :     int any = false, enc;</span>
<span class="lineNum">    2334 </span>            : 
<span class="lineNum">    2335 </span><span class="lineCov">        900 :     if ( gid&gt;=map-&gt;backmax ) {</span>
<span class="lineNum">    2336 </span><span class="lineCov">         64 :         map-&gt;backmap = realloc(map-&gt;backmap,(map-&gt;backmax+=10)*sizeof(int32));</span>
<span class="lineNum">    2337 </span><span class="lineCov">         64 :         memset(map-&gt;backmap+map-&gt;backmax-10,-1,10*sizeof(int32));</span>
<span class="lineNum">    2338 </span>            :     }
<span class="lineNum">    2339 </span><span class="lineCov">        900 :     if ( map-&gt;enc-&gt;psnames!=NULL ) {</span>
<span class="lineNum">    2340 </span>            :         /* Check for multiple encodings */
<span class="lineNum">    2341 </span><span class="lineNoCov">          0 :         for ( enc = map-&gt;enc-&gt;char_cnt-1; enc&gt;=0; --enc ) {</span>
<span class="lineNum">    2342 </span><span class="lineNoCov">          0 :             if ( map-&gt;enc-&gt;psnames[enc]!=NULL &amp;&amp; strcmp(sc-&gt;name,map-&gt;enc-&gt;psnames[enc])==0 ) {</span>
<span class="lineNum">    2343 </span><span class="lineNoCov">          0 :                 if ( !any ) {</span>
<span class="lineNum">    2344 </span><span class="lineNoCov">          0 :                     map-&gt;backmap[gid] = enc;</span>
<span class="lineNum">    2345 </span><span class="lineNoCov">          0 :                     any = true;</span>
<span class="lineNum">    2346 </span>            :                 }
<span class="lineNum">    2347 </span><span class="lineNoCov">          0 :                 map-&gt;map[enc] = gid;</span>
<span class="lineNum">    2348 </span>            :             }
<span class="lineNum">    2349 </span>            :         }
<span class="lineNum">    2350 </span>            :     } else {
<span class="lineNum">    2351 </span><span class="lineCov">        900 :         enc = SFFindSlot(sf,map,sc-&gt;unicodeenc,sc-&gt;name);</span>
<span class="lineNum">    2352 </span><span class="lineCov">        900 :         if ( enc!=-1 ) {</span>
<span class="lineNum">    2353 </span><span class="lineCov">        900 :             map-&gt;map[enc] = gid;</span>
<span class="lineNum">    2354 </span><span class="lineCov">        900 :             map-&gt;backmap[gid] = enc;</span>
<span class="lineNum">    2355 </span><span class="lineCov">        900 :             any = true;</span>
<span class="lineNum">    2356 </span>            :         }
<span class="lineNum">    2357 </span>            :     }
<span class="lineNum">    2358 </span><span class="lineCov">        900 :     if ( basemap!=NULL &amp;&amp; map-&gt;enc==basemap-&gt;enc &amp;&amp; baseenc!=-1 ) {</span>
<span class="lineNum">    2359 </span><span class="lineCov">        900 :         if ( baseenc&gt;=map-&gt;enccount ) {</span>
<span class="lineNum">    2360 </span><span class="lineNoCov">          0 :             if ( fv &amp;&amp; map==fv-&gt;map )</span>
<span class="lineNum">    2361 </span><span class="lineNoCov">          0 :                 FVAddEncodingSlot(fv,gid);</span>
<span class="lineNum">    2362 </span>            :             else
<span class="lineNum">    2363 </span><span class="lineNoCov">          0 :                 MapAddEncodingSlot(map,gid);</span>
<span class="lineNum">    2364 </span>            :         } else {
<span class="lineNum">    2365 </span><span class="lineCov">        900 :             map-&gt;map[baseenc] = gid;</span>
<span class="lineNum">    2366 </span><span class="lineCov">        900 :             if ( map-&gt;backmap[gid]==-1 )</span>
<span class="lineNum">    2367 </span><span class="lineNoCov">          0 :                 map-&gt;backmap[gid] = baseenc;</span>
<span class="lineNum">    2368 </span>            :         }
<span class="lineNum">    2369 </span><span class="lineCov">        900 :         any = true;</span>
<span class="lineNum">    2370 </span>            :     }
<span class="lineNum">    2371 </span><span class="lineCov">        900 : return( any );</span>
<a name="2372"><span class="lineNum">    2372 </span>            : }</a>
<span class="lineNum">    2373 </span>            : 
<span class="lineNum">    2374 </span><span class="lineCov">        900 : void SFAddGlyphAndEncode(SplineFont *sf,SplineChar *sc,EncMap *basemap, int baseenc) {</span>
<span class="lineNum">    2375 </span><span class="lineCov">        900 :     int gid, mapfound = false;</span>
<span class="lineNum">    2376 </span>            :     FontViewBase *fv;
<span class="lineNum">    2377 </span>            :     BDFFont *bdf;
<span class="lineNum">    2378 </span>            : 
<span class="lineNum">    2379 </span><span class="lineCov">        900 :     if ( sf-&gt;cidmaster==NULL ) {</span>
<span class="lineNum">    2380 </span><span class="lineCov">        900 :         if ( sf-&gt;glyphcnt+1&gt;=sf-&gt;glyphmax )</span>
<span class="lineNum">    2381 </span><span class="lineCov">         64 :             sf-&gt;glyphs = realloc(sf-&gt;glyphs,(sf-&gt;glyphmax+=10)*sizeof(SplineChar *));</span>
<span class="lineNum">    2382 </span><span class="lineCov">        900 :         gid = sf-&gt;glyphcnt++;</span>
<span class="lineNum">    2383 </span><span class="lineCov">       1793 :         for ( bdf = sf-&gt;bitmaps; bdf!=NULL; bdf=bdf-&gt;next ) {</span>
<span class="lineNum">    2384 </span><span class="lineCov">        893 :             if ( sf-&gt;glyphcnt+1&gt;=bdf-&gt;glyphmax )</span>
<span class="lineNum">    2385 </span><span class="lineCov">        129 :                 bdf-&gt;glyphs = realloc(bdf-&gt;glyphs,(bdf-&gt;glyphmax=sf-&gt;glyphmax)*sizeof(BDFChar *));</span>
<span class="lineNum">    2386 </span><span class="lineCov">        893 :             if ( sf-&gt;glyphcnt&gt;bdf-&gt;glyphcnt ) {</span>
<span class="lineNum">    2387 </span><span class="lineCov">        893 :                 memset(bdf-&gt;glyphs+bdf-&gt;glyphcnt,0,(sf-&gt;glyphcnt-bdf-&gt;glyphcnt)*sizeof(BDFChar *));</span>
<span class="lineNum">    2388 </span><span class="lineCov">        893 :                 bdf-&gt;glyphcnt = sf-&gt;glyphcnt;</span>
<span class="lineNum">    2389 </span>            :             }
<span class="lineNum">    2390 </span>            :         }
<span class="lineNum">    2391 </span><span class="lineCov">        907 :         for ( fv=sf-&gt;fv; fv!=NULL; fv = fv-&gt;nextsame ) {</span>
<span class="lineNum">    2392 </span><span class="lineCov">          7 :             EncMap *map = fv-&gt;map;</span>
<span class="lineNum">    2393 </span><span class="lineCov">          7 :             if ( gid&gt;=map-&gt;backmax )</span>
<span class="lineNum">    2394 </span><span class="lineNoCov">          0 :                 map-&gt;backmap = realloc(map-&gt;backmap,(map-&gt;backmax=gid+10)*sizeof(int32));</span>
<span class="lineNum">    2395 </span><span class="lineCov">          7 :             map-&gt;backmap[gid] = -1;</span>
<span class="lineNum">    2396 </span>            :         }
<span class="lineNum">    2397 </span>            :     } else {
<span class="lineNum">    2398 </span><span class="lineNoCov">          0 :         gid = baseenc;</span>
<span class="lineNum">    2399 </span><span class="lineNoCov">          0 :         if ( baseenc+1&gt;=sf-&gt;glyphmax )</span>
<span class="lineNum">    2400 </span><span class="lineNoCov">          0 :             sf-&gt;glyphs = realloc(sf-&gt;glyphs,(sf-&gt;glyphmax = baseenc+10)*sizeof(SplineChar *));</span>
<span class="lineNum">    2401 </span><span class="lineNoCov">          0 :         if ( baseenc&gt;=sf-&gt;glyphcnt ) {</span>
<span class="lineNum">    2402 </span><span class="lineNoCov">          0 :             memset(sf-&gt;glyphs+sf-&gt;glyphcnt,0,(baseenc+1-sf-&gt;glyphcnt)*sizeof(SplineChar *));</span>
<span class="lineNum">    2403 </span><span class="lineNoCov">          0 :             sf-&gt;glyphcnt = baseenc+1;</span>
<span class="lineNum">    2404 </span><span class="lineNoCov">          0 :             for ( bdf = sf-&gt;cidmaster-&gt;bitmaps; bdf!=NULL; bdf=bdf-&gt;next ) {</span>
<span class="lineNum">    2405 </span><span class="lineNoCov">          0 :                 if ( baseenc+1&gt;=bdf-&gt;glyphmax )</span>
<span class="lineNum">    2406 </span><span class="lineNoCov">          0 :                     bdf-&gt;glyphs = realloc(bdf-&gt;glyphs,(bdf-&gt;glyphmax=baseenc+10)*sizeof(BDFChar *));</span>
<span class="lineNum">    2407 </span><span class="lineNoCov">          0 :                 if ( baseenc+1&gt;bdf-&gt;glyphcnt ) {</span>
<span class="lineNum">    2408 </span><span class="lineNoCov">          0 :                     memset(bdf-&gt;glyphs+bdf-&gt;glyphcnt,0,(baseenc+1-bdf-&gt;glyphcnt)*sizeof(BDFChar *));</span>
<span class="lineNum">    2409 </span><span class="lineNoCov">          0 :                     bdf-&gt;glyphcnt = baseenc+1;</span>
<span class="lineNum">    2410 </span>            :                 }
<span class="lineNum">    2411 </span>            :             }
<span class="lineNum">    2412 </span><span class="lineNoCov">          0 :             for ( fv=sf-&gt;fv; fv!=NULL; fv = fv-&gt;nextsame ) if ( fv-&gt;sf==sf ) {</span>
<span class="lineNum">    2413 </span><span class="lineNoCov">          0 :                 EncMap *map = fv-&gt;map;</span>
<span class="lineNum">    2414 </span><span class="lineNoCov">          0 :                 if ( gid&gt;=map-&gt;backmax )</span>
<span class="lineNum">    2415 </span><span class="lineNoCov">          0 :                     map-&gt;backmap = realloc(map-&gt;backmap,(map-&gt;backmax=gid+10)*sizeof(int32));</span>
<span class="lineNum">    2416 </span><span class="lineNoCov">          0 :                 map-&gt;backmap[gid] = -1;</span>
<span class="lineNum">    2417 </span>            :             }
<span class="lineNum">    2418 </span>            :         }
<span class="lineNum">    2419 </span>            :     }
<span class="lineNum">    2420 </span><span class="lineCov">        900 :     sf-&gt;glyphs[gid] = NULL;</span>
<span class="lineNum">    2421 </span><span class="lineCov">        907 :     for ( fv=sf-&gt;fv; fv!=NULL; fv = fv-&gt;nextsame ) {</span>
<span class="lineNum">    2422 </span><span class="lineCov">          7 :         EncMap *map = fv-&gt;map;</span>
<span class="lineNum">    2423 </span>            : 
<span class="lineNum">    2424 </span><span class="lineCov">          7 :         FVBiggerGlyphCache(fv,gid);</span>
<span class="lineNum">    2425 </span>            : 
<span class="lineNum">    2426 </span><span class="lineCov">          7 :         if ( !MapAddEnc(sf,sc,basemap,map,baseenc,gid,fv) )</span>
<span class="lineNum">    2427 </span><span class="lineNoCov">          0 :             FVAddEncodingSlot(fv,gid);</span>
<span class="lineNum">    2428 </span><span class="lineCov">          7 :         if ( map==basemap ) mapfound = true;</span>
<span class="lineNum">    2429 </span><span class="lineCov">          7 :         if ( fv-&gt;normal!=NULL ) {</span>
<span class="lineNum">    2430 </span><span class="lineNoCov">          0 :             if ( !MapAddEnc(sf,sc,basemap,fv-&gt;normal,baseenc,gid,fv))</span>
<span class="lineNum">    2431 </span><span class="lineNoCov">          0 :                 MapAddEncodingSlot(fv-&gt;normal,gid);</span>
<span class="lineNum">    2432 </span>            :         }
<span class="lineNum">    2433 </span>            :     }
<span class="lineNum">    2434 </span><span class="lineCov">        900 :     if ( !mapfound &amp;&amp; basemap!=NULL )</span>
<span class="lineNum">    2435 </span><span class="lineCov">        893 :         MapAddEnc(sf,sc,basemap,basemap,baseenc,gid,fv);</span>
<span class="lineNum">    2436 </span><span class="lineCov">        900 :     sf-&gt;glyphs[gid] = sc;</span>
<span class="lineNum">    2437 </span><span class="lineCov">        900 :     sc-&gt;orig_pos = gid;</span>
<span class="lineNum">    2438 </span><span class="lineCov">        900 :     sc-&gt;parent = sf;</span>
<span class="lineNum">    2439 </span><span class="lineCov">        900 :     SFHashGlyph(sf,sc);</span>
<a name="2440"><span class="lineNum">    2440 </span><span class="lineCov">        900 : }</span></a>
<span class="lineNum">    2441 </span>            : 
<span class="lineNum">    2442 </span><span class="lineNoCov">          0 : static SplineChar *SplineCharMatch(SplineFont *parent,SplineChar *sc) {</span>
<span class="lineNum">    2443 </span><span class="lineNoCov">          0 :     SplineChar *scnew = SFSplineCharCreate(parent);</span>
<span class="lineNum">    2444 </span>            : 
<span class="lineNum">    2445 </span><span class="lineNoCov">          0 :     scnew-&gt;parent = parent;</span>
<span class="lineNum">    2446 </span><span class="lineNoCov">          0 :     scnew-&gt;orig_pos = sc-&gt;orig_pos;</span>
<span class="lineNum">    2447 </span><span class="lineNoCov">          0 :     scnew-&gt;name = copy(sc-&gt;name);</span>
<span class="lineNum">    2448 </span><span class="lineNoCov">          0 :     scnew-&gt;unicodeenc = sc-&gt;unicodeenc;</span>
<span class="lineNum">    2449 </span><span class="lineNoCov">          0 :     scnew-&gt;width = sc-&gt;width;</span>
<span class="lineNum">    2450 </span><span class="lineNoCov">          0 :     scnew-&gt;vwidth = sc-&gt;vwidth;</span>
<span class="lineNum">    2451 </span><span class="lineNoCov">          0 :     scnew-&gt;widthset = true;</span>
<span class="lineNum">    2452 </span><span class="lineNoCov">          0 : return( scnew );</span>
<a name="2453"><span class="lineNum">    2453 </span>            : }</a>
<span class="lineNum">    2454 </span>            : 
<span class="lineNum">    2455 </span><span class="lineCov">          2 : void SFMatchGlyphs(SplineFont *sf,SplineFont *target,int addempties) {</span>
<span class="lineNum">    2456 </span>            :     /* reorder sf so that its glyphs array is the same as that in target */
<span class="lineNum">    2457 </span>            :     int i, j, cnt, cnt2;
<span class="lineNum">    2458 </span>            :     SplineChar **glyphs;
<span class="lineNum">    2459 </span>            :     BDFFont *bdf;
<span class="lineNum">    2460 </span>            : 
<span class="lineNum">    2461 </span><span class="lineCov">       3921 :     for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( sf-&gt;glyphs[i]!=NULL )</span>
<span class="lineNum">    2462 </span><span class="lineCov">        460 :         sf-&gt;glyphs[i]-&gt;ticked = false;</span>
<span class="lineNum">    2463 </span><span class="lineCov">          2 :     if (( cnt = target-&gt;glyphcnt )&lt;sf-&gt;glyphcnt ) cnt = sf-&gt;glyphcnt;</span>
<span class="lineNum">    2464 </span><span class="lineCov">          2 :     glyphs = calloc(cnt,sizeof(SplineChar *));</span>
<span class="lineNum">    2465 </span><span class="lineCov">       7370 :     for ( i=0; i&lt;target-&gt;glyphcnt; ++i ) if ( target-&gt;glyphs[i]!=NULL ) {</span>
<span class="lineNum">    2466 </span><span class="lineCov">        460 :         SplineChar *sc = SFGetChar(sf,target-&gt;glyphs[i]-&gt;unicodeenc,target-&gt;glyphs[i]-&gt;name );</span>
<span class="lineNum">    2467 </span><span class="lineCov">        460 :         if ( sc==NULL &amp;&amp; addempties )</span>
<span class="lineNum">    2468 </span><span class="lineNoCov">          0 :             sc = SplineCharMatch(sf,target-&gt;glyphs[i]);</span>
<span class="lineNum">    2469 </span><span class="lineCov">        460 :         if ( sc!=NULL ) {</span>
<span class="lineNum">    2470 </span><span class="lineCov">        460 :             glyphs[i] = sc;</span>
<span class="lineNum">    2471 </span><span class="lineCov">        460 :             sc-&gt;ticked = true;</span>
<span class="lineNum">    2472 </span>            :         }
<span class="lineNum">    2473 </span>            :     }
<span class="lineNum">    2474 </span><span class="lineCov">       3921 :     for ( i=cnt2=0; i&lt;sf-&gt;glyphcnt; ++i )</span>
<span class="lineNum">    2475 </span><span class="lineCov">       3919 :         if ( sf-&gt;glyphs[i]!=NULL &amp;&amp; !sf-&gt;glyphs[i]-&gt;ticked )</span>
<span class="lineNum">    2476 </span><span class="lineNoCov">          0 :             ++cnt2;</span>
<span class="lineNum">    2477 </span><span class="lineCov">          2 :     if ( target-&gt;glyphcnt+cnt2&gt;cnt ) {</span>
<span class="lineNum">    2478 </span><span class="lineNoCov">          0 :         glyphs = realloc(glyphs,(target-&gt;glyphcnt+cnt2)*sizeof(SplineChar *));</span>
<span class="lineNum">    2479 </span><span class="lineNoCov">          0 :         memset(glyphs+cnt,0,(target-&gt;glyphcnt+cnt2-cnt)*sizeof(SplineChar *));</span>
<span class="lineNum">    2480 </span><span class="lineNoCov">          0 :         cnt = target-&gt;glyphcnt+cnt2;</span>
<span class="lineNum">    2481 </span>            :     }
<span class="lineNum">    2482 </span><span class="lineCov">          2 :     j = target-&gt;glyphcnt;</span>
<span class="lineNum">    2483 </span><span class="lineCov">       3921 :     for ( i=0; i&lt;sf-&gt;glyphcnt; ++i )</span>
<span class="lineNum">    2484 </span><span class="lineCov">       3919 :         if ( sf-&gt;glyphs[i]!=NULL &amp;&amp; !sf-&gt;glyphs[i]-&gt;ticked )</span>
<span class="lineNum">    2485 </span><span class="lineNoCov">          0 :             glyphs[j++] = sf-&gt;glyphs[i];</span>
<span class="lineNum">    2486 </span><span class="lineCov">          2 :     free(sf-&gt;glyphs);</span>
<span class="lineNum">    2487 </span><span class="lineCov">          2 :     sf-&gt;glyphs = glyphs;</span>
<span class="lineNum">    2488 </span><span class="lineCov">          2 :     sf-&gt;glyphcnt = sf-&gt;glyphmax = cnt;</span>
<span class="lineNum">    2489 </span><span class="lineCov">       7370 :     for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( sf-&gt;glyphs[i]!=NULL )</span>
<span class="lineNum">    2490 </span><span class="lineCov">        460 :         sf-&gt;glyphs[i]-&gt;orig_pos = i;</span>
<span class="lineNum">    2491 </span><span class="lineCov">          2 :     for ( bdf = sf-&gt;bitmaps; bdf!=NULL; bdf = bdf-&gt;next ) {</span>
<span class="lineNum">    2492 </span>            :         BDFChar **glyphs;
<span class="lineNum">    2493 </span><span class="lineNoCov">          0 :         glyphs = calloc(sf-&gt;glyphcnt,sizeof(BDFChar *));</span>
<span class="lineNum">    2494 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;bdf-&gt;glyphcnt; ++i ) if ( bdf-&gt;glyphs[i]!=NULL )</span>
<span class="lineNum">    2495 </span><span class="lineNoCov">          0 :             glyphs[bdf-&gt;glyphs[i]-&gt;sc-&gt;orig_pos] = bdf-&gt;glyphs[i];</span>
<span class="lineNum">    2496 </span><span class="lineNoCov">          0 :         free(bdf-&gt;glyphs);</span>
<span class="lineNum">    2497 </span><span class="lineNoCov">          0 :         bdf-&gt;glyphs = glyphs;</span>
<span class="lineNum">    2498 </span><span class="lineNoCov">          0 :         bdf-&gt;glyphcnt = bdf-&gt;glyphmax = sf-&gt;glyphcnt;</span>
<span class="lineNum">    2499 </span>            :     }
<a name="2500"><span class="lineNum">    2500 </span><span class="lineCov">          2 : }</span></a>
<span class="lineNum">    2501 </span>            : 
<span class="lineNum">    2502 </span><span class="lineCov">          1 : void MMMatchGlyphs(MMSet *mm) {</span>
<span class="lineNum">    2503 </span>            :     /* reorder all instances so that they have the same orig_pos */
<span class="lineNum">    2504 </span>            :     int i, j, index, lasthole;
<span class="lineNum">    2505 </span><span class="lineCov">          1 :     SplineFont *sf, *base = NULL;</span>
<span class="lineNum">    2506 </span>            :     SplineChar *sc, *scnew, *sc2;
<span class="lineNum">    2507 </span>            : 
<span class="lineNum">    2508 </span><span class="lineCov">          1 :     for ( i = 0; i&lt;mm-&gt;instance_count; ++i ) if ( mm-&gt;instances[i]!=NULL ) {</span>
<span class="lineNum">    2509 </span><span class="lineCov">          1 :         base = mm-&gt;instances[i];</span>
<span class="lineNum">    2510 </span><span class="lineCov">          1 :     break;</span>
<span class="lineNum">    2511 </span>            :     }
<span class="lineNum">    2512 </span><span class="lineCov">          1 :     if ( base==NULL )</span>
<span class="lineNum">    2513 </span><span class="lineCov">          1 : return;</span>
<span class="lineNum">    2514 </span>            : 
<span class="lineNum">    2515 </span>            :     /* First build up an ordering that uses all glyphs found in any of the */
<span class="lineNum">    2516 </span>            :     /*  sub-fonts, &quot;base&quot; will be the start of it. We will add glyphs to */
<span class="lineNum">    2517 </span>            :     /*  &quot;base&quot; as needed */
<span class="lineNum">    2518 </span><span class="lineCov">          1 :     lasthole = -1;</span>
<span class="lineNum">    2519 </span><span class="lineCov">          3 :     for ( i = 0; i&lt;mm-&gt;instance_count; ++i ) if ( (sf=mm-&gt;instances[i])!=NULL &amp;&amp; sf!=NULL ) {</span>
<span class="lineNum">    2520 </span><span class="lineCov">       7370 :         for ( j=0; j&lt;sf-&gt;glyphcnt; ++j ) if ( (sc=sf-&gt;glyphs[j])!=NULL ) {</span>
<span class="lineNum">    2521 </span><span class="lineCov">        920 :             if ( j&lt;base-&gt;glyphcnt &amp;&amp; base-&gt;glyphs[j]!=NULL &amp;&amp;</span>
<span class="lineNum">    2522 </span><span class="lineCov">        920 :                     base-&gt;glyphs[j]-&gt;unicodeenc==sc-&gt;unicodeenc &amp;&amp;</span>
<span class="lineNum">    2523 </span><span class="lineCov">        460 :                     strcmp(base-&gt;glyphs[j]-&gt;name,sc-&gt;name)==0 )</span>
<span class="lineNum">    2524 </span><span class="lineCov">        460 :         continue;       /* It's good, and in the same place */</span>
<span class="lineNum">    2525 </span><span class="lineNoCov">          0 :             else if ( (sc2=SFGetChar(base,sc-&gt;unicodeenc,sc-&gt;name))!=NULL &amp;&amp;</span>
<span class="lineNum">    2526 </span><span class="lineNoCov">          0 :                     sc2-&gt;unicodeenc==sc-&gt;unicodeenc &amp;&amp;</span>
<span class="lineNum">    2527 </span><span class="lineNoCov">          0 :                     strcmp(sc2-&gt;name,sc-&gt;name)==0 )</span>
<span class="lineNum">    2528 </span><span class="lineNoCov">          0 :         continue;       /* Well, it's in there somewhere */</span>
<span class="lineNum">    2529 </span>            :             else {
<span class="lineNum">    2530 </span>            :                 /* We need to add it */
<span class="lineNum">    2531 </span><span class="lineNoCov">          0 :                 if ( j&lt;base-&gt;glyphcnt &amp;&amp; base-&gt;glyphs[j]==NULL )</span>
<span class="lineNum">    2532 </span><span class="lineNoCov">          0 :                     index = j;</span>
<span class="lineNum">    2533 </span>            :                 else {
<span class="lineNum">    2534 </span><span class="lineNoCov">          0 :                     for ( ++lasthole ; lasthole&lt;base-&gt;glyphcnt &amp;&amp; base-&gt;glyphs[lasthole]!=NULL; ++lasthole );</span>
<span class="lineNum">    2535 </span><span class="lineNoCov">          0 :                     index = lasthole;</span>
<span class="lineNum">    2536 </span><span class="lineNoCov">          0 :                     if ( lasthole&gt;=base-&gt;glyphmax )</span>
<span class="lineNum">    2537 </span><span class="lineNoCov">          0 :                         base-&gt;glyphs = realloc(base-&gt;glyphs,(base-&gt;glyphmax+=20)*sizeof(SplineChar *));</span>
<span class="lineNum">    2538 </span><span class="lineNoCov">          0 :                     if ( lasthole&gt;=base-&gt;glyphcnt )</span>
<span class="lineNum">    2539 </span><span class="lineNoCov">          0 :                         base-&gt;glyphcnt = lasthole+1;</span>
<span class="lineNum">    2540 </span>            :                 }
<span class="lineNum">    2541 </span><span class="lineNoCov">          0 :                 base-&gt;glyphs[index] = scnew = SplineCharMatch(base,sc);</span>
<span class="lineNum">    2542 </span><span class="lineNoCov">          0 :                 scnew-&gt;orig_pos = index;</span>
<span class="lineNum">    2543 </span>            :             }
<span class="lineNum">    2544 </span>            :         }
<span class="lineNum">    2545 </span>            :     }
<span class="lineNum">    2546 </span>            : 
<span class="lineNum">    2547 </span>            :     /* Now force all other instances to match */
<span class="lineNum">    2548 </span><span class="lineCov">          3 :     for ( i = 0; i&lt;mm-&gt;instance_count; ++i ) if ( (sf=mm-&gt;instances[i])!=NULL &amp;&amp; sf!=base )</span>
<span class="lineNum">    2549 </span><span class="lineCov">          1 :         SFMatchGlyphs(sf,base,true);</span>
<span class="lineNum">    2550 </span><span class="lineCov">          1 :     if ( mm-&gt;normal!=NULL )</span>
<span class="lineNum">    2551 </span><span class="lineCov">          1 :         SFMatchGlyphs(mm-&gt;normal,base,true);</span>
<a name="2552"><span class="lineNum">    2552 </span>            : }</a>
<span class="lineNum">    2553 </span>            : 
<span class="lineNum">    2554 </span><span class="lineCov">      20393 : int32 UniFromEnc(int enc, Encoding *encname) {</span>
<span class="lineNum">    2555 </span>            :     char from[20];
<span class="lineNum">    2556 </span>            :     unichar_t to[20];
<span class="lineNum">    2557 </span>            :     ICONV_CONST char *fpt;
<span class="lineNum">    2558 </span>            :     char *tpt;
<span class="lineNum">    2559 </span>            :     size_t fromlen, tolen;
<span class="lineNum">    2560 </span>            : 
<span class="lineNum">    2561 </span><span class="lineCov">      20393 :     if ( encname-&gt;is_custom || encname-&gt;is_original )</span>
<span class="lineNum">    2562 </span><span class="lineNoCov">          0 : return( -1 );</span>
<span class="lineNum">    2563 </span><span class="lineCov">      20393 :     if ( enc&gt;=encname-&gt;char_cnt )</span>
<span class="lineNum">    2564 </span><span class="lineCov">       1864 : return( -1 );</span>
<span class="lineNum">    2565 </span><span class="lineCov">      18529 :     if ( encname-&gt;is_unicodebmp || encname-&gt;is_unicodefull )</span>
<span class="lineNum">    2566 </span><span class="lineCov">      17240 : return( enc );</span>
<span class="lineNum">    2567 </span><span class="lineCov">       1289 :     if ( encname-&gt;unicode!=NULL )</span>
<span class="lineNum">    2568 </span><span class="lineCov">       1280 : return( encname-&gt;unicode[enc] );</span>
<span class="lineNum">    2569 </span><span class="lineCov">          9 :     else if ( encname-&gt;tounicode ) {</span>
<span class="lineNum">    2570 </span>            :         /* To my surprise, on RH9, doing a reset on conversion of CP1258-&gt;UCS2 */
<span class="lineNum">    2571 </span>            :         /* causes subsequent calls to return garbage */
<span class="lineNum">    2572 </span><span class="lineCov">          9 :         if ( encname-&gt;iso_2022_escape_len ) {</span>
<span class="lineNum">    2573 </span><span class="lineNoCov">          0 :             tolen = sizeof(to); fromlen = 0;</span>
<span class="lineNum">    2574 </span><span class="lineNoCov">          0 :             iconv(encname-&gt;tounicode,NULL,&amp;fromlen,NULL,&amp;tolen);     /* Reset state */</span>
<span class="lineNum">    2575 </span>            :         }
<span class="lineNum">    2576 </span><span class="lineCov">          9 :         fpt = from; tpt = (char *) to; tolen = sizeof(to);</span>
<span class="lineNum">    2577 </span><span class="lineCov">          9 :         if ( encname-&gt;has_1byte &amp;&amp; enc&lt;256 ) {</span>
<span class="lineNum">    2578 </span><span class="lineCov">          9 :             *(char *) fpt = enc;</span>
<span class="lineNum">    2579 </span><span class="lineCov">          9 :             fromlen = 1;</span>
<span class="lineNum">    2580 </span><span class="lineNoCov">          0 :         } else if ( encname-&gt;has_2byte ) {</span>
<span class="lineNum">    2581 </span><span class="lineNoCov">          0 :             if ( encname-&gt;iso_2022_escape_len )</span>
<span class="lineNum">    2582 </span><span class="lineNoCov">          0 :                 strncpy(from,encname-&gt;iso_2022_escape,encname-&gt;iso_2022_escape_len );</span>
<span class="lineNum">    2583 </span><span class="lineNoCov">          0 :             fromlen = encname-&gt;iso_2022_escape_len;</span>
<span class="lineNum">    2584 </span><span class="lineNoCov">          0 :             from[fromlen++] = enc&gt;&gt;8;</span>
<span class="lineNum">    2585 </span><span class="lineNoCov">          0 :             from[fromlen++] = enc&amp;0xff;</span>
<span class="lineNum">    2586 </span>            :         }
<span class="lineNum">    2587 </span><span class="lineCov">          9 :         if ( iconv(encname-&gt;tounicode,&amp;fpt,&amp;fromlen,&amp;tpt,&amp;tolen)==(size_t) -1 )</span>
<span class="lineNum">    2588 </span><span class="lineNoCov">          0 : return( -1 );</span>
<span class="lineNum">    2589 </span><span class="lineCov">          9 :         if ( tpt-(char *) to == 0 ) {</span>
<span class="lineNum">    2590 </span>            :             /* This strange call appears to be what we need to make CP1258-&gt;UCS2 */
<span class="lineNum">    2591 </span>            :             /*  work.  It's supposed to reset the state and give us the shift */
<span class="lineNum">    2592 </span>            :             /*  out. As there is no state, and no shift out I have no idea why*/
<span class="lineNum">    2593 </span>            :             /*  this works, but it does. */
<span class="lineNum">    2594 </span><span class="lineNoCov">          0 :             if ( iconv(encname-&gt;tounicode,NULL,&amp;fromlen,&amp;tpt,&amp;tolen)==(size_t) -1 )</span>
<span class="lineNum">    2595 </span><span class="lineNoCov">          0 : return( -1 );</span>
<span class="lineNum">    2596 </span>            :         }
<span class="lineNum">    2597 </span><span class="lineCov">          9 :         if ( tpt-(char *) to == sizeof(unichar_t) )</span>
<span class="lineNum">    2598 </span>            :         {
<span class="lineNum">    2599 </span><span class="lineCov">          9 :             return( to[0] );</span>
<span class="lineNum">    2600 </span>            :         }
<span class="lineNum">    2601 </span><span class="lineNoCov">          0 :     } else if ( encname-&gt;tounicode_func!=NULL ) {</span>
<span class="lineNum">    2602 </span><span class="lineNoCov">          0 : return( (encname-&gt;tounicode_func)(enc) );</span>
<span class="lineNum">    2603 </span>            :     }
<span class="lineNum">    2604 </span><span class="lineNoCov">          0 : return( -1 );</span>
<a name="2605"><span class="lineNum">    2605 </span>            : }</a>
<span class="lineNum">    2606 </span>            : 
<span class="lineNum">    2607 </span><span class="lineCov">       1975 : int32 EncFromUni(int32 uni, Encoding *enc) {</span>
<span class="lineNum">    2608 </span>            :     unichar_t from[20];
<span class="lineNum">    2609 </span>            :     unsigned char to[20];
<span class="lineNum">    2610 </span>            :     ICONV_CONST char *fpt;
<span class="lineNum">    2611 </span>            :     char *tpt;
<span class="lineNum">    2612 </span>            :     size_t fromlen, tolen;
<span class="lineNum">    2613 </span>            :     int i;
<span class="lineNum">    2614 </span>            : 
<span class="lineNum">    2615 </span><span class="lineCov">       1975 :     if ( enc-&gt;is_custom || enc-&gt;is_original || enc-&gt;is_compact || uni==-1 )</span>
<span class="lineNum">    2616 </span><span class="lineCov">       1449 : return( -1 );</span>
<span class="lineNum">    2617 </span><span class="lineCov">        526 :     if ( enc-&gt;is_unicodebmp || enc-&gt;is_unicodefull )</span>
<span class="lineNum">    2618 </span><span class="lineCov">          2 : return( uni&lt;enc-&gt;char_cnt ? uni : -1 );</span>
<span class="lineNum">    2619 </span>            : 
<span class="lineNum">    2620 </span><span class="lineCov">        524 :     if ( enc-&gt;unicode!=NULL ) {</span>
<span class="lineNum">    2621 </span><span class="lineCov">      20561 :         for ( i=0; i&lt;enc-&gt;char_cnt; ++i ) {</span>
<span class="lineNum">    2622 </span><span class="lineCov">      20481 :             if ( enc-&gt;unicode[i]==uni )</span>
<span class="lineNum">    2623 </span><span class="lineCov">          1 : return( i );</span>
<span class="lineNum">    2624 </span>            :         }
<span class="lineNum">    2625 </span><span class="lineCov">         80 : return( -1 );</span>
<span class="lineNum">    2626 </span><span class="lineCov">        443 :     } else if ( enc-&gt;fromunicode!=NULL ) {</span>
<span class="lineNum">    2627 </span>            :         /* I don't see how there can be any state to reset in this direction */
<span class="lineNum">    2628 </span>            :         /*  So I don't reset it */
<span class="lineNum">    2629 </span><span class="lineCov">        443 :         from[0] = uni;</span>
<span class="lineNum">    2630 </span><span class="lineCov">        443 :         fromlen = sizeof(unichar_t);</span>
<span class="lineNum">    2631 </span><span class="lineCov">        443 :         fpt = (char *) from; tpt = (char *) to; tolen = sizeof(to);</span>
<span class="lineNum">    2632 </span><span class="lineCov">        443 :         iconv(enc-&gt;fromunicode,NULL,NULL,NULL,NULL); /* reset shift in/out, etc. */</span>
<span class="lineNum">    2633 </span><span class="lineCov">        443 :         if ( iconv(enc-&gt;fromunicode,&amp;fpt,&amp;fromlen,&amp;tpt,&amp;tolen)==(size_t) -1 )</span>
<span class="lineNum">    2634 </span><span class="lineCov">        352 : return( -1 );</span>
<span class="lineNum">    2635 </span><span class="lineCov">         91 :         if ( tpt-(char *) to == 1 )</span>
<span class="lineNum">    2636 </span><span class="lineCov">         91 : return( to[0] );</span>
<span class="lineNum">    2637 </span><span class="lineNoCov">          0 :         if ( enc-&gt;iso_2022_escape_len!=0 ) {</span>
<span class="lineNum">    2638 </span><span class="lineNoCov">          0 :             if ( tpt-(char *) to == enc-&gt;iso_2022_escape_len+2 &amp;&amp;</span>
<span class="lineNum">    2639 </span><span class="lineNoCov">          0 :                     strncmp((char *) to,enc-&gt;iso_2022_escape,enc-&gt;iso_2022_escape_len)==0 )</span>
<span class="lineNum">    2640 </span><span class="lineNoCov">          0 : return( (to[enc-&gt;iso_2022_escape_len]&lt;&lt;8) | to[enc-&gt;iso_2022_escape_len+1] );</span>
<span class="lineNum">    2641 </span>            :         } else {
<span class="lineNum">    2642 </span><span class="lineNoCov">          0 :             if ( tpt-(char *) to == sizeof(unichar_t) )</span>
<span class="lineNum">    2643 </span><span class="lineNoCov">          0 : return( (to[0]&lt;&lt;8) | to[1] );</span>
<span class="lineNum">    2644 </span>            :         }
<span class="lineNum">    2645 </span><span class="lineNoCov">          0 :     } else if ( enc-&gt;fromunicode_func!=NULL ) {</span>
<span class="lineNum">    2646 </span><span class="lineNoCov">          0 : return( (enc-&gt;fromunicode_func)(uni) );</span>
<span class="lineNum">    2647 </span>            :     }
<span class="lineNum">    2648 </span><span class="lineNoCov">          0 : return( -1 );</span>
<a name="2649"><span class="lineNum">    2649 </span>            : }</a>
<span class="lineNum">    2650 </span>            : 
<span class="lineNum">    2651 </span><span class="lineNoCov">          0 : int32 EncFromName(const char *name,enum uni_interp interp,Encoding *encname) {</span>
<span class="lineNum">    2652 </span>            :     int i;
<span class="lineNum">    2653 </span><span class="lineNoCov">          0 :     if ( encname-&gt;psnames!=NULL ) {</span>
<span class="lineNum">    2654 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;encname-&gt;char_cnt; ++i )</span>
<span class="lineNum">    2655 </span><span class="lineNoCov">          0 :             if ( encname-&gt;psnames[i]!=NULL &amp;&amp; strcmp(name,encname-&gt;psnames[i])==0 )</span>
<span class="lineNum">    2656 </span><span class="lineNoCov">          0 : return( i );</span>
<span class="lineNum">    2657 </span>            :     }
<span class="lineNum">    2658 </span><span class="lineNoCov">          0 :     i = UniFromName(name,interp,encname);</span>
<span class="lineNum">    2659 </span><span class="lineNoCov">          0 :     if ( i==-1 &amp;&amp; strlen(name)==4 ) {</span>
<span class="lineNum">    2660 </span>            :         /* MS says use this kind of name, Adobe says use the one above */
<span class="lineNum">    2661 </span>            :         char *end;
<span class="lineNum">    2662 </span><span class="lineNoCov">          0 :         i = strtol(name,&amp;end,16);</span>
<span class="lineNum">    2663 </span><span class="lineNoCov">          0 :         if ( i&lt;0 || i&gt;0xffff || *end!='\0' )</span>
<span class="lineNum">    2664 </span><span class="lineNoCov">          0 : return( -1 );</span>
<span class="lineNum">    2665 </span>            :     }
<span class="lineNum">    2666 </span><span class="lineNoCov">          0 : return( EncFromUni(i,encname));</span>
<a name="2667"><span class="lineNum">    2667 </span>            : }</a>
<span class="lineNum">    2668 </span>            : 
<span class="lineNum">    2669 </span><span class="lineNoCov">          0 : void SFExpandGlyphCount(SplineFont *sf, int newcnt) {</span>
<span class="lineNum">    2670 </span><span class="lineNoCov">          0 :     int old = sf-&gt;glyphcnt;</span>
<span class="lineNum">    2671 </span>            :     FontViewBase *fv;
<span class="lineNum">    2672 </span>            : 
<span class="lineNum">    2673 </span><span class="lineNoCov">          0 :     if ( old&gt;=newcnt )</span>
<span class="lineNum">    2674 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2675 </span><span class="lineNoCov">          0 :     if ( sf-&gt;glyphmax&lt;newcnt ) {</span>
<span class="lineNum">    2676 </span><span class="lineNoCov">          0 :         sf-&gt;glyphs = realloc(sf-&gt;glyphs,newcnt*sizeof(SplineChar *));</span>
<span class="lineNum">    2677 </span><span class="lineNoCov">          0 :         sf-&gt;glyphmax = newcnt;</span>
<span class="lineNum">    2678 </span>            :     }
<span class="lineNum">    2679 </span><span class="lineNoCov">          0 :     memset(sf-&gt;glyphs+sf-&gt;glyphcnt,0,(newcnt-sf-&gt;glyphcnt)*sizeof(SplineChar *));</span>
<span class="lineNum">    2680 </span><span class="lineNoCov">          0 :     sf-&gt;glyphcnt = newcnt;</span>
<span class="lineNum">    2681 </span>            : 
<span class="lineNum">    2682 </span><span class="lineNoCov">          0 :     for ( fv=sf-&gt;fv; fv!=NULL; fv=fv-&gt;nextsame ) {</span>
<span class="lineNum">    2683 </span><span class="lineNoCov">          0 :         if ( fv-&gt;sf==sf ) {  /* Beware of cid keyed fonts which might look at a different subfont */</span>
<span class="lineNum">    2684 </span><span class="lineNoCov">          0 :             if ( fv-&gt;normal!=NULL )</span>
<span class="lineNum">    2685 </span><span class="lineNoCov">          0 :     continue;                   /* If compacted then we haven't added any glyphs so haven't changed anything */</span>
<span class="lineNum">    2686 </span>            :             /* Don't display any of these guys, so not mapped. */
<span class="lineNum">    2687 </span>            :             /*  No change to selection, or to map-&gt;map, but change to backmap */
<span class="lineNum">    2688 </span><span class="lineNoCov">          0 :             if ( newcnt&gt;fv-&gt;map-&gt;backmax )</span>
<span class="lineNum">    2689 </span><span class="lineNoCov">          0 :                 fv-&gt;map-&gt;backmap = realloc(fv-&gt;map-&gt;backmap,(fv-&gt;map-&gt;backmax = newcnt+5)*sizeof(int32));</span>
<span class="lineNum">    2690 </span><span class="lineNoCov">          0 :             memset(fv-&gt;map-&gt;backmap+old,-1,(newcnt-old)*sizeof(int32));</span>
<span class="lineNum">    2691 </span>            :         }
<span class="lineNum">    2692 </span>            :     }
<span class="lineNum">    2693 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
