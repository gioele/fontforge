<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - FontForge coverage report 2017-08-04 01:21:11+02:00 (commit d35f7e4107a9e1db65cce47c468fcc914cecb8fd) - fontforge/ttfspecial.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">fontforge</a> - ttfspecial.c<span style="font-size: 80%;"> (source / <a href="ttfspecial.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">FontForge coverage report 2017-08-04 01:21:11+02:00 (commit d35f7e4107a9e1db65cce47c468fcc914cecb8fd)</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">117</td>
            <td class="headerCovTableEntry">1388</td>
            <td class="headerCovTableEntryLo">8.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-08-04</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">7</td>
            <td class="headerCovTableEntry">48</td>
            <td class="headerCovTableEntryLo">14.6 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* Copyright (C) 2000-2012 by George Williams */</a>
<span class="lineNum">       2 </span>            : /*
<span class="lineNum">       3 </span>            :  * Redistribution and use in source and binary forms, with or without
<span class="lineNum">       4 </span>            :  * modification, are permitted provided that the following conditions are met:
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            :  * Redistributions of source code must retain the above copyright notice, this
<span class="lineNum">       7 </span>            :  * list of conditions and the following disclaimer.
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            :  * Redistributions in binary form must reproduce the above copyright notice,
<span class="lineNum">      10 </span>            :  * this list of conditions and the following disclaimer in the documentation
<span class="lineNum">      11 </span>            :  * and/or other materials provided with the distribution.
<span class="lineNum">      12 </span>            : 
<span class="lineNum">      13 </span>            :  * The name of the author may not be used to endorse or promote products
<span class="lineNum">      14 </span>            :  * derived from this software without specific prior written permission.
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            :  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED
<span class="lineNum">      17 </span>            :  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
<span class="lineNum">      18 </span>            :  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO
<span class="lineNum">      19 </span>            :  * EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<span class="lineNum">      20 </span>            :  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
<span class="lineNum">      21 </span>            :  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
<span class="lineNum">      22 </span>            :  * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
<span class="lineNum">      23 </span>            :  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
<span class="lineNum">      24 </span>            :  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
<span class="lineNum">      25 </span>            :  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">      26 </span>            :  */
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #include &quot;ttfspecial.h&quot;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &quot;fontforge.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;mem.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;splinefill.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;splineutil.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;splineutil2.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;tottf.h&quot;
<span class="lineNum">      36 </span>            : #include &lt;math.h&gt;
<span class="lineNum">      37 </span>            : #include &lt;time.h&gt;
<span class="lineNum">      38 </span>            : #include &lt;utype.h&gt;
<span class="lineNum">      39 </span>            : #include &lt;ustring.h&gt;
<span class="lineNum">      40 </span>            : #include &lt;gimage.h&gt;               /* For COLOR_DEFAULT */
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span>            : #include &quot;ttf.h&quot;
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : /* This file contains routines to generate non-standard true/opentype tables */
<span class="lineNum">      45 </span>            : /* The first is the 'PfEd' table containing PfaEdit specific information */
<span class="lineNum">      46 </span>            : /*      glyph comments &amp; colours ... perhaps other info later */
<span class="lineNum">      47 </span>            : 
<span class="lineNum">      48 </span>            : /* ************************************************************************** */
<span class="lineNum">      49 </span>            : /* *************************    The 'PfEd' table    ************************* */
<span class="lineNum">      50 </span>            : /* *************************         Output         ************************* */
<span class="lineNum">      51 </span>            : /* ************************************************************************** */
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : #include &quot;PfEd.h&quot;     /* This describes the format of the 'PfEd' table */
<span class="lineNum">      54 </span>            :                         /*  and its many subtables. */
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            : #define MAX_SUBTABLE_TYPES      20
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span>            : struct PfEd_subtabs {
<span class="lineNum">      59 </span>            :     int next;
<span class="lineNum">      60 </span>            :     struct {
<span class="lineNum">      61 </span>            :         FILE *data;
<span class="lineNum">      62 </span>            :         uint32 tag;
<span class="lineNum">      63 </span>            :         uint32 offset;
<span class="lineNum">      64 </span>            :     } subtabs[MAX_SUBTABLE_TYPES];
<a name="65"><span class="lineNum">      65 </span>            : };</a>
<span class="lineNum">      66 </span>            : 
<span class="lineNum">      67 </span><span class="lineNoCov">          0 : static void PfEd_FontComment(SplineFont *sf, struct PfEd_subtabs *pfed, uint32 tag ) {</span>
<span class="lineNum">      68 </span>            :     FILE *fcmt;
<span class="lineNum">      69 </span>            :     char *pt;
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :     char *text = tag==fcmt_TAG ? sf-&gt;comments : sf-&gt;fontlog;</span>
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :     if ( text==NULL || *text=='\0' )</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next].tag = tag;</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next++].data = fcmt = tmpfile();</span>
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :     putshort(fcmt,1);                   /* sub-table version number */</span>
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :     putshort(fcmt,strlen(text));</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :     for ( pt = text; *pt; ++pt )</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :         putc(*pt,fcmt);</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :     putshort(fcmt,0);</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :     if ( ftell(fcmt)&amp;1 ) putc(0,fcmt);</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :     if ( ftell(fcmt)&amp;2 ) putshort(fcmt,0);</span>
<a name="84"><span class="lineNum">      84 </span>            : }</a>
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span><span class="lineNoCov">          0 : static void PfEd_GlyphComments(SplineFont *sf, struct PfEd_subtabs *pfed,</span>
<span class="lineNum">      87 </span>            :         struct glyphinfo *gi ) {
<span class="lineNum">      88 </span>            :     int i, j, k, any, cnt, last, skipped;
<span class="lineNum">      89 </span>            :     uint32 offset;
<span class="lineNum">      90 </span>            :     SplineChar *sc, *sc2;
<span class="lineNum">      91 </span>            :     FILE *cmnt;
<span class="lineNum">      92 </span>            : 
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :     any = 0;</span>
<span class="lineNum">      94 </span>            :     /* We don't need to check in bygid order. We just want to know existance */
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) {</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :         if ( sf-&gt;glyphs[i]!=NULL &amp;&amp; sf-&gt;glyphs[i]-&gt;ttf_glyph!=-1 &amp;&amp;</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :                 sf-&gt;glyphs[i]-&gt;comment!=NULL ) {</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :             any = true;</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     100 </span>            :         }
<span class="lineNum">     101 </span>            :     }
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :     if ( !any )</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next].tag = cmnt_TAG;</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next++].data = cmnt = tmpfile();</span>
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :     putshort(cmnt,1);                   /* sub-table version number */</span>
<span class="lineNum">     110 </span>            :             /* Version 0 used ucs2, version 1 uses utf8 */
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :     offset = 0;</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :     for ( j=0; j&lt;4; ++j ) {</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :         cnt = 0;</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;gi-&gt;gcnt; ++i ) if ( gi-&gt;bygid[i]!=-1 ) {</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :             sc=sf-&gt;glyphs[gi-&gt;bygid[i]];</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :             if ( sc!=NULL &amp;&amp; sc-&gt;comment!=NULL ) {</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :                 last = i; skipped = false;</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :                 for ( k=i+1; k&lt;gi-&gt;gcnt; ++k ) {</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :                     if ( gi-&gt;bygid[k]!=-1 )</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :                         sc2 = sf-&gt;glyphs[gi-&gt;bygid[k]];</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :                     if ( (gi-&gt;bygid[k]==-1 || sc2-&gt;comment==NULL) &amp;&amp; skipped )</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :                     if ( gi-&gt;bygid[k]!=-1 &amp;&amp; sc2-&gt;comment!=NULL ) {</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :                         last = k;</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :                         skipped = false;</span>
<span class="lineNum">     127 </span>            :                     } else
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :                         skipped = true;</span>
<span class="lineNum">     129 </span>            :                 }
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :                 ++cnt;</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :                 if ( j==1 ) {</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :                     putshort(cmnt,i);</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :                     putshort(cmnt,last);</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :                     putlong(cmnt,offset);</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :                     offset += sizeof(uint32)*(last-i+2);</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :                 } else if ( j==2 ) {</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :                     for ( ; i&lt;=last; ++i ) {</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :                         if ( gi-&gt;bygid[i]==-1 || (sc=sf-&gt;glyphs[gi-&gt;bygid[i]])-&gt;comment==NULL )</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :                             putlong(cmnt,0);</span>
<span class="lineNum">     140 </span>            :                         else {
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :                             putlong(cmnt,offset);</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :                             offset += strlen(sc-&gt;comment)+1;</span>
<span class="lineNum">     143 </span>            :                         }
<span class="lineNum">     144 </span>            :                     }
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :                     putlong(cmnt,offset);       /* Guard data, to let us calculate the string lengths */</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :                 } else if ( j==3 ) {</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :                     for ( ; i&lt;=last; ++i ) {</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :                         if ( gi-&gt;bygid[i]==-1 || (sc=sf-&gt;glyphs[gi-&gt;bygid[i]])-&gt;comment==NULL )</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :                     continue;</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :                         fputs(sc-&gt;comment,cmnt);</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :                         putc('\0',cmnt);</span>
<span class="lineNum">     152 </span>            :                     }
<span class="lineNum">     153 </span>            :                 }
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :                 i = last;</span>
<span class="lineNum">     155 </span>            :             }
<span class="lineNum">     156 </span>            :         }
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :         if ( j==0 ) {</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :             putshort(cmnt,cnt);</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :             offset = 2*sizeof(short) + cnt*(2*sizeof(short)+sizeof(uint32));</span>
<span class="lineNum">     160 </span>            :         }
<span class="lineNum">     161 </span>            :     }
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :     if ( ftell(cmnt) &amp; 1 )</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :         putc('\0',cmnt);</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :     if ( ftell(cmnt) &amp; 2 )</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :         putshort(cmnt,0);</span>
<a name="166"><span class="lineNum">     166 </span>            : }</a>
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span><span class="lineNoCov">          0 : static void PfEd_CvtComments(SplineFont *sf, struct PfEd_subtabs *pfed ) {</span>
<span class="lineNum">     169 </span>            :     FILE *cvtcmt;
<span class="lineNum">     170 </span>            :     int i, offset;
<span class="lineNum">     171 </span>            : 
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :     if ( sf-&gt;cvt_names==NULL )</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next].tag = cvtc_TAG;</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next++].data = cvtcmt = tmpfile();</span>
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :     for ( i=0; sf-&gt;cvt_names[i]!=END_CVT_NAMES; ++i);</span>
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :     putshort(cvtcmt,0);                 /* sub-table version number */</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :     putshort(cvtcmt,i);</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :     offset = 2*2 + i*2;</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :     for ( i=0; sf-&gt;cvt_names[i]!=END_CVT_NAMES; ++i) {</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :         if ( sf-&gt;cvt_names[i]==NULL )</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :             putshort(cvtcmt,0);</span>
<span class="lineNum">     185 </span>            :         else {
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :             putshort(cvtcmt,offset);</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :             offset += strlen(sf-&gt;cvt_names[i])+1;</span>
<span class="lineNum">     188 </span>            :         }
<span class="lineNum">     189 </span>            :     }
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :     for ( i=0; sf-&gt;cvt_names[i]!=END_CVT_NAMES; ++i) {</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :         if ( sf-&gt;cvt_names[i]!=NULL ) {</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :             fputs(sf-&gt;cvt_names[i],cvtcmt);</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :             putc('\0',cvtcmt);</span>
<span class="lineNum">     194 </span>            :         }
<span class="lineNum">     195 </span>            :     }
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :     if ( ftell(cvtcmt)&amp;1 ) putc(0,cvtcmt);</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :     if ( ftell(cvtcmt)&amp;2 ) putshort(cvtcmt,0);</span>
<a name="198"><span class="lineNum">     198 </span>            : }</a>
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span><span class="lineNoCov">          0 : static void PfEd_Colours(SplineFont *sf, struct PfEd_subtabs *pfed, struct glyphinfo *gi ) {</span>
<span class="lineNum">     201 </span>            :     int i, j, k, any, cnt, last;
<span class="lineNum">     202 </span>            :     SplineChar *sc, *sc2;
<span class="lineNum">     203 </span>            :     FILE *colr;
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :     any = 0;</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) {</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :         if ( sf-&gt;glyphs[i]!=NULL &amp;&amp; sf-&gt;glyphs[i]-&gt;ttf_glyph!=-1 &amp;&amp;</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :                 sf-&gt;glyphs[i]-&gt;color!=COLOR_DEFAULT ) {</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :             any = true;</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     211 </span>            :         }
<span class="lineNum">     212 </span>            :     }
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :     if ( !any )</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next].tag = colr_TAG;</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next++].data = colr = tmpfile();</span>
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :     putshort(colr,0);                   /* sub-table version number */</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :     for ( j=0; j&lt;2; ++j ) {</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :         cnt = 0;</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;gi-&gt;gcnt; ++i ) if ( gi-&gt;bygid[i]!=-1 ) {</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :             sc = sf-&gt;glyphs[gi-&gt;bygid[i]];</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :             if ( sc!=NULL &amp;&amp; sc-&gt;color!=COLOR_DEFAULT ) {</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :                 last = i;</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :                 for ( k=i+1; k&lt;gi-&gt;gcnt; ++k ) {</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :                     if ( gi-&gt;bygid[k]==-1 )</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :                     sc2 = sf-&gt;glyphs[gi-&gt;bygid[k]];</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :                     if ( sc2-&gt;color != sc-&gt;color )</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :                     last = k;</span>
<span class="lineNum">     234 </span>            :                 }
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :                 ++cnt;</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :                 if ( j==1 ) {</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :                     putshort(colr,i);</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :                     putshort(colr,last);</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :                     putlong(colr,sc-&gt;color);</span>
<span class="lineNum">     240 </span>            :                 }
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :                 i = last;</span>
<span class="lineNum">     242 </span>            :             }
<span class="lineNum">     243 </span>            :         }
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :         if ( j==0 )</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :             putshort(colr,cnt);</span>
<span class="lineNum">     246 </span>            :     }
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :     if ( ftell(colr) &amp; 2 )</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :         putshort(colr,0);</span>
<a name="249"><span class="lineNum">     249 </span>            : }</a>
<span class="lineNum">     250 </span>            : 
<span class="lineNum">     251 </span><span class="lineNoCov">          0 : static void PfEd_Lookups(SplineFont *sf, struct PfEd_subtabs *pfed,</span>
<span class="lineNum">     252 </span>            :         OTLookup *lookups, uint32 tag) {
<span class="lineNum">     253 </span>            :     OTLookup *otl;
<span class="lineNum">     254 </span>            :     int lcnt, scnt, ascnt, acnt, s, a;
<span class="lineNum">     255 </span>            :     FILE *lkf;
<span class="lineNum">     256 </span>            :     struct lookup_subtable *subs;
<span class="lineNum">     257 </span>            :     AnchorClass *ac;
<span class="lineNum">     258 </span>            :     int sub_info, ac_info, name_info;
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :     if ( lookups==NULL )</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :     for ( otl=lookups, lcnt=scnt=acnt=ascnt=0; otl!=NULL; otl=otl-&gt;next ) if ( !otl-&gt;unused ) {</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :         ++lcnt;</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :         for ( subs = otl-&gt;subtables; subs!=NULL; subs=subs-&gt;next ) if ( !subs-&gt;unused ) {</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :             ++scnt;</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :             if ( subs-&gt;anchor_classes ) {</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :                 ++ascnt;</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :                 for ( ac=sf-&gt;anchor; ac!=NULL; ac=ac-&gt;next )</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :                     if ( ac-&gt;subtable==subs &amp;&amp; ac-&gt;has_base &amp;&amp; ac-&gt;has_mark )</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :                         ++acnt;</span>
<span class="lineNum">     271 </span>            :             }
<span class="lineNum">     272 </span>            :         }
<span class="lineNum">     273 </span>            :     }
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next].tag = tag;</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next++].data = lkf = tmpfile();</span>
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :     putshort(lkf,0);                    /* Subtable version */</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :     putshort(lkf,lcnt);</span>
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :     sub_info = 4 + 4*lcnt;</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :     ac_info =  sub_info + 2*lcnt + 4*scnt;</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     name_info = ac_info + 2*ascnt + 2*acnt;</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     for ( otl=lookups; otl!=NULL; otl=otl-&gt;next ) if ( !otl-&gt;unused ) {</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :         putshort(lkf,name_info);</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :         name_info += strlen(otl-&gt;lookup_name)+1;</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :         putshort(lkf,sub_info);</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :         for ( subs = otl-&gt;subtables, s=0; subs!=NULL; subs=subs-&gt;next ) if ( !subs-&gt;unused ) ++s;</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :         sub_info += 2 + 4*s;</span>
<span class="lineNum">     290 </span>            :     }
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :     if ( sub_info!=ac_info )</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :         IError(&quot;Lookup name data didn't behave as expected&quot;);</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :     for ( otl=lookups; otl!=NULL; otl=otl-&gt;next ) if ( !otl-&gt;unused ) {</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :         for ( subs = otl-&gt;subtables, s=0; subs!=NULL; subs=subs-&gt;next ) if ( !subs-&gt;unused ) ++s;</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :         putshort(lkf,s);                        /* Subtable count */</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :         for ( subs = otl-&gt;subtables, s=0; subs!=NULL; subs=subs-&gt;next ) if ( !subs-&gt;unused ) {</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :             putshort(lkf,name_info);</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :             name_info += strlen(subs-&gt;subtable_name)+1;</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :             if ( subs-&gt;anchor_classes ) {</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :                 putshort(lkf,ac_info);</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :                 for ( ac=sf-&gt;anchor, a=0; ac!=NULL; ac=ac-&gt;next )</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :                     if ( ac-&gt;subtable==subs &amp;&amp; ac-&gt;has_base &amp;&amp; ac-&gt;has_mark )</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :                         ++a;</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :                 ac_info += 2 + 2*a;</span>
<span class="lineNum">     305 </span>            :             } else
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :                 putshort(lkf,0);</span>
<span class="lineNum">     307 </span>            :         }
<span class="lineNum">     308 </span>            :     }
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :     for ( otl=lookups; otl!=NULL; otl=otl-&gt;next ) if ( !otl-&gt;unused ) {</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :         for ( subs = otl-&gt;subtables, s=0; subs!=NULL; subs=subs-&gt;next ) if ( !subs-&gt;unused ) {</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :             if ( subs-&gt;anchor_classes ) {</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :                 for ( ac=sf-&gt;anchor, a=0; ac!=NULL; ac=ac-&gt;next )</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :                     if ( ac-&gt;subtable==subs &amp;&amp; ac-&gt;has_base &amp;&amp; ac-&gt;has_mark )</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :                         ++a;</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :                 putshort(lkf,a);</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :                 for ( ac=sf-&gt;anchor, a=0; ac!=NULL; ac=ac-&gt;next )</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :                     if ( ac-&gt;subtable==subs &amp;&amp; ac-&gt;has_base &amp;&amp; ac-&gt;has_mark ) {</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :                         putshort(lkf,name_info);</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :                         name_info += strlen(ac-&gt;name)+1;</span>
<span class="lineNum">     320 </span>            :                     }
<span class="lineNum">     321 </span>            :             }
<span class="lineNum">     322 </span>            :         }
<span class="lineNum">     323 </span>            :     }
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :     for ( otl=lookups; otl!=NULL; otl=otl-&gt;next ) if ( !otl-&gt;unused ) {</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :         fputs(otl-&gt;lookup_name,lkf);</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :         putc('\0',lkf);</span>
<span class="lineNum">     327 </span>            :     }
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :     for ( otl=lookups; otl!=NULL; otl=otl-&gt;next ) if ( !otl-&gt;unused ) {</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :         for ( subs = otl-&gt;subtables, s=0; subs!=NULL; subs=subs-&gt;next ) if ( !subs-&gt;unused ) {</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :             fputs(subs-&gt;subtable_name,lkf);</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :             putc('\0',lkf);</span>
<span class="lineNum">     332 </span>            :         }
<span class="lineNum">     333 </span>            :     }
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     for ( otl=lookups; otl!=NULL; otl=otl-&gt;next ) if ( !otl-&gt;unused ) {</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :         for ( subs = otl-&gt;subtables, s=0; subs!=NULL; subs=subs-&gt;next ) if ( !subs-&gt;unused ) {</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :             for ( ac=sf-&gt;anchor, a=0; ac!=NULL; ac=ac-&gt;next )</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :                 if ( ac-&gt;subtable==subs &amp;&amp; ac-&gt;has_base &amp;&amp; ac-&gt;has_mark ) {</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                     fputs(ac-&gt;name,lkf);</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :                     putc('\0',lkf);</span>
<span class="lineNum">     340 </span>            :                 }
<span class="lineNum">     341 </span>            :         }
<span class="lineNum">     342 </span>            :     }
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :     if ( ftell(lkf) &amp; 1 )</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :         putc('\0',lkf);</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :     if ( ftell(lkf) &amp; 2 )</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :         putshort(lkf,0);</span>
<a name="347"><span class="lineNum">     347 </span>            : }</a>
<span class="lineNum">     348 </span>            : 
<span class="lineNum">     349 </span><span class="lineNoCov">          0 : static int pfed_mod_type(float val,int last_mod) {</span>
<span class="lineNum">     350 </span>            :     float ival;
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :     if ( last_mod==V_F )</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 : return( V_F );</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     ival = rint(val);</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :     if ( ival!=val || ival&lt;-32768 || ival&gt;32767 )</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 : return( V_F );</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :     if ( last_mod==V_S || ival&lt;-128 || ival&gt;127 )</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 : return( V_S );</span>
<span class="lineNum">     359 </span>            : 
<span class="lineNum">     360 </span><span class="lineNoCov">          0 : return( V_B );</span>
<a name="361"><span class="lineNum">     361 </span>            : }</a>
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span><span class="lineNoCov">          0 : static void pfed_write_data(FILE *ttf, float val, int mod) {</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :     if ( mod==V_F )</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :         putlong(ttf,(int) rint(val*256.0f));</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :     else if ( mod==V_S )</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :         putshort(ttf,(int) rint(val));</span>
<span class="lineNum">     368 </span>            :     else
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :         putc(((int) rint(val)), ttf);</span>
<a name="370"><span class="lineNum">     370 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span><span class="lineNoCov">          0 : static void pfed_glyph_layer(FILE *layr,Layer *layer, int do_spiro) {</span>
<span class="lineNum">     373 </span>            :     int contour_cnt, image_cnt, ref_cnt, name_off, i,j;
<span class="lineNum">     374 </span>            :     SplineSet *ss;
<span class="lineNum">     375 </span>            :     SplinePoint *sp;
<span class="lineNum">     376 </span>            :     uint32 base;
<span class="lineNum">     377 </span>            :     int mod, was_implicit;
<span class="lineNum">     378 </span>            :     RefChar *ref;
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :     contour_cnt = 0;</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :     for ( ss=layer-&gt;splines; ss!=NULL; ss=ss-&gt;next )</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :         ++contour_cnt;</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :     image_cnt = 0;</span>
<span class="lineNum">     384 </span>            :     /* I'm not doing images yet (if ever) but I leave space for them */
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :     ref_cnt = 0;</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :     for ( ref=layer-&gt;refs; ref!=NULL; ref=ref-&gt;next )</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :         ++ref_cnt;</span>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :     base = ftell(layr);</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :     putshort(layr,contour_cnt);</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     putshort(layr,ref_cnt);</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :     putshort(layr,image_cnt);</span>
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :     name_off = 2*3 + 4 * contour_cnt + (4*7+2)* ref_cnt;</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :     for ( ss=layer-&gt;splines; ss!=NULL; ss=ss-&gt;next ) {</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :         putshort(layr,0);                       /* fill in later */</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :         if ( ss-&gt;contour_name!=NULL ) {</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :             putshort(layr,name_off);</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :             name_off += strlen(ss-&gt;contour_name)+1;</span>
<span class="lineNum">     400 </span>            :         } else {
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :             putshort(layr,0);</span>
<span class="lineNum">     402 </span>            :         }
<span class="lineNum">     403 </span>            :     }
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     for ( ref=layer-&gt;refs; ref!=NULL; ref=ref-&gt;next ) {</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;6; ++j )</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :             putlong(layr, (int) rint(ref-&gt;transform[j]*32768));</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :         putshort(layr,ref-&gt;sc-&gt;ttf_glyph);</span>
<span class="lineNum">     408 </span>            :     }
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :     for ( ss=layer-&gt;splines; ss!=NULL; ss=ss-&gt;next ) {</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :         if ( ss-&gt;contour_name!=NULL ) {</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :             fputs(ss-&gt;contour_name,layr);</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :             putc('\0',layr);</span>
<span class="lineNum">     413 </span>            :         }
<span class="lineNum">     414 </span>            :     }
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :     contour_cnt=0;</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :     for ( ss=layer-&gt;splines; ss!=NULL; ss=ss-&gt;next, ++contour_cnt ) {</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :         uint32 pos = ftell(layr);</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :         fseek( layr, base + 6 + 4*contour_cnt, SEEK_SET);</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :         putshort( layr, pos-base);</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :         fseek( layr, pos, SEEK_SET );</span>
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :         if ( !do_spiro ) {</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :             sp = ss-&gt;first;</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :             mod = pfed_mod_type(sp-&gt;me.x, pfed_mod_type(sp-&gt;me.y,V_B));</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :             putc( (V_MoveTo|mod),layr);</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :             pfed_write_data(layr,sp-&gt;me.x,mod);</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :             pfed_write_data(layr,sp-&gt;me.y,mod);</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :             was_implicit = false;</span>
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :             while ( sp-&gt;next!=NULL ) {</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :                 SplinePoint *nsp = sp-&gt;next-&gt;to;</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :                 float offx = nsp-&gt;me.x - sp-&gt;me.x;</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :                 float offy = nsp-&gt;me.y - sp-&gt;me.y;</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :                 if ( offx==0 &amp;&amp; offy==0 )</span>
<span class="lineNum">     436 </span>            :                     /* Do Nothing */;
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :                 else if ( sp-&gt;next-&gt;knownlinear ) {</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :                     mod = pfed_mod_type(offx, pfed_mod_type(offy,V_B));</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :                     if ( offx==0 ) {</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :                         putc( (V_VLineTo|mod), layr);</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offy,mod);</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :                     } else if ( offy==0 ) {</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :                         putc( (V_HLineTo|mod), layr);</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offx,mod);</span>
<span class="lineNum">     445 </span>            :                     } else {
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :                         putc( (V_LineTo|mod), layr);</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offx,mod);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offy,mod);</span>
<span class="lineNum">     449 </span>            :                     }
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :                 } else if ( sp-&gt;next-&gt;order2 ) {</span>
<span class="lineNum">     451 </span>            :                     float offx1, offx2, offy1, offy2;
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :                     BasePoint *base = was_implicit ? &amp;sp-&gt;prevcp : &amp;sp-&gt;me;</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :                     offx1 = sp-&gt;nextcp.x - base-&gt;x;</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :                     offy1 = sp-&gt;nextcp.y - base-&gt;y;</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :                     mod = pfed_mod_type(offx1, pfed_mod_type(offy1,V_B));</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :                     if ( SPInterpolate(nsp) &amp;&amp; nsp!=ss-&gt;first ) {</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :                         was_implicit = true;</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :                         if ( offx1==0 ) {</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :                             putc( (V_QVImplicit|mod), layr);</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :                             pfed_write_data(layr,offy1,mod);</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :                         } else if ( offy1==0 ) {</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :                             putc( (V_QHImplicit|mod), layr);</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :                             pfed_write_data(layr,offx1,mod);</span>
<span class="lineNum">     464 </span>            :                         } else {
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :                             putc( (V_QImplicit|mod), layr);</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                             pfed_write_data(layr,offx1,mod);</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :                             pfed_write_data(layr,offy1,mod);</span>
<span class="lineNum">     468 </span>            :                         }
<span class="lineNum">     469 </span>            :                     } else {
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :                         offx2 = nsp-&gt;me.x - sp-&gt;nextcp.x;</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :                         offy2 = nsp-&gt;me.y - sp-&gt;nextcp.y;</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :                         mod = pfed_mod_type(offx2, pfed_mod_type(offy2,mod));</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :                         was_implicit = false;</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :                         putc( (V_QCurveTo|mod), layr);</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offx1,mod);</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offy1,mod);</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offx2,mod);</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offy2,mod);</span>
<span class="lineNum">     479 </span>            :                     }
<span class="lineNum">     480 </span>            :                 } else {
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :                     float offx1 = sp-&gt;nextcp.x - sp-&gt;me.x;</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :                     float offy1 = sp-&gt;nextcp.y - sp-&gt;me.y;</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :                     float offx2 = nsp-&gt;prevcp.x - sp-&gt;nextcp.x;</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :                     float offy2 = nsp-&gt;prevcp.y - sp-&gt;nextcp.y;</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :                     float offx3 = nsp-&gt;me.x - nsp-&gt;prevcp.x;</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :                     float offy3 = nsp-&gt;me.y - nsp-&gt;prevcp.y;</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :                     mod = pfed_mod_type(offx1, pfed_mod_type(offy1,V_B));</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :                     mod = pfed_mod_type(offx2, pfed_mod_type(offy2,mod));</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :                     mod = pfed_mod_type(offx3, pfed_mod_type(offy3,mod));</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :                     if ( offx1==0 &amp;&amp; offy3==0 ) {</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :                         putc((V_VHCurveTo|mod),layr);</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offy1,mod);</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offx2,mod);</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offy2,mod);</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offx3,mod);</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                     } else if ( offy1==0 &amp;&amp; offx3==0 ) {</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                         putc((V_HVCurveTo|mod),layr);</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offx1,mod);</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offx2,mod);</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offy2,mod);</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offy3,mod);</span>
<span class="lineNum">     502 </span>            :                     } else {
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :                         putc((V_CurveTo|mod),layr);</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offx1,mod);</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offy1,mod);</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offx2,mod);</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offy2,mod);</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offx3,mod);</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :                         pfed_write_data(layr,offy3,mod);</span>
<span class="lineNum">     510 </span>            :                     }
<span class="lineNum">     511 </span>            :                 }
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :                 if ( nsp == ss-&gt;first )</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :                 if ( nsp-&gt;next!=NULL &amp;&amp; nsp-&gt;next-&gt;to==ss-&gt;first &amp;&amp; nsp-&gt;next-&gt;knownlinear )</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :                 sp = nsp;</span>
<span class="lineNum">     517 </span>            :             }
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :             if ( sp-&gt;next==NULL )</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :                 putc(V_End,layr);</span>
<span class="lineNum">     520 </span>            :             else
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :                 putc(V_Close,layr);</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :         } else if ( ss-&gt;spiro_cnt==0 )</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :             putc(SPIRO_CLOSE_CONTOUR,layr);             /* Mark for an empty spiro contour */</span>
<span class="lineNum">     524 </span>            :         else {
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;ss-&gt;spiro_cnt; ++i ) {</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :                 if ( i==ss-&gt;spiro_cnt-1 &amp;&amp; ss-&gt;first-&gt;prev==NULL )</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :                     putc(SPIRO_CLOSE_CONTOUR,layr);</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :                 else if ( i==0 &amp;&amp; ss-&gt;first-&gt;prev==NULL ) /* Open */</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :                     putc(SPIRO_OPEN_CONTOUR,layr);</span>
<span class="lineNum">     530 </span>            :                 else
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :                     putc(ss-&gt;spiros[i].ty&amp;0x7f,layr);</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :                 putlong(layr,rint(ss-&gt;spiros[i].x*256.0));</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :                 putlong(layr,rint(ss-&gt;spiros[i].y*256.0));</span>
<span class="lineNum">     534 </span>            :             }
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :             putc(SPIRO_END,layr);               /* Add the z whether open or not. Might as well */</span>
<span class="lineNum">     536 </span>            :         }
<span class="lineNum">     537 </span>            :     }
<span class="lineNum">     538 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     539 </span>            : 
<span class="lineNum">     540 </span>            : struct pos_name {
<span class="lineNum">     541 </span>            :     real pos;
<span class="lineNum">     542 </span>            :     char *name;
<a name="543"><span class="lineNum">     543 </span>            : };</a>
<span class="lineNum">     544 </span>            : 
<span class="lineNum">     545 </span><span class="lineNoCov">          0 : static int pfed_guide_real_comp(const void *_r1, const void *_r2) {</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :     const struct pos_name *r1 = _r1, *r2 = _r2;</span>
<span class="lineNum">     547 </span>            : 
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :     if ( r1-&gt;pos&gt;r2-&gt;pos )</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 : return( 1 );</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :     else if ( r1-&gt;pos&lt;r2-&gt;pos )</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 : return( -1 );</span>
<span class="lineNum">     552 </span>            :     else
<span class="lineNum">     553 </span><span class="lineNoCov">          0 : return( 0 );</span>
<a name="554"><span class="lineNum">     554 </span>            : }</a>
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span><span class="lineNoCov">          0 : static int pfed_guide_sortuniq( struct pos_name *array, int cnt) {</span>
<span class="lineNum">     557 </span>            :     int i,j;
<span class="lineNum">     558 </span>            : 
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :     qsort(array,cnt,sizeof(struct pos_name),pfed_guide_real_comp);</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :     for ( i=j=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :         if ( array[i].pos&lt;-32768 || array[i].pos&gt;32767 )</span>
<span class="lineNum">     562 </span>            :             /* Out of bounds, ignore it */;
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :         else if ( i!=0 &amp;&amp; array[i].pos == array[i-1].pos )</span>
<span class="lineNum">     564 </span>            :             /* Duplicate, ignore it */;
<span class="lineNum">     565 </span>            :         else
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :             array[j++] = array[i];</span>
<span class="lineNum">     567 </span>            :     }
<span class="lineNum">     568 </span><span class="lineNoCov">          0 : return( j );</span>
<a name="569"><span class="lineNum">     569 </span>            : }</a>
<span class="lineNum">     570 </span>            : 
<span class="lineNum">     571 </span><span class="lineNoCov">          0 : static int pfed_guide_dump_pos_name(FILE *guid, struct pos_name *pn, int namestart ) {</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :     putshort(guid,(short) rint(pn-&gt;pos));</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :     if ( pn-&gt;name!=NULL ) {</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :         putshort(guid,namestart);</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :         namestart += strlen(pn-&gt;name)+1;</span>
<span class="lineNum">     576 </span>            :     } else {
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :         putshort(guid,0);</span>
<span class="lineNum">     578 </span>            :     }
<span class="lineNum">     579 </span><span class="lineNoCov">          0 : return( namestart );</span>
<a name="580"><span class="lineNum">     580 </span>            : }</a>
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span><span class="lineNoCov">          0 : static void PfEd_Guides(SplineFont *sf, struct PfEd_subtabs *pfed ) {</span>
<span class="lineNum">     583 </span>            :     int h,v, i;
<span class="lineNum">     584 </span>            :     SplineSet *ss;
<span class="lineNum">     585 </span>            :     Spline *s, *first;
<span class="lineNum">     586 </span>            :     FILE *guid;
<span class="lineNum">     587 </span>            :     struct pos_name hs[100], vs[100];
<span class="lineNum">     588 </span>            :     int nameoff, namelen;
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :     if ( sf-&gt;grid.splines==NULL )</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     592 </span>            : 
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :     h=v=0;</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :     for ( ss=sf-&gt;grid.splines; ss!=NULL; ss=ss-&gt;next ) {</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :         first = NULL;</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :         for ( s=ss-&gt;first-&gt;next; s!=NULL &amp;&amp; s!=first; s=s-&gt;to-&gt;next ) {</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :             if ( first==NULL ) first = s;</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :             if ( s-&gt;from-&gt;me.x==s-&gt;to-&gt;me.x ) {</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :                 if ( s-&gt;from-&gt;me.y!=s-&gt;to-&gt;me.y &amp;&amp; v&lt;100 ) {</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :                     vs[v].name = ss-&gt;contour_name;</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :                     vs[v++].pos = s-&gt;from-&gt;me.x;</span>
<span class="lineNum">     602 </span>            :                 }
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :             } else if ( s-&gt;from-&gt;me.y==s-&gt;to-&gt;me.y ) {</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :                 if ( h&lt;100 ) {</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :                     hs[h].name = ss-&gt;contour_name;</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :                     hs[h++].pos = s-&gt;from-&gt;me.y;</span>
<span class="lineNum">     607 </span>            :                 }
<span class="lineNum">     608 </span>            :             }
<span class="lineNum">     609 </span>            :         }
<span class="lineNum">     610 </span>            :     }
<span class="lineNum">     611 </span>            : 
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :     v = pfed_guide_sortuniq(vs,v);</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :     h = pfed_guide_sortuniq(hs,h);</span>
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next].tag = guid_TAG;</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next++].data = guid = tmpfile();</span>
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :     nameoff   = 5*2 + (h+v) * 4;</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :     namelen   = 0;</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;v; ++i ) if ( vs[i].name!=NULL )</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :         namelen += strlen( vs[i].name )+1;</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;h; ++i ) if ( hs[i].name!=NULL )</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :         namelen += strlen( hs[i].name )+1;</span>
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :     putshort(guid,1);                   /* sub-table version number */</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :     putshort(guid,v);</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :     putshort(guid,h);</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :     putshort(guid,0);                   /* Diagonal lines someday? nothing for now */</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :     putshort(guid,nameoff+namelen);     /* full spline output */</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;v; ++i )</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :         nameoff = pfed_guide_dump_pos_name(guid, &amp;vs[i], nameoff );</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;h; ++i )</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :         nameoff = pfed_guide_dump_pos_name(guid, &amp;hs[i], nameoff );</span>
<span class="lineNum">     634 </span>            : 
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;v; ++i ) if ( vs[i].name!=NULL ) {</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :         fputs(vs[i].name,guid);</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :         putc('\0',guid);</span>
<span class="lineNum">     638 </span>            :     }
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;h; ++i ) if ( hs[i].name!=NULL ) {</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :         fputs(hs[i].name,guid);</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :         putc('\0',guid);</span>
<span class="lineNum">     642 </span>            :     }
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :     pfed_glyph_layer(guid,&amp;sf-&gt;grid,false);</span>
<span class="lineNum">     645 </span>            : 
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :     if ( ftell(guid) &amp; 1 )</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :         putc('\0',guid);</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :     if ( ftell(guid) &amp; 2 )</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :         putshort(guid,0);</span>
<a name="650"><span class="lineNum">     650 </span>            : }</a>
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineNoCov">          0 : static int pfed_has_spiros(Layer *layer) {</span>
<span class="lineNum">     653 </span>            :     SplineSet *ss;
<span class="lineNum">     654 </span>            : 
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :     for ( ss=layer-&gt;splines; ss!=NULL; ss=ss-&gt;next ) {</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :         if ( ss-&gt;spiro_cnt&gt;1 )</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 : return( true );</span>
<span class="lineNum">     658 </span>            :     }
<span class="lineNum">     659 </span><span class="lineNoCov">          0 : return( false );</span>
<a name="660"><span class="lineNum">     660 </span>            : }</a>
<span class="lineNum">     661 </span>            : 
<span class="lineNum">     662 </span><span class="lineNoCov">          0 : static void PfEd_Layer(SplineFont *sf, struct glyphinfo *gi, int layer, int dospiro,</span>
<span class="lineNum">     663 </span>            :         FILE *layr) {
<span class="lineNum">     664 </span>            :     int i, j, k, gid, cnt, last, skipped;
<span class="lineNum">     665 </span>            :     SplineChar *sc, *sc2;
<span class="lineNum">     666 </span>            :     uint32 offset;
<span class="lineNum">     667 </span>            :     uint32 *glyph_data_offset_location;
<span class="lineNum">     668 </span>            : 
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;gi-&gt;gcnt; ++i ) if ( gi-&gt;bygid[i]!=-1 )</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :         if ( (sc=sf-&gt;glyphs[gi-&gt;bygid[i]])!=NULL ) {</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :             sc-&gt;ticked = false;</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :             if ( (!dospiro &amp;&amp; (sc-&gt;layers[layer].splines!=NULL || sc-&gt;layers[layer].refs!=NULL) ) ||</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :                     (dospiro &amp;&amp; pfed_has_spiros(&amp;sc-&gt;layers[layer])) )</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :                 sc-&gt;ticked=true;</span>
<span class="lineNum">     675 </span>            :         }
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :     offset = ftell(layr);</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :     glyph_data_offset_location = calloc(gi-&gt;gcnt,sizeof(uint32));</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :     for ( j=0; j&lt;4; ++j ) {</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :         cnt = 0;</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;gi-&gt;gcnt; ++i ) if ( (gid=gi-&gt;bygid[i])!=-1 &amp;&amp; (sc=sf-&gt;glyphs[gid])!=NULL ) {</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :             if ( sc-&gt;ticked ) {</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :                 last = i; skipped = false;</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :                 for ( k=i+1; k&lt;gi-&gt;gcnt; ++k ) {</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :                     sc2 = NULL;</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :                     if ( gi-&gt;bygid[k]!=-1 )</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :                         sc2 = sf-&gt;glyphs[gi-&gt;bygid[k]];</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :                     if ( skipped &amp;&amp; (sc2==NULL || !sc2-&gt;ticked))</span>
<span class="lineNum">     689 </span>            :                 break;
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :                     if ( sc2!=NULL &amp;&amp; sc2-&gt;ticked ) {</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :                         last = k;</span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :                         skipped = false;</span>
<span class="lineNum">     693 </span>            :                     } else
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :                         skipped = true;</span>
<span class="lineNum">     695 </span>            :                 }
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :                 ++cnt;</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :                 if ( j==1 ) {</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :                     putshort(layr,i);</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :                     putshort(layr,last);</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :                     putlong(layr,offset);</span>
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :                     offset += sizeof(uint32)*(last-i+1);</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :                 } else if ( j==2 ) {</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :                     for ( ; i&lt;=last; ++i ) {</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :                         if ( gi-&gt;bygid[i]==-1 || !sf-&gt;glyphs[gi-&gt;bygid[i]]-&gt;ticked )</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :                             putlong(layr,0);</span>
<span class="lineNum">     706 </span>            :                         else {
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :                             glyph_data_offset_location[i] = ftell(layr);</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :                             putlong(layr,0);</span>
<span class="lineNum">     709 </span>            :                         }
<span class="lineNum">     710 </span>            :                     }
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :                 } else if ( j==3 ) {</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :                     for ( ; i&lt;=last; ++i ) {</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :                         if ( gi-&gt;bygid[i]!=-1 &amp;&amp; (sc=sf-&gt;glyphs[gi-&gt;bygid[i]])-&gt;ticked ) {</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :                             uint32 pos = ftell(layr);</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :                             fseek(layr,glyph_data_offset_location[i],SEEK_SET);</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :                             putlong(layr,pos);  /* Offset relative to start of subtable==start of file */</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :                             fseek(layr,pos,SEEK_SET);</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :                             pfed_glyph_layer(layr,&amp;sc-&gt;layers[layer],dospiro);</span>
<span class="lineNum">     719 </span>            :                         }
<span class="lineNum">     720 </span>            :                     }
<span class="lineNum">     721 </span>            :                 }
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :                 i = last;</span>
<span class="lineNum">     723 </span>            :             }
<span class="lineNum">     724 </span>            :         }
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :         if ( j==0 ) {</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :             offset += sizeof(short) + cnt*(2*sizeof(short)+sizeof(uint32));</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :             putshort(layr,cnt);</span>
<span class="lineNum">     728 </span>            :         }
<span class="lineNum">     729 </span>            :     }
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :     free(glyph_data_offset_location);</span>
<a name="731"><span class="lineNum">     731 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     732 </span>            : 
<span class="lineNum">     733 </span><span class="lineNoCov">          0 : static void PfEd_Layers(SplineFont *sf, struct PfEd_subtabs *pfed,</span>
<span class="lineNum">     734 </span>            :         struct glyphinfo *gi ) {
<span class="lineNum">     735 </span>            :     /* currently we output the following:              */
<span class="lineNum">     736 </span>            :     /*  The background layer                           */
<span class="lineNum">     737 </span>            :     /*  And the spiro representation of the foreground */
<span class="lineNum">     738 </span>            :     /*  if the foreground is cubic and output is quad then the foreground */
<span class="lineNum">     739 </span>            :     /*  Any other layers                               */
<span class="lineNum">     740 </span>            :     /* Check if any of these data exist                */
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :     uint8 has_spiro=0;</span>
<span class="lineNum">     742 </span>            :     uint8 *otherlayers;
<span class="lineNum">     743 </span>            :     int i, name_off, l, cnt, sofar;
<span class="lineNum">     744 </span>            :     SplineChar *sc;
<span class="lineNum">     745 </span>            :     FILE *layr;
<span class="lineNum">     746 </span>            : 
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :     otherlayers = calloc(sf-&gt;layer_cnt,sizeof(uint8));</span>
<span class="lineNum">     748 </span>            : 
<span class="lineNum">     749 </span>            :     /* We don't need to check in bygid order. We just want to know existance */
<span class="lineNum">     750 </span>            :     /* We don't check for refs because a reference to an empty glyph is empty too */
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) {</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :         if ( (sc=sf-&gt;glyphs[i])!=NULL &amp;&amp; sc-&gt;ttf_glyph!=-1 ) {</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :             if ( pfed_has_spiros(&amp;sc-&gt;layers[ly_fore]))</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :                 has_spiro = true;</span>
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :             for ( l=ly_back ; l&lt;sf-&gt;layer_cnt; ++l )</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :                 if ( sc-&gt;layers[l].splines!=NULL )</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :                     otherlayers[l] = true;</span>
<span class="lineNum">     758 </span>            :         }
<span class="lineNum">     759 </span>            :     }
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :     otherlayers[gi-&gt;layer] = (!sf-&gt;layers[gi-&gt;layer].order2 &amp;&amp;  gi-&gt;is_ttf) ||</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :                              ( sf-&gt;layers[gi-&gt;layer].order2 &amp;&amp; !gi-&gt;is_ttf);</span>
<span class="lineNum">     762 </span>            : 
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :     for ( l=cnt=0; l&lt;sf-&gt;layer_cnt; ++l )</span>
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :         if ( otherlayers[l] )</span>
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :             ++cnt;</span>
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :     cnt += has_spiro;</span>
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :     if ( cnt==0 ) {</span>
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :     free(otherlayers);</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     770 </span>            :     }
<span class="lineNum">     771 </span>            : 
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next].tag = layr_TAG;</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :     pfed-&gt;subtabs[pfed-&gt;next++].data = layr = tmpfile();</span>
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :     putshort(layr,1);                   /* sub-table version */</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :     putshort(layr,cnt);                 /* layer count */</span>
<span class="lineNum">     777 </span>            : 
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :     name_off = 4 + 8 * cnt;</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :     if ( has_spiro ) {</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :         putshort(layr,1);               /* spiros */</span>
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :         putshort(layr,name_off);</span>
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :         name_off += strlen(&quot;Spiro&quot;)+1;</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :         putlong(layr,0);                /* Fill in later */</span>
<span class="lineNum">     784 </span>            :     }
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :     for ( l=0; l&lt;sf-&gt;layer_cnt; ++l ) if ( otherlayers[l]) {</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :         putshort(layr,(sf-&gt;layers[l].order2?2:3) |           /* Quadratic/cubic */</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :                       (sf-&gt;layers[l].background?0:0x100));   /* Fore/Back */</span>
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :         putshort(layr,name_off);</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :         if ( l==ly_fore ) name_off += strlen(&quot;Old_&quot;);</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :         name_off += strlen(sf-&gt;layers[l].name)+1;</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :         putlong(layr,0);                /* Fill in later */</span>
<span class="lineNum">     792 </span>            :     }
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :     if ( has_spiro ) {</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :         fputs(&quot;Spiro&quot;,layr);</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :         putc('\0',layr);</span>
<span class="lineNum">     796 </span>            :     }
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :     for ( l=0; l&lt;sf-&gt;layer_cnt; ++l ) if ( otherlayers[l]) {</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :         if ( l==ly_fore ) fputs(&quot;Old_&quot;,layr);</span>
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :         fputs(sf-&gt;layers[l].name,layr);</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :         putc('\0',layr);</span>
<span class="lineNum">     801 </span>            :     }
<span class="lineNum">     802 </span>            : 
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :     sofar = 0;</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :     if ( has_spiro ) {</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :         uint32 pos = ftell(layr);</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :         fseek(layr, 4 + 0*8 + 4, SEEK_SET);</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :         putlong(layr,pos);</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :         fseek(layr, 0, SEEK_END);</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :         PfEd_Layer(sf, gi, ly_fore, true, layr);</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :         ++sofar;</span>
<span class="lineNum">     811 </span>            :     }
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :     for ( l=0; l&lt;sf-&gt;layer_cnt; ++l ) if ( otherlayers[l]) {</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :         uint32 pos = ftell(layr);</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :         fseek(layr, 4 + sofar*8 + 4, SEEK_SET);</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :         putlong(layr,pos);</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :         fseek(layr, 0, SEEK_END);</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :         PfEd_Layer(sf, gi, l, false, layr);</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :         ++sofar;</span>
<span class="lineNum">     819 </span>            :     }
<span class="lineNum">     820 </span>            : 
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :     if ( ftell(layr) &amp; 1 )</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :         putc('\0',layr);</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :     if ( ftell(layr) &amp; 2 )</span>
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :         putshort(layr,0);</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :     free(otherlayers);</span>
<a name="826"><span class="lineNum">     826 </span>            : }</a>
<span class="lineNum">     827 </span>            : 
<span class="lineNum">     828 </span><span class="lineCov">         27 : void pfed_dump(struct alltabs *at, SplineFont *sf) {</span>
<span class="lineNum">     829 </span>            :     struct PfEd_subtabs pfed;
<span class="lineNum">     830 </span>            :     FILE *file;
<span class="lineNum">     831 </span>            :     int i;
<span class="lineNum">     832 </span>            :     uint32 offset;
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span><span class="lineCov">         27 :     memset(&amp;pfed,0,sizeof(pfed));</span>
<span class="lineNum">     835 </span><span class="lineCov">         27 :     if ( at-&gt;gi.flags &amp; ttf_flag_pfed_comments ) {</span>
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :         PfEd_FontComment(sf, &amp;pfed, fcmt_TAG );</span>
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :         PfEd_FontComment(sf, &amp;pfed, flog_TAG );</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :         PfEd_GlyphComments(sf, &amp;pfed, &amp;at-&gt;gi );</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :         PfEd_CvtComments(sf, &amp;pfed );</span>
<span class="lineNum">     840 </span>            :     }
<span class="lineNum">     841 </span><span class="lineCov">         27 :     if ( at-&gt;gi.flags &amp; ttf_flag_pfed_colors )</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :         PfEd_Colours(sf, &amp;pfed, &amp;at-&gt;gi );</span>
<span class="lineNum">     843 </span><span class="lineCov">         27 :     if ( (at-&gt;gi.flags &amp; ttf_flag_pfed_lookupnames) &amp;&amp; at-&gt;opentypemode ) {</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :         PfEd_Lookups(sf, &amp;pfed, sf-&gt;gsub_lookups, GSUB_TAG );</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :         PfEd_Lookups(sf, &amp;pfed, sf-&gt;gpos_lookups, GPOS_TAG );</span>
<span class="lineNum">     846 </span>            :     }
<span class="lineNum">     847 </span><span class="lineCov">         27 :     if ( at-&gt;gi.flags &amp; ttf_flag_pfed_guides )</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :         PfEd_Guides(sf, &amp;pfed);</span>
<span class="lineNum">     849 </span><span class="lineCov">         27 :     if ( at-&gt;gi.flags &amp; ttf_flag_pfed_layers )</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :         PfEd_Layers(sf, &amp;pfed, &amp;at-&gt;gi);</span>
<span class="lineNum">     851 </span>            : 
<span class="lineNum">     852 </span><span class="lineCov">         27 :     if ( pfed.next==0 )</span>
<span class="lineNum">     853 </span><span class="lineCov">         54 : return;         /* No subtables */</span>
<span class="lineNum">     854 </span>            : 
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :     at-&gt;pfed = file = tmpfile();</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :     putlong(file, 0x00010000);          /* Version number */</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :     putlong(file, pfed.next);           /* sub-table count */</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :     offset = 2*sizeof(uint32) + 2*pfed.next*sizeof(uint32);</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;pfed.next; ++i ) {</span>
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :         putlong(file,pfed.subtabs[i].tag);</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :         putlong(file,offset);</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :         fseek(pfed.subtabs[i].data,0,SEEK_END);</span>
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :         pfed.subtabs[i].offset = offset;</span>
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :         offset += ftell(pfed.subtabs[i].data);</span>
<span class="lineNum">     865 </span>            :     }
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;pfed.next; ++i ) {</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :         fseek(pfed.subtabs[i].data,0,SEEK_SET);</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :         ttfcopyfile(file,pfed.subtabs[i].data,pfed.subtabs[i].offset,&quot;PfEd-subtable&quot;);</span>
<span class="lineNum">     869 </span>            :     }
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :     if ( ftell(file)&amp;3 )</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :         IError(&quot;'PfEd' table not properly aligned&quot;);</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :     at-&gt;pfedlen = ftell(file);</span>
<span class="lineNum">     873 </span>            : }
<span class="lineNum">     874 </span>            : 
<span class="lineNum">     875 </span>            : /* *************************    The 'PfEd' table    ************************* */
<a name="876"><span class="lineNum">     876 </span>            : /* *************************          Input         ************************* */</a>
<span class="lineNum">     877 </span>            : 
<span class="lineNum">     878 </span><span class="lineNoCov">          0 : static void pfed_readfontcomment(FILE *ttf,struct ttfinfo *info,uint32 base,</span>
<span class="lineNum">     879 </span>            :         uint32 tag) {
<span class="lineNum">     880 </span>            :     int len;
<span class="lineNum">     881 </span>            :     char *start, *pt, *end;
<span class="lineNum">     882 </span>            :     int use_utf8;
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :     use_utf8 = getushort(ttf);</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :     if ( use_utf8!=0 &amp;&amp; use_utf8!=1 )</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 : return;                 /* Bad version number */</span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :     len = getushort(ttf);</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :     start = pt = malloc(len+1);</span>
<span class="lineNum">     890 </span>            : 
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :     end = pt+len;</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :     if ( use_utf8 ) {</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :         while ( pt&lt;end )</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :             *pt++ = getc(ttf);</span>
<span class="lineNum">     895 </span>            :     } else {
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :         while ( pt&lt;end )</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :             *pt++ = getushort(ttf);</span>
<span class="lineNum">     898 </span>            :     }
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :     *pt = '\0';</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :     if ( !use_utf8 ) {</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :         pt = latin1_2_utf8_copy(info-&gt;fontcomments);</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :         free(start);</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :         start = pt;</span>
<span class="lineNum">     904 </span>            :     }
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :     if ( tag==flog_TAG )</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :         info-&gt;fontlog = start;</span>
<span class="lineNum">     907 </span>            :     else
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :         info-&gt;fontcomments = start;</span>
<a name="909"><span class="lineNum">     909 </span>            : }</a>
<span class="lineNum">     910 </span>            : 
<span class="lineNum">     911 </span><span class="lineNoCov">          0 : static char *pfed_read_utf8(FILE *ttf, uint32 start) {</span>
<span class="lineNum">     912 </span>            :     int ch, len;
<span class="lineNum">     913 </span>            :     char *str, *pt;
<span class="lineNum">     914 </span>            : 
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :     fseek( ttf, start, SEEK_SET);</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :     len = 0;</span>
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :     while ( (ch=getc(ttf))!='\0' &amp;&amp; ch!=EOF )</span>
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :         ++len;</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :     fseek( ttf, start, SEEK_SET);</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :     str = pt = malloc(len+1);</span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :     while ( (ch=getc(ttf))!='\0' &amp;&amp; ch!=EOF )</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :         *pt++ = ch;</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :     *pt = '\0';</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 : return( str );</span>
<a name="925"><span class="lineNum">     925 </span>            : }</a>
<span class="lineNum">     926 </span>            : 
<span class="lineNum">     927 </span><span class="lineNoCov">          0 : static char *pfed_read_ucs2_len(FILE *ttf,uint32 offset,int len) {</span>
<span class="lineNum">     928 </span>            :     char *pt, *str;
<span class="lineNum">     929 </span>            :     uint32 uch, uch2;
<span class="lineNum">     930 </span>            :     int i;
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :     if ( len&lt;0 )</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     934 </span>            : 
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :     len&gt;&gt;=1;</span>
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :     if ( (pt=str=malloc(len&gt;0 ? 3*len:1))==NULL )</span>
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :         return( NULL );</span>
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :     fseek(ttf,offset,SEEK_SET);</span>
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;len; ++i ) {</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :         uch = getushort(ttf);</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :         if ( uch&gt;=0xd800 &amp;&amp; uch&lt;0xdc00 ) {</span>
<span class="lineNum">     942 </span>            :             /* Is this a possible utf16 surrogate value? */
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :             uch2 = getushort(ttf);</span>
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :             if ( uch2&gt;=0xdc00 &amp;&amp; uch2&lt;0xe000 )</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :                 uch = ((uch-0xd800)&lt;&lt;10) | (uch2&amp;0x3ff);</span>
<span class="lineNum">     946 </span>            :             else {
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :                 pt = utf8_idpb(pt,uch,0);</span>
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :                 uch = uch2;</span>
<span class="lineNum">     949 </span>            :             }
<span class="lineNum">     950 </span>            :         }
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :         pt = utf8_idpb(pt,uch,0);</span>
<span class="lineNum">     952 </span>            :     }
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :     *pt++ = 0;</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 : return( realloc(str,pt-str) );</span>
<a name="955"><span class="lineNum">     955 </span>            : }</a>
<span class="lineNum">     956 </span>            : 
<span class="lineNum">     957 </span><span class="lineNoCov">          0 : static char *pfed_read_utf8_len(FILE *ttf,uint32 offset,int len) {</span>
<span class="lineNum">     958 </span>            :     char *pt, *str;
<span class="lineNum">     959 </span>            :     int i;
<span class="lineNum">     960 </span>            : 
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :     if ( len&lt;0 )</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     963 </span>            : 
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :     pt = str = malloc(len+1);</span>
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :     fseek(ttf,offset,SEEK_SET);</span>
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;len; ++i )</span>
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :         *pt++ = getc(ttf);</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :     *pt = '\0';</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 : return( str );</span>
<a name="970"><span class="lineNum">     970 </span>            : }</a>
<span class="lineNum">     971 </span>            : 
<span class="lineNum">     972 </span><span class="lineNoCov">          0 : static void pfed_readcvtcomments(FILE *ttf,struct ttfinfo *info,uint32 base ) {</span>
<span class="lineNum">     973 </span>            :     int count, i;
<span class="lineNum">     974 </span>            :     uint16 *offsets;
<span class="lineNum">     975 </span>            : 
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :     if ( getushort(ttf)!=0 )</span>
<span class="lineNum">     978 </span><span class="lineNoCov">          0 : return;                 /* Bad version number */</span>
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :     count = getushort(ttf);</span>
<span class="lineNum">     980 </span>            : 
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :     offsets = malloc(count*sizeof(uint16));</span>
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :     info-&gt;cvt_names = malloc((count+1)*sizeof(char *));</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;count; ++i )</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :         offsets[i] = getushort(ttf);</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;count; ++i ) {</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :         if ( offsets[i]==0 )</span>
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :             info-&gt;cvt_names[i] = NULL;</span>
<span class="lineNum">     988 </span>            :         else
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :             info-&gt;cvt_names[i] = pfed_read_utf8(ttf,base+offsets[i]);</span>
<span class="lineNum">     990 </span>            :     }
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :     free(offsets);</span>
<a name="992"><span class="lineNum">     992 </span>            : }</a>
<span class="lineNum">     993 </span>            : 
<span class="lineNum">     994 </span><span class="lineNoCov">          0 : static void pfed_readglyphcomments(FILE *ttf,struct ttfinfo *info,uint32 base) {</span>
<span class="lineNum">     995 </span>            :     int n, i, j;
<span class="lineNum">     996 </span>            :     struct grange { int start, end; uint32 offset; } *grange;
<span class="lineNum">     997 </span>            :     uint32 offset, next;
<span class="lineNum">     998 </span>            :     int use_utf8;
<span class="lineNum">     999 </span>            : 
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :     use_utf8 = getushort(ttf);</span>
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :     if ( use_utf8!=0 &amp;&amp; use_utf8!=1 )</span>
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 : return;                 /* Bad version number */</span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :     n = getushort(ttf);</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :     grange = malloc(n*sizeof(struct grange));</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;n; ++i ) {</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :         grange[i].start = getushort(ttf);</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :         grange[i].end = getushort(ttf);</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :         grange[i].offset = getlong(ttf);</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :         if ( grange[i].start&gt;grange[i].end || grange[i].end&gt;info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Bad glyph range specified in glyph comment subtable of PfEd table\n&quot;) );</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :             grange[i].start = 1; grange[i].end = 0;</span>
<span class="lineNum">    1013 </span>            :         }
<span class="lineNum">    1014 </span>            :     }
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;n; ++i ) {</span>
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :         for ( j=grange[i].start; j&lt;=grange[i].end; ++j ) {</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :             fseek( ttf,base+grange[i].offset+(j-grange[i].start)*sizeof(uint32),SEEK_SET);</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :             offset = getlong(ttf);</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :             next = getlong(ttf);</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :             if ( use_utf8 )</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :                 info-&gt;chars[j]-&gt;comment = pfed_read_utf8_len(ttf,base+offset,next-offset);</span>
<span class="lineNum">    1022 </span>            :             else
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :                 info-&gt;chars[j]-&gt;comment = pfed_read_ucs2_len(ttf,base+offset,next-offset);</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :             if ( info-&gt;chars[j]-&gt;comment == NULL )</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :                 LogError(_(&quot;Invalid comment string (negative length?) in 'PfEd' table for glyph %s.&quot;),</span>
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :                         info-&gt;chars[j]-&gt;name );</span>
<span class="lineNum">    1027 </span>            :         }
<span class="lineNum">    1028 </span>            :     }
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :     free(grange);</span>
<a name="1030"><span class="lineNum">    1030 </span>            : }</a>
<span class="lineNum">    1031 </span>            : 
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 : static void pfed_readcolours(FILE *ttf,struct ttfinfo *info,uint32 base) {</span>
<span class="lineNum">    1033 </span>            :     int n, i, j, start, end;
<span class="lineNum">    1034 </span>            :     uint32 col;
<span class="lineNum">    1035 </span>            : 
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :     if ( getushort(ttf)!=0 )</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 : return;                 /* Bad version number */</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :     n = getushort(ttf);</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;n; ++i ) {</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :         start = getushort(ttf);</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :         end = getushort(ttf);</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :         col = getlong(ttf);</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :         if ( start&gt;end || end&gt;info-&gt;glyph_cnt )</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Bad glyph range specified in color subtable of PfEd table\n&quot;) );</span>
<span class="lineNum">    1046 </span>            :         else {
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :             for ( j=start; j&lt;=end; ++j )</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :                 info-&gt;chars[j]-&gt;color = col;</span>
<span class="lineNum">    1049 </span>            :         }
<span class="lineNum">    1050 </span>            :     }
<a name="1051"><span class="lineNum">    1051 </span>            : }</a>
<span class="lineNum">    1052 </span>            : 
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 : static void pfed_readlookupnames(FILE *ttf,struct ttfinfo *info,uint32 base,</span>
<span class="lineNum">    1054 </span>            :         OTLookup *lookups) {
<span class="lineNum">    1055 </span>            :     OTLookup *otl;
<span class="lineNum">    1056 </span>            :     struct lookup_subtable *sub;
<span class="lineNum">    1057 </span>            :     AnchorClass *ac;
<span class="lineNum">    1058 </span>            :     int i, j, k, n, s, a;
<span class="lineNum">    1059 </span>            :     struct lstruct { int name_off, subs_off; } *ls, *ss, *as;
<span class="lineNum">    1060 </span>            : 
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :     if ( getushort(ttf)!=0 )</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 : return;                 /* Bad version number */</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :     n = getushort(ttf);</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :     ls = malloc(n*sizeof(struct lstruct));</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;n; ++i ) {</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :         ls[i].name_off = getushort(ttf);</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :         ls[i].subs_off = getushort(ttf);</span>
<span class="lineNum">    1069 </span>            :     }
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :     for ( i=0, otl=lookups; i&lt;n &amp;&amp; otl!=NULL; ++i, otl=otl-&gt;next ) {</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :         if ( ls[i].name_off!=0 ) {</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :             free( otl-&gt;lookup_name );</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :             otl-&gt;lookup_name = pfed_read_utf8(ttf,base+ls[i].name_off);</span>
<span class="lineNum">    1074 </span>            :         }
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :         if ( ls[i].subs_off!=0 ) {</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :             fseek(ttf,base+ls[i].subs_off,SEEK_SET);</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :             s = getushort(ttf);</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :             ss = malloc(s*sizeof(struct lstruct));</span>
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :             for ( j=0; j&lt;s; ++j ) {</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :                 ss[j].name_off = getushort(ttf);</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :                 ss[j].subs_off = getushort(ttf);</span>
<span class="lineNum">    1082 </span>            :             }
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :             for ( j=0, sub=otl-&gt;subtables; j&lt;s &amp;&amp; sub!=NULL; ++j, sub=sub-&gt;next ) {</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :                 if ( ss[j].name_off!=0 ) {</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :                     free( sub-&gt;subtable_name );</span>
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :                     sub-&gt;subtable_name = pfed_read_utf8(ttf,base+ss[j].name_off);</span>
<span class="lineNum">    1087 </span>            :                 }
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :                 if ( ss[j].subs_off!=0 ) {</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :                     if ( !sub-&gt;anchor_classes )</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :                         LogError(_(&quot;Whoops, attempt to name anchors in a subtable which doesn't contain any\n&quot;));</span>
<span class="lineNum">    1091 </span>            :                     else {
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :                         fseek(ttf,base+ss[j].subs_off,SEEK_SET);</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :                         a = getushort(ttf);</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :                         as = malloc(a*sizeof(struct lstruct));</span>
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :                         for ( k=0; k&lt;a; ++k ) {</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :                             as[k].name_off = getushort(ttf);</span>
<span class="lineNum">    1097 </span>            :                         }
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :                         k=0;</span>
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :                         for ( ac=info-&gt;ahead; ac!=NULL; ac=ac-&gt;next ) {</span>
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :                             if ( ac-&gt;subtable==sub ) {</span>
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :                                 if ( as[k].name_off!=0 ) {</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :                                     free( ac-&gt;name );</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :                                     ac-&gt;name = pfed_read_utf8(ttf,base+as[k].name_off);</span>
<span class="lineNum">    1104 </span>            :                                 }
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :                                 ++k;</span>
<span class="lineNum">    1106 </span>            :                             }
<span class="lineNum">    1107 </span>            :                         }
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :                         free(as);</span>
<span class="lineNum">    1109 </span>            :                     }
<span class="lineNum">    1110 </span>            :                 }
<span class="lineNum">    1111 </span>            :             }
<span class="lineNum">    1112 </span>            :             /* I guess it's ok for some subtables to be unnamed, so no check for sub!=NULL */
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :             if ( j&lt;s )</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :                 LogError(_(&quot;Whoops, more names than subtables of lookup %s\n&quot;), otl-&gt;lookup_name );</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :             free(ss);</span>
<span class="lineNum">    1116 </span>            :         }
<span class="lineNum">    1117 </span>            :     }
<span class="lineNum">    1118 </span>            :     /* I guess it's ok for some lookups to be unnamed, so no check for otf!=NULL */
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :     if ( i&lt;n )</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :         LogError(_(&quot;Whoops, more names than lookups\n&quot;) );</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :     free(ls);</span>
<a name="1122"><span class="lineNum">    1122 </span>            : }</a>
<span class="lineNum">    1123 </span>            : 
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 : static float pfed_get_coord(FILE *ttf,int mod) {</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :     if ( mod==V_B )</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 : return( (float) (signed char) getc(ttf) );</span>
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :     else if ( mod==V_S )</span>
<span class="lineNum">    1128 </span><span class="lineNoCov">          0 : return( (float) (short) getushort(ttf));</span>
<span class="lineNum">    1129 </span><span class="lineNoCov">          0 :     else if ( mod==V_F )</span>
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 : return( getlong(ttf)/256.0 );</span>
<span class="lineNum">    1131 </span>            :     else {
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :         LogError(_(&quot;Bad data type in contour verb in 'PfEd'\n&quot;));</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 : return( 0 );</span>
<span class="lineNum">    1134 </span>            :     }
<a name="1135"><span class="lineNum">    1135 </span>            : }</a>
<span class="lineNum">    1136 </span>            : 
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 : static void pfed_read_normal_contour(FILE *ttf,SplineSet *ss,</span>
<span class="lineNum">    1138 </span>            :         uint32 base, int type) {
<span class="lineNum">    1139 </span>            :     SplinePoint *sp, *current;
<span class="lineNum">    1140 </span>            :     int verb, v, m;
<span class="lineNum">    1141 </span>            :     float offx, offy, offx1, offy1, offx2, offy2;
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 :     int was_implicit=false;</span>
<span class="lineNum">    1143 </span>            : 
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    1145 </span>            : 
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :     verb = getc(ttf);</span>
<span class="lineNum">    1147 </span><span class="lineNoCov">          0 :     if ( COM_VERB(verb)!=V_MoveTo ) {</span>
<span class="lineNum">    1148 </span><span class="lineNoCov">          0 :         LogError(_(&quot;Whoops, contours must begin with a move to\n&quot;) );</span>
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :         ss-&gt;first = ss-&gt;last = SplinePointCreate(0,0);</span>
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 :         ss-&gt;start_offset = 0;</span>
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1152 </span>            :     }
<span class="lineNum">    1153 </span><span class="lineNoCov">          0 :     offx = pfed_get_coord(ttf,COM_MOD(verb));</span>
<span class="lineNum">    1154 </span><span class="lineNoCov">          0 :     offy = pfed_get_coord(ttf,COM_MOD(verb));</span>
<span class="lineNum">    1155 </span><span class="lineNoCov">          0 :     ss-&gt;first = current = SplinePointCreate(offx,offy);</span>
<span class="lineNum">    1156 </span><span class="lineNoCov">          0 :     ss-&gt;start_offset = 0;</span>
<span class="lineNum">    1157 </span>            :     for (;;) {
<span class="lineNum">    1158 </span><span class="lineNoCov">          0 :         verb = getc(ttf);</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :         v = COM_VERB(verb); m = COM_MOD(verb);</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :         if ( m==3 ) {</span>
<span class="lineNum">    1161 </span><span class="lineNoCov">          0 :             LogError(_(&quot;Bad data modifier in contour command in 'PfEd'\n&quot;) );</span>
<span class="lineNum">    1162 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    1163 </span>            :         }
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :         if ( verb==V_Close || verb==V_End )</span>
<span class="lineNum">    1165 </span>            :     break;
<span class="lineNum">    1166 </span><span class="lineNoCov">          0 :         else if ( v&gt;=V_LineTo &amp;&amp; v&lt;=V_VLineTo ) {</span>
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 :             offx = offy = 0;</span>
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :             if ( v==V_LineTo ) {</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :                 offx = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :                 offy = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :             } else if ( v==V_HLineTo )</span>
<span class="lineNum">    1172 </span><span class="lineNoCov">          0 :                 offx = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 :             else if ( v==V_VLineTo )</span>
<span class="lineNum">    1174 </span><span class="lineNoCov">          0 :                 offy = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :             sp = SplinePointCreate(current-&gt;me.x+offx,current-&gt;me.y+offy);</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :         } else if ( v&gt;=V_QCurveTo &amp;&amp; v&lt;=V_QVImplicit ) {</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :             int will_be_implicit = true;</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :             offx = offy = 0; offx1 = offy1 = 1; /* else implicit points become straight lines too soon */</span>
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :             if ( v==V_QCurveTo ) {</span>
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :                 offx = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :                 offy = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :                 offx1 = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :                 offy1 = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1184 </span><span class="lineNoCov">          0 :                 will_be_implicit = false;</span>
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 :             } else if ( v==V_QImplicit ) {</span>
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :                 offx = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :                 offy = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :             } else if ( v==V_QHImplicit ) {</span>
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :                 offx = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :             } else if ( v==V_QVImplicit ) {</span>
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :                 offy = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1192 </span>            :             }
<span class="lineNum">    1193 </span>            : 
<span class="lineNum">    1194 </span><span class="lineNoCov">          0 :             current-&gt;nextcp.x = current-&gt;me.x+offx;</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :             current-&gt;nextcp.y = current-&gt;me.y+offy;</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :             current-&gt;nonextcp = false;</span>
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :             sp = SplinePointCreate(current-&gt;nextcp.x+offx1,current-&gt;nextcp.y+offy1);</span>
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :             sp-&gt;prevcp = current-&gt;nextcp;</span>
<span class="lineNum">    1199 </span><span class="lineNoCov">          0 :             sp-&gt;noprevcp = false;</span>
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :             if ( was_implicit ) {</span>
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 :                 current-&gt;me.x = (current-&gt;prevcp.x + current-&gt;nextcp.x)/2;</span>
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :                 current-&gt;me.y = (current-&gt;prevcp.y + current-&gt;nextcp.y)/2;</span>
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :                 SplineRefigure(current-&gt;prev);</span>
<span class="lineNum">    1204 </span>            :             }
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 :             was_implicit = will_be_implicit;</span>
<span class="lineNum">    1206 </span><span class="lineNoCov">          0 :         } else if ( v&gt;=V_CurveTo &amp;&amp; v&lt;=V_HVCurveTo ) {</span>
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :             offx=offy=offx2=offy2=0;</span>
<span class="lineNum">    1208 </span><span class="lineNoCov">          0 :             if ( v==V_CurveTo ) {</span>
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :                 offx = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :                 offy = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1211 </span><span class="lineNoCov">          0 :                 offx1 = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :                 offy1 = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :                 offx2 = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :                 offy2 = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 :             } else if ( v==V_VHCurveTo ) {</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :                 offy = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :                 offx1 = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :                 offy1 = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :                 offx2 = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :             } else if ( v==V_HVCurveTo ) {</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :                 offx = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :                 offx1 = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :                 offy1 = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :                 offy2 = pfed_get_coord(ttf,m);</span>
<span class="lineNum">    1225 </span>            :             }
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :             current-&gt;nextcp.x = current-&gt;me.x+offx;</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :             current-&gt;nextcp.y = current-&gt;me.y+offy;</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :             current-&gt;nonextcp = false;</span>
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :             sp = SplinePointCreate(current-&gt;nextcp.x+offx1+offx2,current-&gt;nextcp.y+offy1+offy2);</span>
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :             sp-&gt;prevcp.x = current-&gt;nextcp.x+offx1;</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :             sp-&gt;prevcp.y = current-&gt;nextcp.y+offy1;</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :             sp-&gt;noprevcp = false;</span>
<span class="lineNum">    1233 </span>            :         } else {
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :             LogError(_(&quot;Whoops, unexpected verb in contour %d.%d\n&quot;), v, m );</span>
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    1236 </span>            :         }
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :         SplineMake(current,sp,type==2);</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :         current = sp;</span>
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :     if ( verb==V_Close ) {</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :         if ( was_implicit ) {</span>
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :             current-&gt;me.x = (current-&gt;prevcp.x + ss-&gt;first-&gt;nextcp.x)/2;</span>
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :             current-&gt;me.y = (current-&gt;prevcp.y + ss-&gt;first-&gt;nextcp.y)/2;</span>
<span class="lineNum">    1244 </span>            :         }
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 :         if ( current-&gt;me.x==ss-&gt;first-&gt;me.x &amp;&amp; current-&gt;me.y==ss-&gt;first-&gt;me.y ) {</span>
<span class="lineNum">    1246 </span><span class="lineNoCov">          0 :             current-&gt;prev-&gt;to = ss-&gt;first;</span>
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :             ss-&gt;first-&gt;prev = current-&gt;prev;</span>
<span class="lineNum">    1248 </span><span class="lineNoCov">          0 :             ss-&gt;first-&gt;prevcp = current-&gt;prevcp;</span>
<span class="lineNum">    1249 </span><span class="lineNoCov">          0 :             ss-&gt;first-&gt;noprevcp = current-&gt;noprevcp;</span>
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :             SplinePointFree(current);</span>
<span class="lineNum">    1251 </span>            :         } else
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :             SplineMake(current,ss-&gt;first,type==2);</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :         ss-&gt;last = ss-&gt;first;</span>
<span class="lineNum">    1254 </span>            :     } else {
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :         ss-&gt;last = current;</span>
<span class="lineNum">    1256 </span>            :     }
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 :     SPLCategorizePoints(ss);</span>
<a name="1258"><span class="lineNum">    1258 </span>            : }</a>
<span class="lineNum">    1259 </span>            : 
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 : static void pfed_read_spiro_contour(FILE *ttf,SplineSet *ss,</span>
<span class="lineNum">    1261 </span>            :         uint32 base, int type) {
<span class="lineNum">    1262 </span>            :     int i, ch;
<span class="lineNum">    1263 </span>            : 
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    1265 </span>            : 
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :     for ( i=0; ; ) {</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :         ch = getc(ttf);</span>
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :         if ( ch!=SPIRO_OPEN_CONTOUR &amp;&amp; ch!=SPIRO_CORNER &amp;&amp; ch!=SPIRO_G4 &amp;&amp;</span>
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 :                 ch!=SPIRO_G2 &amp;&amp; ch!=SPIRO_LEFT &amp;&amp; ch!=SPIRO_RIGHT &amp;&amp;</span>
<span class="lineNum">    1270 </span><span class="lineNoCov">          0 :                 ch!=SPIRO_END &amp;&amp; ch!=SPIRO_CLOSE_CONTOUR ) {</span>
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 :             LogError(_(&quot;Whoops, bad spiro command %d\n&quot;), ch);</span>
<span class="lineNum">    1272 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    1273 </span>            :         }
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :         if ( ss-&gt;spiro_cnt&gt;=ss-&gt;spiro_max )</span>
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :             ss-&gt;spiros = realloc(ss-&gt;spiros,(ss-&gt;spiro_max+=10)*sizeof(spiro_cp));</span>
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :         ss-&gt;spiros[ss-&gt;spiro_cnt].ty = ch;</span>
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :         if ( ch!=SPIRO_END ) {</span>
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :             ss-&gt;spiros[ss-&gt;spiro_cnt].x = getlong(ttf)/256.0;</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :             ss-&gt;spiros[ss-&gt;spiro_cnt].y = getlong(ttf)/256.0;</span>
<span class="lineNum">    1280 </span>            :         } else {
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :             ss-&gt;spiros[ss-&gt;spiro_cnt].x = 0;</span>
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 :             ss-&gt;spiros[ss-&gt;spiro_cnt].y = 0;</span>
<span class="lineNum">    1283 </span>            :         }
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :         ++(ss-&gt;spiro_cnt);</span>
<span class="lineNum">    1285 </span><span class="lineNoCov">          0 :         if ( ch==SPIRO_END || ch=='}' )</span>
<span class="lineNum">    1286 </span>            :     break;
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :     if ( ss-&gt;spiro_cnt!=0 &amp;&amp; ss-&gt;spiros[ss-&gt;spiro_cnt-1].ty!= SPIRO_END ) {</span>
<span class="lineNum">    1289 </span><span class="lineNoCov">          0 :         if ( ss-&gt;spiros[ss-&gt;spiro_cnt-1].ty==SPIRO_CLOSE_CONTOUR )</span>
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :             ss-&gt;spiros[ss-&gt;spiro_cnt-1].ty = SPIRO_G4;</span>
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :         if ( ss-&gt;spiro_cnt&gt;=ss-&gt;spiro_max )</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :             ss-&gt;spiros = realloc(ss-&gt;spiros,(ss-&gt;spiro_max+=2)*sizeof(spiro_cp));</span>
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :         ss-&gt;spiros[ss-&gt;spiro_cnt].ty = SPIRO_END;</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :         ss-&gt;spiros[ss-&gt;spiro_cnt].x = 0;</span>
<span class="lineNum">    1295 </span><span class="lineNoCov">          0 :         ss-&gt;spiros[ss-&gt;spiro_cnt].y = 0;</span>
<span class="lineNum">    1296 </span>            :     }
<a name="1297"><span class="lineNum">    1297 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1298 </span>            : 
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 : static void pfed_read_glyph_layer(FILE *ttf,struct ttfinfo *info,Layer *ly,</span>
<span class="lineNum">    1300 </span>            :         uint32 base, int type, int version) {
<span class="lineNum">    1301 </span>            :     int cc, ic, rc, i, j;
<span class="lineNum">    1302 </span>            :     SplineSet *ss;
<span class="lineNum">    1303 </span>            :     struct contours { int data_off, name_off; SplineSet *ss; } *contours;
<span class="lineNum">    1304 </span>            :     int gid;
<span class="lineNum">    1305 </span>            :     RefChar *last, *cur;
<span class="lineNum">    1306 </span>            : 
<span class="lineNum">    1307 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :     cc = getushort(ttf);                /* Contours */</span>
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :     rc = 0;</span>
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :     if ( version==1 )</span>
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :         rc = getushort(ttf);            /* References */</span>
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :     ic = getushort(ttf);                /* Images */</span>
<span class="lineNum">    1313 </span><span class="lineNoCov">          0 :     contours = malloc(cc*sizeof(struct contours));</span>
<span class="lineNum">    1314 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cc; ++i ) {</span>
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 :         contours[i].data_off = getushort(ttf);</span>
<span class="lineNum">    1316 </span><span class="lineNoCov">          0 :         contours[i].name_off = getushort(ttf);</span>
<span class="lineNum">    1317 </span>            :     }
<span class="lineNum">    1318 </span><span class="lineNoCov">          0 :     last = NULL;</span>
<span class="lineNum">    1319 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;rc; ++i ) {</span>
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :         cur = RefCharCreate();</span>
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;6; ++j )</span>
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :             cur-&gt;transform[j] = getlong(ttf)/32768.0;</span>
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 :         gid = getushort(ttf);</span>
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :         if ( gid&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :             LogError(_(&quot;Bad glyph reference in layer info.\n&quot;));</span>
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    1327 </span>            :         }
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :         cur-&gt;sc = info-&gt;chars[gid];</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :         cur-&gt;orig_pos = gid;</span>
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 :         cur-&gt;unicode_enc = cur-&gt;sc-&gt;unicodeenc;</span>
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :         if ( last==NULL )</span>
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :             ly-&gt;refs = cur;</span>
<span class="lineNum">    1333 </span>            :         else
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :             last-&gt;next = cur;</span>
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :         last = cur;</span>
<span class="lineNum">    1336 </span>            :     }
<span class="lineNum">    1337 </span>            : 
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :     ss = ly-&gt;splines;                        /* Only relevant for spiros where they live in someone else's layer */</span>
<span class="lineNum">    1339 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cc; ++i ) {</span>
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :         if ( type!=1 ) {                /* Not spiros */</span>
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :             contours[i].ss = chunkalloc(sizeof(SplineSet));</span>
<span class="lineNum">    1342 </span><span class="lineNoCov">          0 :             if ( i==0 )</span>
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :                 ly-&gt;splines = contours[i].ss;</span>
<span class="lineNum">    1344 </span>            :             else
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :                 contours[i-1].ss-&gt;next = contours[i].ss;</span>
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :             if ( contours[i].name_off!=0 )</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :                 contours[i].ss-&gt;contour_name = pfed_read_utf8(ttf,base+contours[i].name_off);</span>
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :             pfed_read_normal_contour(ttf,contours[i].ss,base+contours[i].data_off,type);</span>
<span class="lineNum">    1349 </span>            :         } else {                        /* Spiros are actually bound to an already existing layer and don't have an independent existance yet */
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :             contours[i].ss = ss;</span>
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :             if ( ss!=NULL ) {</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :                 pfed_read_spiro_contour(ttf,ss,base+contours[i].data_off,type);</span>
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :                 ss = ss-&gt;next;</span>
<span class="lineNum">    1354 </span>            :             } else
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :                 LogError(_(&quot;Whoops, Ran out of spiros\n&quot;));</span>
<span class="lineNum">    1356 </span>            :         }
<span class="lineNum">    1357 </span>            :     }
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :     free(contours);</span>
<a name="1359"><span class="lineNum">    1359 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1360 </span>            : 
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 : static void pfed_readguidelines(FILE *ttf,struct ttfinfo *info,uint32 base) {</span>
<span class="lineNum">    1362 </span>            :     int i,v,h,off;
<span class="lineNum">    1363 </span>            :     int version;
<span class="lineNum">    1364 </span>            :     SplinePoint *sp, *nsp;
<span class="lineNum">    1365 </span>            :     SplineSet *ss;
<span class="lineNum">    1366 </span>            : 
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    1368 </span><span class="lineNoCov">          0 :     version = getushort(ttf);</span>
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :     if ( version&gt;1 )</span>
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 : return;                 /* Bad version number */</span>
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :     v = getushort(ttf);</span>
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :     h = getushort(ttf);</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :     (void) getushort(ttf);</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :     off = getushort(ttf);</span>
<span class="lineNum">    1375 </span>            : 
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :     if ( off!=0 ) {</span>
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :         pfed_read_glyph_layer(ttf,info,&amp;info-&gt;guidelines,base+off,info-&gt;to_order2?2:3,version);</span>
<span class="lineNum">    1378 </span>            :     } else {
<span class="lineNum">    1379 </span>            :         struct npos { int pos; int offset; } *vs, *hs;
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :         vs = malloc(v*sizeof(struct npos));</span>
<span class="lineNum">    1381 </span><span class="lineNoCov">          0 :         hs = malloc(h*sizeof(struct npos));</span>
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;v; ++i ) {</span>
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :             vs[i].pos = (short) getushort(ttf);</span>
<span class="lineNum">    1384 </span><span class="lineNoCov">          0 :             vs[i].offset = getushort(ttf);</span>
<span class="lineNum">    1385 </span>            :         }
<span class="lineNum">    1386 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;h; ++i ) {</span>
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :             hs[i].pos = (short) getushort(ttf);</span>
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :             hs[i].offset = getushort(ttf);</span>
<span class="lineNum">    1389 </span>            :         }
<span class="lineNum">    1390 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;v; ++i ) {</span>
<span class="lineNum">    1391 </span><span class="lineNoCov">          0 :             sp = SplinePointCreate(vs[i].pos,-info-&gt;emsize);</span>
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :             nsp = SplinePointCreate(vs[i].pos,2*info-&gt;emsize);</span>
<span class="lineNum">    1393 </span><span class="lineNoCov">          0 :             SplineMake(sp,nsp,info-&gt;to_order2);</span>
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :             ss = chunkalloc(sizeof(SplineSet));</span>
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :             ss-&gt;first = sp; ss-&gt;last = nsp;</span>
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :             if ( vs[i].offset!=0 )</span>
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :                 ss-&gt;contour_name = pfed_read_utf8(ttf,base+vs[i].offset);</span>
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :             ss-&gt;next = info-&gt;guidelines.splines;</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :             info-&gt;guidelines.splines = ss;</span>
<span class="lineNum">    1400 </span>            :         }
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;h; ++i ) {</span>
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :             sp = SplinePointCreate(-info-&gt;emsize,hs[i].pos);</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :             nsp = SplinePointCreate(2*info-&gt;emsize,hs[i].pos);</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :             SplineMake(sp,nsp,info-&gt;to_order2);</span>
<span class="lineNum">    1405 </span><span class="lineNoCov">          0 :             ss = chunkalloc(sizeof(SplineSet));</span>
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 :             ss-&gt;first = sp; ss-&gt;last = nsp;</span>
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :             if ( hs[i].offset!=0 )</span>
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :                 ss-&gt;contour_name = pfed_read_utf8(ttf,base+hs[i].offset);</span>
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :             ss-&gt;next = info-&gt;guidelines.splines;</span>
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :             info-&gt;guidelines.splines = ss;</span>
<span class="lineNum">    1411 </span>            :         }
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :         SPLCategorizePoints(info-&gt;guidelines.splines);</span>
<span class="lineNum">    1413 </span><span class="lineNoCov">          0 :         free(vs); free(hs);</span>
<span class="lineNum">    1414 </span>            :     }
<a name="1415"><span class="lineNum">    1415 </span>            : }</a>
<span class="lineNum">    1416 </span>            : 
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 : static void pfed_redo_refs(SplineChar *sc,int layer) {</span>
<span class="lineNum">    1418 </span>            :     RefChar *refs;
<span class="lineNum">    1419 </span>            : 
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :     sc-&gt;ticked = true;</span>
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :     for ( refs=sc-&gt;layers[layer].refs; refs!=NULL; refs=refs-&gt;next ) {</span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :         if ( layer==1 &amp;&amp; refs-&gt;sc==NULL )    /* If main layer has spiros attached, then we'll get here. Any refs will come from the main ttf reading routines and won't be fixed up yet */</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :         if ( !refs-&gt;sc-&gt;ticked )</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :             pfed_redo_refs(refs-&gt;sc,layer);</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :         SCReinstanciateRefChar(sc,refs,layer);</span>
<span class="lineNum">    1427 </span>            :     }
<a name="1428"><span class="lineNum">    1428 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1429 </span>            : 
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 : static void pfed_read_layer(FILE *ttf,struct ttfinfo *info,int layer,int type, uint32 base,</span>
<span class="lineNum">    1431 </span>            :         uint32 start,int version) {
<span class="lineNum">    1432 </span><span class="lineNoCov">          0 :     uint32 *loca = calloc(info-&gt;glyph_cnt,sizeof(uint32));</span>
<span class="lineNum">    1433 </span>            :     int i,j;
<span class="lineNum">    1434 </span>            :     SplineChar *sc;
<span class="lineNum">    1435 </span>            :     int rcnt;
<span class="lineNum">    1436 </span>            :     struct range { int start, last; uint32 offset; } *ranges;
<span class="lineNum">    1437 </span>            : 
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :     fseek(ttf,start,SEEK_SET);</span>
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :     rcnt = getushort(ttf);</span>
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :     ranges = malloc(rcnt*sizeof(struct range));</span>
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;rcnt; ++i ) {</span>
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :         ranges[i].start  = getushort(ttf);</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :         ranges[i].last   = getushort(ttf);</span>
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :         ranges[i].offset = getlong(ttf);</span>
<span class="lineNum">    1445 </span>            :     }
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;rcnt; ++i ) {</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :         fseek(ttf,base+ranges[i].offset,SEEK_SET);</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :         for ( j=ranges[i].start; j&lt;=ranges[i].last; ++j )</span>
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :             loca[j] = getlong(ttf);</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :         for ( j=ranges[i].start; j&lt;=ranges[i].last; ++j ) {</span>
<span class="lineNum">    1451 </span>            :             Layer *ly;
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :             sc = info-&gt;chars[j];</span>
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :             ly = &amp;sc-&gt;layers[layer];</span>
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :             if ( loca[j]!=0 )</span>
<span class="lineNum">    1455 </span><span class="lineNoCov">          0 :                 pfed_read_glyph_layer(ttf,info,ly,base+loca[j],type,version);</span>
<span class="lineNum">    1456 </span>            :         }
<span class="lineNum">    1457 </span>            :     }
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :     free(ranges); free(loca);</span>
<span class="lineNum">    1459 </span>            : 
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;info-&gt;glyph_cnt; ++i ) if ( info-&gt;chars[i]!=NULL )</span>
<span class="lineNum">    1461 </span><span class="lineNoCov">          0 :         info-&gt;chars[i]-&gt;ticked = false;</span>
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;info-&gt;glyph_cnt; ++i ) if ( info-&gt;chars[i]!=NULL )</span>
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :         pfed_redo_refs(info-&gt;chars[i],layer);</span>
<a name="1464"><span class="lineNum">    1464 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1465 </span>            : 
<span class="lineNum">    1466 </span><span class="lineNoCov">          0 : static void pfed_readotherlayers(FILE *ttf,struct ttfinfo *info,uint32 base) {</span>
<span class="lineNum">    1467 </span>            :     int i, l, lcnt, spiro_index, gid;
<span class="lineNum">    1468 </span>            :     int version;
<span class="lineNum">    1469 </span>            :     struct layer_info { int type, name_off, data_off, sf_layer; char *name; } *layers;
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :     int non_spiro_cnt=0;</span>
<span class="lineNum">    1471 </span>            :     SplineChar *sc;
<span class="lineNum">    1472 </span>            : 
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    1474 </span><span class="lineNoCov">          0 :     version = getushort(ttf);</span>
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :     if ( version&gt;1 )</span>
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 : return;                 /* Bad version number */</span>
<span class="lineNum">    1477 </span><span class="lineNoCov">          0 :     lcnt = getushort(ttf);</span>
<span class="lineNum">    1478 </span><span class="lineNoCov">          0 :     layers = malloc(lcnt*sizeof(struct layer_info));</span>
<span class="lineNum">    1479 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;lcnt; ++i ) {</span>
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 :         layers[i].type     = getushort(ttf);</span>
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :         layers[i].name_off = getushort(ttf);</span>
<span class="lineNum">    1482 </span><span class="lineNoCov">          0 :         layers[i].data_off = getlong(ttf);</span>
<span class="lineNum">    1483 </span><span class="lineNoCov">          0 :         layers[i].sf_layer = -1;</span>
<span class="lineNum">    1484 </span>            :     }
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :     spiro_index = -1;</span>
<span class="lineNum">    1486 </span><span class="lineNoCov">          0 :     non_spiro_cnt = 0;</span>
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;lcnt; ++i ) {</span>
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :         if ( layers[i].name_off==0 )</span>
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :             layers[i].name = copy(&quot;Unnamed&quot;);</span>
<span class="lineNum">    1490 </span>            :         else {
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :             layers[i].name = pfed_read_utf8(ttf,base+layers[i].name_off);</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :             if ( layers[i].type==1 &amp;&amp; strcmp(layers[i].name,&quot;Spiro&quot;)==0 )</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :                 spiro_index = i;</span>
<span class="lineNum">    1494 </span>            :         }
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :         if ( layers[i].type==2 || layers[i].type==3 || layers[i].type==0x102 || layers[i].type==0x103 )</span>
<span class="lineNum">    1496 </span><span class="lineNoCov">          0 :             ++non_spiro_cnt;</span>
<span class="lineNum">    1497 </span>            :     }
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :     if ( spiro_index==-1 ) {</span>
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;lcnt; ++i )</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :             if ( layers[i].type==1 ) {</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :                 spiro_index=i;</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1503 </span>            :             }
<span class="lineNum">    1504 </span>            :     }
<span class="lineNum">    1505 </span>            : 
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :     if ( non_spiro_cnt!=0 ) {</span>
<span class="lineNum">    1507 </span><span class="lineNoCov">          0 :         info-&gt;layer_cnt = non_spiro_cnt+1;</span>
<span class="lineNum">    1508 </span><span class="lineNoCov">          0 :         info-&gt;layers = calloc(info-&gt;layer_cnt+1,sizeof(LayerInfo));</span>
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 :         info-&gt;layers[ly_back].background = true;</span>
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :         info-&gt;layers[ly_fore].order2 = info-&gt;to_order2;</span>
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 :         info-&gt;layers[ly_fore].background = false;</span>
<span class="lineNum">    1512 </span><span class="lineNoCov">          0 :         l = i = 0;</span>
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :         if ( (layers[i].type&amp;0xff)==1 )</span>
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :             ++i;</span>
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :         if ( layers[i].type&amp;0x100 ) {</span>
<span class="lineNum">    1516 </span>            :             /* first layer output is foreground, so it can't replace the background layer */
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :             ++info-&gt;layer_cnt;</span>
<span class="lineNum">    1518 </span><span class="lineNoCov">          0 :             l = 2;</span>
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :             info-&gt;layers[ly_back].order2 = info-&gt;to_order2;</span>
<span class="lineNum">    1520 </span>            :         }
<span class="lineNum">    1521 </span><span class="lineNoCov">          0 :         for ( ; i&lt;lcnt; ++i ) if ( (layers[i].type&amp;0xff)==2 || (layers[i].type&amp;0xff)==3 ) {</span>
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :             info-&gt;layers[l].name   = layers[i].name;</span>
<span class="lineNum">    1523 </span><span class="lineNoCov">          0 :             layers[i].name = NULL;</span>
<span class="lineNum">    1524 </span><span class="lineNoCov">          0 :             layers[i].sf_layer = l;</span>
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :             info-&gt;layers[l].order2 = (layers[i].type&amp;0xff)==2;</span>
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :             info-&gt;layers[l].background = (layers[i].type&amp;0x100)?0:1;</span>
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :             if ( l==0 ) l=2; else ++l;</span>
<span class="lineNum">    1528 </span>            :         }
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :         if ( info-&gt;layer_cnt!=2 ) {</span>
<span class="lineNum">    1530 </span><span class="lineNoCov">          0 :             for ( gid = 0; gid&lt;info-&gt;glyph_cnt; ++gid ) if ((sc=info-&gt;chars[gid])!=NULL ) {</span>
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 :                 sc-&gt;layers = realloc(sc-&gt;layers,info-&gt;layer_cnt*sizeof(Layer));</span>
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :                 memset(sc-&gt;layers+2,0,(info-&gt;layer_cnt-2)*sizeof(Layer));</span>
<span class="lineNum">    1533 </span><span class="lineNoCov">          0 :                 sc-&gt;layer_cnt = info-&gt;layer_cnt;</span>
<span class="lineNum">    1534 </span>            :             }
<span class="lineNum">    1535 </span>            :         }
<span class="lineNum">    1536 </span>            :     }
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :     if ( spiro_index!=-1 )</span>
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :         pfed_read_layer(ttf,info,ly_fore,layers[spiro_index].type,base,base+layers[spiro_index].data_off,version);</span>
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;lcnt; ++i ) if ( layers[i].sf_layer!=-1 ) {</span>
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :         pfed_read_layer(ttf,info,layers[i].sf_layer,layers[i].type&amp;0xff,</span>
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 :                 base,base+layers[i].data_off,version);</span>
<span class="lineNum">    1542 </span>            :     }
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;lcnt; ++i )</span>
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :         free( layers[i].name );</span>
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :     free( layers );</span>
<a name="1546"><span class="lineNum">    1546 </span>            : }</a>
<span class="lineNum">    1547 </span>            : 
<span class="lineNum">    1548 </span><span class="lineNoCov">          0 : void pfed_read(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    1549 </span>            :     int n,i;
<span class="lineNum">    1550 </span>            :     struct tagoff { uint32 tag, offset; } tagoff[MAX_SUBTABLE_TYPES+30];
<span class="lineNum">    1551 </span>            : 
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :     fseek(ttf,info-&gt;pfed_start,SEEK_SET);</span>
<span class="lineNum">    1553 </span>            : 
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 :     if ( getlong(ttf)!=0x00010000 )</span>
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1556 </span><span class="lineNoCov">          0 :     n = getlong(ttf);</span>
<span class="lineNum">    1557 </span><span class="lineNoCov">          0 :     if ( n&gt;=MAX_SUBTABLE_TYPES+30 )</span>
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :         n = MAX_SUBTABLE_TYPES+30;</span>
<span class="lineNum">    1559 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;n; ++i ) {</span>
<span class="lineNum">    1560 </span><span class="lineNoCov">          0 :         tagoff[i].tag = getlong(ttf);</span>
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :         tagoff[i].offset = getlong(ttf);</span>
<span class="lineNum">    1562 </span>            :     }
<span class="lineNum">    1563 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;n; ++i ) switch ( tagoff[i].tag ) {</span>
<span class="lineNum">    1564 </span>            :       case fcmt_TAG: case flog_TAG:
<span class="lineNum">    1565 </span><span class="lineNoCov">          0 :         pfed_readfontcomment(ttf,info,info-&gt;pfed_start+tagoff[i].offset, tagoff[i].tag);</span>
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1567 </span>            :       case cvtc_TAG:
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :         pfed_readcvtcomments(ttf,info,info-&gt;pfed_start+tagoff[i].offset);</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1570 </span>            :       case cmnt_TAG:
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :         pfed_readglyphcomments(ttf,info,info-&gt;pfed_start+tagoff[i].offset);</span>
<span class="lineNum">    1572 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1573 </span>            :       case colr_TAG:
<span class="lineNum">    1574 </span><span class="lineNoCov">          0 :         pfed_readcolours(ttf,info,info-&gt;pfed_start+tagoff[i].offset);</span>
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1576 </span>            :       case GPOS_TAG:
<span class="lineNum">    1577 </span><span class="lineNoCov">          0 :         pfed_readlookupnames(ttf,info,info-&gt;pfed_start+tagoff[i].offset,info-&gt;gpos_lookups);</span>
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1579 </span>            :       case GSUB_TAG:
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :         pfed_readlookupnames(ttf,info,info-&gt;pfed_start+tagoff[i].offset,info-&gt;gsub_lookups);</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1582 </span>            :       case layr_TAG:
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :         pfed_readotherlayers(ttf,info,info-&gt;pfed_start+tagoff[i].offset);</span>
<span class="lineNum">    1584 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1585 </span>            :       case guid_TAG:
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :         pfed_readguidelines(ttf,info,info-&gt;pfed_start+tagoff[i].offset);</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1588 </span>            :       default:
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Unknown subtable '%c%c%c%c' in 'PfEd' table, ignored\n&quot;),</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :                 tagoff[i].tag&gt;&gt;24, (tagoff[i].tag&gt;&gt;16)&amp;0xff, (tagoff[i].tag&gt;&gt;8)&amp;0xff, tagoff[i].tag&amp;0xff );</span>
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1592 </span>            :     }
<span class="lineNum">    1593 </span>            : }
<span class="lineNum">    1594 </span>            : 
<span class="lineNum">    1595 </span>            : /* 'TeX ' table format is as follows...                          */
<span class="lineNum">    1596 </span>            : /* uint32  version number 0x00010000                             */
<span class="lineNum">    1597 </span>            : /* uint32  subtable count                                        */
<span class="lineNum">    1598 </span>            : /* struct { uint32 tab, offset } tag/offset for first subtable   */
<span class="lineNum">    1599 </span>            : /* struct { uint32 tab, offset } tag/offset for second subtable  */
<span class="lineNum">    1600 </span>            : /* ...                                                           */
<span class="lineNum">    1601 </span>            : 
<span class="lineNum">    1602 </span>            : /* 'TeX ' 'ftpm' font parameter subtable format                  */
<span class="lineNum">    1603 </span>            : /*  short version number 0                                       */
<span class="lineNum">    1604 </span>            : /*  parameter count                                              */
<span class="lineNum">    1605 </span>            : /*  array of { 4chr tag, value }                                 */
<span class="lineNum">    1606 </span>            : 
<span class="lineNum">    1607 </span>            : /* 'TeX ' 'htdp' per-glyph height/depth subtable format          */
<span class="lineNum">    1608 </span>            : /*  short  version number 0                                      */
<span class="lineNum">    1609 </span>            : /*  short  glyph-count                                           */
<span class="lineNum">    1610 </span>            : /*  array[glyph-count] of { int16 height,depth }                 */
<span class="lineNum">    1611 </span>            : 
<span class="lineNum">    1612 </span>            : /* 'TeX ' 'itlc' per-glyph italic correction subtable            */
<span class="lineNum">    1613 </span>            : /*  short  version number 0                                      */
<span class="lineNum">    1614 </span>            : /*  short  glyph-count                                           */
<span class="lineNum">    1615 </span>            : /*  array[glyph-count] of int16 italic_correction                */
<span class="lineNum">    1616 </span>            : 
<span class="lineNum">    1617 </span>            : /* !!!!!!!!!!! OBSOLETE !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! */
<span class="lineNum">    1618 </span>            : /* 'TeX ' 'sbsp' per-glyph sub/super script positioning subtable */
<span class="lineNum">    1619 </span>            : /*  short  version number 0                                      */
<span class="lineNum">    1620 </span>            : /*  short  glyph-count                                           */
<span class="lineNum">    1621 </span>            : /*  array[glyph-count] of { int16 sub,super }                    */
<span class="lineNum">    1622 </span>            : 
<span class="lineNum">    1623 </span>            : #undef MAX_SUBTABLE_TYPES
<span class="lineNum">    1624 </span>            : #define MAX_SUBTABLE_TYPES      4
<span class="lineNum">    1625 </span>            : 
<span class="lineNum">    1626 </span>            : struct TeX_subtabs {
<span class="lineNum">    1627 </span>            :     int next;
<span class="lineNum">    1628 </span>            :     struct {
<span class="lineNum">    1629 </span>            :         FILE *data;
<span class="lineNum">    1630 </span>            :         uint32 tag;
<span class="lineNum">    1631 </span>            :         uint32 offset;
<span class="lineNum">    1632 </span>            :     } subtabs[MAX_SUBTABLE_TYPES];
<span class="lineNum">    1633 </span>            : };
<span class="lineNum">    1634 </span>            : 
<span class="lineNum">    1635 </span>            : static uint32 tex_text_params[] = {
<span class="lineNum">    1636 </span>            :     TeX_Slant,
<span class="lineNum">    1637 </span>            :     TeX_Space,
<span class="lineNum">    1638 </span>            :     TeX_Stretch,
<span class="lineNum">    1639 </span>            :     TeX_Shrink,
<span class="lineNum">    1640 </span>            :     TeX_XHeight,
<span class="lineNum">    1641 </span>            :     TeX_Quad,
<span class="lineNum">    1642 </span>            :     TeX_ExtraSp,
<span class="lineNum">    1643 </span>            :     0
<span class="lineNum">    1644 </span>            : };
<span class="lineNum">    1645 </span>            : static uint32 tex_math_params[] = {
<span class="lineNum">    1646 </span>            :     TeX_Slant,
<span class="lineNum">    1647 </span>            :     TeX_Space,
<span class="lineNum">    1648 </span>            :     TeX_Stretch,
<span class="lineNum">    1649 </span>            :     TeX_Shrink,
<span class="lineNum">    1650 </span>            :     TeX_XHeight,
<span class="lineNum">    1651 </span>            :     TeX_Quad,
<span class="lineNum">    1652 </span>            :     TeX_MathSp,
<span class="lineNum">    1653 </span>            :     TeX_Num1,
<span class="lineNum">    1654 </span>            :     TeX_Num2,
<span class="lineNum">    1655 </span>            :     TeX_Num3,
<span class="lineNum">    1656 </span>            :     TeX_Denom1,
<span class="lineNum">    1657 </span>            :     TeX_Denom2,
<span class="lineNum">    1658 </span>            :     TeX_Sup1,
<span class="lineNum">    1659 </span>            :     TeX_Sup2,
<span class="lineNum">    1660 </span>            :     TeX_Sup3,
<span class="lineNum">    1661 </span>            :     TeX_Sub1,
<span class="lineNum">    1662 </span>            :     TeX_Sub2,
<span class="lineNum">    1663 </span>            :     TeX_SupDrop,
<span class="lineNum">    1664 </span>            :     TeX_SubDrop,
<span class="lineNum">    1665 </span>            :     TeX_Delim1,
<span class="lineNum">    1666 </span>            :     TeX_Delim2,
<span class="lineNum">    1667 </span>            :     TeX_AxisHeight,
<span class="lineNum">    1668 </span>            :     0};
<span class="lineNum">    1669 </span>            : static uint32 tex_mathext_params[] = {
<span class="lineNum">    1670 </span>            :     TeX_Slant,
<span class="lineNum">    1671 </span>            :     TeX_Space,
<span class="lineNum">    1672 </span>            :     TeX_Stretch,
<span class="lineNum">    1673 </span>            :     TeX_Shrink,
<span class="lineNum">    1674 </span>            :     TeX_XHeight,
<span class="lineNum">    1675 </span>            :     TeX_Quad,
<span class="lineNum">    1676 </span>            :     TeX_MathSp,
<span class="lineNum">    1677 </span>            :     TeX_DefRuleThick,
<span class="lineNum">    1678 </span>            :     TeX_BigOpSpace1,
<span class="lineNum">    1679 </span>            :     TeX_BigOpSpace2,
<span class="lineNum">    1680 </span>            :     TeX_BigOpSpace3,
<span class="lineNum">    1681 </span>            :     TeX_BigOpSpace4,
<span class="lineNum">    1682 </span>            :     TeX_BigOpSpace5,
<span class="lineNum">    1683 </span>            :     0};
<span class="lineNum">    1684 </span>            : 
<span class="lineNum">    1685 </span>            : /* ************************************************************************** */
<span class="lineNum">    1686 </span>            : /* *************************    The 'TeX ' table    ************************* */
<span class="lineNum">    1687 </span>            : /* *************************         Output         ************************* */
<a name="1688"><span class="lineNum">    1688 </span>            : /* ************************************************************************** */</a>
<span class="lineNum">    1689 </span>            : 
<span class="lineNum">    1690 </span><span class="lineNoCov">          0 : static void TeX_dumpFontParams(SplineFont *sf, struct TeX_subtabs *tex, struct alltabs *at ) {</span>
<span class="lineNum">    1691 </span>            :     FILE *fprm;
<span class="lineNum">    1692 </span>            :     int i,pcnt;
<span class="lineNum">    1693 </span>            :     uint32 *tags;
<span class="lineNum">    1694 </span>            : 
<span class="lineNum">    1695 </span><span class="lineNoCov">          0 :     if ( sf-&gt;texdata.type==tex_unset )</span>
<span class="lineNum">    1696 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1697 </span><span class="lineNoCov">          0 :     tex-&gt;subtabs[tex-&gt;next].tag = CHR('f','t','p','m');</span>
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :     tex-&gt;subtabs[tex-&gt;next++].data = fprm = tmpfile();</span>
<span class="lineNum">    1699 </span>            : 
<span class="lineNum">    1700 </span><span class="lineNoCov">          0 :     putshort(fprm,0);                   /* sub-table version number */</span>
<span class="lineNum">    1701 </span><span class="lineNoCov">          0 :     pcnt = sf-&gt;texdata.type==tex_math ? 22 : sf-&gt;texdata.type==tex_mathext ? 13 : 7;</span>
<span class="lineNum">    1702 </span><span class="lineNoCov">          0 :     tags = sf-&gt;texdata.type==tex_math ? tex_math_params :</span>
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :             sf-&gt;texdata.type==tex_mathext ? tex_mathext_params :</span>
<span class="lineNum">    1704 </span>            :                                             tex_text_params;
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 :     putshort(fprm,pcnt);</span>
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;pcnt; ++i ) {</span>
<span class="lineNum">    1707 </span><span class="lineNoCov">          0 :         putlong(fprm,tags[i]);</span>
<span class="lineNum">    1708 </span><span class="lineNoCov">          0 :         putlong(fprm,sf-&gt;texdata.params[i]);</span>
<span class="lineNum">    1709 </span>            :     }
<span class="lineNum">    1710 </span>            :     /* always aligned */
<a name="1711"><span class="lineNum">    1711 </span>            : }</a>
<span class="lineNum">    1712 </span>            : 
<span class="lineNum">    1713 </span><span class="lineNoCov">          0 : static void TeX_dumpHeightDepth(SplineFont *sf, struct TeX_subtabs *tex, struct alltabs *at ) {</span>
<span class="lineNum">    1714 </span>            :     FILE *htdp;
<span class="lineNum">    1715 </span>            :     int i,j,k,last_g, gid;
<span class="lineNum">    1716 </span>            :     DBounds b;
<span class="lineNum">    1717 </span>            : 
<span class="lineNum">    1718 </span><span class="lineNoCov">          0 :     for ( i=at-&gt;gi.gcnt-1; i&gt;=0; --i ) {</span>
<span class="lineNum">    1719 </span><span class="lineNoCov">          0 :         gid = at-&gt;gi.bygid[i];</span>
<span class="lineNum">    1720 </span><span class="lineNoCov">          0 :         if ( gid!=-1 &amp;&amp; sf-&gt;glyphs[gid]!=NULL &amp;&amp;</span>
<span class="lineNum">    1721 </span><span class="lineNoCov">          0 :                 (sf-&gt;glyphs[gid]-&gt;tex_height!=TEX_UNDEF || sf-&gt;glyphs[gid]-&gt;tex_depth!=TEX_UNDEF))</span>
<span class="lineNum">    1722 </span>            :     break;
<span class="lineNum">    1723 </span>            :     }
<span class="lineNum">    1724 </span><span class="lineNoCov">          0 :     if ( i&lt;0 )               /* No height/depth info */</span>
<span class="lineNum">    1725 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1726 </span>            : 
<span class="lineNum">    1727 </span><span class="lineNoCov">          0 :     tex-&gt;subtabs[tex-&gt;next].tag = CHR('h','t','d','p');</span>
<span class="lineNum">    1728 </span><span class="lineNoCov">          0 :     tex-&gt;subtabs[tex-&gt;next++].data = htdp = tmpfile();</span>
<span class="lineNum">    1729 </span>            : 
<span class="lineNum">    1730 </span><span class="lineNoCov">          0 :     putshort(htdp,0);                           /* sub-table version number */</span>
<span class="lineNum">    1731 </span><span class="lineNoCov">          0 :     putshort(htdp,sf-&gt;glyphs[gid]-&gt;ttf_glyph+1);/* data for this many glyphs */</span>
<span class="lineNum">    1732 </span>            : 
<span class="lineNum">    1733 </span><span class="lineNoCov">          0 :     last_g = -1;</span>
<span class="lineNum">    1734 </span><span class="lineNoCov">          0 :     for ( j=0; j&lt;=i; ++j ) {</span>
<span class="lineNum">    1735 </span><span class="lineNoCov">          0 :         gid = at-&gt;gi.bygid[j];</span>
<span class="lineNum">    1736 </span><span class="lineNoCov">          0 :         if ( gid!=-1 &amp;&amp; sf-&gt;glyphs[gid]!=NULL ) {</span>
<span class="lineNum">    1737 </span><span class="lineNoCov">          0 :             SplineChar *sc = sf-&gt;glyphs[gid];</span>
<span class="lineNum">    1738 </span><span class="lineNoCov">          0 :             for ( k=last_g+1; k&lt;sc-&gt;ttf_glyph; ++k ) {</span>
<span class="lineNum">    1739 </span><span class="lineNoCov">          0 :                 putshort(htdp,0);</span>
<span class="lineNum">    1740 </span><span class="lineNoCov">          0 :                 putshort(htdp,0);</span>
<span class="lineNum">    1741 </span>            :             }
<span class="lineNum">    1742 </span><span class="lineNoCov">          0 :             if ( sc-&gt;tex_depth==TEX_UNDEF || sc-&gt;tex_height==TEX_UNDEF )</span>
<span class="lineNum">    1743 </span><span class="lineNoCov">          0 :                 SplineCharFindBounds(sc,&amp;b);</span>
<span class="lineNum">    1744 </span><span class="lineNoCov">          0 :             putshort( htdp, sc-&gt;tex_height==TEX_UNDEF ? b.maxy : sc-&gt;tex_height );</span>
<span class="lineNum">    1745 </span><span class="lineNoCov">          0 :             putshort( htdp, sc-&gt;tex_depth==TEX_UNDEF ? -b.miny : sc-&gt;tex_depth );</span>
<span class="lineNum">    1746 </span><span class="lineNoCov">          0 :             last_g = sc-&gt;ttf_glyph;</span>
<span class="lineNum">    1747 </span>            :         }
<span class="lineNum">    1748 </span>            :     }
<span class="lineNum">    1749 </span>            :     /* always aligned */
<a name="1750"><span class="lineNum">    1750 </span>            : }</a>
<span class="lineNum">    1751 </span>            : 
<span class="lineNum">    1752 </span><span class="lineNoCov">          0 : static void TeX_dumpItalicCorr(SplineFont *sf, struct TeX_subtabs *tex, struct alltabs *at ) {</span>
<span class="lineNum">    1753 </span>            :     FILE *itlc;
<span class="lineNum">    1754 </span>            :     int i,j,k,last_g, gid;
<span class="lineNum">    1755 </span>            : 
<span class="lineNum">    1756 </span><span class="lineNoCov">          0 :     for ( i=at-&gt;gi.gcnt-1; i&gt;=0; --i ) {</span>
<span class="lineNum">    1757 </span><span class="lineNoCov">          0 :         gid = at-&gt;gi.bygid[i];</span>
<span class="lineNum">    1758 </span><span class="lineNoCov">          0 :         if ( gid!=-1 &amp;&amp; sf-&gt;glyphs[gid]!=NULL &amp;&amp;</span>
<span class="lineNum">    1759 </span><span class="lineNoCov">          0 :                 sf-&gt;glyphs[gid]-&gt;italic_correction!=TEX_UNDEF )</span>
<span class="lineNum">    1760 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    1761 </span>            :     }
<span class="lineNum">    1762 </span><span class="lineNoCov">          0 :     if ( i&lt;0 )               /* No italic_correction info */</span>
<span class="lineNum">    1763 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1764 </span>            : 
<span class="lineNum">    1765 </span><span class="lineNoCov">          0 :     tex-&gt;subtabs[tex-&gt;next].tag = CHR('i','t','l','c');</span>
<span class="lineNum">    1766 </span><span class="lineNoCov">          0 :     tex-&gt;subtabs[tex-&gt;next++].data = itlc = tmpfile();</span>
<span class="lineNum">    1767 </span>            : 
<span class="lineNum">    1768 </span><span class="lineNoCov">          0 :     putshort(itlc,0);                           /* sub-table version number */</span>
<span class="lineNum">    1769 </span><span class="lineNoCov">          0 :     putshort(itlc,sf-&gt;glyphs[gid]-&gt;ttf_glyph+1);/* data for this many glyphs */</span>
<span class="lineNum">    1770 </span>            : 
<span class="lineNum">    1771 </span><span class="lineNoCov">          0 :     last_g = -1;</span>
<span class="lineNum">    1772 </span><span class="lineNoCov">          0 :     for ( j=0; j&lt;=i; ++j ) {</span>
<span class="lineNum">    1773 </span><span class="lineNoCov">          0 :         gid = at-&gt;gi.bygid[j];</span>
<span class="lineNum">    1774 </span><span class="lineNoCov">          0 :         if ( gid!=-1 &amp;&amp; sf-&gt;glyphs[gid]!=NULL ) {</span>
<span class="lineNum">    1775 </span><span class="lineNoCov">          0 :             SplineChar *sc = sf-&gt;glyphs[gid];</span>
<span class="lineNum">    1776 </span><span class="lineNoCov">          0 :             for ( k=last_g+1; k&lt;sc-&gt;ttf_glyph; ++k ) {</span>
<span class="lineNum">    1777 </span><span class="lineNoCov">          0 :                 putshort(itlc,0);</span>
<span class="lineNum">    1778 </span><span class="lineNoCov">          0 :                 putshort(itlc,0);</span>
<span class="lineNum">    1779 </span>            :             }
<span class="lineNum">    1780 </span><span class="lineNoCov">          0 :             putshort( itlc, sc-&gt;italic_correction!=TEX_UNDEF ? sc-&gt;italic_correction :</span>
<span class="lineNum">    1781 </span>            :                                     0 );
<span class="lineNum">    1782 </span><span class="lineNoCov">          0 :             last_g = sc-&gt;ttf_glyph;</span>
<span class="lineNum">    1783 </span>            :         }
<span class="lineNum">    1784 </span>            :     }
<span class="lineNum">    1785 </span>            :     /* always aligned */
<a name="1786"><span class="lineNum">    1786 </span>            : }</a>
<span class="lineNum">    1787 </span>            : 
<span class="lineNum">    1788 </span><span class="lineCov">         27 : void tex_dump(struct alltabs *at, SplineFont *sf) {</span>
<span class="lineNum">    1789 </span>            :     struct TeX_subtabs tex;
<span class="lineNum">    1790 </span>            :     FILE *file;
<span class="lineNum">    1791 </span>            :     int i;
<span class="lineNum">    1792 </span>            :     uint32 offset;
<span class="lineNum">    1793 </span>            : 
<span class="lineNum">    1794 </span><span class="lineCov">         27 :     if ( !(at-&gt;gi.flags &amp; ttf_flag_TeXtable ))</span>
<span class="lineNum">    1795 </span><span class="lineCov">         54 : return;</span>
<span class="lineNum">    1796 </span>            : 
<span class="lineNum">    1797 </span><span class="lineNoCov">          0 :     memset(&amp;tex,0,sizeof(tex));</span>
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 :     TeX_dumpFontParams(sf,&amp;tex,at);</span>
<span class="lineNum">    1799 </span><span class="lineNoCov">          0 :     TeX_dumpHeightDepth(sf,&amp;tex,at);</span>
<span class="lineNum">    1800 </span><span class="lineNoCov">          0 :     TeX_dumpItalicCorr(sf,&amp;tex,at);</span>
<span class="lineNum">    1801 </span>            : 
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :     if ( tex.next==0 )</span>
<span class="lineNum">    1803 </span><span class="lineNoCov">          0 : return;         /* No subtables */</span>
<span class="lineNum">    1804 </span>            : 
<span class="lineNum">    1805 </span><span class="lineNoCov">          0 :     at-&gt;tex = file = tmpfile();</span>
<span class="lineNum">    1806 </span><span class="lineNoCov">          0 :     putlong(file, 0x00010000);          /* Version number */</span>
<span class="lineNum">    1807 </span><span class="lineNoCov">          0 :     putlong(file, tex.next);            /* sub-table count */</span>
<span class="lineNum">    1808 </span><span class="lineNoCov">          0 :     offset = 2*sizeof(uint32) + 2*tex.next*sizeof(uint32);</span>
<span class="lineNum">    1809 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;tex.next; ++i ) {</span>
<span class="lineNum">    1810 </span><span class="lineNoCov">          0 :         putlong(file,tex.subtabs[i].tag);</span>
<span class="lineNum">    1811 </span><span class="lineNoCov">          0 :         putlong(file,offset);</span>
<span class="lineNum">    1812 </span><span class="lineNoCov">          0 :         fseek(tex.subtabs[i].data,0,SEEK_END);</span>
<span class="lineNum">    1813 </span><span class="lineNoCov">          0 :         tex.subtabs[i].offset = offset;</span>
<span class="lineNum">    1814 </span><span class="lineNoCov">          0 :         offset += ftell(tex.subtabs[i].data);</span>
<span class="lineNum">    1815 </span>            :     }
<span class="lineNum">    1816 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;tex.next; ++i ) {</span>
<span class="lineNum">    1817 </span><span class="lineNoCov">          0 :         fseek(tex.subtabs[i].data,0,SEEK_SET);</span>
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :         ttfcopyfile(file,tex.subtabs[i].data,tex.subtabs[i].offset,&quot;TeX-subtable&quot;);</span>
<span class="lineNum">    1819 </span>            :     }
<span class="lineNum">    1820 </span><span class="lineNoCov">          0 :     if ( ftell(file)&amp;2 )</span>
<span class="lineNum">    1821 </span><span class="lineNoCov">          0 :         putshort(file,0);</span>
<span class="lineNum">    1822 </span><span class="lineNoCov">          0 :     if ( ftell(file)&amp;3 )</span>
<span class="lineNum">    1823 </span><span class="lineNoCov">          0 :         IError(&quot;'TeX ' table not properly aligned&quot;);</span>
<span class="lineNum">    1824 </span><span class="lineNoCov">          0 :     at-&gt;texlen = ftell(file);</span>
<span class="lineNum">    1825 </span>            : }
<span class="lineNum">    1826 </span>            : 
<span class="lineNum">    1827 </span>            : /* *************************    The 'TeX ' table    ************************* */
<a name="1828"><span class="lineNum">    1828 </span>            : /* *************************          Input         ************************* */</a>
<span class="lineNum">    1829 </span>            : 
<span class="lineNum">    1830 </span><span class="lineNoCov">          0 : static void TeX_readFontParams(FILE *ttf,struct ttfinfo *info,uint32 base) {</span>
<span class="lineNum">    1831 </span>            :     int i,pcnt;
<span class="lineNum">    1832 </span>            :     static uint32 *alltags[] = { tex_text_params, tex_math_params, tex_mathext_params };
<span class="lineNum">    1833 </span>            :     int j,k;
<span class="lineNum">    1834 </span>            :     uint32 tag;
<span class="lineNum">    1835 </span>            :     int32 val;
<span class="lineNum">    1836 </span>            : 
<span class="lineNum">    1837 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    1838 </span><span class="lineNoCov">          0 :     if ( getushort(ttf)!=0 )    /* Don't know how to read this version of the subtable */</span>
<span class="lineNum">    1839 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1840 </span><span class="lineNoCov">          0 :     pcnt = getushort(ttf);</span>
<span class="lineNum">    1841 </span><span class="lineNoCov">          0 :     if ( pcnt==22 ) info-&gt;texdata.type = tex_math;</span>
<span class="lineNum">    1842 </span><span class="lineNoCov">          0 :     else if ( pcnt==13 ) info-&gt;texdata.type = tex_mathext;</span>
<span class="lineNum">    1843 </span><span class="lineNoCov">          0 :     else if ( pcnt&gt;=7 ) info-&gt;texdata.type = tex_text;</span>
<span class="lineNum">    1844 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;pcnt; ++i ) {</span>
<span class="lineNum">    1845 </span><span class="lineNoCov">          0 :         tag = getlong(ttf);</span>
<span class="lineNum">    1846 </span><span class="lineNoCov">          0 :         val = getlong(ttf);</span>
<span class="lineNum">    1847 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;3; ++j ) {</span>
<span class="lineNum">    1848 </span><span class="lineNoCov">          0 :             for ( k=0; alltags[j][k]!=0; ++k )</span>
<span class="lineNum">    1849 </span><span class="lineNoCov">          0 :                 if ( alltags[j][k]==tag )</span>
<span class="lineNum">    1850 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1851 </span><span class="lineNoCov">          0 :             if ( alltags[j][k]==tag )</span>
<span class="lineNum">    1852 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1853 </span>            :         }
<span class="lineNum">    1854 </span><span class="lineNoCov">          0 :         if ( j&lt;3 )</span>
<span class="lineNum">    1855 </span><span class="lineNoCov">          0 :             info-&gt;texdata.params[k] = val;</span>
<span class="lineNum">    1856 </span>            :     }
<a name="1857"><span class="lineNum">    1857 </span>            : }</a>
<span class="lineNum">    1858 </span>            : 
<span class="lineNum">    1859 </span><span class="lineNoCov">          0 : static void TeX_readHeightDepth(FILE *ttf,struct ttfinfo *info,uint32 base) {</span>
<span class="lineNum">    1860 </span>            :     int i,gcnt;
<span class="lineNum">    1861 </span>            : 
<span class="lineNum">    1862 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    1863 </span><span class="lineNoCov">          0 :     if ( getushort(ttf)!=0 )    /* Don't know how to read this version of the subtable */</span>
<span class="lineNum">    1864 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1865 </span><span class="lineNoCov">          0 :     gcnt = getushort(ttf);</span>
<span class="lineNum">    1866 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;gcnt &amp;&amp; i&lt;info-&gt;glyph_cnt; ++i ) {</span>
<span class="lineNum">    1867 </span>            :         int h, d;
<span class="lineNum">    1868 </span><span class="lineNoCov">          0 :         h = getushort(ttf);</span>
<span class="lineNum">    1869 </span><span class="lineNoCov">          0 :         d = getushort(ttf);</span>
<span class="lineNum">    1870 </span><span class="lineNoCov">          0 :         if ( info-&gt;chars[i]!=NULL ) {</span>
<span class="lineNum">    1871 </span><span class="lineNoCov">          0 :             info-&gt;chars[i]-&gt;tex_height = h;</span>
<span class="lineNum">    1872 </span><span class="lineNoCov">          0 :             info-&gt;chars[i]-&gt;tex_depth = d;</span>
<span class="lineNum">    1873 </span>            :         }
<span class="lineNum">    1874 </span>            :     }
<a name="1875"><span class="lineNum">    1875 </span>            : }</a>
<span class="lineNum">    1876 </span>            : 
<span class="lineNum">    1877 </span><span class="lineNoCov">          0 : static void TeX_readItalicCorr(FILE *ttf,struct ttfinfo *info,uint32 base) {</span>
<span class="lineNum">    1878 </span>            :     int i,gcnt;
<span class="lineNum">    1879 </span>            : 
<span class="lineNum">    1880 </span><span class="lineNoCov">          0 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    1881 </span><span class="lineNoCov">          0 :     if ( getushort(ttf)!=0 )    /* Don't know how to read this version of the subtable */</span>
<span class="lineNum">    1882 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1883 </span><span class="lineNoCov">          0 :     gcnt = getushort(ttf);</span>
<span class="lineNum">    1884 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;gcnt &amp;&amp; i&lt;info-&gt;glyph_cnt; ++i ) {</span>
<span class="lineNum">    1885 </span>            :         int ital;
<span class="lineNum">    1886 </span><span class="lineNoCov">          0 :         ital = getushort(ttf);</span>
<span class="lineNum">    1887 </span><span class="lineNoCov">          0 :         if ( info-&gt;chars[i]!=NULL ) {</span>
<span class="lineNum">    1888 </span><span class="lineNoCov">          0 :             info-&gt;chars[i]-&gt;italic_correction = ital;</span>
<span class="lineNum">    1889 </span>            :         }
<span class="lineNum">    1890 </span>            :     }
<a name="1891"><span class="lineNum">    1891 </span>            : }</a>
<span class="lineNum">    1892 </span>            : 
<span class="lineNum">    1893 </span><span class="lineNoCov">          0 : void tex_read(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    1894 </span>            :     int n,i;
<span class="lineNum">    1895 </span>            :     struct tagoff { uint32 tag, offset; } tagoff[MAX_SUBTABLE_TYPES+30];
<span class="lineNum">    1896 </span>            : 
<span class="lineNum">    1897 </span><span class="lineNoCov">          0 :     fseek(ttf,info-&gt;tex_start,SEEK_SET);</span>
<span class="lineNum">    1898 </span>            : 
<span class="lineNum">    1899 </span><span class="lineNoCov">          0 :     if ( getlong(ttf)!=0x00010000 )</span>
<span class="lineNum">    1900 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1901 </span><span class="lineNoCov">          0 :     n = getlong(ttf);</span>
<span class="lineNum">    1902 </span><span class="lineNoCov">          0 :     if ( n&gt;=MAX_SUBTABLE_TYPES+30 )</span>
<span class="lineNum">    1903 </span><span class="lineNoCov">          0 :         n = MAX_SUBTABLE_TYPES+30;</span>
<span class="lineNum">    1904 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;n; ++i ) {</span>
<span class="lineNum">    1905 </span><span class="lineNoCov">          0 :         tagoff[i].tag = getlong(ttf);</span>
<span class="lineNum">    1906 </span><span class="lineNoCov">          0 :         tagoff[i].offset = getlong(ttf);</span>
<span class="lineNum">    1907 </span>            :     }
<span class="lineNum">    1908 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;n; ++i ) switch ( tagoff[i].tag ) {</span>
<span class="lineNum">    1909 </span>            :       case CHR('f','t','p','m'):
<span class="lineNum">    1910 </span><span class="lineNoCov">          0 :         TeX_readFontParams(ttf,info,info-&gt;tex_start+tagoff[i].offset);</span>
<span class="lineNum">    1911 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1912 </span>            :       case CHR('h','t','d','p'):
<span class="lineNum">    1913 </span><span class="lineNoCov">          0 :         TeX_readHeightDepth(ttf,info,info-&gt;tex_start+tagoff[i].offset);</span>
<span class="lineNum">    1914 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1915 </span>            :       case CHR('i','t','l','c'):
<span class="lineNum">    1916 </span><span class="lineNoCov">          0 :         TeX_readItalicCorr(ttf,info,info-&gt;tex_start+tagoff[i].offset);</span>
<span class="lineNum">    1917 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1918 </span>            :       default:
<span class="lineNum">    1919 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Unknown subtable '%c%c%c%c' in 'TeX ' table, ignored\n&quot;),</span>
<span class="lineNum">    1920 </span><span class="lineNoCov">          0 :                 tagoff[i].tag&gt;&gt;24, (tagoff[i].tag&gt;&gt;16)&amp;0xff, (tagoff[i].tag&gt;&gt;8)&amp;0xff, tagoff[i].tag&amp;0xff );</span>
<span class="lineNum">    1921 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1922 </span>            :     }
<span class="lineNum">    1923 </span>            : }
<span class="lineNum">    1924 </span>            : 
<span class="lineNum">    1925 </span>            : /* ************************************************************************** */
<span class="lineNum">    1926 </span>            : /* *************************    The 'BDF ' table    ************************* */
<span class="lineNum">    1927 </span>            : /* *************************         Output         ************************* */
<span class="lineNum">    1928 </span>            : /* ************************************************************************** */
<span class="lineNum">    1929 </span>            : 
<span class="lineNum">    1930 </span>            : /* the BDF table is used to store BDF properties so that we can do round trip */
<span class="lineNum">    1931 </span>            : /* conversion from BDF-&gt;otb-&gt;BDF without losing anything. */
<span class="lineNum">    1932 </span>            : /* Format:
<span class="lineNum">    1933 </span>            :         USHORT  version         : 'BDF' table version number, must be 0x0001
<span class="lineNum">    1934 </span>            :         USHORT  strikeCount     : number of strikes in table
<span class="lineNum">    1935 </span>            :         ULONG   stringTable     : offset (from start of BDF table) to string table
<span class="lineNum">    1936 </span>            : 
<span class="lineNum">    1937 </span>            : followed by an array of 'strikeCount' descriptors that look like:
<span class="lineNum">    1938 </span>            :         USHORT  ppem            : vertical pixels-per-EM for this strike
<span class="lineNum">    1939 </span>            :         USHORT  num_items       : number of items (properties and atoms), max is 255
<span class="lineNum">    1940 </span>            : 
<span class="lineNum">    1941 </span>            : this array is followed by 'strikeCount' value sets. Each &quot;value set&quot; is
<span class="lineNum">    1942 </span>            : an array of (num_items) items that look like:
<span class="lineNum">    1943 </span>            :         ULONG   item_name       : offset in string table to item name
<span class="lineNum">    1944 </span>            :         USHORT  item_type       : item type: 0 =&gt; non-property string (e.g. COMMENT)
<span class="lineNum">    1945 </span>            :                                              1 =&gt; non-property atom (e.g. FONT)
<span class="lineNum">    1946 </span>            :                                              2 =&gt; non-property int32
<span class="lineNum">    1947 </span>            :                                              3 =&gt; non-property uint32
<span class="lineNum">    1948 </span>            :                                           0x10 =&gt; flag for a property, ored
<span class="lineNum">    1949 </span>            :                                                   with above value types)
<span class="lineNum">    1950 </span>            :         ULONG   item_value      : item value.
<span class="lineNum">    1951 </span>            :                                 strings  =&gt; an offset into the string table
<span class="lineNum">    1952 </span>            :                                           to the corresponding string,
<span class="lineNum">    1953 </span>            :                                           without the surrending double-quotes
<span class="lineNum">    1954 </span>            : 
<span class="lineNum">    1955 </span>            :                                 atoms    =&gt; an offset into the string table
<span class="lineNum">    1956 </span>            : 
<span class="lineNum">    1957 </span>            :                                 integers =&gt; the corresponding 32-bit value
<span class="lineNum">    1958 </span>            : Then the string table of null terminated strings. These strings should be in
<span class="lineNum">    1959 </span>            : ASCII.
<span class="lineNum">    1960 </span>            : */
<span class="lineNum">    1961 </span>            : 
<span class="lineNum">    1962 </span>            : /* Internally FF stores BDF comments as one psuedo property per line. As you */
<span class="lineNum">    1963 </span>            : /*  might expect. But FreeType merges them into one large lump with newlines */
<span class="lineNum">    1964 </span>            : /*  between lines. Which means that BDF tables created by FreeType will be in*/
<span class="lineNum">    1965 </span>            : /*  that format. So we might as well be compatible. We will pack &amp; unpack    */
<a name="1966"><span class="lineNum">    1966 </span>            : /*  comment lines */</a>
<span class="lineNum">    1967 </span>            : 
<span class="lineNum">    1968 </span><span class="lineCov">          1 : static int BDFPropCntMergedComments(BDFFont *bdf) {</span>
<span class="lineNum">    1969 </span>            :     int i, cnt;
<span class="lineNum">    1970 </span>            : 
<span class="lineNum">    1971 </span><span class="lineCov">          1 :     cnt = 0;</span>
<span class="lineNum">    1972 </span><span class="lineCov">          4 :     for ( i=0; i&lt;bdf-&gt;prop_cnt; ++i ) {</span>
<span class="lineNum">    1973 </span><span class="lineCov">          4 :         ++cnt;</span>
<span class="lineNum">    1974 </span><span class="lineCov">          4 :         if ( strmatch(bdf-&gt;props[i].name,&quot;COMMENT&quot;)==0 )</span>
<span class="lineNum">    1975 </span><span class="lineCov">          1 :     break;</span>
<span class="lineNum">    1976 </span>            :     }
<span class="lineNum">    1977 </span><span class="lineCov">         35 :     for ( ; i&lt;bdf-&gt;prop_cnt; ++i ) {</span>
<span class="lineNum">    1978 </span><span class="lineCov">         34 :         if ( strmatch(bdf-&gt;props[i].name,&quot;COMMENT&quot;)==0 )</span>
<span class="lineNum">    1979 </span><span class="lineCov">          2 :     continue;</span>
<span class="lineNum">    1980 </span><span class="lineCov">         32 :         ++cnt;</span>
<span class="lineNum">    1981 </span>            :     }
<span class="lineNum">    1982 </span><span class="lineCov">          1 : return( cnt );</span>
<a name="1983"><span class="lineNum">    1983 </span>            : }</a>
<span class="lineNum">    1984 </span>            : 
<span class="lineNum">    1985 </span><span class="lineCov">          1 : static char *MergeComments(BDFFont *bdf) {</span>
<span class="lineNum">    1986 </span>            :     int len, i;
<span class="lineNum">    1987 </span>            :     char *str;
<span class="lineNum">    1988 </span>            : 
<span class="lineNum">    1989 </span><span class="lineCov">          1 :     len = 0;</span>
<span class="lineNum">    1990 </span><span class="lineCov">         38 :     for ( i=0; i&lt;bdf-&gt;prop_cnt; ++i ) {</span>
<span class="lineNum">    1991 </span><span class="lineCov">         39 :         if ( strmatch(bdf-&gt;props[i].name,&quot;COMMENT&quot;)==0 &amp;&amp;</span>
<span class="lineNum">    1992 </span><span class="lineCov">          2 :                 ((bdf-&gt;props[i].type &amp; ~prt_property)==prt_string ||</span>
<span class="lineNum">    1993 </span><span class="lineNoCov">          0 :                  (bdf-&gt;props[i].type &amp; ~prt_property)==prt_atom ))</span>
<span class="lineNum">    1994 </span><span class="lineCov">          2 :             len += strlen( bdf-&gt;props[i].u.atom ) + 1;</span>
<span class="lineNum">    1995 </span>            :     }
<span class="lineNum">    1996 </span><span class="lineCov">          1 :     if ( len==0 )</span>
<span class="lineNum">    1997 </span><span class="lineNoCov">          0 : return( copy( &quot;&quot; ));</span>
<span class="lineNum">    1998 </span>            : 
<span class="lineNum">    1999 </span><span class="lineCov">          1 :     str = malloc( len+1 );</span>
<span class="lineNum">    2000 </span><span class="lineCov">          1 :     len = 0;</span>
<span class="lineNum">    2001 </span><span class="lineCov">         38 :     for ( i=0; i&lt;bdf-&gt;prop_cnt; ++i ) {</span>
<span class="lineNum">    2002 </span><span class="lineCov">         39 :         if ( strmatch(bdf-&gt;props[i].name,&quot;COMMENT&quot;)==0 &amp;&amp;</span>
<span class="lineNum">    2003 </span><span class="lineCov">          2 :                 ((bdf-&gt;props[i].type &amp; ~prt_property)==prt_string ||</span>
<span class="lineNum">    2004 </span><span class="lineNoCov">          0 :                  (bdf-&gt;props[i].type &amp; ~prt_property)==prt_atom )) {</span>
<span class="lineNum">    2005 </span><span class="lineCov">          2 :             strcpy(str+len,bdf-&gt;props[i].u.atom );</span>
<span class="lineNum">    2006 </span><span class="lineCov">          2 :             len += strlen( bdf-&gt;props[i].u.atom ) + 1;</span>
<span class="lineNum">    2007 </span><span class="lineCov">          2 :             str[len-1] = '\n';</span>
<span class="lineNum">    2008 </span>            :         }
<span class="lineNum">    2009 </span>            :     }
<span class="lineNum">    2010 </span><span class="lineCov">          1 :     str[len-1] = '\0';</span>
<span class="lineNum">    2011 </span><span class="lineCov">          1 : return( str );</span>
<span class="lineNum">    2012 </span>            : }
<span class="lineNum">    2013 </span>            : 
<a name="2014"><span class="lineNum">    2014 </span>            : #define AMAX    50</a>
<span class="lineNum">    2015 </span>            : 
<span class="lineNum">    2016 </span><span class="lineCov">         13 : int ttf_bdf_dump(SplineFont *sf,struct alltabs *at,int32 *sizes) {</span>
<span class="lineNum">    2017 </span>            :     FILE *strings;
<span class="lineNum">    2018 </span>            :     struct atomoff { char *name; int pos; } atomoff[AMAX];
<span class="lineNum">    2019 </span><span class="lineCov">         13 :     int acnt=0;</span>
<span class="lineNum">    2020 </span><span class="lineCov">         13 :     int spcnt = 0;</span>
<span class="lineNum">    2021 </span>            :     int i,j,k;
<span class="lineNum">    2022 </span>            :     BDFFont *bdf;
<span class="lineNum">    2023 </span>            :     long pos;
<span class="lineNum">    2024 </span>            : 
<span class="lineNum">    2025 </span><span class="lineCov">         61 :     for ( i=0; sizes[i]!=0; ++i ) {</span>
<span class="lineNum">    2026 </span><span class="lineCov">         48 :         for ( bdf=sf-&gt;bitmaps; bdf!=NULL &amp;&amp; (bdf-&gt;pixelsize!=(sizes[i]&amp;0xffff) || BDFDepth(bdf)!=(sizes[i]&gt;&gt;16)); bdf=bdf-&gt;next );</span>
<span class="lineNum">    2027 </span><span class="lineCov">         48 :         if ( bdf!=NULL &amp;&amp; bdf-&gt;prop_cnt!=0 )</span>
<span class="lineNum">    2028 </span><span class="lineCov">          1 :             ++spcnt;</span>
<span class="lineNum">    2029 </span>            :     }
<span class="lineNum">    2030 </span><span class="lineCov">         13 :     if ( spcnt==0 )     /* No strikes with properties */</span>
<span class="lineNum">    2031 </span><span class="lineCov">         12 : return(true);</span>
<span class="lineNum">    2032 </span>            : 
<span class="lineNum">    2033 </span><span class="lineCov">          1 :     at-&gt;bdf = tmpfile();</span>
<span class="lineNum">    2034 </span><span class="lineCov">          1 :     strings = tmpfile();</span>
<span class="lineNum">    2035 </span>            : 
<span class="lineNum">    2036 </span><span class="lineCov">          1 :     putshort(at-&gt;bdf,0x0001);</span>
<span class="lineNum">    2037 </span><span class="lineCov">          1 :     putshort(at-&gt;bdf,spcnt);</span>
<span class="lineNum">    2038 </span><span class="lineCov">          1 :     putlong(at-&gt;bdf,0);              /* offset to string table */</span>
<span class="lineNum">    2039 </span>            : 
<span class="lineNum">    2040 </span><span class="lineCov">          2 :     for ( i=0; sizes[i]!=0; ++i ) {</span>
<span class="lineNum">    2041 </span><span class="lineCov">          1 :         for ( bdf=sf-&gt;bitmaps; bdf!=NULL &amp;&amp; (bdf-&gt;pixelsize!=(sizes[i]&amp;0xffff) || BDFDepth(bdf)!=(sizes[i]&gt;&gt;16)); bdf=bdf-&gt;next );</span>
<span class="lineNum">    2042 </span><span class="lineCov">          1 :         if ( bdf!=NULL &amp;&amp; bdf-&gt;prop_cnt!=0 ) {</span>
<span class="lineNum">    2043 </span><span class="lineCov">          1 :             putshort(at-&gt;bdf,bdf-&gt;pixelsize);</span>
<span class="lineNum">    2044 </span><span class="lineCov">          1 :             putshort(at-&gt;bdf,BDFPropCntMergedComments(bdf));</span>
<span class="lineNum">    2045 </span>            :         }
<span class="lineNum">    2046 </span>            :     }
<span class="lineNum">    2047 </span>            : 
<span class="lineNum">    2048 </span><span class="lineCov">          2 :     for ( i=0; sizes[i]!=0; ++i ) {</span>
<span class="lineNum">    2049 </span><span class="lineCov">          1 :         for ( bdf=sf-&gt;bitmaps; bdf!=NULL &amp;&amp; (bdf-&gt;pixelsize!=(sizes[i]&amp;0xffff) || BDFDepth(bdf)!=(sizes[i]&gt;&gt;16)); bdf=bdf-&gt;next );</span>
<span class="lineNum">    2050 </span><span class="lineCov">          1 :         if ( bdf!=NULL &amp;&amp; bdf-&gt;prop_cnt!=0 ) {</span>
<span class="lineNum">    2051 </span><span class="lineCov">          1 :             int saw_comment=0;</span>
<span class="lineNum">    2052 </span>            :             char *str;
<span class="lineNum">    2053 </span><span class="lineCov">         38 :             for ( j=0; j&lt;bdf-&gt;prop_cnt; ++j ) {</span>
<span class="lineNum">    2054 </span><span class="lineCov">         37 :                 if ( strmatch(bdf-&gt;props[j].name,&quot;COMMENT&quot;)==0 &amp;&amp; saw_comment )</span>
<span class="lineNum">    2055 </span><span class="lineCov">          1 :             continue;</span>
<span class="lineNum">    2056 </span>            :                 /* Try to reuse keyword names in string space */
<span class="lineNum">    2057 </span><span class="lineCov">        666 :                 for ( k=0 ; k&lt;acnt; ++k ) {</span>
<span class="lineNum">    2058 </span><span class="lineCov">        630 :                     if ( strcmp(atomoff[k].name,bdf-&gt;props[j].name)==0 )</span>
<span class="lineNum">    2059 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2060 </span>            :                 }
<span class="lineNum">    2061 </span><span class="lineCov">         36 :                 if ( k&gt;=acnt &amp;&amp; k&lt;AMAX ) {</span>
<span class="lineNum">    2062 </span><span class="lineCov">         36 :                     atomoff[k].name = bdf-&gt;props[j].name;</span>
<span class="lineNum">    2063 </span><span class="lineCov">         36 :                     atomoff[k].pos = ftell(strings);</span>
<span class="lineNum">    2064 </span><span class="lineCov">         36 :                     ++acnt;</span>
<span class="lineNum">    2065 </span><span class="lineCov">         36 :                     fwrite(atomoff[k].name,1,strlen(atomoff[k].name)+1,strings);</span>
<span class="lineNum">    2066 </span>            :                 }
<span class="lineNum">    2067 </span><span class="lineCov">         36 :                 if ( k&lt;acnt )</span>
<span class="lineNum">    2068 </span><span class="lineCov">         36 :                     putlong(at-&gt;bdf,atomoff[k].pos);</span>
<span class="lineNum">    2069 </span>            :                 else {
<span class="lineNum">    2070 </span><span class="lineNoCov">          0 :                     putlong(at-&gt;bdf,ftell(strings));</span>
<span class="lineNum">    2071 </span><span class="lineNoCov">          0 :                     fwrite(bdf-&gt;props[j].name,1,strlen(bdf-&gt;props[j].name)+1,strings);</span>
<span class="lineNum">    2072 </span>            :                 }
<span class="lineNum">    2073 </span><span class="lineCov">         36 :                 str = bdf-&gt;props[j].u.str;</span>
<span class="lineNum">    2074 </span><span class="lineCov">         36 :                 if ( strmatch(bdf-&gt;props[j].name,&quot;COMMENT&quot;)==0 ) {</span>
<span class="lineNum">    2075 </span><span class="lineCov">          1 :                     str = MergeComments(bdf);</span>
<span class="lineNum">    2076 </span><span class="lineCov">          1 :                     saw_comment = true;</span>
<span class="lineNum">    2077 </span>            :                 }
<span class="lineNum">    2078 </span><span class="lineCov">         36 :                 putshort(at-&gt;bdf,bdf-&gt;props[j].type);</span>
<span class="lineNum">    2079 </span><span class="lineCov">         56 :                 if ( (bdf-&gt;props[j].type &amp; ~prt_property)==prt_string ||</span>
<span class="lineNum">    2080 </span><span class="lineCov">         20 :                         (bdf-&gt;props[j].type &amp; ~prt_property)==prt_atom ) {</span>
<span class="lineNum">    2081 </span><span class="lineCov">         19 :                     putlong(at-&gt;bdf,ftell(strings));</span>
<span class="lineNum">    2082 </span><span class="lineCov">         19 :                     fwrite(str,1,strlen(str)+1,strings);</span>
<span class="lineNum">    2083 </span><span class="lineCov">         38 :                     if ( str!=bdf-&gt;props[j].u.str )</span>
<span class="lineNum">    2084 </span><span class="lineCov">          1 :                         free(str);</span>
<span class="lineNum">    2085 </span>            :                 } else {
<span class="lineNum">    2086 </span><span class="lineCov">         17 :                     putlong(at-&gt;bdf,bdf-&gt;props[j].u.val);</span>
<span class="lineNum">    2087 </span>            :                 }
<span class="lineNum">    2088 </span>            :             }
<span class="lineNum">    2089 </span>            :         }
<span class="lineNum">    2090 </span>            :     }
<span class="lineNum">    2091 </span>            : 
<span class="lineNum">    2092 </span><span class="lineCov">          1 :     pos = ftell(at-&gt;bdf);</span>
<span class="lineNum">    2093 </span><span class="lineCov">          1 :     fseek(at-&gt;bdf,4,SEEK_SET);</span>
<span class="lineNum">    2094 </span><span class="lineCov">          1 :     putlong(at-&gt;bdf,pos);</span>
<span class="lineNum">    2095 </span><span class="lineCov">          1 :     fseek(at-&gt;bdf,0,SEEK_END);</span>
<span class="lineNum">    2096 </span>            : 
<span class="lineNum">    2097 </span><span class="lineCov">          1 :     if ( !ttfcopyfile(at-&gt;bdf,strings,pos,&quot;BDF string table&quot;))</span>
<span class="lineNum">    2098 </span><span class="lineNoCov">          0 : return( false );</span>
<span class="lineNum">    2099 </span>            : 
<span class="lineNum">    2100 </span><span class="lineCov">          1 :     at-&gt;bdflen = ftell( at-&gt;bdf );</span>
<span class="lineNum">    2101 </span>            : 
<span class="lineNum">    2102 </span>            :     /* Align table */
<span class="lineNum">    2103 </span><span class="lineCov">          1 :     if ( at-&gt;bdflen&amp;1 )</span>
<span class="lineNum">    2104 </span><span class="lineCov">          1 :         putc('\0',at-&gt;bdf);</span>
<span class="lineNum">    2105 </span><span class="lineCov">          1 :     if ( (at-&gt;bdflen+1)&amp;2 )</span>
<span class="lineNum">    2106 </span><span class="lineCov">          1 :         putshort(at-&gt;bdf,0);</span>
<span class="lineNum">    2107 </span>            : 
<span class="lineNum">    2108 </span><span class="lineCov">          1 : return( true );</span>
<span class="lineNum">    2109 </span>            : }
<span class="lineNum">    2110 </span>            : 
<span class="lineNum">    2111 </span>            : /* *************************    The 'BDF ' table    ************************* */
<a name="2112"><span class="lineNum">    2112 </span>            : /* *************************          Input         ************************* */</a>
<span class="lineNum">    2113 </span>            : 
<span class="lineNum">    2114 </span><span class="lineNoCov">          0 : static char *getstring(FILE *ttf,long start) {</span>
<span class="lineNum">    2115 </span><span class="lineNoCov">          0 :     long here = ftell(ttf);</span>
<span class="lineNum">    2116 </span>            :     int len, ch;
<span class="lineNum">    2117 </span>            :     char *str, *pt;
<span class="lineNum">    2118 </span>            : 
<span class="lineNum">    2119 </span><span class="lineNoCov">          0 :     if ( here&lt;0 ) return( NULL );</span>
<span class="lineNum">    2120 </span><span class="lineNoCov">          0 :     fseek(ttf,start,SEEK_SET);</span>
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 :     for ( len=1; (ch=getc(ttf))&gt;0 ; ++len );</span>
<span class="lineNum">    2122 </span><span class="lineNoCov">          0 :     fseek(ttf,start,SEEK_SET);</span>
<span class="lineNum">    2123 </span><span class="lineNoCov">          0 :     pt = str = malloc(len);</span>
<span class="lineNum">    2124 </span><span class="lineNoCov">          0 :     while ( (ch=getc(ttf))&gt;0 )</span>
<span class="lineNum">    2125 </span><span class="lineNoCov">          0 :         *pt++ = ch;</span>
<span class="lineNum">    2126 </span><span class="lineNoCov">          0 :     *pt = '\0';</span>
<span class="lineNum">    2127 </span><span class="lineNoCov">          0 :     fseek(ttf,here,SEEK_SET);</span>
<span class="lineNum">    2128 </span><span class="lineNoCov">          0 : return( str );</span>
<span class="lineNum">    2129 </span>            : }
<a name="2130"><span class="lineNum">    2130 </span>            : </a>
<span class="lineNum">    2131 </span>            : /* COMMENTS get stored all in one lump by freetype. De-lump them */
<span class="lineNum">    2132 </span><span class="lineNoCov">          0 : static int CheckForNewlines(BDFFont *bdf,int k) {</span>
<span class="lineNum">    2133 </span>            :     char *pt, *start;
<span class="lineNum">    2134 </span>            :     int cnt, i;
<span class="lineNum">    2135 </span>            : 
<span class="lineNum">    2136 </span><span class="lineNoCov">          0 :     for ( cnt=0, pt = bdf-&gt;props[k].u.atom; *pt; ++pt )</span>
<span class="lineNum">    2137 </span><span class="lineNoCov">          0 :         if ( *pt=='\n' )</span>
<span class="lineNum">    2138 </span><span class="lineNoCov">          0 :             ++cnt;</span>
<span class="lineNum">    2139 </span><span class="lineNoCov">          0 :     if ( cnt==0 )</span>
<span class="lineNum">    2140 </span><span class="lineNoCov">          0 : return( k );</span>
<span class="lineNum">    2141 </span>            : 
<span class="lineNum">    2142 </span><span class="lineNoCov">          0 :     bdf-&gt;prop_cnt += cnt;</span>
<span class="lineNum">    2143 </span><span class="lineNoCov">          0 :     bdf-&gt;props = realloc(bdf-&gt;props, bdf-&gt;prop_cnt*sizeof( BDFProperties ));</span>
<span class="lineNum">    2144 </span>            : 
<span class="lineNum">    2145 </span><span class="lineNoCov">          0 :     pt = strchr(bdf-&gt;props[k].u.atom,'\n');</span>
<span class="lineNum">    2146 </span><span class="lineNoCov">          0 :     *pt = '\0'; ++pt;</span>
<span class="lineNum">    2147 </span><span class="lineNoCov">          0 :     for ( i=1; i&lt;=cnt; ++i ) {</span>
<span class="lineNum">    2148 </span><span class="lineNoCov">          0 :         start = pt;</span>
<span class="lineNum">    2149 </span><span class="lineNoCov">          0 :         while ( *pt!='\n' &amp;&amp; *pt!='\0' ) ++pt;</span>
<span class="lineNum">    2150 </span><span class="lineNoCov">          0 :         bdf-&gt;props[k+i].name = copy(bdf-&gt;props[k].name);</span>
<span class="lineNum">    2151 </span><span class="lineNoCov">          0 :         bdf-&gt;props[k+i].type = bdf-&gt;props[k].type;</span>
<span class="lineNum">    2152 </span><span class="lineNoCov">          0 :         bdf-&gt;props[k+i].u.atom = copyn(start,pt-start);</span>
<span class="lineNum">    2153 </span><span class="lineNoCov">          0 :         if ( *pt=='\n' ) ++pt;</span>
<span class="lineNum">    2154 </span>            :     }
<span class="lineNum">    2155 </span><span class="lineNoCov">          0 :     pt = copy( bdf-&gt;props[k].u.atom );</span>
<span class="lineNum">    2156 </span><span class="lineNoCov">          0 :     free( bdf-&gt;props[k].u.atom );</span>
<span class="lineNum">    2157 </span><span class="lineNoCov">          0 :     bdf-&gt;props[k].u.atom = pt;</span>
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 : return( k+cnt );</span>
<a name="2159"><span class="lineNum">    2159 </span>            : }</a>
<span class="lineNum">    2160 </span>            : 
<span class="lineNum">    2161 </span><span class="lineCov">          5 : void ttf_bdf_read(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    2162 </span>            :     int strike_cnt, i,j,k;
<span class="lineNum">    2163 </span>            :     long string_start;
<span class="lineNum">    2164 </span>            :     struct bdfinfo { BDFFont *bdf; int cnt; } *bdfinfo;
<span class="lineNum">    2165 </span>            :     BDFFont *bdf;
<span class="lineNum">    2166 </span>            : 
<span class="lineNum">    2167 </span><span class="lineCov">          5 :     if ( info-&gt;bdf_start==0 )</span>
<span class="lineNum">    2168 </span><span class="lineCov">          5 : return;</span>
<span class="lineNum">    2169 </span><span class="lineNoCov">          0 :     fseek(ttf,info-&gt;bdf_start,SEEK_SET);</span>
<span class="lineNum">    2170 </span><span class="lineNoCov">          0 :     if ( getushort(ttf)!=1 )</span>
<span class="lineNum">    2171 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2172 </span><span class="lineNoCov">          0 :     strike_cnt = getushort(ttf);</span>
<span class="lineNum">    2173 </span><span class="lineNoCov">          0 :     string_start = getlong(ttf) + info-&gt;bdf_start;</span>
<span class="lineNum">    2174 </span>            : 
<span class="lineNum">    2175 </span><span class="lineNoCov">          0 :     bdfinfo = malloc(strike_cnt*sizeof(struct bdfinfo));</span>
<span class="lineNum">    2176 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;strike_cnt; ++i ) {</span>
<span class="lineNum">    2177 </span>            :         int ppem, num_items;
<span class="lineNum">    2178 </span><span class="lineNoCov">          0 :         ppem = getushort(ttf);</span>
<span class="lineNum">    2179 </span><span class="lineNoCov">          0 :         num_items = getushort(ttf);</span>
<span class="lineNum">    2180 </span><span class="lineNoCov">          0 :         for ( bdf=info-&gt;bitmaps; bdf!=NULL; bdf=bdf-&gt;next )</span>
<span class="lineNum">    2181 </span><span class="lineNoCov">          0 :             if ( bdf-&gt;pixelsize==ppem )</span>
<span class="lineNum">    2182 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    2183 </span><span class="lineNoCov">          0 :         bdfinfo[i].bdf = bdf;</span>
<span class="lineNum">    2184 </span><span class="lineNoCov">          0 :         bdfinfo[i].cnt = num_items;</span>
<span class="lineNum">    2185 </span>            :     }
<span class="lineNum">    2186 </span>            : 
<span class="lineNum">    2187 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;strike_cnt; ++i ) {</span>
<span class="lineNum">    2188 </span><span class="lineNoCov">          0 :         if ( (bdf = bdfinfo[i].bdf) ==NULL )</span>
<span class="lineNum">    2189 </span><span class="lineNoCov">          0 :             fseek(ttf,10*bdfinfo[i].cnt,SEEK_CUR);</span>
<span class="lineNum">    2190 </span>            :         else {
<span class="lineNum">    2191 </span><span class="lineNoCov">          0 :             bdf-&gt;prop_cnt = bdfinfo[i].cnt;</span>
<span class="lineNum">    2192 </span><span class="lineNoCov">          0 :             bdf-&gt;props = malloc(bdf-&gt;prop_cnt*sizeof(BDFProperties));</span>
<span class="lineNum">    2193 </span><span class="lineNoCov">          0 :             for ( j=k=0; j&lt;bdfinfo[i].cnt; ++j, ++k ) {</span>
<span class="lineNum">    2194 </span><span class="lineNoCov">          0 :                 long name = getlong(ttf);</span>
<span class="lineNum">    2195 </span><span class="lineNoCov">          0 :                 int type = getushort(ttf);</span>
<span class="lineNum">    2196 </span><span class="lineNoCov">          0 :                 long value = getlong(ttf);</span>
<span class="lineNum">    2197 </span><span class="lineNoCov">          0 :                 bdf-&gt;props[k].type = type;</span>
<span class="lineNum">    2198 </span><span class="lineNoCov">          0 :                 bdf-&gt;props[k].name = getstring(ttf,string_start+name);</span>
<span class="lineNum">    2199 </span><span class="lineNoCov">          0 :                 switch ( type&amp;~prt_property ) {</span>
<span class="lineNum">    2200 </span>            :                   case prt_int: case prt_uint:
<span class="lineNum">    2201 </span><span class="lineNoCov">          0 :                     bdf-&gt;props[k].u.val = value;</span>
<span class="lineNum">    2202 </span><span class="lineNoCov">          0 :                     if ( strcmp(bdf-&gt;props[k].name,&quot;FONT_ASCENT&quot;)==0 &amp;&amp;</span>
<span class="lineNum">    2203 </span><span class="lineNoCov">          0 :                             value&lt;=bdf-&gt;pixelsize ) {</span>
<span class="lineNum">    2204 </span><span class="lineNoCov">          0 :                         bdf-&gt;ascent = value;</span>
<span class="lineNum">    2205 </span><span class="lineNoCov">          0 :                         bdf-&gt;descent = bdf-&gt;pixelsize-value;</span>
<span class="lineNum">    2206 </span>            :                     }
<span class="lineNum">    2207 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    2208 </span>            :                   case prt_string: case prt_atom:
<span class="lineNum">    2209 </span><span class="lineNoCov">          0 :                     bdf-&gt;props[k].u.str = getstring(ttf,string_start+value);</span>
<span class="lineNum">    2210 </span><span class="lineNoCov">          0 :                     k = CheckForNewlines(bdf,k);</span>
<span class="lineNum">    2211 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">    2212 </span>            :                 }
<span class="lineNum">    2213 </span>            :             }
<span class="lineNum">    2214 </span>            :         }
<span class="lineNum">    2215 </span>            :     }
<span class="lineNum">    2216 </span><span class="lineNoCov">          0 :     free(bdfinfo);</span>
<span class="lineNum">    2217 </span>            : }
<span class="lineNum">    2218 </span>            : 
<span class="lineNum">    2219 </span>            : 
<span class="lineNum">    2220 </span>            : /* ************************************************************************** */
<span class="lineNum">    2221 </span>            : /* *************************    The 'FFTM' table    ************************* */
<span class="lineNum">    2222 </span>            : /* *************************         Output         ************************* */
<span class="lineNum">    2223 </span>            : /* ************************************************************************** */
<span class="lineNum">    2224 </span>            : 
<span class="lineNum">    2225 </span>            : /* FontForge timestamp table */
<span class="lineNum">    2226 </span>            : /* Contains: */
<span class="lineNum">    2227 </span>            : /*  date of fontforge sources */
<a name="2228"><span class="lineNum">    2228 </span>            : /*  date of font's (not file's) creation */</a>
<span class="lineNum">    2229 </span>            : /*  date of font's modification */
<span class="lineNum">    2230 </span><span class="lineCov">         27 : int ttf_fftm_dump(SplineFont *sf,struct alltabs *at) {</span>
<span class="lineNum">    2231 </span>            :     int32 results[2];
<span class="lineNum">    2232 </span>            : 
<span class="lineNum">    2233 </span><span class="lineCov">         27 :     at-&gt;fftmf = tmpfile();</span>
<span class="lineNum">    2234 </span>            : 
<span class="lineNum">    2235 </span><span class="lineCov">         27 :     putlong(at-&gt;fftmf,0x00000001);   /* Version */</span>
<span class="lineNum">    2236 </span>            : 
<span class="lineNum">    2237 </span><span class="lineCov">         27 :     cvt_unix_to_1904(LibFF_ModTime,results);</span>
<span class="lineNum">    2238 </span><span class="lineCov">         27 :     putlong(at-&gt;fftmf,results[1]);</span>
<span class="lineNum">    2239 </span><span class="lineCov">         27 :     putlong(at-&gt;fftmf,results[0]);</span>
<span class="lineNum">    2240 </span>            : 
<span class="lineNum">    2241 </span><span class="lineCov">         27 :     cvt_unix_to_1904(sf-&gt;creationtime,results);</span>
<span class="lineNum">    2242 </span><span class="lineCov">         27 :     putlong(at-&gt;fftmf,results[1]);</span>
<span class="lineNum">    2243 </span><span class="lineCov">         27 :     putlong(at-&gt;fftmf,results[0]);</span>
<span class="lineNum">    2244 </span>            : 
<span class="lineNum">    2245 </span><span class="lineCov">         27 :     cvt_unix_to_1904(sf-&gt;modificationtime,results);</span>
<span class="lineNum">    2246 </span><span class="lineCov">         27 :     putlong(at-&gt;fftmf,results[1]);</span>
<span class="lineNum">    2247 </span><span class="lineCov">         27 :     putlong(at-&gt;fftmf,results[0]);</span>
<span class="lineNum">    2248 </span>            : 
<span class="lineNum">    2249 </span><span class="lineCov">         27 :     at-&gt;fftmlen = ftell(at-&gt;fftmf);       /* had better be 7*4 */</span>
<span class="lineNum">    2250 </span>            :             /* It will never be misaligned */
<span class="lineNum">    2251 </span><span class="lineCov">         27 :     if ( (at-&gt;fftmlen&amp;1)!=0 )</span>
<span class="lineNum">    2252 </span><span class="lineNoCov">          0 :         putc(0,at-&gt;fftmf);</span>
<span class="lineNum">    2253 </span><span class="lineCov">         27 :     if ( ((at-&gt;fftmlen+1)&amp;2)!=0 )</span>
<span class="lineNum">    2254 </span><span class="lineNoCov">          0 :         putshort(at-&gt;fftmf,0);</span>
<span class="lineNum">    2255 </span><span class="lineCov">         27 : return( true );</span>
<span class="lineNum">    2256 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
