<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - FontForge coverage report 2017-08-04 01:21:11+02:00 (commit d35f7e4107a9e1db65cce47c468fcc914cecb8fd) - fontforge/print.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">fontforge</a> - print.c<span style="font-size: 80%;"> (source / <a href="print.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">FontForge coverage report 2017-08-04 01:21:11+02:00 (commit d35f7e4107a9e1db65cce47c468fcc914cecb8fd)</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">1808</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-08-04</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">44</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- coding: utf-8 -*- */</a>
<span class="lineNum">       2 </span>            : /* Copyright (C) 2000-2012 by George Williams */
<span class="lineNum">       3 </span>            : /*
<span class="lineNum">       4 </span>            :  * Redistribution and use in source and binary forms, with or without
<span class="lineNum">       5 </span>            :  * modification, are permitted provided that the following conditions are met:
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            :  * Redistributions of source code must retain the above copyright notice, this
<span class="lineNum">       8 </span>            :  * list of conditions and the following disclaimer.
<span class="lineNum">       9 </span>            : 
<span class="lineNum">      10 </span>            :  * Redistributions in binary form must reproduce the above copyright notice,
<span class="lineNum">      11 </span>            :  * this list of conditions and the following disclaimer in the documentation
<span class="lineNum">      12 </span>            :  * and/or other materials provided with the distribution.
<span class="lineNum">      13 </span>            : 
<span class="lineNum">      14 </span>            :  * The name of the author may not be used to endorse or promote products
<span class="lineNum">      15 </span>            :  * derived from this software without specific prior written permission.
<span class="lineNum">      16 </span>            : 
<span class="lineNum">      17 </span>            :  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED
<span class="lineNum">      18 </span>            :  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
<span class="lineNum">      19 </span>            :  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO
<span class="lineNum">      20 </span>            :  * EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<span class="lineNum">      21 </span>            :  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
<span class="lineNum">      22 </span>            :  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
<span class="lineNum">      23 </span>            :  * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
<span class="lineNum">      24 </span>            :  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
<span class="lineNum">      25 </span>            :  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
<span class="lineNum">      26 </span>            :  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">      27 </span>            :  */
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : #include &quot;print.h&quot;
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : #include &quot;cvexport.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;dumppfa.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;fontforgevw.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;fvfonts.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;langfreq.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;mm.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;psread.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;sflayoutP.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;splinesaveafm.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;splineutil.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;tottf.h&quot;
<span class="lineNum">      42 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      43 </span>            : #include &lt;math.h&gt;
<span class="lineNum">      44 </span>            : #include &lt;time.h&gt;
<span class="lineNum">      45 </span>            : #include &lt;unistd.h&gt;
<span class="lineNum">      46 </span>            : #include &lt;ustring.h&gt;
<span class="lineNum">      47 </span>            : #include &lt;ffglib.h&gt;
<span class="lineNum">      48 </span>            : #include &quot;utype.h&quot;
<span class="lineNum">      49 </span>            : #include &lt;sys/types.h&gt;
<span class="lineNum">      50 </span>            : #if !defined(__MINGW32__)
<span class="lineNum">      51 </span>            : #include &lt;sys/wait.h&gt;
<span class="lineNum">      52 </span>            : #endif
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span>            : int pagewidth = 0, pageheight=0;        /* In points */
<span class="lineNum">      55 </span>            : char *printlazyprinter=NULL;
<span class="lineNum">      56 </span>            : char *printcommand=NULL;
<span class="lineNum">      57 </span>            : int printtype = pt_unknown;
<span class="lineNum">      58 </span>            : int use_gv;
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span>            : struct printdefaults pdefs[] = {
<span class="lineNum">      61 </span>            :     { &amp;custom, pt_fontdisplay, 0, NULL },
<span class="lineNum">      62 </span>            :     { &amp;custom, pt_chars, 0, NULL },
<span class="lineNum">      63 </span>            :     { &amp;custom, pt_fontdisplay, 0, NULL }
<span class="lineNum">      64 </span>            : };
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span>            : 
<span class="lineNum">      67 </span>            : /* ************************************************************************** */
<span class="lineNum">      68 </span>            : /* ***************************** Printing Stuff ***************************** */
<a name="69"><span class="lineNum">      69 </span>            : /* ************************************************************************** */</a>
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span><span class="lineNoCov">          0 : static int pdf_addobject(PI *pi) {</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :     if ( pi-&gt;next_object==0 ) {</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :         pi-&gt;max_object = 100;</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :         pi-&gt;object_offsets = malloc(pi-&gt;max_object*sizeof(int));</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :         pi-&gt;object_offsets[pi-&gt;next_object++] = 0;        /* Object 0 is magic */</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :     } else if ( pi-&gt;next_object&gt;=pi-&gt;max_object ) {</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :         pi-&gt;max_object += 100;</span>
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :         pi-&gt;object_offsets = realloc(pi-&gt;object_offsets,pi-&gt;max_object*sizeof(int));</span>
<span class="lineNum">      79 </span>            :     }
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :     pi-&gt;object_offsets[pi-&gt;next_object] = ftell(pi-&gt;out);</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%d 0 obj\n&quot;, pi-&gt;next_object++ );</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 : return( pi-&gt;next_object-1 );</span>
<a name="83"><span class="lineNum">      83 </span>            : }</a>
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span><span class="lineNoCov">          0 : static void pdf_addpage(PI *pi) {</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :     if ( pi-&gt;next_page==0 ) {</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :         pi-&gt;max_page = 100;</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :         pi-&gt;page_objects = malloc(pi-&gt;max_page*sizeof(int));</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :     } else if ( pi-&gt;next_page&gt;=pi-&gt;max_page ) {</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :         pi-&gt;max_page += 100;</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :         pi-&gt;page_objects = realloc(pi-&gt;page_objects,pi-&gt;max_page*sizeof(int));</span>
<span class="lineNum">      92 </span>            :     }
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :     pi-&gt;page_objects[pi-&gt;next_page++] = pi-&gt;next_object;</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">      95 </span>            :         /* Each page is its own dictionary */
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Parent 00000 0 R\n&quot; );   /* Fixup later */</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Type /Page\n&quot; );</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Contents %d 0 R\n&quot;, pi-&gt;next_object );</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     102 </span>            :         /* Each page has its own content stream */
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&lt;&lt; /Length %d 0 R &gt;&gt;\n&quot;, pi-&gt;next_object );</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;stream\n&quot; );</span>
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :     pi-&gt;start_cur_page = ftell( pi-&gt;out );</span>
<a name="107"><span class="lineNum">     107 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span><span class="lineNoCov">          0 : static void pdf_finishpage(PI *pi) {</span>
<span class="lineNum">     110 </span>            :     long streamlength;
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :     if ( pi-&gt;pt!=pt_fontsample )</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;Q\n&quot; );</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :     streamlength = ftell(pi-&gt;out)-pi-&gt;start_cur_page;</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;\nendstream\n&quot; );</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     117 </span>            : 
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot; %ld\n&quot;, streamlength );</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<a name="121"><span class="lineNum">     121 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span><span class="lineNoCov">          0 : static int pfb_getsectionlength(FILE *pfb,int sec_type,int skip_sec) {</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     int len=0, sublen, ch;</span>
<span class="lineNum">     125 </span>            : 
<span class="lineNum">     126 </span>            :     for (;;) {
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :         ch = getc(pfb);</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :         if ( ch!=0x80 ) {</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :             ungetc(ch,pfb);</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :             if ( len!=0 )</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 : return( len );</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 : return( -1 );</span>
<span class="lineNum">     133 </span>            :         }
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :         ch = getc(pfb);</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :         if ( ch!=sec_type ) {</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :             fseek(pfb,-2,SEEK_CUR);</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :             if ( len!=0 )</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 : return( len );</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 : return( -1 );</span>
<span class="lineNum">     140 </span>            :         }
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :         ch = getc(pfb);</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :         sublen = ch;</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :         ch = getc(pfb);</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :         sublen += (ch&lt;&lt;8);</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :         ch = getc(pfb);</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :         sublen += (ch&lt;&lt;16);</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :         ch = getc(pfb);</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :         sublen += (ch&lt;&lt;24);</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :         if ( !skip_sec )</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 : return( sublen );</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :         len += sublen;</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :         fseek(pfb,sublen,SEEK_CUR);</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     154 </span>            : }
<span class="lineNum">     155 </span>            : 
<span class="lineNum">     156 </span>            : struct fontdesc {
<span class="lineNum">     157 </span>            :     DBounds bb;
<span class="lineNum">     158 </span>            :     double ascent, descent, capheight, xheight, avgwidth, maxwidth;
<span class="lineNum">     159 </span>            :     double stemh, stemv;
<span class="lineNum">     160 </span>            :     int flags;
<a name="161"><span class="lineNum">     161 </span>            : };</a>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span><span class="lineNoCov">          0 : static int figure_fontdesc(PI *pi, int sfid, struct fontdesc *fd, int fonttype, int fontstream) {</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :     int i, j, first = true;</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :     SplineFont *sf = pi-&gt;sfbits[sfid].sf;</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :     EncMap *map = pi-&gt;sfbits[sfid].map;</span>
<span class="lineNum">     167 </span>            :     DBounds b;
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :     int capcnt=0, xhcnt=0, wcnt=0;</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :     double samewidth = -1;</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :     int beyond_std = false;</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :     int fd_num = pi-&gt;next_object;</span>
<span class="lineNum">     172 </span>            :     int cidmax;
<span class="lineNum">     173 </span>            :     char *stemv;
<span class="lineNum">     174 </span>            : 
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     memset(fd,0,sizeof(*fd));</span>
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :     cidmax = 0;</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :     if ( sf-&gt;subfonts!=0 ) {</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;sf-&gt;subfontcnt; ++i )</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :             if ( cidmax&lt;sf-&gt;subfonts[i]-&gt;glyphcnt )</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :                 cidmax = sf-&gt;subfonts[i]-&gt;glyphcnt;</span>
<span class="lineNum">     182 </span>            :     } else
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :         cidmax = map-&gt;enccount;</span>
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cidmax; ++i ) {</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :         SplineChar *sc = NULL;</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :         if ( sf-&gt;subfonts!=0 ) {</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :             for ( j=0; j&lt;sf-&gt;subfontcnt; ++j )</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :                 if ( i&lt;sf-&gt;subfonts[j]-&gt;glyphcnt &amp;&amp;</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :                         SCWorthOutputting(sf-&gt;subfonts[j]-&gt;glyphs[i]) ) {</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :                     sc = sf-&gt;subfonts[j]-&gt;glyphs[i];</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     193 </span>            :                 }
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :         } else if ( map-&gt;map[i]==-1 )</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :             sc = NULL;</span>
<span class="lineNum">     196 </span>            :         else
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :             sc = sf-&gt;glyphs[map-&gt;map[i]];</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :         if ( SCWorthOutputting(sc)) {</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :             int uni = sc-&gt;unicodeenc;</span>
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :             SplineCharFindBounds(sc,&amp;b);</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :             if ( first ) {</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :                 fd-&gt;bb = b;</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :                 first = false;</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :                 samewidth = sc-&gt;width;</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :                 fd-&gt;maxwidth = sc-&gt;width;</span>
<span class="lineNum">     207 </span>            :             } else {
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :                 if ( b.minx&lt;fd-&gt;bb.minx ) fd-&gt;bb.minx = b.minx;</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :                 if ( b.miny&lt;fd-&gt;bb.miny ) fd-&gt;bb.miny = b.miny;</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :                 if ( b.maxx&gt;fd-&gt;bb.maxx ) fd-&gt;bb.maxx = b.maxx;</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :                 if ( b.maxy&gt;fd-&gt;bb.maxy ) fd-&gt;bb.maxy = b.maxy;</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :                 if ( samewidth!=sc-&gt;width )</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :                     samewidth = -1;</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :                 if ( sc-&gt;width&gt;fd-&gt;maxwidth ) fd-&gt;maxwidth = sc-&gt;width;</span>
<span class="lineNum">     215 </span>            :             }
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :             fd-&gt;avgwidth += sc-&gt;width; ++wcnt;</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :             if ( sc-&gt;layers[ly_fore].refs==NULL ) {</span>
<span class="lineNum">     218 </span>            :                 /* Ascent and Descent are defined on non-accented characters */
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :                 if ( b.miny&lt;fd-&gt;descent ) fd-&gt;descent = b.miny;</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :                 if ( b.maxy&gt;fd-&gt;ascent ) fd-&gt;ascent = b.maxy;</span>
<span class="lineNum">     221 </span>            :             }
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :             if ( uni=='B' || uni=='D' || uni=='E' || uni=='F' || uni=='H' ||</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :                     uni=='I' || uni=='J' || uni=='L' || uni=='M' || uni=='N' ||</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :                     uni=='P' || uni=='R' || uni=='T' || uni=='U' || uni=='W' ||</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :                     uni=='X' || uni=='Y' || uni=='Z' ||</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :                     uni==0x393 || uni==0x395 || uni==0x396 || uni==0x397 ||</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :                     uni==0x399 || uni==0x39a || uni==0x39c ||</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :                     (uni&gt;=0x3a0 &amp;&amp; uni&lt;=0x3a8) ||</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :                     (uni&gt;=0x411 &amp;&amp; uni&lt;=0x415) || uni==0x418 ||</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :                     (uni&gt;=0x41a &amp;&amp; uni&lt;=0x41d) || uni==0x41f || uni==0x420 ||</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :                     (uni&gt;=0x422 &amp;&amp; uni&lt;=0x42c)) {</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :                 fd-&gt;capheight += b.maxy;</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :                 ++capcnt;</span>
<span class="lineNum">     234 </span>            :             }
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :             if ( (uni&gt;='u' &amp;&amp; uni&lt;='z') ||</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :                     uni==0x3c0 || uni==0x3c4 || uni==0x3c7 || uni==0x3bd ||</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :                     (uni&gt;=0x432 &amp;&amp; uni&lt;=0x434) || uni==0x438 ||</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :                     (uni&gt;=0x43a &amp;&amp; uni&lt;=0x43d) || uni==0x43f || uni==0x432 ||</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :                     (uni&gt;=0x445 &amp;&amp; uni&lt;=0x44c)) {</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :                 fd-&gt;xheight += b.maxy;</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :                 ++xhcnt;</span>
<span class="lineNum">     242 </span>            :             }
<span class="lineNum">     243 </span>            :             /* This is a stupid defn. Every font contains accented latin and */
<span class="lineNum">     244 </span>            :             /*  they aren't in adobe std */
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :             if ( uni&lt;=0x7e )</span>
<span class="lineNum">     246 </span>            :                 /* It's in adobe std */;
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :             else if ( uni&gt;0x3000 &amp;&amp; uni&lt;0xfb00 )</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :                 beyond_std = true;</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :             else if ( !beyond_std ) {</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :                 for ( j=0x80; j&lt;0x100; ++j )</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :                     if ( uni==unicode_from_adobestd[j])</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :                 if ( j==0x100 )</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :                     beyond_std = true;</span>
<span class="lineNum">     255 </span>            :             }
<span class="lineNum">     256 </span>            :         }
<span class="lineNum">     257 </span>            :     }
<span class="lineNum">     258 </span>            : 
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :     if ( capcnt!=0 ) fd-&gt;capheight /= capcnt;</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :     if ( xhcnt!=0 ) fd-&gt;xheight /= xhcnt;</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :     if ( wcnt!=0 ) fd-&gt;avgwidth /= wcnt;</span>
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :     if ( samewidth!=-1 ) fd-&gt;flags = 1;</span>
<span class="lineNum">     264 </span>            :     /* I can't tell whether it's serifed (flag=2) */
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     if ( !beyond_std ) fd-&gt;flags |= 4;</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     else fd-&gt;flags |= 1&lt;&lt;(6-1);</span>
<span class="lineNum">     267 </span>            :     /* I can't tell whether it's script (flag=0x10) */
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     if ( strstrmatch(sf-&gt;fontname,&quot;script&quot;)) fd-&gt;flags |= 0x10;</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :     if ( sf-&gt;italicangle!=0 ) fd-&gt;flags |= (1&lt;&lt;(7-1));</span>
<span class="lineNum">     270 </span>            : 
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :     if (( i = PSDictFindEntry(sf-&gt;private,&quot;StdHW&quot;))!=-1 )</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :         fd-&gt;stemh = strtod(sf-&gt;private-&gt;values[i],NULL);</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :     if (( i = PSDictFindEntry(sf-&gt;private,&quot;StdVW&quot;))!=-1 )</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :         fd-&gt;stemv = strtod(sf-&gt;private-&gt;values[i],NULL);</span>
<span class="lineNum">     275 </span>            : 
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &lt;&lt;\n&quot; );</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Type /FontDescriptor\n&quot; );</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /FontName /%s\n&quot;, sf-&gt;fontname );</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Flags %d\n&quot;, fd-&gt;flags );</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /FontBBox [%g %g %g %g]\n&quot;,</span>
<span class="lineNum">     282 </span>            :             (double) fd-&gt;bb.minx, (double) fd-&gt;bb.miny, (double) fd-&gt;bb.maxx, (double) fd-&gt;bb.maxy );
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     stemv = PSDictHasEntry(sf-&gt;private,&quot;StdVW&quot;);</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     if ( stemv!=NULL )          /* Said to be required, but meaningless for cid fonts where there should be multiple values */</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /StemV %s\n&quot;, stemv );</span>
<span class="lineNum">     286 </span>            :     else
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /StemV 0\n&quot; );</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :     stemv = PSDictHasEntry(sf-&gt;private,&quot;StdHW&quot;);</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :     if ( stemv!=NULL )</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /StemH %s\n&quot;, stemv );</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /ItalicAngle %g\n&quot;, (double) sf-&gt;italicangle );</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Ascent %g\n&quot;, fd-&gt;ascent );</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Descent %g\n&quot;, fd-&gt;descent );</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :     if ( sf-&gt;pfminfo.pfmset )</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /Leading %d\n&quot;, sf-&gt;pfminfo.linegap+sf-&gt;ascent+sf-&gt;descent );</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /CapHeight %g\n&quot;, fd-&gt;capheight );</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /XHeight %g\n&quot;, fd-&gt;xheight );</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /AvgWidth %g\n&quot;, fd-&gt;avgwidth );</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /MaxWidth %g\n&quot;, fd-&gt;maxwidth );</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :     if ( fonttype==1 )</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /FontFile %d 0 R\n&quot;, fontstream );</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :     else if ( fonttype==2 )</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /FontFile2 %d 0 R\n&quot;, fontstream );</span>
<span class="lineNum">     304 </span>            :     else
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /FontFile3 %d 0 R\n&quot;, fontstream );</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot; );</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 : return( fd_num );</span>
<a name="309"><span class="lineNum">     309 </span>            : }</a>
<span class="lineNum">     310 </span>            : 
<span class="lineNum">     311 </span><span class="lineNoCov">          0 : static void dump_pfb_encoding(PI *pi,int sfid, int base,int font_d_ref) {</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :     int i, first=-1, last, gid;</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :     struct sfbits *sfbit = &amp;pi-&gt;sfbits[sfid];</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :     SplineFont *sf = sfbit-&gt;sf;</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     EncMap *map = sfbit-&gt;map;</span>
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     for ( i=base; i&lt;base+256 &amp;&amp; i&lt;map-&gt;enccount; ++i ) {</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :         gid = map-&gt;map[i];</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :         if ( gid!=-1 &amp;&amp; SCWorthOutputting(sf-&gt;glyphs[gid])) {</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :             if ( first==-1 ) first = i-base;</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :             last = i-base;</span>
<span class="lineNum">     322 </span>            :         }
<span class="lineNum">     323 </span>            :     }
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :     if ( first==-1 )</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 : return;                 /* Nothing in this range */</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :     sfbit-&gt;our_font_objs[sfbit-&gt;next_font] = pi-&gt;next_object;</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     sfbit-&gt;fonts[base/256] = sfbit-&gt;next_font++;</span>
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &lt;&lt;\n&quot; );</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Type /Font\n&quot; );</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Subtype /Type1\n&quot; );</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /BaseFont /%s\n&quot;, sf-&gt;fontname );</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /FirstChar %d\n&quot;, first );</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /LastChar %d\n&quot;, last );</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Widths %d 0 R\n&quot;, pi-&gt;next_object );</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /FontDescriptor %d 0 R\n&quot;, font_d_ref );</span>
<span class="lineNum">     338 </span>            :     /* Contrary to my reading of the PDF spec, Adobe Acrobat &amp; Apple's Preview*/
<span class="lineNum">     339 </span>            :     /*  will reencode a font to AdobeStandard if an encoding is omitted */
<span class="lineNum">     340 </span>            :     /* Ghostview agrees with me, and does not reencode */
<span class="lineNum">     341 </span>            :     /*if ( base!=0 )*/
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /Encoding %d 0 R\n&quot;, pi-&gt;next_object+1 );</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot; );</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     345 </span>            :     /* The width vector is normalized to 1000 unit em from whatever the font really uses */
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  [\n&quot; );</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :     for ( i=base+first; i&lt;=base+last; ++i ) if ( (gid=map-&gt;map[i])!=-1 &amp;&amp; SCWorthOutputting(sf-&gt;glyphs[gid]))</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    %g\n&quot;, sf-&gt;glyphs[gid]-&gt;width*1000.0/(sf-&gt;ascent+sf-&gt;descent) );</span>
<span class="lineNum">     350 </span>            :     else
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    0\n&quot; );</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  ]\n&quot; );</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     354 </span>            :     /*if ( base!=0 )*/ {
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :         pdf_addobject(pi);</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  &lt;&lt;\n&quot; );</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /Type /Encoding\n&quot; );</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /Differences [ %d\n&quot;, first );</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :         for ( i=base+first; i&lt;=base+last; ++i )</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :             if ( (gid=map-&gt;map[i])!=-1 &amp;&amp; SCWorthOutputting( sf-&gt;glyphs[gid] ))</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :                 fprintf( pi-&gt;out, &quot;\t/%s\n&quot;, sf-&gt;glyphs[gid]-&gt;name );</span>
<span class="lineNum">     362 </span>            :             else
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :                 fprintf( pi-&gt;out, &quot;\t/.notdef\n&quot; );</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    ]\n&quot; );</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot; );</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     367 </span>            :     }
<a name="368"><span class="lineNum">     368 </span>            : }</a>
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span><span class="lineNoCov">          0 : static void pdf_dump_type1(PI *pi,int sfid) {</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :     struct sfbits *sfbit = &amp;pi-&gt;sfbits[sfid];</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :     int font_stream = pi-&gt;next_object;</span>
<span class="lineNum">     373 </span>            :     int fd_obj;
<span class="lineNum">     374 </span>            :     int length1, length2, length3;
<span class="lineNum">     375 </span>            :     int i;
<span class="lineNum">     376 </span>            :     struct fontdesc fd;
<span class="lineNum">     377 </span>            : 
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :     length1 = pfb_getsectionlength(sfbit-&gt;fontfile,1,true);</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :     length2 = pfb_getsectionlength(sfbit-&gt;fontfile,2,true);</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :     length3 = pfb_getsectionlength(sfbit-&gt;fontfile,1,true);</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&lt;&lt; /Length %d /Length1 %d /Length2 %d /Length3 %d&gt;&gt;\n&quot;,</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :             length1+length2+length3, length1, length2, length3 );</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;stream\n&quot; );</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :     rewind(sfbit-&gt;fontfile);</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :     length1 = pfb_getsectionlength(sfbit-&gt;fontfile,1,false);</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;length1; ++i ) {</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :         int ch = getc(sfbit-&gt;fontfile);</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :         putc(ch,pi-&gt;out);</span>
<span class="lineNum">     390 </span>            :     }
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     while ( (length2 = pfb_getsectionlength(sfbit-&gt;fontfile,2,false))!= -1 ) {</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;length2; ++i ) {</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :             int ch = getc(sfbit-&gt;fontfile);</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :             putc(ch,pi-&gt;out);</span>
<span class="lineNum">     395 </span>            :         }
<span class="lineNum">     396 </span>            :     }
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     length3 = pfb_getsectionlength(sfbit-&gt;fontfile,1,false);</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;length3; ++i ) {</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :         int ch = getc(sfbit-&gt;fontfile);</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :         putc(ch,pi-&gt;out);</span>
<span class="lineNum">     401 </span>            :     }
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;\nendstream\n&quot; );</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :     fd_obj = figure_fontdesc(pi, sfid, &amp;fd,1,font_stream);</span>
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :     sfbit-&gt;our_font_objs = malloc((sfbit-&gt;map-&gt;enccount/256+1)*sizeof(int *));</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :     sfbit-&gt;fonts = malloc((sfbit-&gt;map-&gt;enccount/256+1)*sizeof(int *));</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;sfbit-&gt;map-&gt;enccount; i += 256 ) {</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :         sfbit-&gt;fonts[i/256] = -1;</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :         dump_pfb_encoding(pi,sfid,i,fd_obj);</span>
<span class="lineNum">     412 </span>            :     }
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :     sfbit-&gt;twobyte = false;</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span>            : struct opac_state {
<span class="lineNum">     417 </span>            :     int isfill;
<span class="lineNum">     418 </span>            :     float opacity;
<span class="lineNum">     419 </span>            :     int obj;
<span class="lineNum">     420 </span>            : };
<span class="lineNum">     421 </span>            : 
<span class="lineNum">     422 </span>            : struct glyph_res {
<span class="lineNum">     423 </span>            :     int pattern_cnt, pattern_max;
<span class="lineNum">     424 </span>            :     char **pattern_names;
<span class="lineNum">     425 </span>            :     int *pattern_objs;
<span class="lineNum">     426 </span>            :     int image_cnt, image_max;
<span class="lineNum">     427 </span>            :     char **image_names;
<span class="lineNum">     428 </span>            :     int *image_objs;
<span class="lineNum">     429 </span>            :     int opacity_cnt, opacity_max;
<span class="lineNum">     430 </span>            :     struct opac_state *opac_state;
<span class="lineNum">     431 </span>            : };
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span>            : #define GLYPH_RES_EMPTY { 0, 0, NULL, NULL, 0, 0, NULL, NULL, 0, 0, NULL }
<a name="434"><span class="lineNum">     434 </span>            : </a>
<span class="lineNum">     435 </span>            : 
<span class="lineNum">     436 </span><span class="lineNoCov">          0 : void makePatName(char *buffer,</span>
<span class="lineNum">     437 </span>            :         RefChar *ref,SplineChar *sc,int layer,int isstroke,int isgrad) {
<span class="lineNum">     438 </span>            :     /* In PDF patterns (which include gradients) are fixed to the page. They */
<span class="lineNum">     439 </span>            :     /*  do not alter with the Current Transformation Matrix. So if we have */
<span class="lineNum">     440 </span>            :     /*  a reference to a glyph, then every reference to the same glyph will */
<span class="lineNum">     441 </span>            :     /*  need a different pattern description where that description involves */
<span class="lineNum">     442 </span>            :     /*  the reference's transform matrix */
<span class="lineNum">     443 </span>            : 
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :     if ( ref==NULL )</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :         sprintf( buffer,&quot;%s_ly%d_%s_%s&quot;, sc-&gt;name, layer,</span>
<span class="lineNum">     446 </span>            :                     isstroke ? &quot;stroke&quot;:&quot;fill&quot;, isgrad ? &quot;grad&quot;: &quot;pattern&quot; );
<span class="lineNum">     447 </span>            :     else {
<span class="lineNum">     448 </span>            :         /* PDF names are significant up to 127 chars long and can contain */
<span class="lineNum">     449 </span>            :         /*  all kinds of odd characters, just no spaces or slashes, so this */
<span class="lineNum">     450 </span>            :         /*  name should be legal */
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :         sprintf( buffer,&quot;%s_trans_%g,%g,%g,%g,%g,%g_ly%d_%s_%s&quot;, sc-&gt;name,</span>
<span class="lineNum">     452 </span>            :                 (double) ref-&gt;transform[0], (double) ref-&gt;transform[1], (double) ref-&gt;transform[2],
<span class="lineNum">     453 </span>            :                 (double) ref-&gt;transform[3], (double) ref-&gt;transform[4], (double) ref-&gt;transform[5],
<span class="lineNum">     454 </span>            :                 layer,
<span class="lineNum">     455 </span>            :                 isstroke ? &quot;stroke&quot;:&quot;fill&quot;, isgrad ? &quot;grad&quot;: &quot;pattern&quot; );
<span class="lineNum">     456 </span>            :     }
<a name="457"><span class="lineNum">     457 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     458 </span>            : 
<span class="lineNum">     459 </span><span class="lineNoCov">          0 : static void pdf_BrushCheck(PI *pi,struct glyph_res *gr,struct brush *brush,</span>
<span class="lineNum">     460 </span>            :         int isfill,int layer,SplineChar *sc, RefChar *ref) {
<span class="lineNum">     461 </span>            :     char buffer[400];
<span class="lineNum">     462 </span>            :     int function_obj, shade_obj;
<span class="lineNum">     463 </span>            :     int i,j;
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :     struct gradient *grad = brush-&gt;gradient;</span>
<span class="lineNum">     465 </span>            :     struct pattern *pat;
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     if ( grad!=NULL ) {</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :         function_obj = pdf_addobject(pi);</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /FunctionType 0\n&quot; ); /* Iterpolation between samples */</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Domain [%g %g]\n&quot;, (double) grad-&gt;grad_stops[0].offset,</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :                 (double) grad-&gt;grad_stops[grad-&gt;stop_cnt-1].offset );</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Range [0 1.0 0 1.0 0 1.0]\n&quot; );</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Size [%d]\n&quot;, grad-&gt;stop_cnt==2?2:101 );</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /BitsPerSample 8\n&quot; );</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Decode [0 1.0 0 1.0 0 1.0]\n&quot; );</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Length %d\n&quot;, 3*(grad-&gt;stop_cnt==2?2:101) );</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;stream\n&quot; );</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :         if ( grad-&gt;stop_cnt==2 ) {</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :             unsigned col = grad-&gt;grad_stops[0].col;</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :             if ( col==COLOR_INHERITED ) col = 0x000000;</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :             putc((col&gt;&gt;16)&amp;0xff,pi-&gt;out);</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :             putc((col&gt;&gt;8 )&amp;0xff,pi-&gt;out);</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :             putc((col    )&amp;0xff,pi-&gt;out);</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :             col = grad-&gt;grad_stops[1].col;</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :             if ( col==COLOR_INHERITED ) col = 0x000000;</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :             putc((col&gt;&gt;16)&amp;0xff,pi-&gt;out);</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :             putc((col&gt;&gt;8 )&amp;0xff,pi-&gt;out);</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :             putc((col    )&amp;0xff,pi-&gt;out);</span>
<span class="lineNum">     491 </span>            :         } else {
<span class="lineNum">     492 </span>            :             /* Rather than try and figure out the minimum common divisor */
<span class="lineNum">     493 </span>            :             /*  off all the offsets, I'll just assume they are all percent*/
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;=100; ++i ) {</span>
<span class="lineNum">     495 </span>            :                 int col;
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                 double t = grad-&gt;grad_stops[0].offset +</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                         (grad-&gt;grad_stops[grad-&gt;stop_cnt-1].offset-</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :                          grad-&gt;grad_stops[0].offset)* i/100.0;</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :                 for ( j=0; j&lt;grad-&gt;stop_cnt; ++j )</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :                     if ( t&lt;=grad-&gt;grad_stops[j].offset )</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :                 if ( j==grad-&gt;stop_cnt )</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :                     col = grad-&gt;grad_stops[j-1].col;</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :                 else if ( t==grad-&gt;grad_stops[j].offset )</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                     col = grad-&gt;grad_stops[j].col;</span>
<span class="lineNum">     506 </span>            :                 else {
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :                     double percent = (t-grad-&gt;grad_stops[j-1].offset)/ (grad-&gt;grad_stops[j].offset-grad-&gt;grad_stops[j-1].offset);</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                     uint32 col1 = grad-&gt;grad_stops[j-1].col;</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :                     uint32 col2 = grad-&gt;grad_stops[j  ].col;</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :                     if ( col1==COLOR_INHERITED ) col1 = 0x000000;</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :                     if ( col2==COLOR_INHERITED ) col2 = 0x000000;</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :                     int red   = ((col1&gt;&gt;16)&amp;0xff)*(1-percent) + ((col2&gt;&gt;16)&amp;0xff)*percent;</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :                     int green = ((col1&gt;&gt;8 )&amp;0xff)*(1-percent) + ((col2&gt;&gt;8 )&amp;0xff)*percent;</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :                     int blue  = ((col1    )&amp;0xff)*(1-percent) + ((col2    )&amp;0xff)*percent;</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :                     col = (red&lt;&lt;16) | (green&lt;&lt;8) | blue;</span>
<span class="lineNum">     516 </span>            :                 }
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :                 if ( col==COLOR_INHERITED ) col = 0x000000;</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :                 putc((col&gt;&gt;16)&amp;0xff,pi-&gt;out);</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :                 putc((col&gt;&gt;8 )&amp;0xff,pi-&gt;out);</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :                 putc((col    )&amp;0xff,pi-&gt;out);</span>
<span class="lineNum">     521 </span>            :             }
<span class="lineNum">     522 </span>            :         }
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;\nendstream\n&quot; );</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :         shade_obj = pdf_addobject(pi);</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /ShadingType %d\n&quot;, grad-&gt;radius==0?2:3 );</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /ColorSpace /DeviceRGB\n&quot; );</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :         if ( grad-&gt;radius==0 ) {</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /Coords [%g %g %g %g]\n&quot;,</span>
<span class="lineNum">     532 </span>            :                     (double) grad-&gt;start.x, (double) grad-&gt;start.y, (double) grad-&gt;stop.x, (double) grad-&gt;stop.y);
<span class="lineNum">     533 </span>            :         } else {
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /Coords [%g %g 0 %g %g %g]\n&quot;,</span>
<span class="lineNum">     535 </span>            :                     (double) grad-&gt;start.x, (double) grad-&gt;start.y, (double) grad-&gt;stop.x, (double) grad-&gt;stop.y,
<span class="lineNum">     536 </span>            :                     (double) grad-&gt;radius );
<span class="lineNum">     537 </span>            :         }
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Function %d 0 R\n&quot;, function_obj );</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Extend [true true]\n&quot; );     /* implies pad */</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     542 </span>            : 
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :         if ( gr-&gt;pattern_cnt&gt;=gr-&gt;pattern_max ) {</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :             gr-&gt;pattern_names = realloc(gr-&gt;pattern_names,(gr-&gt;pattern_max+=100)*sizeof(char *));</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :             gr-&gt;pattern_objs  = realloc(gr-&gt;pattern_objs ,(gr-&gt;pattern_max     )*sizeof(int   ));</span>
<span class="lineNum">     546 </span>            :         }
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :         makePatName(buffer,ref,sc,layer,!isfill,true);</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :         gr-&gt;pattern_names[gr-&gt;pattern_cnt  ] = copy(buffer);</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :         gr-&gt;pattern_objs [gr-&gt;pattern_cnt++] = pdf_addobject(pi);</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Type /Pattern\n&quot; );</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /PatternType 2\n&quot; );</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Shading %d 0 R\n&quot;, shade_obj );</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :     } else if ( (pat=brush-&gt;pattern)!=NULL ) {</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :         SplineChar *pattern_sc = SFGetChar(sc-&gt;parent,-1,pat-&gt;pattern);</span>
<span class="lineNum">     558 </span>            :         DBounds b;
<span class="lineNum">     559 </span>            :         real scale[6], result[6];
<span class="lineNum">     560 </span>            :         int respos, resobj;
<span class="lineNum">     561 </span>            :         int lenpos, lenstart, len;
<span class="lineNum">     562 </span>            : 
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :         if ( pattern_sc==NULL )</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :             LogError(_(&quot;No glyph named %s, used as a pattern in %s\n&quot;), pat-&gt;pattern, sc-&gt;name);</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :         PatternSCBounds(pattern_sc,&amp;b);</span>
<span class="lineNum">     566 </span>            : 
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :         if ( gr-&gt;pattern_cnt&gt;=gr-&gt;pattern_max ) {</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :             gr-&gt;pattern_names = realloc(gr-&gt;pattern_names,(gr-&gt;pattern_max+=100)*sizeof(char *));</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :             gr-&gt;pattern_objs  = realloc(gr-&gt;pattern_objs ,(gr-&gt;pattern_max     )*sizeof(int   ));</span>
<span class="lineNum">     570 </span>            :         }
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :         makePatName(buffer,ref,sc,layer,!isfill,false);</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :         gr-&gt;pattern_names[gr-&gt;pattern_cnt  ] = copy(buffer);</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :         gr-&gt;pattern_objs [gr-&gt;pattern_cnt++] = pdf_addobject(pi);</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Type /Pattern\n&quot; );</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /PatternType 1\n&quot; );</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /PaintType 1\n&quot; );            /* The intricacies of uncolored tiles are not something into which I wish to delve */</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /TilingType 1\n&quot; );</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /BBox [%g %g %g %g]\n&quot;, (double) b.minx, (double) b.miny, (double) b.maxx, (double) b.maxy );</span>
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /XStep %g\n&quot;, (double) (b.maxx-b.minx) );</span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /YStep %g\n&quot;, (double) (b.maxy-b.miny) );</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :         memset(scale,0,sizeof(scale));</span>
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :         scale[0] = pat-&gt;width/(b.maxx-b.minx);</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :         scale[3] = pat-&gt;height/(b.maxy-b.miny);</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :         MatMultiply(scale,pat-&gt;transform, result);</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Matrix [%g %g %g %g %g %g]\n&quot;, (double) result[0], (double) result[1],</span>
<span class="lineNum">     587 </span>            :                 (double) result[2], (double) result[3], (double) result[4], (double) result[5]);
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /Resources &quot; );</span>
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :         respos = ftell(pi-&gt;out);</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;000000 0 R\n&quot; );</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /Length &quot; );</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :         lenpos = ftell(pi-&gt;out);</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;00000000\n&quot; );</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot; stream \n&quot; );</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :         lenstart = ftell(pi-&gt;out);</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :         SC_PSDump((void (*)(int,void *)) fputc,pi-&gt;out,pattern_sc,true,true,ly_all);</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :         len = ftell(pi-&gt;out)-lenstart;</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot; endstream\n&quot; );</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     601 </span>            : 
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :         resobj = PdfDumpGlyphResources(pi,pattern_sc);</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :         fseek(pi-&gt;out,respos,SEEK_SET);</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%6d&quot;, resobj );</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :         fseek(pi-&gt;out,lenpos,SEEK_SET);</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%8d&quot;, len );</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :         fseek(pi-&gt;out,0,SEEK_END);</span>
<span class="lineNum">     608 </span>            :     }
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :     if ( brush-&gt;opacity&lt;1.0 &amp;&amp; brush-&gt;opacity&gt;=0 ) {</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :         for ( i=gr-&gt;opacity_cnt-1; i&gt;=0; --i ) {</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :             if ( brush-&gt;opacity==gr-&gt;opac_state[i].opacity &amp;&amp; isfill==gr-&gt;opac_state[i].opacity )</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :         break;  /* Already done */</span>
<span class="lineNum">     613 </span>            :         }
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :         if ( i==-1 ) {</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :             if ( gr-&gt;opacity_cnt&gt;=gr-&gt;opacity_max ) {</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :                 gr-&gt;opac_state = realloc(gr-&gt;opac_state,(gr-&gt;opacity_max+=100)*sizeof(struct opac_state));</span>
<span class="lineNum">     617 </span>            :             }
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :             gr-&gt;opac_state[gr-&gt;opacity_cnt].opacity = brush-&gt;opacity;</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :             gr-&gt;opac_state[gr-&gt;opacity_cnt].isfill  = isfill;</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :             gr-&gt;opac_state[gr-&gt;opacity_cnt].obj     = function_obj = pdf_addobject(pi);</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :             ++gr-&gt;opacity_cnt;</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /Type /ExtGState\n&quot; );</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :             if ( isfill )</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :                 fprintf( pi-&gt;out, &quot;  /ca %g\n&quot;, brush-&gt;opacity );</span>
<span class="lineNum">     626 </span>            :             else
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :                 fprintf( pi-&gt;out, &quot;  /CA %g\n&quot;, brush-&gt;opacity );</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /AIS false\n&quot; );  /* alpha value */</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<span class="lineNum">     631 </span>            :         }
<span class="lineNum">     632 </span>            :     }
<a name="633"><span class="lineNum">     633 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     634 </span>            : 
<span class="lineNum">     635 </span><span class="lineNoCov">          0 : static void pdf_ImageCheck(PI *pi,struct glyph_res *gr,ImageList *images,</span>
<span class="lineNum">     636 </span>            :         int layer,SplineChar *sc) {
<span class="lineNum">     637 </span>            :     char buffer[400];
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :     int icnt=0;</span>
<span class="lineNum">     639 </span>            :     GImage *img;
<span class="lineNum">     640 </span>            :     struct _GImage *base;
<span class="lineNum">     641 </span>            :     int i;
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :     while ( images!=NULL ) {</span>
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :         img = images-&gt;image;</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :         base = img-&gt;list_len==0 ? img-&gt;u.image : img-&gt;u.images[1];</span>
<span class="lineNum">     646 </span>            : 
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :         if ( gr-&gt;image_cnt&gt;=gr-&gt;image_max ) {</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :             gr-&gt;image_names = realloc(gr-&gt;image_names,(gr-&gt;image_max+=100)*sizeof(char *));</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :             gr-&gt;image_objs  = realloc(gr-&gt;image_objs ,(gr-&gt;image_max     )*sizeof(int   ));</span>
<span class="lineNum">     650 </span>            :         }
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :         sprintf( buffer, &quot;%s_ly%d_%d_image&quot;, sc-&gt;name, layer, icnt );</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :         gr-&gt;image_names[gr-&gt;image_cnt  ] = copy(buffer);</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :         gr-&gt;image_objs [gr-&gt;image_cnt++] = pdf_addobject(pi);</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :         ++icnt;</span>
<span class="lineNum">     655 </span>            : 
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Type /XObject\n&quot; );</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Subtype /Image\n&quot; );</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Width %d\n&quot;, base-&gt;width );</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Height %d\n&quot;, base-&gt;height );</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :         if ( base-&gt;image_type == it_mono ) {</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /BitsPerComponent 1\n&quot; );</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /ImageMask true\n&quot; );</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /Length %d\n&quot;, base-&gt;height*base-&gt;bytes_per_line );</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :         } else if ( base-&gt;image_type == it_true ) {</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /BitsPerComponent 8\n&quot; );</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /ColorSpace /DeviceRGB\n&quot; );</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /Length %d\n&quot;, base-&gt;height*base-&gt;width*3 );</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :         } else if ( base-&gt;image_type == it_index ) {</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /BitsPerComponent 8\n&quot; );</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /ColorSpace [/Indexed /DeviceRGB %d\n&lt;&quot;,</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :                     base-&gt;clut-&gt;clut_len );</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;base-&gt;clut-&gt;clut_len; ++i )</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :                 fprintf( pi-&gt;out, &quot;%06x &quot;, base-&gt;clut-&gt;clut[i] );</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;&gt;\n&quot; );</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  /Length %d\n&quot;, base-&gt;height*base-&gt;width );</span>
<span class="lineNum">     677 </span>            :         }
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;stream\n&quot; );</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :         if ( base-&gt;image_type!=it_true ) {</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :             fwrite(base-&gt;data,1,base-&gt;height*base-&gt;bytes_per_line,pi-&gt;out);</span>
<span class="lineNum">     682 </span>            :         } else {
<span class="lineNum">     683 </span>            :             /* My image representation of colors includes a pad byte, pdf's does not */
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :             uint32 *pt = (uint32 *) base-&gt;data;</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;base-&gt;width*base-&gt;height; ++i, ++pt ) {</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :                 int red   = (*pt&gt;&gt;16)&amp;0xff;</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :                 int green = (*pt&gt;&gt;8 )&amp;0xff;</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :                 int blue  = (*pt    )&amp;0xff;</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :                 putc(red,pi-&gt;out);</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :                 putc(green,pi-&gt;out);</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :                 putc(blue,pi-&gt;out);</span>
<span class="lineNum">     692 </span>            :             }
<span class="lineNum">     693 </span>            :         }
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;\nendstream\n&quot; );</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :         images = images-&gt;next;</span>
<span class="lineNum">     697 </span>            :     }
<span class="lineNum">     698 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     699 </span>            : 
<a name="700"><span class="lineNum">     700 </span>            : /* We need different gradients and patterns for different transform */</a>
<span class="lineNum">     701 </span>            : /*  matrices of references to the same glyph. Sigh. */
<span class="lineNum">     702 </span><span class="lineNoCov">          0 : int PdfDumpGlyphResources(PI *pi,SplineChar *sc) {</span>
<span class="lineNum">     703 </span>            :     int resobj;
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :     struct glyph_res gr = GLYPH_RES_EMPTY;</span>
<span class="lineNum">     705 </span>            :     int i;
<span class="lineNum">     706 </span>            :     int layer;
<span class="lineNum">     707 </span>            :     RefChar *ref;
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :     for ( layer=ly_fore; layer&lt;sc-&gt;layer_cnt; ++layer ) {</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :         if ( sc-&gt;layers[layer].dofill )</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :             pdf_BrushCheck(pi,&amp;gr,&amp;sc-&gt;layers[layer].fill_brush,true,layer,sc,NULL);</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :         if ( sc-&gt;layers[layer].dostroke )</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :             pdf_BrushCheck(pi,&amp;gr,&amp;sc-&gt;layers[layer].stroke_pen.brush,false,layer,sc,NULL);</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :         pdf_ImageCheck(pi,&amp;gr,sc-&gt;layers[layer].images,layer,sc);</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :         for ( ref=sc-&gt;layers[layer].refs; ref!=NULL; ref=ref-&gt;next ) {</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;ref-&gt;layer_cnt; ++i ) {</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :                 if ( ref-&gt;layers[i].dofill )</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :                     pdf_BrushCheck(pi,&amp;gr,&amp;ref-&gt;layers[i].fill_brush,true,i,ref-&gt;sc,ref);</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :                 if ( ref-&gt;layers[i].dostroke )</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :                     pdf_BrushCheck(pi,&amp;gr,&amp;ref-&gt;layers[i].stroke_pen.brush,false,i,ref-&gt;sc,ref);</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :                 pdf_ImageCheck(pi,&amp;gr,ref-&gt;layers[i].images,i,ref-&gt;sc);</span>
<span class="lineNum">     722 </span>            :             }
<span class="lineNum">     723 </span>            :         }
<span class="lineNum">     724 </span>            :     }
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :     resobj = pdf_addobject(pi);</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :     fprintf(pi-&gt;out,&quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :     if ( gr.pattern_cnt!=0 ) {</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Pattern &lt;&lt;\n&quot; );</span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;gr.pattern_cnt; ++i ) {</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;    /%s %d 0 R\n&quot;, gr.pattern_names[i], gr.pattern_objs[i] );</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :             free(gr.pattern_names[i]);</span>
<span class="lineNum">     732 </span>            :         }
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :         free(gr.pattern_names); free(gr.pattern_objs);</span>
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot;);</span>
<span class="lineNum">     735 </span>            :     }
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :     if ( gr.image_cnt!=0 ) {</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /XObject &lt;&lt;\n&quot; );</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;gr.image_cnt; ++i ) {</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;    /%s %d 0 R\n&quot;, gr.image_names[i], gr.image_objs[i] );</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :             free(gr.image_names[i]);</span>
<span class="lineNum">     741 </span>            :         }
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :         free(gr.image_names); free(gr.image_objs);</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot;);</span>
<span class="lineNum">     744 </span>            :     }
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :     if ( gr.opacity_cnt!=0 ) {</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /ExtGState &lt;&lt;\n&quot; );</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;gr.opacity_cnt; ++i ) {</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;    /gs_%s_opacity_%g %d 0 R\n&quot;,</span>
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :                     gr.opac_state[i].isfill ? &quot;fill&quot; : &quot;stroke&quot;,</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :                     gr.opac_state[i].opacity, gr.opac_state[i].obj );</span>
<span class="lineNum">     751 </span>            :         }
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :         free(gr.opac_state);</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot;);</span>
<span class="lineNum">     754 </span>            :     }
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 : return( resobj );</span>
<a name="758"><span class="lineNum">     758 </span>            : }</a>
<span class="lineNum">     759 </span>            : 
<span class="lineNum">     760 </span><span class="lineNoCov">          0 : static int PdfDumpSFResources(PI *pi,SplineFont *sf) {</span>
<span class="lineNum">     761 </span>            :     int resobj;
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :     struct glyph_res gr = GLYPH_RES_EMPTY;</span>
<span class="lineNum">     763 </span>            :     int i;
<span class="lineNum">     764 </span>            :     int layer, gid;
<span class="lineNum">     765 </span>            :     SplineChar *sc;
<span class="lineNum">     766 </span>            :     RefChar *ref;
<span class="lineNum">     767 </span>            : 
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :     for ( gid=0; gid&lt;sf-&gt;glyphcnt; ++gid) if ( (sc=sf-&gt;glyphs[gid])!=NULL ) {</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :         for ( layer=ly_fore; layer&lt;sc-&gt;layer_cnt; ++layer ) {</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :             if ( sc-&gt;layers[layer].dofill )</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :                 pdf_BrushCheck(pi,&amp;gr,&amp;sc-&gt;layers[layer].fill_brush,true,layer,sc,NULL);</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :             if ( sc-&gt;layers[layer].dostroke )</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :                 pdf_BrushCheck(pi,&amp;gr,&amp;sc-&gt;layers[layer].stroke_pen.brush,false,layer,sc,NULL);</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :             pdf_ImageCheck(pi,&amp;gr,sc-&gt;layers[layer].images,layer,sc);</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :             for ( ref=sc-&gt;layers[layer].refs; ref!=NULL; ref=ref-&gt;next ) {</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :                 for ( i=0; i&lt;ref-&gt;layer_cnt; ++i ) {</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :                     if ( ref-&gt;layers[i].dofill )</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :                         pdf_BrushCheck(pi,&amp;gr,&amp;ref-&gt;layers[i].fill_brush,true,i,ref-&gt;sc,ref);</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :                     if ( ref-&gt;layers[i].dostroke )</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :                         pdf_BrushCheck(pi,&amp;gr,&amp;ref-&gt;layers[i].stroke_pen.brush,false,i,ref-&gt;sc,ref);</span>
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :                     pdf_ImageCheck(pi,&amp;gr,ref-&gt;layers[layer].images,i,ref-&gt;sc);</span>
<span class="lineNum">     782 </span>            :                 }
<span class="lineNum">     783 </span>            :             }
<span class="lineNum">     784 </span>            :         }
<span class="lineNum">     785 </span>            :     }
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :     resobj = pdf_addobject(pi);</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :     fprintf(pi-&gt;out,&quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :     if ( gr.pattern_cnt!=0 ) {</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Pattern &lt;&lt;\n&quot; );</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;gr.pattern_cnt; ++i ) {</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;    /%s %d 0 R\n&quot;, gr.pattern_names[i], gr.pattern_objs[i] );</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :             free(gr.pattern_names[i]);</span>
<span class="lineNum">     793 </span>            :         }
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :         free(gr.pattern_names); free(gr.pattern_objs);</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot;);</span>
<span class="lineNum">     796 </span>            :     }
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :     if ( gr.image_cnt!=0 ) {</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /XObject &lt;&lt;\n&quot; );</span>
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;gr.image_cnt; ++i ) {</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;    /%s %d 0 R\n&quot;, gr.image_names[i], gr.image_objs[i] );</span>
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :             free(gr.image_names[i]);</span>
<span class="lineNum">     802 </span>            :         }
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :         free(gr.image_names); free(gr.image_objs);</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot;);</span>
<span class="lineNum">     805 </span>            :     }
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :     if ( gr.opacity_cnt!=0 ) {</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /ExtGState &lt;&lt;\n&quot; );</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;gr.opacity_cnt; ++i ) {</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;    /gs_%s_opacity_%g %d 0 R\n&quot;,</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :                     gr.opac_state[i].isfill ? &quot;fill&quot; : &quot;stroke&quot;,</span>
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :                     gr.opac_state[i].opacity, gr.opac_state[i].obj );</span>
<span class="lineNum">     812 </span>            :         }
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :         free(gr.opac_state);</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot;);</span>
<span class="lineNum">     815 </span>            :     }
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 : return( resobj );</span>
<a name="819"><span class="lineNum">     819 </span>            : }</a>
<span class="lineNum">     820 </span>            : 
<span class="lineNum">     821 </span><span class="lineNoCov">          0 : static int pdf_charproc(PI *pi, SplineChar *sc) {</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :     int ret = pi-&gt;next_object;</span>
<span class="lineNum">     823 </span>            :     long streamstart, streamlength;
<span class="lineNum">     824 </span>            :     int i,last;
<span class="lineNum">     825 </span>            : 
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">     827 </span>            :     /* Now page 96 of the PDFReference.pdf manual claims that Resource dicas */
<span class="lineNum">     828 </span>            :     /*  for type3 fonts should reside in the content stream dictionary. This */
<span class="lineNum">     829 </span>            :     /*  isn't very meaningful because type3 fonts are not content streams. I */
<span class="lineNum">     830 </span>            :     /*  assumed it meant in the stream dictionary for each glyph (which is a */
<span class="lineNum">     831 </span>            :     /*  content stream) but that is not the case. It's in the font dictionary*/
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&lt;&lt; /Length %d 0 R &gt;&gt;&quot;, pi-&gt;next_object );</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;stream\n&quot; );</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :     streamstart = ftell(pi-&gt;out);</span>
<span class="lineNum">     835 </span>            : 
<span class="lineNum">     836 </span>            :     /* In addition to drawing the glyph, we must provide some metrics */
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :     last = ly_fore;</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :     if ( sc-&gt;parent-&gt;multilayer )</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :         last = sc-&gt;layer_cnt-1;</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :     for ( i=ly_fore; i&lt;=last; ++i ) {</span>
<span class="lineNum">     841 </span>            :         ImageList *img;
<span class="lineNum">     842 </span>            :         RefChar *ref;
<span class="lineNum">     843 </span>            :         int j;
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :         if ( (sc-&gt;layers[i].dofill &amp;&amp; (sc-&gt;layers[i].fill_brush.col!=COLOR_INHERITED || sc-&gt;layers[i].fill_brush.gradient!=NULL || sc-&gt;layers[i].fill_brush.pattern!=NULL)) ||</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :                 (sc-&gt;layers[i].dostroke &amp;&amp; (sc-&gt;layers[i].stroke_pen.brush.col!=COLOR_INHERITED|| sc-&gt;layers[i].stroke_pen.brush.gradient!=NULL || sc-&gt;layers[i].stroke_pen.brush.pattern!=NULL)) )</span>
<span class="lineNum">     846 </span>            :     break;
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :         for ( img=sc-&gt;layers[i].images; img!=NULL; img=img-&gt;next )</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :             if ( img-&gt;image-&gt;u.image-&gt;image_type != it_mono )</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :         if ( img!=NULL )</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :         for ( ref=sc-&gt;layers[i].refs; ref!=NULL; ref=ref-&gt;next ) {</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :             for ( j=0; j&lt;ref-&gt;layer_cnt; ++j ) {</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :                 if ( (ref-&gt;layers[j].dofill &amp;&amp; (ref-&gt;layers[j].fill_brush.col!=COLOR_INHERITED || ref-&gt;layers[j].fill_brush.gradient!=NULL || ref-&gt;layers[j].fill_brush.pattern!=NULL)) ||</span>
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :                         (ref-&gt;layers[j].dostroke &amp;&amp; (ref-&gt;layers[j].stroke_pen.brush.col!=COLOR_INHERITED|| ref-&gt;layers[j].stroke_pen.brush.gradient!=NULL || ref-&gt;layers[j].stroke_pen.brush.pattern!=NULL)) )</span>
<span class="lineNum">     856 </span>            :             break;
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :                 for ( img=ref-&gt;layers[j].images; img!=NULL; img=img-&gt;next )</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :                     if ( img-&gt;image-&gt;u.image-&gt;image_type != it_mono )</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :                 if ( img!=NULL )</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     862 </span>            :             }
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :             if ( j!=ref-&gt;layer_cnt )</span>
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     865 </span>            :         }
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :         if ( ref!=NULL )</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     868 </span>            :     }
<span class="lineNum">     869 </span>            : 
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :     if ( i==sc-&gt;layer_cnt ) {</span>
<span class="lineNum">     871 </span>            :         /* We never set the color, use d1 to specify metrics */
<span class="lineNum">     872 </span>            :         DBounds b;
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :         SplineCharFindBounds(sc,&amp;b);</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%d 0 %g %g %g %g d1\n&quot;,</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :                 sc-&gt;width,</span>
<span class="lineNum">     876 </span>            :                 (double) b.minx, (double) b.miny, (double) b.maxx, (double) b.maxy );
<span class="lineNum">     877 </span>            :     } else
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%d 0 d0\n&quot;, sc-&gt;width );</span>
<span class="lineNum">     879 </span>            : 
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :     SC_PSDump((void (*)(int,void *)) fputc,pi-&gt;out,sc,true,true,ly_fore);</span>
<span class="lineNum">     881 </span>            : 
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :     streamlength = ftell(pi-&gt;out)-streamstart;</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;\nendstream\n&quot; );</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     885 </span>            : 
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot; %ld\n&quot;, streamlength );</span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 : return( ret );</span>
<a name="890"><span class="lineNum">     890 </span>            : }</a>
<span class="lineNum">     891 </span>            : 
<span class="lineNum">     892 </span><span class="lineNoCov">          0 : static void dump_pdf3_encoding(PI *pi,int sfid, int base,DBounds *bb, int notdefproc) {</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :     int i, first=-1, last, gid;</span>
<span class="lineNum">     894 </span>            :     int charprocs[256];
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :     struct sfbits *sfbit = &amp;pi-&gt;sfbits[sfid];</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :     SplineFont *sf = sfbit-&gt;sf;</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :     EncMap *map = sfbit-&gt;map;</span>
<span class="lineNum">     898 </span>            :     int respos, resobj;
<span class="lineNum">     899 </span>            : 
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :     for ( i=base; i&lt;base+256 &amp;&amp; i&lt;map-&gt;enccount; ++i ) if ( (gid=map-&gt;map[i])!=-1 ) {</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :         if ( SCWorthOutputting(sf-&gt;glyphs[gid]) &amp;&amp; strcmp(sf-&gt;glyphs[gid]-&gt;name,&quot;.notdef&quot;)!=0 ) {</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :             if ( first==-1 ) first = i-base;</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :             last = i-base;</span>
<span class="lineNum">     904 </span>            :         }
<span class="lineNum">     905 </span>            :     }
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :     if ( first==-1 )</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 : return;                 /* Nothing in this range */</span>
<span class="lineNum">     908 </span>            : 
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :     memset(charprocs,0,sizeof(charprocs));</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :     for ( i=base; i&lt;base+256 &amp;&amp; i&lt;map-&gt;enccount; ++i ) if ( (gid=map-&gt;map[i])!=-1 ) {</span>
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :         if ( SCWorthOutputting(sf-&gt;glyphs[gid]) &amp;&amp; strcmp(sf-&gt;glyphs[gid]-&gt;name,&quot;.notdef&quot;)!=0 )</span>
<span class="lineNum">     912 </span><span class="lineNoCov">          0 :             charprocs[i-base] = pdf_charproc(pi,sf-&gt;glyphs[gid]);</span>
<span class="lineNum">     913 </span>            :     }
<span class="lineNum">     914 </span>            : 
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :     sfbit-&gt;our_font_objs[sfbit-&gt;next_font] = pi-&gt;next_object;</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :     sfbit-&gt;fonts[base/256] = sfbit-&gt;next_font++;</span>
<span class="lineNum">     917 </span>            : 
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &lt;&lt;\n&quot; );</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Type /Font\n&quot; );</span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Subtype /Type3\n&quot; );</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Name /%s\n&quot;, sf-&gt;fontname );</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /FontBBox [%g %g %g %g]\n&quot;,</span>
<span class="lineNum">     924 </span>            :             floor(bb-&gt;minx), floor(bb-&gt;miny), ceil(bb-&gt;maxx), ceil(bb-&gt;maxy) );
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /FontMatrix [%g 0 0 %g 0 0]\n&quot;,</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :             1.0/(sf-&gt;ascent+sf-&gt;descent), 1.0/(sf-&gt;ascent+sf-&gt;descent));</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /FirstChar %d\n&quot;, first );</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /LastChar %d\n&quot;, last );</span>
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Widths %d 0 R\n&quot;, pi-&gt;next_object );</span>
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Encoding %d 0 R\n&quot;, pi-&gt;next_object+1 );</span>
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /CharProcs %d 0 R\n&quot;, pi-&gt;next_object+2 );</span>
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Resources &quot; );</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :     respos = ftell(pi-&gt;out);</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;000000 0 R\n&quot; );</span>
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot; );</span>
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     937 </span>            : 
<span class="lineNum">     938 </span>            :     /* Widths array */
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  [\n&quot; );</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :     for ( i=base+first; i&lt;=base+last; ++i )</span>
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :         if ( (gid=map-&gt;map[i])!=-1 &amp;&amp; SCWorthOutputting(sf-&gt;glyphs[gid]))</span>
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;    %d\n&quot;, sf-&gt;glyphs[gid]-&gt;width );</span>
<span class="lineNum">     944 </span>            :         else
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;    0\n&quot; );</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  ]\n&quot; );</span>
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span>            :     /* Encoding dictionary */
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &lt;&lt;\n&quot; );</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Type /Encoding\n&quot; );</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Differences [ %d\n&quot;, first );</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :     for ( i=base+first; i&lt;=base+last; ++i )</span>
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :         if ( (gid=map-&gt;map[i])!=-1 &amp;&amp; SCWorthOutputting(sf-&gt;glyphs[gid]))</span>
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;\t/%s\n&quot;, sf-&gt;glyphs[gid]-&gt;name );</span>
<span class="lineNum">     957 </span>            :         else
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;\t/.notdef\n&quot; );</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    ]\n&quot; );</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot; );</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     962 </span>            : 
<span class="lineNum">     963 </span>            :     /* Char procs dictionary */
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &lt;&lt;\n&quot; );</span>
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;\t/.notdef %d 0 R\n&quot;, notdefproc );</span>
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :     for ( i=base+first; i&lt;=base+last; ++i )</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :         if ( (gid=map-&gt;map[i])!=-1 &amp;&amp; SCWorthOutputting(sf-&gt;glyphs[gid]))</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;\t/%s %d 0 R\n&quot;, sf-&gt;glyphs[gid]-&gt;name, charprocs[i-base] );</span>
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot; );</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">     972 </span>            : 
<span class="lineNum">     973 </span>            : 
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :     resobj = PdfDumpSFResources(pi,sf);</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :     fseek(pi-&gt;out,respos,SEEK_SET);</span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :     fprintf(pi-&gt;out,&quot;%06d&quot;, resobj );</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :     fseek(pi-&gt;out,0,SEEK_END);</span>
<a name="978"><span class="lineNum">     978 </span>            : }</a>
<span class="lineNum">     979 </span>            : 
<span class="lineNum">     980 </span><span class="lineNoCov">          0 : static void pdf_gen_type3(PI *pi,int sfid) {</span>
<span class="lineNum">     981 </span>            :     int i, notdefproc;
<span class="lineNum">     982 </span>            :     DBounds bb;
<span class="lineNum">     983 </span>            :     SplineChar sc;
<span class="lineNum">     984 </span>            :     Layer layers[2];
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :     struct sfbits *sfbit = &amp;pi-&gt;sfbits[sfid];</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :     SplineFont *sf = sfbit-&gt;sf;</span>
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :     EncMap *map = sfbit-&gt;map;</span>
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :     int notdefpos = SFFindNotdef(sf,-2);</span>
<span class="lineNum">     989 </span>            : 
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :     if ( notdefpos!=-1 )</span>
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :         notdefproc = pdf_charproc(pi,sf-&gt;glyphs[notdefpos]);</span>
<span class="lineNum">     992 </span>            :     else {
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :         memset(&amp;sc,0,sizeof(sc));</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :         sc.name = &quot;.notdef&quot;;</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :         sc.parent = sf;</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :         sc.width = sf-&gt;ascent+sf-&gt;descent;</span>
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :         sc.layer_cnt = 2;</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :         memset(layers,0,sizeof(layers));</span>
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :         sc.layers = layers;</span>
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :         notdefproc = pdf_charproc(pi, &amp;sc);</span>
<span class="lineNum">    1001 </span>            :     }
<span class="lineNum">    1002 </span>            : 
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :     SplineFontFindBounds(sf,&amp;bb);</span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :     sfbit-&gt;our_font_objs = malloc((map-&gt;enccount/256+1)*sizeof(int *));</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :     sfbit-&gt;fonts = malloc((map-&gt;enccount/256+1)*sizeof(int *));</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;map-&gt;enccount; i += 256 ) {</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :         sfbit-&gt;fonts[i/256] = -1;</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :         dump_pdf3_encoding(pi,sfid,i,&amp;bb,notdefproc);</span>
<span class="lineNum">    1009 </span>            :     }
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :     sfbit-&gt;twobyte = false;</span>
<a name="1011"><span class="lineNum">    1011 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1012 </span>            : 
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 : static void pdf_build_type0(PI *pi, int sfid) {</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :     int cidfont_ref, fd_obj, font_stream = pi-&gt;next_object;</span>
<span class="lineNum">    1015 </span>            :     long len;
<span class="lineNum">    1016 </span>            :     int ch, cidmax, i,j;
<span class="lineNum">    1017 </span>            :     struct fontdesc fd;
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :     struct sfbits *sfbit = &amp;pi-&gt;sfbits[sfid];</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :     SplineFont *sf = sfbit-&gt;sf;</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :     SplineFont *cidmaster = sf-&gt;cidmaster!=NULL?sf-&gt;cidmaster:sf;</span>
<span class="lineNum">    1021 </span>            :     uint16 *widths;
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :     int defwidth = sf-&gt;ascent+sf-&gt;descent;</span>
<span class="lineNum">    1023 </span>            : 
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :     fseek( sfbit-&gt;fontfile,0,SEEK_END);</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :     len = ftell(sfbit-&gt;fontfile );</span>
<span class="lineNum">    1026 </span>            : 
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&lt;&lt; /Length %ld &quot;, len );</span>
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :     if ( sfbit-&gt;istype42cid )</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;/Length1 %ld&gt;&gt;\n&quot;, len );</span>
<span class="lineNum">    1031 </span>            :     else
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;/Subtype /CIDFontType0C&gt;&gt;\n&quot; );</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;stream\n&quot; );</span>
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :     rewind(sfbit-&gt;fontfile);</span>
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :     while ( (ch=getc(sfbit-&gt;fontfile))!=EOF )</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :         putc(ch,pi-&gt;out);</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;\nendstream\n&quot; );</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<span class="lineNum">    1039 </span>            : 
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :     fd_obj = figure_fontdesc(pi, sfid, &amp;fd,sfbit-&gt;istype42cid?2:3,font_stream);</span>
<span class="lineNum">    1041 </span>            : 
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :     cidfont_ref = pi-&gt;next_object;</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &lt;&lt;\n&quot; );</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Type /Font\n&quot; );</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Subtype /CIDFontType%d\n&quot;, sfbit-&gt;istype42cid?2:0 );</span>
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /BaseFont /%s\n&quot;, cidmaster-&gt;fontname);</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :     if ( cidmaster-&gt;cidregistry!=NULL &amp;&amp; strmatch(cidmaster-&gt;cidregistry,&quot;Adobe&quot;)==0 )</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /CIDSystemInfo &lt;&lt; /Registry (%s) /Ordering (%s) /Supplement %d &gt;&gt;\n&quot;,</span>
<span class="lineNum">    1050 </span>            :                 cidmaster-&gt;cidregistry, cidmaster-&gt;ordering, cidmaster-&gt;supplement );
<span class="lineNum">    1051 </span>            :     else
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /CIDSystemInfo &lt;&lt; /Registry (Adobe) /Ordering (Identity) /Supplement 0&gt;&gt;\n&quot; );</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /DW %d\n&quot;, defwidth );</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /W %d 0 R\n&quot;, pi-&gt;next_object );</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /FontDescriptor %d 0 R\n&quot;, fd_obj );</span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :     if ( sfbit-&gt;istype42cid )</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /CIDToGIDMap /Identity\n&quot; );</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot; );</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">    1060 </span>            : 
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :     cidmax = 0;</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :     if ( cidmaster-&gt;subfonts!=0 ) {</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;cidmaster-&gt;subfontcnt; ++i )</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :             if ( cidmax&lt;cidmaster-&gt;subfonts[i]-&gt;glyphcnt )</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :                 cidmax = cidmaster-&gt;subfonts[i]-&gt;glyphcnt;</span>
<span class="lineNum">    1066 </span>            :     } else
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :         cidmax = cidmaster-&gt;glyphcnt + 2;    /* two extra useless glyphs in ttf */</span>
<span class="lineNum">    1068 </span>            : 
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :     widths = malloc(cidmax*sizeof(uint16));</span>
<span class="lineNum">    1070 </span>            : 
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cidmax; ++i ) {</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :         SplineChar *sc = NULL;</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :         if ( cidmaster-&gt;subfonts!=0 ) {</span>
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :             for ( j=0; j&lt;cidmaster-&gt;subfontcnt; ++j )</span>
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :                 if ( i&lt;cidmaster-&gt;subfonts[j]-&gt;glyphcnt &amp;&amp;</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :                         SCWorthOutputting(cidmaster-&gt;subfonts[j]-&gt;glyphs[i]) ) {</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :                     sc = cidmaster-&gt;subfonts[j]-&gt;glyphs[i];</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1079 </span>            :                 }
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :         } else if ( i&lt;cidmaster-&gt;glyphcnt )</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :             sc = cidmaster-&gt;glyphs[i];</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :         if ( sc!=NULL )</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :             widths[i] = sc-&gt;width;</span>
<span class="lineNum">    1084 </span>            :         else
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :             widths[i] = defwidth;</span>
<span class="lineNum">    1086 </span>            :     }
<span class="lineNum">    1087 </span>            :     /* Width vector */
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  [\n&quot; );</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :     i=0;</span>
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :     while ( i&lt;cidmax ) {</span>
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :         if ( widths[i]==defwidth ) {</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :             ++i;</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    1095 </span>            :         }
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :         if ( i&lt;cidmax-1 &amp;&amp; widths[i]==widths[i+1] ) {</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :             for ( j=i; j&lt;cidmax &amp;&amp; widths[j]==widths[i]; ++j );</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :             --j;</span>
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;    %d %d %d\n&quot;, i,j, widths[i]);</span>
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :             i = j+1;</span>
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    1102 </span>            :         }
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    %d [&quot;, i );</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :         j=i;</span>
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :         while ( j==cidmax-1 || (j&lt;cidmax-1 &amp;&amp; widths[j+1]!=widths[j])) {</span>
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;%d &quot;, widths[j]);</span>
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :             ++j;</span>
<span class="lineNum">    1108 </span>            :         }
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;]\n&quot; );</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :         i = j;</span>
<span class="lineNum">    1111 </span>            :     }
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  ]\n&quot; );</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n&quot; );</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :     free(widths);</span>
<span class="lineNum">    1115 </span>            : 
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;\n&quot; );</span>
<span class="lineNum">    1117 </span>            : 
<span class="lineNum">    1118 </span>            :     /* OK, now we've dumped up the CID part, we need to create a Type0 Font */
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :     sfbit-&gt;our_font_objs = malloc(sizeof(int));</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :     sfbit-&gt;our_font_objs[0] = pi-&gt;next_object;</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :     sfbit-&gt;next_font = 1;</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &lt;&lt;\n&quot; );</span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Type /Font\n&quot; );</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Subtype /Type0\n&quot; );</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :     if ( sfbit-&gt;istype42cid )</span>
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /BaseFont /%s\n&quot;, sfbit-&gt;sf-&gt;fontname );</span>
<span class="lineNum">    1128 </span>            :     else
<span class="lineNum">    1129 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    /BaseFont /%s-Identity-H\n&quot;, cidmaster-&gt;fontname);</span>
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Encoding /Identity-H\n&quot; );</span>
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /DescendantFonts [%d 0 R]\n&quot;, cidfont_ref);</span>
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot; );</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<a name="1134"><span class="lineNum">    1134 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1135 </span>            : 
<span class="lineNum">    1136 </span><span class="lineNoCov">          0 : static void dump_pdfprologue(PI *pi) {</span>
<span class="lineNum">    1137 </span>            : /* TODO: Note, maybe this routine can be combined somehow with cvexports.c _ExportPDF() */
<span class="lineNum">    1138 </span>            :     time_t now;
<span class="lineNum">    1139 </span>            :     struct tm *tm;
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :     const char *author = GetAuthor();</span>
<span class="lineNum">    1141 </span>            :     int sfid;
<span class="lineNum">    1142 </span>            : 
<span class="lineNum">    1143 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%PDF-1.4\n%%\201\342\202\203\n&quot; ); /* Header comment + binary comment */</span>
<span class="lineNum">    1144 </span>            : 
<span class="lineNum">    1145 </span>            :     /* Output metadata */
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">    1147 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">    1148 </span><span class="lineNoCov">          0 :     if ( pi-&gt;pt==pt_fontdisplay ) {</span>
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Title (Font Display for %s)\n&quot;, pi-&gt;mainsf-&gt;fullname );</span>
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 :     } else if ( pi-&gt;pt==pt_fontsample ) {</span>
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Title (Text Sample of %s)\n&quot;, pi-&gt;mainsf-&gt;fullname );</span>
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 :     } else if ( pi-&gt;sc!=NULL )</span>
<span class="lineNum">    1153 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Title (Character Display for %s from %s)\n&quot;, pi-&gt;sc-&gt;name, pi-&gt;mainsf-&gt;fullname );</span>
<span class="lineNum">    1154 </span>            :     else
<span class="lineNum">    1155 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Title (Character Displays from %s)\n&quot;, pi-&gt;mainsf-&gt;fullname );</span>
<span class="lineNum">    1156 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Creator (FontForge)\n&quot; );</span>
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Producer (FontForge)\n&quot; );</span>
<span class="lineNum">    1158 </span><span class="lineNoCov">          0 :     time(&amp;now);</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :     tm = localtime(&amp;now);</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /CreationDate (D:%04d%02d%02d%02d%02d%02d&quot;,</span>
<span class="lineNum">    1161 </span><span class="lineNoCov">          0 :             tm-&gt;tm_year+1900, tm-&gt;tm_mon+1, tm-&gt;tm_mday, tm-&gt;tm_hour, tm-&gt;tm_min, tm-&gt;tm_sec );</span>
<span class="lineNum">    1162 </span>            : #ifdef _NO_TZSET
<span class="lineNum">    1163 </span>            :     fprintf( pi-&gt;out, &quot;Z)\n&quot; );
<span class="lineNum">    1164 </span>            : #else
<span class="lineNum">    1165 </span><span class="lineNoCov">          0 :     if ( timezone==0 )</span>
<span class="lineNum">    1166 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;Z)\n&quot; );</span>
<span class="lineNum">    1167 </span>            :     else {
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :         if ( timezone&lt;0 ) /* fprintf bug - this is a kludge to print +/- in front of a %02d-padded value */</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;-&quot; );</span>
<span class="lineNum">    1170 </span>            :         else
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;+&quot; );</span>
<span class="lineNum">    1172 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%02d'%02d')\n&quot;, (int)(timezone/3600),(int)(timezone/60-(timezone/3600)*60) );</span>
<span class="lineNum">    1173 </span>            :     }
<span class="lineNum">    1174 </span>            : #endif
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :     if ( author!=NULL )</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Author (%s)\n&quot;, author );</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<span class="lineNum">    1179 </span>            : 
<span class="lineNum">    1180 </span>            :     /* Output document catalog */
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Pages 00000 0 R\n&quot; );            /* Fix this up later */</span>
<span class="lineNum">    1184 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Type /Catalog\n&quot; );</span>
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<span class="lineNum">    1187 </span>            : 
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :     for ( sfid=0; sfid&lt;pi-&gt;sfcnt; ++sfid ) {</span>
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :         struct sfbits *sfbit = &amp;pi-&gt;sfbits[sfid];</span>
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :         if ( sfbit-&gt;fontfile!=NULL ) {</span>
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :             if ( sfbit-&gt;sf-&gt;multilayer )</span>
<span class="lineNum">    1192 </span>            :                 /* We can't use a postscript type3 font, we have to build up a  */
<span class="lineNum">    1193 </span>            :                 /* pdf font out of pdf graphics. Should be a one to one mapping */
<span class="lineNum">    1194 </span>            :                 /* but syntax is a little different. Hence we don't generate a  */
<span class="lineNum">    1195 </span>            :                 /* postscript type3 we do this instead */
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :                 pdf_gen_type3(pi,sfid);</span>
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :             else if ( sfbit-&gt;iscid )</span>
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :                 pdf_build_type0(pi,sfid);</span>
<span class="lineNum">    1199 </span>            :             else
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :                 pdf_dump_type1(pi,sfid);</span>
<span class="lineNum">    1201 </span>            :         }
<span class="lineNum">    1202 </span>            :     }
<a name="1203"><span class="lineNum">    1203 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1204 </span>            : 
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 : static void dump_pdftrailer(PI *pi) {</span>
<span class="lineNum">    1206 </span>            :     int i;
<span class="lineNum">    1207 </span>            :     int xrefloc;
<span class="lineNum">    1208 </span>            :     int sfid;
<span class="lineNum">    1209 </span>            : 
<span class="lineNum">    1210 </span>            :     /* Fix up the document catalog to point to the Pages dictionary */
<span class="lineNum">    1211 </span>            :     /*  which we will now create */
<span class="lineNum">    1212 </span>            :     /* Document catalog is object 2 */
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :     fseek(pi-&gt;out, pi-&gt;object_offsets[2], SEEK_SET );</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;2 0 obj\n&lt;&lt;\n  /Pages %05d 0 R\n&quot;, pi-&gt;next_object );</span>
<span class="lineNum">    1215 </span>            : 
<span class="lineNum">    1216 </span>            :     /* Fix up every page dictionary to point to the Pages dictionary */
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :     for ( i=0 ; i&lt;pi-&gt;next_page; ++i ) {</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :         fseek(pi-&gt;out, pi-&gt;object_offsets[pi-&gt;page_objects[i]], SEEK_SET );</span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%d 0 obj\n&lt;&lt;\n  /Parent %05d 0 R\n&quot;,</span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :                 pi-&gt;page_objects[i], pi-&gt;next_object );</span>
<span class="lineNum">    1221 </span>            :     }
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :     fseek(pi-&gt;out, 0, SEEK_END );</span>
<span class="lineNum">    1223 </span>            : 
<span class="lineNum">    1224 </span>            :     /* Now the pages dictionary */
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Type /Pages\n&quot; );</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Kids [\n&quot; );</span>
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :     for ( i=0 ; i&lt;pi-&gt;next_page; ++i )</span>
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;    %d 0 R\n&quot;, pi-&gt;page_objects[i]);</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  ]\n&quot; );</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Count %d\n&quot;, pi-&gt;next_page );</span>
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /MediaBox [0 0 %d %d]\n&quot;, pi-&gt;pagewidth, pi-&gt;pageheight );</span>
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Resources &lt;&lt;\n&quot; );</span>
<span class="lineNum">    1235 </span>            :     /* In case we have a type3 font, include the image procsets */
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /ProcSet [/PDF /Text /ImageB /ImageC /ImageI]\n&quot; );</span>
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Font &lt;&lt;\n&quot; );</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;      /FTB %d 0 R\n&quot;, pi-&gt;next_object );</span>
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :     for ( sfid=0; sfid&lt;pi-&gt;sfcnt; ++sfid ) {</span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :         struct sfbits *sfbit = &amp;pi-&gt;sfbits[sfid];</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;sfbit-&gt;next_font; ++i )</span>
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;      /F%d-%d %d 0 R\n&quot;, sfid, i, sfbit-&gt;our_font_objs[i] );</span>
<span class="lineNum">    1243 </span>            :     }
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    &gt;&gt;\n&quot; );</span>
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &gt;&gt;\n&quot; );</span>
<span class="lineNum">    1246 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<span class="lineNum">    1248 </span>            : 
<span class="lineNum">    1249 </span>            :     /* Now times bold font (which is guarantteed to be present so we don't */
<span class="lineNum">    1250 </span>            :     /* need to include it or much info about it */
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :     pdf_addobject(pi);</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&lt;&lt;\n&quot; );</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Type /Font\n&quot; );</span>
<span class="lineNum">    1254 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /Subtype /Type1\n&quot; );</span>
<span class="lineNum">    1255 </span>            :     /*fprintf( pi-&gt;out, &quot;  /Name /FTB\n&quot; );*/              /* Obsolete and not recommended (even though required in 1.0) */
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /BaseFont /Times-Bold\n&quot; );</span>
<span class="lineNum">    1257 </span>            :     /*fprintf( pi-&gt;out, &quot;  /Encoding /WinAnsiEncoding\n&quot; );*/
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;&gt;&gt;\n&quot; );</span>
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endobj\n\n&quot; );</span>
<span class="lineNum">    1260 </span>            : 
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :     xrefloc = ftell(pi-&gt;out);</span>
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;xref\n&quot; );</span>
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot; 0 %d\n&quot;, pi-&gt;next_object );</span>
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;0000000000 65535 f \n&quot; );   /* object 0 is magic */</span>
<span class="lineNum">    1265 </span><span class="lineNoCov">          0 :     for ( i=1; i&lt;pi-&gt;next_object; ++i )</span>
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%010d %05d n \n&quot;, pi-&gt;object_offsets[i], 0 );</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;trailer\n&quot; );</span>
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot; &lt;&lt;\n&quot; );</span>
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Size %d\n&quot;, pi-&gt;next_object );</span>
<span class="lineNum">    1270 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Root 2 0 R\n&quot; );</span>
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    /Info 1 0 R\n&quot; );</span>
<span class="lineNum">    1272 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot; &gt;&gt;\n&quot; );</span>
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;startxref\n&quot; );</span>
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%d\n&quot;,xrefloc );</span>
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%EOF\n&quot; );</span>
<span class="lineNum">    1276 </span>            : 
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;pi-&gt;sfcnt; ++i ) {</span>
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :         free(pi-&gt;sfbits[i].our_font_objs);</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :         free(pi-&gt;sfbits[i].fonts);</span>
<span class="lineNum">    1280 </span>            :     }
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :     free(pi-&gt;object_offsets);</span>
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 :     free(pi-&gt;page_objects);</span>
<a name="1283"><span class="lineNum">    1283 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1284 </span>            : 
<span class="lineNum">    1285 </span><span class="lineNoCov">          0 : static void DumpIdentCMap(PI *pi, int sfid) {</span>
<span class="lineNum">    1286 </span><span class="lineNoCov">          0 :     struct sfbits *sfbit = &amp;pi-&gt;sfbits[pi-&gt;sfid];</span>
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :     SplineFont *sf = sfbit-&gt;sf;</span>
<span class="lineNum">    1288 </span>            :     SplineFont *master;
<span class="lineNum">    1289 </span>            :     int i, j, k, max;
<span class="lineNum">    1290 </span>            : 
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :     master = sf-&gt;subfontcnt!=0 ? sf : sf-&gt;cidmaster;</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :     max = 0;</span>
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :     if ( sfbit-&gt;istype42cid )</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :         max = sfbit-&gt;map-&gt;enccount;</span>
<span class="lineNum">    1295 </span>            :     else {
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;sf-&gt;subfontcnt; ++i )</span>
<span class="lineNum">    1297 </span><span class="lineNoCov">          0 :             if ( sf-&gt;subfonts[i]-&gt;glyphcnt&gt;max ) max = sf-&gt;subfonts[i]-&gt;glyphcnt;</span>
<span class="lineNum">    1298 </span>            :     }
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :     sfbit-&gt;cidcnt = max;</span>
<span class="lineNum">    1300 </span>            : 
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :     if ( max&gt;65535 ) max = 65535;</span>
<span class="lineNum">    1302 </span>            : 
<span class="lineNum">    1303 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%BeginResource: CMap (Noop)\n&quot; );</span>
<span class="lineNum">    1304 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%!PS-Adobe-3.0 Resource-CMap\n&quot; );</span>
<span class="lineNum">    1305 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%BeginResource: CMap (Noop)\n&quot; );</span>
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%DocumentNeededResources: ProcSet (CIDInit)\n&quot; );</span>
<span class="lineNum">    1307 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%IncludeResource: ProcSet (CIDInit)\n&quot; );</span>
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%BeginResource: CMap (Noop)\n&quot; );</span>
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :     if ( master!=NULL &amp;&amp; master-&gt;cidregistry!=NULL )</span>
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%%%%Title: (Noop %s %s %d)\n&quot;, master-&gt;cidregistry, master-&gt;ordering, master-&gt;supplement );</span>
<span class="lineNum">    1311 </span>            :     else
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%%%%Title: (Noop Adobe Identity 0)\n&quot; );</span>
<span class="lineNum">    1313 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%EndComments\n&quot; );</span>
<span class="lineNum">    1314 </span>            : 
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;/CIDInit /ProcSet findresource begin\n&quot; );</span>
<span class="lineNum">    1316 </span>            : 
<span class="lineNum">    1317 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;12 dict begin\n&quot; );</span>
<span class="lineNum">    1318 </span>            : 
<span class="lineNum">    1319 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;begincmap\n&quot; );</span>
<span class="lineNum">    1320 </span>            : 
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;/CIDSystemInfo 3 dict dup begin\n&quot; );</span>
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :     if ( master!=NULL &amp;&amp; master-&gt;cidregistry!=NULL ) {</span>
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Registry (%s) def\n&quot;, master-&gt;cidregistry );</span>
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Ordering (%s) def\n&quot;, master-&gt;ordering );</span>
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Supplement %d def\n&quot;, master-&gt;supplement );</span>
<span class="lineNum">    1326 </span>            :     } else {
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Registry (%s) def\n&quot;, &quot;Adobe&quot; );</span>
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Ordering (%s) def\n&quot;, &quot;Identity&quot; );</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /Supplement %d def\n&quot;, 0 );</span>
<span class="lineNum">    1330 </span>            :     }
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;end def\n&quot; );</span>
<span class="lineNum">    1332 </span>            : 
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;/CMapName /Noop-%d def\n&quot;, sfid );</span>
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;/CMapVersion 1.0 def\n&quot; );</span>
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;/CMapType 1 def\n&quot; );</span>
<span class="lineNum">    1336 </span>            : 
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;1 begincodespacerange\n&quot; );</span>
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  &lt;0000&gt; &lt;%04x&gt;\n&quot;, ((max+255)&amp;0xffff00)-1 );</span>
<span class="lineNum">    1339 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endcodespacerange\n&quot; );</span>
<span class="lineNum">    1340 </span>            : 
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :     for ( j=0; j&lt;=max/256; j += 100 ) {</span>
<span class="lineNum">    1342 </span><span class="lineNoCov">          0 :         k = ( max/256-j &gt; 100 )? 100 : max/256-j;</span>
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out, &quot;%d begincidrange\n&quot;, k );</span>
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;k; ++i )</span>
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot; &lt;%04x&gt; &lt;%04x&gt; %d\n&quot;, (j+i)&lt;&lt;8, ((j+i)&lt;&lt;8)|0xff, (j+i)&lt;&lt;8 );</span>
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;endcidrange\n\n&quot; );</span>
<span class="lineNum">    1347 </span>            :     }
<span class="lineNum">    1348 </span>            : 
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;endcmap\n&quot; );</span>
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;CMapName currentdict /CMap defineresource pop\n&quot; );</span>
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;end\nend\n&quot; );</span>
<span class="lineNum">    1352 </span>            : 
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%EndResource\n&quot; );</span>
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%EndResource\n&quot; );</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%EOF\n&quot; );</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%EndResource\n&quot; );</span>
<a name="1357"><span class="lineNum">    1357 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1358 </span>            : 
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 : static void dump_prologue(PI *pi) {</span>
<span class="lineNum">    1360 </span>            :     time_t now;
<span class="lineNum">    1361 </span>            :     int ch, i, j, base, sfid;
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :     const char *author = GetAuthor();</span>
<span class="lineNum">    1363 </span>            : 
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype==pt_pdf ) {</span>
<span class="lineNum">    1365 </span><span class="lineNoCov">          0 :         dump_pdfprologue(pi);</span>
<span class="lineNum">    1366 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1367 </span>            :     }
<span class="lineNum">    1368 </span>            : 
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%!PS-Adobe-3.0\n&quot; );</span>
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%BoundingBox: 20 20 %d %d\n&quot;, pi-&gt;pagewidth-30, pi-&gt;pageheight-20 );</span>
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%Creator: FontForge\n&quot; );</span>
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :     time(&amp;now);</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%CreationDate: %s&quot;, ctime(&amp;now) );</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%DocumentData: Binary\n&quot; );</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :     if ( author!=NULL )</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%%%%For: %s\n&quot;, author);</span>
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%LanguageLevel: %d\n&quot;, 3 );</span>
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%Orientation: Portrait\n&quot; );</span>
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%Pages: (atend)\n&quot; );</span>
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :     if ( pi-&gt;pt==pt_fontdisplay ) {</span>
<span class="lineNum">    1381 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%%%%Title: Font Display for %s\n&quot;, pi-&gt;mainsf-&gt;fullname );</span>
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%%%%DocumentSuppliedResources: font %s\n&quot;, pi-&gt;mainsf-&gt;fontname );</span>
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :     } else if ( pi-&gt;pt==pt_fontsample ) {</span>
<span class="lineNum">    1384 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%%%%Title: Text Sample of %s\n&quot;, pi-&gt;mainsf-&gt;fullname );</span>
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%%%%DocumentSuppliedResources: font %s\n&quot;, pi-&gt;mainsf-&gt;fontname );</span>
<span class="lineNum">    1386 </span><span class="lineNoCov">          0 :     } else if ( pi-&gt;sc!=NULL )</span>
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%%%%Title: Character Display for %s from %s\n&quot;, pi-&gt;sc-&gt;name, pi-&gt;mainsf-&gt;fullname );</span>
<span class="lineNum">    1388 </span>            :     else
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%%%%Title: Character Displays from %s\n&quot;, pi-&gt;mainsf-&gt;fullname );</span>
<span class="lineNum">    1390 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%DocumentNeededResources: font Times-Bold\n&quot; );</span>
<span class="lineNum">    1391 </span>            :     /* Just in case they have a unicode font without dingbats */
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%DocumentNeededResources: font ZapfDingbats\n&quot; );</span>
<span class="lineNum">    1393 </span>            :     /* Just in case they have a cid keyed font */
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%DocumentNeededResources: ProcSet (CIDInit)\n&quot; );</span>
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%EndComments\n\n&quot; );</span>
<span class="lineNum">    1396 </span>            : 
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%BeginSetup\n&quot; );</span>
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :     if ( pi-&gt;hadsize )</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&lt;&lt; /PageSize [%d %d] &gt;&gt; setpagedevice\n&quot;, pi-&gt;pagewidth, pi-&gt;pageheight );</span>
<span class="lineNum">    1400 </span>            : 
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%% &lt;font&gt; &lt;encoding&gt; font_remap &lt;font&gt; ; from the cookbook\n&quot; );</span>
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;/reencodedict 5 dict def\n&quot; );</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;/font_remap { reencodedict begin\n&quot; );</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /newencoding exch def\n&quot; );</span>
<span class="lineNum">    1405 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /basefont exch def\n&quot; );</span>
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /newfont basefont  maxlength dict def\n&quot; );</span>
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  basefont {\n&quot; );</span>
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    exch dup dup /FID ne exch /Encoding ne and\n&quot; );</span>
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot; { exch newfont 3 1 roll put }\n&quot; );</span>
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot; { pop pop }\n&quot; );</span>
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;    ifelse\n&quot; );</span>
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  } forall\n&quot; );</span>
<span class="lineNum">    1413 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  newfont /Encoding newencoding put\n&quot; );</span>
<span class="lineNum">    1414 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  /foo newfont definefont        %%Leave on stack\n&quot; );</span>
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;  end } def\n&quot; );</span>
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;/n_show { moveto show } bind def\n&quot; );</span>
<span class="lineNum">    1417 </span>            : 
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%IncludeResource: font Times-Bold\n&quot; );</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;/Times-Bold-ISO-8859-1 /Times-Bold findfont ISOLatin1Encoding font_remap definefont\n&quot; );</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;/Times-Bold__12 /Times-Bold-ISO-8859-1 findfont 12 scalefont def\n&quot; );</span>
<span class="lineNum">    1421 </span>            : 
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :     if ( pi-&gt;showvm )</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot; vmstatus pop /VM1 exch def pop\n&quot; );</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :     for ( sfid=0; sfid&lt;pi-&gt;sfcnt; ++sfid ) {</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :         struct sfbits *sfbit = &amp;pi-&gt;sfbits[pi-&gt;sfid];</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :         if ( sfbit-&gt;fontfile!=NULL ) {</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;%%%%BeginResource: font %s\n&quot;, sfbit-&gt;sf-&gt;fontname );</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :             while ( (ch=getc(sfbit-&gt;fontfile))!=EOF )</span>
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :                 putc(ch,pi-&gt;out);</span>
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 :             fclose( sfbit-&gt;fontfile ); sfbit-&gt;fontfile = NULL;</span>
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;\n%%%%EndResource\n&quot; );</span>
<span class="lineNum">    1432 </span><span class="lineNoCov">          0 :             if ( sfbit-&gt;iscid )</span>
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 :                 DumpIdentCMap(pi,sfid);</span>
<span class="lineNum">    1434 </span><span class="lineNoCov">          0 :             if ( pi-&gt;pt!=pt_fontsample ) {</span>
<span class="lineNum">    1435 </span><span class="lineNoCov">          0 :                 sprintf(sfbit-&gt;psfontname,&quot;%s__%d&quot;, sfbit-&gt;sf-&gt;fontname, pi-&gt;pointsize );</span>
<span class="lineNum">    1436 </span><span class="lineNoCov">          0 :                 if ( !sfbit-&gt;iscid )</span>
<span class="lineNum">    1437 </span><span class="lineNoCov">          0 :                     fprintf(pi-&gt;out,&quot;/%s /%s findfont %d scalefont def\n&quot;,</span>
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :                             sfbit-&gt;psfontname, sfbit-&gt;sf-&gt;fontname, pi-&gt;pointsize );</span>
<span class="lineNum">    1439 </span>            :                 else
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :                     fprintf(pi-&gt;out,&quot;/%s /%s--Noop /Noop-%d [ /%s ] composefont %d scalefont def\n&quot;,</span>
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :                             sfbit-&gt;psfontname, sfbit-&gt;sf-&gt;fontname, 0, sfbit-&gt;sf-&gt;fontname, pi-&gt;pointsize );</span>
<span class="lineNum">    1442 </span>            :             }
<span class="lineNum">    1443 </span>            : 
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :             if ( !sfbit-&gt;iscid ) {</span>
<span class="lineNum">    1445 </span>            :                 /* Now see if there are any unencoded characters in the font, and if so */
<span class="lineNum">    1446 </span>            :                 /*  reencode enough fonts to display them all. These will all be 256 char fonts */
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :                 if ( sfbit-&gt;twobyte )</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :                     i = 65536;</span>
<span class="lineNum">    1449 </span>            :                 else
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :                     i = 256;</span>
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :                 for ( ; i&lt;sfbit-&gt;map-&gt;enccount; ++i ) {</span>
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :                     int gid = sfbit-&gt;map-&gt;map[i];</span>
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :                     if ( gid!=-1 &amp;&amp; SCWorthOutputting(sfbit-&gt;sf-&gt;glyphs[gid]) ) {</span>
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :                         base = i&amp;~0xff;</span>
<span class="lineNum">    1455 </span><span class="lineNoCov">          0 :                         if ( pi-&gt;pt!=pt_fontsample )</span>
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 :                             fprintf( pi-&gt;out, &quot;/%s-%x__%d /%s-%x /%s%s findfont [\n&quot;,</span>
<span class="lineNum">    1457 </span><span class="lineNoCov">          0 :                                     sfbit-&gt;sf-&gt;fontname, base&gt;&gt;8, pi-&gt;pointsize,</span>
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :                                     sfbit-&gt;sf-&gt;fontname, base&gt;&gt;8,</span>
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :                                     sfbit-&gt;sf-&gt;fontname, sfbit-&gt;twobyte?&quot;Base&quot;:&quot;&quot; );</span>
<span class="lineNum">    1460 </span>            :                         else
<span class="lineNum">    1461 </span><span class="lineNoCov">          0 :                             fprintf( pi-&gt;out, &quot;/%s-%x /%s%s findfont [\n&quot;,</span>
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :                                     sfbit-&gt;sf-&gt;fontname, base&gt;&gt;8,</span>
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :                                     sfbit-&gt;sf-&gt;fontname, sfbit-&gt;twobyte?&quot;Base&quot;:&quot;&quot; );</span>
<span class="lineNum">    1464 </span><span class="lineNoCov">          0 :                         for ( j=0; j&lt;0x100 &amp;&amp; base+j&lt;sfbit-&gt;map-&gt;enccount; ++j ) {</span>
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 :                             int gid2 = sfbit-&gt;map-&gt;map[base+j];</span>
<span class="lineNum">    1466 </span><span class="lineNoCov">          0 :                             if ( gid2!=-1 &amp;&amp; SCWorthOutputting(sfbit-&gt;sf-&gt;glyphs[gid2]))</span>
<span class="lineNum">    1467 </span><span class="lineNoCov">          0 :                                 fprintf( pi-&gt;out, &quot;\t/%s\n&quot;, sfbit-&gt;sf-&gt;glyphs[gid2]-&gt;name );</span>
<span class="lineNum">    1468 </span>            :                             else
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :                                 fprintf( pi-&gt;out, &quot;\t/.notdef\n&quot; );</span>
<span class="lineNum">    1470 </span>            :                         }
<span class="lineNum">    1471 </span><span class="lineNoCov">          0 :                         for ( ;j&lt;0x100; ++j )</span>
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :                             fprintf( pi-&gt;out, &quot;\t/.notdef\n&quot; );</span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :                         if ( pi-&gt;pt!=pt_fontsample )</span>
<span class="lineNum">    1474 </span><span class="lineNoCov">          0 :                             fprintf( pi-&gt;out, &quot; ] font_remap definefont %d scalefont def\n&quot;,</span>
<span class="lineNum">    1475 </span>            :                                     pi-&gt;pointsize );
<span class="lineNum">    1476 </span>            :                         else
<span class="lineNum">    1477 </span><span class="lineNoCov">          0 :                             fprintf( pi-&gt;out, &quot; ] font_remap definefont\n&quot; );</span>
<span class="lineNum">    1478 </span><span class="lineNoCov">          0 :                         i = base+0xff;</span>
<span class="lineNum">    1479 </span>            :                     }
<span class="lineNum">    1480 </span>            :                 }
<span class="lineNum">    1481 </span>            :             }
<span class="lineNum">    1482 </span>            :         }
<span class="lineNum">    1483 </span>            :     }
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 :     if ( pi-&gt;showvm )</span>
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;vmstatus pop dup VM1 sub (Max VMusage: ) print == flush\n&quot; );</span>
<span class="lineNum">    1486 </span>            : 
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :     fprintf( pi-&gt;out, &quot;%%%%EndSetup\n\n&quot; );</span>
<a name="1488"><span class="lineNum">    1488 </span>            : }</a>
<span class="lineNum">    1489 </span>            : 
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 : static int PIDownloadFont(PI *pi, SplineFont *sf, EncMap *map) {</span>
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :     int is_mm = sf-&gt;mm!=NULL &amp;&amp; MMValid(sf-&gt;mm,false);</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :     int error = false;</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :     struct sfbits *sfbit = &amp;pi-&gt;sfbits[pi-&gt;sfid];</span>
<span class="lineNum">    1494 </span>            : 
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :     if ( sf-&gt;cidmaster!=NULL ) sf = sf-&gt;cidmaster;</span>
<span class="lineNum">    1496 </span>            : 
<span class="lineNum">    1497 </span><span class="lineNoCov">          0 :     sfbit-&gt;sf = sf;</span>
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :     sfbit-&gt;map = map;</span>
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :     sfbit-&gt;twobyte = map-&gt;enc-&gt;has_2byte;</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :     sfbit-&gt;wastwobyte = sfbit-&gt;twobyte;</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :     sfbit-&gt;isunicode = map-&gt;enc-&gt;is_unicodebmp;</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :     sfbit-&gt;isunicodefull = map-&gt;enc-&gt;is_unicodefull;</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :     sfbit-&gt;istype42cid = sf-&gt;layers[ly_fore].order2;</span>
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :     sfbit-&gt;iscid = sf-&gt;subfontcnt!=0 || sfbit-&gt;istype42cid;</span>
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :     if ( pi-&gt;pointsize==0 )</span>
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :         pi-&gt;pointsize = sfbit-&gt;iscid &amp;&amp; !sfbit-&gt;istype42cid?18:20;             /* 18 fits 20 across, 20 fits 16 */</span>
<span class="lineNum">    1507 </span>            : 
<span class="lineNum">    1508 </span><span class="lineNoCov">          0 :     sfbit-&gt;fontfile = tmpfile();</span>
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 :     if ( sfbit-&gt;fontfile==NULL ) {</span>
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :         ff_post_error(_(&quot;Failed to open temporary output file&quot;),_(&quot;Failed to open temporary output file&quot;));</span>
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 : return(false);</span>
<span class="lineNum">    1512 </span>            :     }
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :     if ( pi-&gt;sfid==0 )</span>
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :         ff_progress_start_indicator(10,_(&quot;Printing Font&quot;),_(&quot;Printing Font&quot;),</span>
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :                 _(&quot;Generating PostScript Font&quot;),sf-&gt;glyphcnt,1);</span>
<span class="lineNum">    1516 </span>            :     else
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :         ff_progress_reset();</span>
<span class="lineNum">    1518 </span><span class="lineNoCov">          0 :     ff_progress_enable_stop(false);</span>
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype==pt_pdf &amp;&amp; sf-&gt;multilayer ) {</span>
<span class="lineNum">    1520 </span>            :         /* These need to be done in line as pdf objects */
<span class="lineNum">    1521 </span>            :         /* I leave fontfile open as a flag, even though we don't use it */
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :     } else if ( pi-&gt;printtype==pt_pdf &amp;&amp; sfbit-&gt;iscid ) {</span>
<span class="lineNum">    1523 </span><span class="lineNoCov">          0 :         if ( !_WriteTTFFont(sfbit-&gt;fontfile,sf,</span>
<span class="lineNum">    1524 </span><span class="lineNoCov">          0 :                 sfbit-&gt;istype42cid?ff_type42cid:ff_cffcid,NULL,bf_none,</span>
<span class="lineNum">    1525 </span>            :                 ps_flag_nocffsugar,map,ly_fore))
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :             error = true;</span>
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :     } else if ( !_WritePSFont(sfbit-&gt;fontfile,sf,</span>
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :                 pi-&gt;printtype==pt_pdf ? ff_pfb :</span>
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :                 sf-&gt;multilayer?ff_ptype3:</span>
<span class="lineNum">    1530 </span>            :                 is_mm?ff_mma:
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 :                 sfbit-&gt;istype42cid?ff_type42cid:</span>
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :                 sfbit-&gt;iscid?ff_cid:</span>
<span class="lineNum">    1533 </span><span class="lineNoCov">          0 :                 sfbit-&gt;twobyte?ff_ptype0:</span>
<span class="lineNum">    1534 </span>            :                 ff_pfa,ps_flag_identitycidmap,map,NULL,ly_fore))
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :         error = true;</span>
<span class="lineNum">    1536 </span>            : 
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :     ff_progress_end_indicator();</span>
<span class="lineNum">    1538 </span>            : 
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 :     if ( error ) {</span>
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :         ff_post_error(_(&quot;Failed to generate postscript font&quot;),_(&quot;Failed to generate postscript font&quot;) );</span>
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 :         fclose(sfbit-&gt;fontfile);</span>
<span class="lineNum">    1542 </span><span class="lineNoCov">          0 : return(false);</span>
<span class="lineNum">    1543 </span>            :     }
<span class="lineNum">    1544 </span>            : 
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :     rewind(sfbit-&gt;fontfile);</span>
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :     ++ pi-&gt;sfcnt;</span>
<span class="lineNum">    1547 </span><span class="lineNoCov">          0 : return( true );</span>
<a name="1548"><span class="lineNum">    1548 </span>            : }</a>
<span class="lineNum">    1549 </span>            : 
<span class="lineNum">    1550 </span><span class="lineNoCov">          0 : static void endpage(PI *pi ) {</span>
<span class="lineNum">    1551 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype!=pt_pdf )</span>
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;showpage cleartomark restore\t\t%%End of Page\n&quot; );</span>
<span class="lineNum">    1553 </span>            :     else
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 :         pdf_finishpage(pi);</span>
<a name="1555"><span class="lineNum">    1555 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1556 </span>            : 
<span class="lineNum">    1557 </span><span class="lineNoCov">          0 : static void dump_trailer(PI *pi) {</span>
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :     if ( pi-&gt;page!=0 )</span>
<span class="lineNum">    1559 </span><span class="lineNoCov">          0 :         endpage(pi);</span>
<span class="lineNum">    1560 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype==pt_pdf )</span>
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :         dump_pdftrailer(pi);</span>
<span class="lineNum">    1562 </span>            :     else {
<span class="lineNum">    1563 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%%%%Trailer\n&quot; );</span>
<span class="lineNum">    1564 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%%%%Pages: %d\n&quot;, pi-&gt;page );</span>
<span class="lineNum">    1565 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%%%%EOF\n&quot; );</span>
<span class="lineNum">    1566 </span>            :     }
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1568 </span>            : 
<span class="lineNum">    1569 </span>            : /* ************************************************************************** */
<span class="lineNum">    1570 </span>            : /* ************************* Code for full font dump ************************ */
<a name="1571"><span class="lineNum">    1571 </span>            : /* ************************************************************************** */</a>
<span class="lineNum">    1572 </span>            : 
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 : static void startpage(PI *pi ) {</span>
<span class="lineNum">    1574 </span>            :     int i;
<span class="lineNum">    1575 </span>            :     /* I used to have a progress indicator here showing pages. But they went */
<span class="lineNum">    1576 </span>            :     /*  by so fast that even for CaslonRoman it was pointless */
<span class="lineNum">    1577 </span>            : 
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :     if ( pi-&gt;page!=0 )</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :         endpage(pi);</span>
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :     ++pi-&gt;page;</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :     pi-&gt;ypos = -60-.9*pi-&gt;pointsize;</span>
<span class="lineNum">    1582 </span>            : 
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype==pt_pdf ) {</span>
<span class="lineNum">    1584 </span><span class="lineNoCov">          0 :         pdf_addpage(pi);</span>
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :         if ( pi-&gt;pt == pt_chars )</span>
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;q 1 0 0 1 40 %d cm\n&quot;, pi-&gt;pageheight-54 );</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;BT\n  /FTB 12 Tf\n  193.2 -10.92 Td\n&quot; );</span>
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;(Font Display for %s) Tj\n&quot;, pi-&gt;mainsf-&gt;fontname );</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;-159.8 -43.98 Td\n&quot; );</span>
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :         if ( pi-&gt;sfbits[0].iscid &amp;&amp; !pi-&gt;sfbits[0].istype42cid)</span>
<span class="lineNum">    1592 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;pi-&gt;max; ++i )</span>
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :                 fprintf(pi-&gt;out,&quot;%d 0 Td (%d) Tj\n&quot;, (pi-&gt;pointsize+pi-&gt;extrahspace), i );</span>
<span class="lineNum">    1594 </span>            :         else
<span class="lineNum">    1595 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;pi-&gt;max; ++i )</span>
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 :                 fprintf(pi-&gt;out,&quot;%d 0 Td (%X) Tj\n&quot;, (pi-&gt;pointsize+pi-&gt;extrahspace), i );</span>
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;ET\n&quot; );</span>
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1599 </span>            :     }
<span class="lineNum">    1600 </span>            : 
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :     fprintf(pi-&gt;out,&quot;%%%%Page: %d %d\n&quot;, pi-&gt;page, pi-&gt;page );</span>
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :     fprintf(pi-&gt;out,&quot;%%%%PageResources: font Times-Bold font %s\n&quot;, pi-&gt;mainsf-&gt;fontname );</span>
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :     fprintf(pi-&gt;out,&quot;save mark\n&quot; );</span>
<span class="lineNum">    1604 </span><span class="lineNoCov">          0 :     fprintf(pi-&gt;out,&quot;40 %d translate\n&quot;, pi-&gt;pageheight-54 );</span>
<span class="lineNum">    1605 </span><span class="lineNoCov">          0 :     fprintf(pi-&gt;out,&quot;Times-Bold__12 setfont\n&quot; );</span>
<span class="lineNum">    1606 </span><span class="lineNoCov">          0 :     fprintf(pi-&gt;out,&quot;(Font Display for %s) 193.2 -10.92 n_show\n&quot;, pi-&gt;mainsf-&gt;fontname);</span>
<span class="lineNum">    1607 </span>            : 
<span class="lineNum">    1608 </span><span class="lineNoCov">          0 :     if ( pi-&gt;sfbits[0].iscid &amp;&amp; !pi-&gt;sfbits[0].istype42cid )</span>
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;pi-&gt;max; ++i )</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;(%d) %d -54.84 n_show\n&quot;, i, 60+(pi-&gt;pointsize+pi-&gt;extrahspace)*i );</span>
<span class="lineNum">    1611 </span>            :     else
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;pi-&gt;max; ++i )</span>
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;(%X) %d -54.84 n_show\n&quot;, i, 60+(pi-&gt;pointsize+pi-&gt;extrahspace)*i );</span>
<a name="1614"><span class="lineNum">    1614 </span>            : }</a>
<span class="lineNum">    1615 </span>            : 
<span class="lineNum">    1616 </span><span class="lineNoCov">          0 : static int DumpLine(PI *pi) {</span>
<span class="lineNum">    1617 </span><span class="lineNoCov">          0 :     int i=0, line, gid;</span>
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :     struct sfbits *sfbit = &amp;pi-&gt;sfbits[0];</span>
<span class="lineNum">    1619 </span>            : 
<span class="lineNum">    1620 </span>            :     /* First find the next line with stuff on it */
<span class="lineNum">    1621 </span><span class="lineNoCov">          0 :     if ( !sfbit-&gt;iscid || sfbit-&gt;istype42cid ) {</span>
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 :         for ( line = pi-&gt;chline ; line&lt;sfbit-&gt;map-&gt;enccount; line += pi-&gt;max ) {</span>
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;pi-&gt;max &amp;&amp; line+i&lt;sfbit-&gt;map-&gt;enccount; ++i )</span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :                 if ( (gid=sfbit-&gt;map-&gt;map[line+i])!=-1 )</span>
<span class="lineNum">    1625 </span><span class="lineNoCov">          0 :                     if ( SCWorthOutputting(sfbit-&gt;sf-&gt;glyphs[gid]) )</span>
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1627 </span><span class="lineNoCov">          0 :             if ( i!=pi-&gt;max )</span>
<span class="lineNum">    1628 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1629 </span>            :         }
<span class="lineNum">    1630 </span>            :     } else {
<span class="lineNum">    1631 </span><span class="lineNoCov">          0 :         for ( line = pi-&gt;chline ; line&lt;sfbit-&gt;cidcnt; line += pi-&gt;max ) {</span>
<span class="lineNum">    1632 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;pi-&gt;max &amp;&amp; line+i&lt;sfbit-&gt;cidcnt; ++i )</span>
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :                 if ( CIDWorthOutputting(sfbit-&gt;sf,line+i)!= -1 )</span>
<span class="lineNum">    1634 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :             if ( i!=pi-&gt;max )</span>
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1637 </span>            :         }
<span class="lineNum">    1638 </span>            :     }
<span class="lineNum">    1639 </span><span class="lineNoCov">          0 :     if ( line+i&gt;=sfbit-&gt;cidcnt )          /* Nothing more */</span>
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 : return(0);</span>
<span class="lineNum">    1641 </span>            : 
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 :     if ( sfbit-&gt;iscid )</span>
<span class="lineNum">    1643 </span>            :         /* No encoding worries */;
<span class="lineNum">    1644 </span><span class="lineNoCov">          0 :     else if ( (sfbit-&gt;wastwobyte &amp;&amp; line&gt;=65536) || ( !sfbit-&gt;wastwobyte &amp;&amp; line&gt;=256 ) ) {</span>
<span class="lineNum">    1645 </span>            :         /* Nothing more encoded. Can't use the normal font, must use one of */
<span class="lineNum">    1646 </span>            :         /*  the funky reencodings we built up at the beginning */
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :         if ( pi-&gt;lastbase!=(line&gt;&gt;8) ) {</span>
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :             if ( !pi-&gt;overflow ) {</span>
<span class="lineNum">    1649 </span>            :                 /* draw a line to indicate the end of the encoding */
<span class="lineNum">    1650 </span>            :                 /* but we've still got more (unencoded) glyphs coming */
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :                 if ( pi-&gt;printtype==pt_pdf ) {</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :                     fprintf( pi-&gt;out, &quot;%d %d m %d %d l S\n&quot;,</span>
<span class="lineNum">    1653 </span><span class="lineNoCov">          0 :                         100, pi-&gt;ypos+8*pi-&gt;pointsize/10-1, 400, pi-&gt;ypos+8*pi-&gt;pointsize/10-1 );</span>
<span class="lineNum">    1654 </span>            :                 } else
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :                     fprintf( pi-&gt;out, &quot;%d %d moveto %d %d rlineto stroke\n&quot;,</span>
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 :                         100, pi-&gt;ypos+8*pi-&gt;pointsize/10-1, 300, 0 );</span>
<span class="lineNum">    1657 </span><span class="lineNoCov">          0 :                 pi-&gt;ypos -= 5;</span>
<span class="lineNum">    1658 </span>            :             }
<span class="lineNum">    1659 </span><span class="lineNoCov">          0 :             pi-&gt;overflow = true;</span>
<span class="lineNum">    1660 </span><span class="lineNoCov">          0 :             pi-&gt;lastbase = (line&gt;&gt;8);</span>
<span class="lineNum">    1661 </span><span class="lineNoCov">          0 :             sprintf(sfbit-&gt;psfontname,&quot;%s-%x__%d&quot;, sfbit-&gt;sf-&gt;fontname, pi-&gt;lastbase,</span>
<span class="lineNum">    1662 </span>            :                     pi-&gt;pointsize );
<span class="lineNum">    1663 </span>            :         }
<span class="lineNum">    1664 </span>            :     }
<span class="lineNum">    1665 </span>            : 
<span class="lineNum">    1666 </span><span class="lineNoCov">          0 :     if ( pi-&gt;chline==0 ) {</span>
<span class="lineNum">    1667 </span>            :         /* start the first page */
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 :         startpage(pi);</span>
<span class="lineNum">    1669 </span>            :     } else {
<span class="lineNum">    1670 </span>            :         /* start subsequent pages by displaying the one before */
<span class="lineNum">    1671 </span><span class="lineNoCov">          0 :         if ( pi-&gt;ypos - pi-&gt;pointsize &lt; -(pi-&gt;pageheight-90) ) {</span>
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :             startpage(pi);</span>
<span class="lineNum">    1673 </span>            :         }
<span class="lineNum">    1674 </span>            :     }
<span class="lineNum">    1675 </span><span class="lineNoCov">          0 :     pi-&gt;chline = line;</span>
<span class="lineNum">    1676 </span>            : 
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype==pt_pdf ) {</span>
<span class="lineNum">    1678 </span><span class="lineNoCov">          0 :         int lastfont = -1;</span>
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 :         if ( !pi-&gt;overflow || (line&lt;17*65536 &amp;&amp; sfbit-&gt;isunicodefull)) {</span>
<span class="lineNum">    1680 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out, &quot;BT\n  /FTB 12 Tf\n  26.88 %d Td\n&quot;, pi-&gt;ypos );</span>
<span class="lineNum">    1681 </span><span class="lineNoCov">          0 :             if ( sfbit-&gt;iscid &amp;&amp; !sfbit-&gt;istype42cid )</span>
<span class="lineNum">    1682 </span><span class="lineNoCov">          0 :                 fprintf(pi-&gt;out,&quot;(%d) Tj\n&quot;, pi-&gt;chline );</span>
<span class="lineNum">    1683 </span>            :             else
<span class="lineNum">    1684 </span><span class="lineNoCov">          0 :                 fprintf(pi-&gt;out,&quot;(%04X) Tj\n&quot;, pi-&gt;chline );</span>
<span class="lineNum">    1685 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out, &quot;ET\n&quot; );</span>
<span class="lineNum">    1686 </span>            :         }
<span class="lineNum">    1687 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out, &quot;BT\n  %d %d Td\n&quot;, 58-(pi-&gt;pointsize+pi-&gt;extrahspace), pi-&gt;ypos );</span>
<span class="lineNum">    1688 </span><span class="lineNoCov">          0 :         if ( sfbit-&gt;iscid )</span>
<span class="lineNum">    1689 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out, &quot;  /F0 %d Tf\n&quot;, pi-&gt;pointsize );</span>
<span class="lineNum">    1690 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;pi-&gt;max ; ++i ) {</span>
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;  %d 0 TD\n&quot;, pi-&gt;pointsize+pi-&gt;extrahspace );</span>
<span class="lineNum">    1692 </span><span class="lineNoCov">          0 :             if ( i+pi-&gt;chline&lt;sfbit-&gt;cidcnt &amp;&amp;</span>
<span class="lineNum">    1693 </span><span class="lineNoCov">          0 :                         ((sfbit-&gt;iscid &amp;&amp; !sfbit-&gt;istype42cid &amp;&amp; CIDWorthOutputting(sfbit-&gt;sf,i+pi-&gt;chline)!=-1) ||</span>
<span class="lineNum">    1694 </span><span class="lineNoCov">          0 :                          ((!sfbit-&gt;iscid || sfbit-&gt;istype42cid) &amp;&amp; (gid=sfbit-&gt;map-&gt;map[i+pi-&gt;chline])!=-1 &amp;&amp;</span>
<span class="lineNum">    1695 </span><span class="lineNoCov">          0 :                                  SCWorthOutputting(sfbit-&gt;sf-&gt;glyphs[gid]))) ) {</span>
<span class="lineNum">    1696 </span>            :                 /*int x = 58 + i*(pi-&gt;pointsize+pi-&gt;extrahspace);*/
<span class="lineNum">    1697 </span><span class="lineNoCov">          0 :                 if ( !sfbit-&gt;iscid &amp;&amp; (i+pi-&gt;chline)/256 != lastfont ) {</span>
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :                     lastfont = (i+pi-&gt;chline)/256;</span>
<span class="lineNum">    1699 </span><span class="lineNoCov">          0 :                     fprintf(pi-&gt;out, &quot;  /F%d-%d %d Tf\n&quot;, pi-&gt;sfid, sfbit-&gt;fonts[lastfont], pi-&gt;pointsize );</span>
<span class="lineNum">    1700 </span>            :                 }
<span class="lineNum">    1701 </span><span class="lineNoCov">          0 :                 if ( sfbit-&gt;istype42cid ) {</span>
<span class="lineNum">    1702 </span><span class="lineNoCov">          0 :                     int gid = sfbit-&gt;map-&gt;map[pi-&gt;chline+i];</span>
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :                     SplineChar *sc = gid==-1? NULL : sfbit-&gt;sf-&gt;glyphs[gid];</span>
<span class="lineNum">    1704 </span><span class="lineNoCov">          0 :                     fprintf( pi-&gt;out, &quot;  &lt;%04x&gt; Tj\n&quot;, sc==NULL ? 0 : sc-&gt;ttf_glyph );</span>
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 :                 } else if ( sfbit-&gt;iscid )</span>
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :                     fprintf( pi-&gt;out, &quot;  &lt;%04x&gt; Tj\n&quot;, pi-&gt;chline+i );</span>
<span class="lineNum">    1707 </span>            :                 else
<span class="lineNum">    1708 </span><span class="lineNoCov">          0 :                     fprintf( pi-&gt;out, &quot;  &lt;%02x&gt; Tj\n&quot;, (pi-&gt;chline+i)%256 );</span>
<span class="lineNum">    1709 </span>            :             }
<span class="lineNum">    1710 </span>            :         }
<span class="lineNum">    1711 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out, &quot;ET\n&quot; );</span>
<span class="lineNum">    1712 </span>            :     } else {
<span class="lineNum">    1713 </span><span class="lineNoCov">          0 :         if ( !pi-&gt;overflow || (line&lt;17*65536 &amp;&amp; sfbit-&gt;isunicodefull)) {</span>
<span class="lineNum">    1714 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;Times-Bold__12 setfont\n&quot; );</span>
<span class="lineNum">    1715 </span><span class="lineNoCov">          0 :             if ( sfbit-&gt;iscid &amp;&amp; !sfbit-&gt;istype42cid )</span>
<span class="lineNum">    1716 </span><span class="lineNoCov">          0 :                 fprintf(pi-&gt;out,&quot;(%d) 26.88 %d n_show\n&quot;, pi-&gt;chline, pi-&gt;ypos );</span>
<span class="lineNum">    1717 </span>            :             else
<span class="lineNum">    1718 </span><span class="lineNoCov">          0 :                 fprintf(pi-&gt;out,&quot;(%04X) 26.88 %d n_show\n&quot;, pi-&gt;chline, pi-&gt;ypos );</span>
<span class="lineNum">    1719 </span>            :         }
<span class="lineNum">    1720 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%s setfont\n&quot;, sfbit-&gt;psfontname );</span>
<span class="lineNum">    1721 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;pi-&gt;max ; ++i ) {</span>
<span class="lineNum">    1722 </span><span class="lineNoCov">          0 :             if ( i+pi-&gt;chline&lt;sfbit-&gt;cidcnt &amp;&amp;</span>
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :                         ((sfbit-&gt;iscid &amp;&amp; !sfbit-&gt;istype42cid &amp;&amp; CIDWorthOutputting(sfbit-&gt;sf,i+pi-&gt;chline)!=-1) ||</span>
<span class="lineNum">    1724 </span><span class="lineNoCov">          0 :                          ((!sfbit-&gt;iscid || sfbit-&gt;istype42cid) &amp;&amp; (gid=sfbit-&gt;map-&gt;map[i+pi-&gt;chline])!=-1 &amp;&amp;</span>
<span class="lineNum">    1725 </span><span class="lineNoCov">          0 :                                  SCWorthOutputting(sfbit-&gt;sf-&gt;glyphs[gid]))) ) {</span>
<span class="lineNum">    1726 </span><span class="lineNoCov">          0 :                 int x = 58 + i*(pi-&gt;pointsize+pi-&gt;extrahspace);</span>
<span class="lineNum">    1727 </span><span class="lineNoCov">          0 :                 if ( sfbit-&gt;istype42cid ) {</span>
<span class="lineNum">    1728 </span><span class="lineNoCov">          0 :                     int gid = sfbit-&gt;map-&gt;map[pi-&gt;chline+i];</span>
<span class="lineNum">    1729 </span><span class="lineNoCov">          0 :                     if ( gid!=-1 ) gid = sfbit-&gt;sf-&gt;glyphs[gid]-&gt;ttf_glyph;</span>
<span class="lineNum">    1730 </span><span class="lineNoCov">          0 :                     fprintf( pi-&gt;out, &quot;&lt;%04x&gt; %d %d n_show\n&quot;, gid==-1?0:gid,</span>
<span class="lineNum">    1731 </span>            :                             x, pi-&gt;ypos );
<span class="lineNum">    1732 </span><span class="lineNoCov">          0 :                 } else if ( pi-&gt;overflow ) {</span>
<span class="lineNum">    1733 </span><span class="lineNoCov">          0 :                     fprintf( pi-&gt;out, &quot;&lt;%02x&gt; %d %d n_show\n&quot;, pi-&gt;chline +i-(pi-&gt;lastbase&lt;&lt;8),</span>
<span class="lineNum">    1734 </span>            :                             x, pi-&gt;ypos );
<span class="lineNum">    1735 </span><span class="lineNoCov">          0 :                 } else if ( sfbit-&gt;iscid ) {</span>
<span class="lineNum">    1736 </span><span class="lineNoCov">          0 :                     fprintf( pi-&gt;out, &quot;&lt;%04x&gt; %d %d n_show\n&quot;, pi-&gt;chline +i,</span>
<span class="lineNum">    1737 </span>            :                             x, pi-&gt;ypos );
<span class="lineNum">    1738 </span><span class="lineNoCov">          0 :                 } else if ( sfbit-&gt;twobyte ) {</span>
<span class="lineNum">    1739 </span><span class="lineNoCov">          0 :                     fprintf( pi-&gt;out, &quot;&lt;%04x&gt; %d %d n_show\n&quot;, pi-&gt;chline +i,</span>
<span class="lineNum">    1740 </span>            :                             x, pi-&gt;ypos );
<span class="lineNum">    1741 </span>            :                 } else {
<span class="lineNum">    1742 </span><span class="lineNoCov">          0 :                     fprintf( pi-&gt;out, &quot;&lt;%02x&gt; %d %d n_show\n&quot;, pi-&gt;chline +i,</span>
<span class="lineNum">    1743 </span>            :                             x, pi-&gt;ypos );
<span class="lineNum">    1744 </span>            :                 }
<span class="lineNum">    1745 </span>            :             }
<span class="lineNum">    1746 </span>            :         }
<span class="lineNum">    1747 </span>            :     }
<span class="lineNum">    1748 </span><span class="lineNoCov">          0 :     pi-&gt;ypos -= pi-&gt;pointsize+pi-&gt;extravspace;</span>
<span class="lineNum">    1749 </span><span class="lineNoCov">          0 :     pi-&gt;chline += pi-&gt;max;</span>
<span class="lineNum">    1750 </span><span class="lineNoCov">          0 : return(true);</span>
<a name="1751"><span class="lineNum">    1751 </span>            : }</a>
<span class="lineNum">    1752 </span>            : 
<span class="lineNum">    1753 </span><span class="lineNoCov">          0 : static void PIFontDisplay(PI *pi) {</span>
<span class="lineNum">    1754 </span><span class="lineNoCov">          0 :     SplineFont *sf = pi-&gt;mainsf;</span>
<span class="lineNum">    1755 </span>            : 
<span class="lineNum">    1756 </span><span class="lineNoCov">          0 :     if ( !PIDownloadFont(pi,sf,pi-&gt;mainmap))</span>
<span class="lineNum">    1757 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1758 </span><span class="lineNoCov">          0 :     dump_prologue(pi);</span>
<span class="lineNum">    1759 </span>            : 
<span class="lineNum">    1760 </span><span class="lineNoCov">          0 :     pi-&gt;extravspace = pi-&gt;pointsize/6;</span>
<span class="lineNum">    1761 </span><span class="lineNoCov">          0 :     pi-&gt;extrahspace = pi-&gt;pointsize/3;</span>
<span class="lineNum">    1762 </span><span class="lineNoCov">          0 :     pi-&gt;max = (pi-&gt;pagewidth-100)/(pi-&gt;extrahspace+pi-&gt;pointsize);</span>
<span class="lineNum">    1763 </span><span class="lineNoCov">          0 :     pi-&gt;sfbits[0].cidcnt = pi-&gt;sfbits[0].map-&gt;enccount;</span>
<span class="lineNum">    1764 </span><span class="lineNoCov">          0 :     if ( sf-&gt;subfontcnt!=0 &amp;&amp; pi-&gt;sfbits[0].iscid ) {</span>
<span class="lineNum">    1765 </span><span class="lineNoCov">          0 :         int i,max=0;</span>
<span class="lineNum">    1766 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;sf-&gt;subfontcnt; ++i )</span>
<span class="lineNum">    1767 </span><span class="lineNoCov">          0 :             if ( sf-&gt;subfonts[i]-&gt;glyphcnt&gt;max )</span>
<span class="lineNum">    1768 </span><span class="lineNoCov">          0 :                 max = sf-&gt;subfonts[i]-&gt;glyphcnt;</span>
<span class="lineNum">    1769 </span><span class="lineNoCov">          0 :         pi-&gt;sfbits[0].cidcnt = max;</span>
<span class="lineNum">    1770 </span>            :     }
<span class="lineNum">    1771 </span>            : 
<span class="lineNum">    1772 </span><span class="lineNoCov">          0 :     if ( pi-&gt;sfbits[0].iscid &amp;&amp; !pi-&gt;sfbits[0].istype42cid ) {</span>
<span class="lineNum">    1773 </span><span class="lineNoCov">          0 :         if ( pi-&gt;max&gt;=20 ) pi-&gt;max = 20;</span>
<span class="lineNum">    1774 </span><span class="lineNoCov">          0 :         else if ( pi-&gt;max&gt;=10 ) pi-&gt;max = 10;</span>
<span class="lineNum">    1775 </span><span class="lineNoCov">          0 :         else if ( pi-&gt;max &gt;= 5 ) pi-&gt;max = 5;</span>
<span class="lineNum">    1776 </span><span class="lineNoCov">          0 :         else if ( pi-&gt;max &gt;= 2 ) pi-&gt;max = 2;</span>
<span class="lineNum">    1777 </span>            :     } else {
<span class="lineNum">    1778 </span><span class="lineNoCov">          0 :         if ( pi-&gt;max&gt;=32 ) pi-&gt;max = 32;</span>
<span class="lineNum">    1779 </span><span class="lineNoCov">          0 :         else if ( pi-&gt;max&gt;=16 ) pi-&gt;max = 16;</span>
<span class="lineNum">    1780 </span><span class="lineNoCov">          0 :         else if ( pi-&gt;max&gt;=8 ) pi-&gt;max = 8;</span>
<span class="lineNum">    1781 </span><span class="lineNoCov">          0 :         else if ( pi-&gt;max &gt;= 4 ) pi-&gt;max = 4;</span>
<span class="lineNum">    1782 </span><span class="lineNoCov">          0 :         else if ( pi-&gt;max &gt;= 2 ) pi-&gt;max = 2;</span>
<span class="lineNum">    1783 </span>            :     }
<span class="lineNum">    1784 </span>            : 
<span class="lineNum">    1785 </span><span class="lineNoCov">          0 :     while ( DumpLine(pi))</span>
<span class="lineNum">    1786 </span>            :         ;
<span class="lineNum">    1787 </span>            : 
<span class="lineNum">    1788 </span><span class="lineNoCov">          0 :     if ( pi-&gt;chline==0 )</span>
<span class="lineNum">    1789 </span><span class="lineNoCov">          0 :         ff_post_notice(_(&quot;Print Failed&quot;),_(&quot;Warning: Font contained no glyphs&quot;));</span>
<span class="lineNum">    1790 </span>            :     else
<span class="lineNum">    1791 </span><span class="lineNoCov">          0 :         dump_trailer(pi);</span>
<span class="lineNum">    1792 </span>            : }
<span class="lineNum">    1793 </span>            : 
<span class="lineNum">    1794 </span>            : /* ************************************************************************** */
<span class="lineNum">    1795 </span>            : /* ********************* Code for single character dump ********************* */
<a name="1796"><span class="lineNum">    1796 </span>            : /* ************************************************************************** */</a>
<span class="lineNum">    1797 </span>            : 
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 : static void SCPrintPage(PI *pi,SplineChar *sc) {</span>
<span class="lineNum">    1799 </span>            :     DBounds b, page;
<span class="lineNum">    1800 </span>            :     real scalex, scaley;
<span class="lineNum">    1801 </span>            : 
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :     if ( pi-&gt;page!=0 )</span>
<span class="lineNum">    1803 </span><span class="lineNoCov">          0 :         endpage(pi);</span>
<span class="lineNum">    1804 </span><span class="lineNoCov">          0 :     ++pi-&gt;page;</span>
<span class="lineNum">    1805 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype!=pt_pdf ) {</span>
<span class="lineNum">    1806 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%%%%Page: %d %d\n&quot;, pi-&gt;page, pi-&gt;page );</span>
<span class="lineNum">    1807 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%%%%PageResources: font Times-Bold\n&quot; );</span>
<span class="lineNum">    1808 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;save mark\n&quot; );</span>
<span class="lineNum">    1809 </span>            :     } else {
<span class="lineNum">    1810 </span><span class="lineNoCov">          0 :         startpage(pi);</span>
<span class="lineNum">    1811 </span>            :     }
<span class="lineNum">    1812 </span>            : 
<span class="lineNum">    1813 </span><span class="lineNoCov">          0 :     SplineCharFindBounds(sc,&amp;b);</span>
<span class="lineNum">    1814 </span><span class="lineNoCov">          0 :     if ( b.maxy&lt;sc-&gt;parent-&gt;ascent+5 ) b.maxy = sc-&gt;parent-&gt;ascent + 5;</span>
<span class="lineNum">    1815 </span><span class="lineNoCov">          0 :     if ( b.miny&gt;-sc-&gt;parent-&gt;descent ) b.miny =-sc-&gt;parent-&gt;descent - 5;</span>
<span class="lineNum">    1816 </span><span class="lineNoCov">          0 :     if ( b.minx&gt;00 ) b.minx = -5;</span>
<span class="lineNum">    1817 </span><span class="lineNoCov">          0 :     if ( b.maxx&lt;=0 ) b.maxx = 5;</span>
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :     if ( b.maxx&lt;=sc-&gt;width+5 ) b.maxx = sc-&gt;width+5;</span>
<span class="lineNum">    1819 </span>            : 
<span class="lineNum">    1820 </span>            :     /* From the default bounding box */
<span class="lineNum">    1821 </span><span class="lineNoCov">          0 :     page.minx = 40; page.maxx = pi-&gt;pagewidth-15;</span>
<span class="lineNum">    1822 </span><span class="lineNoCov">          0 :     page.miny = 20; page.maxy = pi-&gt;pageheight-20;</span>
<span class="lineNum">    1823 </span>            : 
<span class="lineNum">    1824 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype!=pt_pdf ) {</span>
<span class="lineNum">    1825 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;Times-Bold__12 setfont\n&quot; );</span>
<span class="lineNum">    1826 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;(%s from %s) 80 %g n_show\n&quot;, sc-&gt;name, sc-&gt;parent-&gt;fullname, (double) (page.maxy-12) );</span>
<span class="lineNum">    1827 </span>            :     } else {
<span class="lineNum">    1828 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;BT\n&quot; );</span>
<span class="lineNum">    1829 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  /FTB 12 Tf\n&quot; );</span>
<span class="lineNum">    1830 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  80 %g Td\n&quot;, (double) (page.maxy-12) );</span>
<span class="lineNum">    1831 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;  (%s from %s) Tj\n&quot;, sc-&gt;name, sc-&gt;parent-&gt;fullname );</span>
<span class="lineNum">    1832 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;ET\n&quot; );</span>
<span class="lineNum">    1833 </span>            :     }
<span class="lineNum">    1834 </span><span class="lineNoCov">          0 :     page.maxy -= 20;</span>
<span class="lineNum">    1835 </span>            : 
<span class="lineNum">    1836 </span><span class="lineNoCov">          0 :     scalex = (page.maxx-page.minx)/(b.maxx-b.minx);</span>
<span class="lineNum">    1837 </span><span class="lineNoCov">          0 :     scaley = (page.maxy-page.miny)/(b.maxy-b.miny);</span>
<span class="lineNum">    1838 </span><span class="lineNoCov">          0 :     pi-&gt;scale = (scalex&lt;scaley)?scalex:scaley;</span>
<span class="lineNum">    1839 </span><span class="lineNoCov">          0 :     pi-&gt;xoff = page.minx - b.minx*pi-&gt;scale;</span>
<span class="lineNum">    1840 </span><span class="lineNoCov">          0 :     pi-&gt;yoff = page.miny - b.miny*pi-&gt;scale;</span>
<span class="lineNum">    1841 </span>            : 
<span class="lineNum">    1842 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype!=pt_pdf ) {</span>
<span class="lineNum">    1843 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;gsave .2 setlinewidth\n&quot; );</span>
<span class="lineNum">    1844 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%g %g moveto %g %g lineto stroke\n&quot;, (double) page.minx, (double) pi-&gt;yoff, (double) page.maxx, (double) pi-&gt;yoff );</span>
<span class="lineNum">    1845 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%g %g moveto %g %g lineto stroke\n&quot;, (double) pi-&gt;xoff, (double) page.miny, (double) pi-&gt;xoff, (double) page.maxy );</span>
<span class="lineNum">    1846 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%g %g moveto %g %g lineto stroke\n&quot;, (double) page.minx, (double) (sc-&gt;parent-&gt;ascent*pi-&gt;scale+pi-&gt;yoff), (double) page.maxx, (double) (sc-&gt;parent-&gt;ascent*pi-&gt;scale+pi-&gt;yoff) );</span>
<span class="lineNum">    1847 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%g %g moveto %g %g lineto stroke\n&quot;, (double) page.minx, (double) (-sc-&gt;parent-&gt;descent*pi-&gt;scale+pi-&gt;yoff), (double) page.maxx, (double) (-sc-&gt;parent-&gt;descent*pi-&gt;scale+pi-&gt;yoff) );</span>
<span class="lineNum">    1848 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%g %g moveto %g %g lineto stroke\n&quot;, (double) (pi-&gt;xoff+sc-&gt;width*pi-&gt;scale), (double) page.miny, (double) (pi-&gt;xoff+sc-&gt;width*pi-&gt;scale), (double) page.maxy );</span>
<span class="lineNum">    1849 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;grestore\n&quot; );</span>
<span class="lineNum">    1850 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;gsave\n %g %g translate\n&quot;, (double) pi-&gt;xoff, (double) pi-&gt;yoff );</span>
<span class="lineNum">    1851 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot; %g %g scale\n&quot;, (double) pi-&gt;scale, (double) pi-&gt;scale );</span>
<span class="lineNum">    1852 </span><span class="lineNoCov">          0 :         SC_PSDump((void (*)(int,void *)) fputc,pi-&gt;out,sc,true,false,ly_fore);</span>
<span class="lineNum">    1853 </span><span class="lineNoCov">          0 :         if ( sc-&gt;parent-&gt;multilayer )</span>
<span class="lineNum">    1854 </span>            :             /* All done */;
<span class="lineNum">    1855 </span><span class="lineNoCov">          0 :         else if ( sc-&gt;parent-&gt;strokedfont )</span>
<span class="lineNum">    1856 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;%g setlinewidth stroke\n&quot;, (double) sc-&gt;parent-&gt;strokewidth );</span>
<span class="lineNum">    1857 </span>            :         else
<span class="lineNum">    1858 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;fill\n&quot; );</span>
<span class="lineNum">    1859 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;grestore\n&quot; );</span>
<span class="lineNum">    1860 </span>            :     } else {
<span class="lineNum">    1861 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;q .2 w\n&quot; );</span>
<span class="lineNum">    1862 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%g %g m %g %g l S\n&quot;, (double) page.minx, (double) pi-&gt;yoff, (double) page.maxx, (double) pi-&gt;yoff );</span>
<span class="lineNum">    1863 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%g %g m %g %g l S\n&quot;, (double) pi-&gt;xoff, (double) page.miny, (double) pi-&gt;xoff, (double) page.maxy );</span>
<span class="lineNum">    1864 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%g %g m %g %g l S\n&quot;, (double) page.minx, (double) (sc-&gt;parent-&gt;ascent*pi-&gt;scale+pi-&gt;yoff), (double) page.maxx, (double) (sc-&gt;parent-&gt;ascent*pi-&gt;scale+pi-&gt;yoff) );</span>
<span class="lineNum">    1865 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%g %g m %g %g l S\n&quot;, (double) page.minx, (double) (-sc-&gt;parent-&gt;descent*pi-&gt;scale+pi-&gt;yoff), (double) page.maxx, (double) (-sc-&gt;parent-&gt;descent*pi-&gt;scale+pi-&gt;yoff) );</span>
<span class="lineNum">    1866 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%g %g m %g %g l S\n&quot;, (double) (pi-&gt;xoff+sc-&gt;width*pi-&gt;scale), (double) page.miny, (double) (pi-&gt;xoff+sc-&gt;width*pi-&gt;scale), (double) page.maxy );</span>
<span class="lineNum">    1867 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;Q\n&quot; );</span>
<span class="lineNum">    1868 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;q \n %g 0 0 %g %g %g cm\n&quot;, (double) pi-&gt;scale, (double) pi-&gt;scale,</span>
<span class="lineNum">    1869 </span>            :                 (double) pi-&gt;xoff, (double) pi-&gt;yoff );
<span class="lineNum">    1870 </span><span class="lineNoCov">          0 :         SC_PSDump((void (*)(int,void *)) fputc,pi-&gt;out,sc,true,true,ly_fore);</span>
<span class="lineNum">    1871 </span><span class="lineNoCov">          0 :         if ( sc-&gt;parent-&gt;multilayer )</span>
<span class="lineNum">    1872 </span>            :             /* All done */;
<span class="lineNum">    1873 </span><span class="lineNoCov">          0 :         else if ( sc-&gt;parent-&gt;strokedfont )</span>
<span class="lineNum">    1874 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;%g w S\n&quot;, (double) sc-&gt;parent-&gt;strokewidth );</span>
<span class="lineNum">    1875 </span>            :         else
<span class="lineNum">    1876 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;f\n&quot; );</span>
<span class="lineNum">    1877 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;Q\n&quot; );</span>
<span class="lineNum">    1878 </span>            :     }
<a name="1879"><span class="lineNum">    1879 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1880 </span>            : 
<span class="lineNum">    1881 </span><span class="lineNoCov">          0 : static void PIChars(PI *pi) {</span>
<span class="lineNum">    1882 </span>            :     int i, gid;
<span class="lineNum">    1883 </span>            : 
<span class="lineNum">    1884 </span><span class="lineNoCov">          0 :     dump_prologue(pi);</span>
<span class="lineNum">    1885 </span><span class="lineNoCov">          0 :     if ( pi-&gt;fv!=NULL )</span>
<span class="lineNum">    1886 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;pi-&gt;mainmap-&gt;enccount; ++i ) {</span>
<span class="lineNum">    1887 </span><span class="lineNoCov">          0 :             if ( pi-&gt;fv-&gt;selected[i] &amp;&amp; (gid=pi-&gt;mainmap-&gt;map[i])!=-1 &amp;&amp;</span>
<span class="lineNum">    1888 </span><span class="lineNoCov">          0 :                     SCWorthOutputting(pi-&gt;mainsf-&gt;glyphs[gid]) )</span>
<span class="lineNum">    1889 </span><span class="lineNoCov">          0 :                 SCPrintPage(pi,pi-&gt;mainsf-&gt;glyphs[gid]);</span>
<span class="lineNum">    1890 </span><span class="lineNoCov">          0 :     } else if ( pi-&gt;sc!=NULL )</span>
<span class="lineNum">    1891 </span><span class="lineNoCov">          0 :         SCPrintPage(pi,pi-&gt;sc);</span>
<span class="lineNum">    1892 </span>            :     else {
<span class="lineNum">    1893 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;MVGlyphCount(pi-&gt;mv); ++i )</span>
<span class="lineNum">    1894 </span><span class="lineNoCov">          0 :             if ( SCWorthOutputting(MVGlyphIndex(pi-&gt;mv,i)))</span>
<span class="lineNum">    1895 </span><span class="lineNoCov">          0 :                 SCPrintPage(pi,MVGlyphIndex(pi-&gt;mv,i));</span>
<span class="lineNum">    1896 </span>            :     }
<span class="lineNum">    1897 </span><span class="lineNoCov">          0 :     dump_trailer(pi);</span>
<span class="lineNum">    1898 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1899 </span>            : 
<span class="lineNum">    1900 </span>            : /* ************************************************************************** */
<span class="lineNum">    1901 </span>            : /* ************************** Code for sample text ************************** */
<a name="1902"><span class="lineNum">    1902 </span>            : /* ************************************************************************** */</a>
<span class="lineNum">    1903 </span>            : 
<span class="lineNum">    1904 </span><span class="lineNoCov">          0 : static void samplestartpage(PI *pi ) {</span>
<span class="lineNum">    1905 </span><span class="lineNoCov">          0 :     struct sfbits *sfbit = &amp;pi-&gt;sfbits[0];</span>
<span class="lineNum">    1906 </span>            : 
<span class="lineNum">    1907 </span><span class="lineNoCov">          0 :     if ( pi-&gt;page!=0 )</span>
<span class="lineNum">    1908 </span><span class="lineNoCov">          0 :         endpage(pi);</span>
<span class="lineNum">    1909 </span><span class="lineNoCov">          0 :     ++pi-&gt;page;</span>
<span class="lineNum">    1910 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype==pt_pdf ) {</span>
<span class="lineNum">    1911 </span><span class="lineNoCov">          0 :         pdf_addpage(pi);</span>
<span class="lineNum">    1912 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;BT\n  /FTB 12 Tf\n  80 %d Td\n&quot;, pi-&gt;pageheight-84 );</span>
<span class="lineNum">    1913 </span><span class="lineNoCov">          0 :         if ( pi-&gt;pt==pt_fontsample )</span>
<span class="lineNum">    1914 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;(Sample Text from %s) Tj\nET\n&quot;, sfbit-&gt;sf-&gt;fullname );</span>
<span class="lineNum">    1915 </span>            :         else {
<span class="lineNum">    1916 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;(Sample Sizes of %s) Tj\n&quot;, sfbit-&gt;sf-&gt;fullname );</span>
<span class="lineNum">    1917 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;ET\nq 1 0 0 1 40 %d cm\n&quot;, pi-&gt;pageheight-34-</span>
<span class="lineNum">    1918 </span><span class="lineNoCov">          0 :                     pi-&gt;pointsize*sfbit-&gt;sf-&gt;ascent/(sfbit-&gt;sf-&gt;ascent+sfbit-&gt;sf-&gt;descent) );</span>
<span class="lineNum">    1919 </span>            :         }
<span class="lineNum">    1920 </span><span class="lineNoCov">          0 :         pi-&gt;lastfont = -1;</span>
<span class="lineNum">    1921 </span><span class="lineNoCov">          0 :         pi-&gt;wasps = -1;</span>
<span class="lineNum">    1922 </span>            :     } else {
<span class="lineNum">    1923 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%%%%Page: %d %d\n&quot;, pi-&gt;page, pi-&gt;page );</span>
<span class="lineNum">    1924 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%%%%PageResources: font %s\n&quot;, sfbit-&gt;sf-&gt;fontname );</span>
<span class="lineNum">    1925 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;save mark\n&quot; );</span>
<span class="lineNum">    1926 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;Times-Bold__12 setfont\n&quot; );</span>
<span class="lineNum">    1927 </span><span class="lineNoCov">          0 :         if ( pi-&gt;pt==pt_fontsample )</span>
<span class="lineNum">    1928 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;(Sample Text from %s) 80 %d n_show\n&quot;, sfbit-&gt;sf-&gt;fullname, pi-&gt;pageheight-84 );</span>
<span class="lineNum">    1929 </span>            :         else {
<span class="lineNum">    1930 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;(Sample Sizes of %s) 80 %d n_show\n&quot;, sfbit-&gt;sf-&gt;fullname, pi-&gt;pageheight-84 );</span>
<span class="lineNum">    1931 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;40 %d translate\n&quot;, pi-&gt;pageheight-34-</span>
<span class="lineNum">    1932 </span><span class="lineNoCov">          0 :                     pi-&gt;pointsize*sfbit-&gt;sf-&gt;ascent/(sfbit-&gt;sf-&gt;ascent+sfbit-&gt;sf-&gt;descent) );</span>
<span class="lineNum">    1933 </span>            :         }
<span class="lineNum">    1934 </span><span class="lineNoCov">          0 :         if ( sfbit-&gt;iscid )</span>
<span class="lineNum">    1935 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;/Noop-%d [ /%s ] composefont %d scalefont setfont\n&quot;,</span>
<span class="lineNum">    1936 </span><span class="lineNoCov">          0 :                     0, sfbit-&gt;sf-&gt;fontname, pi-&gt;pointsize );</span>
<span class="lineNum">    1937 </span>            :         else
<span class="lineNum">    1938 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;/%s findfont %d scalefont setfont\n&quot;, sfbit-&gt;sf-&gt;fontname,</span>
<span class="lineNum">    1939 </span>            :                     pi-&gt;pointsize);
<span class="lineNum">    1940 </span>            :     }
<span class="lineNum">    1941 </span>            : 
<span class="lineNum">    1942 </span><span class="lineNoCov">          0 :     pi-&gt;ypos = -30;</span>
<a name="1943"><span class="lineNum">    1943 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1944 </span>            : 
<span class="lineNum">    1945 </span><span class="lineNoCov">          0 : static void outputchar(PI *pi, int sfid, SplineChar *sc) {</span>
<span class="lineNum">    1946 </span>            :     int enc;
<span class="lineNum">    1947 </span>            : 
<span class="lineNum">    1948 </span><span class="lineNoCov">          0 :     if ( sc==NULL )</span>
<span class="lineNum">    1949 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1950 </span>            :     /* type42cid output uses a CIDMap indexed by GID */
<span class="lineNum">    1951 </span><span class="lineNoCov">          0 :     if ( pi-&gt;sfbits[sfid].istype42cid ) {</span>
<span class="lineNum">    1952 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;%04X&quot;, sc-&gt;ttf_glyph );</span>
<span class="lineNum">    1953 </span>            :     } else {
<span class="lineNum">    1954 </span><span class="lineNoCov">          0 :         enc = pi-&gt;sfbits[sfid].map-&gt;backmap[sc-&gt;orig_pos];</span>
<span class="lineNum">    1955 </span><span class="lineNoCov">          0 :         if ( enc==-1 )</span>
<span class="lineNum">    1956 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1957 </span><span class="lineNoCov">          0 :         if ( pi-&gt;sfbits[sfid].iscid ) {</span>
<span class="lineNum">    1958 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;%04X&quot;, enc );</span>
<span class="lineNum">    1959 </span><span class="lineNoCov">          0 :         } else if ( pi-&gt;sfbits[sfid].twobyte &amp;&amp; enc&lt;=0xffff ) {</span>
<span class="lineNum">    1960 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;%04X&quot;, enc );</span>
<span class="lineNum">    1961 </span>            :         } else {
<span class="lineNum">    1962 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;%02X&quot;, enc&amp;0xff );</span>
<span class="lineNum">    1963 </span>            :         }
<span class="lineNum">    1964 </span>            :     }
<a name="1965"><span class="lineNum">    1965 </span>            : }</a>
<span class="lineNum">    1966 </span>            : 
<span class="lineNum">    1967 </span><span class="lineNoCov">          0 : static void outputotchar(PI *pi,struct opentype_str *osc,int x,int baseline) {</span>
<span class="lineNum">    1968 </span><span class="lineNoCov">          0 :     struct fontlist *fl = osc-&gt;fl;</span>
<span class="lineNum">    1969 </span><span class="lineNoCov">          0 :     FontData *fd = fl-&gt;fd;</span>
<span class="lineNum">    1970 </span><span class="lineNoCov">          0 :     struct sfmaps *sfmap = fd-&gt;sfmap;</span>
<span class="lineNum">    1971 </span><span class="lineNoCov">          0 :     int sfid = sfmap-&gt;sfbit_id;</span>
<span class="lineNum">    1972 </span><span class="lineNoCov">          0 :     struct sfbits *sfbit = &amp;pi-&gt;sfbits[sfid];</span>
<span class="lineNum">    1973 </span><span class="lineNoCov">          0 :     SplineChar *sc = osc-&gt;sc;</span>
<span class="lineNum">    1974 </span><span class="lineNoCov">          0 :     int enc = sfbit-&gt;map-&gt;backmap[sc-&gt;orig_pos];</span>
<span class="lineNum">    1975 </span>            : 
<span class="lineNum">    1976 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype==pt_pdf ) {</span>
<span class="lineNum">    1977 </span><span class="lineNoCov">          0 :         int fn = sfbit-&gt;iscid?0:sfbit-&gt;fonts[enc/256];</span>
<span class="lineNum">    1978 </span><span class="lineNoCov">          0 :         if ( pi-&gt;wassfid!=sfid || fn!=pi-&gt;wasfn || fd-&gt;pointsize!=pi-&gt;wasps ) {</span>
<span class="lineNum">    1979 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;/F%d-%d %d Tf\n &quot;, sfid, fn, fd-&gt;pointsize);</span>
<span class="lineNum">    1980 </span><span class="lineNoCov">          0 :             pi-&gt;wassfid = sfid; pi-&gt;wasfn = fn; pi-&gt;wasps = fd-&gt;pointsize;</span>
<span class="lineNum">    1981 </span>            :         }
<span class="lineNum">    1982 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out, &quot;%g %g Td &quot;,</span>
<span class="lineNum">    1983 </span><span class="lineNoCov">          0 :                 (double) ((x+osc-&gt;vr.xoff-pi-&gt;lastx)*pi-&gt;scale),</span>
<span class="lineNum">    1984 </span><span class="lineNoCov">          0 :                 (double) ((baseline+osc-&gt;vr.yoff+osc-&gt;bsln_off-pi-&gt;lasty)*pi-&gt;scale) );</span>
<span class="lineNum">    1985 </span><span class="lineNoCov">          0 :         pi-&gt;lastx = x+osc-&gt;vr.xoff; pi-&gt;lasty = baseline+osc-&gt;vr.yoff+osc-&gt;bsln_off;</span>
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :         putc('&lt;',pi-&gt;out);</span>
<span class="lineNum">    1987 </span><span class="lineNoCov">          0 :         outputchar(pi,sfid,sc);</span>
<span class="lineNum">    1988 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&gt; Tj\n&quot; );</span>
<span class="lineNum">    1989 </span>            :     } else {
<span class="lineNum">    1990 </span><span class="lineNoCov">          0 :         int fn = 0;</span>
<span class="lineNum">    1991 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out, &quot;%g %g moveto &quot;,</span>
<span class="lineNum">    1992 </span><span class="lineNoCov">          0 :                 (double) ((x+osc-&gt;vr.xoff)*pi-&gt;scale),</span>
<span class="lineNum">    1993 </span><span class="lineNoCov">          0 :                 (double) ((baseline+osc-&gt;vr.yoff+osc-&gt;bsln_off)*pi-&gt;scale) );</span>
<span class="lineNum">    1994 </span><span class="lineNoCov">          0 :         if ( (sfbit-&gt;twobyte &amp;&amp; enc&gt;0xffff) || (!sfbit-&gt;twobyte &amp;&amp; enc&gt;0xff) )</span>
<span class="lineNum">    1995 </span><span class="lineNoCov">          0 :             fn = enc&gt;&gt;8;</span>
<span class="lineNum">    1996 </span><span class="lineNoCov">          0 :         if ( pi-&gt;wassfid!=sfid || fn!=pi-&gt;wasfn || fd-&gt;pointsize!=pi-&gt;wasps ) {</span>
<span class="lineNum">    1997 </span><span class="lineNoCov">          0 :             if ( sfbit-&gt;iscid )</span>
<span class="lineNum">    1998 </span><span class="lineNoCov">          0 :                 putc('&lt;',pi-&gt;out);</span>
<span class="lineNum">    1999 </span><span class="lineNoCov">          0 :             else if ( (sfbit-&gt;twobyte &amp;&amp; enc&gt;0xffff) || (!sfbit-&gt;twobyte &amp;&amp; enc&gt;0xff) )</span>
<span class="lineNum">    2000 </span><span class="lineNoCov">          0 :                 fprintf(pi-&gt;out,&quot;/%s-%x findfont %d scalefont setfont\n  &lt;&quot;,</span>
<span class="lineNum">    2001 </span><span class="lineNoCov">          0 :                         sfbit-&gt;sf-&gt;fontname, enc&gt;&gt;8,</span>
<span class="lineNum">    2002 </span>            :                         fd-&gt;pointsize);
<span class="lineNum">    2003 </span>            :             else
<span class="lineNum">    2004 </span><span class="lineNoCov">          0 :                 fprintf(pi-&gt;out,&quot;/%s findfont %d scalefont setfont\n  &lt;&quot;, sfbit-&gt;sf-&gt;fontname,</span>
<span class="lineNum">    2005 </span>            :                         fd-&gt;pointsize);
<span class="lineNum">    2006 </span><span class="lineNoCov">          0 :             pi-&gt;wassfid = sfid; pi-&gt;wasfn = fn; pi-&gt;wasps = fd-&gt;pointsize;</span>
<span class="lineNum">    2007 </span>            :         } else
<span class="lineNum">    2008 </span><span class="lineNoCov">          0 :             putc('&lt;',pi-&gt;out);</span>
<span class="lineNum">    2009 </span><span class="lineNoCov">          0 :         outputchar(pi,sfid,sc);</span>
<span class="lineNum">    2010 </span><span class="lineNoCov">          0 :         fprintf( pi-&gt;out, &quot;&gt; show\n&quot; );</span>
<span class="lineNum">    2011 </span>            :     }
<a name="2012"><span class="lineNum">    2012 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2013 </span>            : 
<span class="lineNum">    2014 </span><span class="lineNoCov">          0 : static void PIFontSample(PI *pi) {</span>
<span class="lineNum">    2015 </span>            :     struct sfmaps *sfmaps;
<span class="lineNum">    2016 </span><span class="lineNoCov">          0 :     int cnt=0;</span>
<span class="lineNum">    2017 </span>            :     int y,x, bottom, top, baseline;
<span class="lineNum">    2018 </span><span class="lineNoCov">          0 :     LayoutInfo *li = pi-&gt;sample;</span>
<span class="lineNum">    2019 </span>            :     struct opentype_str **line;
<span class="lineNum">    2020 </span>            :     int i,j;
<span class="lineNum">    2021 </span>            : 
<span class="lineNum">    2022 </span><span class="lineNoCov">          0 :     pi-&gt;pointsize = 12;              /* no longer meaningful */</span>
<span class="lineNum">    2023 </span><span class="lineNoCov">          0 :     pi-&gt;extravspace = pi-&gt;pointsize/6;</span>
<span class="lineNum">    2024 </span><span class="lineNoCov">          0 :     pi-&gt;scale = 72.0/li-&gt;dpi;</span>
<span class="lineNum">    2025 </span><span class="lineNoCov">          0 :     pi-&gt;lastfont = -1; pi-&gt;intext = false;</span>
<span class="lineNum">    2026 </span><span class="lineNoCov">          0 :     pi-&gt;wassfid = -1;</span>
<span class="lineNum">    2027 </span>            : 
<span class="lineNum">    2028 </span><span class="lineNoCov">          0 :     for ( cnt=0, sfmaps = li-&gt;sfmaps; sfmaps!=NULL; sfmaps = sfmaps-&gt;next, ++cnt ) {</span>
<span class="lineNum">    2029 </span><span class="lineNoCov">          0 :         pi-&gt;sfid = cnt;</span>
<span class="lineNum">    2030 </span><span class="lineNoCov">          0 :         sfmaps-&gt;sfbit_id = cnt;</span>
<span class="lineNum">    2031 </span><span class="lineNoCov">          0 :         pi-&gt;sfbits[cnt].sfmap = sfmaps;</span>
<span class="lineNum">    2032 </span><span class="lineNoCov">          0 :         if ( !PIDownloadFont(pi,sfmaps-&gt;sf,sfmaps-&gt;map))</span>
<span class="lineNum">    2033 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2034 </span>            :     }
<span class="lineNum">    2035 </span><span class="lineNoCov">          0 :     dump_prologue(pi);</span>
<span class="lineNum">    2036 </span>            : 
<span class="lineNum">    2037 </span><span class="lineNoCov">          0 :     samplestartpage(pi);</span>
<span class="lineNum">    2038 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype==pt_pdf ) {</span>
<span class="lineNum">    2039 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out, &quot;BT\n&quot; );</span>
<span class="lineNum">    2040 </span><span class="lineNoCov">          0 :         pi-&gt;lastx = pi-&gt;lasty = 0;</span>
<span class="lineNum">    2041 </span>            :     }
<span class="lineNum">    2042 </span><span class="lineNoCov">          0 :     y = top = rint((pi-&gt;pageheight - 96)/pi-&gt;scale);      /* In dpi units */</span>
<span class="lineNum">    2043 </span><span class="lineNoCov">          0 :     bottom = rint(36/pi-&gt;scale);                     /* multiply by scale to get ps points */</span>
<span class="lineNum">    2044 </span>            : 
<span class="lineNum">    2045 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;li-&gt;lcnt; ++i ) {</span>
<span class="lineNum">    2046 </span><span class="lineNoCov">          0 :         if ( y - li-&gt;lineheights[i].fh &lt; bottom ) {</span>
<span class="lineNum">    2047 </span><span class="lineNoCov">          0 :             if ( pi-&gt;printtype==pt_pdf )</span>
<span class="lineNum">    2048 </span><span class="lineNoCov">          0 :                 fprintf(pi-&gt;out, &quot;ET\n&quot; );</span>
<span class="lineNum">    2049 </span><span class="lineNoCov">          0 :             samplestartpage(pi);</span>
<span class="lineNum">    2050 </span><span class="lineNoCov">          0 :             if ( pi-&gt;printtype==pt_pdf ) {</span>
<span class="lineNum">    2051 </span><span class="lineNoCov">          0 :                 fprintf(pi-&gt;out, &quot;BT\n&quot; );</span>
<span class="lineNum">    2052 </span><span class="lineNoCov">          0 :                 pi-&gt;lastx = pi-&gt;lasty = 0;</span>
<span class="lineNum">    2053 </span>            :             }
<span class="lineNum">    2054 </span><span class="lineNoCov">          0 :             y = top;</span>
<span class="lineNum">    2055 </span>            :         }
<span class="lineNum">    2056 </span><span class="lineNoCov">          0 :         x = rint(36/pi-&gt;scale);</span>
<span class="lineNum">    2057 </span><span class="lineNoCov">          0 :         baseline = y - li-&gt;lineheights[i].as;</span>
<span class="lineNum">    2058 </span><span class="lineNoCov">          0 :         y -= li-&gt;lineheights[i].fh;</span>
<span class="lineNum">    2059 </span><span class="lineNoCov">          0 :         line = li-&gt;lines[i];</span>
<span class="lineNum">    2060 </span><span class="lineNoCov">          0 :         for ( j=0; line[j]!=NULL; ++j ) {</span>
<span class="lineNum">    2061 </span><span class="lineNoCov">          0 :             outputotchar(pi,line[j],x,baseline);</span>
<span class="lineNum">    2062 </span><span class="lineNoCov">          0 :             x += line[j]-&gt;advance_width + line[j]-&gt;vr.h_adv_off;</span>
<span class="lineNum">    2063 </span>            :         }
<span class="lineNum">    2064 </span>            :     }
<span class="lineNum">    2065 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype==pt_pdf )</span>
<span class="lineNum">    2066 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out, &quot;ET\n&quot; );</span>
<span class="lineNum">    2067 </span><span class="lineNoCov">          0 :     dump_trailer(pi);</span>
<span class="lineNum">    2068 </span>            : }
<span class="lineNum">    2069 </span>            : 
<span class="lineNum">    2070 </span>            : /* ************************************************************************** */
<span class="lineNum">    2071 </span>            : /* ************************** Code for multi size *************************** */
<span class="lineNum">    2072 </span>            : /* ************************************************************************** */
<a name="2073"><span class="lineNum">    2073 </span>            : static double pointsizes[] = { 72, 48, 36, 24, 20, 18, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7.5, 7, 6.5, 6, 5.5, 5, 4.5, 4.2, 4, 0 };</a>
<span class="lineNum">    2074 </span>            : 
<span class="lineNum">    2075 </span><span class="lineNoCov">          0 : static void SCPrintSizes(PI *pi,SplineChar *sc) {</span>
<span class="lineNum">    2076 </span><span class="lineNoCov">          0 :     int xstart = 10, i;</span>
<span class="lineNum">    2077 </span>            :     int enc;
<span class="lineNum">    2078 </span><span class="lineNoCov">          0 :     struct sfbits *sfbit = &amp;pi-&gt;sfbits[0];</span>
<span class="lineNum">    2079 </span>            : 
<span class="lineNum">    2080 </span><span class="lineNoCov">          0 :     if ( !SCWorthOutputting(sc))</span>
<span class="lineNum">    2081 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2082 </span><span class="lineNoCov">          0 :     enc = sfbit-&gt;map-&gt;backmap[sc-&gt;orig_pos];</span>
<span class="lineNum">    2083 </span><span class="lineNoCov">          0 :     if ( pi-&gt;ypos - pi-&gt;pointsize &lt; -(pi-&gt;pageheight-90) &amp;&amp; pi-&gt;ypos!=-30 ) {</span>
<span class="lineNum">    2084 </span><span class="lineNoCov">          0 :         samplestartpage(pi);</span>
<span class="lineNum">    2085 </span>            :     }
<span class="lineNum">    2086 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype==pt_pdf ) {</span>
<span class="lineNum">    2087 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;BT\n%d %d Td\n&quot;, xstart, pi-&gt;ypos );</span>
<span class="lineNum">    2088 </span>            :     } else {
<span class="lineNum">    2089 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out,&quot;%d %d moveto &quot;, xstart, pi-&gt;ypos );</span>
<span class="lineNum">    2090 </span>            :     }
<span class="lineNum">    2091 </span><span class="lineNoCov">          0 :     for ( i=0; pointsizes[i]!=0; ++i ) {</span>
<span class="lineNum">    2092 </span><span class="lineNoCov">          0 :         if ( pi-&gt;printtype==pt_pdf ) {</span>
<span class="lineNum">    2093 </span><span class="lineNoCov">          0 :             fprintf(pi-&gt;out,&quot;/F%d-%d %g Tf\n  &lt;&quot;, pi-&gt;sfid, sfbit-&gt;iscid?0:sfbit-&gt;fonts[enc/256], pointsizes[i]);</span>
<span class="lineNum">    2094 </span><span class="lineNoCov">          0 :             outputchar(pi,0,sc);</span>
<span class="lineNum">    2095 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;&gt; Tj\n&quot; );</span>
<span class="lineNum">    2096 </span>            :             /* Don't need to use TJ here, no possibility of kerning */
<span class="lineNum">    2097 </span>            :         } else {
<span class="lineNum">    2098 </span><span class="lineNoCov">          0 :             if ( (sfbit-&gt;twobyte &amp;&amp; enc&gt;0xffff) || (!sfbit-&gt;twobyte &amp;&amp; enc&gt;0xff) )</span>
<span class="lineNum">    2099 </span><span class="lineNoCov">          0 :                 fprintf(pi-&gt;out,&quot;/%s-%x findfont %g scalefont setfont\n  &lt;&quot;,</span>
<span class="lineNum">    2100 </span><span class="lineNoCov">          0 :                         sfbit-&gt;sf-&gt;fontname, enc&gt;&gt;8,</span>
<span class="lineNum">    2101 </span>            :                         pointsizes[i]);
<span class="lineNum">    2102 </span>            :             else
<span class="lineNum">    2103 </span><span class="lineNoCov">          0 :                 fprintf(pi-&gt;out,&quot;/%s findfont %g scalefont setfont\n  &lt;&quot;, sfbit-&gt;sf-&gt;fontname,</span>
<span class="lineNum">    2104 </span>            :                         pointsizes[i]);
<span class="lineNum">    2105 </span><span class="lineNoCov">          0 :             outputchar(pi,0,sc);</span>
<span class="lineNum">    2106 </span><span class="lineNoCov">          0 :             fprintf( pi-&gt;out, &quot;&gt; show\n&quot; );</span>
<span class="lineNum">    2107 </span>            :         }
<span class="lineNum">    2108 </span>            :     }
<span class="lineNum">    2109 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype==pt_pdf )</span>
<span class="lineNum">    2110 </span><span class="lineNoCov">          0 :         fprintf(pi-&gt;out, &quot;ET\n&quot;);</span>
<span class="lineNum">    2111 </span><span class="lineNoCov">          0 :     pi-&gt;ypos -= pi-&gt;pointsize+pi-&gt;extravspace;</span>
<a name="2112"><span class="lineNum">    2112 </span>            : }</a>
<span class="lineNum">    2113 </span>            : 
<span class="lineNum">    2114 </span><span class="lineNoCov">          0 : static void PIMultiSize(PI *pi) {</span>
<span class="lineNum">    2115 </span>            :     int i, gid;
<span class="lineNum">    2116 </span><span class="lineNoCov">          0 :     struct sfbits *sfbit = &amp;pi-&gt;sfbits[0];</span>
<span class="lineNum">    2117 </span>            : 
<span class="lineNum">    2118 </span><span class="lineNoCov">          0 :     pi-&gt;pointsize = pointsizes[0];</span>
<span class="lineNum">    2119 </span><span class="lineNoCov">          0 :     pi-&gt;extravspace = pi-&gt;pointsize/6;</span>
<span class="lineNum">    2120 </span><span class="lineNoCov">          0 :     if ( !PIDownloadFont(pi,pi-&gt;mainsf,pi-&gt;mainmap))</span>
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2122 </span><span class="lineNoCov">          0 :     dump_prologue(pi);</span>
<span class="lineNum">    2123 </span>            : 
<span class="lineNum">    2124 </span><span class="lineNoCov">          0 :     samplestartpage(pi);</span>
<span class="lineNum">    2125 </span>            : 
<span class="lineNum">    2126 </span><span class="lineNoCov">          0 :     if ( pi-&gt;fv!=NULL ) {</span>
<span class="lineNum">    2127 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;sfbit-&gt;map-&gt;enccount; ++i )</span>
<span class="lineNum">    2128 </span><span class="lineNoCov">          0 :             if ( pi-&gt;fv-&gt;selected[i] &amp;&amp; (gid=sfbit-&gt;map-&gt;map[i])!=-1 &amp;&amp;</span>
<span class="lineNum">    2129 </span><span class="lineNoCov">          0 :                     SCWorthOutputting(sfbit-&gt;sf-&gt;glyphs[gid]) )</span>
<span class="lineNum">    2130 </span><span class="lineNoCov">          0 :                 SCPrintSizes(pi,sfbit-&gt;sf-&gt;glyphs[gid]);</span>
<span class="lineNum">    2131 </span><span class="lineNoCov">          0 :     } else if ( pi-&gt;sc!=NULL )</span>
<span class="lineNum">    2132 </span><span class="lineNoCov">          0 :         SCPrintSizes(pi,pi-&gt;sc);</span>
<span class="lineNum">    2133 </span>            :     else {
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;MVGlyphCount(pi-&gt;mv); ++i )</span>
<span class="lineNum">    2135 </span><span class="lineNoCov">          0 :             if ( SCWorthOutputting(MVGlyphIndex(pi-&gt;mv,i)))</span>
<span class="lineNum">    2136 </span><span class="lineNoCov">          0 :                 SCPrintSizes(pi,MVGlyphIndex(pi-&gt;mv,i));</span>
<span class="lineNum">    2137 </span>            :     }
<span class="lineNum">    2138 </span>            : 
<span class="lineNum">    2139 </span><span class="lineNoCov">          0 :     dump_trailer(pi);</span>
<span class="lineNum">    2140 </span>            : }
<span class="lineNum">    2141 </span>            : 
<span class="lineNum">    2142 </span>            : /* ************************************************************************** */
<span class="lineNum">    2143 </span>            : /* ***************** Sample Text in Many Scripts/Languages ****************** */
<span class="lineNum">    2144 </span>            : /* ************************************************************************** */
<span class="lineNum">    2145 </span>            : 
<span class="lineNum">    2146 </span>            : /* English */
<span class="lineNum">    2147 </span>            : static char *_simple[] = {
<span class="lineNum">    2148 </span>            :     &quot; A quick brown fox jumps over the lazy dog.&quot;,
<span class="lineNum">    2149 </span>            :     NULL
<span class="lineNum">    2150 </span>            : };
<span class="lineNum">    2151 </span>            : static char *_simplelatnchoices[] = {
<span class="lineNum">    2152 </span>            : /* English */
<span class="lineNum">    2153 </span>            :     &quot; A quick brown fox jumps over the lazy dog.&quot;,
<span class="lineNum">    2154 </span>            :     &quot; Few zebras validate my paradox, quoth Jack Xeno&quot;,
<span class="lineNum">    2155 </span>            :     &quot; A quick brown vixen jumps for the lazy dog.&quot;,
<span class="lineNum">    2156 </span>            :     &quot; The quick blonde doxy jumps over an unfazed wag.&quot;,
<span class="lineNum">    2157 </span>            : /* Swedish */
<span class="lineNum">    2158 </span>            :     &quot;flygande bäckasiner söka hwila på mjuka tuvor&quot;,
<span class="lineNum">    2159 </span>            : /* German (from http://shiar.net/misc/txt/pangram.en) */
<span class="lineNum">    2160 </span>            : /* Twelve boxing fighters hunted Eva across the great dike of Sylt */
<span class="lineNum">    2161 </span>            :     &quot;zwölf Boxkämpfer jagten Eva quer über den großen Sylter Deich&quot;,
<span class="lineNum">    2162 </span>            : /* French (from http://shiar.net/misc/txt/pangram.en) */
<span class="lineNum">    2163 </span>            : /* Carry this old wisky to the blond smoking judge */
<span class="lineNum">    2164 </span>            :     &quot;portez ce vieux whisky au juge blond qui fume&quot;,
<span class="lineNum">    2165 </span>            :     &quot;Les naïfs ægithales hâtifs pondant à Noël où il gèle sont sûrs d'être déçus et de voir leurs drôles d'œufs abîmés.&quot;,
<span class="lineNum">    2166 </span>            : /* Dutch (from http://shiar.net/misc/txt/pangram.en) */
<span class="lineNum">    2167 </span>            : /* Sexy by body, though scared by the swimsuit */
<span class="lineNum">    2168 </span>            :     &quot; sexy qua lijf, doch bang voor 't zwempak&quot;,
<span class="lineNum">    2169 </span>            : /* Polish (from http://shiar.net/misc/txt/pangram.en) */
<span class="lineNum">    2170 </span>            : /* to push a hedgehog or eight bins of figs in this boat */
<span class="lineNum">    2171 </span>            :     &quot; pchnąć w tę łódź jeża lub ośm skrzyń fig &quot;,
<span class="lineNum">    2172 </span>            : /* Slovaka (from http://shiar.net/misc/txt/pangram.en) */
<span class="lineNum">    2173 </span>            :     &quot; starý kôň na hŕbe kníh žuje tíško povädnuté ruže, na stĺpe sa ďateľ učí kvákať novú ódu o živote &quot;,
<span class="lineNum">    2174 </span>            : /* Czech (from http://shiar.net/misc/txt/pangram.en) */
<span class="lineNum">    2175 </span>            :     &quot; příliš žluťoučký kůň úpěl ďábelské kódy &quot;,
<span class="lineNum">    2176 </span>            :     NULL
<span class="lineNum">    2177 </span>            : };
<span class="lineNum">    2178 </span>            : static uint32 _simplelatnlangs[] = {
<span class="lineNum">    2179 </span>            :     CHR('E','N','G',' '),
<span class="lineNum">    2180 </span>            :     CHR('E','N','G',' '),
<span class="lineNum">    2181 </span>            :     CHR('E','N','G',' '),
<span class="lineNum">    2182 </span>            :     CHR('E','N','G',' '),
<span class="lineNum">    2183 </span>            :     CHR('S','V','E',' '),
<span class="lineNum">    2184 </span>            :     CHR('D','E','U',' '),
<span class="lineNum">    2185 </span>            :     CHR('F','R','A',' '),
<span class="lineNum">    2186 </span>            :     CHR('F','R','A',' '),
<span class="lineNum">    2187 </span>            :     CHR('N','L','D',' '),
<span class="lineNum">    2188 </span>            :     CHR('P','L','K',' '),
<span class="lineNum">    2189 </span>            :     CHR('S','L','V',' '),
<span class="lineNum">    2190 </span>            :     CHR('C','S','Y',' ')
<span class="lineNum">    2191 </span>            : };
<span class="lineNum">    2192 </span>            : 
<span class="lineNum">    2193 </span>            : /* Hebrew (from http://shiar.net/misc/txt/pangram.en) */
<span class="lineNum">    2194 </span>            : static char *_simplehebrew[] = {
<span class="lineNum">    2195 </span>            :     &quot; ?דג סקרן שט בים מאוכזב ולפתע מצא לו חברה איך הקליטה &quot;,
<span class="lineNum">    2196 </span>            :     NULL
<span class="lineNum">    2197 </span>            : };
<span class="lineNum">    2198 </span>            : /* Katakana (from http://shiar.net/misc/txt/pangram.en) */
<span class="lineNum">    2199 </span>            : static char *_simplekata[] = {
<span class="lineNum">    2200 </span>            :     &quot; イロハニホヘト チリヌルヲ ワカヨタレソ ツネナラム/ ウヰノオクヤマ ケフコエテ アサキユメミシ ヱヒモセスン &quot;,
<span class="lineNum">    2201 </span>            :     NULL
<span class="lineNum">    2202 </span>            : };
<span class="lineNum">    2203 </span>            : /* Hiragana (from http://shiar.net/misc/txt/pangram.en) */
<span class="lineNum">    2204 </span>            : static char *_simplehira[] = {
<span class="lineNum">    2205 </span>            :     &quot; いろはにほへとちりぬるを/ わかよたれそつねならむ/ うゐのおくやまけふこえて/ あさきゆめみしゑひもせす &quot;,
<span class="lineNum">    2206 </span>            :     NULL
<span class="lineNum">    2207 </span>            : };
<span class="lineNum">    2208 </span>            : /* Russian */
<span class="lineNum">    2209 </span>            : static char *_simplecyrill[] = {
<span class="lineNum">    2210 </span>            :     &quot; Съешь ещё этих мягких французских булок, да выпей чаю!&quot;,
<span class="lineNum">    2211 </span>            :     NULL
<span class="lineNum">    2212 </span>            : };
<span class="lineNum">    2213 </span>            : static char *_simplecyrillchoices[] = {
<span class="lineNum">    2214 </span>            : /* Eat more those soft french 'little-sweet-breads' and drink tea */
<span class="lineNum">    2215 </span>            :     &quot; Съешь ещё этих мягких французских булок, да выпей чаю!&quot;,
<span class="lineNum">    2216 </span>            : /* &quot;In the deep forests of South citrus lived... /answer/Yeah but falsificated one!&quot; */
<span class="lineNum">    2217 </span>            :     &quot; В чащах юга жил-был цитрус -- да, но фальшивый экземпляръ!&quot;,
<span class="lineNum">    2218 </span>            : /* A kind lamplighter with grimy face wants to show me a stunt. */
<span class="lineNum">    2219 </span>            :     &quot;Љубазни фењерџија чађавог лица хоће да ми покаже штос.&quot;,
<span class="lineNum">    2220 </span>            : /* More frequent filtering through the reticular bag improves
<span class="lineNum">    2221 </span>            : fertilization of genetic hybrids. */
<span class="lineNum">    2222 </span>            :     &quot;Чешће цeђење мрeжастим џаком побољшава фертилизацију генских хибрида.&quot;,
<span class="lineNum">    2223 </span>            :     NULL
<span class="lineNum">    2224 </span>            : };
<span class="lineNum">    2225 </span>            : static uint32 _simplecyrilliclangs[] = {
<span class="lineNum">    2226 </span>            :     CHR('R','U','S',' '),       /* Russian */
<span class="lineNum">    2227 </span>            :     CHR('R','U','S',' '),
<span class="lineNum">    2228 </span>            :     CHR('S','R','B',' '),       /* Serbian */
<span class="lineNum">    2229 </span>            :     CHR('S','R','B',' ')
<span class="lineNum">    2230 </span>            : };
<span class="lineNum">    2231 </span>            : /* Russian */
<span class="lineNum">    2232 </span>            : static char *_annakarenena[] = {
<span class="lineNum">    2233 </span>            :     &quot; Всѣ счастливыя семьи похожи другъ на друга, каждая несчастливая семья несчастлива по-своему.&quot;,
<span class="lineNum">    2234 </span>            :     &quot; Все смѣшалось въ домѣ Облонскихъ. Жена узнала, что мужъ былъ связи съ бывшею въ ихъ домѣ француженкою-гувернанткой, и объявила мужу, что не можетъ жить съ нимъ въ одномъ домѣ.&quot;,
<span class="lineNum">    2235 </span>            :     NULL
<span class="lineNum">    2236 </span>            : };
<span class="lineNum">    2237 </span>            : /* Serbian (Cyrillic) */
<span class="lineNum">    2238 </span>            : static char *_serbcyriljohn[] = {
<span class="lineNum">    2239 </span>            :     &quot;У почетку беше Реч Божија, и та Реч беше у Бога, и Бог беше Реч.&quot;,
<span class="lineNum">    2240 </span>            :     NULL
<span class="lineNum">    2241 </span>            : };
<span class="lineNum">    2242 </span>            : /* Spanish */
<span class="lineNum">    2243 </span>            : static char *_donquixote[] = {
<span class="lineNum">    2244 </span>            :     &quot; En un lugar de la Mancha, de cuyo nombre no quiero acordarme, no ha mucho tiempo que vivía un hidalgo de los de lanza en astillero, adarga antigua, rocín flaco y galgo corredor.&quot;,
<span class="lineNum">    2245 </span>            :     NULL
<span class="lineNum">    2246 </span>            : };
<span class="lineNum">    2247 </span>            : /* German */
<span class="lineNum">    2248 </span>            : static char *_faust[] = {
<span class="lineNum">    2249 </span>            :     &quot;Ihr naht euch wieder, schwankende Gestalten,&quot;,
<span class="lineNum">    2250 </span>            :     &quot;Die früh sich einst dem trüben Blick gezeigt.&quot;,
<span class="lineNum">    2251 </span>            :     &quot;Versuch ich wohl, euch diesmal festzuhalten?&quot;,
<span class="lineNum">    2252 </span>            :     &quot;Fühl ich mein Herz noch jenem Wahn geneigt?&quot;,
<span class="lineNum">    2253 </span>            :     &quot;Ihr drängt euch zu! Nun gut, so mögt ihr walten,&quot;,
<span class="lineNum">    2254 </span>            :     &quot;Wie ihr aus Dunst und Nebel um mich steigt;&quot;,
<span class="lineNum">    2255 </span>            :     &quot;Mein Busen fühlt sich jugendlich erschüttert&quot;,
<span class="lineNum">    2256 </span>            :     &quot;Vom Zauberhauch, der euren Zug umwittert.&quot;,
<span class="lineNum">    2257 </span>            :     NULL
<span class="lineNum">    2258 </span>            : };
<span class="lineNum">    2259 </span>            : /* Anglo Saxon */
<span class="lineNum">    2260 </span>            : static char *_beorwulf[] = {
<span class="lineNum">    2261 </span>            :     &quot;Hwæt, we Gar-Dena  in geardagum&quot;,
<span class="lineNum">    2262 </span>            :     &quot;þeodcyninga  þrym gefrunon,&quot;,
<span class="lineNum">    2263 </span>            :     &quot;hu ða æþelingas  ellen fremedon.&quot;,
<span class="lineNum">    2264 </span>            :     &quot; Oft Scyld Scefing  sceaþena þreatum,&quot;,
<span class="lineNum">    2265 </span>            :     &quot;monegum mægþum  meodosetla ofteah;&quot;,
<span class="lineNum">    2266 </span>            :     &quot;egsode Eorle.  Syððan ærest wearð&quot;,
<span class="lineNum">    2267 </span>            :     &quot;feasceaft funden,  (he þæs frofre gebad)&quot;,
<span class="lineNum">    2268 </span>            :     &quot;weox under wolcnum,  weorðmyndum þah,&quot;,
<span class="lineNum">    2269 </span>            :     &quot;oðþæt him æghwyle  þara ymbsittendra&quot;,
<span class="lineNum">    2270 </span>            :     &quot;ofer hronrade  hyan scolde,&quot;,
<span class="lineNum">    2271 </span>            :     &quot;gomban gyldan: þæt wæs god cyning!&quot;,
<span class="lineNum">    2272 </span>            :     NULL
<span class="lineNum">    2273 </span>            : };
<span class="lineNum">    2274 </span>            : /* Italian */
<span class="lineNum">    2275 </span>            : static char *_inferno[] = {
<span class="lineNum">    2276 </span>            :     &quot; Nel mezzo del cammin di nostra vita&quot;,
<span class="lineNum">    2277 </span>            :     &quot;mi ritrovai per una selva obscura,&quot;,
<span class="lineNum">    2278 </span>            :     &quot;ché la diritta via era smarrita.&quot;,
<span class="lineNum">    2279 </span>            :     &quot; Ahi quanto a dir qual era è cosa dura&quot;,
<span class="lineNum">    2280 </span>            :     &quot;esta selva selvaggia e aspra e forte&quot;,
<span class="lineNum">    2281 </span>            :     &quot;che nel pensier rinova la paura!&quot;,
<span class="lineNum">    2282 </span>            :     NULL
<span class="lineNum">    2283 </span>            : };
<span class="lineNum">    2284 </span>            : /* Latin */
<span class="lineNum">    2285 </span>            : static char *_debello[] = {
<span class="lineNum">    2286 </span>            :     &quot; Gallia est omnis dīvīsa in partēs trēs, quārum ūnum incolunt Belgae, aliam Aquītānī, tertiam, quī ipsōrum linguā Celtae, nostrā Gallī appelantur. Hī omnēs linguā, īnstitūtīs, lēgibus inter sē differunt. Gallōs ab Aquītānīs Garumna flūmen, ā Belgīs Matrona et Sēquana dīvidit.&quot;,
<span class="lineNum">    2287 </span>            :     NULL
<span class="lineNum">    2288 </span>            : };
<span class="lineNum">    2289 </span>            : /* French */
<span class="lineNum">    2290 </span>            : static char *_pheadra[] = {
<span class="lineNum">    2291 </span>            :     &quot;Le dessein en est pris: je pars, cher Théramène,&quot;,
<span class="lineNum">    2292 </span>            :     &quot;Et quitte le séjour de l'aimable Trézène.&quot;,
<span class="lineNum">    2293 </span>            :     &quot;Dans le doute mortel dont je suis agité,&quot;,
<span class="lineNum">    2294 </span>            :     &quot;Je commence à rougir de mon oisiveté.&quot;,
<span class="lineNum">    2295 </span>            :     &quot;Depuis plus de six mois éloigné de mon père,&quot;,
<span class="lineNum">    2296 </span>            :     &quot;J'ignore le destin d'une tête si chère;&quot;,
<span class="lineNum">    2297 </span>            :     &quot;J'ignore jusqu'aux lieux qui le peuvent cacher.&quot;,
<span class="lineNum">    2298 </span>            :     NULL
<span class="lineNum">    2299 </span>            : };
<span class="lineNum">    2300 </span>            : /* Classical Greek */
<span class="lineNum">    2301 </span>            : static char *_antigone[] = {
<span class="lineNum">    2302 </span>            :     &quot;Ὦ κοινὸν αὐτάδελφον Ἰσμήνης κάρα,&quot;,
<span class="lineNum">    2303 </span>            :     &quot;ἆῤ οἶσθ᾽ ὅτι Ζεὺς τῶν ἀπ᾽ Οἰδίπου κακῶν&quot;,
<span class="lineNum">    2304 </span>            :     &quot;ὁποῖον οὐχὶ νῷν ἔτι ζσαιν τελεῖ;&quot;,
<span class="lineNum">    2305 </span>            :     NULL
<span class="lineNum">    2306 </span>            : };
<span class="lineNum">    2307 </span>            : /* Hebrew */ /* Seder */
<span class="lineNum">    2308 </span>            : static char *_hebrew[] = {
<span class="lineNum">    2309 </span>            :     &quot;וְאָתָא מַלְאַךְ הַמָּוֶת, וְשָׁחַט לְשּׁוׂחֵט, רְּשָׁחַט לְתוׂרָא, רְּשָׁתַה לְמַּיָּא, דְּכָכָה לְנוּרָא, דְּשָׂרַף לְחוּטְרָא, דְּהִכָּה לְכַלְכָּא, דְּנָשַׁךְ לְשׁוּנְרָא, דְּאָכְלָה לְגַדְיָא, דִּזְבַן אַבָּא בִּתְרֵי זוּזֵי. חַד גַּדְיָא, חַד גַּדְיָא.&quot;,
<span class="lineNum">    2310 </span>            :     &quot;וְאָתָא הַקָּדוֹשׁ כָּדוּךְ הוּא, וְשָׁחַט לְמַלְאַךְ הַמָּוֶת, רְּשָׁחַט לְשּׁוׂחֵט, רְּשָׁחַט לְתוׂרָא, רְּשָׁתַה לְמַּיָּא, דְּכָכָה לְנוּרָא, דְּשָׂרַף לְחוּטְרָא, דְּהִכָּה לְכַלְכָּא, דְּנָשַׁךְ לְשׁוּנְרָא, דְּאָכְלָה לְגַדְיָא, דִּזְבַן אַבָּא בִּתְרֵי זוּזֵי. חַד גַּדְיָא, חַד גַּדְיָא.&quot;,
<span class="lineNum">    2311 </span>            :     NULL
<span class="lineNum">    2312 </span>            : };
<span class="lineNum">    2313 </span>            : /* Arabic with no dots or vowel marks */
<span class="lineNum">    2314 </span>            : static char *_arabic[] = {
<span class="lineNum">    2315 </span>            :     &quot;لقيت الحكمة العادلة حبا عظيما من الشعب. انسحبت من النادی فی السنة الماضية. وقعت فی الوادی فانكسرت يدی. قابلت صديقی عمرا الكاتب القدير فی السوق فقال لی انه ارسل الى الجامعة عددا من مجلته الجديدة. احتل الامير فيصل مدينة دمسق فی الحرب العالمية ودخلها راكبا على فرسه المحبوبة. ارسل عمر خالدا الى العراق ولاكن بعد مدة قصيرة وجه خالد جيشه الى سورية. قدم على دمشق واستطاع فتحها. قبل احتل عمر القدس وعقد جلستة مع حاكم القدس وقد تكلم معه عن فتح المدينة. ثم رجع عمر الى المدنة المنورة.&quot;,
<span class="lineNum">    2316 </span>            :     NULL
<span class="lineNum">    2317 </span>            : };
<span class="lineNum">    2318 </span>            : /* Renaissance English with period ligatures */
<span class="lineNum">    2319 </span>            : static char *_muchado[] = {
<span class="lineNum">    2320 </span>            :     &quot; But till all graces be in one woman, one womã ſhal not com in my grace: rich ſhe ſhall be thats certain, wiſe, or ile none, vertuous, or ile neuer cheapen her.&quot;,
<span class="lineNum">    2321 </span>            :     NULL
<span class="lineNum">    2322 </span>            : };
<span class="lineNum">    2323 </span>            : /* Modern (well, Dickens) English */
<span class="lineNum">    2324 </span>            : static char *_chuzzlewit[] = {
<span class="lineNum">    2325 </span>            :     &quot; As no lady or gentleman, with any claims to polite breeding, can&quot;
<span class="lineNum">    2326 </span>            :     &quot; possibly sympathize with the Chuzzlewit Family without being first&quot;
<span class="lineNum">    2327 </span>            :     &quot; assured of the extreme antiquity of the race, it is a great satisfaction&quot;
<span class="lineNum">    2328 </span>            :     &quot; to know that it undoubtedly descended in a direct line from Adam and&quot;
<span class="lineNum">    2329 </span>            :     &quot; Eve; and was, in the very earliest times, closely connected with the&quot;
<span class="lineNum">    2330 </span>            :     &quot; agricultural interest. If it should ever be urged by grudging and&quot;
<span class="lineNum">    2331 </span>            :     &quot; malicious persons, that a Chuzzlewit, in any period of the family&quot;
<span class="lineNum">    2332 </span>            :     &quot; history, displayed an overweening amount of family pride, surely the&quot;
<span class="lineNum">    2333 </span>            :     &quot; weakness will be considered not only pardonable but laudable, when the&quot;
<span class="lineNum">    2334 </span>            :     &quot; immense superiority of the house to the rest of mankind, in respect of&quot;
<span class="lineNum">    2335 </span>            :     &quot; this its ancient origin, is taken into account.&quot;,
<span class="lineNum">    2336 </span>            :     NULL
<span class="lineNum">    2337 </span>            : };
<span class="lineNum">    2338 </span>            : /* Middle Welsh */
<span class="lineNum">    2339 </span>            : static char *_mabinogion[] = {
<span class="lineNum">    2340 </span>            :     &quot; Gan fod Argraffiad Rhydychen o'r Mabinogion yn rhoi'r testun yn union fel y digwydd yn y llawysgrifau, ac felly yn cyfarfod â gofyn yr ysgolhaig, bernais mai gwell mewn llawlyfr fel hwn oedd golygu peth arno er mwyn helpu'r ieuainc a'r dibrofiad yn yr hen orgraff.&quot;,
<span class="lineNum">    2341 </span>            :     NULL
<span class="lineNum">    2342 </span>            : };
<span class="lineNum">    2343 </span>            : /* Swedish */
<span class="lineNum">    2344 </span>            : static char *_PippiGarOmBord[] = {
<span class="lineNum">    2345 </span>            :     &quot;Om någon människa skulle komma resande till den lilla, lilla staden och så kanske ett tu tre råka förirra sig lite för långt bort åt ena utkanten, då skulle den månniskan få se Villa Villekulla. Inte för att huset var så mycket att titta på just, en rätt fallfårdig gammal villa och en rätt vanskött gammal trädgård runt omkring, men främlingen skulle kanske i alla fall stanna och undra vem som bodde där.&quot;,
<span class="lineNum">    2346 </span>            :     NULL
<span class="lineNum">    2347 </span>            : };
<span class="lineNum">    2348 </span>            : /* Czech */
<span class="lineNum">    2349 </span>            : static char *_goodsoldier[] = {
<span class="lineNum">    2350 </span>            :     &quot; „Tak nám zabili Ferdinanda,“ řekla posluhovačka panu Švejkovi, který opustiv před léty vojenskou službu, když byl definitivně prohlášen vojenskou lékařskou komisí za blba, živil se prodejem psů, ošklivých nečistokrevných oblud, kterým padělal rodokmeny.&quot;,
<span class="lineNum">    2351 </span>            :     &quot; Kromě tohoto zaměstnání byl stižen revmatismem a mazal si právě kolena opodeldokem.&quot;,
<span class="lineNum">    2352 </span>            :     NULL
<span class="lineNum">    2353 </span>            : };
<span class="lineNum">    2354 </span>            : /* Lithuanian */
<span class="lineNum">    2355 </span>            : static char *_lithuanian[] = {
<span class="lineNum">    2356 </span>            :     &quot; Kiekviena šventė yra surišta su praeitimi. Nešvenčiamas gimtadienis, kai, kūdikis gimsta. Ir po keliolikos metų gimtinės arba vardinės nėra tiek reikšmingos, kaip sulaukus 50 ar 75 metų. Juo tolimesnis įvykis, tuo šventė darosi svarbesnė ir iškilmingesnė.&quot;,
<span class="lineNum">    2357 </span>            :     NULL
<span class="lineNum">    2358 </span>            : };
<span class="lineNum">    2359 </span>            : /* Polish */
<span class="lineNum">    2360 </span>            : static char *_polish[] = {
<span class="lineNum">    2361 </span>            :     &quot; Język prasłowiański miał w zakresie deklinacji (fleksji imiennej) następujące kategorie gramatyczne: liczby, rodzaju i przypadku. Poza tym istniały w nim (w zakresie fleksji rzeczownika) różne «odmiany», czyli typy deklinacyjne. Im dawniej w czasie, tym owe różnice deklinacyjne miały mniejszy związek z semantyką rzeczownika.&quot;,
<span class="lineNum">    2362 </span>            :     NULL
<span class="lineNum">    2363 </span>            : };
<span class="lineNum">    2364 </span>            : /* Slovene */
<span class="lineNum">    2365 </span>            : static char *_slovene[] = {
<span class="lineNum">    2366 </span>            :     &quot; Razvoj glasoslovja je diametralno drugačen od razvoja morfologije.&quot;,
<span class="lineNum">    2367 </span>            :     &quot; V govoru si besede slede. V vsaki sintagmi dobi beseda svojo vrednost, če je zvezana z besedo, ki je pred njo, in z besedo, ki ji sledi.&quot;,
<span class="lineNum">    2368 </span>            :     NULL
<span class="lineNum">    2369 </span>            : };
<span class="lineNum">    2370 </span>            : /* Macedonian */
<span class="lineNum">    2371 </span>            : static char *_macedonian[] = {
<span class="lineNum">    2372 </span>            :     &quot; Македонскиот јазик во балканската јазична средина и наспрема соседните словенски јаеици. 1. Македонскиот јазик се говори во СР Македонија, и надвор од нејзините граници, во оние делови на Македонија што по балканските војни влегоа во составот на Грција и Бугарија.&quot;,
<span class="lineNum">    2373 </span>            :     NULL
<span class="lineNum">    2374 </span>            : };
<span class="lineNum">    2375 </span>            : /* Bulgarian */
<span class="lineNum">    2376 </span>            : static char *_bulgarian[] = {
<span class="lineNum">    2377 </span>            :    &quot; ПРЕДМЕТ И ЗАДАЧИ НА ФОНЕТИКАТА Думата фонетика произлиза от гръцката дума фоне, която означава „звук“, „глас“, „тон“.&quot;,
<span class="lineNum">    2378 </span>            :     NULL
<span class="lineNum">    2379 </span>            : };
<span class="lineNum">    2380 </span>            : /* Korean Hangul */
<span class="lineNum">    2381 </span>            : static char *_hangulsijo[] = {
<span class="lineNum">    2382 </span>            :     &quot;어버이 살아신 제 섬길 일란 다 하여라&quot;,
<span class="lineNum">    2383 </span>            :     &quot;지나간 후면 애닯다 어이 하리&quot;,
<span class="lineNum">    2384 </span>            :     &quot;평생에 고쳐 못할 일이 이뿐인가 하노라&quot;,
<span class="lineNum">    2385 </span>            :     &quot;- 정철&quot;,
<span class="lineNum">    2386 </span>            :     &quot;&quot;,
<span class="lineNum">    2387 </span>            :     &quot;이고 진 저 늙은이 짐 벗어 나를 주오&quot;,
<span class="lineNum">    2388 </span>            :     &quot;나는 젊었거니 돌이라 무거울까&quot;,
<span class="lineNum">    2389 </span>            :     &quot;늙기도 설워라커든 짐을 조차 지실까&quot;,
<span class="lineNum">    2390 </span>            :     &quot;- 정철&quot;,
<span class="lineNum">    2391 </span>            :     NULL
<span class="lineNum">    2392 </span>            : };
<span class="lineNum">    2393 </span>            : /* Chinese traditional */
<span class="lineNum">    2394 </span>            : /* https://en.wikipedia.org/wiki/Tao_Te_Ching */
<span class="lineNum">    2395 </span>            : static char *_TaoTeChing[] = {
<span class="lineNum">    2396 </span>            :     &quot;道可道非常道，&quot;,
<span class="lineNum">    2397 </span>            :     &quot;名可名非常名。&quot;,
<span class="lineNum">    2398 </span>            :     NULL
<span class="lineNum">    2399 </span>            : };
<span class="lineNum">    2400 </span>            : /* http://gan.wikipedia.org/wiki/%E5%B0%87%E9%80%B2%E9%85%92 */
<span class="lineNum">    2401 </span>            : static char *_LiBai[] = {
<span class="lineNum">    2402 </span>            :     &quot;將進酒&quot;,
<span class="lineNum">    2403 </span>            :     &quot;&quot;,
<span class="lineNum">    2404 </span>            :     &quot;君不見 黃河之水天上來 奔流到海不復回&quot;,
<span class="lineNum">    2405 </span>            :     &quot;君不見 高堂明鏡悲白髮 朝如青絲暮成雪&quot;,
<span class="lineNum">    2406 </span>            :     &quot;人生得意須盡歡 莫使金樽空對月&quot;,
<span class="lineNum">    2407 </span>            :     &quot;天生我材必有用 千金散盡還復來&quot;,
<span class="lineNum">    2408 </span>            :     &quot;烹羊宰牛且為樂 會須一飲三百杯&quot;,
<span class="lineNum">    2409 </span>            :     &quot;岑夫子 丹丘生 將進酒 君莫停&quot;,
<span class="lineNum">    2410 </span>            :     &quot;與君歌一曲 請君為我側耳聽&quot;,
<span class="lineNum">    2411 </span>            :     &quot;鐘鼓饌玉不足貴 但願長醉不願醒&quot;,
<span class="lineNum">    2412 </span>            :     &quot;古來聖賢皆寂寞 惟有飲者留其名&quot;,
<span class="lineNum">    2413 </span>            :     &quot;陳王昔時宴平樂 斗酒十千恣讙謔&quot;,
<span class="lineNum">    2414 </span>            :     &quot;主人何為言少錢 徑須沽取對君酌&quot;,
<span class="lineNum">    2415 </span>            :     &quot;五花馬 千金裘 呼兒將出換美酒 與爾同消萬古愁&quot;,
<span class="lineNum">    2416 </span>            :     NULL
<span class="lineNum">    2417 </span>            : };
<span class="lineNum">    2418 </span>            : static char *_LiBaiShort[] = {
<span class="lineNum">    2419 </span>            :     &quot;將進酒&quot;,
<span class="lineNum">    2420 </span>            :     &quot;&quot;,
<span class="lineNum">    2421 </span>            :     &quot;君不見 黃河之水天上來 奔流到海不復回&quot;,
<span class="lineNum">    2422 </span>            :     &quot;君不見 高堂明鏡悲白髮 朝如青絲暮成雪&quot;,
<span class="lineNum">    2423 </span>            :     NULL
<span class="lineNum">    2424 </span>            : };
<span class="lineNum">    2425 </span>            : /* Japanese */
<span class="lineNum">    2426 </span>            : /* https://ja.wikipedia.org/wiki/%E6%BA%90%E6%B0%8F%E7%89%A9%E8%AA%9E */
<span class="lineNum">    2427 </span>            : static char *_Genji[] = {
<span class="lineNum">    2428 </span>            :     &quot;源氏物語（紫式部）：いづれの御時にか、女御・更衣あまた さぶらひたまひけるなかに、いとやむごとなき 際にはあらぬが、すぐれてときめきたまふありけり。&quot;,
<span class="lineNum">    2429 </span>            :     NULL
<span class="lineNum">    2430 </span>            : };
<span class="lineNum">    2431 </span>            : /* http://www.geocities.jp/sybrma/42souseki.neko.html */
<span class="lineNum">    2432 </span>            : static char *_IAmACat[] = {
<span class="lineNum">    2433 </span>            :     &quot;吾輩は猫である（夏目漱石）：吾輩は猫である&quot;,
<span class="lineNum">    2434 </span>            :     NULL
<span class="lineNum">    2435 </span>            : };
<span class="lineNum">    2436 </span>            : 
<span class="lineNum">    2437 </span>            : /* The following translations of the gospel according to John are all from */
<span class="lineNum">    2438 </span>            : /*  Compendium of the world's languages. 1991 Routledge. by George L. Campbell*/
<span class="lineNum">    2439 </span>            : 
<span class="lineNum">    2440 </span>            : /* Belorussian */
<span class="lineNum">    2441 </span>            : static char *_belorussianjohn[] = {
<span class="lineNum">    2442 </span>            :     &quot;У пачатку было Слова, і Слова было ў Бога, і Богам было Слова. Яно было ў пачатку ў Бога&quot;,
<span class="lineNum">    2443 </span>            :     NULL
<span class="lineNum">    2444 </span>            : };
<span class="lineNum">    2445 </span>            : /* basque */
<span class="lineNum">    2446 </span>            : static char *_basquejohn[] = {
<span class="lineNum">    2447 </span>            :     &quot;Asieran Itza ba-zan, ta Itza Yainkoagan zan, ta Itza Yainko zan.&quot;,
<span class="lineNum">    2448 </span>            :     &quot;Asieran Bera Yainkoagan zan.&quot;,
<span class="lineNum">    2449 </span>            :     NULL
<span class="lineNum">    2450 </span>            : };
<span class="lineNum">    2451 </span>            : /* danish */
<span class="lineNum">    2452 </span>            : static char *_danishjohn[] = {
<span class="lineNum">    2453 </span>            :     &quot;Begyndelsen var Ordet, og Ordet var hos Gud, og Ordet var Gud.&quot;,
<span class="lineNum">    2454 </span>            :     &quot;Dette var i Begyndelsen hos Gud.&quot;,
<span class="lineNum">    2455 </span>            :     NULL
<span class="lineNum">    2456 </span>            : };
<span class="lineNum">    2457 </span>            : /* dutch */
<span class="lineNum">    2458 </span>            : static char *_dutchjohn[] = {
<span class="lineNum">    2459 </span>            :     &quot;In den beginne was het Woord en het Woord was bij God en het Woord was God.&quot;,
<span class="lineNum">    2460 </span>            :     &quot;Dit was in den beginne bij God.&quot;,
<span class="lineNum">    2461 </span>            :     NULL
<span class="lineNum">    2462 </span>            : };
<span class="lineNum">    2463 </span>            : /* finnish */
<span class="lineNum">    2464 </span>            : static char *_finnishjohn[] = {
<span class="lineNum">    2465 </span>            :     &quot;Alussa oli Sana, ja Sana oli Jumalan luona, Sana oli Jumala.&quot;,
<span class="lineNum">    2466 </span>            :     &quot;ja hä oli alussa Jumalan luona.&quot;,
<span class="lineNum">    2467 </span>            :     NULL
<span class="lineNum">    2468 </span>            : };
<span class="lineNum">    2469 </span>            : /* georgian */
<span class="lineNum">    2470 </span>            :     /* Hmm, the first 0x10e0 might be 0x10dd, 0x301 */
<span class="lineNum">    2471 </span>            : static char *_georgianjohn[] = {
<span class="lineNum">    2472 </span>            :     &quot;პირველითგან იყო სიტყუუ̂ა, და სიტყუუ̂ა იგი იყო ღუ̂თისა თანა, და დიერთი იყო სიტყუუ̂ა იგი.&quot;,
<span class="lineNum">    2473 </span>            :     &quot;ესე იყო პირველითგან დიერთი თინი.&quot;,
<span class="lineNum">    2474 </span>            :     NULL
<span class="lineNum">    2475 </span>            : };
<span class="lineNum">    2476 </span>            : /* icelandic */
<span class="lineNum">    2477 </span>            : static char *_icelandicjohn[] = {
<span class="lineNum">    2478 </span>            :     &quot;Í upphafi var Orðið og Orðið var hjà Guði, og Orðið var Guði.&quot;,
<span class="lineNum">    2479 </span>            :     &quot;Það var í upphafi hjá Guði.&quot;,
<span class="lineNum">    2480 </span>            :     NULL
<span class="lineNum">    2481 </span>            : };
<span class="lineNum">    2482 </span>            : /* irish */
<span class="lineNum">    2483 </span>            : static char *_irishjohn[] = {
<span class="lineNum">    2484 </span>            :     &quot;Bhí an Briathar(I) ann i dtús báire agus bhí an Briathar in éineacht le Dia, agus ba Dhia an Briathar.&quot;,
<span class="lineNum">    2485 </span>            :     &quot;Bhí sé ann i dtús báire in éineacht le Dia.&quot;,
<span class="lineNum">    2486 </span>            :     NULL
<span class="lineNum">    2487 </span>            : };
<span class="lineNum">    2488 </span>            : /* Bokmål norwegian */
<span class="lineNum">    2489 </span>            : static char *_norwegianjohn[] = {
<span class="lineNum">    2490 </span>            :     &quot;I begynnelsen var Ordet, Ordet var hos Gud, og Ordet var Gud.&quot;,
<span class="lineNum">    2491 </span>            :     &quot;Han var i begynnelsen hos Gud.&quot;,
<span class="lineNum">    2492 </span>            :     &quot;Alt er blitt til ved ham; uten ham er ikke noe blitt til av alt som er til.&quot;,
<span class="lineNum">    2493 </span>            :     NULL
<span class="lineNum">    2494 </span>            : };
<span class="lineNum">    2495 </span>            : /* Nynorsk norwegian */
<span class="lineNum">    2496 </span>            : static char *_nnorwegianjohn[] = {
<span class="lineNum">    2497 </span>            :     &quot;I opphavet var Ordet, og Ordet var hjå Gud, og Ordet var Gud.&quot;,
<span class="lineNum">    2498 </span>            :     &quot;Han var i opphavet hjå Gud.&quot;,
<span class="lineNum">    2499 </span>            :     NULL
<span class="lineNum">    2500 </span>            : };
<span class="lineNum">    2501 </span>            : /* old church slavonic */
<span class="lineNum">    2502 </span>            : static char *_churchjohn[] = {
<span class="lineNum">    2503 </span>            :     &quot;Въ нача́лѣ бѣ̀ сло́во и҆ сло́во бѣ̀ къ бг҃ꙋ, и҆ бг҃ъ бѣ̀ сло́во.&quot;,
<span class="lineNum">    2504 </span>            :     &quot;Се́й бѣ̀ и҆сконѝ къ бг҃ꙋ.&quot;,
<span class="lineNum">    2505 </span>            :     NULL
<span class="lineNum">    2506 </span>            : };
<span class="lineNum">    2507 </span>            : /* swedish */
<span class="lineNum">    2508 </span>            : static char *_swedishjohn[] = {
<span class="lineNum">    2509 </span>            :     &quot;I begynnelsen var Ordet, och Ordet var hos Gud, och Ordet var Gud.&quot;,
<span class="lineNum">    2510 </span>            :     &quot;Han var i begynnelsen hos Gud.&quot;,
<span class="lineNum">    2511 </span>            :     NULL
<span class="lineNum">    2512 </span>            : };
<span class="lineNum">    2513 </span>            : /* portuguese */
<span class="lineNum">    2514 </span>            : static char *_portjohn[] = {
<span class="lineNum">    2515 </span>            :     &quot;No Principio era a Palavra, e a Palavra estava junto de Deos, e a Palavra era Deos.&quot;,
<span class="lineNum">    2516 </span>            :     &quot;Esta estava no principio junto de Deos.&quot;,
<span class="lineNum">    2517 </span>            :     NULL
<span class="lineNum">    2518 </span>            : };
<span class="lineNum">    2519 </span>            : /* cherokee */
<span class="lineNum">    2520 </span>            : static char *_cherokeejohn[] = {
<span class="lineNum">    2521 </span>            :     &quot;ᏗᏓᎴᏂᏯᎬ ᎧᏃᎮᏘ ᎡᎮᎢ, ᎠᎴ ᎾᏯᎩ ᎧᏃᎮᏘ ᎤᏁᎳᏅᎯ ᎢᏧᎳᎭ ᎠᏘᎮᎢ, ᎠᎴ ᎾᏯᎩ ᎧᏃᎮᏘ ᎤᏁᎳᏅᎯ ᎨᏎᎢ.&quot;,
<span class="lineNum">    2522 </span>            :     &quot;ᏗᏓᎴᏂᏯᎬ ᎾᏯᎩ ᎤᏁᎳᏅᎯ ᎢᏧᎳᎭ ᎠᏘᎮᎢ&quot;,
<span class="lineNum">    2523 </span>            :     NULL
<span class="lineNum">    2524 </span>            : };
<span class="lineNum">    2525 </span>            : /* swahili */
<span class="lineNum">    2526 </span>            : static char *_swahilijohn[] = {
<span class="lineNum">    2527 </span>            :     &quot;Hapo mwanzo kulikuwako Neno, naye Neno alikuwako kwa Mungo, naye Neno alikuwa Mungu, Huyo mwanzo alikuwako kwa Mungu.&quot;,
<span class="lineNum">    2528 </span>            :     &quot;Vyote vilvanyika kwa huyo; wala pasipo yeye hakikufanyika cho chote kilichofanyiki.&quot;,
<span class="lineNum">    2529 </span>            :     NULL
<span class="lineNum">    2530 </span>            : };
<span class="lineNum">    2531 </span>            : /* thai */      /* I'm sure I've made transcription errors here, I can't figure out what &quot;0xe27, 0xe38, 0xe4d&quot; really is */
<span class="lineNum">    2532 </span>            : static char *_thaijohn[] = {
<span class="lineNum">    2533 </span>            :     &quot;๏ ในทีเดิมนะนพวุํลอโฆเปนอยู่ แลเปนอยู่ดว้ยกันกับ พวุํเฆ้า&quot;,
<span class="lineNum">    2534 </span>            :     NULL
<span class="lineNum">    2535 </span>            : };
<span class="lineNum">    2536 </span>            : /* Mayan K'iche' of Guatemala */ /* Prolog to Popol Wuj */ /* Provided by Daniel Johnson */
<span class="lineNum">    2537 </span>            : static char *_mayanPopolWuj[] = {
<span class="lineNum">    2538 </span>            :     &quot;Are u xe' ojer tzij waral, C'i Che' u bi'. Waral xchikatz'ibaj-wi, xchikatiquiba-wi ojer tzij, u ticaribal, u xe'nabal puch ronojel xban pa tinamit C'i Che', ramak C'i Che' winak.&quot;,
<span class="lineNum">    2539 </span>            :     NULL
<span class="lineNum">    2540 </span>            : };
<span class="lineNum">    2541 </span>            : 
<span class="lineNum">    2542 </span>            : /* I've omitted cornish. no interesting letters. no current speakers */
<span class="lineNum">    2543 </span>            : 
<span class="lineNum">    2544 </span>            :   /* http://www.ethnologue.com/iso639/codes.asp */
<span class="lineNum">    2545 </span>            : enum scripts { sc_latin, sc_greek, sc_cyrillic, sc_georgian, sc_hebrew,
<span class="lineNum">    2546 </span>            :         sc_arabic, sc_hangul, sc_chinesetrad, sc_chinesemod, sc_kanji,
<span class="lineNum">    2547 </span>            :         sc_hiragana, sc_katakana
<span class="lineNum">    2548 </span>            : };
<span class="lineNum">    2549 </span>            : static struct langsamples {
<span class="lineNum">    2550 </span>            :     char **sample;
<span class="lineNum">    2551 </span>            :     char *iso_lang;             /* ISO 639 two character abbreviation */
<span class="lineNum">    2552 </span>            :     enum scripts script;
<span class="lineNum">    2553 </span>            :     uint32 otf_script, lang;
<span class="lineNum">    2554 </span>            : } sample[] = {
<span class="lineNum">    2555 </span>            :     { _simple, &quot;various&quot;, sc_latin, CHR('l','a','t','n'), CHR('E','N','G',' ') },
<span class="lineNum">    2556 </span>            :     { _simplecyrill, &quot;various&quot;, sc_cyrillic, CHR('c','y','r','l'), CHR('R','U','S',' ')},
<span class="lineNum">    2557 </span>            :     { _simplehebrew, &quot;he&quot;, sc_hebrew, CHR('h','e','b','r'), CHR('I','W','R',' ') },
<span class="lineNum">    2558 </span>            :     { _simplekata, &quot;ja&quot;, sc_katakana, CHR('k','a','n','a'), CHR('J','A','N',' ')},
<span class="lineNum">    2559 </span>            :     { _simplehira, &quot;ja&quot;, sc_hiragana, CHR('k','a','n','a'), CHR('J','A','N',' ')},
<span class="lineNum">    2560 </span>            :     { _faust, &quot;de&quot;, sc_latin, CHR('l','a','t','n'), CHR('D','E','U',' ')},
<span class="lineNum">    2561 </span>            :     { _pheadra, &quot;fr&quot;, sc_latin, CHR('l','a','t','n'), CHR('F','R','A',' ')},
<span class="lineNum">    2562 </span>            :     { _antigone, &quot;el&quot;, sc_greek, CHR('g','r','e','k'), CHR('P','G','R',' ')}, /* Is this polytonic? */
<span class="lineNum">    2563 </span>            :     { _annakarenena, &quot;ru&quot;, sc_cyrillic, CHR('c','y','r','l'), CHR('R','U','S',' ')},
<span class="lineNum">    2564 </span>            :     { _serbcyriljohn, &quot;sr&quot;, sc_cyrillic, CHR('c','y','r','l'), CHR('S','R','B',' ')},
<span class="lineNum">    2565 </span>            :     { _debello, &quot;la&quot;, sc_latin, CHR('l','a','t','n'), CHR('L','A','T',' ')},
<span class="lineNum">    2566 </span>            :     { _hebrew, &quot;he&quot;, sc_hebrew, CHR('h','e','b','r'), CHR('I','W','R',' ') },
<span class="lineNum">    2567 </span>            :     { _arabic, &quot;ar&quot;, sc_arabic, CHR('a','r','a','b'), CHR('A','R','A',' ')},
<span class="lineNum">    2568 </span>            :     { _hangulsijo, &quot;ko&quot;, sc_hangul, CHR('h','a','n','g'), CHR('K','O','R',' ')},
<span class="lineNum">    2569 </span>            :     { _TaoTeChing, &quot;zh&quot;, sc_chinesetrad, CHR('h','a','n','i'), CHR('Z','H','T',' ')},
<span class="lineNum">    2570 </span>            :     { _LiBai, &quot;zh&quot;, sc_chinesetrad, CHR('h','a','n','i'), CHR('Z','H','T',' ')},
<span class="lineNum">    2571 </span>            :     { _Genji, &quot;ja&quot;, sc_kanji, CHR('h','a','n','i'), CHR('J','A','N',' ')},
<span class="lineNum">    2572 </span>            :     { _IAmACat, &quot;ja&quot;, sc_kanji, CHR('h','a','n','i'), CHR('J','A','N',' ')},
<span class="lineNum">    2573 </span>            :     { _donquixote, &quot;es&quot;, sc_latin, CHR('l','a','t','n'), CHR('E','S','P',' ')},
<span class="lineNum">    2574 </span>            :     { _inferno, &quot;it&quot;, sc_latin, CHR('l','a','t','n'), CHR('I','T','A',' ')},
<span class="lineNum">    2575 </span>            :     { _beorwulf, &quot;enm&quot;, sc_latin, CHR('l','a','t','n'), CHR('E','N','G',' ')},                /* 639-2 name for middle english */
<span class="lineNum">    2576 </span>            :     { _muchado, &quot;eng&quot;, sc_latin, CHR('l','a','t','n'), CHR('E','N','G',' ')},         /* 639-2 name for modern english */
<span class="lineNum">    2577 </span>            :     { _chuzzlewit, &quot;en&quot;, sc_latin, CHR('l','a','t','n'), CHR('E','N','G',' ')},               /* 639-2 name for modern english */
<span class="lineNum">    2578 </span>            :     { _PippiGarOmBord, &quot;sv&quot;, sc_latin, CHR('l','a','t','n'), CHR('S','V','E',' ')},
<span class="lineNum">    2579 </span>            :     { _mabinogion, &quot;cy&quot;, sc_latin, CHR('l','a','t','n'), CHR('W','E','L',' ')},
<span class="lineNum">    2580 </span>            :     { _goodsoldier, &quot;cs&quot;, sc_latin, CHR('l','a','t','n'), CHR('C','S','Y',' ')},
<span class="lineNum">    2581 </span>            :     { _macedonian, &quot;mk&quot;, sc_cyrillic, CHR('c','y','r','l'), CHR('M','K','D',' ')},
<span class="lineNum">    2582 </span>            :     { _bulgarian, &quot;bg&quot;, sc_cyrillic, CHR('c','y','r','l'), CHR('B','G','R',' ')},
<span class="lineNum">    2583 </span>            :     { _belorussianjohn, &quot;be&quot;, sc_cyrillic, CHR('c','y','r','l'), CHR('B','E','L',' ')},
<span class="lineNum">    2584 </span>            :     { _churchjohn, &quot;cu&quot;, sc_cyrillic, CHR('c','y','r','l'), CHR('C','S','L',' ')},
<span class="lineNum">    2585 </span>            :     { _lithuanian, &quot;lt&quot;, sc_latin, CHR('l','a','t','n'), CHR('L','T','H',' ')},
<span class="lineNum">    2586 </span>            :     { _polish, &quot;pl&quot;, sc_latin, CHR('l','a','t','n'), CHR('P','L','K',' ')},
<span class="lineNum">    2587 </span>            :     { _slovene, &quot;sl&quot;, sc_latin, CHR('l','a','t','n'), CHR('S','L','V',' ')},
<span class="lineNum">    2588 </span>            :     { _irishjohn, &quot;ga&quot;, sc_latin, CHR('l','a','t','n'), CHR('I','R','I',' ')},
<span class="lineNum">    2589 </span>            :     { _basquejohn, &quot;eu&quot;, sc_latin, CHR('l','a','t','n'), CHR('E','U','Q',' ')},
<span class="lineNum">    2590 </span>            :     { _portjohn, &quot;pt&quot;, sc_latin, CHR('l','a','t','n'), CHR('P','T','G',' ')},
<span class="lineNum">    2591 </span>            :     { _icelandicjohn, &quot;is&quot;, sc_latin, CHR('l','a','t','n'), CHR('I','S','L',' ')},
<span class="lineNum">    2592 </span>            :     { _danishjohn, &quot;da&quot;, sc_latin, CHR('l','a','t','n'), CHR('D','A','N',' ')},
<span class="lineNum">    2593 </span>            :     { _swedishjohn, &quot;sv&quot;, sc_latin, CHR('l','a','t','n'), CHR('S','V','E',' ')},
<span class="lineNum">    2594 </span>            :     { _norwegianjohn, &quot;no&quot;, sc_latin, CHR('l','a','t','n'), CHR('N','O','R',' ')},
<span class="lineNum">    2595 </span>            :     { _nnorwegianjohn, &quot;no&quot;, sc_latin, CHR('l','a','t','n'), CHR('N','O','R',' ')},
<span class="lineNum">    2596 </span>            :     { _dutchjohn, &quot;nl&quot;, sc_latin, CHR('l','a','t','n'), CHR('N','L','D',' ')},
<span class="lineNum">    2597 </span>            :     { _finnishjohn, &quot;fi&quot;, sc_latin, CHR('l','a','t','n'), CHR('F','I','N',' ')},
<span class="lineNum">    2598 </span>            :     { _cherokeejohn, &quot;chr&quot;, sc_latin, CHR('l','a','t','n'), CHR('C','H','R',' ')},
<span class="lineNum">    2599 </span>            :     { _thaijohn, &quot;th&quot;, sc_latin, CHR('l','a','t','n'), CHR('T','H','A',' ')},
<span class="lineNum">    2600 </span>            :     { _georgianjohn, &quot;ka&quot;, sc_georgian, CHR('g','e','o','r'), CHR('K','A','T',' ') },
<span class="lineNum">    2601 </span>            :     { _swahilijohn, &quot;sw&quot;, sc_latin, CHR('l','a','t','n'), CHR('S','W','K',' ')},
<span class="lineNum">    2602 </span>            :     { _mayanPopolWuj, &quot;QUT&quot;, sc_latin, CHR('l','a','t','n'), CHR('Q','U','T',' ')},
<span class="lineNum">    2603 </span>            :     { NULL, NULL, 0, 0, 0 }
<a name="2604"><span class="lineNum">    2604 </span>            : };</a>
<span class="lineNum">    2605 </span>            : 
<span class="lineNum">    2606 </span><span class="lineNoCov">          0 : static void OrderSampleByLang(void) {</span>
<span class="lineNum">    2607 </span><span class="lineNoCov">          0 :     const char *lang = getenv(&quot;LANG&quot;);</span>
<span class="lineNum">    2608 </span>            :     char langbuf[12], *pt;
<span class="lineNum">    2609 </span>            :     int i,j;
<span class="lineNum">    2610 </span>            :     int simple_pos;
<span class="lineNum">    2611 </span>            : 
<span class="lineNum">    2612 </span><span class="lineNoCov">          0 :     if ( lang==NULL )</span>
<span class="lineNum">    2613 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2614 </span>            : 
<span class="lineNum">    2615 </span><span class="lineNoCov">          0 :     strncpy(langbuf,lang,10);</span>
<span class="lineNum">    2616 </span><span class="lineNoCov">          0 :     langbuf[10] = '\0';</span>
<span class="lineNum">    2617 </span><span class="lineNoCov">          0 :     for ( j=0; j&lt;3; ++j ) {</span>
<span class="lineNum">    2618 </span><span class="lineNoCov">          0 :         if ( j==1 ) {</span>
<span class="lineNum">    2619 </span><span class="lineNoCov">          0 :             for ( pt=langbuf; *pt!='\0' &amp;&amp; *pt!='.'; ++pt );</span>
<span class="lineNum">    2620 </span><span class="lineNoCov">          0 :             *pt = '\0';</span>
<span class="lineNum">    2621 </span><span class="lineNoCov">          0 :         } else if ( j==2 ) {</span>
<span class="lineNum">    2622 </span><span class="lineNoCov">          0 :             for ( pt=langbuf; *pt!='\0' &amp;&amp; *pt!='_'; ++pt );</span>
<span class="lineNum">    2623 </span><span class="lineNoCov">          0 :             *pt = '\0';</span>
<span class="lineNum">    2624 </span>            :         }
<span class="lineNum">    2625 </span><span class="lineNoCov">          0 :         for ( i=0; sample[i].sample!=NULL; ++i )</span>
<span class="lineNum">    2626 </span><span class="lineNoCov">          0 :             if ( strcmp(sample[i].iso_lang,langbuf)==0 ) {</span>
<span class="lineNum">    2627 </span>            :                 struct langsamples temp;
<span class="lineNum">    2628 </span><span class="lineNoCov">          0 :                 temp = sample[i];</span>
<span class="lineNum">    2629 </span><span class="lineNoCov">          0 :                 sample[i] = sample[2];</span>
<span class="lineNum">    2630 </span><span class="lineNoCov">          0 :                 sample[2] = temp;</span>
<span class="lineNum">    2631 </span><span class="lineNoCov">          0 :     goto out;</span>
<span class="lineNum">    2632 </span>            :             }
<span class="lineNum">    2633 </span>            :     }
<span class="lineNum">    2634 </span>            :     out:
<span class="lineNum">    2635 </span><span class="lineNoCov">          0 :     simple_pos = 0;</span>
<span class="lineNum">    2636 </span><span class="lineNoCov">          0 :     if ( strcmp(langbuf,&quot;sv&quot;)==0 )</span>
<span class="lineNum">    2637 </span><span class="lineNoCov">          0 :         simple_pos = 4;</span>
<span class="lineNum">    2638 </span><span class="lineNoCov">          0 :     else if ( strcmp(langbuf,&quot;de&quot;)==0 )</span>
<span class="lineNum">    2639 </span><span class="lineNoCov">          0 :         simple_pos = 5;</span>
<span class="lineNum">    2640 </span><span class="lineNoCov">          0 :     else if ( strcmp(langbuf,&quot;fr&quot;)==0 )</span>
<span class="lineNum">    2641 </span><span class="lineNoCov">          0 :         simple_pos = 6 + (rand()&amp;1);</span>
<span class="lineNum">    2642 </span><span class="lineNoCov">          0 :     else if ( strcmp(langbuf,&quot;nl&quot;)==0 )</span>
<span class="lineNum">    2643 </span><span class="lineNoCov">          0 :         simple_pos = 8;</span>
<span class="lineNum">    2644 </span><span class="lineNoCov">          0 :     else if ( strcmp(langbuf,&quot;pl&quot;)==0 )</span>
<span class="lineNum">    2645 </span><span class="lineNoCov">          0 :         simple_pos = 9;</span>
<span class="lineNum">    2646 </span><span class="lineNoCov">          0 :     else if ( strcmp(langbuf,&quot;sl&quot;)==0 )</span>
<span class="lineNum">    2647 </span><span class="lineNoCov">          0 :         simple_pos = 10;</span>
<span class="lineNum">    2648 </span><span class="lineNoCov">          0 :     else if ( strcmp(langbuf,&quot;cs&quot;)==0 )</span>
<span class="lineNum">    2649 </span><span class="lineNoCov">          0 :         simple_pos = 11;</span>
<span class="lineNum">    2650 </span>            :     else
<span class="lineNum">    2651 </span><span class="lineNoCov">          0 :         simple_pos = rand()&amp;3;</span>
<span class="lineNum">    2652 </span><span class="lineNoCov">          0 :     _simple[0] = _simplelatnchoices[simple_pos];</span>
<span class="lineNum">    2653 </span><span class="lineNoCov">          0 :     sample[0].lang = _simplelatnlangs[simple_pos];</span>
<span class="lineNum">    2654 </span>            : 
<span class="lineNum">    2655 </span><span class="lineNoCov">          0 :     for ( j=0; _simplecyrillchoices[j]!=NULL; ++j );</span>
<span class="lineNum">    2656 </span><span class="lineNoCov">          0 :     simple_pos = rand()%(j+1);</span>
<span class="lineNum">    2657 </span><span class="lineNoCov">          0 :     _simplecyrill[0] = _simplecyrillchoices[simple_pos];</span>
<span class="lineNum">    2658 </span><span class="lineNoCov">          0 :     sample[1].lang = _simplecyrilliclangs[simple_pos];</span>
<a name="2659"><span class="lineNum">    2659 </span>            : }</a>
<span class="lineNum">    2660 </span>            : 
<span class="lineNum">    2661 </span><span class="lineNoCov">          0 : static int AllChars( SplineFont *sf, const char *str) {</span>
<span class="lineNum">    2662 </span>            :     int i, ch;
<span class="lineNum">    2663 </span>            :     SplineChar *sc;
<span class="lineNum">    2664 </span>            :     struct altuni *alt;
<span class="lineNum">    2665 </span>            : 
<span class="lineNum">    2666 </span><span class="lineNoCov">          0 :     if ( sf-&gt;subfontcnt==0 ) {</span>
<span class="lineNum">    2667 </span><span class="lineNoCov">          0 :         while ( (ch = utf8_ildb(&amp;str))!='\0' ) {</span>
<span class="lineNum">    2668 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;sf-&gt;glyphcnt; ++i ) if ( (sc = sf-&gt;glyphs[i])!=NULL ) {</span>
<span class="lineNum">    2669 </span><span class="lineNoCov">          0 :                 if ( sc-&gt;unicodeenc == ch )</span>
<span class="lineNum">    2670 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    2671 </span><span class="lineNoCov">          0 :                 for ( alt=sc-&gt;altuni ; alt!=NULL ; alt=alt-&gt;next )</span>
<span class="lineNum">    2672 </span><span class="lineNoCov">          0 :                     if ( alt-&gt;vs==-1 &amp;&amp; alt-&gt;unienc==ch )</span>
<span class="lineNum">    2673 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2674 </span><span class="lineNoCov">          0 :                 if ( alt!=NULL )</span>
<span class="lineNum">    2675 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    2676 </span>            :             }
<span class="lineNum">    2677 </span><span class="lineNoCov">          0 :             if ( i==sf-&gt;glyphcnt || !SCWorthOutputting(sf-&gt;glyphs[i]) )</span>
<span class="lineNum">    2678 </span><span class="lineNoCov">          0 : return( false );</span>
<span class="lineNum">    2679 </span>            :         }
<span class="lineNum">    2680 </span>            :     } else {
<span class="lineNum">    2681 </span><span class="lineNoCov">          0 :         int max = 0, j;</span>
<span class="lineNum">    2682 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;sf-&gt;subfontcnt; ++i )</span>
<span class="lineNum">    2683 </span><span class="lineNoCov">          0 :             if ( sf-&gt;subfonts[i]-&gt;glyphcnt&gt;max ) max = sf-&gt;subfonts[i]-&gt;glyphcnt;</span>
<span class="lineNum">    2684 </span><span class="lineNoCov">          0 :         while ( (ch = utf8_ildb(&amp;str))!='\0' ) {</span>
<span class="lineNum">    2685 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;max; ++i ) {</span>
<span class="lineNum">    2686 </span><span class="lineNoCov">          0 :                 for ( j=0; j&lt;sf-&gt;subfontcnt; ++j )</span>
<span class="lineNum">    2687 </span><span class="lineNoCov">          0 :                     if ( i&lt;sf-&gt;subfonts[j]-&gt;glyphcnt &amp;&amp; sf-&gt;subfonts[j]-&gt;glyphs[i]!=NULL )</span>
<span class="lineNum">    2688 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2689 </span><span class="lineNoCov">          0 :                 if ( j!=sf-&gt;subfontcnt )</span>
<span class="lineNum">    2690 </span><span class="lineNoCov">          0 :                     if ( sf-&gt;subfonts[j]-&gt;glyphs[i]-&gt;unicodeenc == ch )</span>
<span class="lineNum">    2691 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    2692 </span>            :             }
<span class="lineNum">    2693 </span><span class="lineNoCov">          0 :             if ( i==max || !SCWorthOutputting(sf-&gt;subfonts[j]-&gt;glyphs[i]))</span>
<span class="lineNum">    2694 </span><span class="lineNoCov">          0 : return( false );</span>
<span class="lineNum">    2695 </span>            :         }
<span class="lineNum">    2696 </span>            :     }
<span class="lineNum">    2697 </span><span class="lineNoCov">          0 : return( true );</span>
<a name="2698"><span class="lineNum">    2698 </span>            : }</a>
<span class="lineNum">    2699 </span>            : 
<span class="lineNum">    2700 </span><span class="lineNoCov">          0 : static int ScriptInList(uint32 script, uint32 *scripts, int scnt) {</span>
<span class="lineNum">    2701 </span>            :     int s;
<span class="lineNum">    2702 </span>            : 
<span class="lineNum">    2703 </span><span class="lineNoCov">          0 :     for ( s=0; s&lt;scnt; ++s )</span>
<span class="lineNum">    2704 </span><span class="lineNoCov">          0 :         if ( script == scripts[s] )</span>
<span class="lineNum">    2705 </span><span class="lineNoCov">          0 : return( true );</span>
<span class="lineNum">    2706 </span>            : 
<span class="lineNum">    2707 </span><span class="lineNoCov">          0 : return( false );</span>
<a name="2708"><span class="lineNum">    2708 </span>            : }</a>
<span class="lineNum">    2709 </span>            : 
<span class="lineNum">    2710 </span><span class="lineNoCov">          0 : unichar_t *PrtBuildDef( SplineFont *sf, void *tf,</span>
<span class="lineNum">    2711 </span>            :         void (*langsyscallback)(void *tf, int end, uint32 script, uint32 lang) ) {
<span class="lineNum">    2712 </span><span class="lineNoCov">          0 :     int i, j, gotem, len, any=0, foundsomething=0;</span>
<span class="lineNum">    2713 </span><span class="lineNoCov">          0 :     unichar_t *ret=NULL;</span>
<span class="lineNum">    2714 </span>            :     char **cur;
<span class="lineNum">    2715 </span>            :     uint32 scriptsdone[100], scriptsthere[100], langs[100];
<span class="lineNum">    2716 </span>            :     char *randoms[100];
<span class="lineNum">    2717 </span>            :     char buffer[220], *pt;
<span class="lineNum">    2718 </span>            :     int scnt,s,therecnt, rcnt;
<span class="lineNum">    2719 </span>            : 
<span class="lineNum">    2720 </span><span class="lineNoCov">          0 :     OrderSampleByLang();</span>
<span class="lineNum">    2721 </span><span class="lineNoCov">          0 :     therecnt = SF2Scripts(sf,scriptsthere);</span>
<span class="lineNum">    2722 </span>            : 
<span class="lineNum">    2723 </span><span class="lineNoCov">          0 :     scnt = 0;</span>
<span class="lineNum">    2724 </span>            : 
<span class="lineNum">    2725 </span>            :     while ( 1 ) {
<span class="lineNum">    2726 </span><span class="lineNoCov">          0 :         len = any = 0;</span>
<span class="lineNum">    2727 </span><span class="lineNoCov">          0 :         for ( i=0; sample[i].sample!=NULL; ++i ) {</span>
<span class="lineNum">    2728 </span><span class="lineNoCov">          0 :             gotem = true;</span>
<span class="lineNum">    2729 </span><span class="lineNoCov">          0 :             cur = sample[i].sample;</span>
<span class="lineNum">    2730 </span><span class="lineNoCov">          0 :             for ( j=0; cur[j]!=NULL &amp;&amp; gotem; ++j )</span>
<span class="lineNum">    2731 </span><span class="lineNoCov">          0 :                 gotem = AllChars(sf,cur[j]);</span>
<span class="lineNum">    2732 </span><span class="lineNoCov">          0 :             if ( !gotem &amp;&amp; sample[i].sample==_LiBai ) {</span>
<span class="lineNum">    2733 </span><span class="lineNoCov">          0 :                 cur = _LiBaiShort;</span>
<span class="lineNum">    2734 </span><span class="lineNoCov">          0 :                 gotem = true;</span>
<span class="lineNum">    2735 </span><span class="lineNoCov">          0 :                 for ( j=0; cur[j]!=NULL &amp;&amp; gotem; ++j )</span>
<span class="lineNum">    2736 </span><span class="lineNoCov">          0 :                     gotem = AllChars(sf,cur[j]);</span>
<span class="lineNum">    2737 </span>            :             }
<span class="lineNum">    2738 </span><span class="lineNoCov">          0 :             if ( gotem ) {</span>
<span class="lineNum">    2739 </span><span class="lineNoCov">          0 :                 for ( s=0; s&lt;scnt; ++s )</span>
<span class="lineNum">    2740 </span><span class="lineNoCov">          0 :                     if ( scriptsdone[s]==sample[i].otf_script )</span>
<span class="lineNum">    2741 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2742 </span><span class="lineNoCov">          0 :                 if ( s==scnt )</span>
<span class="lineNum">    2743 </span><span class="lineNoCov">          0 :                     scriptsdone[scnt++] = sample[i].otf_script;</span>
<span class="lineNum">    2744 </span>            : 
<span class="lineNum">    2745 </span><span class="lineNoCov">          0 :                 foundsomething = true;</span>
<span class="lineNum">    2746 </span><span class="lineNoCov">          0 :                 ++any;</span>
<span class="lineNum">    2747 </span><span class="lineNoCov">          0 :                 for ( j=0; cur[j]!=NULL; ++j ) {</span>
<span class="lineNum">    2748 </span><span class="lineNoCov">          0 :                     if ( ret )</span>
<span class="lineNum">    2749 </span><span class="lineNoCov">          0 :                         utf82u_strcpy(ret+len,cur[j]);</span>
<span class="lineNum">    2750 </span><span class="lineNoCov">          0 :                     len += g_utf8_strlen( cur[j], -1 );</span>
<span class="lineNum">    2751 </span><span class="lineNoCov">          0 :                     if ( ret )</span>
<span class="lineNum">    2752 </span><span class="lineNoCov">          0 :                         ret[len] = '\n';</span>
<span class="lineNum">    2753 </span><span class="lineNoCov">          0 :                     ++len;</span>
<span class="lineNum">    2754 </span>            :                 }
<span class="lineNum">    2755 </span><span class="lineNoCov">          0 :                 if ( ret )</span>
<span class="lineNum">    2756 </span><span class="lineNoCov">          0 :                     ret[len] = '\n';</span>
<span class="lineNum">    2757 </span><span class="lineNoCov">          0 :                 ++len;</span>
<span class="lineNum">    2758 </span><span class="lineNoCov">          0 :                 if ( ret &amp;&amp; langsyscallback!=NULL )</span>
<span class="lineNum">    2759 </span><span class="lineNoCov">          0 :                     (langsyscallback)(tf,len,sample[i].otf_script,sample[i].lang);</span>
<span class="lineNum">    2760 </span>            :             }
<span class="lineNum">    2761 </span>            :         }
<span class="lineNum">    2762 </span>            : 
<span class="lineNum">    2763 </span><span class="lineNoCov">          0 :         rcnt = 0;</span>
<span class="lineNum">    2764 </span><span class="lineNoCov">          0 :         for ( s=0; s&lt;therecnt; ++s ) if ( !ScriptInList(scriptsthere[s],scriptsdone,scnt)) {</span>
<span class="lineNum">    2765 </span><span class="lineNoCov">          0 :             if ( ret ) {</span>
<span class="lineNum">    2766 </span><span class="lineNoCov">          0 :                 if ( randoms[rcnt]!='\0' ) {</span>
<span class="lineNum">    2767 </span><span class="lineNoCov">          0 :                     utf82u_strcpy(ret+len,randoms[rcnt]);</span>
<span class="lineNum">    2768 </span><span class="lineNoCov">          0 :                     len += u_strlen(ret+len);</span>
<span class="lineNum">    2769 </span><span class="lineNoCov">          0 :                     ret[len++] = '\n';</span>
<span class="lineNum">    2770 </span><span class="lineNoCov">          0 :                     ret[len] = '\0';</span>
<span class="lineNum">    2771 </span><span class="lineNoCov">          0 :                     if ( langsyscallback!=NULL )</span>
<span class="lineNum">    2772 </span><span class="lineNoCov">          0 :                         (langsyscallback)(tf,len,scriptsthere[s],langs[rcnt]);</span>
<span class="lineNum">    2773 </span>            :                 }
<span class="lineNum">    2774 </span><span class="lineNoCov">          0 :                 free(randoms[rcnt]);</span>
<span class="lineNum">    2775 </span>            :             } else {
<span class="lineNum">    2776 </span><span class="lineNoCov">          0 :                 randoms[rcnt] = RandomParaFromScript(scriptsthere[s],&amp;langs[rcnt],sf);</span>
<span class="lineNum">    2777 </span><span class="lineNoCov">          0 :                 for ( pt=randoms[rcnt]; *pt==' '; ++pt );</span>
<span class="lineNum">    2778 </span><span class="lineNoCov">          0 :                 if ( *pt=='\0' )</span>
<span class="lineNum">    2779 </span><span class="lineNoCov">          0 :                     *randoms[rcnt] = '\0';</span>
<span class="lineNum">    2780 </span>            :                 else {
<span class="lineNum">    2781 </span><span class="lineNoCov">          0 :                     len += g_utf8_strlen( randoms[rcnt], -1 )+2;</span>
<span class="lineNum">    2782 </span><span class="lineNoCov">          0 :                     foundsomething = true;</span>
<span class="lineNum">    2783 </span>            :                 }
<span class="lineNum">    2784 </span>            :             }
<span class="lineNum">    2785 </span><span class="lineNoCov">          0 :             ++rcnt;</span>
<span class="lineNum">    2786 </span>            :         }
<span class="lineNum">    2787 </span>            : 
<span class="lineNum">    2788 </span><span class="lineNoCov">          0 :         if ( !foundsomething ) {</span>
<span class="lineNum">    2789 </span>            :             /* For example, Apostolos's Phaistos Disk font. There is no OT script*/
<span class="lineNum">    2790 </span>            :             /*  code assigned for those unicode points */
<span class="lineNum">    2791 </span>            :             int gid;
<span class="lineNum">    2792 </span>            :             SplineChar *sc;
<span class="lineNum">    2793 </span>            : 
<span class="lineNum">    2794 </span><span class="lineNoCov">          0 :             pt = buffer;</span>
<span class="lineNum">    2795 </span><span class="lineNoCov">          0 :             for ( gid=i=0; gid&lt;sf-&gt;glyphcnt &amp;&amp; pt&lt;buffer+sizeof(buffer)-4 &amp;&amp; i&lt;50; ++gid ) {</span>
<span class="lineNum">    2796 </span><span class="lineNoCov">          0 :                 if ( (sc=sf-&gt;glyphs[gid])!=NULL &amp;&amp; sc-&gt;unicodeenc!=-1 ) {</span>
<span class="lineNum">    2797 </span><span class="lineNoCov">          0 :                     pt = utf8_idpb(pt,sc-&gt;unicodeenc,0);</span>
<span class="lineNum">    2798 </span><span class="lineNoCov">          0 :                     ++i;</span>
<span class="lineNum">    2799 </span>            :                 }
<span class="lineNum">    2800 </span>            :             }
<span class="lineNum">    2801 </span><span class="lineNoCov">          0 :             *pt = '\0';</span>
<span class="lineNum">    2802 </span><span class="lineNoCov">          0 :             if ( i&gt;0 ) {</span>
<span class="lineNum">    2803 </span><span class="lineNoCov">          0 :                 if ( ret ) {</span>
<span class="lineNum">    2804 </span><span class="lineNoCov">          0 :                     utf82u_strcpy(ret+len,buffer);</span>
<span class="lineNum">    2805 </span><span class="lineNoCov">          0 :                     len += u_strlen(ret+len);</span>
<span class="lineNum">    2806 </span><span class="lineNoCov">          0 :                     ret[len++] = '\n';</span>
<span class="lineNum">    2807 </span><span class="lineNoCov">          0 :                     ret[len] = '\0';</span>
<span class="lineNum">    2808 </span><span class="lineNoCov">          0 :                     if ( langsyscallback!=NULL )</span>
<span class="lineNum">    2809 </span><span class="lineNoCov">          0 :                         (langsyscallback)(tf,len,DEFAULT_SCRIPT,DEFAULT_LANG);</span>
<span class="lineNum">    2810 </span>            :                 } else
<span class="lineNum">    2811 </span><span class="lineNoCov">          0 :                     len += g_utf8_strlen( buffer, -1 )+1;</span>
<span class="lineNum">    2812 </span>            :             }
<span class="lineNum">    2813 </span>            :         }
<span class="lineNum">    2814 </span>            : 
<span class="lineNum">    2815 </span><span class="lineNoCov">          0 :         if ( ret ) {</span>
<span class="lineNum">    2816 </span><span class="lineNoCov">          0 :             ret[len]='\0';</span>
<span class="lineNum">    2817 </span><span class="lineNoCov">          0 : return( ret );</span>
<span class="lineNum">    2818 </span>            :         }
<span class="lineNum">    2819 </span><span class="lineNoCov">          0 :         if ( len == 0 ) {</span>
<span class="lineNum">    2820 </span>            :             /* Er... We didn't find anything?! */
<span class="lineNum">    2821 </span><span class="lineNoCov">          0 : return( calloc(1,sizeof(unichar_t)));</span>
<span class="lineNum">    2822 </span>            :         }
<span class="lineNum">    2823 </span><span class="lineNoCov">          0 :         ret = malloc((len+1)*sizeof(unichar_t));</span>
<span class="lineNum">    2824 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2825 </span>            : }
<span class="lineNum">    2826 </span>            : 
<span class="lineNum">    2827 </span>            : /* ************************************************************************** */
<span class="lineNum">    2828 </span>            : /* ******************************* Print Code ******************************* */
<a name="2829"><span class="lineNum">    2829 </span>            : /* ************************************************************************** */</a>
<span class="lineNum">    2830 </span>            : 
<span class="lineNum">    2831 </span><span class="lineNoCov">          0 : static void QueueIt(PI *pi) {</span>
<span class="lineNum">    2832 </span>            :     #if !defined(__MINGW32__)
<span class="lineNum">    2833 </span>            :     int pid;
<span class="lineNum">    2834 </span>            :     int stdinno, i, status;
<span class="lineNum">    2835 </span>            :     char *argv[40], buf[10];
<span class="lineNum">    2836 </span>            : 
<span class="lineNum">    2837 </span><span class="lineNoCov">          0 :     if ( (pid=fork())==0 ) {</span>
<span class="lineNum">    2838 </span><span class="lineNoCov">          0 :         stdinno = fileno(stdin);</span>
<span class="lineNum">    2839 </span><span class="lineNoCov">          0 :         close(stdinno);</span>
<span class="lineNum">    2840 </span><span class="lineNoCov">          0 :         dup2(fileno(pi-&gt;out),stdinno);</span>
<span class="lineNum">    2841 </span><span class="lineNoCov">          0 :         i = 0;</span>
<span class="lineNum">    2842 </span><span class="lineNoCov">          0 :         if ( pi-&gt;printtype == pt_ghostview ) {</span>
<span class="lineNum">    2843 </span><span class="lineNoCov">          0 :             if ( !use_gv )</span>
<span class="lineNum">    2844 </span><span class="lineNoCov">          0 :                 argv[i++] = &quot;ghostview&quot;;</span>
<span class="lineNum">    2845 </span>            :             else {
<span class="lineNum">    2846 </span><span class="lineNoCov">          0 :                 argv[i++] = &quot;gv&quot;;</span>
<span class="lineNum">    2847 </span><span class="lineNoCov">          0 :                 argv[i++] = &quot;-antialias&quot;;</span>
<span class="lineNum">    2848 </span>            :             }
<span class="lineNum">    2849 </span><span class="lineNoCov">          0 :             argv[i++] = &quot;-&quot;;          /* read from stdin */</span>
<span class="lineNum">    2850 </span><span class="lineNoCov">          0 :         } else if ( pi-&gt;printtype == pt_lp ) {</span>
<span class="lineNum">    2851 </span><span class="lineNoCov">          0 :             argv[i++] = &quot;lp&quot;;</span>
<span class="lineNum">    2852 </span><span class="lineNoCov">          0 :             if ( pi-&gt;printer!=NULL ) {</span>
<span class="lineNum">    2853 </span><span class="lineNoCov">          0 :                 argv[i++] = &quot;-d&quot;;</span>
<span class="lineNum">    2854 </span><span class="lineNoCov">          0 :                 argv[i++] = pi-&gt;printer;</span>
<span class="lineNum">    2855 </span>            :             }
<span class="lineNum">    2856 </span><span class="lineNoCov">          0 :             if ( pi-&gt;copies&gt;1 ) {</span>
<span class="lineNum">    2857 </span><span class="lineNoCov">          0 :                 argv[i++] = &quot;-n&quot;;</span>
<span class="lineNum">    2858 </span><span class="lineNoCov">          0 :                 sprintf(buf,&quot;%d&quot;, pi-&gt;copies );</span>
<span class="lineNum">    2859 </span><span class="lineNoCov">          0 :                 argv[i++] = buf;</span>
<span class="lineNum">    2860 </span>            :             }
<span class="lineNum">    2861 </span><span class="lineNoCov">          0 :         } else if ( pi-&gt;printtype == pt_lpr ) {</span>
<span class="lineNum">    2862 </span><span class="lineNoCov">          0 :             argv[i++] = &quot;lpr&quot;;</span>
<span class="lineNum">    2863 </span><span class="lineNoCov">          0 :             if ( pi-&gt;printer!=NULL ) {</span>
<span class="lineNum">    2864 </span><span class="lineNoCov">          0 :                 argv[i++] = &quot;-P&quot;;</span>
<span class="lineNum">    2865 </span><span class="lineNoCov">          0 :                 argv[i++] = pi-&gt;printer;</span>
<span class="lineNum">    2866 </span>            :             }
<span class="lineNum">    2867 </span><span class="lineNoCov">          0 :             if ( pi-&gt;copies&gt;1 ) {</span>
<span class="lineNum">    2868 </span><span class="lineNoCov">          0 :                 sprintf(buf,&quot;-#%d&quot;, pi-&gt;copies );</span>
<span class="lineNum">    2869 </span><span class="lineNoCov">          0 :                 argv[i++] = buf;</span>
<span class="lineNum">    2870 </span>            :             }
<span class="lineNum">    2871 </span>            :         } else {
<span class="lineNum">    2872 </span>            :             char *temp, *pt, *start;
<span class="lineNum">    2873 </span><span class="lineNoCov">          0 :             int quoted=0;</span>
<span class="lineNum">    2874 </span>            :             /* This is in the child. We're going to do an exec soon */
<span class="lineNum">    2875 </span>            :             /*  We don't need to free things here */
<span class="lineNum">    2876 </span><span class="lineNoCov">          0 :             temp = copy(printcommand);</span>
<span class="lineNum">    2877 </span><span class="lineNoCov">          0 :             for ( pt=start=temp; *pt ; ++pt ) {</span>
<span class="lineNum">    2878 </span><span class="lineNoCov">          0 :                 if ( *pt==quoted ) {</span>
<span class="lineNum">    2879 </span><span class="lineNoCov">          0 :                     quoted = 0;</span>
<span class="lineNum">    2880 </span><span class="lineNoCov">          0 :                     *pt = '\0';</span>
<span class="lineNum">    2881 </span><span class="lineNoCov">          0 :                 } else if ( quoted )</span>
<span class="lineNum">    2882 </span>            :                     /* Do nothing */;
<span class="lineNum">    2883 </span><span class="lineNoCov">          0 :                 else if ( *pt=='&quot;' || *pt=='\'' ) {</span>
<span class="lineNum">    2884 </span><span class="lineNoCov">          0 :                     start = pt+1;</span>
<span class="lineNum">    2885 </span><span class="lineNoCov">          0 :                     quoted = *pt;</span>
<span class="lineNum">    2886 </span><span class="lineNoCov">          0 :                 } else if ( *pt==' ' )</span>
<span class="lineNum">    2887 </span><span class="lineNoCov">          0 :                     *pt = '\0';</span>
<span class="lineNum">    2888 </span><span class="lineNoCov">          0 :                 if ( *pt=='\0' ) {</span>
<span class="lineNum">    2889 </span><span class="lineNoCov">          0 :                     if ( i&lt;sizeof(argv)/sizeof(argv[0])-1 )</span>
<span class="lineNum">    2890 </span><span class="lineNoCov">          0 :                         argv[i++] = start;</span>
<span class="lineNum">    2891 </span><span class="lineNoCov">          0 :                     while ( pt[1]==' ' ) ++pt;</span>
<span class="lineNum">    2892 </span><span class="lineNoCov">          0 :                     start = pt+1;</span>
<span class="lineNum">    2893 </span>            :                 }
<span class="lineNum">    2894 </span>            :             }
<span class="lineNum">    2895 </span><span class="lineNoCov">          0 :             if ( pt&gt;start &amp;&amp; i&lt;sizeof(argv)/sizeof(argv[0])-1 )</span>
<span class="lineNum">    2896 </span><span class="lineNoCov">          0 :                 argv[i++] = start;</span>
<span class="lineNum">    2897 </span>            :         }
<span class="lineNum">    2898 </span><span class="lineNoCov">          0 :         argv[i] = NULL;</span>
<span class="lineNum">    2899 </span>            :  /*for ( i=0; argv[i]!=NULL; ++i ) printf( &quot;%s &quot;, argv[i]); printf(&quot;\n&quot; );*/
<span class="lineNum">    2900 </span><span class="lineNoCov">          0 :         execvp(argv[0],argv);</span>
<span class="lineNum">    2901 </span><span class="lineNoCov">          0 :         if ( pi-&gt;printtype == pt_ghostview ) {</span>
<span class="lineNum">    2902 </span><span class="lineNoCov">          0 :             argv[0] = &quot;gv&quot;;</span>
<span class="lineNum">    2903 </span><span class="lineNoCov">          0 :             execvp(argv[0],argv);</span>
<span class="lineNum">    2904 </span>            :         }
<span class="lineNum">    2905 </span><span class="lineNoCov">          0 :         fprintf( stderr, &quot;Failed to exec print job\n&quot; );</span>
<span class="lineNum">    2906 </span>            :         /*IError(&quot;Failed to exec print job&quot;);*/ /* X Server gets confused by talking to the child */
<span class="lineNum">    2907 </span><span class="lineNoCov">          0 :         _exit(1);</span>
<span class="lineNum">    2908 </span><span class="lineNoCov">          0 :     } else if ( pid==-1 )</span>
<span class="lineNum">    2909 </span><span class="lineNoCov">          0 :         IError(&quot;Failed to fork print job&quot;);</span>
<span class="lineNum">    2910 </span><span class="lineNoCov">          0 :     else if ( pi-&gt;printtype != pt_ghostview ) {</span>
<span class="lineNum">    2911 </span><span class="lineNoCov">          0 :         waitpid(pid,&amp;status,0);</span>
<span class="lineNum">    2912 </span><span class="lineNoCov">          0 :         if ( !WIFEXITED(status) )</span>
<span class="lineNum">    2913 </span><span class="lineNoCov">          0 :             IError(&quot;Failed to queue print job&quot;);</span>
<span class="lineNum">    2914 </span>            :     } else {
<span class="lineNum">    2915 </span><span class="lineNoCov">          0 :         sleep(1);</span>
<span class="lineNum">    2916 </span><span class="lineNoCov">          0 :         if ( waitpid(pid,&amp;status,WNOHANG)&gt;0 ) {</span>
<span class="lineNum">    2917 </span><span class="lineNoCov">          0 :             if ( !WIFEXITED(status) )</span>
<span class="lineNum">    2918 </span><span class="lineNoCov">          0 :                 IError(&quot;Failed to run ghostview&quot;);</span>
<span class="lineNum">    2919 </span>            :         }
<span class="lineNum">    2920 </span>            :     }
<span class="lineNum">    2921 </span><span class="lineNoCov">          0 :     waitpid(-1,&amp;status,WNOHANG);    /* Clean up any zombie ghostviews */</span>
<span class="lineNum">    2922 </span>            :     #endif
<a name="2923"><span class="lineNum">    2923 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2924 </span>            : 
<span class="lineNum">    2925 </span><span class="lineNoCov">          0 : void DoPrinting(PI *pi,char *filename) {</span>
<span class="lineNum">    2926 </span><span class="lineNoCov">          0 :     int sfmax=1;</span>
<span class="lineNum">    2927 </span>            : 
<span class="lineNum">    2928 </span><span class="lineNoCov">          0 :     if ( pi-&gt;pt==pt_fontsample ) {</span>
<span class="lineNum">    2929 </span>            :         struct sfmaps *sfmap;
<span class="lineNum">    2930 </span><span class="lineNoCov">          0 :         for ( sfmap=pi-&gt;sample-&gt;sfmaps, sfmax=0; sfmap!=NULL; sfmap=sfmap-&gt;next, ++sfmax );</span>
<span class="lineNum">    2931 </span><span class="lineNoCov">          0 :         if ( sfmax==0 ) sfmax=1;</span>
<span class="lineNum">    2932 </span>            :     }
<span class="lineNum">    2933 </span><span class="lineNoCov">          0 :     pi-&gt;sfmax = sfmax;</span>
<span class="lineNum">    2934 </span><span class="lineNoCov">          0 :     pi-&gt;sfbits = calloc(sfmax,sizeof(struct sfbits));</span>
<span class="lineNum">    2935 </span><span class="lineNoCov">          0 :     pi-&gt;sfcnt = 0;</span>
<span class="lineNum">    2936 </span>            : 
<span class="lineNum">    2937 </span><span class="lineNoCov">          0 :     if ( pi-&gt;pt==pt_fontdisplay )</span>
<span class="lineNum">    2938 </span><span class="lineNoCov">          0 :         PIFontDisplay(pi);</span>
<span class="lineNum">    2939 </span><span class="lineNoCov">          0 :     else if ( pi-&gt;pt==pt_fontsample )</span>
<span class="lineNum">    2940 </span><span class="lineNoCov">          0 :         PIFontSample(pi);</span>
<span class="lineNum">    2941 </span><span class="lineNoCov">          0 :     else if ( pi-&gt;pt==pt_multisize )</span>
<span class="lineNum">    2942 </span><span class="lineNoCov">          0 :         PIMultiSize(pi);</span>
<span class="lineNum">    2943 </span>            :     else
<span class="lineNum">    2944 </span><span class="lineNoCov">          0 :         PIChars(pi);</span>
<span class="lineNum">    2945 </span><span class="lineNoCov">          0 :     rewind(pi-&gt;out);</span>
<span class="lineNum">    2946 </span><span class="lineNoCov">          0 :     if ( ferror(pi-&gt;out) )</span>
<span class="lineNum">    2947 </span><span class="lineNoCov">          0 :         ff_post_error(_(&quot;Print Failed&quot;),_(&quot;Failed to generate postscript in file %s&quot;),</span>
<span class="lineNum">    2948 </span>            :                 filename==NULL?&quot;temporary&quot;:filename );
<span class="lineNum">    2949 </span><span class="lineNoCov">          0 :     if ( pi-&gt;printtype!=pt_file &amp;&amp; pi-&gt;printtype!=pt_pdf )</span>
<span class="lineNum">    2950 </span><span class="lineNoCov">          0 :         QueueIt(pi);</span>
<span class="lineNum">    2951 </span><span class="lineNoCov">          0 :     if ( fclose(pi-&gt;out)!=0 )</span>
<span class="lineNum">    2952 </span><span class="lineNoCov">          0 :         ff_post_error(_(&quot;Print Failed&quot;),_(&quot;Failed to generate postscript in file %s&quot;),</span>
<span class="lineNum">    2953 </span>            :                 filename==NULL?&quot;temporary&quot;:filename );
<span class="lineNum">    2954 </span><span class="lineNoCov">          0 :     free(pi-&gt;sfbits);</span>
<span class="lineNum">    2955 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2956 </span>            : 
<span class="lineNum">    2957 </span>            : /* ************************************************************************** */
<span class="lineNum">    2958 </span>            : /* ******************************* Init Code ******************************** */
<a name="2959"><span class="lineNum">    2959 </span>            : /* ************************************************************************** */</a>
<span class="lineNum">    2960 </span>            : 
<span class="lineNum">    2961 </span><span class="lineNoCov">          0 : static void PIGetPrinterDefs(PI *pi) {</span>
<span class="lineNum">    2962 </span><span class="lineNoCov">          0 :     pi-&gt;pagewidth = pagewidth;</span>
<span class="lineNum">    2963 </span><span class="lineNoCov">          0 :     pi-&gt;pageheight = pageheight;</span>
<span class="lineNum">    2964 </span><span class="lineNoCov">          0 :     pi-&gt;printtype = printtype;</span>
<span class="lineNum">    2965 </span><span class="lineNoCov">          0 :     pi-&gt;printer = copy(printlazyprinter);</span>
<span class="lineNum">    2966 </span><span class="lineNoCov">          0 :     pi-&gt;copies = 1;</span>
<span class="lineNum">    2967 </span><span class="lineNoCov">          0 :     if ( pi-&gt;pagewidth!=0 &amp;&amp; pi-&gt;pageheight!=0 )</span>
<span class="lineNum">    2968 </span><span class="lineNoCov">          0 :         pi-&gt;hadsize = true;</span>
<span class="lineNum">    2969 </span>            :     else {
<span class="lineNum">    2970 </span><span class="lineNoCov">          0 :         pi-&gt;pagewidth = 595;</span>
<span class="lineNum">    2971 </span><span class="lineNoCov">          0 :         pi-&gt;pageheight = 792;</span>
<span class="lineNum">    2972 </span>            :         /* numbers chosen to fit either A4 or US-Letter */
<span class="lineNum">    2973 </span><span class="lineNoCov">          0 :         pi-&gt;hadsize = false; /* But we don't want to do a setpagedevice on this because then some printers will wait until fed this odd page size */</span>
<span class="lineNum">    2974 </span>            :     }
<a name="2975"><span class="lineNum">    2975 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2976 </span>            : 
<span class="lineNum">    2977 </span><span class="lineNoCov">          0 : void PI_Init(PI *pi,FontViewBase *fv,SplineChar *sc) {</span>
<span class="lineNum">    2978 </span><span class="lineNoCov">          0 :     int di = fv!=NULL?0:sc!=NULL?1:2;</span>
<span class="lineNum">    2979 </span>            : 
<span class="lineNum">    2980 </span><span class="lineNoCov">          0 :     memset(pi,'\0',sizeof(*pi));</span>
<span class="lineNum">    2981 </span><span class="lineNoCov">          0 :     pi-&gt;fv = fv;</span>
<span class="lineNum">    2982 </span><span class="lineNoCov">          0 :     pi-&gt;sc = sc;</span>
<span class="lineNum">    2983 </span><span class="lineNoCov">          0 :     if ( fv!=NULL ) {</span>
<span class="lineNum">    2984 </span><span class="lineNoCov">          0 :         pi-&gt;mainsf = fv-&gt;sf;</span>
<span class="lineNum">    2985 </span><span class="lineNoCov">          0 :         pi-&gt;mainmap = fv-&gt;map;</span>
<span class="lineNum">    2986 </span><span class="lineNoCov">          0 :     } else if ( sc!=NULL ) {</span>
<span class="lineNum">    2987 </span><span class="lineNoCov">          0 :         pi-&gt;mainsf = sc-&gt;parent;</span>
<span class="lineNum">    2988 </span><span class="lineNoCov">          0 :         pi-&gt;mainmap = pi-&gt;mainsf-&gt;fv-&gt;map;</span>
<span class="lineNum">    2989 </span>            :     }
<span class="lineNum">    2990 </span><span class="lineNoCov">          0 :     if ( pi-&gt;mainsf-&gt;cidmaster )</span>
<span class="lineNum">    2991 </span><span class="lineNoCov">          0 :         pi-&gt;mainsf = pi-&gt;mainsf-&gt;cidmaster;</span>
<span class="lineNum">    2992 </span><span class="lineNoCov">          0 :     PIGetPrinterDefs(pi);</span>
<span class="lineNum">    2993 </span><span class="lineNoCov">          0 :     pi-&gt;pointsize = pdefs[di].pointsize;</span>
<span class="lineNum">    2994 </span><span class="lineNoCov">          0 :     if ( pi-&gt;pointsize==0 )</span>
<span class="lineNum">    2995 </span><span class="lineNoCov">          0 :         pi-&gt;pointsize = pi-&gt;mainsf-&gt;subfontcnt!=0?18:20;               /* 18 fits 20 across, 20 fits 16 */</span>
<span class="lineNum">    2996 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2997 </span>            : 
<span class="lineNum">    2998 </span>            : 
<span class="lineNum">    2999 </span>            : /* ************************************************************************** */
<span class="lineNum">    3000 </span>            : /* ******************************** Scripting ******************************* */
<a name="3001"><span class="lineNum">    3001 </span>            : /* ************************************************************************** */</a>
<span class="lineNum">    3002 </span>            : 
<span class="lineNum">    3003 </span><span class="lineNoCov">          0 : static unichar_t *FileToUString(char *filename,int max) {</span>
<span class="lineNum">    3004 </span>            :     FILE *file;
<span class="lineNum">    3005 </span>            :     int ch, ch2;
<span class="lineNum">    3006 </span><span class="lineNoCov">          0 :     int format=0;</span>
<span class="lineNum">    3007 </span>            :     unichar_t *space, *upt, *end;
<span class="lineNum">    3008 </span>            : 
<span class="lineNum">    3009 </span><span class="lineNoCov">          0 :     file = fopen( filename,&quot;rb&quot; );</span>
<span class="lineNum">    3010 </span><span class="lineNoCov">          0 :     if ( file==NULL )</span>
<span class="lineNum">    3011 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    3012 </span><span class="lineNoCov">          0 :     ch = getc(file); ch2 = getc(file);</span>
<span class="lineNum">    3013 </span><span class="lineNoCov">          0 :     if ( ch==0xfe &amp;&amp; ch2==0xff )</span>
<span class="lineNum">    3014 </span><span class="lineNoCov">          0 :         format = 1;             /* normal ucs2 */</span>
<span class="lineNum">    3015 </span><span class="lineNoCov">          0 :     else if ( ch==0xff &amp;&amp; ch2==0xfe )</span>
<span class="lineNum">    3016 </span><span class="lineNoCov">          0 :         format = 2;             /* byte-swapped ucs2 */</span>
<span class="lineNum">    3017 </span>            :     else
<span class="lineNum">    3018 </span><span class="lineNoCov">          0 :         rewind(file);</span>
<span class="lineNum">    3019 </span><span class="lineNoCov">          0 :     space = upt = malloc((max+1)*sizeof(unichar_t));</span>
<span class="lineNum">    3020 </span><span class="lineNoCov">          0 :     end = space+max;</span>
<span class="lineNum">    3021 </span><span class="lineNoCov">          0 :     if ( format!=0 ) {</span>
<span class="lineNum">    3022 </span><span class="lineNoCov">          0 :         while ( upt&lt;end ) {</span>
<span class="lineNum">    3023 </span><span class="lineNoCov">          0 :             ch = getc(file); ch2 = getc(file);</span>
<span class="lineNum">    3024 </span><span class="lineNoCov">          0 :             if ( ch2==EOF )</span>
<span class="lineNum">    3025 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    3026 </span><span class="lineNoCov">          0 :             if ( format==1 )</span>
<span class="lineNum">    3027 </span><span class="lineNoCov">          0 :                 *upt ++ = (ch&lt;&lt;8)|ch2;</span>
<span class="lineNum">    3028 </span>            :             else
<span class="lineNum">    3029 </span><span class="lineNoCov">          0 :                 *upt ++ = (ch2&lt;&lt;8)|ch;</span>
<span class="lineNum">    3030 </span>            :         }
<span class="lineNum">    3031 </span>            :     } else {
<span class="lineNum">    3032 </span>            :         char buffer[400];
<span class="lineNum">    3033 </span><span class="lineNoCov">          0 :         while ( fgets(buffer,sizeof(buffer),file)!=NULL ) {</span>
<span class="lineNum">    3034 </span><span class="lineNoCov">          0 :             def2u_strncpy(upt,buffer,end-upt);</span>
<span class="lineNum">    3035 </span><span class="lineNoCov">          0 :             upt += u_strlen(upt);</span>
<span class="lineNum">    3036 </span>            :         }
<span class="lineNum">    3037 </span>            :     }
<span class="lineNum">    3038 </span><span class="lineNoCov">          0 :     *upt = '\0';</span>
<span class="lineNum">    3039 </span><span class="lineNoCov">          0 :     fclose(file);</span>
<span class="lineNum">    3040 </span><span class="lineNoCov">          0 : return( space );</span>
<a name="3041"><span class="lineNum">    3041 </span>            : }</a>
<span class="lineNum">    3042 </span>            : 
<span class="lineNum">    3043 </span><span class="lineNoCov">          0 : void ScriptPrint(FontViewBase *fv,int type,int32 *pointsizes,char *samplefile,</span>
<span class="lineNum">    3044 </span>            :         unichar_t *sample, char *outputfile) {
<span class="lineNum">    3045 </span>            :     PI pi;
<span class="lineNum">    3046 </span>            :     char buf[100];
<span class="lineNum">    3047 </span>            :     LayoutInfo *li;
<span class="lineNum">    3048 </span>            :     unichar_t temp[2];
<span class="lineNum">    3049 </span>            : 
<span class="lineNum">    3050 </span><span class="lineNoCov">          0 :     PI_Init(&amp;pi,fv,NULL);</span>
<span class="lineNum">    3051 </span><span class="lineNoCov">          0 :     if ( pointsizes!=NULL ) {</span>
<span class="lineNum">    3052 </span><span class="lineNoCov">          0 :         pi.pointsizes = pointsizes;</span>
<span class="lineNum">    3053 </span><span class="lineNoCov">          0 :         pi.pointsize = pointsizes[0];</span>
<span class="lineNum">    3054 </span>            :     }
<span class="lineNum">    3055 </span><span class="lineNoCov">          0 :     pi.pt = type;</span>
<span class="lineNum">    3056 </span><span class="lineNoCov">          0 :     if ( type==pt_fontsample ) {</span>
<span class="lineNum">    3057 </span><span class="lineNoCov">          0 :         int width = (pi.pagewidth-1*72)*printdpi/72;</span>
<span class="lineNum">    3058 </span><span class="lineNoCov">          0 :         li = calloc(1,sizeof(LayoutInfo));</span>
<span class="lineNum">    3059 </span><span class="lineNoCov">          0 :         temp[0] = 0;</span>
<span class="lineNum">    3060 </span><span class="lineNoCov">          0 :         li-&gt;wrap = true;</span>
<span class="lineNum">    3061 </span><span class="lineNoCov">          0 :         li-&gt;dpi = printdpi;</span>
<span class="lineNum">    3062 </span><span class="lineNoCov">          0 :         li-&gt;ps = -1;</span>
<span class="lineNum">    3063 </span><span class="lineNoCov">          0 :         li-&gt;text = u_copy(temp);</span>
<span class="lineNum">    3064 </span><span class="lineNoCov">          0 :         SFMapOfSF(li,fv-&gt;sf);</span>
<span class="lineNum">    3065 </span><span class="lineNoCov">          0 :         LI_SetFontData(li,0,-1, fv-&gt;sf, fv-&gt;active_layer,sftf_otf,pi.pointsize,true,width);</span>
<span class="lineNum">    3066 </span>            : 
<span class="lineNum">    3067 </span><span class="lineNoCov">          0 :         if ( samplefile!=NULL &amp;&amp; *samplefile!='\0' )</span>
<span class="lineNum">    3068 </span><span class="lineNoCov">          0 :             sample = FileToUString(samplefile,65536);</span>
<span class="lineNum">    3069 </span><span class="lineNoCov">          0 :         if ( sample==NULL )</span>
<span class="lineNum">    3070 </span><span class="lineNoCov">          0 :             sample = PrtBuildDef(pi.mainsf,li,(void (*)(void *, int, uint32, uint32))LayoutInfoInitLangSys);</span>
<span class="lineNum">    3071 </span>            :         else
<span class="lineNum">    3072 </span><span class="lineNoCov">          0 :             LayoutInfoInitLangSys(li,u_strlen(sample),DEFAULT_SCRIPT,DEFAULT_LANG);</span>
<span class="lineNum">    3073 </span><span class="lineNoCov">          0 :         LayoutInfoSetTitle(li, sample, width);</span>
<span class="lineNum">    3074 </span><span class="lineNoCov">          0 :         pi.sample = li;</span>
<span class="lineNum">    3075 </span><span class="lineNoCov">          0 :         free(sample);</span>
<span class="lineNum">    3076 </span>            :     }
<span class="lineNum">    3077 </span><span class="lineNoCov">          0 :     if ( pi.printtype==pt_file || pi.printtype==pt_pdf ) {</span>
<span class="lineNum">    3078 </span><span class="lineNoCov">          0 :         if ( outputfile==NULL ) {</span>
<span class="lineNum">    3079 </span><span class="lineNoCov">          0 :             sprintf(buf,&quot;pr-%.90s.%s&quot;, pi.mainsf-&gt;fontname,</span>
<span class="lineNum">    3080 </span><span class="lineNoCov">          0 :                     pi.printtype==pt_file?&quot;ps&quot;:&quot;pdf&quot; );</span>
<span class="lineNum">    3081 </span><span class="lineNoCov">          0 :             outputfile = buf;</span>
<span class="lineNum">    3082 </span>            :         }
<span class="lineNum">    3083 </span><span class="lineNoCov">          0 :         pi.out = fopen(outputfile,&quot;wb&quot;);</span>
<span class="lineNum">    3084 </span><span class="lineNoCov">          0 :         if ( pi.out==NULL ) {</span>
<span class="lineNum">    3085 </span><span class="lineNoCov">          0 :             ff_post_error(_(&quot;Print Failed&quot;),_(&quot;Failed to open file %s for output&quot;), outputfile);</span>
<span class="lineNum">    3086 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3087 </span>            :         }
<span class="lineNum">    3088 </span>            :     } else {
<span class="lineNum">    3089 </span><span class="lineNoCov">          0 :         outputfile = NULL;</span>
<span class="lineNum">    3090 </span><span class="lineNoCov">          0 :         pi.out = tmpfile();</span>
<span class="lineNum">    3091 </span><span class="lineNoCov">          0 :         if ( pi.out==NULL ) {</span>
<span class="lineNum">    3092 </span><span class="lineNoCov">          0 :             ff_post_error(_(&quot;Failed to open temporary output file&quot;),_(&quot;Failed to open temporary output file&quot;));</span>
<span class="lineNum">    3093 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3094 </span>            :         }
<span class="lineNum">    3095 </span>            :     }
<span class="lineNum">    3096 </span>            : 
<span class="lineNum">    3097 </span><span class="lineNoCov">          0 :     DoPrinting(&amp;pi,outputfile);</span>
<span class="lineNum">    3098 </span>            : 
<span class="lineNum">    3099 </span><span class="lineNoCov">          0 :     if ( pi.pt==pt_fontsample ) {</span>
<span class="lineNum">    3100 </span><span class="lineNoCov">          0 :         LayoutInfo_Destroy(pi.sample);</span>
<span class="lineNum">    3101 </span><span class="lineNoCov">          0 :         free(pi.sample);</span>
<span class="lineNum">    3102 </span>            :     }
<span class="lineNum">    3103 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
