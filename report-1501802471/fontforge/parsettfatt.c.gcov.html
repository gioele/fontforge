<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - FontForge coverage report 2017-08-04 01:21:11+02:00 (commit d35f7e4107a9e1db65cce47c468fcc914cecb8fd) - fontforge/parsettfatt.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">fontforge</a> - parsettfatt.c<span style="font-size: 80%;"> (source / <a href="parsettfatt.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">FontForge coverage report 2017-08-04 01:21:11+02:00 (commit d35f7e4107a9e1db65cce47c468fcc914cecb8fd)</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1758</td>
            <td class="headerCovTableEntry">4049</td>
            <td class="headerCovTableEntryLo">43.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-08-04</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">72</td>
            <td class="headerCovTableEntry">127</td>
            <td class="headerCovTableEntryLo">56.7 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* Copyright (C) 2000-2012 by George Williams */</a>
<span class="lineNum">       2 </span>            : /*
<span class="lineNum">       3 </span>            :  * Redistribution and use in source and binary forms, with or without
<span class="lineNum">       4 </span>            :  * modification, are permitted provided that the following conditions are met:
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            :  * Redistributions of source code must retain the above copyright notice, this
<span class="lineNum">       7 </span>            :  * list of conditions and the following disclaimer.
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            :  * Redistributions in binary form must reproduce the above copyright notice,
<span class="lineNum">      10 </span>            :  * this list of conditions and the following disclaimer in the documentation
<span class="lineNum">      11 </span>            :  * and/or other materials provided with the distribution.
<span class="lineNum">      12 </span>            : 
<span class="lineNum">      13 </span>            :  * The name of the author may not be used to endorse or promote products
<span class="lineNum">      14 </span>            :  * derived from this software without specific prior written permission.
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            :  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED
<span class="lineNum">      17 </span>            :  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
<span class="lineNum">      18 </span>            :  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO
<span class="lineNum">      19 </span>            :  * EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<span class="lineNum">      20 </span>            :  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
<span class="lineNum">      21 </span>            :  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
<span class="lineNum">      22 </span>            :  * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
<span class="lineNum">      23 </span>            :  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
<span class="lineNum">      24 </span>            :  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
<span class="lineNum">      25 </span>            :  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">      26 </span>            :  */
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #include &quot;parsettfatt.h&quot;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &quot;fontforge.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;lookups.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;mem.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;parsettf.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;splineutil.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;tottfaat.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;tottfgpos.h&quot;
<span class="lineNum">      37 </span>            : #include &lt;chardata.h&gt;
<span class="lineNum">      38 </span>            : #include &lt;utype.h&gt;
<span class="lineNum">      39 </span>            : #include &lt;ustring.h&gt;
<span class="lineNum">      40 </span>            : #include &lt;math.h&gt;
<span class="lineNum">      41 </span>            : #include &lt;locale.h&gt;
<span class="lineNum">      42 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      43 </span>            : #include &lt;ggadget.h&gt;              /* For GTextInfo */
<a name="44"><span class="lineNum">      44 </span>            : #include &quot;ttf.h&quot;</a>
<span class="lineNum">      45 </span>            : 
<span class="lineNum">      46 </span><span class="lineNoCov">          0 : static uint16 *getAppleClassTable(FILE *ttf, int classdef_offset, int cnt, int sub, int div, struct ttfinfo *info) {</span>
<span class="lineNum">      47 </span><span class="lineNoCov">          0 :     uint16 *class = calloc(cnt,sizeof(uint16));</span>
<span class="lineNum">      48 </span>            :     int first, i, n;
<span class="lineNum">      49 </span>            :     /* Apple stores its class tables as containing offsets. I find it hard to */
<span class="lineNum">      50 </span>            :     /*  think that way and convert them to indeces (by subtracting off a base */
<span class="lineNum">      51 </span>            :     /*  offset and dividing by the item's size) before doing anything else */
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :     fseek(ttf,classdef_offset,SEEK_SET);</span>
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :     first = getushort(ttf);</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :     n = getushort(ttf);</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :     if ( first+n-1&gt;=cnt ) {</span>
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Bad Apple Kern Class\n&quot;) );</span>
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :         info-&gt;bad_gx = true;</span>
<span class="lineNum">      59 </span>            :     }
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;n &amp;&amp; i+first&lt;cnt; ++i )</span>
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :         class[first+i] = (getushort(ttf)-sub)/div;</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 : return( class );</span>
<a name="63"><span class="lineNum">      63 </span>            : }</a>
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span><span class="lineCov">         64 : static char **ClassToNames(struct ttfinfo *info,int class_cnt,uint16 *class,int glyph_cnt) {</span>
<span class="lineNum">      66 </span><span class="lineCov">         64 :     char **ret = malloc(class_cnt*sizeof(char *));</span>
<span class="lineNum">      67 </span><span class="lineCov">         64 :     int *lens = calloc(class_cnt,sizeof(int));</span>
<span class="lineNum">      68 </span>            :     int i;
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span><span class="lineCov">         64 :     ret[0] = NULL;</span>
<span class="lineNum">      71 </span><span class="lineCov">      60098 :     for ( i=0 ; i&lt;glyph_cnt; ++i ) if ( class[i]!=0 &amp;&amp; info-&gt;chars[i]!=NULL &amp;&amp; class[i]&lt;class_cnt )</span>
<span class="lineNum">      72 </span><span class="lineCov">       5537 :         lens[class[i]] += strlen(info-&gt;chars[i]-&gt;name)+1;</span>
<span class="lineNum">      73 </span><span class="lineCov">        862 :     for ( i=1; i&lt;class_cnt ; ++i )</span>
<span class="lineNum">      74 </span><span class="lineCov">        798 :         ret[i] = malloc(lens[i]+1);</span>
<span class="lineNum">      75 </span><span class="lineCov">         64 :     memset(lens,0,class_cnt*sizeof(int));</span>
<span class="lineNum">      76 </span><span class="lineCov">      60098 :     for ( i=0 ; i&lt;glyph_cnt; ++i ) if ( class[i]!=0 &amp;&amp; info-&gt;chars[i]!=NULL ) {</span>
<span class="lineNum">      77 </span><span class="lineCov">       5537 :         if ( class[i]&lt;class_cnt ) {</span>
<span class="lineNum">      78 </span><span class="lineCov">       5537 :             strcpy(ret[class[i]]+lens[class[i]], info-&gt;chars[i]-&gt;name );</span>
<span class="lineNum">      79 </span><span class="lineCov">       5537 :             lens[class[i]] += strlen(info-&gt;chars[i]-&gt;name)+1;</span>
<span class="lineNum">      80 </span><span class="lineCov">       5537 :             ret[class[i]][lens[class[i]]-1] = ' ';</span>
<span class="lineNum">      81 </span>            :         } else {
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Class index out of range %d (must be &lt;%d)\n&quot;),class[i], class_cnt );</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">      84 </span>            :         }
<span class="lineNum">      85 </span>            :     }
<span class="lineNum">      86 </span><span class="lineCov">        862 :     for ( i=1; i&lt;class_cnt ; ++i )</span>
<span class="lineNum">      87 </span><span class="lineCov">        798 :         if ( lens[i]==0 )</span>
<span class="lineNum">      88 </span><span class="lineCov">          2 :             ret[i][0] = '\0';</span>
<span class="lineNum">      89 </span>            :         else
<span class="lineNum">      90 </span><span class="lineCov">        796 :             ret[i][lens[i]-1] = '\0';</span>
<span class="lineNum">      91 </span><span class="lineCov">         64 :     free(lens);</span>
<span class="lineNum">      92 </span><span class="lineCov">         64 : return( ret );</span>
<a name="93"><span class="lineNum">      93 </span>            : }</a>
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span><span class="lineCov">         32 : static char *CoverageMinusClasses(uint16 *coverageglyphs,uint16 *classed,</span>
<span class="lineNum">      96 </span>            :         struct ttfinfo *info ) {
<span class="lineNum">      97 </span>            :     int i, j, len;
<span class="lineNum">      98 </span><span class="lineCov">         32 :     uint8 *glyphs = calloc(info-&gt;glyph_cnt,1);</span>
<span class="lineNum">      99 </span>            :     char *ret;
<span class="lineNum">     100 </span>            : 
<span class="lineNum">     101 </span><span class="lineCov">       1177 :     for ( i=0; coverageglyphs[i]!=0xffff; ++i )</span>
<span class="lineNum">     102 </span><span class="lineCov">       1145 :         glyphs[coverageglyphs[i]] = 1;</span>
<span class="lineNum">     103 </span><span class="lineCov">      29638 :     for ( i=0; i&lt;info-&gt;glyph_cnt; ++i )</span>
<span class="lineNum">     104 </span><span class="lineCov">      29606 :         if ( classed[i]!=0 )</span>
<span class="lineNum">     105 </span><span class="lineCov">       2432 :             glyphs[i] = 0;</span>
<span class="lineNum">     106 </span><span class="lineCov">      29638 :     for ( i=0; i&lt;info-&gt;glyph_cnt; ++i )</span>
<span class="lineNum">     107 </span><span class="lineCov">      29606 :         if ( glyphs[i]!=0 )</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     109 </span>            :     /* coverage table matches glyphs in classes. No need for special treatment*/
<span class="lineNum">     110 </span><span class="lineCov">         32 :     if ( i==info-&gt;glyph_cnt ) {</span>
<span class="lineNum">     111 </span><span class="lineCov">         32 :         free(glyphs);</span>
<span class="lineNum">     112 </span><span class="lineCov">         32 : return( NULL );</span>
<span class="lineNum">     113 </span>            :     }
<span class="lineNum">     114 </span>            :     /* Otherwise we need to generate a class string of glyph names in the coverage */
<span class="lineNum">     115 </span>            :     /*  table but not in any class. These become the glyphs in class 0 */
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :     ret = NULL;</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :     for ( j=0; j&lt;2; ++j ) {</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :         len = 0;</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;info-&gt;glyph_cnt; ++i ) {</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :             if ( glyphs[i]!=0 ) {</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :                 if ( j ) {</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :                     strcpy( ret+len, info-&gt;chars[i]-&gt;name );</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :                     strcat( ret+len, &quot; &quot;);</span>
<span class="lineNum">     124 </span>            :                 }
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :                 len += strlen(info-&gt;chars[i]-&gt;name)+1;</span>
<span class="lineNum">     126 </span>            :             }
<span class="lineNum">     127 </span>            :         }
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :         if ( j==0 )</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :             ret = malloc(len+1);</span>
<span class="lineNum">     130 </span>            :         else
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :             ret[len-1] = '\0';</span>
<span class="lineNum">     132 </span>            :     }
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :     free(glyphs);</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 : return( ret );</span>
<a name="135"><span class="lineNum">     135 </span>            : }</a>
<span class="lineNum">     136 </span>            : 
<span class="lineNum">     137 </span><span class="lineCov">         42 : static int ClassFindCnt(uint16 *class,int tot) {</span>
<span class="lineNum">     138 </span><span class="lineCov">         42 :     int i, max=0;</span>
<span class="lineNum">     139 </span>            : 
<span class="lineNum">     140 </span><span class="lineCov">      40268 :     for ( i=0; i&lt;tot; ++i )</span>
<span class="lineNum">     141 </span><span class="lineCov">      40226 :         if ( class[i]&gt;max ) max = class[i];</span>
<span class="lineNum">     142 </span><span class="lineCov">         42 : return( max+1 );</span>
<a name="143"><span class="lineNum">     143 </span>            : }</a>
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span><span class="lineCov">        658 : static int cmpuint16(const void *u1, const void *u2) {</span>
<span class="lineNum">     146 </span><span class="lineCov">        658 : return( ((int) *((const uint16 *) u1)) - ((int) *((const uint16 *) u2)) );</span>
<a name="147"><span class="lineNum">     147 </span>            : }</a>
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span><span class="lineCov">          8 : static char *GlyphsToNames(struct ttfinfo *info,uint16 *glyphs,int make_uniq) {</span>
<span class="lineNum">     150 </span>            :     int i, j, len, off;
<span class="lineNum">     151 </span>            :     char *ret, *pt;
<span class="lineNum">     152 </span>            : 
<span class="lineNum">     153 </span><span class="lineCov">          8 :     if ( glyphs==NULL )</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 : return( copy(&quot;&quot;));</span>
<span class="lineNum">     155 </span>            : 
<span class="lineNum">     156 </span>            :     /* Adobe produces coverage tables containing duplicate glyphs in */
<span class="lineNum">     157 </span>            :     /*  GaramondPremrPro.otf. We want unique glyphs, so enforce that */
<span class="lineNum">     158 </span><span class="lineCov">          8 :     if ( make_uniq ) {</span>
<span class="lineNum">     159 </span><span class="lineCov">          8 :         for ( i=0 ; glyphs[i]!=0xffff; ++i );</span>
<span class="lineNum">     160 </span><span class="lineCov">          8 :         qsort(glyphs,i,sizeof(uint16),cmpuint16);</span>
<span class="lineNum">     161 </span><span class="lineCov">        245 :         for ( i=0; glyphs[i]!=0xffff; ++i ) {</span>
<span class="lineNum">     162 </span><span class="lineCov">        237 :             if ( glyphs[i+1]==glyphs[i] ) {</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :                 for ( j=i+1; glyphs[j]==glyphs[i]; ++j );</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :                 off = j-i -1;</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :                 for ( j=i+1; ; ++j ) {</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :                     glyphs[j] = glyphs[j+off];</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :                     if ( glyphs[j]==0xffff )</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     170 </span>            :             }
<span class="lineNum">     171 </span>            :         }
<span class="lineNum">     172 </span>            :     }
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span><span class="lineCov">        245 :     for ( i=len=0 ; glyphs[i]!=0xffff; ++i ) {</span>
<span class="lineNum">     175 </span><span class="lineCov">        237 :         if ( glyphs[i]&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :             if ( !info-&gt;bad_ot ) {</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;GID out of range.\n&quot;) );</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">     179 </span>            :             }
<span class="lineNum">     180 </span><span class="lineNoCov">          0 : return( copy(&quot;&quot;));</span>
<span class="lineNum">     181 </span>            :         }
<span class="lineNum">     182 </span><span class="lineCov">        237 :         if ( info-&gt;chars[glyphs[i]]!=NULL )</span>
<span class="lineNum">     183 </span><span class="lineCov">        237 :             len += strlen(info-&gt;chars[glyphs[i]]-&gt;name)+1;</span>
<span class="lineNum">     184 </span>            :     }
<span class="lineNum">     185 </span><span class="lineCov">          8 :     ret = pt = malloc(len+1); *pt = '\0';</span>
<span class="lineNum">     186 </span><span class="lineCov">        245 :     for ( i=0 ; glyphs[i]!=0xffff; ++i ) if ( info-&gt;chars[glyphs[i]]!=NULL ) {</span>
<span class="lineNum">     187 </span><span class="lineCov">        237 :         strcpy(pt,info-&gt;chars[glyphs[i]]-&gt;name);</span>
<span class="lineNum">     188 </span><span class="lineCov">        237 :         pt += strlen(pt);</span>
<span class="lineNum">     189 </span><span class="lineCov">        237 :         *pt++ = ' ';</span>
<span class="lineNum">     190 </span>            :     }
<span class="lineNum">     191 </span><span class="lineCov">          8 :     if ( pt&gt;ret ) pt[-1] = '\0';</span>
<span class="lineNum">     192 </span><span class="lineCov">          8 : return( ret );</span>
<span class="lineNum">     193 </span>            : }
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span>            : struct language {       /* normal entry with lang tag 'dflt' */
<span class="lineNum">     196 </span>            :     uint32 tag;
<span class="lineNum">     197 </span>            :     uint32 offset;
<span class="lineNum">     198 </span>            :     uint16 req;         /* required feature index. 0xffff for null */
<span class="lineNum">     199 </span>            :     int fcnt;
<span class="lineNum">     200 </span>            :     uint16 *features;
<span class="lineNum">     201 </span>            : };
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span>            : struct scripts {
<span class="lineNum">     204 </span>            :     uint32 offset;
<span class="lineNum">     205 </span>            :     uint32 tag;
<span class="lineNum">     206 </span>            :     int langcnt;                /* the default language is included as a */
<span class="lineNum">     207 </span>            :     struct language *languages;
<span class="lineNum">     208 </span>            : };
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span>            : struct feature {
<span class="lineNum">     211 </span>            :     uint32 offset;
<span class="lineNum">     212 </span>            :     uint32 tag;
<span class="lineNum">     213 </span>            :     int lcnt;
<span class="lineNum">     214 </span>            :     uint16 *lookups;
<span class="lineNum">     215 </span>            : };
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span>            : struct lookup {
<span class="lineNum">     218 </span>            :     uint16 type;
<span class="lineNum">     219 </span>            :     uint32 flags;       /* low order 16 bits: traditional flags, high order: mark filtering set index if pst_usemarkfilteringset */
<span class="lineNum">     220 </span>            :     uint32 offset;
<span class="lineNum">     221 </span>            :     int subtabcnt;
<span class="lineNum">     222 </span>            :     int32 *subtab_offsets;
<span class="lineNum">     223 </span>            :     OTLookup *otlookup;
<a name="224"><span class="lineNum">     224 </span>            : };</a>
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span><span class="lineCov">        368 : static uint16 *getCoverageTable(FILE *ttf, int coverage_offset, struct ttfinfo *info) {</span>
<span class="lineNum">     227 </span>            :     int format, cnt, i,j, rcnt;
<span class="lineNum">     228 </span><span class="lineCov">        368 :     uint16 *glyphs=NULL;</span>
<span class="lineNum">     229 </span>            :     int start, end, ind, max;
<span class="lineNum">     230 </span>            : 
<span class="lineNum">     231 </span><span class="lineCov">        368 :     fseek(ttf,coverage_offset,SEEK_SET);</span>
<span class="lineNum">     232 </span><span class="lineCov">        368 :     format = getushort(ttf);</span>
<span class="lineNum">     233 </span><span class="lineCov">        368 :     if ( format==1 ) {</span>
<span class="lineNum">     234 </span><span class="lineCov">        246 :         cnt = getushort(ttf);</span>
<span class="lineNum">     235 </span><span class="lineCov">        246 :         glyphs = malloc((cnt+1)*sizeof(uint16));</span>
<span class="lineNum">     236 </span><span class="lineCov">        246 :         if ( ftell(ttf)+2*cnt &gt; info-&gt;g_bounds ) {</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :             LogError( _(&quot;coverage table extends beyond end of table\n&quot;) );</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :             if ( ftell(ttf)&gt;info-&gt;g_bounds ) {</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :             free(glyphs);</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     242 </span>            :         }
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :             cnt = (info-&gt;g_bounds-ftell(ttf))/2;</span>
<span class="lineNum">     244 </span>            :         }
<span class="lineNum">     245 </span><span class="lineCov">       2686 :         for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">     246 </span><span class="lineCov">       2440 :             if ( cnt&amp;0xffff0000 ) {</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad count.\n&quot;));</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">     249 </span>            :             }
<span class="lineNum">     250 </span><span class="lineCov">       2440 :             glyphs[i] = getushort(ttf);</span>
<span class="lineNum">     251 </span><span class="lineCov">       2440 :             if ( feof(ttf) ) {</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;End of file found in coverage table.\n&quot;) );</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :                 free(glyphs);</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     256 </span>            :             }
<span class="lineNum">     257 </span><span class="lineCov">       2440 :             if ( glyphs[i]&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad coverage table. Glyph %d out of range [0,%d)\n&quot;), glyphs[i], info-&gt;glyph_cnt );</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :                 glyphs[i] = 0;</span>
<span class="lineNum">     261 </span>            :             }
<span class="lineNum">     262 </span>            :         }
<span class="lineNum">     263 </span><span class="lineCov">        122 :     } else if ( format==2 ) {</span>
<span class="lineNum">     264 </span><span class="lineCov">        122 :         glyphs = calloc((max=256),sizeof(uint16));</span>
<span class="lineNum">     265 </span><span class="lineCov">        122 :         rcnt = getushort(ttf); cnt = 0;</span>
<span class="lineNum">     266 </span><span class="lineCov">        122 :         if ( ftell(ttf)+6*rcnt &gt; info-&gt;g_bounds ) {</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :             LogError( _(&quot;coverage table extends beyond end of table\n&quot;) );</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :             rcnt = (info-&gt;g_bounds-ftell(ttf))/6;</span>
<span class="lineNum">     270 </span>            :         }
<span class="lineNum">     271 </span>            : 
<span class="lineNum">     272 </span><span class="lineCov">       1856 :         for ( i=0; i&lt;rcnt; ++i ) {</span>
<span class="lineNum">     273 </span><span class="lineCov">       1734 :             start = getushort(ttf);</span>
<span class="lineNum">     274 </span><span class="lineCov">       1734 :             end = getushort(ttf);</span>
<span class="lineNum">     275 </span><span class="lineCov">       1734 :             ind = getushort(ttf);</span>
<span class="lineNum">     276 </span><span class="lineCov">       1734 :             if ( feof(ttf) ) {</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;End of file found in coverage table.\n&quot;) );</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :                 free(glyphs);</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     281 </span>            :             }
<span class="lineNum">     282 </span><span class="lineCov">       1734 :             if ( start&gt;end || end&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad coverage table. Glyph range %d-%d out of range [0,%d)\n&quot;), start, end, info-&gt;glyph_cnt );</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :                 start = end = 0;</span>
<span class="lineNum">     286 </span>            :             }
<span class="lineNum">     287 </span><span class="lineCov">       1734 :             if ( ind+end-start+2 &gt;= max ) {</span>
<span class="lineNum">     288 </span><span class="lineCov">        429 :                 int oldmax = max;</span>
<span class="lineNum">     289 </span><span class="lineCov">        429 :                 max = ind+end-start+2;</span>
<span class="lineNum">     290 </span><span class="lineCov">        429 :                 glyphs = realloc(glyphs,max*sizeof(uint16));</span>
<span class="lineNum">     291 </span><span class="lineCov">        429 :                 memset(glyphs+oldmax,0,(max-oldmax)*sizeof(uint16));</span>
<span class="lineNum">     292 </span>            :             }
<span class="lineNum">     293 </span><span class="lineCov">      18487 :             for ( j=start; j&lt;=end; ++j ) {</span>
<span class="lineNum">     294 </span><span class="lineCov">      16753 :                 glyphs[j-start+ind] = j;</span>
<span class="lineNum">     295 </span><span class="lineCov">      16753 :                 if ( j&gt;=info-&gt;glyph_cnt )</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :                     glyphs[j-start+ind] = 0;</span>
<span class="lineNum">     297 </span>            :             }
<span class="lineNum">     298 </span><span class="lineCov">       1734 :             if ( ind+end-start+1&gt;cnt )</span>
<span class="lineNum">     299 </span><span class="lineCov">       1734 :                 cnt = ind+end-start+1;</span>
<span class="lineNum">     300 </span>            :         }
<span class="lineNum">     301 </span>            :     } else {
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Bad format for coverage table %d\n&quot;), format );</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     305 </span>            :     }
<span class="lineNum">     306 </span><span class="lineCov">        368 :     glyphs[cnt] = 0xffff;</span>
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span><span class="lineCov">        368 : return( glyphs );</span>
<span class="lineNum">     309 </span>            : }
<span class="lineNum">     310 </span>            : 
<span class="lineNum">     311 </span>            : struct valuerecord {
<span class="lineNum">     312 </span>            :     int16 xplacement, yplacement;
<span class="lineNum">     313 </span>            :     int16 xadvance, yadvance;
<span class="lineNum">     314 </span>            :     uint16 offXplaceDev, offYplaceDev;
<span class="lineNum">     315 </span>            :     uint16 offXadvanceDev, offYadvanceDev;
<a name="316"><span class="lineNum">     316 </span>            : };</a>
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span><span class="lineCov">         79 : static uint16 *getClassDefTable(FILE *ttf, int classdef_offset, struct ttfinfo *info) {</span>
<span class="lineNum">     319 </span>            :     int format, i, j;
<span class="lineNum">     320 </span>            :     uint16 start, glyphcnt, rangecnt, end, class;
<span class="lineNum">     321 </span><span class="lineCov">         79 :     uint16 *glist=NULL;</span>
<span class="lineNum">     322 </span><span class="lineCov">         79 :     int warned = false;</span>
<span class="lineNum">     323 </span><span class="lineCov">         79 :     int cnt = info-&gt;glyph_cnt;</span>
<span class="lineNum">     324 </span><span class="lineCov">         79 :     uint32 g_bounds = info-&gt;g_bounds;</span>
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span><span class="lineCov">         79 :     fseek(ttf, classdef_offset, SEEK_SET);</span>
<span class="lineNum">     327 </span><span class="lineCov">         79 :     glist = calloc(cnt,sizeof(uint16)); /* Class 0 is default */</span>
<span class="lineNum">     328 </span><span class="lineCov">         79 :     format = getushort(ttf);</span>
<span class="lineNum">     329 </span><span class="lineCov">         79 :     if ( format==1 ) {</span>
<span class="lineNum">     330 </span><span class="lineCov">         14 :         start = getushort(ttf);</span>
<span class="lineNum">     331 </span><span class="lineCov">         14 :         glyphcnt = getushort(ttf);</span>
<span class="lineNum">     332 </span><span class="lineCov">         14 :         if ( start+(int) glyphcnt&gt;cnt ) {</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Bad class def table. start=%d cnt=%d, max glyph=%d\n&quot;), start, glyphcnt, cnt );</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :             glyphcnt = cnt-start;</span>
<span class="lineNum">     336 </span><span class="lineCov">         14 :         } else if ( ftell(ttf)+2*glyphcnt &gt; g_bounds ) {</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Class definition sub-table extends beyond end of table\n&quot;) );</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :             glyphcnt = (g_bounds-ftell(ttf))/2;</span>
<span class="lineNum">     340 </span>            :         }
<span class="lineNum">     341 </span><span class="lineCov">        337 :         for ( i=0; i&lt;glyphcnt; ++i )</span>
<span class="lineNum">     342 </span><span class="lineCov">        323 :             glist[start+i] = getushort(ttf);</span>
<span class="lineNum">     343 </span><span class="lineCov">         65 :     } else if ( format==2 ) {</span>
<span class="lineNum">     344 </span><span class="lineCov">         65 :         rangecnt = getushort(ttf);</span>
<span class="lineNum">     345 </span><span class="lineCov">         65 :         if ( ftell(ttf)+6*rangecnt &gt; g_bounds ) {</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Class definition sub-table extends beyond end of table\n&quot;) );</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :             rangecnt = (g_bounds-ftell(ttf))/6;</span>
<span class="lineNum">     349 </span>            :         }
<span class="lineNum">     350 </span><span class="lineCov">       2974 :         for ( i=0; i&lt;rangecnt; ++i ) {</span>
<span class="lineNum">     351 </span><span class="lineCov">       2909 :             start = getushort(ttf);</span>
<span class="lineNum">     352 </span><span class="lineCov">       2909 :             end = getushort(ttf);</span>
<span class="lineNum">     353 </span><span class="lineCov">       2909 :             if ( start&gt;end || end&gt;=cnt ) {</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad class def table. Glyph range %d-%d out of range [0,%d)\n&quot;), start, end, cnt );</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">     356 </span>            :             }
<span class="lineNum">     357 </span><span class="lineCov">       2909 :             class = getushort(ttf);</span>
<span class="lineNum">     358 </span><span class="lineCov">      24489 :             for ( j=start; j&lt;=end; ++j ) if ( j&lt;cnt )</span>
<span class="lineNum">     359 </span><span class="lineCov">      21580 :                 glist[j] = class;</span>
<span class="lineNum">     360 </span>            :         }
<span class="lineNum">     361 </span>            :     } else {
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Unknown class table format: %d\n&quot;), format );</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">     364 </span>            :         /* Put everything in class 0 and return that */
<span class="lineNum">     365 </span>            :     }
<span class="lineNum">     366 </span>            : 
<span class="lineNum">     367 </span>            :     /* Do another validity test */
<span class="lineNum">     368 </span><span class="lineCov">      76309 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">     369 </span><span class="lineCov">      76230 :         if ( glist[i]&gt;=cnt+1 ) {</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :             if ( !warned ) {</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Nonsensical class assigned to a glyph-- class=%d is too big. Glyph=%d\n&quot;),</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :                         glist[i], i );</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :                 warned = true;</span>
<span class="lineNum">     375 </span>            :             }
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :             glist[i] = 0;</span>
<span class="lineNum">     377 </span>            :         }
<span class="lineNum">     378 </span>            :     }
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineCov">         79 : return glist;</span>
<a name="381"><span class="lineNum">     381 </span>            : }</a>
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span><span class="lineCov">     153121 : static void readvaluerecord(struct valuerecord *vr,int vf,FILE *ttf) {</span>
<span class="lineNum">     384 </span><span class="lineCov">     153121 :     memset(vr,'\0',sizeof(struct valuerecord));</span>
<span class="lineNum">     385 </span><span class="lineCov">     153121 :     if ( vf&amp;1 )</span>
<span class="lineNum">     386 </span><span class="lineCov">          3 :         vr-&gt;xplacement = getushort(ttf);</span>
<span class="lineNum">     387 </span><span class="lineCov">     153121 :     if ( vf&amp;2 )</span>
<span class="lineNum">     388 </span><span class="lineCov">          1 :         vr-&gt;yplacement = getushort(ttf);</span>
<span class="lineNum">     389 </span><span class="lineCov">     153121 :     if ( vf&amp;4 )</span>
<span class="lineNum">     390 </span><span class="lineCov">      76549 :         vr-&gt;xadvance = getushort(ttf);</span>
<span class="lineNum">     391 </span><span class="lineCov">     153121 :     if ( vf&amp;8 )</span>
<span class="lineNum">     392 </span><span class="lineCov">         11 :         vr-&gt;yadvance = getushort(ttf);</span>
<span class="lineNum">     393 </span><span class="lineCov">     153121 :     if ( vf&amp;0x10 )</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :         vr-&gt;offXplaceDev = getushort(ttf);</span>
<span class="lineNum">     395 </span><span class="lineCov">     153121 :     if ( vf&amp;0x20 )</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :         vr-&gt;offYplaceDev = getushort(ttf);</span>
<span class="lineNum">     397 </span><span class="lineCov">     153121 :     if ( vf&amp;0x40 )</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :         vr-&gt;offXadvanceDev = getushort(ttf);</span>
<span class="lineNum">     399 </span><span class="lineCov">     153121 :     if ( vf&amp;0x80 )</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :         vr-&gt;offYadvanceDev = getushort(ttf);</span>
<a name="401"><span class="lineNum">     401 </span><span class="lineCov">     153121 : }</span></a>
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span><span class="lineNoCov">          0 : static void ReadDeviceTable(FILE *ttf,DeviceTable *adjust,uint32 devtab,</span>
<span class="lineNum">     404 </span>            :         struct ttfinfo *info) {
<span class="lineNum">     405 </span>            :     long here;
<span class="lineNum">     406 </span>            :     int pack;
<span class="lineNum">     407 </span>            :     int w,b,i,c;
<span class="lineNum">     408 </span>            : 
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :     if ( devtab==0 )</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :     here = ftell(ttf);</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :     fseek(ttf,devtab,SEEK_SET);</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :     adjust-&gt;first_pixel_size = getushort(ttf);</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :     adjust-&gt;last_pixel_size  = getushort(ttf);</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     pack = getushort(ttf);</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :     if ( adjust-&gt;first_pixel_size&gt;adjust-&gt;last_pixel_size || pack==0 || pack&gt;3 ) {</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :         LogError(_(&quot;Bad device table\n&quot; ));</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :         adjust-&gt;first_pixel_size = adjust-&gt;last_pixel_size = 0;</span>
<span class="lineNum">     420 </span>            :     } else {
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :         c = adjust-&gt;last_pixel_size-adjust-&gt;first_pixel_size+1;</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :         adjust-&gt;corrections = malloc(c);</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :         if ( pack==1 ) {</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;c; i+=8 ) {</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :                 w = getushort(ttf);</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :                 for ( b=0; b&lt;8 &amp;&amp; i+b&lt;c; ++b )</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :                     adjust-&gt;corrections[i+b] = ((int16) ((w&lt;&lt;(b*2))&amp;0xc000))&gt;&gt;14;</span>
<span class="lineNum">     428 </span>            :             }
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :         } else if ( pack==2 ) {</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;c; i+=4 ) {</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :                 w = getushort(ttf);</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :                 for ( b=0; b&lt;4 &amp;&amp; i+b&lt;c; ++b )</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :                     adjust-&gt;corrections[i+b] = ((int16) ((w&lt;&lt;(b*4))&amp;0xf000))&gt;&gt;12;</span>
<span class="lineNum">     434 </span>            :             }
<span class="lineNum">     435 </span>            :         } else {
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;c; ++i )</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :                 adjust-&gt;corrections[i] = (int8) getc(ttf);</span>
<span class="lineNum">     438 </span>            :         }
<span class="lineNum">     439 </span>            :     }
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :     fseek(ttf,here,SEEK_SET);</span>
<a name="441"><span class="lineNum">     441 </span>            : }</a>
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineCov">          5 : static ValDevTab *readValDevTab(FILE *ttf,struct valuerecord *vr,uint32 base,</span>
<span class="lineNum">     444 </span>            :         struct ttfinfo *info) {
<span class="lineNum">     445 </span>            :     ValDevTab *ret;
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span><span class="lineCov">         10 :     if ( vr-&gt;offXplaceDev==0 &amp;&amp; vr-&gt;offYplaceDev==0 &amp;&amp;</span>
<span class="lineNum">     448 </span><span class="lineCov">         10 :             vr-&gt;offXadvanceDev==0 &amp;&amp; vr-&gt;offYadvanceDev==0 )</span>
<span class="lineNum">     449 </span><span class="lineCov">          5 : return( NULL );</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :     ret = chunkalloc(sizeof(ValDevTab));</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :     if ( vr-&gt;offXplaceDev!=0 )</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :         ReadDeviceTable(ttf,&amp;ret-&gt;xadjust,base + vr-&gt;offXplaceDev,info);</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :     if ( vr-&gt;offYplaceDev!=0 )</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :         ReadDeviceTable(ttf,&amp;ret-&gt;yadjust,base + vr-&gt;offYplaceDev,info);</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :     if ( vr-&gt;offXadvanceDev!=0 )</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :         ReadDeviceTable(ttf,&amp;ret-&gt;xadv,base + vr-&gt;offXadvanceDev,info);</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :     if ( vr-&gt;offYadvanceDev!=0 )</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :         ReadDeviceTable(ttf,&amp;ret-&gt;yadv,base + vr-&gt;offYadvanceDev,info);</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 : return( ret );</span>
<a name="460"><span class="lineNum">     460 </span>            : }</a>
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineCov">          1 : static void addPairPos(struct ttfinfo *info, int glyph1, int glyph2,</span>
<span class="lineNum">     463 </span>            :         struct lookup_subtable *subtable, struct valuerecord *vr1,struct valuerecord *vr2,
<span class="lineNum">     464 </span>            :         uint32 base,FILE *ttf) {
<span class="lineNum">     465 </span>            :     
<span class="lineNum">     466 </span><span class="lineCov">          2 :     if ( glyph1&lt;info-&gt;glyph_cnt &amp;&amp; glyph2&lt;info-&gt;glyph_cnt &amp;&amp;</span>
<span class="lineNum">     467 </span><span class="lineCov">          3 :             info-&gt;chars[glyph1]!=NULL &amp;&amp; info-&gt;chars[glyph2]!=NULL ) {</span>
<span class="lineNum">     468 </span><span class="lineCov">          1 :         PST *pos = chunkalloc(sizeof(PST));</span>
<span class="lineNum">     469 </span><span class="lineCov">          1 :         pos-&gt;type = pst_pair;</span>
<span class="lineNum">     470 </span><span class="lineCov">          1 :         pos-&gt;subtable = subtable;</span>
<span class="lineNum">     471 </span><span class="lineCov">          1 :         pos-&gt;next = info-&gt;chars[glyph1]-&gt;possub;</span>
<span class="lineNum">     472 </span><span class="lineCov">          1 :         info-&gt;chars[glyph1]-&gt;possub = pos;</span>
<span class="lineNum">     473 </span><span class="lineCov">          1 :         pos-&gt;u.pair.vr = chunkalloc(sizeof(struct vr [2]));</span>
<span class="lineNum">     474 </span><span class="lineCov">          1 :         pos-&gt;u.pair.paired = copy(info-&gt;chars[glyph2]-&gt;name);</span>
<span class="lineNum">     475 </span><span class="lineCov">          1 :         pos-&gt;u.pair.vr[0].xoff = vr1-&gt;xplacement;</span>
<span class="lineNum">     476 </span><span class="lineCov">          1 :         pos-&gt;u.pair.vr[0].yoff = vr1-&gt;yplacement;</span>
<span class="lineNum">     477 </span><span class="lineCov">          1 :         pos-&gt;u.pair.vr[0].h_adv_off = vr1-&gt;xadvance;</span>
<span class="lineNum">     478 </span><span class="lineCov">          1 :         pos-&gt;u.pair.vr[0].v_adv_off = vr1-&gt;yadvance;</span>
<span class="lineNum">     479 </span><span class="lineCov">          1 :         pos-&gt;u.pair.vr[1].xoff = vr2-&gt;xplacement;</span>
<span class="lineNum">     480 </span><span class="lineCov">          1 :         pos-&gt;u.pair.vr[1].yoff = vr2-&gt;yplacement;</span>
<span class="lineNum">     481 </span><span class="lineCov">          1 :         pos-&gt;u.pair.vr[1].h_adv_off = vr2-&gt;xadvance;</span>
<span class="lineNum">     482 </span><span class="lineCov">          1 :         pos-&gt;u.pair.vr[1].v_adv_off = vr2-&gt;yadvance;</span>
<span class="lineNum">     483 </span><span class="lineCov">          1 :         pos-&gt;u.pair.vr[0].adjust = readValDevTab(ttf,vr1,base,info);</span>
<span class="lineNum">     484 </span><span class="lineCov">          1 :         pos-&gt;u.pair.vr[1].adjust = readValDevTab(ttf,vr2,base,info);</span>
<span class="lineNum">     485 </span>            :     } else {
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Bad pair position: glyphs %d &amp; %d should have been &lt; %d\n&quot;),</span>
<span class="lineNum">     487 </span>            :                 glyph1, glyph2, info-&gt;glyph_cnt );
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">     489 </span>            :     }
<a name="490"><span class="lineNum">     490 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span><span class="lineCov">      58812 : static int addKernPair(struct ttfinfo *info, int glyph1, int glyph2,</span>
<span class="lineNum">     493 </span>            :         int16 offset, uint32 devtab, struct lookup_subtable *subtable,int isv,
<span class="lineNum">     494 </span>            :         FILE *ttf) {
<span class="lineNum">     495 </span>            :     KernPair *kp;
<span class="lineNum">     496 </span><span class="lineCov">     117624 :     if ( glyph1&lt;info-&gt;glyph_cnt &amp;&amp; glyph2&lt;info-&gt;glyph_cnt &amp;&amp;</span>
<span class="lineNum">     497 </span><span class="lineCov">     117624 :             info-&gt;chars[glyph1]!=NULL &amp;&amp; info-&gt;chars[glyph2]!=NULL ) {</span>
<span class="lineNum">     498 </span><span class="lineCov">    2799059 :         for ( kp=isv ? info-&gt;chars[glyph1]-&gt;vkerns : info-&gt;chars[glyph1]-&gt;kerns;</span>
<span class="lineNum">     499 </span><span class="lineCov">    2681435 :                 kp!=NULL; kp=kp-&gt;next ) {</span>
<span class="lineNum">     500 </span><span class="lineCov">    2681435 :             if ( kp-&gt;sc == info-&gt;chars[glyph2] )</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     502 </span>            :         }
<span class="lineNum">     503 </span><span class="lineCov">     117624 :         if ( kp==NULL ) {</span>
<span class="lineNum">     504 </span><span class="lineCov">      58812 :             kp = chunkalloc(sizeof(KernPair));</span>
<span class="lineNum">     505 </span><span class="lineCov">      58812 :             kp-&gt;sc = info-&gt;chars[glyph2];</span>
<span class="lineNum">     506 </span><span class="lineCov">      58812 :             kp-&gt;off = offset;</span>
<span class="lineNum">     507 </span><span class="lineCov">      58812 :             kp-&gt;subtable = subtable;</span>
<span class="lineNum">     508 </span><span class="lineCov">      58812 :             if ( devtab!=0 ) {</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :                 kp-&gt;adjust = chunkalloc(sizeof(DeviceTable));</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :                 ReadDeviceTable(ttf,kp-&gt;adjust,devtab,info);</span>
<span class="lineNum">     511 </span>            :             }
<span class="lineNum">     512 </span><span class="lineCov">      58812 :             if ( isv ) {</span>
<span class="lineNum">     513 </span><span class="lineCov">          2 :                 kp-&gt;next = info-&gt;chars[glyph1]-&gt;vkerns;</span>
<span class="lineNum">     514 </span><span class="lineCov">          2 :                 info-&gt;chars[glyph1]-&gt;vkerns = kp;</span>
<span class="lineNum">     515 </span>            :             } else {
<span class="lineNum">     516 </span><span class="lineCov">      58810 :                 kp-&gt;next = info-&gt;chars[glyph1]-&gt;kerns;</span>
<span class="lineNum">     517 </span><span class="lineCov">      58810 :                 info-&gt;chars[glyph1]-&gt;kerns = kp;</span>
<span class="lineNum">     518 </span>            :             }
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :         } else if ( kp-&gt;subtable!=subtable )</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 : return( true );</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :     } else if ( glyph1&gt;=info-&gt;glyph_cnt || glyph2&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">     522 </span>            :         /* Might be NULL in a ttc file where we omit glyphs */
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Bad kern pair: glyphs %d &amp; %d should have been &lt; %d\n&quot;),</span>
<span class="lineNum">     524 </span>            :                 glyph1, glyph2, info-&gt;glyph_cnt );
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">     526 </span>            :     }
<span class="lineNum">     527 </span><span class="lineCov">      58812 : return( false );</span>
<a name="528"><span class="lineNum">     528 </span>            : }</a>
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span><span class="lineCov">         28 : static void gposKernSubTable(FILE *ttf, int stoffset, struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable) {</span>
<span class="lineNum">     531 </span>            :     int coverage, cnt, i, j, pair_cnt, vf1, vf2, glyph2;
<span class="lineNum">     532 </span>            :     int cd1, cd2, c1_cnt, c2_cnt;
<span class="lineNum">     533 </span>            :     uint16 format;
<span class="lineNum">     534 </span>            :     uint16 *ps_offsets;
<span class="lineNum">     535 </span>            :     uint16 *glyphs, *class1, *class2;
<span class="lineNum">     536 </span>            :     struct valuerecord vr1, vr2;
<span class="lineNum">     537 </span>            :     long foffset;
<span class="lineNum">     538 </span>            :     KernClass *kc;
<span class="lineNum">     539 </span>            :     int isv, r2l;
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span><span class="lineCov">         28 :     format=getushort(ttf);</span>
<span class="lineNum">     542 </span><span class="lineCov">         28 :     if ( format!=1 &amp;&amp; format!=2 )       /* Unknown subtable format */</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     544 </span><span class="lineCov">         28 :     coverage = getushort(ttf);</span>
<span class="lineNum">     545 </span><span class="lineCov">         28 :     vf1 = getushort(ttf);</span>
<span class="lineNum">     546 </span><span class="lineCov">         28 :     vf2 = getushort(ttf);</span>
<span class="lineNum">     547 </span><span class="lineCov">         28 :     r2l = 0;</span>
<span class="lineNum">     548 </span>            : 
<span class="lineNum">     549 </span>            :     /* Accept forms both with and without device tables */
<span class="lineNum">     550 </span><span class="lineCov">         28 :     if ( (vf1==0x0008 || vf1==0x0088) &amp;&amp; vf2==0x0000 )</span>
<span class="lineNum">     551 </span><span class="lineCov">          2 :         isv = 1;                /* Top to bottom */</span>
<span class="lineNum">     552 </span><span class="lineCov">         26 :     else if ( vf1==0x0000 &amp;&amp; (vf2==0x0004 || vf2==0x0044) &amp;&amp; (l-&gt;flags&amp;pst_r2l)) {</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :         isv = 0;                /* Right to left */</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :         r2l = 1;</span>
<span class="lineNum">     555 </span><span class="lineCov">         26 :     } else if ( (vf1==0x0004 || vf1==0x0044) &amp;&amp; vf2==0x0000 &amp;&amp; !(l-&gt;flags&amp;pst_r2l) )</span>
<span class="lineNum">     556 </span><span class="lineCov">         25 :         isv = 0;                /* Left to right */</span>
<span class="lineNum">     557 </span>            :     else
<span class="lineNum">     558 </span><span class="lineCov">          1 :         isv = 2;                /* Can't optimize, store all 8 settings */</span>
<span class="lineNum">     559 </span><span class="lineCov">         28 :     if ( format==1 ) {</span>
<span class="lineNum">     560 </span><span class="lineCov">         17 :         subtable-&gt;per_glyph_pst_or_kern = true;</span>
<span class="lineNum">     561 </span><span class="lineCov">         17 :         cnt = getushort(ttf);</span>
<span class="lineNum">     562 </span><span class="lineCov">         17 :         ps_offsets = malloc(cnt*sizeof(uint16));</span>
<span class="lineNum">     563 </span><span class="lineCov">       1797 :         for ( i=0; i&lt;cnt; ++i )</span>
<span class="lineNum">     564 </span><span class="lineCov">       1780 :             ps_offsets[i]=getushort(ttf);</span>
<span class="lineNum">     565 </span><span class="lineCov">         17 :         glyphs = getCoverageTable(ttf,stoffset+coverage,info);</span>
<span class="lineNum">     566 </span><span class="lineCov">         17 :         if ( glyphs==NULL ) {</span>
<span class="lineNum">     567 </span>            : /* GT: This continues a multi-line error message, hence the leading space */
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :             LogError( _(&quot; Bad pairwise kerning table, ignored\n&quot;) );</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :             free(ps_offsets);</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     571 </span>            :         }
<span class="lineNum">     572 </span><span class="lineCov">       1797 :         for ( i=0; i&lt;cnt; ++i ) if ( glyphs[i]&lt;info-&gt;glyph_cnt ) {</span>
<span class="lineNum">     573 </span><span class="lineCov">       1780 :             fseek(ttf,stoffset+ps_offsets[i],SEEK_SET);</span>
<span class="lineNum">     574 </span><span class="lineCov">       1780 :             pair_cnt = getushort(ttf);</span>
<span class="lineNum">     575 </span><span class="lineCov">      60593 :             for ( j=0; j&lt;pair_cnt; ++j ) {</span>
<span class="lineNum">     576 </span><span class="lineCov">      58813 :                 glyph2 = getushort(ttf);</span>
<span class="lineNum">     577 </span><span class="lineCov">      58813 :                 readvaluerecord(&amp;vr1,vf1,ttf);</span>
<span class="lineNum">     578 </span><span class="lineCov">      58813 :                 readvaluerecord(&amp;vr2,vf2,ttf);</span>
<span class="lineNum">     579 </span><span class="lineCov">      58813 :                 if ( isv==2 )</span>
<span class="lineNum">     580 </span><span class="lineCov">          1 :                     addPairPos(info, glyphs[i], glyph2,subtable,&amp;vr1,&amp;vr2, stoffset,ttf);</span>
<span class="lineNum">     581 </span><span class="lineCov">      58812 :                 else if ( isv ) {</span>
<span class="lineNum">     582 </span><span class="lineCov">          2 :                     if ( addKernPair(info, glyphs[i], glyph2, vr1.yadvance,</span>
<span class="lineNum">     583 </span><span class="lineCov">          2 :                             vr1.offYadvanceDev==0?0:stoffset+vr1.offYadvanceDev,</span>
<span class="lineNum">     584 </span>            :                             subtable,isv,ttf))
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :                         addPairPos(info, glyphs[i], glyph2,subtable,&amp;vr1,&amp;vr2, stoffset,ttf);</span>
<span class="lineNum">     586 </span>            :                         /* If we've already got kern data for this pair of */
<span class="lineNum">     587 </span>            :                         /*  glyphs, then we can't make it be a true KernPair */
<span class="lineNum">     588 </span>            :                         /*  but we can save the info as a pst_pair */
<span class="lineNum">     589 </span><span class="lineCov">      58810 :                 } else if ( r2l ) {     /* R2L */</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :                     if ( addKernPair(info, glyphs[i], glyph2, vr2.xadvance,</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :                             vr2.offXadvanceDev==0?0:stoffset+vr2.offXadvanceDev,</span>
<span class="lineNum">     592 </span>            :                             subtable,isv,ttf))
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :                         addPairPos(info, glyphs[i], glyph2,subtable,&amp;vr1,&amp;vr2,stoffset,ttf);</span>
<span class="lineNum">     594 </span>            :                 } else {
<span class="lineNum">     595 </span><span class="lineCov">      58810 :                     if ( addKernPair(info, glyphs[i], glyph2, vr1.xadvance,</span>
<span class="lineNum">     596 </span><span class="lineCov">      58810 :                             vr1.offXadvanceDev==0?0:stoffset+vr1.offXadvanceDev,</span>
<span class="lineNum">     597 </span>            :                             subtable,isv,ttf))
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :                         addPairPos(info, glyphs[i], glyph2,subtable,&amp;vr1,&amp;vr2,stoffset,ttf);</span>
<span class="lineNum">     599 </span>            :                 }
<span class="lineNum">     600 </span>            :             }
<span class="lineNum">     601 </span>            :         }
<span class="lineNum">     602 </span><span class="lineCov">         17 :         free(ps_offsets); free(glyphs);</span>
<span class="lineNum">     603 </span><span class="lineCov">         11 :     } else if ( format==2 ) {   /* Class-based kerning */</span>
<span class="lineNum">     604 </span><span class="lineCov">         11 :         cd1 = getushort(ttf);</span>
<span class="lineNum">     605 </span><span class="lineCov">         11 :         cd2 = getushort(ttf);</span>
<span class="lineNum">     606 </span><span class="lineCov">         11 :         foffset = ftell(ttf);</span>
<span class="lineNum">     607 </span><span class="lineCov">         11 :         class1 = getClassDefTable(ttf, stoffset+cd1, info);</span>
<span class="lineNum">     608 </span><span class="lineCov">         11 :         class2 = getClassDefTable(ttf, stoffset+cd2, info);</span>
<span class="lineNum">     609 </span><span class="lineCov">         11 :         glyphs = getCoverageTable(ttf,stoffset+coverage,info);</span>
<span class="lineNum">     610 </span><span class="lineCov">         11 :         if ( glyphs==NULL ) {</span>
<span class="lineNum">     611 </span>            : /* GT: This continues a multi-line error message, hence the leading space */
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :             LogError( _(&quot; Bad kerning class table, ignored\n&quot;) );</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :         free(class1);</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :         free(class2);</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     616 </span>            :         }
<span class="lineNum">     617 </span><span class="lineCov">         11 :         fseek(ttf, foffset, SEEK_SET);  /* come back */</span>
<span class="lineNum">     618 </span><span class="lineCov">         11 :         c1_cnt = getushort(ttf);</span>
<span class="lineNum">     619 </span><span class="lineCov">         11 :         c2_cnt = getushort(ttf);</span>
<span class="lineNum">     620 </span><span class="lineCov">         11 :         if ( isv!=2 ) {</span>
<span class="lineNum">     621 </span><span class="lineCov">         11 :             if ( isv ) {</span>
<span class="lineNum">     622 </span><span class="lineCov">          1 :                 if ( info-&gt;vkhead==NULL )</span>
<span class="lineNum">     623 </span><span class="lineCov">          1 :                     info-&gt;vkhead = kc = chunkalloc(sizeof(KernClass));</span>
<span class="lineNum">     624 </span>            :                 else
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :                     kc = info-&gt;vklast-&gt;next = chunkalloc(sizeof(KernClass));</span>
<span class="lineNum">     626 </span><span class="lineCov">          1 :                 info-&gt;vklast = kc;</span>
<span class="lineNum">     627 </span>            :             } else {
<span class="lineNum">     628 </span><span class="lineCov">         10 :                 if ( info-&gt;khead==NULL )</span>
<span class="lineNum">     629 </span><span class="lineCov">          4 :                     info-&gt;khead = kc = chunkalloc(sizeof(KernClass));</span>
<span class="lineNum">     630 </span>            :                 else
<span class="lineNum">     631 </span><span class="lineCov">          6 :                     kc = info-&gt;klast-&gt;next = chunkalloc(sizeof(KernClass));</span>
<span class="lineNum">     632 </span><span class="lineCov">         10 :                 info-&gt;klast = kc;</span>
<span class="lineNum">     633 </span>            :             }
<span class="lineNum">     634 </span><span class="lineCov">         11 :             subtable-&gt;vertical_kerning = isv;</span>
<span class="lineNum">     635 </span><span class="lineCov">         11 :             subtable-&gt;kc = kc;</span>
<span class="lineNum">     636 </span><span class="lineCov">         11 :             kc-&gt;first_cnt = c1_cnt; kc-&gt;second_cnt = c2_cnt;</span>
<span class="lineNum">     637 </span><span class="lineCov">         11 :             kc-&gt;subtable = subtable;</span>
<span class="lineNum">     638 </span><span class="lineCov">         11 :             kc-&gt;offsets = malloc(c1_cnt*c2_cnt*sizeof(int16));</span>
<span class="lineNum">     639 </span><span class="lineCov">         11 :             kc-&gt;adjusts = calloc(c1_cnt*c2_cnt,sizeof(DeviceTable));</span>
<span class="lineNum">     640 </span><span class="lineCov">         11 :             kc-&gt;firsts = ClassToNames(info,c1_cnt,class1,info-&gt;glyph_cnt);</span>
<span class="lineNum">     641 </span><span class="lineCov">         11 :             kc-&gt;seconds = ClassToNames(info,c2_cnt,class2,info-&gt;glyph_cnt);</span>
<span class="lineNum">     642 </span>            :             /* Now if the coverage table contains entries which are not in */
<span class="lineNum">     643 </span>            :             /*  the list of first classes, then those glyphs are the real */
<span class="lineNum">     644 </span>            :             /*  values for kc-&gt;firsts[0] */
<span class="lineNum">     645 </span><span class="lineCov">         11 :             kc-&gt;firsts[0] = CoverageMinusClasses(glyphs,class1,info);</span>
<span class="lineNum">     646 </span><span class="lineCov">        333 :             for ( i=0; i&lt;c1_cnt; ++i) {</span>
<span class="lineNum">     647 </span><span class="lineCov">      18068 :                 for ( j=0; j&lt;c2_cnt; ++j) {</span>
<span class="lineNum">     648 </span><span class="lineCov">      17746 :                     readvaluerecord(&amp;vr1,vf1,ttf);</span>
<span class="lineNum">     649 </span><span class="lineCov">      17746 :                     readvaluerecord(&amp;vr2,vf2,ttf);</span>
<span class="lineNum">     650 </span><span class="lineCov">      17746 :                     if ( isv )</span>
<span class="lineNum">     651 </span><span class="lineCov">          9 :                         kc-&gt;offsets[i*c2_cnt+j] = vr1.yadvance;</span>
<span class="lineNum">     652 </span><span class="lineCov">      17737 :                     else if ( r2l )</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :                         kc-&gt;offsets[i*c2_cnt+j] = vr2.xadvance;</span>
<span class="lineNum">     654 </span>            :                     else
<span class="lineNum">     655 </span><span class="lineCov">      17737 :                         kc-&gt;offsets[i*c2_cnt+j] = vr1.xadvance;</span>
<span class="lineNum">     656 </span><span class="lineCov">      17746 :                     if ( isv ) {</span>
<span class="lineNum">     657 </span><span class="lineCov">          9 :                         if ( vr1.offYadvanceDev!=0 )</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :                             ReadDeviceTable(ttf,&amp;kc-&gt;adjusts[i*c2_cnt+j],stoffset+vr1.offYadvanceDev,info);</span>
<span class="lineNum">     659 </span><span class="lineCov">      17737 :                     } else if ( r2l ) {</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :                         if ( vr2.offXadvanceDev!=0 )</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :                             ReadDeviceTable(ttf,&amp;kc-&gt;adjusts[i*c2_cnt+j],stoffset+vr2.offXadvanceDev,info);</span>
<span class="lineNum">     662 </span>            :                     } else {
<span class="lineNum">     663 </span><span class="lineCov">      17737 :                         if ( vr1.offXadvanceDev!=0 )</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :                             ReadDeviceTable(ttf,&amp;kc-&gt;adjusts[i*c2_cnt+j],stoffset+vr1.offXadvanceDev,info);</span>
<span class="lineNum">     665 </span>            :                     }
<span class="lineNum">     666 </span>            :                 }
<span class="lineNum">     667 </span>            :             }
<span class="lineNum">     668 </span>            :         } else {        /* This happens when we have a feature which is neither 'kern' nor 'vkrn' we don't know what to do with it so we make it into kern pairs */
<span class="lineNum">     669 </span>            :             int k,m;
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :             subtable-&gt;per_glyph_pst_or_kern = true;</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;c1_cnt; ++i) {</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :                 for ( j=0; j&lt;c2_cnt; ++j) {</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :                     readvaluerecord(&amp;vr1,vf1,ttf);</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :                     readvaluerecord(&amp;vr2,vf2,ttf);</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :                     if ( vr1.xadvance!=0 || vr1.xplacement!=0 || vr1.yadvance!=0 || vr1.yplacement!=0 ||</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :                             vr2.xadvance!=0 || vr2.xplacement!=0 || vr2.yadvance!=0 || vr2.yplacement!=0 )</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :                         for ( k=0; k&lt;info-&gt;glyph_cnt; ++k )</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :                             if ( class1[k]==i )</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :                                 for ( m=0; m&lt;info-&gt;glyph_cnt; ++m )</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :                                     if ( class2[m]==j )</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :                                         addPairPos(info, k,m,subtable,&amp;vr1,&amp;vr2,stoffset,ttf);</span>
<span class="lineNum">     682 </span>            :                 }
<span class="lineNum">     683 </span>            :             }
<span class="lineNum">     684 </span>            :         }
<span class="lineNum">     685 </span><span class="lineCov">         11 :         free(class1); free(class2);</span>
<span class="lineNum">     686 </span><span class="lineCov">         11 :         free(glyphs);</span>
<span class="lineNum">     687 </span>            :     }
<a name="688"><span class="lineNum">     688 </span>            : }</a>
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span><span class="lineCov">      23626 : static AnchorPoint *readAnchorPoint(FILE *ttf,uint32 base,AnchorClass *class,</span>
<span class="lineNum">     691 </span>            :         enum anchor_type type,AnchorPoint *last, struct ttfinfo *info) {
<span class="lineNum">     692 </span>            :     AnchorPoint *ap;
<span class="lineNum">     693 </span>            :     int format;
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span><span class="lineCov">      23626 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">     696 </span>            : 
<span class="lineNum">     697 </span><span class="lineCov">      23626 :     ap = chunkalloc(sizeof(AnchorPoint));</span>
<span class="lineNum">     698 </span><span class="lineCov">      23626 :     ap-&gt;anchor = class;</span>
<span class="lineNum">     699 </span>            :     /* All anchor types have the same initial 3 entries, format */
<span class="lineNum">     700 </span>            :     /*  x,y pos. format 2 contains a truetype positioning point, and */
<span class="lineNum">     701 </span>            :     /*  format==3 may also have device tables */
<span class="lineNum">     702 </span><span class="lineCov">      23626 :     format = getushort(ttf);</span>
<span class="lineNum">     703 </span><span class="lineCov">      23626 :     ap-&gt;me.x = (int16) getushort(ttf);</span>
<span class="lineNum">     704 </span><span class="lineCov">      23626 :     ap-&gt;me.y = (int16) getushort(ttf);</span>
<span class="lineNum">     705 </span><span class="lineCov">      23626 :     ap-&gt;type = type;</span>
<span class="lineNum">     706 </span><span class="lineCov">      23626 :     if ( format==2 ) {</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :         ap-&gt;ttf_pt_index = getushort(ttf);</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :         ap-&gt;has_ttf_pt = true;</span>
<span class="lineNum">     709 </span>            :     }
<span class="lineNum">     710 </span><span class="lineCov">      23626 :     else if ( format==3 ) {</span>
<span class="lineNum">     711 </span>            :         int devoff;
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :         devoff = getushort(ttf);</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :         if ( devoff!=0 )</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :             ReadDeviceTable(ttf,&amp;ap-&gt;xadjust,base+devoff,info);</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :         devoff = getushort(ttf);</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :         if ( devoff!=0 )</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :             ReadDeviceTable(ttf,&amp;ap-&gt;yadjust,base+devoff,info);</span>
<span class="lineNum">     718 </span>            :     }
<span class="lineNum">     719 </span><span class="lineCov">      23626 :     ap-&gt;next = last;</span>
<span class="lineNum">     720 </span><span class="lineCov">      23626 : return( ap );</span>
<a name="721"><span class="lineNum">     721 </span>            : }</a>
<span class="lineNum">     722 </span>            : 
<span class="lineNum">     723 </span><span class="lineNoCov">          0 : static void gposCursiveSubTable(FILE *ttf, int stoffset, struct ttfinfo *info,struct lookup_subtable *subtable) {</span>
<span class="lineNum">     724 </span>            :     int coverage, cnt, format, i;
<span class="lineNum">     725 </span>            :     struct ee_offsets { int entry, exit; } *offsets;
<span class="lineNum">     726 </span>            :     uint16 *glyphs;
<span class="lineNum">     727 </span>            :     AnchorClass *class;
<span class="lineNum">     728 </span>            :     SplineChar *sc;
<span class="lineNum">     729 </span>            :     char buf[50];
<span class="lineNum">     730 </span>            : 
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :     format=getushort(ttf);</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :     if ( format!=1 )    /* Unknown subtable format */</span>
<span class="lineNum">     733 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :     coverage = getushort(ttf);</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :     cnt = getushort(ttf);</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :     if ( cnt==0 )</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :     offsets = malloc(cnt*sizeof(struct ee_offsets));</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :         offsets[i].entry = getushort(ttf);</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :         offsets[i].exit  = getushort(ttf);</span>
<span class="lineNum">     742 </span>            :     }
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :     glyphs = getCoverageTable(ttf,stoffset+coverage,info);</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :     if ( glyphs==NULL ) {</span>
<span class="lineNum">     745 </span>            : /* GT: This continues a multi-line error message, hence the leading space */
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :         LogError( _(&quot; Bad cursive alignment table, ignored\n&quot;) );</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :         free(offsets);</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     749 </span>            :     }
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :     class = chunkalloc(sizeof(AnchorClass));</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :     snprintf(buf,sizeof(buf),_(&quot;Cursive-%d&quot;),</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :             info-&gt;anchor_class_cnt++ );</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :     class-&gt;name = copy(buf);</span>
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :     subtable-&gt;anchor_classes = true;</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :     class-&gt;subtable = subtable;</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :     class-&gt;type = act_curs;</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :     if ( info-&gt;ahead==NULL )</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :         info-&gt;ahead = class;</span>
<span class="lineNum">     760 </span>            :     else
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :         info-&gt;alast-&gt;next = class;</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :     info-&gt;alast = class;</span>
<span class="lineNum">     763 </span>            : 
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :         sc = info-&gt;chars[glyphs[i]];</span>
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :         if ( offsets[i].entry!=0 ) {</span>
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :             sc-&gt;anchor = readAnchorPoint(ttf,stoffset+offsets[i].entry,class,</span>
<span class="lineNum">     768 </span>            :                     at_centry,sc-&gt;anchor,info);
<span class="lineNum">     769 </span>            :         }
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :         if ( offsets[i].exit!=0 ) {</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :             sc-&gt;anchor = readAnchorPoint(ttf,stoffset+offsets[i].exit,class,</span>
<span class="lineNum">     772 </span>            :                     at_cexit,sc-&gt;anchor,info);
<span class="lineNum">     773 </span>            :         }
<span class="lineNum">     774 </span>            :     }
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :     free(offsets);</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :     free(glyphs);</span>
<a name="777"><span class="lineNum">     777 </span>            : }</a>
<span class="lineNum">     778 </span>            : 
<span class="lineNum">     779 </span><span class="lineCov">         65 : static AnchorClass **MarkGlyphsProcessMarks(FILE *ttf,int markoffset,</span>
<span class="lineNum">     780 </span>            :         struct ttfinfo *info,struct lookup *l, struct lookup_subtable *subtable,uint16 *markglyphs,
<span class="lineNum">     781 </span>            :         int classcnt) {
<span class="lineNum">     782 </span><span class="lineCov">         65 :     AnchorClass **classes = calloc(classcnt,sizeof(AnchorClass *)), *ac;</span>
<span class="lineNum">     783 </span>            :     char buf[50];
<span class="lineNum">     784 </span>            :     int i, cnt;
<span class="lineNum">     785 </span>            :     struct mr { uint16 class, offset; } *at_offsets;
<span class="lineNum">     786 </span>            :     SplineChar *sc;
<span class="lineNum">     787 </span>            : 
<span class="lineNum">     788 </span><span class="lineCov">         65 :     fseek(ttf,markoffset,SEEK_SET);</span>
<span class="lineNum">     789 </span><span class="lineCov">         65 :     cnt = getushort(ttf);</span>
<span class="lineNum">     790 </span><span class="lineCov">         65 :     if ( feof(ttf) ) {</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Bad mark table.\n&quot;) );</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">     794 </span>            :     }
<span class="lineNum">     795 </span>            : 
<span class="lineNum">     796 </span><span class="lineCov">        142 :     for ( i=0; i&lt;classcnt; ++i ) {</span>
<span class="lineNum">     797 </span><span class="lineCov">         77 :         snprintf(buf,sizeof(buf),_(&quot;Anchor-%d&quot;),</span>
<span class="lineNum">     798 </span><span class="lineCov">         77 :                 info-&gt;anchor_class_cnt+i );</span>
<span class="lineNum">     799 </span><span class="lineCov">         77 :         classes[i] = ac = chunkalloc(sizeof(AnchorClass));</span>
<span class="lineNum">     800 </span><span class="lineCov">         77 :         ac-&gt;name = copy(buf);</span>
<span class="lineNum">     801 </span><span class="lineCov">         77 :         subtable-&gt;anchor_classes = true;</span>
<span class="lineNum">     802 </span><span class="lineCov">         77 :         ac-&gt;subtable = subtable;</span>
<span class="lineNum">     803 </span>            :         /*ac-&gt;merge_with = info-&gt;anchor_merge_cnt+1;*/
<span class="lineNum">     804 </span><span class="lineCov">         77 :         ac-&gt;type = l-&gt;otlookup-&gt;lookup_type==gpos_mark2mark ? act_mkmk : act_mark;</span>
<span class="lineNum">     805 </span>            :             /* I don't distinguish between mark to base and mark to lig */
<span class="lineNum">     806 </span><span class="lineCov">         77 :         if ( info-&gt;ahead==NULL )</span>
<span class="lineNum">     807 </span><span class="lineCov">          9 :             info-&gt;ahead = ac;</span>
<span class="lineNum">     808 </span>            :         else
<span class="lineNum">     809 </span><span class="lineCov">         68 :             info-&gt;alast-&gt;next = ac;</span>
<span class="lineNum">     810 </span><span class="lineCov">         77 :         info-&gt;alast = ac;</span>
<span class="lineNum">     811 </span>            :     }
<span class="lineNum">     812 </span>            : 
<span class="lineNum">     813 </span><span class="lineCov">         65 :     at_offsets = malloc(cnt*sizeof(struct mr));</span>
<span class="lineNum">     814 </span><span class="lineCov">       1267 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">     815 </span><span class="lineCov">       1202 :         at_offsets[i].class = getushort(ttf);</span>
<span class="lineNum">     816 </span><span class="lineCov">       1202 :         at_offsets[i].offset = getushort(ttf);</span>
<span class="lineNum">     817 </span><span class="lineCov">       1202 :         if ( at_offsets[i].class&gt;=classcnt ) {</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :             at_offsets[i].class = 0;</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :             if ( markglyphs[i]&gt;=info-&gt;glyph_cnt )</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Class out of bounds in GPOS mark sub-table\n&quot;) );</span>
<span class="lineNum">     821 </span>            :             else
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Class out of bounds in GPOS mark sub-table for mark %.30s\n&quot;), info-&gt;chars[markglyphs[i]]-&gt;name);</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">     824 </span>            :         }
<span class="lineNum">     825 </span>            :     }
<span class="lineNum">     826 </span><span class="lineCov">       1267 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">     827 </span><span class="lineCov">       1202 :         if ( markglyphs[i]&gt;=info-&gt;glyph_cnt )</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">     829 </span><span class="lineCov">       1202 :         sc = info-&gt;chars[markglyphs[i]];</span>
<span class="lineNum">     830 </span><span class="lineCov">       1202 :         if ( sc==NULL || at_offsets[i].offset==0 )</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">     832 </span><span class="lineCov">       2404 :         sc-&gt;anchor = readAnchorPoint(ttf,markoffset+at_offsets[i].offset,</span>
<span class="lineNum">     833 </span><span class="lineCov">       1202 :                 classes[at_offsets[i].class],at_mark,sc-&gt;anchor,info);</span>
<span class="lineNum">     834 </span>            :     }
<span class="lineNum">     835 </span><span class="lineCov">         65 :     free(at_offsets);</span>
<span class="lineNum">     836 </span><span class="lineCov">         65 : return( classes );</span>
<a name="837"><span class="lineNum">     837 </span>            : }</a>
<span class="lineNum">     838 </span>            : 
<span class="lineNum">     839 </span><span class="lineCov">         62 : static void MarkGlyphsProcessBases(FILE *ttf,int baseoffset,</span>
<span class="lineNum">     840 </span>            :         struct ttfinfo *info,struct lookup *l, struct lookup_subtable *subtable,uint16 *baseglyphs,int classcnt,
<span class="lineNum">     841 </span>            :         AnchorClass **classes,enum anchor_type at) {
<span class="lineNum">     842 </span>            :     int basecnt,i, j, ibase;
<span class="lineNum">     843 </span>            :     uint16 *offsets;
<span class="lineNum">     844 </span>            :     SplineChar *sc;
<span class="lineNum">     845 </span>            : 
<span class="lineNum">     846 </span><span class="lineCov">         62 :     fseek(ttf,baseoffset,SEEK_SET);</span>
<span class="lineNum">     847 </span><span class="lineCov">         62 :     basecnt = getushort(ttf);</span>
<span class="lineNum">     848 </span><span class="lineCov">         62 :     if ( feof(ttf) ) {</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Bad base table.\n&quot;) );</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">     851 </span><span class="lineCov">         62 : return;</span>
<span class="lineNum">     852 </span>            :     }
<span class="lineNum">     853 </span><span class="lineCov">         62 :     offsets = malloc(basecnt*classcnt*sizeof(uint16));</span>
<span class="lineNum">     854 </span><span class="lineCov">      22221 :     for ( i=0; i&lt;basecnt*classcnt; ++i )</span>
<span class="lineNum">     855 </span><span class="lineCov">      22159 :         offsets[i] = getushort(ttf);</span>
<span class="lineNum">     856 </span><span class="lineCov">      12927 :     for ( i=ibase=0; i&lt;basecnt; ++i, ibase+= classcnt ) {</span>
<span class="lineNum">     857 </span><span class="lineCov">      12865 :         if ( baseglyphs[i]&gt;=info-&gt;glyph_cnt )</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">     859 </span><span class="lineCov">      12865 :         sc = info-&gt;chars[baseglyphs[i]];</span>
<span class="lineNum">     860 </span><span class="lineCov">      12865 :         if ( sc==NULL )</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">     862 </span><span class="lineCov">      35024 :         for ( j=0; j&lt;classcnt; ++j ) if ( offsets[ibase+j]!=0 ) {</span>
<span class="lineNum">     863 </span><span class="lineCov">      44318 :             sc-&gt;anchor = readAnchorPoint(ttf,baseoffset+offsets[ibase+j],</span>
<span class="lineNum">     864 </span><span class="lineCov">      22159 :                     classes[j], at,sc-&gt;anchor,info);</span>
<span class="lineNum">     865 </span>            :         }
<span class="lineNum">     866 </span>            :     }
<span class="lineNum">     867 </span><span class="lineCov">         62 :     free(offsets);</span>
<a name="868"><span class="lineNum">     868 </span>            : }</a>
<span class="lineNum">     869 </span>            : 
<span class="lineNum">     870 </span><span class="lineCov">          3 : static void MarkGlyphsProcessLigs(FILE *ttf,int baseoffset,</span>
<span class="lineNum">     871 </span>            :         struct ttfinfo *info,struct lookup *l, struct lookup_subtable *subtable,uint16 *baseglyphs,int classcnt,
<span class="lineNum">     872 </span>            :         AnchorClass **classes) {
<span class="lineNum">     873 </span>            :     int basecnt,compcnt, i, j, k, kbase;
<span class="lineNum">     874 </span>            :     uint16 *loffsets, *aoffsets;
<span class="lineNum">     875 </span>            :     SplineChar *sc;
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span><span class="lineCov">          3 :     fseek(ttf,baseoffset,SEEK_SET);</span>
<span class="lineNum">     878 </span><span class="lineCov">          3 :     basecnt = getushort(ttf);</span>
<span class="lineNum">     879 </span><span class="lineCov">          3 :     if ( feof(ttf) ) {</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Bad ligature base table.\n&quot;) );</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">     882 </span><span class="lineCov">          3 : return;</span>
<span class="lineNum">     883 </span>            :     }
<span class="lineNum">     884 </span><span class="lineCov">          3 :     loffsets = malloc(basecnt*sizeof(uint16));</span>
<span class="lineNum">     885 </span><span class="lineCov">        268 :     for ( i=0; i&lt;basecnt; ++i )</span>
<span class="lineNum">     886 </span><span class="lineCov">        265 :         loffsets[i] = getushort(ttf);</span>
<span class="lineNum">     887 </span><span class="lineCov">        268 :     for ( i=0; i&lt;basecnt; ++i ) {</span>
<span class="lineNum">     888 </span><span class="lineCov">        265 :         sc = info-&gt;chars[baseglyphs[i]];</span>
<span class="lineNum">     889 </span><span class="lineCov">        265 :         if ( baseglyphs[i]&gt;=info-&gt;glyph_cnt || sc==NULL )</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">     891 </span><span class="lineCov">        265 :         fseek(ttf,baseoffset+loffsets[i],SEEK_SET);</span>
<span class="lineNum">     892 </span><span class="lineCov">        265 :         compcnt = getushort(ttf);</span>
<span class="lineNum">     893 </span><span class="lineCov">        265 :         if ( feof(ttf)) {</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :             LogError(_(&quot;Bad ligature anchor count.\n&quot;));</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">     897 </span>            :         }
<span class="lineNum">     898 </span><span class="lineCov">        265 :         aoffsets = malloc(compcnt*classcnt*sizeof(uint16));</span>
<span class="lineNum">     899 </span><span class="lineCov">        530 :         for ( k=0; k&lt;compcnt*classcnt; ++k )</span>
<span class="lineNum">     900 </span><span class="lineCov">        265 :             aoffsets[k] = getushort(ttf);</span>
<span class="lineNum">     901 </span><span class="lineCov">        530 :         for ( k=kbase=0; k&lt;compcnt; ++k, kbase+=classcnt ) {</span>
<span class="lineNum">     902 </span><span class="lineCov">        530 :             for ( j=0; j&lt;classcnt; ++j ) if ( aoffsets[kbase+j]!=0 ) {</span>
<span class="lineNum">     903 </span><span class="lineCov">        530 :                 sc-&gt;anchor = readAnchorPoint(ttf,baseoffset+loffsets[i]+aoffsets[kbase+j],</span>
<span class="lineNum">     904 </span><span class="lineCov">        265 :                         classes[j], at_baselig,sc-&gt;anchor,info);</span>
<span class="lineNum">     905 </span><span class="lineCov">        265 :                 sc-&gt;anchor-&gt;lig_index = k;</span>
<span class="lineNum">     906 </span>            :             }
<span class="lineNum">     907 </span>            :         }
<span class="lineNum">     908 </span><span class="lineCov">        265 :         free(aoffsets);</span>
<span class="lineNum">     909 </span>            :     }
<span class="lineNum">     910 </span><span class="lineCov">          3 :     free(loffsets);</span>
<a name="911"><span class="lineNum">     911 </span>            : }</a>
<span class="lineNum">     912 </span>            : 
<span class="lineNum">     913 </span><span class="lineCov">         65 : static void gposMarkSubTable(FILE *ttf, uint32 stoffset,</span>
<span class="lineNum">     914 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable) {
<span class="lineNum">     915 </span>            :     int markcoverage, basecoverage, classcnt, markoffset, baseoffset;
<span class="lineNum">     916 </span>            :     uint16 *markglyphs, *baseglyphs;
<span class="lineNum">     917 </span>            :     AnchorClass **classes;
<span class="lineNum">     918 </span>            : 
<span class="lineNum">     919 </span>            :         /* The header for the three different mark tables is the same */
<span class="lineNum">     920 </span><span class="lineCov">         65 :     /* Type = */ getushort(ttf);</span>
<span class="lineNum">     921 </span><span class="lineCov">         65 :     markcoverage = getushort(ttf);</span>
<span class="lineNum">     922 </span><span class="lineCov">         65 :     basecoverage = getushort(ttf);</span>
<span class="lineNum">     923 </span><span class="lineCov">         65 :     classcnt = getushort(ttf);</span>
<span class="lineNum">     924 </span><span class="lineCov">         65 :     markoffset = getushort(ttf);</span>
<span class="lineNum">     925 </span><span class="lineCov">         65 :     baseoffset = getushort(ttf);</span>
<span class="lineNum">     926 </span><span class="lineCov">         65 :     markglyphs = getCoverageTable(ttf,stoffset+markcoverage,info);</span>
<span class="lineNum">     927 </span><span class="lineCov">         65 :     baseglyphs = getCoverageTable(ttf,stoffset+basecoverage,info);</span>
<span class="lineNum">     928 </span><span class="lineCov">         65 :     if ( baseglyphs==NULL || markglyphs==NULL ) {</span>
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :         free(baseglyphs); free(markglyphs);</span>
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :         LogError( _(&quot; Bad mark attachment table, ignored\n&quot;) );</span>
<span class="lineNum">     931 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     932 </span>            :     }
<span class="lineNum">     933 </span>            :         /* as is the (first) mark table */
<span class="lineNum">     934 </span><span class="lineCov">         65 :     classes = MarkGlyphsProcessMarks(ttf,stoffset+markoffset,</span>
<span class="lineNum">     935 </span>            :             info,l,subtable,markglyphs,classcnt);
<span class="lineNum">     936 </span><span class="lineCov">         65 :     if ( classes==NULL ) {</span>
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :         free(baseglyphs);</span>
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :         free(markglyphs);</span>
<span class="lineNum">     939 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     940 </span>            :     }
<span class="lineNum">     941 </span><span class="lineCov">         65 :     switch ( l-&gt;otlookup-&gt;lookup_type ) {</span>
<span class="lineNum">     942 </span>            :       case gpos_mark2base:
<span class="lineNum">     943 </span>            :       case gpos_mark2mark:
<span class="lineNum">     944 </span><span class="lineCov">         62 :           MarkGlyphsProcessBases(ttf,stoffset+baseoffset,</span>
<span class="lineNum">     945 </span>            :             info,l,subtable,baseglyphs,classcnt,classes,
<span class="lineNum">     946 </span><span class="lineCov">         62 :             l-&gt;otlookup-&gt;lookup_type==gpos_mark2base?at_basechar:at_basemark);</span>
<span class="lineNum">     947 </span><span class="lineCov">         62 :       break;</span>
<span class="lineNum">     948 </span>            :       case gpos_mark2ligature:
<span class="lineNum">     949 </span><span class="lineCov">          3 :           MarkGlyphsProcessLigs(ttf,stoffset+baseoffset,</span>
<span class="lineNum">     950 </span>            :             info,l,subtable,baseglyphs,classcnt,classes);
<span class="lineNum">     951 </span><span class="lineCov">          3 :       break;</span>
<span class="lineNum">     952 </span>            :     }
<span class="lineNum">     953 </span><span class="lineCov">         65 :     info-&gt;anchor_class_cnt += classcnt;</span>
<span class="lineNum">     954 </span><span class="lineCov">         65 :     ++ info-&gt;anchor_merge_cnt;</span>
<span class="lineNum">     955 </span><span class="lineCov">         65 :     free(markglyphs); free(baseglyphs);</span>
<span class="lineNum">     956 </span><span class="lineCov">         65 :     free(classes);</span>
<a name="957"><span class="lineNum">     957 </span>            : }</a>
<span class="lineNum">     958 </span>            : 
<span class="lineNum">     959 </span><span class="lineCov">          3 : static void gposSimplePos(FILE *ttf, int stoffset, struct ttfinfo *info,</span>
<span class="lineNum">     960 </span>            :         struct lookup *l, struct lookup_subtable *subtable) {
<span class="lineNum">     961 </span>            :     int coverage, cnt, i, vf;
<span class="lineNum">     962 </span>            :     uint16 format;
<span class="lineNum">     963 </span>            :     uint16 *glyphs;
<span class="lineNum">     964 </span><span class="lineCov">          3 :     struct valuerecord *vr=NULL, _vr, *which;</span>
<span class="lineNum">     965 </span>            : 
<span class="lineNum">     966 </span><span class="lineCov">          3 :     format=getushort(ttf);</span>
<span class="lineNum">     967 </span><span class="lineCov">          3 :     if ( format!=1 &amp;&amp; format!=2 )       /* Unknown subtable format */</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     969 </span><span class="lineCov">          3 :     coverage = getushort(ttf);</span>
<span class="lineNum">     970 </span><span class="lineCov">          3 :     vf = getushort(ttf);</span>
<span class="lineNum">     971 </span><span class="lineCov">          3 :     if ( vf==0 )</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     973 </span><span class="lineCov">          3 :     if ( format==1 ) {</span>
<span class="lineNum">     974 </span><span class="lineCov">          3 :         memset(&amp;_vr,0,sizeof(_vr));</span>
<span class="lineNum">     975 </span><span class="lineCov">          3 :         readvaluerecord(&amp;_vr,vf,ttf);</span>
<span class="lineNum">     976 </span>            :     } else {
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :         cnt = getushort(ttf);</span>
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :         vr = calloc(cnt,sizeof(struct valuerecord));</span>
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;cnt; ++i )</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :             readvaluerecord(&amp;vr[i],vf,ttf);</span>
<span class="lineNum">     981 </span>            :     }
<span class="lineNum">     982 </span><span class="lineCov">          3 :     glyphs = getCoverageTable(ttf,stoffset+coverage,info);</span>
<span class="lineNum">     983 </span><span class="lineCov">          3 :     if ( glyphs==NULL ) {</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :         free(vr);</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :         LogError( _(&quot; Bad simple positioning table, ignored\n&quot;) );</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">     987 </span>            :     }
<span class="lineNum">     988 </span><span class="lineCov">          6 :     for ( i=0; glyphs[i]!=0xffff; ++i ) if ( glyphs[i]&lt;info-&gt;glyph_cnt &amp;&amp; info-&gt;chars[glyphs[i]]!=NULL ) {</span>
<span class="lineNum">     989 </span><span class="lineCov">          3 :         PST *pos = chunkalloc(sizeof(PST));</span>
<span class="lineNum">     990 </span><span class="lineCov">          3 :         pos-&gt;type = pst_position;</span>
<span class="lineNum">     991 </span><span class="lineCov">          3 :         pos-&gt;subtable = subtable;</span>
<span class="lineNum">     992 </span><span class="lineCov">          3 :         pos-&gt;next = info-&gt;chars[glyphs[i]]-&gt;possub;</span>
<span class="lineNum">     993 </span><span class="lineCov">          3 :         info-&gt;chars[glyphs[i]]-&gt;possub = pos;</span>
<span class="lineNum">     994 </span><span class="lineCov">          3 :         which = format==1 ? &amp;_vr : &amp;vr[i];</span>
<span class="lineNum">     995 </span><span class="lineCov">          3 :         pos-&gt;u.pos.xoff = which-&gt;xplacement;</span>
<span class="lineNum">     996 </span><span class="lineCov">          3 :         pos-&gt;u.pos.yoff = which-&gt;yplacement;</span>
<span class="lineNum">     997 </span><span class="lineCov">          3 :         pos-&gt;u.pos.h_adv_off = which-&gt;xadvance;</span>
<span class="lineNum">     998 </span><span class="lineCov">          3 :         pos-&gt;u.pos.v_adv_off = which-&gt;yadvance;</span>
<span class="lineNum">     999 </span><span class="lineCov">          3 :         pos-&gt;u.pos.adjust = readValDevTab(ttf,which,stoffset,info);</span>
<span class="lineNum">    1000 </span>            :     }
<span class="lineNum">    1001 </span><span class="lineCov">          3 :     subtable-&gt;per_glyph_pst_or_kern = true;</span>
<span class="lineNum">    1002 </span><span class="lineCov">          3 :     free(vr);</span>
<span class="lineNum">    1003 </span><span class="lineCov">          3 :     free(glyphs);</span>
<a name="1004"><span class="lineNum">    1004 </span>            : }</a>
<span class="lineNum">    1005 </span>            : 
<span class="lineNum">    1006 </span><span class="lineCov">         72 : static void ProcessSubLookups(FILE *ttf,struct ttfinfo *info,int gpos,</span>
<span class="lineNum">    1007 </span>            :         struct lookup *alllooks,struct seqlookup *sl) {
<span class="lineNum">    1008 </span>            :     int i;
<span class="lineNum">    1009 </span>            : 
<span class="lineNum">    1010 </span><span class="lineCov">         72 :     i = (intpt) sl-&gt;lookup;</span>
<span class="lineNum">    1011 </span><span class="lineCov">         72 :     if ( i&lt;0 || i&gt;=info-&gt;lookup_cnt ) {</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Attempt to reference lookup %d (within a contextual lookup), but there are\n only %d lookups in %s\n&quot;),</span>
<span class="lineNum">    1013 </span>            :                 i, info-&gt;lookup_cnt, gpos ? &quot;'GPOS'&quot; : &quot;'GSUB'&quot; );
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :         sl-&gt;lookup = NULL;</span>
<span class="lineNum">    1016 </span><span class="lineCov">         72 : return;</span>
<span class="lineNum">    1017 </span>            :     }
<span class="lineNum">    1018 </span><span class="lineCov">         72 :     sl-&gt;lookup = alllooks[i].otlookup;</span>
<a name="1019"><span class="lineNum">    1019 </span>            : }</a>
<span class="lineNum">    1020 </span>            : 
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 : static void g___ContextSubTable1(FILE *ttf, int stoffset,</span>
<span class="lineNum">    1022 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, int justinuse,
<span class="lineNum">    1023 </span>            :         struct lookup *alllooks, int gpos) {
<span class="lineNum">    1024 </span>            :     int i, j, k, rcnt, cnt;
<span class="lineNum">    1025 </span>            :     uint16 coverage;
<span class="lineNum">    1026 </span>            :     uint16 *glyphs;
<span class="lineNum">    1027 </span>            :     struct subrule {
<span class="lineNum">    1028 </span>            :         uint32 offset;
<span class="lineNum">    1029 </span>            :         int gcnt;
<span class="lineNum">    1030 </span>            :         int scnt;
<span class="lineNum">    1031 </span>            :         uint16 *glyphs;
<span class="lineNum">    1032 </span>            :         struct seqlookup *sl;
<span class="lineNum">    1033 </span>            :     };
<span class="lineNum">    1034 </span>            :     struct rule {
<span class="lineNum">    1035 </span>            :         uint32 offsets;
<span class="lineNum">    1036 </span>            :         int scnt;
<span class="lineNum">    1037 </span>            :         struct subrule *subrules;
<span class="lineNum">    1038 </span>            :     } *rules;
<span class="lineNum">    1039 </span>            :     FPST *fpst;
<span class="lineNum">    1040 </span>            :     struct fpst_rule *rule;
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :     int warned = false, warned2 = false;</span>
<span class="lineNum">    1042 </span>            : 
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :     coverage = getushort(ttf);</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :     rcnt = getushort(ttf);              /* glyph count in coverage table */</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :     rules = malloc(rcnt*sizeof(struct rule));</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;rcnt; ++i )</span>
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :         rules[i].offsets = getushort(ttf)+stoffset;</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :     glyphs = getCoverageTable(ttf,stoffset+coverage,info);</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :     if ( glyphs==NULL ) {</span>
<span class="lineNum">    1050 </span>            : /* GT: This continues a multi-line error message, hence the leading space */
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :         LogError( _(&quot; Bad contextual table, ignored\n&quot;) );</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :         free(rules);</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1054 </span>            :     }
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :     cnt = 0;</span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;rcnt; ++i ) {</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :         fseek(ttf,rules[i].offsets,SEEK_SET);</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :         rules[i].scnt = getushort(ttf);</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :         cnt += rules[i].scnt;</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :         rules[i].subrules = malloc(rules[i].scnt*sizeof(struct subrule));</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;rules[i].scnt; ++j )</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].offset = getushort(ttf)+rules[i].offsets;</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;rules[i].scnt; ++j ) {</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :             fseek(ttf,rules[i].subrules[j].offset,SEEK_SET);</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].gcnt = getushort(ttf);</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].scnt = getushort(ttf);</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].glyphs = malloc((rules[i].subrules[j].gcnt+1)*sizeof(uint16));</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].glyphs[0] = glyphs[i];</span>
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :             for ( k=1; k&lt;rules[i].subrules[j].gcnt; ++k ) {</span>
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :                 rules[i].subrules[j].glyphs[k] = getushort(ttf);</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :                 if ( rules[i].subrules[j].glyphs[k]&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :                     if ( !warned )</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :                         LogError( _(&quot;Bad contextual or chaining sub table. Glyph %d out of range [0,%d)\n&quot;),</span>
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :                                  rules[i].subrules[j].glyphs[k], info-&gt;glyph_cnt );</span>
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :                     info-&gt;bad_ot = true;</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :                     warned = true;</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :                     rules[i].subrules[j].glyphs[k] = 0;</span>
<span class="lineNum">    1078 </span>            :                  }
<span class="lineNum">    1079 </span>            :             }
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].glyphs[k] = 0xffff;</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].sl = malloc(rules[i].subrules[j].scnt*sizeof(struct seqlookup));</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :             for ( k=0; k&lt;rules[i].subrules[j].scnt; ++k ) {</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :                 rules[i].subrules[j].sl[k].seq = getushort(ttf);</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :                 if ( rules[i].subrules[j].sl[k].seq &gt;= rules[i].subrules[j].gcnt+1 )</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :                     if ( !warned2 ) {</span>
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :                         LogError( _(&quot;Attempt to apply a lookup to a location out of the range of this contextual\n lookup seq=%d max=%d\n&quot;),</span>
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :                                 rules[i].subrules[j].sl[k].seq, rules[i].subrules[j].gcnt );</span>
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :                         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :                         warned2 = true;</span>
<span class="lineNum">    1090 </span>            :                     }
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :                 rules[i].subrules[j].sl[k].lookup = (void *) (intpt) getushort(ttf);</span>
<span class="lineNum">    1092 </span>            :             }
<span class="lineNum">    1093 </span>            :         }
<span class="lineNum">    1094 </span>            :     }
<span class="lineNum">    1095 </span>            : 
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :     if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    1097 </span>            :         /* Nothing to do. This lookup doesn't really reference any glyphs */
<span class="lineNum">    1098 </span>            :         /*  any lookups it invokes will be processed on their own */
<span class="lineNum">    1099 </span>            :     } else {
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :         fpst = chunkalloc(sizeof(FPST));</span>
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :         fpst-&gt;type = gpos ? pst_contextpos : pst_contextsub;</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :         fpst-&gt;format = pst_glyphs;</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :         fpst-&gt;subtable = subtable;</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :         fpst-&gt;next = info-&gt;possub;</span>
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :         info-&gt;possub = fpst;</span>
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :         subtable-&gt;fpst = fpst;</span>
<span class="lineNum">    1107 </span>            : 
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :         fpst-&gt;rules = rule = calloc(cnt,sizeof(struct fpst_rule));</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :         fpst-&gt;rule_cnt = cnt;</span>
<span class="lineNum">    1110 </span>            : 
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :         cnt = 0;</span>
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;rcnt; ++i ) for ( j=0; j&lt;rules[i].scnt; ++j ) {</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :             rule[cnt].u.glyph.names = GlyphsToNames(info,rules[i].subrules[j].glyphs,false);</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :             rule[cnt].lookup_cnt = rules[i].subrules[j].scnt;</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :             rule[cnt].lookups = rules[i].subrules[j].sl;</span>
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].sl = NULL;</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :             for ( k=0; k&lt;rule[cnt].lookup_cnt; ++k )</span>
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :                 ProcessSubLookups(ttf,info,gpos,alllooks,&amp;rule[cnt].lookups[k]);</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :             ++cnt;</span>
<span class="lineNum">    1120 </span>            :         }
<span class="lineNum">    1121 </span>            :     }
<span class="lineNum">    1122 </span>            : 
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;rcnt; ++i ) {</span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;rules[i].scnt; ++j ) {</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :             free(rules[i].subrules[j].glyphs);</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :             free(rules[i].subrules[j].sl);</span>
<span class="lineNum">    1127 </span>            :         }
<span class="lineNum">    1128 </span><span class="lineNoCov">          0 :         free(rules[i].subrules);</span>
<span class="lineNum">    1129 </span>            :     }
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 :     free(rules);</span>
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 :     free(glyphs);</span>
<a name="1132"><span class="lineNum">    1132 </span>            : }</a>
<span class="lineNum">    1133 </span>            : 
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 : static void g___ChainingSubTable1(FILE *ttf, int stoffset,</span>
<span class="lineNum">    1135 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, int justinuse,
<span class="lineNum">    1136 </span>            :         struct lookup *alllooks, int gpos) {
<span class="lineNum">    1137 </span>            :     int i, j, k, rcnt, cnt, which;
<span class="lineNum">    1138 </span>            :     uint16 coverage;
<span class="lineNum">    1139 </span>            :     uint16 *glyphs;
<span class="lineNum">    1140 </span>            :     struct subrule {
<span class="lineNum">    1141 </span>            :         uint32 offset;
<span class="lineNum">    1142 </span>            :         int gcnt, bcnt, fcnt;
<span class="lineNum">    1143 </span>            :         int scnt;
<span class="lineNum">    1144 </span>            :         uint16 *glyphs, *bglyphs, *fglyphs;
<span class="lineNum">    1145 </span>            :         struct seqlookup *sl;
<span class="lineNum">    1146 </span>            :     };
<span class="lineNum">    1147 </span>            :     struct rule {
<span class="lineNum">    1148 </span>            :         uint32 offsets;
<span class="lineNum">    1149 </span>            :         int scnt;
<span class="lineNum">    1150 </span>            :         struct subrule *subrules;
<span class="lineNum">    1151 </span>            :     } *rules;
<span class="lineNum">    1152 </span>            :     FPST *fpst;
<span class="lineNum">    1153 </span>            :     struct fpst_rule *rule;
<span class="lineNum">    1154 </span><span class="lineNoCov">          0 :     int warned = false, warned2 = false;</span>
<span class="lineNum">    1155 </span>            : 
<span class="lineNum">    1156 </span><span class="lineNoCov">          0 :     coverage = getushort(ttf);</span>
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :     rcnt = getushort(ttf);              /* glyph count in coverage table */</span>
<span class="lineNum">    1158 </span><span class="lineNoCov">          0 :     rules = malloc(rcnt*sizeof(struct rule));</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;rcnt; ++i )</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :         rules[i].offsets = getushort(ttf)+stoffset;</span>
<span class="lineNum">    1161 </span><span class="lineNoCov">          0 :     glyphs = getCoverageTable(ttf,stoffset+coverage,info);</span>
<span class="lineNum">    1162 </span><span class="lineNoCov">          0 :     if ( glyphs==NULL ) {</span>
<span class="lineNum">    1163 </span><span class="lineNoCov">          0 :         free(rules);</span>
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :         LogError( _(&quot; Bad contextual chaining table, ignored\n&quot;) );</span>
<span class="lineNum">    1165 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1166 </span>            :     }
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 :     cnt = 0;</span>
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;rcnt; ++i ) {</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :         fseek(ttf,rules[i].offsets,SEEK_SET);</span>
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :         rules[i].scnt = getushort(ttf);</span>
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :         cnt += rules[i].scnt;</span>
<span class="lineNum">    1172 </span><span class="lineNoCov">          0 :         rules[i].subrules = malloc(rules[i].scnt*sizeof(struct subrule));</span>
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;rules[i].scnt; ++j )</span>
<span class="lineNum">    1174 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].offset = getushort(ttf)+rules[i].offsets;</span>
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;rules[i].scnt; ++j ) {</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :             fseek(ttf,rules[i].subrules[j].offset,SEEK_SET);</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].bcnt = getushort(ttf);</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :             if ( feof(ttf)) {</span>
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Unexpected end of file in contextual chaining subtable.\n&quot;) );</span>
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1182 </span>            :             }
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].bglyphs = malloc((rules[i].subrules[j].bcnt+1)*sizeof(uint16));</span>
<span class="lineNum">    1184 </span><span class="lineNoCov">          0 :             for ( k=0; k&lt;rules[i].subrules[j].bcnt; ++k )</span>
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 :                 rules[i].subrules[j].bglyphs[k] = getushort(ttf);</span>
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].bglyphs[k] = 0xffff;</span>
<span class="lineNum">    1187 </span>            : 
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].gcnt = getushort(ttf);</span>
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :             if ( feof(ttf)) {</span>
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Unexpected end of file in contextual chaining subtable.\n&quot;) );</span>
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1193 </span>            :             }
<span class="lineNum">    1194 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].glyphs = malloc((rules[i].subrules[j].gcnt+1)*sizeof(uint16));</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].glyphs[0] = glyphs[i];</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :             for ( k=1; k&lt;rules[i].subrules[j].gcnt; ++k )</span>
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :                 rules[i].subrules[j].glyphs[k] = getushort(ttf);</span>
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].glyphs[k] = 0xffff;</span>
<span class="lineNum">    1199 </span>            : 
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].fcnt = getushort(ttf);</span>
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 :             if ( feof(ttf)) {</span>
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Unexpected end of file in contextual chaining subtable.\n&quot;) );</span>
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1205 </span>            :             }
<span class="lineNum">    1206 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].fglyphs = malloc((rules[i].subrules[j].fcnt+1)*sizeof(uint16));</span>
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :             for ( k=0; k&lt;rules[i].subrules[j].fcnt; ++k )</span>
<span class="lineNum">    1208 </span><span class="lineNoCov">          0 :                 rules[i].subrules[j].fglyphs[k] = getushort(ttf);</span>
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].fglyphs[k] = 0xffff;</span>
<span class="lineNum">    1210 </span>            : 
<span class="lineNum">    1211 </span><span class="lineNoCov">          0 :             for ( which = 0; which&lt;3; ++which ) {</span>
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :                 for ( k=0; k&lt;(&amp;rules[i].subrules[j].gcnt)[which]; ++k ) {</span>
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :                     if ( (&amp;rules[i].subrules[j].glyphs)[which][k]&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :                         if ( !warned )</span>
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 :                             LogError( _(&quot;Bad contextual or chaining sub table. Glyph %d out of range [0,%d)\n&quot;),</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :                                     (&amp;rules[i].subrules[j].glyphs)[which][k], info-&gt;glyph_cnt );</span>
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :                         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :                         warned = true;</span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :                         (&amp;rules[i].subrules[j].glyphs)[which][k] = 0;</span>
<span class="lineNum">    1220 </span>            :                     }
<span class="lineNum">    1221 </span>            :                 }
<span class="lineNum">    1222 </span>            :             }
<span class="lineNum">    1223 </span>            : 
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].scnt = getushort(ttf);</span>
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :             if ( feof(ttf)) {</span>
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Unexpected end of file in contextual chaining subtable.\n&quot;) );</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1229 </span>            :             }
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].sl = malloc(rules[i].subrules[j].scnt*sizeof(struct seqlookup));</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :             for ( k=0; k&lt;rules[i].subrules[j].scnt; ++k ) {</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :                 rules[i].subrules[j].sl[k].seq = getushort(ttf);</span>
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :                 if ( rules[i].subrules[j].sl[k].seq &gt;= rules[i].subrules[j].gcnt+1 )</span>
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :                     if ( !warned2 ) {</span>
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :                         LogError( _(&quot;Attempt to apply a lookup to a location out of the range of this contextual\n lookup seq=%d max=%d\n&quot;),</span>
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :                                 rules[i].subrules[j].sl[k].seq, rules[i].subrules[j].gcnt );</span>
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :                         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :                         warned2 = true;</span>
<span class="lineNum">    1239 </span>            :                     }
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :                 rules[i].subrules[j].sl[k].lookup = (void *) (intpt) getushort(ttf);</span>
<span class="lineNum">    1241 </span>            :             }
<span class="lineNum">    1242 </span>            :         }
<span class="lineNum">    1243 </span>            :     }
<span class="lineNum">    1244 </span>            : 
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 :     if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    1246 </span>            :         /* Nothing to do. This lookup doesn't really reference any glyphs */
<span class="lineNum">    1247 </span>            :         /*  any lookups it invokes will be processed on their own */
<span class="lineNum">    1248 </span>            :     } else {
<span class="lineNum">    1249 </span><span class="lineNoCov">          0 :         fpst = chunkalloc(sizeof(FPST));</span>
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :         fpst-&gt;type = gpos ? pst_chainpos : pst_chainsub;</span>
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :         fpst-&gt;format = pst_glyphs;</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :         fpst-&gt;subtable = subtable;</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :         fpst-&gt;next = info-&gt;possub;</span>
<span class="lineNum">    1254 </span><span class="lineNoCov">          0 :         info-&gt;possub = fpst;</span>
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :         subtable-&gt;fpst = fpst;</span>
<span class="lineNum">    1256 </span>            : 
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 :         fpst-&gt;rules = rule = calloc(cnt,sizeof(struct fpst_rule));</span>
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :         fpst-&gt;rule_cnt = cnt;</span>
<span class="lineNum">    1259 </span>            : 
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :         cnt = 0;</span>
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;rcnt; ++i ) for ( j=0; j&lt;rules[i].scnt; ++j ) {</span>
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :             rule[cnt].u.glyph.back = GlyphsToNames(info,rules[i].subrules[j].bglyphs,false);</span>
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :             rule[cnt].u.glyph.names = GlyphsToNames(info,rules[i].subrules[j].glyphs,false);</span>
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :             rule[cnt].u.glyph.fore = GlyphsToNames(info,rules[i].subrules[j].fglyphs,false);</span>
<span class="lineNum">    1265 </span><span class="lineNoCov">          0 :             rule[cnt].lookup_cnt = rules[i].subrules[j].scnt;</span>
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :             rule[cnt].lookups = rules[i].subrules[j].sl;</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :             rules[i].subrules[j].sl = NULL;</span>
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :             for ( k=0; k&lt;rule[cnt].lookup_cnt; ++k )</span>
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 :                 ProcessSubLookups(ttf,info,gpos,alllooks,&amp;rule[cnt].lookups[k]);</span>
<span class="lineNum">    1270 </span><span class="lineNoCov">          0 :             ++cnt;</span>
<span class="lineNum">    1271 </span>            :         }
<span class="lineNum">    1272 </span>            :     }
<span class="lineNum">    1273 </span>            : 
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;rcnt; ++i ) {</span>
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;rules[i].scnt; ++j ) {</span>
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :             free(rules[i].subrules[j].bglyphs);</span>
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :             free(rules[i].subrules[j].glyphs);</span>
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :             free(rules[i].subrules[j].fglyphs);</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :             free(rules[i].subrules[j].sl);</span>
<span class="lineNum">    1280 </span>            :         }
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :         free(rules[i].subrules);</span>
<span class="lineNum">    1282 </span>            :     }
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :     free(rules);</span>
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :     free(glyphs);</span>
<a name="1285"><span class="lineNum">    1285 </span>            : }</a>
<span class="lineNum">    1286 </span>            : 
<span class="lineNum">    1287 </span><span class="lineCov">         12 : static void g___ContextSubTable2(FILE *ttf, int stoffset,</span>
<span class="lineNum">    1288 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, int justinuse,
<span class="lineNum">    1289 </span>            :         struct lookup *alllooks, int gpos) {
<span class="lineNum">    1290 </span>            :     int i, j, k, rcnt, cnt;
<span class="lineNum">    1291 </span>            :     uint16 coverage;
<span class="lineNum">    1292 </span>            :     uint16 classoff;
<span class="lineNum">    1293 </span>            :     struct subrule {
<span class="lineNum">    1294 </span>            :         uint32 offset;
<span class="lineNum">    1295 </span>            :         int ccnt;
<span class="lineNum">    1296 </span>            :         int scnt;
<span class="lineNum">    1297 </span>            :         uint16 *classindeces;
<span class="lineNum">    1298 </span>            :         struct seqlookup *sl;
<span class="lineNum">    1299 </span>            :     };
<span class="lineNum">    1300 </span>            :     struct rule {
<span class="lineNum">    1301 </span>            :         uint32 offsets;
<span class="lineNum">    1302 </span>            :         int scnt;
<span class="lineNum">    1303 </span>            :         struct subrule *subrules;
<span class="lineNum">    1304 </span>            :     } *rules;
<span class="lineNum">    1305 </span>            :     FPST *fpst;
<span class="lineNum">    1306 </span>            :     struct fpst_rule *rule;
<span class="lineNum">    1307 </span>            :     uint16 *glyphs, *class;
<span class="lineNum">    1308 </span><span class="lineCov">         12 :     int warned2 = false;</span>
<span class="lineNum">    1309 </span>            : 
<span class="lineNum">    1310 </span><span class="lineCov">         12 :     coverage = getushort(ttf);</span>
<span class="lineNum">    1311 </span><span class="lineCov">         12 :     classoff = getushort(ttf);</span>
<span class="lineNum">    1312 </span><span class="lineCov">         12 :     rcnt = getushort(ttf);              /* class count in coverage table *//* == number of top level rules */</span>
<span class="lineNum">    1313 </span><span class="lineCov">         12 :     rules = calloc(rcnt,sizeof(struct rule));</span>
<span class="lineNum">    1314 </span><span class="lineCov">         66 :     for ( i=0; i&lt;rcnt; ++i )</span>
<span class="lineNum">    1315 </span><span class="lineCov">         54 :         rules[i].offsets = getushort(ttf)+stoffset;</span>
<span class="lineNum">    1316 </span><span class="lineCov">         12 :     cnt = 0;</span>
<span class="lineNum">    1317 </span><span class="lineCov">         66 :     for ( i=0; i&lt;rcnt; ++i ) if ( rules[i].offsets!=stoffset ) { /* some classes might be unused */</span>
<span class="lineNum">    1318 </span><span class="lineCov">         18 :         fseek(ttf,rules[i].offsets,SEEK_SET);</span>
<span class="lineNum">    1319 </span><span class="lineCov">         18 :         rules[i].scnt = getushort(ttf);</span>
<span class="lineNum">    1320 </span><span class="lineCov">         18 :         if ( rules[i].scnt&lt;0 ) {</span>
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Bad count in context chaining sub-table.\n&quot;) );</span>
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 :             free(rules);</span>
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1325 </span>            :         }
<span class="lineNum">    1326 </span><span class="lineCov">         18 :         cnt += rules[i].scnt;</span>
<span class="lineNum">    1327 </span><span class="lineCov">         18 :         rules[i].subrules = malloc(rules[i].scnt*sizeof(struct subrule));</span>
<span class="lineNum">    1328 </span><span class="lineCov">         60 :         for ( j=0; j&lt;rules[i].scnt; ++j )</span>
<span class="lineNum">    1329 </span><span class="lineCov">         42 :             rules[i].subrules[j].offset = getushort(ttf)+rules[i].offsets;</span>
<span class="lineNum">    1330 </span><span class="lineCov">         60 :         for ( j=0; j&lt;rules[i].scnt; ++j ) {</span>
<span class="lineNum">    1331 </span><span class="lineCov">         42 :             fseek(ttf,rules[i].subrules[j].offset,SEEK_SET);</span>
<span class="lineNum">    1332 </span><span class="lineCov">         42 :             rules[i].subrules[j].ccnt = getushort(ttf);</span>
<span class="lineNum">    1333 </span><span class="lineCov">         42 :             rules[i].subrules[j].scnt = getushort(ttf);</span>
<span class="lineNum">    1334 </span><span class="lineCov">         42 :             if ( rules[i].subrules[j].ccnt&lt;0 ) {</span>
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad class count in contextual chaining sub-table.\n&quot;) );</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :                 free(rules);</span>
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1339 </span>            :             }
<span class="lineNum">    1340 </span><span class="lineCov">         42 :             rules[i].subrules[j].classindeces = malloc(rules[i].subrules[j].ccnt*sizeof(uint16));</span>
<span class="lineNum">    1341 </span><span class="lineCov">         42 :             rules[i].subrules[j].classindeces[0] = i;</span>
<span class="lineNum">    1342 </span><span class="lineCov">        114 :             for ( k=1; k&lt;rules[i].subrules[j].ccnt; ++k )</span>
<span class="lineNum">    1343 </span><span class="lineCov">         72 :                 rules[i].subrules[j].classindeces[k] = getushort(ttf);</span>
<span class="lineNum">    1344 </span><span class="lineCov">         42 :             if ( rules[i].subrules[j].scnt&lt;0 ) {</span>
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad count in contextual chaining sub-table.\n&quot;) );</span>
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :                 free(rules);</span>
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1349 </span>            :             }
<span class="lineNum">    1350 </span><span class="lineCov">         42 :             rules[i].subrules[j].sl = malloc(rules[i].subrules[j].scnt*sizeof(struct seqlookup));</span>
<span class="lineNum">    1351 </span><span class="lineCov">         96 :             for ( k=0; k&lt;rules[i].subrules[j].scnt; ++k ) {</span>
<span class="lineNum">    1352 </span><span class="lineCov">         54 :                 rules[i].subrules[j].sl[k].seq = getushort(ttf);</span>
<span class="lineNum">    1353 </span><span class="lineCov">         54 :                 if ( rules[i].subrules[j].sl[k].seq &gt;= rules[i].subrules[j].ccnt )</span>
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :                     if ( !warned2 ) {</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :                         LogError( _(&quot;Attempt to apply a lookup to a location out of the range of this contextual\n lookup seq=%d max=%d\n&quot;),</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :                                 rules[i].subrules[j].sl[k].seq, rules[i].subrules[j].ccnt-1);</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :                         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :                         warned2 = true;</span>
<span class="lineNum">    1359 </span>            :                     }
<span class="lineNum">    1360 </span><span class="lineCov">         54 :                 rules[i].subrules[j].sl[k].lookup = (void *) (intpt) getushort(ttf);</span>
<span class="lineNum">    1361 </span>            :             }
<span class="lineNum">    1362 </span>            :         }
<span class="lineNum">    1363 </span>            :     }
<span class="lineNum">    1364 </span>            : 
<span class="lineNum">    1365 </span><span class="lineCov">         12 :     if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    1366 </span>            :         /* Nothing to do. This lookup doesn't really reference any glyphs */
<span class="lineNum">    1367 </span>            :         /*  any lookups it invokes will be processed on their own */
<span class="lineNum">    1368 </span>            :     } else {
<span class="lineNum">    1369 </span><span class="lineCov">         12 :         fpst = chunkalloc(sizeof(FPST));</span>
<span class="lineNum">    1370 </span><span class="lineCov">         12 :         fpst-&gt;type = gpos ? pst_contextpos : pst_contextsub;</span>
<span class="lineNum">    1371 </span><span class="lineCov">         12 :         fpst-&gt;format = pst_class;</span>
<span class="lineNum">    1372 </span><span class="lineCov">         12 :         fpst-&gt;subtable = subtable;</span>
<span class="lineNum">    1373 </span><span class="lineCov">         12 :         subtable-&gt;fpst = fpst;</span>
<span class="lineNum">    1374 </span><span class="lineCov">         12 :         fpst-&gt;next = info-&gt;possub;</span>
<span class="lineNum">    1375 </span><span class="lineCov">         12 :         info-&gt;possub = fpst;</span>
<span class="lineNum">    1376 </span>            : 
<span class="lineNum">    1377 </span><span class="lineCov">         12 :         fpst-&gt;rules = rule = calloc(cnt,sizeof(struct fpst_rule));</span>
<span class="lineNum">    1378 </span><span class="lineCov">         12 :         fpst-&gt;rule_cnt = cnt;</span>
<span class="lineNum">    1379 </span><span class="lineCov">         12 :         class = getClassDefTable(ttf, stoffset+classoff, info);</span>
<span class="lineNum">    1380 </span><span class="lineCov">         12 :         fpst-&gt;nccnt = ClassFindCnt(class,info-&gt;glyph_cnt);</span>
<span class="lineNum">    1381 </span><span class="lineCov">         12 :         fpst-&gt;nclass = ClassToNames(info,fpst-&gt;nccnt,class,info-&gt;glyph_cnt);</span>
<span class="lineNum">    1382 </span><span class="lineCov">         12 :         fpst-&gt;nclassnames = calloc(fpst-&gt;nccnt,sizeof(char *));</span>
<span class="lineNum">    1383 </span>            : 
<span class="lineNum">    1384 </span>            :         /* Just in case they used the coverage table to redefine class 0 */
<span class="lineNum">    1385 </span><span class="lineCov">         12 :         glyphs = getCoverageTable(ttf,stoffset+coverage,info);</span>
<span class="lineNum">    1386 </span><span class="lineCov">         12 :         if ( glyphs==NULL ) {</span>
<span class="lineNum">    1387 </span>            : /* GT: This continues a multi-line error message, hence the leading space */
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :             LogError( _(&quot; Bad contextual substitution table, ignored\n&quot;) );</span>
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :             free(rules);</span>
<span class="lineNum">    1390 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1391 </span>            :         }
<span class="lineNum">    1392 </span><span class="lineCov">         12 :         fpst-&gt;nclass[0] = CoverageMinusClasses(glyphs,class,info);</span>
<span class="lineNum">    1393 </span><span class="lineCov">         12 :         free(glyphs); free(class); class = NULL;</span>
<span class="lineNum">    1394 </span>            : 
<span class="lineNum">    1395 </span><span class="lineCov">         12 :         cnt = 0;</span>
<span class="lineNum">    1396 </span><span class="lineCov">         54 :         for ( i=0; i&lt;rcnt; ++i ) for ( j=0; j&lt;rules[i].scnt; ++j ) {</span>
<span class="lineNum">    1397 </span><span class="lineCov">         42 :             rule[cnt].u.class.nclasses = rules[i].subrules[j].classindeces;</span>
<span class="lineNum">    1398 </span><span class="lineCov">         42 :             rule[cnt].u.class.ncnt = rules[i].subrules[j].ccnt;</span>
<span class="lineNum">    1399 </span><span class="lineCov">         42 :             rules[i].subrules[j].classindeces = NULL;</span>
<span class="lineNum">    1400 </span><span class="lineCov">         42 :             rule[cnt].lookup_cnt = rules[i].subrules[j].scnt;</span>
<span class="lineNum">    1401 </span><span class="lineCov">         42 :             rule[cnt].lookups = rules[i].subrules[j].sl;</span>
<span class="lineNum">    1402 </span><span class="lineCov">         42 :             rules[i].subrules[j].sl = NULL;</span>
<span class="lineNum">    1403 </span><span class="lineCov">         96 :             for ( k=0; k&lt;rule[cnt].lookup_cnt; ++k )</span>
<span class="lineNum">    1404 </span><span class="lineCov">         54 :                 ProcessSubLookups(ttf,info,gpos,alllooks,&amp;rule[cnt].lookups[k]);</span>
<span class="lineNum">    1405 </span><span class="lineCov">         42 :             ++cnt;</span>
<span class="lineNum">    1406 </span>            :         }
<span class="lineNum">    1407 </span>            :     }
<span class="lineNum">    1408 </span>            : 
<span class="lineNum">    1409 </span><span class="lineCov">         66 :     for ( i=0; i&lt;rcnt; ++i ) {</span>
<span class="lineNum">    1410 </span><span class="lineCov">         96 :         for ( j=0; j&lt;rules[i].scnt; ++j ) {</span>
<span class="lineNum">    1411 </span><span class="lineCov">         42 :             free(rules[i].subrules[j].classindeces);</span>
<span class="lineNum">    1412 </span><span class="lineCov">         42 :             free(rules[i].subrules[j].sl);</span>
<span class="lineNum">    1413 </span>            :         }
<span class="lineNum">    1414 </span><span class="lineCov">         54 :         free(rules[i].subrules);</span>
<span class="lineNum">    1415 </span>            :     }
<span class="lineNum">    1416 </span><span class="lineCov">         12 :     free(rules);</span>
<a name="1417"><span class="lineNum">    1417 </span>            : }</a>
<span class="lineNum">    1418 </span>            : 
<span class="lineNum">    1419 </span><span class="lineCov">          9 : static void g___ChainingSubTable2(FILE *ttf, int stoffset,</span>
<span class="lineNum">    1420 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, int justinuse,
<span class="lineNum">    1421 </span>            :         struct lookup *alllooks, int gpos) {
<span class="lineNum">    1422 </span>            :     int i, j, k, rcnt, cnt;
<span class="lineNum">    1423 </span>            :     uint16 coverage, offset;
<span class="lineNum">    1424 </span>            :     uint16 bclassoff, classoff, fclassoff;
<span class="lineNum">    1425 </span>            :     struct subrule {
<span class="lineNum">    1426 </span>            :         uint32 offset;
<span class="lineNum">    1427 </span>            :         int ccnt, bccnt, fccnt;
<span class="lineNum">    1428 </span>            :         int scnt;
<span class="lineNum">    1429 </span>            :         uint16 *classindeces, *bci, *fci;
<span class="lineNum">    1430 </span>            :         struct seqlookup *sl;
<span class="lineNum">    1431 </span>            :     };
<span class="lineNum">    1432 </span>            :     struct rule {
<span class="lineNum">    1433 </span>            :         uint32 offsets;
<span class="lineNum">    1434 </span>            :         int scnt;
<span class="lineNum">    1435 </span>            :         struct subrule *subrules;
<span class="lineNum">    1436 </span>            :     } *rules;
<span class="lineNum">    1437 </span>            :     FPST *fpst;
<span class="lineNum">    1438 </span>            :     struct fpst_rule *rule;
<span class="lineNum">    1439 </span>            :     uint16 *glyphs, *class;
<span class="lineNum">    1440 </span><span class="lineCov">          9 :     int warned2 = false;</span>
<span class="lineNum">    1441 </span>            : 
<span class="lineNum">    1442 </span><span class="lineCov">          9 :     coverage = getushort(ttf);</span>
<span class="lineNum">    1443 </span><span class="lineCov">          9 :     bclassoff = getushort(ttf);</span>
<span class="lineNum">    1444 </span><span class="lineCov">          9 :     classoff = getushort(ttf);</span>
<span class="lineNum">    1445 </span><span class="lineCov">          9 :     fclassoff = getushort(ttf);</span>
<span class="lineNum">    1446 </span><span class="lineCov">          9 :     rcnt = getushort(ttf);              /* class count *//* == max number of top level rules */</span>
<span class="lineNum">    1447 </span><span class="lineCov">          9 :     rules = calloc(rcnt,sizeof(struct rule));</span>
<span class="lineNum">    1448 </span><span class="lineCov">         34 :     for ( i=0; i&lt;rcnt; ++i ) {</span>
<span class="lineNum">    1449 </span><span class="lineCov">         25 :         offset = getushort(ttf);</span>
<span class="lineNum">    1450 </span><span class="lineCov">         25 :         rules[i].offsets = offset==0 ? 0 : offset+stoffset;</span>
<span class="lineNum">    1451 </span>            :     }
<span class="lineNum">    1452 </span><span class="lineCov">          9 :     cnt = 0;</span>
<span class="lineNum">    1453 </span><span class="lineCov">         34 :     for ( i=0; i&lt;rcnt; ++i ) if ( rules[i].offsets!=0 ) { /* some classes might be unused */</span>
<span class="lineNum">    1454 </span><span class="lineCov">         11 :         fseek(ttf,rules[i].offsets,SEEK_SET);</span>
<span class="lineNum">    1455 </span><span class="lineCov">         11 :         rules[i].scnt = getushort(ttf);</span>
<span class="lineNum">    1456 </span><span class="lineCov">         11 :         if ( rules[i].scnt&lt;0 ) {</span>
<span class="lineNum">    1457 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Bad count in context chaining sub-table.\n&quot;) );</span>
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :             free(rules);</span>
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1461 </span>            :         }
<span class="lineNum">    1462 </span><span class="lineCov">         11 :         cnt += rules[i].scnt;</span>
<span class="lineNum">    1463 </span><span class="lineCov">         11 :         rules[i].subrules = malloc(rules[i].scnt*sizeof(struct subrule));</span>
<span class="lineNum">    1464 </span><span class="lineCov">         25 :         for ( j=0; j&lt;rules[i].scnt; ++j )</span>
<span class="lineNum">    1465 </span><span class="lineCov">         14 :             rules[i].subrules[j].offset = getushort(ttf)+rules[i].offsets;</span>
<span class="lineNum">    1466 </span><span class="lineCov">         25 :         for ( j=0; j&lt;rules[i].scnt; ++j ) {</span>
<span class="lineNum">    1467 </span><span class="lineCov">         14 :             fseek(ttf,rules[i].subrules[j].offset,SEEK_SET);</span>
<span class="lineNum">    1468 </span><span class="lineCov">         14 :             rules[i].subrules[j].bccnt = getushort(ttf);</span>
<span class="lineNum">    1469 </span><span class="lineCov">         14 :             if ( rules[i].subrules[j].bccnt&lt;0 ) {</span>
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad class count in contextual chaining sub-table.\n&quot;) );</span>
<span class="lineNum">    1471 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :                 free(rules);</span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1474 </span>            :             }
<span class="lineNum">    1475 </span><span class="lineCov">         14 :             rules[i].subrules[j].bci = malloc(rules[i].subrules[j].bccnt*sizeof(uint16));</span>
<span class="lineNum">    1476 </span><span class="lineCov">         26 :             for ( k=0; k&lt;rules[i].subrules[j].bccnt; ++k )</span>
<span class="lineNum">    1477 </span><span class="lineCov">         12 :                 rules[i].subrules[j].bci[k] = getushort(ttf);</span>
<span class="lineNum">    1478 </span><span class="lineCov">         14 :             rules[i].subrules[j].ccnt = getushort(ttf);</span>
<span class="lineNum">    1479 </span><span class="lineCov">         14 :             if ( rules[i].subrules[j].ccnt&lt;0 ) {</span>
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad class count in contextual chaining sub-table.\n&quot;) );</span>
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    1482 </span><span class="lineNoCov">          0 :                 free(rules);</span>
<span class="lineNum">    1483 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1484 </span>            :             }
<span class="lineNum">    1485 </span><span class="lineCov">         14 :             rules[i].subrules[j].classindeces = malloc(rules[i].subrules[j].ccnt*sizeof(uint16));</span>
<span class="lineNum">    1486 </span><span class="lineCov">         14 :             rules[i].subrules[j].classindeces[0] = i;</span>
<span class="lineNum">    1487 </span><span class="lineCov">         14 :             for ( k=1; k&lt;rules[i].subrules[j].ccnt; ++k )</span>
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :                 rules[i].subrules[j].classindeces[k] = getushort(ttf);</span>
<span class="lineNum">    1489 </span><span class="lineCov">         14 :             rules[i].subrules[j].fccnt = getushort(ttf);</span>
<span class="lineNum">    1490 </span><span class="lineCov">         14 :             if ( rules[i].subrules[j].fccnt&lt;0 ) {</span>
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad class count in contextual chaining sub-table.\n&quot;) );</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :                 free(rules);</span>
<span class="lineNum">    1494 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1495 </span>            :             }
<span class="lineNum">    1496 </span><span class="lineCov">         14 :             rules[i].subrules[j].fci = malloc(rules[i].subrules[j].fccnt*sizeof(uint16));</span>
<span class="lineNum">    1497 </span><span class="lineCov">         16 :             for ( k=0; k&lt;rules[i].subrules[j].fccnt; ++k )</span>
<span class="lineNum">    1498 </span><span class="lineCov">          2 :                 rules[i].subrules[j].fci[k] = getushort(ttf);</span>
<span class="lineNum">    1499 </span><span class="lineCov">         14 :             rules[i].subrules[j].scnt = getushort(ttf);</span>
<span class="lineNum">    1500 </span><span class="lineCov">         14 :             if ( rules[i].subrules[j].scnt&lt;0 ) {</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad count in contextual chaining sub-table.\n&quot;) );</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :                 free(rules);</span>
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1505 </span>            :             }
<span class="lineNum">    1506 </span><span class="lineCov">         14 :             rules[i].subrules[j].sl = malloc(rules[i].subrules[j].scnt*sizeof(struct seqlookup));</span>
<span class="lineNum">    1507 </span><span class="lineCov">         28 :             for ( k=0; k&lt;rules[i].subrules[j].scnt; ++k ) {</span>
<span class="lineNum">    1508 </span><span class="lineCov">         14 :                 rules[i].subrules[j].sl[k].seq = getushort(ttf);</span>
<span class="lineNum">    1509 </span><span class="lineCov">         14 :                 if ( rules[i].subrules[j].sl[k].seq &gt;= rules[i].subrules[j].ccnt )</span>
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :                     if ( !warned2 ) {</span>
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 :                         LogError( _(&quot;Attempt to apply a lookup to a location out of the range of this contextual\n lookup seq=%d max=%d\n&quot;),</span>
<span class="lineNum">    1512 </span><span class="lineNoCov">          0 :                                 rules[i].subrules[j].sl[k].seq, rules[i].subrules[j].ccnt-1);</span>
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :                         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :                         warned2 = true;</span>
<span class="lineNum">    1515 </span>            :                     }
<span class="lineNum">    1516 </span><span class="lineCov">         14 :                 rules[i].subrules[j].sl[k].lookup = (void *) (intpt) getushort(ttf);</span>
<span class="lineNum">    1517 </span>            :             }
<span class="lineNum">    1518 </span>            :         }
<span class="lineNum">    1519 </span>            :     }
<span class="lineNum">    1520 </span>            : 
<span class="lineNum">    1521 </span><span class="lineCov">          9 :     if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    1522 </span>            :         /* Nothing to do. This lookup doesn't really reference any glyphs */
<span class="lineNum">    1523 </span>            :         /*  any lookups it invokes will be processed on their own */
<span class="lineNum">    1524 </span>            :     } else {
<span class="lineNum">    1525 </span><span class="lineCov">          9 :         fpst = chunkalloc(sizeof(FPST));</span>
<span class="lineNum">    1526 </span><span class="lineCov">          9 :         fpst-&gt;type = gpos ? pst_chainpos : pst_chainsub;</span>
<span class="lineNum">    1527 </span><span class="lineCov">          9 :         fpst-&gt;format = pst_class;</span>
<span class="lineNum">    1528 </span><span class="lineCov">          9 :         fpst-&gt;subtable = subtable;</span>
<span class="lineNum">    1529 </span><span class="lineCov">          9 :         subtable-&gt;fpst = fpst;</span>
<span class="lineNum">    1530 </span><span class="lineCov">          9 :         fpst-&gt;next = info-&gt;possub;</span>
<span class="lineNum">    1531 </span><span class="lineCov">          9 :         info-&gt;possub = fpst;</span>
<span class="lineNum">    1532 </span>            : 
<span class="lineNum">    1533 </span><span class="lineCov">          9 :         fpst-&gt;rules = rule = calloc(cnt,sizeof(struct fpst_rule));</span>
<span class="lineNum">    1534 </span><span class="lineCov">          9 :         fpst-&gt;rule_cnt = cnt;</span>
<span class="lineNum">    1535 </span>            : 
<span class="lineNum">    1536 </span><span class="lineCov">          9 :         class = getClassDefTable(ttf, stoffset+classoff, info);</span>
<span class="lineNum">    1537 </span><span class="lineCov">          9 :         fpst-&gt;nccnt = ClassFindCnt(class,info-&gt;glyph_cnt);</span>
<span class="lineNum">    1538 </span><span class="lineCov">          9 :         fpst-&gt;nclass = ClassToNames(info,fpst-&gt;nccnt,class,info-&gt;glyph_cnt);</span>
<span class="lineNum">    1539 </span><span class="lineCov">          9 :         fpst-&gt;nclassnames = calloc(fpst-&gt;nccnt,sizeof(char *));</span>
<span class="lineNum">    1540 </span>            : 
<span class="lineNum">    1541 </span>            :         /* Just in case they used the coverage table to redefine class 0 */
<span class="lineNum">    1542 </span><span class="lineCov">          9 :         glyphs = getCoverageTable(ttf,stoffset+coverage,info);</span>
<span class="lineNum">    1543 </span><span class="lineCov">          9 :         if ( glyphs==NULL ) {</span>
<span class="lineNum">    1544 </span>            : /* GT: This continues a multi-line error message, hence the leading space */
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :             LogError( _(&quot; Bad contextual chaining substitution table, ignored\n&quot;) );</span>
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :             free(rules);</span>
<span class="lineNum">    1547 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1548 </span>            :         }
<span class="lineNum">    1549 </span><span class="lineCov">          9 :         fpst-&gt;nclass[0] = CoverageMinusClasses(glyphs,class,info);</span>
<span class="lineNum">    1550 </span><span class="lineCov">          9 :         free(glyphs); free(class); class = NULL;</span>
<span class="lineNum">    1551 </span>            : 
<span class="lineNum">    1552 </span>            :         /* The docs don't mention this, but in mangal.ttf fclassoff==0 NULL */
<span class="lineNum">    1553 </span><span class="lineCov">          9 :         if ( bclassoff!=0 )</span>
<span class="lineNum">    1554 </span><span class="lineCov">          9 :             class = getClassDefTable(ttf, stoffset+bclassoff, info);</span>
<span class="lineNum">    1555 </span>            :         else
<span class="lineNum">    1556 </span><span class="lineNoCov">          0 :             class = calloc(info-&gt;glyph_cnt,sizeof(uint16));</span>
<span class="lineNum">    1557 </span><span class="lineCov">          9 :         fpst-&gt;bccnt = ClassFindCnt(class,info-&gt;glyph_cnt);</span>
<span class="lineNum">    1558 </span><span class="lineCov">          9 :         fpst-&gt;bclass = ClassToNames(info,fpst-&gt;bccnt,class,info-&gt;glyph_cnt);</span>
<span class="lineNum">    1559 </span><span class="lineCov">          9 :         fpst-&gt;bclassnames = calloc(fpst-&gt;bccnt,sizeof(char *));</span>
<span class="lineNum">    1560 </span><span class="lineCov">          9 :         free(class);</span>
<span class="lineNum">    1561 </span><span class="lineCov">          9 :         if ( fclassoff!=0 )</span>
<span class="lineNum">    1562 </span><span class="lineCov">          9 :             class = getClassDefTable(ttf, stoffset+fclassoff, info);</span>
<span class="lineNum">    1563 </span>            :         else
<span class="lineNum">    1564 </span><span class="lineNoCov">          0 :             class = calloc(info-&gt;glyph_cnt,sizeof(uint16));</span>
<span class="lineNum">    1565 </span><span class="lineCov">          9 :         fpst-&gt;fccnt = ClassFindCnt(class,info-&gt;glyph_cnt);</span>
<span class="lineNum">    1566 </span><span class="lineCov">          9 :         fpst-&gt;fclass = ClassToNames(info,fpst-&gt;fccnt,class,info-&gt;glyph_cnt);</span>
<span class="lineNum">    1567 </span><span class="lineCov">          9 :         fpst-&gt;fclassnames = calloc(fpst-&gt;fccnt,sizeof(char *));</span>
<span class="lineNum">    1568 </span><span class="lineCov">          9 :         free(class);</span>
<span class="lineNum">    1569 </span>            : 
<span class="lineNum">    1570 </span><span class="lineCov">          9 :         cnt = 0;</span>
<span class="lineNum">    1571 </span><span class="lineCov">         23 :         for ( i=0; i&lt;rcnt; ++i ) for ( j=0; j&lt;rules[i].scnt; ++j ) {</span>
<span class="lineNum">    1572 </span><span class="lineCov">         14 :             rule[cnt].u.class.nclasses = rules[i].subrules[j].classindeces;</span>
<span class="lineNum">    1573 </span><span class="lineCov">         14 :             rule[cnt].u.class.ncnt = rules[i].subrules[j].ccnt;</span>
<span class="lineNum">    1574 </span><span class="lineCov">         14 :             rules[i].subrules[j].classindeces = NULL;</span>
<span class="lineNum">    1575 </span><span class="lineCov">         14 :             rule[cnt].u.class.bclasses = rules[i].subrules[j].bci;</span>
<span class="lineNum">    1576 </span><span class="lineCov">         14 :             rule[cnt].u.class.bcnt = rules[i].subrules[j].bccnt;</span>
<span class="lineNum">    1577 </span><span class="lineCov">         14 :             rules[i].subrules[j].bci = NULL;</span>
<span class="lineNum">    1578 </span><span class="lineCov">         14 :             rule[cnt].u.class.fclasses = rules[i].subrules[j].fci;</span>
<span class="lineNum">    1579 </span><span class="lineCov">         14 :             rule[cnt].u.class.fcnt = rules[i].subrules[j].fccnt;</span>
<span class="lineNum">    1580 </span><span class="lineCov">         14 :             rules[i].subrules[j].fci = NULL;</span>
<span class="lineNum">    1581 </span><span class="lineCov">         14 :             rule[cnt].lookup_cnt = rules[i].subrules[j].scnt;</span>
<span class="lineNum">    1582 </span><span class="lineCov">         14 :             rule[cnt].lookups = rules[i].subrules[j].sl;</span>
<span class="lineNum">    1583 </span><span class="lineCov">         14 :             rules[i].subrules[j].sl = NULL;</span>
<span class="lineNum">    1584 </span><span class="lineCov">         28 :             for ( k=0; k&lt;rule[cnt].lookup_cnt; ++k )</span>
<span class="lineNum">    1585 </span><span class="lineCov">         14 :                 ProcessSubLookups(ttf,info,gpos,alllooks,&amp;rule[cnt].lookups[k]);</span>
<span class="lineNum">    1586 </span><span class="lineCov">         14 :             ++cnt;</span>
<span class="lineNum">    1587 </span>            :         }
<span class="lineNum">    1588 </span>            :     }
<span class="lineNum">    1589 </span>            : 
<span class="lineNum">    1590 </span><span class="lineCov">         34 :     for ( i=0; i&lt;rcnt; ++i ) {</span>
<span class="lineNum">    1591 </span><span class="lineCov">         39 :         for ( j=0; j&lt;rules[i].scnt; ++j ) {</span>
<span class="lineNum">    1592 </span><span class="lineCov">         14 :             free(rules[i].subrules[j].classindeces);</span>
<span class="lineNum">    1593 </span><span class="lineCov">         14 :             free(rules[i].subrules[j].sl);</span>
<span class="lineNum">    1594 </span>            :         }
<span class="lineNum">    1595 </span><span class="lineCov">         25 :         free(rules[i].subrules);</span>
<span class="lineNum">    1596 </span>            :     }
<span class="lineNum">    1597 </span><span class="lineCov">          9 :     free(rules);</span>
<a name="1598"><span class="lineNum">    1598 </span>            : }</a>
<span class="lineNum">    1599 </span>            : 
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 : static void g___ContextSubTable3(FILE *ttf, int stoffset,</span>
<span class="lineNum">    1601 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, int justinuse,
<span class="lineNum">    1602 </span>            :         struct lookup *alllooks, int gpos) {
<span class="lineNum">    1603 </span>            :     int i, k, scnt, gcnt;
<span class="lineNum">    1604 </span>            :     uint16 *coverage;
<span class="lineNum">    1605 </span>            :     struct seqlookup *sl;
<span class="lineNum">    1606 </span>            :     uint16 *glyphs;
<span class="lineNum">    1607 </span>            :     FPST *fpst;
<span class="lineNum">    1608 </span>            :     struct fpst_rule *rule;
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :     int warned2 = false;</span>
<span class="lineNum">    1610 </span>            : 
<span class="lineNum">    1611 </span><span class="lineNoCov">          0 :     gcnt = getushort(ttf);</span>
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :     scnt = getushort(ttf);</span>
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :     if ( feof(ttf) ) {</span>
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :         LogError( _(&quot;End of file in context chaining sub-table.\n&quot;) );</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1616 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1617 </span>            :     }
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :     coverage = malloc(gcnt*sizeof(uint16));</span>
<span class="lineNum">    1619 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;gcnt; ++i )</span>
<span class="lineNum">    1620 </span><span class="lineNoCov">          0 :         coverage[i] = getushort(ttf);</span>
<span class="lineNum">    1621 </span><span class="lineNoCov">          0 :     sl = malloc(scnt*sizeof(struct seqlookup));</span>
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 :     for ( k=0; k&lt;scnt; ++k ) {</span>
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :         sl[k].seq = getushort(ttf);</span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :         if ( sl[k].seq &gt;= gcnt &amp;&amp; !warned2 ) {</span>
<span class="lineNum">    1625 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Attempt to apply a lookup to a location out of the range of this contextual\n lookup seq=%d, max=%d\n&quot;),</span>
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :                     sl[k].seq, gcnt-1 );</span>
<span class="lineNum">    1627 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    1628 </span><span class="lineNoCov">          0 :             warned2 = true;</span>
<span class="lineNum">    1629 </span>            :         }
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :         sl[k].lookup = (void *) (intpt) getushort(ttf);</span>
<span class="lineNum">    1631 </span>            :     }
<span class="lineNum">    1632 </span>            : 
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :     if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    1634 </span>            :         /* Nothing to do. This lookup doesn't really reference any glyphs */
<span class="lineNum">    1635 </span>            :         /*  any lookups it invokes will be processed on their own */
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :         free(sl);</span>
<span class="lineNum">    1637 </span>            :     } else {
<span class="lineNum">    1638 </span><span class="lineNoCov">          0 :         fpst = chunkalloc(sizeof(FPST));</span>
<span class="lineNum">    1639 </span><span class="lineNoCov">          0 :         fpst-&gt;type = gpos ? pst_contextpos : pst_contextsub;</span>
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :         fpst-&gt;format = pst_coverage;</span>
<span class="lineNum">    1641 </span><span class="lineNoCov">          0 :         fpst-&gt;subtable = subtable;</span>
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 :         subtable-&gt;fpst = fpst;</span>
<span class="lineNum">    1643 </span><span class="lineNoCov">          0 :         fpst-&gt;next = info-&gt;possub;</span>
<span class="lineNum">    1644 </span><span class="lineNoCov">          0 :         info-&gt;possub = fpst;</span>
<span class="lineNum">    1645 </span>            : 
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :         fpst-&gt;rules = rule = calloc(1,sizeof(struct fpst_rule));</span>
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :         fpst-&gt;rule_cnt = 1;</span>
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :         rule-&gt;u.coverage.ncnt = gcnt;</span>
<span class="lineNum">    1649 </span><span class="lineNoCov">          0 :         rule-&gt;u.coverage.ncovers = malloc(gcnt*sizeof(char *));</span>
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;gcnt; ++i ) {</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :             glyphs =  getCoverageTable(ttf,stoffset+coverage[i],info);</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :             rule-&gt;u.coverage.ncovers[i] = GlyphsToNames(info,glyphs,true);</span>
<span class="lineNum">    1653 </span><span class="lineNoCov">          0 :             free(glyphs);</span>
<span class="lineNum">    1654 </span>            :         }
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :         rule-&gt;lookup_cnt = scnt;</span>
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 :         rule-&gt;lookups = sl;</span>
<span class="lineNum">    1657 </span><span class="lineNoCov">          0 :         for ( k=0; k&lt;scnt; ++k )</span>
<span class="lineNum">    1658 </span><span class="lineNoCov">          0 :             ProcessSubLookups(ttf,info,gpos,alllooks,&amp;sl[k]);</span>
<span class="lineNum">    1659 </span>            :     }
<span class="lineNum">    1660 </span>            : 
<span class="lineNum">    1661 </span><span class="lineNoCov">          0 :     free(coverage);</span>
<a name="1662"><span class="lineNum">    1662 </span>            : }</a>
<span class="lineNum">    1663 </span>            : 
<span class="lineNum">    1664 </span><span class="lineCov">          7 : static void g___ChainingSubTable3(FILE *ttf, int stoffset,</span>
<span class="lineNum">    1665 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, int justinuse,
<span class="lineNum">    1666 </span>            :         struct lookup *alllooks, int gpos) {
<span class="lineNum">    1667 </span>            :     int i, k, scnt, gcnt, bcnt, fcnt;
<span class="lineNum">    1668 </span>            :     uint16 *coverage, *bcoverage, *fcoverage;
<span class="lineNum">    1669 </span>            :     struct seqlookup *sl;
<span class="lineNum">    1670 </span>            :     uint16 *glyphs;
<span class="lineNum">    1671 </span>            :     FPST *fpst;
<span class="lineNum">    1672 </span>            :     struct fpst_rule *rule;
<span class="lineNum">    1673 </span><span class="lineCov">          7 :     int warned2 = false;</span>
<span class="lineNum">    1674 </span>            : 
<span class="lineNum">    1675 </span><span class="lineCov">          7 :     bcnt = getushort(ttf);</span>
<span class="lineNum">    1676 </span><span class="lineCov">          7 :     if ( feof(ttf)) {</span>
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :         LogError( _(&quot;End of file in context chaining subtable.\n&quot;) );</span>
<span class="lineNum">    1678 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1680 </span>            :     }
<span class="lineNum">    1681 </span><span class="lineCov">          7 :     bcoverage = malloc(bcnt*sizeof(uint16));</span>
<span class="lineNum">    1682 </span><span class="lineCov">          8 :     for ( i=0; i&lt;bcnt; ++i )</span>
<span class="lineNum">    1683 </span><span class="lineCov">          1 :         bcoverage[i] = getushort(ttf);</span>
<span class="lineNum">    1684 </span><span class="lineCov">          7 :     gcnt = getushort(ttf);</span>
<span class="lineNum">    1685 </span><span class="lineCov">          7 :     if ( feof(ttf)) {</span>
<span class="lineNum">    1686 </span><span class="lineNoCov">          0 :         LogError( _(&quot;End of file in context chaining subtable.\n&quot;) );</span>
<span class="lineNum">    1687 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1688 </span><span class="lineNoCov">          0 :         free(bcoverage);</span>
<span class="lineNum">    1689 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1690 </span>            :     }
<span class="lineNum">    1691 </span><span class="lineCov">          7 :     coverage = malloc(gcnt*sizeof(uint16));</span>
<span class="lineNum">    1692 </span><span class="lineCov">         14 :     for ( i=0; i&lt;gcnt; ++i )</span>
<span class="lineNum">    1693 </span><span class="lineCov">          7 :         coverage[i] = getushort(ttf);</span>
<span class="lineNum">    1694 </span><span class="lineCov">          7 :     fcnt = getushort(ttf);</span>
<span class="lineNum">    1695 </span><span class="lineCov">          7 :     if ( feof(ttf)) {</span>
<span class="lineNum">    1696 </span><span class="lineNoCov">          0 :         LogError( _(&quot;End of file in context chaining subtable.\n&quot;) );</span>
<span class="lineNum">    1697 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :         free(bcoverage);</span>
<span class="lineNum">    1699 </span><span class="lineNoCov">          0 :         free(coverage);</span>
<span class="lineNum">    1700 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1701 </span>            :     }
<span class="lineNum">    1702 </span><span class="lineCov">          7 :     fcoverage = malloc(fcnt*sizeof(uint16));</span>
<span class="lineNum">    1703 </span><span class="lineCov">         13 :     for ( i=0; i&lt;fcnt; ++i )</span>
<span class="lineNum">    1704 </span><span class="lineCov">          6 :         fcoverage[i] = getushort(ttf);</span>
<span class="lineNum">    1705 </span><span class="lineCov">          7 :     scnt = getushort(ttf);</span>
<span class="lineNum">    1706 </span><span class="lineCov">          7 :     if ( feof(ttf)) {</span>
<span class="lineNum">    1707 </span><span class="lineNoCov">          0 :         LogError( _(&quot;End of file in context chaining subtable.\n&quot;) );</span>
<span class="lineNum">    1708 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1709 </span><span class="lineNoCov">          0 :         free(fcoverage);</span>
<span class="lineNum">    1710 </span><span class="lineNoCov">          0 :         free(bcoverage);</span>
<span class="lineNum">    1711 </span><span class="lineNoCov">          0 :         free(coverage);</span>
<span class="lineNum">    1712 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1713 </span>            :     }
<span class="lineNum">    1714 </span><span class="lineCov">          7 :     sl = malloc(scnt*sizeof(struct seqlookup));</span>
<span class="lineNum">    1715 </span><span class="lineCov">         14 :     for ( k=0; k&lt;scnt; ++k ) {</span>
<span class="lineNum">    1716 </span><span class="lineCov">          7 :         sl[k].seq = getushort(ttf);</span>
<span class="lineNum">    1717 </span><span class="lineCov">          7 :         if ( sl[k].seq &gt;= gcnt &amp;&amp; !warned2 ) {</span>
<span class="lineNum">    1718 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Attempt to apply a lookup to a location out of the range of this contextual\n lookup seq=%d, max=%d\n&quot;),</span>
<span class="lineNum">    1719 </span><span class="lineNoCov">          0 :                     sl[k].seq, gcnt-1 );</span>
<span class="lineNum">    1720 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    1721 </span><span class="lineNoCov">          0 :             warned2 = true;</span>
<span class="lineNum">    1722 </span>            :         }
<span class="lineNum">    1723 </span><span class="lineCov">          7 :         sl[k].lookup = (void *) (intpt) getushort(ttf);</span>
<span class="lineNum">    1724 </span>            :     }
<span class="lineNum">    1725 </span>            : 
<span class="lineNum">    1726 </span><span class="lineCov">          7 :     if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    1727 </span>            :         /* Nothing to do. This lookup doesn't really reference any glyphs */
<span class="lineNum">    1728 </span>            :         /*  any lookups it invokes will be processed on their own */
<span class="lineNum">    1729 </span><span class="lineCov">          3 :         free(sl);</span>
<span class="lineNum">    1730 </span>            :     } else {
<span class="lineNum">    1731 </span><span class="lineCov">          4 :         fpst = chunkalloc(sizeof(FPST));</span>
<span class="lineNum">    1732 </span><span class="lineCov">          4 :         fpst-&gt;type = gpos ? pst_chainpos : pst_chainsub;</span>
<span class="lineNum">    1733 </span><span class="lineCov">          4 :         fpst-&gt;format = pst_coverage;</span>
<span class="lineNum">    1734 </span><span class="lineCov">          4 :         fpst-&gt;subtable = subtable;</span>
<span class="lineNum">    1735 </span><span class="lineCov">          4 :         subtable-&gt;fpst = fpst;</span>
<span class="lineNum">    1736 </span><span class="lineCov">          4 :         fpst-&gt;next = info-&gt;possub;</span>
<span class="lineNum">    1737 </span><span class="lineCov">          4 :         info-&gt;possub = fpst;</span>
<span class="lineNum">    1738 </span>            : 
<span class="lineNum">    1739 </span><span class="lineCov">          4 :         fpst-&gt;rules = rule = calloc(1,sizeof(struct fpst_rule));</span>
<span class="lineNum">    1740 </span><span class="lineCov">          4 :         fpst-&gt;rule_cnt = 1;</span>
<span class="lineNum">    1741 </span>            : 
<span class="lineNum">    1742 </span><span class="lineCov">          4 :         rule-&gt;u.coverage.bcnt = bcnt;</span>
<span class="lineNum">    1743 </span><span class="lineCov">          4 :         rule-&gt;u.coverage.bcovers = malloc(bcnt*sizeof(char *));</span>
<span class="lineNum">    1744 </span><span class="lineCov">          5 :         for ( i=0; i&lt;bcnt; ++i ) {</span>
<span class="lineNum">    1745 </span><span class="lineCov">          1 :             glyphs =  getCoverageTable(ttf,stoffset+bcoverage[i],info);</span>
<span class="lineNum">    1746 </span><span class="lineCov">          1 :             rule-&gt;u.coverage.bcovers[i] = GlyphsToNames(info,glyphs,true);</span>
<span class="lineNum">    1747 </span><span class="lineCov">          1 :             free(glyphs);</span>
<span class="lineNum">    1748 </span>            :         }
<span class="lineNum">    1749 </span>            : 
<span class="lineNum">    1750 </span><span class="lineCov">          4 :         rule-&gt;u.coverage.ncnt = gcnt;</span>
<span class="lineNum">    1751 </span><span class="lineCov">          4 :         rule-&gt;u.coverage.ncovers = malloc(gcnt*sizeof(char *));</span>
<span class="lineNum">    1752 </span><span class="lineCov">          8 :         for ( i=0; i&lt;gcnt; ++i ) {</span>
<span class="lineNum">    1753 </span><span class="lineCov">          4 :             glyphs =  getCoverageTable(ttf,stoffset+coverage[i],info);</span>
<span class="lineNum">    1754 </span><span class="lineCov">          4 :             rule-&gt;u.coverage.ncovers[i] = GlyphsToNames(info,glyphs,true);</span>
<span class="lineNum">    1755 </span><span class="lineCov">          4 :             free(glyphs);</span>
<span class="lineNum">    1756 </span>            :         }
<span class="lineNum">    1757 </span>            : 
<span class="lineNum">    1758 </span><span class="lineCov">          4 :         rule-&gt;u.coverage.fcnt = fcnt;</span>
<span class="lineNum">    1759 </span><span class="lineCov">          4 :         rule-&gt;u.coverage.fcovers = malloc(fcnt*sizeof(char *));</span>
<span class="lineNum">    1760 </span><span class="lineCov">          7 :         for ( i=0; i&lt;fcnt; ++i ) {</span>
<span class="lineNum">    1761 </span><span class="lineCov">          3 :             glyphs =  getCoverageTable(ttf,stoffset+fcoverage[i],info);</span>
<span class="lineNum">    1762 </span><span class="lineCov">          3 :             rule-&gt;u.coverage.fcovers[i] = GlyphsToNames(info,glyphs,true);</span>
<span class="lineNum">    1763 </span><span class="lineCov">          3 :             free(glyphs);</span>
<span class="lineNum">    1764 </span>            :         }
<span class="lineNum">    1765 </span>            : 
<span class="lineNum">    1766 </span><span class="lineCov">          4 :         rule-&gt;lookup_cnt = scnt;</span>
<span class="lineNum">    1767 </span><span class="lineCov">          4 :         rule-&gt;lookups = sl;</span>
<span class="lineNum">    1768 </span><span class="lineCov">          8 :         for ( k=0; k&lt;scnt; ++k )</span>
<span class="lineNum">    1769 </span><span class="lineCov">          4 :             ProcessSubLookups(ttf,info,gpos,alllooks,&amp;sl[k]);</span>
<span class="lineNum">    1770 </span>            :     }
<span class="lineNum">    1771 </span>            : 
<span class="lineNum">    1772 </span><span class="lineCov">          7 :     free(bcoverage);</span>
<span class="lineNum">    1773 </span><span class="lineCov">          7 :     free(coverage);</span>
<span class="lineNum">    1774 </span><span class="lineCov">          7 :     free(fcoverage);</span>
<a name="1775"><span class="lineNum">    1775 </span>            : }</a>
<span class="lineNum">    1776 </span>            : 
<span class="lineNum">    1777 </span><span class="lineNoCov">          0 : static void gposContextSubTable(FILE *ttf, int stoffset,</span>
<span class="lineNum">    1778 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, 
<span class="lineNum">    1779 </span>            :         struct lookup *alllooks) {
<span class="lineNum">    1780 </span><span class="lineNoCov">          0 :     switch( getushort(ttf)) {</span>
<span class="lineNum">    1781 </span>            :       case 1:
<span class="lineNum">    1782 </span><span class="lineNoCov">          0 :         g___ContextSubTable1(ttf,stoffset,info,l,subtable,git_normal,alllooks,true);</span>
<span class="lineNum">    1783 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1784 </span>            :       case 2:
<span class="lineNum">    1785 </span><span class="lineNoCov">          0 :         g___ContextSubTable2(ttf,stoffset,info,l,subtable,git_normal,alllooks,true);</span>
<span class="lineNum">    1786 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1787 </span>            :       case 3:
<span class="lineNum">    1788 </span><span class="lineNoCov">          0 :         g___ContextSubTable3(ttf,stoffset,info,l,subtable,git_normal,alllooks,true);</span>
<span class="lineNum">    1789 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1790 </span>            :     }
<a name="1791"><span class="lineNum">    1791 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1792 </span>            : 
<span class="lineNum">    1793 </span><span class="lineNoCov">          0 : static void gposChainingSubTable(FILE *ttf, int stoffset,</span>
<span class="lineNum">    1794 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, 
<span class="lineNum">    1795 </span>            :         struct lookup *alllooks) {
<span class="lineNum">    1796 </span><span class="lineNoCov">          0 :     switch( getushort(ttf)) {</span>
<span class="lineNum">    1797 </span>            :       case 1:
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 :         g___ChainingSubTable1(ttf,stoffset,info,l,subtable,git_normal,alllooks,true);</span>
<span class="lineNum">    1799 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1800 </span>            :       case 2:
<span class="lineNum">    1801 </span><span class="lineNoCov">          0 :         g___ChainingSubTable2(ttf,stoffset,info,l,subtable,git_normal,alllooks,true);</span>
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1803 </span>            :       case 3:
<span class="lineNum">    1804 </span><span class="lineNoCov">          0 :         g___ChainingSubTable3(ttf,stoffset,info,l,subtable,git_normal,alllooks,true);</span>
<span class="lineNum">    1805 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1806 </span>            :     }
<span class="lineNum">    1807 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1808 </span>            : 
<span class="lineNum">    1809 </span>            : static struct { uint32 tag; char *str; } tagstr[] = {
<span class="lineNum">    1810 </span>            :     { CHR('v','r','t','2'), &quot;vert&quot; },
<span class="lineNum">    1811 </span>            :     { CHR('s','m','c','p'), &quot;sc&quot; },
<span class="lineNum">    1812 </span>            :     { CHR('s','m','c','p'), &quot;small&quot; },
<span class="lineNum">    1813 </span>            :     { CHR('o','n','u','m'), &quot;oldstyle&quot; },
<span class="lineNum">    1814 </span>            :     { CHR('s','u','p','s'), &quot;superior&quot; },
<span class="lineNum">    1815 </span>            :     { CHR('s','u','b','s'), &quot;inferior&quot; },
<span class="lineNum">    1816 </span>            :     { CHR('s','w','s','h'), &quot;swash&quot; },
<span class="lineNum">    1817 </span>            :     { 0, NULL }
<a name="1818"><span class="lineNum">    1818 </span>            : };</a>
<span class="lineNum">    1819 </span>            : 
<span class="lineNum">    1820 </span><span class="lineCov">         77 : static void gsubSimpleSubTable(FILE *ttf, int stoffset, struct ttfinfo *info,</span>
<span class="lineNum">    1821 </span>            :         struct lookup *l, struct lookup_subtable *subtable, int justinuse) {
<span class="lineNum">    1822 </span>            :     int coverage, cnt, i, j, which;
<span class="lineNum">    1823 </span>            :     uint16 format;
<span class="lineNum">    1824 </span><span class="lineCov">         77 :     uint16 *glyphs, *glyph2s=NULL;</span>
<span class="lineNum">    1825 </span><span class="lineCov">         77 :     int delta=0;</span>
<span class="lineNum">    1826 </span>            : 
<span class="lineNum">    1827 </span><span class="lineCov">         77 :     format=getushort(ttf);</span>
<span class="lineNum">    1828 </span><span class="lineCov">         77 :     if ( format!=1 &amp;&amp; format!=2 )       /* Unknown subtable format */</span>
<span class="lineNum">    1829 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1830 </span><span class="lineCov">         77 :     coverage = getushort(ttf);</span>
<span class="lineNum">    1831 </span><span class="lineCov">         77 :     if ( format==1 ) {</span>
<span class="lineNum">    1832 </span><span class="lineCov">         14 :         delta = getushort(ttf);</span>
<span class="lineNum">    1833 </span>            :     } else {
<span class="lineNum">    1834 </span><span class="lineCov">         63 :         cnt = getushort(ttf);</span>
<span class="lineNum">    1835 </span><span class="lineCov">         63 :         glyph2s = malloc(cnt*sizeof(uint16));</span>
<span class="lineNum">    1836 </span><span class="lineCov">        646 :         for ( i=0; i&lt;cnt; ++i )</span>
<span class="lineNum">    1837 </span><span class="lineCov">        583 :             glyph2s[i] = getushort(ttf);</span>
<span class="lineNum">    1838 </span>            :             /* in range check comes later */
<span class="lineNum">    1839 </span>            :     }
<span class="lineNum">    1840 </span><span class="lineCov">         77 :     glyphs = getCoverageTable(ttf,stoffset+coverage,info);</span>
<span class="lineNum">    1841 </span><span class="lineCov">         77 :     if ( glyphs==NULL ) {</span>
<span class="lineNum">    1842 </span><span class="lineNoCov">          0 :         free(glyph2s);</span>
<span class="lineNum">    1843 </span><span class="lineNoCov">          0 :         LogError( _(&quot; Bad simple substitution table, ignored\n&quot;) );</span>
<span class="lineNum">    1844 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1845 </span>            :     }
<span class="lineNum">    1846 </span><span class="lineCov">         77 :     if ( justinuse==git_findnames ) {</span>
<span class="lineNum">    1847 </span>            :         FeatureScriptLangList *fl;
<span class="lineNum">    1848 </span><span class="lineCov">          8 :         fl = l-&gt;otlookup-&gt;features;</span>
<span class="lineNum">    1849 </span>            :         /* Unnamed glyphs get a name built of the base name and the feature tag */
<span class="lineNum">    1850 </span>            :         /*  assuming this lookup is tagged with a feature... */
<span class="lineNum">    1851 </span><span class="lineCov">          8 :         if ( fl!=NULL )</span>
<span class="lineNum">    1852 </span><span class="lineCov">         30 :         for ( i=0; glyphs[i]!=0xffff; ++i ) if ( glyphs[i]&lt;info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    1853 </span><span class="lineCov">         27 :             if ( info-&gt;chars[glyphs[i]]-&gt;name!=NULL ) {</span>
<span class="lineNum">    1854 </span><span class="lineCov">         27 :                 which = format==1 ? (uint16) (glyphs[i]+delta) : glyph2s[i];</span>
<span class="lineNum">    1855 </span><span class="lineCov">         54 :                 if ( which&lt;info-&gt;glyph_cnt &amp;&amp; which&gt;=0 &amp;&amp; info-&gt;chars[which]!=NULL &amp;&amp;</span>
<span class="lineNum">    1856 </span><span class="lineCov">         27 :                         info-&gt;chars[which]-&gt;name==NULL ) {</span>
<span class="lineNum">    1857 </span><span class="lineCov">         27 :                     char *basename = info-&gt;chars[glyphs[i]]-&gt;name;</span>
<span class="lineNum">    1858 </span>            :                     char *str;
<span class="lineNum">    1859 </span><span class="lineCov">         27 :                     char tag[5], *pt=tag;</span>
<span class="lineNum">    1860 </span><span class="lineCov">         27 :                     for ( j=0; tagstr[j].tag!=0 &amp;&amp; tagstr[j].tag!=fl-&gt;featuretag; ++j );</span>
<span class="lineNum">    1861 </span><span class="lineCov">         27 :                     if ( tagstr[j].tag!=0 )</span>
<span class="lineNum">    1862 </span><span class="lineNoCov">          0 :                         pt = tagstr[j].str;</span>
<span class="lineNum">    1863 </span>            :                     else {
<span class="lineNum">    1864 </span><span class="lineCov">         27 :                         tag[0] = fl-&gt;featuretag&gt;&gt;24;</span>
<span class="lineNum">    1865 </span><span class="lineCov">         27 :                         if ( (tag[1] = (fl-&gt;featuretag&gt;&gt;16)&amp;0xff)==' ' ) tag[1] = '\0';</span>
<span class="lineNum">    1866 </span><span class="lineCov">         27 :                         if ( (tag[2] = (fl-&gt;featuretag&gt;&gt;8)&amp;0xff)==' ' ) tag[2] = '\0';</span>
<span class="lineNum">    1867 </span><span class="lineCov">         27 :                         if ( (tag[3] = (fl-&gt;featuretag)&amp;0xff)==' ' ) tag[3] = '\0';</span>
<span class="lineNum">    1868 </span><span class="lineCov">         27 :                         tag[4] = '\0';</span>
<span class="lineNum">    1869 </span><span class="lineCov">         27 :                         pt = tag;</span>
<span class="lineNum">    1870 </span>            :                     }
<span class="lineNum">    1871 </span><span class="lineCov">         27 :                     str = malloc(strlen(basename)+strlen(pt)+2);</span>
<span class="lineNum">    1872 </span><span class="lineCov">         27 :                     sprintf(str,&quot;%s.%s&quot;, basename, pt );</span>
<span class="lineNum">    1873 </span><span class="lineCov">         27 :                     info-&gt;chars[which]-&gt;name = str;</span>
<span class="lineNum">    1874 </span>            :                 }
<span class="lineNum">    1875 </span>            :             }
<span class="lineNum">    1876 </span>            :         }
<span class="lineNum">    1877 </span><span class="lineCov">         69 :     } else if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    1878 </span><span class="lineCov">         42 :         for ( i=0; glyphs[i]!=0xffff; ++i ) if ( glyphs[i]&lt;info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    1879 </span><span class="lineCov">         36 :             info-&gt;inuse[glyphs[i]]= true;</span>
<span class="lineNum">    1880 </span><span class="lineCov">         36 :             which = format==1 ? (uint16) (glyphs[i]+delta) : glyph2s[i];</span>
<span class="lineNum">    1881 </span><span class="lineCov">         36 :             info-&gt;inuse[which]= true;</span>
<span class="lineNum">    1882 </span>            :         }
<span class="lineNum">    1883 </span><span class="lineCov">         63 :     } else if ( justinuse==git_normal ) {</span>
<span class="lineNum">    1884 </span><span class="lineCov">        655 :         for ( i=0; glyphs[i]!=0xffff; ++i ) if ( glyphs[i]&lt;info-&gt;glyph_cnt &amp;&amp; info-&gt;chars[glyphs[i]]!=NULL ) {</span>
<span class="lineNum">    1885 </span><span class="lineCov">        592 :             which = format==1 ? (uint16) (glyphs[i]+delta) : glyph2s[i];</span>
<span class="lineNum">    1886 </span><span class="lineCov">        592 :             if ( which&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    1887 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad substitution glyph: GID %d not less than %d\n&quot;),</span>
<span class="lineNum">    1888 </span>            :                         which, info-&gt;glyph_cnt);
<span class="lineNum">    1889 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    1890 </span><span class="lineNoCov">          0 :                 which = 0;</span>
<span class="lineNum">    1891 </span>            :             }
<span class="lineNum">    1892 </span><span class="lineCov">        592 :             if ( info-&gt;chars[which]!=NULL &amp;&amp; info-&gt;chars[glyphs[i]]!=NULL ) {</span>
<span class="lineNum">    1893 </span>            :                         /* Might be in a ttc file */
<span class="lineNum">    1894 </span><span class="lineCov">        592 :                 PST *pos = chunkalloc(sizeof(PST));</span>
<span class="lineNum">    1895 </span><span class="lineCov">        592 :                 pos-&gt;type = pst_substitution;</span>
<span class="lineNum">    1896 </span><span class="lineCov">        592 :                 pos-&gt;subtable = subtable;</span>
<span class="lineNum">    1897 </span><span class="lineCov">        592 :                 pos-&gt;next = info-&gt;chars[glyphs[i]]-&gt;possub;</span>
<span class="lineNum">    1898 </span><span class="lineCov">        592 :                 info-&gt;chars[glyphs[i]]-&gt;possub = pos;</span>
<span class="lineNum">    1899 </span><span class="lineCov">        592 :                 pos-&gt;u.subs.variant = copy(info-&gt;chars[which]-&gt;name);</span>
<span class="lineNum">    1900 </span>            :             }
<span class="lineNum">    1901 </span>            :         }
<span class="lineNum">    1902 </span>            :     }
<span class="lineNum">    1903 </span><span class="lineCov">         77 :     subtable-&gt;per_glyph_pst_or_kern = true;</span>
<span class="lineNum">    1904 </span><span class="lineCov">         77 :     free(glyph2s);</span>
<span class="lineNum">    1905 </span><span class="lineCov">         77 :     free(glyphs);</span>
<span class="lineNum">    1906 </span>            : }
<a name="1907"><span class="lineNum">    1907 </span>            : </a>
<span class="lineNum">    1908 </span>            : /* Multiple and alternate substitution lookups have the same format */
<span class="lineNum">    1909 </span><span class="lineCov">          9 : static void gsubMultipleSubTable(FILE *ttf, int stoffset, struct ttfinfo *info,</span>
<span class="lineNum">    1910 </span>            :         struct lookup *l, struct lookup_subtable *subtable, int justinuse) {
<span class="lineNum">    1911 </span>            :     int coverage, cnt, i, j, len, max;
<span class="lineNum">    1912 </span>            :     uint16 format;
<span class="lineNum">    1913 </span>            :     uint16 *offsets;
<span class="lineNum">    1914 </span>            :     uint16 *glyphs, *glyph2s;
<span class="lineNum">    1915 </span>            :     char *pt;
<span class="lineNum">    1916 </span>            :     int bad;
<span class="lineNum">    1917 </span><span class="lineCov">          9 :     int badcnt = 0;</span>
<span class="lineNum">    1918 </span>            : 
<span class="lineNum">    1919 </span><span class="lineCov">          9 :     if ( justinuse==git_findnames )</span>
<span class="lineNum">    1920 </span><span class="lineCov">          3 : return;</span>
<span class="lineNum">    1921 </span>            : 
<span class="lineNum">    1922 </span><span class="lineCov">          6 :     format=getushort(ttf);</span>
<span class="lineNum">    1923 </span><span class="lineCov">          6 :     if ( format!=1 )    /* Unknown subtable format */</span>
<span class="lineNum">    1924 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1925 </span><span class="lineCov">          6 :     coverage = getushort(ttf);</span>
<span class="lineNum">    1926 </span><span class="lineCov">          6 :     cnt = getushort(ttf);</span>
<span class="lineNum">    1927 </span><span class="lineCov">          6 :     if ( feof(ttf)) {</span>
<span class="lineNum">    1928 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Unexpected end of file in GSUB sub-table.\n&quot;));</span>
<span class="lineNum">    1929 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1930 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1931 </span>            :     }
<span class="lineNum">    1932 </span><span class="lineCov">          6 :     offsets = malloc(cnt*sizeof(uint16));</span>
<span class="lineNum">    1933 </span><span class="lineCov">         18 :     for ( i=0; i&lt;cnt; ++i )</span>
<span class="lineNum">    1934 </span><span class="lineCov">         12 :         offsets[i] = getushort(ttf);</span>
<span class="lineNum">    1935 </span><span class="lineCov">          6 :     glyphs = getCoverageTable(ttf,stoffset+coverage,info);</span>
<span class="lineNum">    1936 </span><span class="lineCov">          6 :     if ( glyphs==NULL ) {</span>
<span class="lineNum">    1937 </span><span class="lineNoCov">          0 :         free(offsets);</span>
<span class="lineNum">    1938 </span><span class="lineNoCov">          0 :         LogError( _(&quot; Bad multiple substitution table, ignored\n&quot;) );</span>
<span class="lineNum">    1939 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    1940 </span>            :     }
<span class="lineNum">    1941 </span><span class="lineCov">          6 :     for ( i=0; glyphs[i]!=0xffff; ++i );</span>
<span class="lineNum">    1942 </span><span class="lineCov">          6 :     if ( i!=cnt ) {</span>
<span class="lineNum">    1943 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Coverage table specifies a different number of glyphs than the sub-table expects.\n&quot; ));</span>
<span class="lineNum">    1944 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1945 </span><span class="lineNoCov">          0 :         if ( cnt&lt;i )</span>
<span class="lineNum">    1946 </span><span class="lineNoCov">          0 :             glyphs[cnt] = 0xffff;</span>
<span class="lineNum">    1947 </span>            :         else
<span class="lineNum">    1948 </span><span class="lineNoCov">          0 :             cnt = i;</span>
<span class="lineNum">    1949 </span>            :     }
<span class="lineNum">    1950 </span><span class="lineCov">          6 :     max = 20;</span>
<span class="lineNum">    1951 </span><span class="lineCov">          6 :     glyph2s = malloc(max*sizeof(uint16));</span>
<span class="lineNum">    1952 </span><span class="lineCov">         18 :     for ( i=0; glyphs[i]!=0xffff; ++i ) {</span>
<span class="lineNum">    1953 </span>            :                 PST *alt;
<span class="lineNum">    1954 </span><span class="lineCov">         12 :                 fseek(ttf,stoffset+offsets[i],SEEK_SET);</span>
<span class="lineNum">    1955 </span><span class="lineCov">         12 :                 cnt = getushort(ttf);</span>
<span class="lineNum">    1956 </span><span class="lineCov">         12 :                 if ( feof(ttf)) {</span>
<span class="lineNum">    1957 </span><span class="lineNoCov">          0 :                         LogError( _(&quot;Unexpected end of file in GSUB sub-table.\n&quot;));</span>
<span class="lineNum">    1958 </span><span class="lineNoCov">          0 :                         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1959 </span><span class="lineNoCov">          0 :                         free(offsets);</span>
<span class="lineNum">    1960 </span><span class="lineNoCov">          0 :                         free(glyphs);</span>
<span class="lineNum">    1961 </span><span class="lineNoCov">          0 :                         free(glyph2s);</span>
<span class="lineNum">    1962 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    1963 </span>            :                 }
<span class="lineNum">    1964 </span><span class="lineCov">         12 :                 if ( cnt&gt;max ) {</span>
<span class="lineNum">    1965 </span><span class="lineNoCov">          0 :                         max = cnt+30;</span>
<span class="lineNum">    1966 </span><span class="lineNoCov">          0 :                         glyph2s = realloc(glyph2s,max*sizeof(uint16));</span>
<span class="lineNum">    1967 </span>            :                 }
<span class="lineNum">    1968 </span><span class="lineCov">         12 :                 len = 0; bad = false;</span>
<span class="lineNum">    1969 </span><span class="lineCov">         36 :                 for ( j=0; j&lt;cnt; ++j ) {</span>
<span class="lineNum">    1970 </span><span class="lineCov">         24 :                         glyph2s[j] = getushort(ttf);</span>
<span class="lineNum">    1971 </span><span class="lineCov">         24 :                         if ( feof(ttf)) {</span>
<span class="lineNum">    1972 </span><span class="lineNoCov">          0 :                                 LogError( _(&quot;Unexpected end of file in GSUB sub-table.\n&quot; ));</span>
<span class="lineNum">    1973 </span><span class="lineNoCov">          0 :                                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    1974 </span><span class="lineNoCov">          0 :                                 free(offsets);</span>
<span class="lineNum">    1975 </span><span class="lineNoCov">          0 :                                 free(glyphs);</span>
<span class="lineNum">    1976 </span><span class="lineNoCov">          0 :                                 free(glyph2s);</span>
<span class="lineNum">    1977 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1978 </span>            :                         }
<span class="lineNum">    1979 </span><span class="lineCov">         24 :                         if ( glyph2s[j]&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    1980 </span><span class="lineNoCov">          0 :                         if ( !justinuse )</span>
<span class="lineNum">    1981 </span><span class="lineNoCov">          0 :                                 LogError( _(&quot;Bad Multiple/Alternate substitution glyph. GID %d not less than %d\n&quot;),</span>
<span class="lineNum">    1982 </span><span class="lineNoCov">          0 :                                         glyph2s[j], info-&gt;glyph_cnt );</span>
<span class="lineNum">    1983 </span><span class="lineNoCov">          0 :                         info-&gt;bad_ot = true;</span>
<span class="lineNum">    1984 </span><span class="lineNoCov">          0 :                         if ( ++badcnt&gt;20 ) {</span>
<span class="lineNum">    1985 </span><span class="lineNoCov">          0 :                                 free(offsets);</span>
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :                                 free(glyphs);</span>
<span class="lineNum">    1987 </span><span class="lineNoCov">          0 :                                 free(glyph2s);</span>
<span class="lineNum">    1988 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1989 </span>            :                         }
<span class="lineNum">    1990 </span><span class="lineNoCov">          0 :                         glyph2s[j] = 0;</span>
<span class="lineNum">    1991 </span>            :                         }
<span class="lineNum">    1992 </span><span class="lineCov">         24 :                         if ( justinuse==git_justinuse )</span>
<span class="lineNum">    1993 </span>            :                         /* Do Nothing */;
<span class="lineNum">    1994 </span><span class="lineCov">         12 :                         else if ( info-&gt;chars[glyph2s[j]]==NULL )</span>
<span class="lineNum">    1995 </span><span class="lineNoCov">          0 :                         bad = true;</span>
<span class="lineNum">    1996 </span>            :                         else
<span class="lineNum">    1997 </span><span class="lineCov">         12 :                         len += strlen( info-&gt;chars[glyph2s[j]]-&gt;name) +1;</span>
<span class="lineNum">    1998 </span>            :                 }
<span class="lineNum">    1999 </span><span class="lineCov">         12 :                 if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    2000 </span><span class="lineCov">          6 :                         info-&gt;inuse[glyphs[i]] = 1;</span>
<span class="lineNum">    2001 </span><span class="lineCov">         18 :                         for ( j=0; j&lt;cnt; ++j )</span>
<span class="lineNum">    2002 </span><span class="lineCov">         12 :                         info-&gt;inuse[glyph2s[j]] = 1;</span>
<span class="lineNum">    2003 </span><span class="lineCov">          6 :                 } else if ( info-&gt;chars[glyphs[i]]!=NULL &amp;&amp; !bad ) {</span>
<span class="lineNum">    2004 </span><span class="lineCov">          6 :                         alt = chunkalloc(sizeof(PST));</span>
<span class="lineNum">    2005 </span><span class="lineCov">          6 :                         alt-&gt;type = l-&gt;otlookup-&gt;lookup_type==gsub_multiple?pst_multiple:pst_alternate;</span>
<span class="lineNum">    2006 </span><span class="lineCov">          6 :                         alt-&gt;subtable = subtable;</span>
<span class="lineNum">    2007 </span><span class="lineCov">          6 :                         alt-&gt;next = info-&gt;chars[glyphs[i]]-&gt;possub;</span>
<span class="lineNum">    2008 </span><span class="lineCov">          6 :                         info-&gt;chars[glyphs[i]]-&gt;possub = alt;</span>
<span class="lineNum">    2009 </span><span class="lineCov">          6 :                         pt = alt-&gt;u.subs.variant = malloc(len+1);</span>
<span class="lineNum">    2010 </span><span class="lineCov">          6 :                         *pt = '\0';</span>
<span class="lineNum">    2011 </span><span class="lineCov">         18 :                         for ( j=0; j&lt;cnt; ++j ) {</span>
<span class="lineNum">    2012 </span><span class="lineCov">         12 :                         strcat(pt,info-&gt;chars[glyph2s[j]]-&gt;name);</span>
<span class="lineNum">    2013 </span><span class="lineCov">         12 :                         strcat(pt,&quot; &quot;);</span>
<span class="lineNum">    2014 </span>            :                         }
<span class="lineNum">    2015 </span><span class="lineCov">          6 :                         if ( *pt!='\0' &amp;&amp; pt[strlen(pt)-1]==' ' )</span>
<span class="lineNum">    2016 </span><span class="lineCov">          6 :                         pt[strlen(pt)-1] = '\0';</span>
<span class="lineNum">    2017 </span>            :                 }
<span class="lineNum">    2018 </span><span class="lineCov">         12 :                 if (glyphs[i] &gt; info-&gt;glyph_cnt) {</span>
<span class="lineNum">    2019 </span><span class="lineNoCov">          0 :                         fprintf(stderr, &quot;This glyph is out of bounds.\n&quot;);</span>
<span class="lineNum">    2020 </span><span class="lineCov">         12 :                 } else if (info-&gt;chars[glyphs[i]] == NULL || info-&gt;chars[glyphs[i]]-&gt;possub == NULL) {</span>
<span class="lineNum">    2021 </span><span class="lineCov">          6 :                         if (justinuse != git_justinuse) fprintf( stderr , &quot;This glyph isn't loaded yet.\n&quot; );</span>
<span class="lineNum">    2022 </span><span class="lineCov">          6 :                 } else if (info-&gt;chars[glyphs[i]]-&gt;possub-&gt;u.subs.variant == NULL) {</span>
<span class="lineNum">    2023 </span><span class="lineNoCov">          0 :                         fprintf( stderr , &quot;info-&gt;chars[glyphs[%d]]-&gt;possub-&gt;u.subs.variant is null. glyphs[%d] = %d. info-&gt;chars[%d]-&gt;name = \&quot;%s\&quot;.\n&quot; , i , i , glyphs[i] , glyphs[i] , info-&gt;chars[glyphs[i]]-&gt;name ) ;</span>
<span class="lineNum">    2024 </span>            :                 }
<span class="lineNum">    2025 </span>            :     }
<span class="lineNum">    2026 </span><span class="lineCov">          6 :     subtable-&gt;per_glyph_pst_or_kern = true;</span>
<span class="lineNum">    2027 </span><span class="lineCov">          6 :     free(glyphs);</span>
<span class="lineNum">    2028 </span><span class="lineCov">          6 :     free(glyph2s);</span>
<span class="lineNum">    2029 </span><span class="lineCov">          6 :     free(offsets);</span>
<a name="2030"><span class="lineNum">    2030 </span>            : }</a>
<span class="lineNum">    2031 </span>            : 
<span class="lineNum">    2032 </span><span class="lineCov">         92 : static void gsubLigatureSubTable(FILE *ttf, int stoffset,</span>
<span class="lineNum">    2033 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, int justinuse) {
<span class="lineNum">    2034 </span>            :     int coverage, cnt, i, j, k, lig_cnt, cc, len;
<span class="lineNum">    2035 </span>            :     uint16 *ls_offsets, *lig_offsets;
<span class="lineNum">    2036 </span>            :     uint16 *glyphs, *lig_glyphs, lig;
<span class="lineNum">    2037 </span>            :     char *pt;
<span class="lineNum">    2038 </span>            :     PST *liga;
<span class="lineNum">    2039 </span>            : 
<span class="lineNum">    2040 </span><span class="lineCov">         92 :     /* Format = */ getushort(ttf);</span>
<span class="lineNum">    2041 </span><span class="lineCov">         92 :     coverage = getushort(ttf);</span>
<span class="lineNum">    2042 </span><span class="lineCov">         92 :     cnt = getushort(ttf);</span>
<span class="lineNum">    2043 </span><span class="lineCov">         92 :     if ( feof(ttf)) {</span>
<span class="lineNum">    2044 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Unexpected end of file in GSUB ligature sub-table.\n&quot; ));</span>
<span class="lineNum">    2045 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2046 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2047 </span>            :     }
<span class="lineNum">    2048 </span><span class="lineCov">         92 :     ls_offsets = malloc(cnt*sizeof(uint16));</span>
<span class="lineNum">    2049 </span><span class="lineCov">       1088 :     for ( i=0; i&lt;cnt; ++i )</span>
<span class="lineNum">    2050 </span><span class="lineCov">        996 :         ls_offsets[i]=getushort(ttf);</span>
<span class="lineNum">    2051 </span><span class="lineCov">         92 :     glyphs = getCoverageTable(ttf,stoffset+coverage,info);</span>
<span class="lineNum">    2052 </span><span class="lineCov">         92 :     if ( glyphs==NULL ) {</span>
<span class="lineNum">    2053 </span><span class="lineNoCov">          0 :         LogError( _(&quot; Bad ligature table, ignored\n&quot;) );</span>
<span class="lineNum">    2054 </span><span class="lineNoCov">          0 :         free(ls_offsets);</span>
<span class="lineNum">    2055 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2056 </span>            :     }
<span class="lineNum">    2057 </span><span class="lineCov">       1088 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    2058 </span><span class="lineCov">        996 :         fseek(ttf,stoffset+ls_offsets[i],SEEK_SET);</span>
<span class="lineNum">    2059 </span><span class="lineCov">        996 :         lig_cnt = getushort(ttf);</span>
<span class="lineNum">    2060 </span><span class="lineCov">        996 :         if ( feof(ttf)) {</span>
<span class="lineNum">    2061 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Unexpected end of file in GSUB ligature sub-table.\n&quot; ));</span>
<span class="lineNum">    2062 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    2063 </span><span class="lineNoCov">          0 :             free(ls_offsets);</span>
<span class="lineNum">    2064 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2065 </span>            :         }
<span class="lineNum">    2066 </span><span class="lineCov">        996 :         lig_offsets = malloc(lig_cnt*sizeof(uint16));</span>
<span class="lineNum">    2067 </span><span class="lineCov">       5675 :         for ( j=0; j&lt;lig_cnt; ++j )</span>
<span class="lineNum">    2068 </span><span class="lineCov">       4679 :             lig_offsets[j] = getushort(ttf);</span>
<span class="lineNum">    2069 </span><span class="lineCov">        996 :         if ( feof(ttf)) {</span>
<span class="lineNum">    2070 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Unexpected end of file in GSUB ligature sub-table.\n&quot; ));</span>
<span class="lineNum">    2071 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    2072 </span><span class="lineNoCov">          0 :             free(lig_offsets);</span>
<span class="lineNum">    2073 </span><span class="lineNoCov">          0 :             free(ls_offsets);</span>
<span class="lineNum">    2074 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2075 </span>            :         }
<span class="lineNum">    2076 </span><span class="lineCov">       5675 :         for ( j=0; j&lt;lig_cnt; ++j ) {</span>
<span class="lineNum">    2077 </span><span class="lineCov">       4679 :             fseek(ttf,stoffset+ls_offsets[i]+lig_offsets[j],SEEK_SET);</span>
<span class="lineNum">    2078 </span><span class="lineCov">       4679 :             lig = getushort(ttf);</span>
<span class="lineNum">    2079 </span><span class="lineCov">       4679 :             if ( lig&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    2080 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad ligature glyph. GID %d not less than %d\n&quot;),</span>
<span class="lineNum">    2081 </span>            :                         lig, info-&gt;glyph_cnt );
<span class="lineNum">    2082 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    2083 </span><span class="lineNoCov">          0 :                 lig = 0;</span>
<span class="lineNum">    2084 </span>            :             }
<span class="lineNum">    2085 </span><span class="lineCov">       4679 :             cc = getushort(ttf);</span>
<span class="lineNum">    2086 </span><span class="lineCov">       4679 :             if ( cc&lt;0 || cc&gt;100 ) {</span>
<span class="lineNum">    2087 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Unlikely count of ligature components (%d), I suspect this ligature sub-\n table is garbage, I'm giving up on it.\n&quot;), cc );</span>
<span class="lineNum">    2088 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    2089 </span><span class="lineNoCov">          0 :                 free(glyphs); free(lig_offsets); free(ls_offsets);</span>
<span class="lineNum">    2090 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2091 </span>            :             }
<span class="lineNum">    2092 </span><span class="lineCov">       4679 :             lig_glyphs = malloc(cc*sizeof(uint16));</span>
<span class="lineNum">    2093 </span><span class="lineCov">       4679 :             lig_glyphs[0] = glyphs[i];</span>
<span class="lineNum">    2094 </span><span class="lineCov">      12038 :             for ( k=1; k&lt;cc; ++k ) {</span>
<span class="lineNum">    2095 </span><span class="lineCov">       7359 :                 lig_glyphs[k] = getushort(ttf);</span>
<span class="lineNum">    2096 </span><span class="lineCov">       7359 :                 if ( lig_glyphs[k]&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    2097 </span><span class="lineNoCov">          0 :                     if ( justinuse==git_normal )</span>
<span class="lineNum">    2098 </span><span class="lineNoCov">          0 :                         LogError( _(&quot;Bad ligature component glyph. GID %d not less than %d (in ligature %d)\n&quot;),</span>
<span class="lineNum">    2099 </span><span class="lineNoCov">          0 :                                 lig_glyphs[k], info-&gt;glyph_cnt, lig );</span>
<span class="lineNum">    2100 </span><span class="lineNoCov">          0 :                     info-&gt;bad_ot = true;</span>
<span class="lineNum">    2101 </span><span class="lineNoCov">          0 :                     lig_glyphs[k] = 0;</span>
<span class="lineNum">    2102 </span>            :                 }
<span class="lineNum">    2103 </span>            :             }
<span class="lineNum">    2104 </span><span class="lineCov">       4679 :             if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    2105 </span><span class="lineCov">        528 :                 info-&gt;inuse[lig] = 1;</span>
<span class="lineNum">    2106 </span><span class="lineCov">       2142 :                 for ( k=0; k&lt;cc; ++k )</span>
<span class="lineNum">    2107 </span><span class="lineCov">       1614 :                     info-&gt;inuse[lig_glyphs[k]] = 1;</span>
<span class="lineNum">    2108 </span><span class="lineCov">       4151 :             } else if ( justinuse==git_findnames ) {</span>
<span class="lineNum">    2109 </span><span class="lineCov">        650 :                 FeatureScriptLangList *fl = l-&gt;otlookup-&gt;features;</span>
<span class="lineNum">    2110 </span>            :                 /* If our ligature glyph has no name (and its components do) */
<span class="lineNum">    2111 </span>            :                 /*  give it a name by concatenating components with underscores */
<span class="lineNum">    2112 </span>            :                 /*  between them, and appending the tag */
<span class="lineNum">    2113 </span><span class="lineCov">        650 :                 if ( fl!=NULL &amp;&amp; info-&gt;chars[lig]!=NULL &amp;&amp; info-&gt;chars[lig]-&gt;name==NULL ) {</span>
<span class="lineNum">    2114 </span><span class="lineCov">        516 :                     int len=0;</span>
<span class="lineNum">    2115 </span><span class="lineCov">       2100 :                     for ( k=0; k&lt;cc; ++k ) {</span>
<span class="lineNum">    2116 </span><span class="lineCov">       1584 :                         if ( info-&gt;chars[lig_glyphs[k]]==NULL || info-&gt;chars[lig_glyphs[k]]-&gt;name==NULL )</span>
<span class="lineNum">    2117 </span>            :                     break;
<span class="lineNum">    2118 </span><span class="lineCov">       1584 :                         len += strlen(info-&gt;chars[lig_glyphs[k]]-&gt;name)+1;</span>
<span class="lineNum">    2119 </span>            :                     }
<span class="lineNum">    2120 </span><span class="lineCov">        516 :                     if ( k==cc ) {</span>
<span class="lineNum">    2121 </span><span class="lineCov">        516 :                         char *str = malloc(len+6), *pt;</span>
<span class="lineNum">    2122 </span>            :                         char tag[5];
<span class="lineNum">    2123 </span><span class="lineCov">        516 :                         tag[0] = fl-&gt;featuretag&gt;&gt;24;</span>
<span class="lineNum">    2124 </span><span class="lineCov">        516 :                         if ( (tag[1] = (fl-&gt;featuretag&gt;&gt;16)&amp;0xff)==' ' ) tag[1] = '\0';</span>
<span class="lineNum">    2125 </span><span class="lineCov">        516 :                         if ( (tag[2] = (fl-&gt;featuretag&gt;&gt;8)&amp;0xff)==' ' ) tag[2] = '\0';</span>
<span class="lineNum">    2126 </span><span class="lineCov">        516 :                         if ( (tag[3] = (fl-&gt;featuretag)&amp;0xff)==' ' ) tag[3] = '\0';</span>
<span class="lineNum">    2127 </span><span class="lineCov">        516 :                         tag[4] = '\0';</span>
<span class="lineNum">    2128 </span><span class="lineCov">        516 :                         *str='\0';</span>
<span class="lineNum">    2129 </span><span class="lineCov">       2100 :                         for ( k=0; k&lt;cc; ++k ) {</span>
<span class="lineNum">    2130 </span><span class="lineCov">       1584 :                             strcat(str,info-&gt;chars[lig_glyphs[k]]-&gt;name);</span>
<span class="lineNum">    2131 </span><span class="lineCov">       1584 :                             strcat(str,&quot;_&quot;);</span>
<span class="lineNum">    2132 </span>            :                         }
<span class="lineNum">    2133 </span><span class="lineCov">        516 :                         pt = str+strlen(str);</span>
<span class="lineNum">    2134 </span><span class="lineCov">        516 :                         pt[-1] = '.';</span>
<span class="lineNum">    2135 </span><span class="lineCov">        516 :                         strcpy(pt,tag);</span>
<span class="lineNum">    2136 </span><span class="lineCov">        516 :                         info-&gt;chars[lig]-&gt;name = str;</span>
<span class="lineNum">    2137 </span>            :                     }
<span class="lineNum">    2138 </span>            :                 }
<span class="lineNum">    2139 </span><span class="lineCov">       3501 :             } else if ( info-&gt;chars[lig]!=NULL ) {</span>
<span class="lineNum">    2140 </span><span class="lineCov">       3501 :                 int err=false;</span>
<span class="lineNum">    2141 </span><span class="lineCov">      12060 :                 for ( k=len=0; k&lt;cc; ++k )</span>
<span class="lineNum">    2142 </span><span class="lineCov">      17118 :                     if ( lig_glyphs[k]&lt;info-&gt;glyph_cnt &amp;&amp;</span>
<span class="lineNum">    2143 </span><span class="lineCov">       8559 :                             info-&gt;chars[lig_glyphs[k]]!=NULL )</span>
<span class="lineNum">    2144 </span><span class="lineCov">       8559 :                         len += strlen(info-&gt;chars[lig_glyphs[k]]-&gt;name)+1;</span>
<span class="lineNum">    2145 </span>            :                     else
<span class="lineNum">    2146 </span><span class="lineNoCov">          0 :                         err = true;</span>
<span class="lineNum">    2147 </span><span class="lineCov">       3501 :                 if ( !err ) {</span>
<span class="lineNum">    2148 </span><span class="lineCov">       3501 :                     liga = chunkalloc(sizeof(PST));</span>
<span class="lineNum">    2149 </span><span class="lineCov">       3501 :                     liga-&gt;type = pst_ligature;</span>
<span class="lineNum">    2150 </span><span class="lineCov">       3501 :                     liga-&gt;subtable = subtable;</span>
<span class="lineNum">    2151 </span><span class="lineCov">       3501 :                     liga-&gt;next = info-&gt;chars[lig]-&gt;possub;</span>
<span class="lineNum">    2152 </span><span class="lineCov">       3501 :                     info-&gt;chars[lig]-&gt;possub = liga;</span>
<span class="lineNum">    2153 </span><span class="lineCov">       3501 :                     liga-&gt;u.lig.lig = info-&gt;chars[lig];</span>
<span class="lineNum">    2154 </span><span class="lineCov">       3501 :                     liga-&gt;u.lig.components = pt = malloc(len);</span>
<span class="lineNum">    2155 </span><span class="lineCov">      12060 :                     for ( k=0; k&lt;cc; ++k ) {</span>
<span class="lineNum">    2156 </span><span class="lineCov">      17118 :                         if ( lig_glyphs[k]&lt;info-&gt;glyph_cnt &amp;&amp;</span>
<span class="lineNum">    2157 </span><span class="lineCov">       8559 :                                 info-&gt;chars[lig_glyphs[k]]!=NULL ) {</span>
<span class="lineNum">    2158 </span><span class="lineCov">       8559 :                             strcpy(pt,info-&gt;chars[lig_glyphs[k]]-&gt;name);</span>
<span class="lineNum">    2159 </span><span class="lineCov">       8559 :                             pt += strlen(pt);</span>
<span class="lineNum">    2160 </span><span class="lineCov">       8559 :                             *pt++ = ' ';</span>
<span class="lineNum">    2161 </span>            :                         }
<span class="lineNum">    2162 </span>            :                     }
<span class="lineNum">    2163 </span><span class="lineCov">       3501 :                     pt[-1] = '\0';</span>
<span class="lineNum">    2164 </span>            :                 }
<span class="lineNum">    2165 </span>            :             }
<span class="lineNum">    2166 </span><span class="lineCov">       4679 :             free(lig_glyphs);</span>
<span class="lineNum">    2167 </span>            :         }
<span class="lineNum">    2168 </span><span class="lineCov">        996 :         free(lig_offsets);</span>
<span class="lineNum">    2169 </span>            :     }
<span class="lineNum">    2170 </span><span class="lineCov">         92 :     subtable-&gt;per_glyph_pst_or_kern = true;</span>
<span class="lineNum">    2171 </span><span class="lineCov">         92 :     free(ls_offsets); free(glyphs);</span>
<a name="2172"><span class="lineNum">    2172 </span>            : }</a>
<span class="lineNum">    2173 </span>            : 
<span class="lineNum">    2174 </span><span class="lineCov">         12 : static void gsubContextSubTable(FILE *ttf, int stoffset,</span>
<span class="lineNum">    2175 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, int justinuse,
<span class="lineNum">    2176 </span>            :         struct lookup *alllooks) {
<span class="lineNum">    2177 </span><span class="lineCov">         12 :     if ( justinuse==git_findnames )</span>
<span class="lineNum">    2178 </span><span class="lineCov">         12 : return;         /* Don't give names to these guys, they might not be unique */</span>
<span class="lineNum">    2179 </span>            :         /* ie. because these are context based there is not a one to one */
<span class="lineNum">    2180 </span>            :         /*  mapping between input glyphs and output glyphs. One input glyph */
<span class="lineNum">    2181 </span>            :         /*  may go to several output glyphs (depending on context) and so */
<span class="lineNum">    2182 </span>            :         /*  &lt;input-glyph-name&gt;&quot;.&quot;&lt;tag-name&gt; would be used for several glyphs */
<span class="lineNum">    2183 </span><span class="lineCov">         12 :     switch( getushort(ttf)) {</span>
<span class="lineNum">    2184 </span>            :       case 1:
<span class="lineNum">    2185 </span><span class="lineNoCov">          0 :         g___ContextSubTable1(ttf,stoffset,info,l,subtable,justinuse,alllooks,false);</span>
<span class="lineNum">    2186 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2187 </span>            :       case 2:
<span class="lineNum">    2188 </span><span class="lineCov">         12 :         g___ContextSubTable2(ttf,stoffset,info,l,subtable,justinuse,alllooks,false);</span>
<span class="lineNum">    2189 </span><span class="lineCov">         12 :       break;</span>
<span class="lineNum">    2190 </span>            :       case 3:
<span class="lineNum">    2191 </span><span class="lineNoCov">          0 :         g___ContextSubTable3(ttf,stoffset,info,l,subtable,justinuse,alllooks,false);</span>
<span class="lineNum">    2192 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2193 </span>            :     }
<a name="2194"><span class="lineNum">    2194 </span>            : }</a>
<span class="lineNum">    2195 </span>            : 
<span class="lineNum">    2196 </span><span class="lineCov">         20 : static void gsubChainingSubTable(FILE *ttf, int stoffset,</span>
<span class="lineNum">    2197 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, int justinuse,
<span class="lineNum">    2198 </span>            :         struct lookup *alllooks) {
<span class="lineNum">    2199 </span><span class="lineCov">         20 :     if ( justinuse==git_findnames )</span>
<span class="lineNum">    2200 </span><span class="lineCov">         24 : return;         /* Don't give names to these guys, the names might not be unique */</span>
<span class="lineNum">    2201 </span><span class="lineCov">         16 :     switch( getushort(ttf)) {</span>
<span class="lineNum">    2202 </span>            :       case 1:
<span class="lineNum">    2203 </span><span class="lineNoCov">          0 :         g___ChainingSubTable1(ttf,stoffset,info,l,subtable,justinuse,alllooks,false);</span>
<span class="lineNum">    2204 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2205 </span>            :       case 2:
<span class="lineNum">    2206 </span><span class="lineCov">          9 :         g___ChainingSubTable2(ttf,stoffset,info,l,subtable,justinuse,alllooks,false);</span>
<span class="lineNum">    2207 </span><span class="lineCov">          9 :       break;</span>
<span class="lineNum">    2208 </span>            :       case 3:
<span class="lineNum">    2209 </span><span class="lineCov">          7 :         g___ChainingSubTable3(ttf,stoffset,info,l,subtable,justinuse,alllooks,false);</span>
<span class="lineNum">    2210 </span><span class="lineCov">          7 :       break;</span>
<span class="lineNum">    2211 </span>            :     }
<a name="2212"><span class="lineNum">    2212 </span>            : }</a>
<span class="lineNum">    2213 </span>            : 
<span class="lineNum">    2214 </span><span class="lineNoCov">          0 : static void gsubReverseChainSubTable(FILE *ttf, int stoffset,</span>
<span class="lineNum">    2215 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, int justinuse) {
<span class="lineNum">    2216 </span>            :     int scnt, bcnt, fcnt, i;
<span class="lineNum">    2217 </span>            :     uint16 coverage, *bcoverage, *fcoverage, *sglyphs, *glyphs;
<span class="lineNum">    2218 </span>            :     FPST *fpst;
<span class="lineNum">    2219 </span>            :     struct fpst_rule *rule;
<span class="lineNum">    2220 </span>            : 
<span class="lineNum">    2221 </span><span class="lineNoCov">          0 :     if ( justinuse==git_findnames )</span>
<span class="lineNum">    2222 </span><span class="lineNoCov">          0 : return;         /* Don't give names to these guys, they might not be unique */</span>
<span class="lineNum">    2223 </span><span class="lineNoCov">          0 :     if ( getushort(ttf)!=1 )</span>
<span class="lineNum">    2224 </span><span class="lineNoCov">          0 : return;         /* Don't understand this format type */</span>
<span class="lineNum">    2225 </span>            : 
<span class="lineNum">    2226 </span><span class="lineNoCov">          0 :     coverage = getushort(ttf);</span>
<span class="lineNum">    2227 </span><span class="lineNoCov">          0 :     bcnt = getushort(ttf);</span>
<span class="lineNum">    2228 </span><span class="lineNoCov">          0 :     bcoverage = malloc(bcnt*sizeof(uint16));</span>
<span class="lineNum">    2229 </span><span class="lineNoCov">          0 :     for ( i = 0 ; i&lt;bcnt; ++i )</span>
<span class="lineNum">    2230 </span><span class="lineNoCov">          0 :         bcoverage[i] = getushort(ttf);</span>
<span class="lineNum">    2231 </span><span class="lineNoCov">          0 :     fcnt = getushort(ttf);</span>
<span class="lineNum">    2232 </span><span class="lineNoCov">          0 :     fcoverage = malloc(fcnt*sizeof(uint16));</span>
<span class="lineNum">    2233 </span><span class="lineNoCov">          0 :     for ( i = 0 ; i&lt;fcnt; ++i )</span>
<span class="lineNum">    2234 </span><span class="lineNoCov">          0 :         fcoverage[i] = getushort(ttf);</span>
<span class="lineNum">    2235 </span><span class="lineNoCov">          0 :     scnt = getushort(ttf);</span>
<span class="lineNum">    2236 </span><span class="lineNoCov">          0 :     sglyphs = malloc((scnt+1)*sizeof(uint16));</span>
<span class="lineNum">    2237 </span><span class="lineNoCov">          0 :     for ( i = 0 ; i&lt;scnt; ++i )</span>
<span class="lineNum">    2238 </span><span class="lineNoCov">          0 :         if (( sglyphs[i] = getushort(ttf))&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    2239 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Bad reverse contextual chaining substitution glyph: %d is not less than %d\n&quot;),</span>
<span class="lineNum">    2240 </span><span class="lineNoCov">          0 :                     sglyphs[i], info-&gt;glyph_cnt );</span>
<span class="lineNum">    2241 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    2242 </span><span class="lineNoCov">          0 :             sglyphs[i] = 0;</span>
<span class="lineNum">    2243 </span>            :         }
<span class="lineNum">    2244 </span><span class="lineNoCov">          0 :     sglyphs[i] = 0xffff;</span>
<span class="lineNum">    2245 </span>            : 
<span class="lineNum">    2246 </span><span class="lineNoCov">          0 :     if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    2247 </span><span class="lineNoCov">          0 :         for ( i = 0 ; i&lt;scnt; ++i )</span>
<span class="lineNum">    2248 </span><span class="lineNoCov">          0 :             info-&gt;inuse[sglyphs[i]] = 1;</span>
<span class="lineNum">    2249 </span>            :     } else {
<span class="lineNum">    2250 </span><span class="lineNoCov">          0 :         fpst = chunkalloc(sizeof(FPST));</span>
<span class="lineNum">    2251 </span><span class="lineNoCov">          0 :         fpst-&gt;type = pst_reversesub;</span>
<span class="lineNum">    2252 </span><span class="lineNoCov">          0 :         fpst-&gt;format = pst_reversecoverage;</span>
<span class="lineNum">    2253 </span><span class="lineNoCov">          0 :         fpst-&gt;subtable = subtable;</span>
<span class="lineNum">    2254 </span><span class="lineNoCov">          0 :         fpst-&gt;next = info-&gt;possub;</span>
<span class="lineNum">    2255 </span><span class="lineNoCov">          0 :         info-&gt;possub = fpst;</span>
<span class="lineNum">    2256 </span><span class="lineNoCov">          0 :         subtable-&gt;fpst = fpst;</span>
<span class="lineNum">    2257 </span>            : 
<span class="lineNum">    2258 </span><span class="lineNoCov">          0 :         fpst-&gt;rules = rule = calloc(1,sizeof(struct fpst_rule));</span>
<span class="lineNum">    2259 </span><span class="lineNoCov">          0 :         fpst-&gt;rule_cnt = 1;</span>
<span class="lineNum">    2260 </span>            : 
<span class="lineNum">    2261 </span><span class="lineNoCov">          0 :         rule-&gt;u.rcoverage.always1 = 1;</span>
<span class="lineNum">    2262 </span><span class="lineNoCov">          0 :         rule-&gt;u.rcoverage.bcnt = bcnt;</span>
<span class="lineNum">    2263 </span><span class="lineNoCov">          0 :         rule-&gt;u.rcoverage.fcnt = fcnt;</span>
<span class="lineNum">    2264 </span><span class="lineNoCov">          0 :         rule-&gt;u.rcoverage.ncovers = malloc(sizeof(char *));</span>
<span class="lineNum">    2265 </span><span class="lineNoCov">          0 :         rule-&gt;u.rcoverage.bcovers = malloc(bcnt*sizeof(char *));</span>
<span class="lineNum">    2266 </span><span class="lineNoCov">          0 :         rule-&gt;u.rcoverage.fcovers = malloc(fcnt*sizeof(char *));</span>
<span class="lineNum">    2267 </span><span class="lineNoCov">          0 :         rule-&gt;u.rcoverage.replacements = GlyphsToNames(info,sglyphs,false);</span>
<span class="lineNum">    2268 </span><span class="lineNoCov">          0 :         glyphs = getCoverageTable(ttf,stoffset+coverage,info);</span>
<span class="lineNum">    2269 </span><span class="lineNoCov">          0 :         rule-&gt;u.rcoverage.ncovers[0] = GlyphsToNames(info,glyphs,false);</span>
<span class="lineNum">    2270 </span><span class="lineNoCov">          0 :         free(glyphs);</span>
<span class="lineNum">    2271 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;bcnt; ++i ) {</span>
<span class="lineNum">    2272 </span><span class="lineNoCov">          0 :             glyphs = getCoverageTable(ttf,stoffset+bcoverage[i],info);</span>
<span class="lineNum">    2273 </span><span class="lineNoCov">          0 :             rule-&gt;u.rcoverage.bcovers[i] = GlyphsToNames(info,glyphs,true);</span>
<span class="lineNum">    2274 </span><span class="lineNoCov">          0 :             free(glyphs);</span>
<span class="lineNum">    2275 </span>            :         }
<span class="lineNum">    2276 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;fcnt; ++i ) {</span>
<span class="lineNum">    2277 </span><span class="lineNoCov">          0 :             glyphs = getCoverageTable(ttf,stoffset+fcoverage[i],info);</span>
<span class="lineNum">    2278 </span><span class="lineNoCov">          0 :             rule-&gt;u.rcoverage.fcovers[i] = GlyphsToNames(info,glyphs,true);</span>
<span class="lineNum">    2279 </span><span class="lineNoCov">          0 :             free(glyphs);</span>
<span class="lineNum">    2280 </span>            :         }
<span class="lineNum">    2281 </span><span class="lineNoCov">          0 :         rule-&gt;lookup_cnt = 0;                /* substitution lookups needed for reverse chaining */</span>
<span class="lineNum">    2282 </span>            :     }
<span class="lineNum">    2283 </span><span class="lineNoCov">          0 :     free(sglyphs);</span>
<span class="lineNum">    2284 </span><span class="lineNoCov">          0 :     free(fcoverage);</span>
<span class="lineNum">    2285 </span><span class="lineNoCov">          0 :     free(bcoverage);</span>
<a name="2286"><span class="lineNum">    2286 </span>            : }</a>
<span class="lineNum">    2287 </span>            : 
<span class="lineNum">    2288 </span><span class="lineCov">          1 : static void readttfsizeparameters(FILE *ttf,int32 broken_pos,int32 correct_pos,</span>
<span class="lineNum">    2289 </span>            :         struct ttfinfo *info) {
<span class="lineNum">    2290 </span>            :     int32 here;
<span class="lineNum">    2291 </span>            :     /* Both of the two fonts I've seen that contain a 'size' feature */
<span class="lineNum">    2292 </span>            :     /*  have multiple features all of which point to the same parameter */
<span class="lineNum">    2293 </span>            :     /*  area. Odd. */
<span class="lineNum">    2294 </span>            :     /* When Adobe first released fonts containing the 'size' feature */
<span class="lineNum">    2295 </span>            :     /*  they did not follow the spec, and the offset to the size parameters */
<span class="lineNum">    2296 </span>            :     /*  was relative to the wrong location. They claim (Aug 2006) that */
<span class="lineNum">    2297 </span>            :     /*  this has been fixed. Be prepared to read either style of 'size' */
<span class="lineNum">    2298 </span>            :     /*  following the heuristics Adobe provides */
<span class="lineNum">    2299 </span>            :     int32 test[2];
<span class="lineNum">    2300 </span>            :     int i, nid;
<span class="lineNum">    2301 </span>            : 
<span class="lineNum">    2302 </span><span class="lineCov">          1 :     if ( info-&gt;last_size_pos==broken_pos || info-&gt;last_size_pos==correct_pos )</span>
<span class="lineNum">    2303 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2304 </span>            : 
<span class="lineNum">    2305 </span><span class="lineCov">          1 :     if ( info-&gt;last_size_pos!=0 ) {</span>
<span class="lineNum">    2306 </span><span class="lineNoCov">          0 :         LogError( _(&quot;This font, %s, has multiple GPOS 'size' features. I'm not sure how to interpret that. I shall pick one arbitrarily.\n&quot;),</span>
<span class="lineNum">    2307 </span><span class="lineNoCov">          0 :                 info-&gt;fontname==NULL? _(&quot;&lt;Untitled&gt;&quot;) : info-&gt;fontname );</span>
<span class="lineNum">    2308 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2309 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2310 </span>            :     }
<span class="lineNum">    2311 </span>            : 
<span class="lineNum">    2312 </span><span class="lineCov">          1 :     test[0] = correct_pos; test[1] = broken_pos;</span>
<span class="lineNum">    2313 </span><span class="lineCov">          1 :     here = ftell(ttf);</span>
<span class="lineNum">    2314 </span><span class="lineCov">          1 :     for ( i=0; i&lt;2; ++i ) {</span>
<span class="lineNum">    2315 </span><span class="lineCov">          1 :         fseek(ttf,test[i],SEEK_SET);</span>
<span class="lineNum">    2316 </span><span class="lineCov">          1 :         info-&gt;last_size_pos = test[i];</span>
<span class="lineNum">    2317 </span><span class="lineCov">          1 :         info-&gt;design_size = getushort(ttf);</span>
<span class="lineNum">    2318 </span><span class="lineCov">          1 :         if ( info-&gt;design_size==0 )</span>
<span class="lineNum">    2319 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    2320 </span><span class="lineCov">          1 :         info-&gt;fontstyle_id = getushort(ttf);</span>
<span class="lineNum">    2321 </span><span class="lineCov">          1 :         nid = getushort(ttf);</span>
<span class="lineNum">    2322 </span><span class="lineCov">          1 :         info-&gt;design_range_bottom = getushort(ttf);</span>
<span class="lineNum">    2323 </span><span class="lineCov">          1 :         info-&gt;design_range_top = getushort(ttf);</span>
<span class="lineNum">    2324 </span><span class="lineCov">          2 :         if ( info-&gt;fontstyle_id == 0 &amp;&amp; nid==0 &amp;&amp; info-&gt;design_size!=0 &amp;&amp;</span>
<span class="lineNum">    2325 </span><span class="lineCov">          2 :                 info-&gt;design_range_bottom==0 &amp;&amp; info-&gt;design_range_top==0 ) {</span>
<span class="lineNum">    2326 </span>            :             /* Reasonable spec, only design size provided */
<span class="lineNum">    2327 </span><span class="lineCov">          1 :             info-&gt;fontstyle_name = NULL;</span>
<span class="lineNum">    2328 </span><span class="lineCov">          1 :     break;</span>
<span class="lineNum">    2329 </span>            :         }
<span class="lineNum">    2330 </span><span class="lineNoCov">          0 :         if ( info-&gt;design_size==0 ||</span>
<span class="lineNum">    2331 </span><span class="lineNoCov">          0 :                 info-&gt;design_size &lt; info-&gt;design_range_bottom ||</span>
<span class="lineNum">    2332 </span><span class="lineNoCov">          0 :                 info-&gt;design_size &gt; info-&gt;design_range_top ||</span>
<span class="lineNum">    2333 </span><span class="lineNoCov">          0 :                 info-&gt;design_range_bottom &gt; info-&gt;design_range_top )</span>
<span class="lineNum">    2334 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    2335 </span><span class="lineNoCov">          0 :         if ( info-&gt;fontstyle_id == 0 &amp;&amp; nid==0 ) {</span>
<span class="lineNum">    2336 </span>            :             /* Not really allowed, but we'll accept it anyway */
<span class="lineNum">    2337 </span>            :             /* If a range is provided than a style name is expected */
<span class="lineNum">    2338 </span><span class="lineNoCov">          0 :             LogError(_(&quot;This font contains a 'size' feature with a design size and design range but no stylename. That is technically an error, but we'll let it pass&quot;));</span>
<span class="lineNum">    2339 </span><span class="lineNoCov">          0 :             info-&gt;fontstyle_name = NULL;</span>
<span class="lineNum">    2340 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    2341 </span>            :         }
<span class="lineNum">    2342 </span><span class="lineNoCov">          0 :         if ( nid&lt;256 || nid&gt;32767 )</span>
<span class="lineNum">    2343 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    2344 </span><span class="lineNoCov">          0 :         info-&gt;fontstyle_name = FindAllLangEntries(ttf,info,nid);</span>
<span class="lineNum">    2345 </span><span class="lineNoCov">          0 :         if ( info-&gt;fontstyle_name==NULL )</span>
<span class="lineNum">    2346 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    2347 </span>            :         else
<span class="lineNum">    2348 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    2349 </span>            :     }
<span class="lineNum">    2350 </span><span class="lineCov">          1 :     if ( i==2 ) {</span>
<span class="lineNum">    2351 </span><span class="lineNoCov">          0 :         LogError(_(&quot;The 'size' feature does not seem to follow the standard,\nnor does it conform to Adobe's early misinterpretation of\nthe standard. I cannot parse it.\n&quot;) );</span>
<span class="lineNum">    2352 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2353 </span><span class="lineNoCov">          0 :         info-&gt;design_size = info-&gt;design_range_bottom = info-&gt;design_range_top = info-&gt;fontstyle_id = 0;</span>
<span class="lineNum">    2354 </span><span class="lineNoCov">          0 :         info-&gt;fontstyle_name = NULL;</span>
<span class="lineNum">    2355 </span><span class="lineCov">          1 :     } else if ( i==1 ) {</span>
<span class="lineNum">    2356 </span><span class="lineNoCov">          0 :         LogError(_(&quot;The 'size' feature of this font conforms to Adobe's early misinterpretation of the otf standard.\n&quot;) );</span>
<span class="lineNum">    2357 </span>            :     }
<span class="lineNum">    2358 </span><span class="lineCov">          1 :     fseek(ttf,here,SEEK_SET);</span>
<a name="2359"><span class="lineNum">    2359 </span>            : }</a>
<span class="lineNum">    2360 </span>            : 
<span class="lineNum">    2361 </span><span class="lineNoCov">          0 : static void readttffeatnameparameters(FILE *ttf,int32 pos,uint32 tag,</span>
<span class="lineNum">    2362 </span>            :         struct ttfinfo *info) {
<span class="lineNum">    2363 </span>            :     int version, nid;
<span class="lineNum">    2364 </span>            :     struct otffeatname *fn;
<span class="lineNum">    2365 </span>            :     uint32 here;
<span class="lineNum">    2366 </span>            : 
<span class="lineNum">    2367 </span><span class="lineNoCov">          0 :     here = ftell(ttf);</span>
<span class="lineNum">    2368 </span><span class="lineNoCov">          0 :     fseek(ttf,pos,SEEK_SET);</span>
<span class="lineNum">    2369 </span><span class="lineNoCov">          0 :     version = getushort(ttf);   /* Minor version #, currently (2009) 0 */</span>
<span class="lineNum">    2370 </span><span class="lineNoCov">          0 :     nid = getushort(ttf);</span>
<span class="lineNum">    2371 </span><span class="lineNoCov">          0 :     fseek(ttf,here,SEEK_SET);</span>
<span class="lineNum">    2372 </span>            : 
<span class="lineNum">    2373 </span><span class="lineNoCov">          0 :     if ( version&gt;=10 || nid&lt;256 || nid&gt;32767 ) {</span>
<span class="lineNum">    2374 </span><span class="lineNoCov">          0 :         if ( nid&lt;256 || nid&gt;32767 )</span>
<span class="lineNum">    2375 </span><span class="lineNoCov">          0 :             LogError(_(&quot;The name parameter of the '%c%c%c%c' feature does not contain a valid name id.\n&quot;),</span>
<span class="lineNum">    2376 </span>            :                     tag&gt;&gt;24, tag&gt;&gt;16, tag&gt;&gt;8, tag );
<span class="lineNum">    2377 </span>            :         else
<span class="lineNum">    2378 </span><span class="lineNoCov">          0 :             LogError(_(&quot;The name parameter of the '%c%c%c%c' feature has an unlikely version number %d.\n&quot;),</span>
<span class="lineNum">    2379 </span>            :                     tag&gt;&gt;24, tag&gt;&gt;16, tag&gt;&gt;8, tag, version );
<span class="lineNum">    2380 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2381 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2382 </span>            :     }
<span class="lineNum">    2383 </span><span class="lineNoCov">          0 :     for ( fn=info-&gt;feat_names; fn!=NULL &amp;&amp; fn-&gt;tag!=tag; fn=fn-&gt;next );</span>
<span class="lineNum">    2384 </span><span class="lineNoCov">          0 :     if ( fn!=NULL ) {</span>
<span class="lineNum">    2385 </span><span class="lineNoCov">          0 :         if ( fn-&gt;nid == nid )</span>
<span class="lineNum">    2386 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2387 </span><span class="lineNoCov">          0 :         LogError(_(&quot;There are multiple name ids naming the '%c%c%c%c' feature\n this is technically legitimate, but fontforge can't handle it.\n&quot;),</span>
<span class="lineNum">    2388 </span>            :                 tag&gt;&gt;24, tag&gt;&gt;16, tag&gt;&gt;8, tag );
<span class="lineNum">    2389 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2390 </span>            :     }
<span class="lineNum">    2391 </span>            : 
<span class="lineNum">    2392 </span><span class="lineNoCov">          0 :     fn = chunkalloc( sizeof(*fn) );</span>
<span class="lineNum">    2393 </span><span class="lineNoCov">          0 :     fn-&gt;tag = tag;</span>
<span class="lineNum">    2394 </span><span class="lineNoCov">          0 :     fn-&gt;nid = nid;</span>
<span class="lineNum">    2395 </span><span class="lineNoCov">          0 :     fn-&gt;next = info-&gt;feat_names;</span>
<span class="lineNum">    2396 </span><span class="lineNoCov">          0 :     info-&gt;feat_names = fn;</span>
<span class="lineNum">    2397 </span><span class="lineNoCov">          0 :     fn-&gt;names = FindAllLangEntries(ttf,info,nid);</span>
<a name="2398"><span class="lineNum">    2398 </span>            : }</a>
<span class="lineNum">    2399 </span>            : 
<span class="lineNum">    2400 </span><span class="lineCov">         35 : static struct scripts *readttfscripts(FILE *ttf,int32 pos, struct ttfinfo *info, int isgpos) {</span>
<span class="lineNum">    2401 </span>            :     int i,j,k,cnt;
<span class="lineNum">    2402 </span>            :     int deflang, lcnt;
<span class="lineNum">    2403 </span>            :     struct scripts *scripts;
<span class="lineNum">    2404 </span>            : 
<span class="lineNum">    2405 </span><span class="lineCov">         35 :     if ( pos&gt;=info-&gt;g_bounds ) {</span>
<span class="lineNum">    2406 </span><span class="lineNoCov">          0 :         LogError(_(&quot;Attempt to read script data beyond end of %s table&quot;), isgpos ? &quot;GPOS&quot; : &quot;GSUB&quot; );</span>
<span class="lineNum">    2407 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2408 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2409 </span>            :     }
<span class="lineNum">    2410 </span><span class="lineCov">         35 :     fseek(ttf,pos,SEEK_SET);</span>
<span class="lineNum">    2411 </span><span class="lineCov">         35 :     cnt = getushort(ttf);</span>
<span class="lineNum">    2412 </span><span class="lineCov">         35 :     if ( cnt&lt;=0 )</span>
<span class="lineNum">    2413 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2414 </span><span class="lineCov">         35 :     else if ( cnt&gt;1000 ) {</span>
<span class="lineNum">    2415 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Too many scripts %d\n&quot;), cnt );</span>
<span class="lineNum">    2416 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2417 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2418 </span>            :     }
<span class="lineNum">    2419 </span>            : 
<span class="lineNum">    2420 </span><span class="lineCov">         35 :     scripts = calloc(cnt+1,sizeof(struct scripts));</span>
<span class="lineNum">    2421 </span><span class="lineCov">        127 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    2422 </span><span class="lineCov">         92 :         scripts[i].tag = getlong(ttf);</span>
<span class="lineNum">    2423 </span><span class="lineCov">         92 :         scripts[i].offset = getushort(ttf);</span>
<span class="lineNum">    2424 </span>            :     }
<span class="lineNum">    2425 </span><span class="lineCov">        127 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    2426 </span><span class="lineCov">         92 :         fseek(ttf,pos+scripts[i].offset,SEEK_SET);</span>
<span class="lineNum">    2427 </span><span class="lineCov">         92 :         deflang = getushort(ttf);</span>
<span class="lineNum">    2428 </span><span class="lineCov">         92 :         lcnt = getushort(ttf);</span>
<span class="lineNum">    2429 </span><span class="lineCov">         92 :         lcnt += (deflang!=0);</span>
<span class="lineNum">    2430 </span><span class="lineCov">         92 :         scripts[i].langcnt = lcnt;</span>
<span class="lineNum">    2431 </span><span class="lineCov">         92 :         scripts[i].languages = calloc(lcnt+1,sizeof(struct language));</span>
<span class="lineNum">    2432 </span><span class="lineCov">         92 :         j = 0;</span>
<span class="lineNum">    2433 </span><span class="lineCov">         92 :         if ( deflang!=0 ) {</span>
<span class="lineNum">    2434 </span><span class="lineCov">         92 :             scripts[i].languages[0].tag = CHR('d','f','l','t');</span>
<span class="lineNum">    2435 </span><span class="lineCov">         92 :             scripts[i].languages[0].offset = deflang+scripts[i].offset;</span>
<span class="lineNum">    2436 </span><span class="lineCov">         92 :             ++j;</span>
<span class="lineNum">    2437 </span>            :         }
<span class="lineNum">    2438 </span><span class="lineCov">        111 :         for ( ; j&lt;lcnt; ++j ) {</span>
<span class="lineNum">    2439 </span><span class="lineCov">         19 :             scripts[i].languages[j].tag = getlong(ttf);</span>
<span class="lineNum">    2440 </span><span class="lineCov">         19 :             scripts[i].languages[j].offset = scripts[i].offset+getushort(ttf);</span>
<span class="lineNum">    2441 </span>            :         }
<span class="lineNum">    2442 </span><span class="lineCov">        203 :         for ( j=0; j&lt;lcnt; ++j ) {</span>
<span class="lineNum">    2443 </span><span class="lineCov">        111 :             if ( pos+scripts[i].languages[j].offset&gt;=info-&gt;g_bounds ) {</span>
<span class="lineNum">    2444 </span><span class="lineNoCov">          0 :                 LogError(_(&quot;Attempt to read script data beyond end of %s table&quot;), isgpos ? &quot;GPOS&quot; : &quot;GSUB&quot; );</span>
<span class="lineNum">    2445 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    2446 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2447 </span>            :             }
<span class="lineNum">    2448 </span><span class="lineCov">        111 :             fseek(ttf,pos+scripts[i].languages[j].offset,SEEK_SET);</span>
<span class="lineNum">    2449 </span><span class="lineCov">        111 :             (void) getushort(ttf);      /* lookup ordering table undefined */</span>
<span class="lineNum">    2450 </span><span class="lineCov">        111 :             scripts[i].languages[j].req = getushort(ttf);</span>
<span class="lineNum">    2451 </span><span class="lineCov">        111 :             scripts[i].languages[j].fcnt = getushort(ttf);</span>
<span class="lineNum">    2452 </span><span class="lineCov">        111 :             if ( feof(ttf)) {</span>
<span class="lineNum">    2453 </span><span class="lineNoCov">          0 :                 LogError(_(&quot;End of file when reading scripts in %s table&quot;), isgpos ? &quot;GPOS&quot; : &quot;GSUB&quot; );</span>
<span class="lineNum">    2454 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    2455 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2456 </span>            :             }
<span class="lineNum">    2457 </span><span class="lineCov">        111 :             scripts[i].languages[j].features = malloc(scripts[i].languages[j].fcnt*sizeof(uint16));</span>
<span class="lineNum">    2458 </span><span class="lineCov">        540 :             for ( k=0; k&lt;scripts[i].languages[j].fcnt; ++k )</span>
<span class="lineNum">    2459 </span><span class="lineCov">        429 :                 scripts[i].languages[j].features[k] = getushort(ttf);</span>
<span class="lineNum">    2460 </span>            :         }
<span class="lineNum">    2461 </span>            :     }
<span class="lineNum">    2462 </span>            : 
<span class="lineNum">    2463 </span><span class="lineCov">         35 :     if ( feof(ttf)) {</span>
<span class="lineNum">    2464 </span><span class="lineNoCov">          0 :         LogError(_(&quot;End of file in %s table&quot;), isgpos ? &quot;GPOS&quot; : &quot;GSUB&quot; );</span>
<span class="lineNum">    2465 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2466 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2467 </span>            :     }
<span class="lineNum">    2468 </span>            : 
<span class="lineNum">    2469 </span><span class="lineCov">         35 : return( scripts );</span>
<a name="2470"><span class="lineNum">    2470 </span>            : }</a>
<span class="lineNum">    2471 </span>            : 
<span class="lineNum">    2472 </span><span class="lineCov">         35 : static struct feature *readttffeatures(FILE *ttf,int32 pos,int isgpos, struct ttfinfo *info) {</span>
<span class="lineNum">    2473 </span>            :     /* read the features table returning an array containing all interesting */
<span class="lineNum">    2474 </span>            :     /*  features */
<span class="lineNum">    2475 </span>            :     int cnt;
<span class="lineNum">    2476 </span>            :     int i,j;
<span class="lineNum">    2477 </span>            :     struct feature *features;
<span class="lineNum">    2478 </span>            :     int parameters;
<span class="lineNum">    2479 </span>            : 
<span class="lineNum">    2480 </span><span class="lineCov">         35 :     if ( pos&gt;=info-&gt;g_bounds ) {</span>
<span class="lineNum">    2481 </span><span class="lineNoCov">          0 :         LogError(_(&quot;Attempt to read feature data beyond end of %s table&quot;), isgpos ? &quot;GPOS&quot; : &quot;GSUB&quot; );</span>
<span class="lineNum">    2482 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2483 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2484 </span>            :     }
<span class="lineNum">    2485 </span><span class="lineCov">         35 :     fseek(ttf,pos,SEEK_SET);</span>
<span class="lineNum">    2486 </span><span class="lineCov">         35 :     info-&gt;feature_cnt = cnt = getushort(ttf);</span>
<span class="lineNum">    2487 </span><span class="lineCov">         35 :     if ( cnt&lt;=0 )</span>
<span class="lineNum">    2488 </span><span class="lineCov">          1 : return( NULL );</span>
<span class="lineNum">    2489 </span><span class="lineCov">         34 :     else if ( cnt&gt;1000 ) {</span>
<span class="lineNum">    2490 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Too many features %d\n&quot;), cnt );</span>
<span class="lineNum">    2491 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2492 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2493 </span>            :     }
<span class="lineNum">    2494 </span>            : 
<span class="lineNum">    2495 </span><span class="lineCov">         34 :     features = calloc(cnt+1,sizeof(struct feature));</span>
<span class="lineNum">    2496 </span><span class="lineCov">        257 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    2497 </span><span class="lineCov">        223 :         features[i].tag = getlong(ttf);</span>
<span class="lineNum">    2498 </span><span class="lineCov">        223 :         features[i].offset = getushort(ttf);</span>
<span class="lineNum">    2499 </span>            :     }
<span class="lineNum">    2500 </span>            : 
<span class="lineNum">    2501 </span><span class="lineCov">        257 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    2502 </span><span class="lineCov">        223 :         if ( pos+features[i].offset&gt;=info-&gt;g_bounds ) {</span>
<span class="lineNum">    2503 </span><span class="lineNoCov">          0 :             LogError(_(&quot;Attempt to read feature data beyond end of %s table&quot;), isgpos ? &quot;GPOS&quot; : &quot;GSUB&quot; );</span>
<span class="lineNum">    2504 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    2505 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2506 </span>            :         }
<span class="lineNum">    2507 </span><span class="lineCov">        223 :         fseek(ttf,pos+features[i].offset,SEEK_SET);</span>
<span class="lineNum">    2508 </span><span class="lineCov">        223 :         parameters = getushort(ttf);</span>
<span class="lineNum">    2509 </span><span class="lineCov">        223 :         if ( features[i].tag==CHR('s','i','z','e') &amp;&amp; parameters!=0 &amp;&amp; !feof(ttf)) {</span>
<span class="lineNum">    2510 </span><span class="lineCov">          1 :             readttfsizeparameters(ttf,pos+parameters,</span>
<span class="lineNum">    2511 </span><span class="lineCov">          1 :                     pos+parameters+features[i].offset,info);</span>
<span class="lineNum">    2512 </span><span class="lineCov">        222 :         } else if ( features[i].tag&gt;=CHR('s','s','0','1') &amp;&amp; features[i].tag&lt;=CHR('s','s','2','0') &amp;&amp;</span>
<span class="lineNum">    2513 </span><span class="lineNoCov">          0 :                 parameters!=0 &amp;&amp; !feof(ttf)) {</span>
<span class="lineNum">    2514 </span><span class="lineNoCov">          0 :             readttffeatnameparameters(ttf,pos+parameters+features[i].offset,</span>
<span class="lineNum">    2515 </span><span class="lineNoCov">          0 :                     features[i].tag,info);</span>
<span class="lineNum">    2516 </span>            :         }
<span class="lineNum">    2517 </span><span class="lineCov">        223 :         features[i].lcnt = getushort(ttf);</span>
<span class="lineNum">    2518 </span><span class="lineCov">        223 :         if ( feof(ttf) ) {</span>
<span class="lineNum">    2519 </span><span class="lineNoCov">          0 :             LogError(_(&quot;End of file when reading features in %s table&quot;), isgpos ? &quot;GPOS&quot; : &quot;GSUB&quot; );</span>
<span class="lineNum">    2520 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    2521 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2522 </span>            :         }
<span class="lineNum">    2523 </span><span class="lineCov">        223 :         features[i].lookups = malloc(features[i].lcnt*sizeof(uint16));</span>
<span class="lineNum">    2524 </span><span class="lineCov">        669 :         for ( j=0; j&lt;features[i].lcnt; ++j )</span>
<span class="lineNum">    2525 </span><span class="lineCov">        446 :             features[i].lookups[j] = getushort(ttf);</span>
<span class="lineNum">    2526 </span>            :     }
<span class="lineNum">    2527 </span>            : 
<span class="lineNum">    2528 </span><span class="lineCov">         34 : return( features );</span>
<a name="2529"><span class="lineNum">    2529 </span>            : }</a>
<span class="lineNum">    2530 </span>            : 
<span class="lineNum">    2531 </span><span class="lineCov">         35 : static struct lookup *readttflookups(FILE *ttf,int32 pos, struct ttfinfo *info, int isgpos) {</span>
<span class="lineNum">    2532 </span>            :     int cnt,i,j;
<span class="lineNum">    2533 </span>            :     struct lookup *lookups;
<span class="lineNum">    2534 </span><span class="lineCov">         35 :     OTLookup *otlookup, *last=NULL;</span>
<span class="lineNum">    2535 </span>            :     struct lookup_subtable *st;
<span class="lineNum">    2536 </span>            : 
<span class="lineNum">    2537 </span><span class="lineCov">         35 :     if ( pos&gt;=info-&gt;g_bounds ) {</span>
<span class="lineNum">    2538 </span><span class="lineNoCov">          0 :         LogError(_(&quot;Attempt to read lookup data beyond end of %s table&quot;),</span>
<span class="lineNum">    2539 </span><span class="lineNoCov">          0 :                 isgpos==2? &quot;JSTF&quot; : isgpos ? &quot;GPOS&quot; : &quot;GSUB&quot; );</span>
<span class="lineNum">    2540 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2541 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2542 </span>            :     }
<span class="lineNum">    2543 </span>            : 
<span class="lineNum">    2544 </span><span class="lineCov">         35 :     fseek(ttf,pos,SEEK_SET);</span>
<span class="lineNum">    2545 </span><span class="lineCov">         35 :     info-&gt;lookup_cnt = cnt = getushort(ttf);</span>
<span class="lineNum">    2546 </span><span class="lineCov">         35 :     info-&gt;cur_lookups = NULL;</span>
<span class="lineNum">    2547 </span><span class="lineCov">         35 :     if ( cnt&lt;=0 )</span>
<span class="lineNum">    2548 </span><span class="lineCov">          1 : return( NULL );</span>
<span class="lineNum">    2549 </span><span class="lineCov">         34 :     else if ( cnt&gt;1000 ) {</span>
<span class="lineNum">    2550 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Too many lookups %d\n&quot;), cnt );</span>
<span class="lineNum">    2551 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2552 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2553 </span>            :     }
<span class="lineNum">    2554 </span>            : 
<span class="lineNum">    2555 </span><span class="lineCov">         34 :     lookups = calloc(cnt+1,sizeof(struct lookup));</span>
<span class="lineNum">    2556 </span><span class="lineCov">        329 :     for ( i=0; i&lt;cnt; ++i )</span>
<span class="lineNum">    2557 </span><span class="lineCov">        295 :         lookups[i].offset = getushort(ttf);</span>
<span class="lineNum">    2558 </span><span class="lineCov">        329 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    2559 </span><span class="lineCov">        295 :         if ( pos+lookups[i].offset&gt;=info-&gt;g_bounds ) {</span>
<span class="lineNum">    2560 </span><span class="lineNoCov">          0 :             LogError(_(&quot;Attempt to read lookup data beyond end of %s table&quot;),</span>
<span class="lineNum">    2561 </span><span class="lineNoCov">          0 :                     isgpos==2? &quot;JSTF&quot; : isgpos ? &quot;GPOS&quot; : &quot;GSUB&quot; );</span>
<span class="lineNum">    2562 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    2563 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2564 </span>            :         }
<span class="lineNum">    2565 </span><span class="lineCov">        295 :         fseek(ttf,pos+lookups[i].offset,SEEK_SET);</span>
<span class="lineNum">    2566 </span><span class="lineCov">        295 :         lookups[i].type = getushort(ttf);</span>
<span class="lineNum">    2567 </span><span class="lineCov">        295 :         lookups[i].flags = getushort(ttf);</span>
<span class="lineNum">    2568 </span><span class="lineCov">        295 :         lookups[i].subtabcnt = getushort(ttf);</span>
<span class="lineNum">    2569 </span><span class="lineCov">        295 :         lookups[i].subtab_offsets = malloc(lookups[i].subtabcnt*sizeof(int32));</span>
<span class="lineNum">    2570 </span><span class="lineCov">        601 :         for ( j=0; j&lt;lookups[i].subtabcnt; ++j )</span>
<span class="lineNum">    2571 </span><span class="lineCov">        306 :             lookups[i].subtab_offsets[j] = pos+lookups[i].offset+getushort(ttf);</span>
<span class="lineNum">    2572 </span><span class="lineCov">        295 :         if ( lookups[i].flags&amp;pst_usemarkfilteringset )</span>
<span class="lineNum">    2573 </span><span class="lineNoCov">          0 :             lookups[i].flags |= (getushort(ttf)&lt;&lt;16);</span>
<span class="lineNum">    2574 </span>            : 
<span class="lineNum">    2575 </span><span class="lineCov">        295 :         lookups[i].otlookup = otlookup = chunkalloc(sizeof(OTLookup));</span>
<span class="lineNum">    2576 </span><span class="lineCov">        295 :         otlookup-&gt;lookup_index = i;</span>
<span class="lineNum">    2577 </span><span class="lineCov">        295 :         if ( last==NULL )</span>
<span class="lineNum">    2578 </span><span class="lineCov">         34 :             info-&gt;cur_lookups = otlookup;</span>
<span class="lineNum">    2579 </span>            :         else
<span class="lineNum">    2580 </span><span class="lineCov">        261 :             last-&gt;next = otlookup;</span>
<span class="lineNum">    2581 </span><span class="lineCov">        295 :         last = otlookup;</span>
<span class="lineNum">    2582 </span><span class="lineCov">        295 :         otlookup-&gt;lookup_type = ((isgpos&gt;0)&lt;&lt;8) | lookups[i].type;</span>
<span class="lineNum">    2583 </span><span class="lineCov">        295 :         otlookup-&gt;lookup_flags = lookups[i].flags;</span>
<span class="lineNum">    2584 </span><span class="lineCov">        295 :         otlookup-&gt;lookup_index = i;</span>
<span class="lineNum">    2585 </span><span class="lineCov">        295 :         if ( feof(ttf) ) {</span>
<span class="lineNum">    2586 </span><span class="lineNoCov">          0 :             LogError(_(&quot;End of file when reading lookups in %s table&quot;), isgpos ? &quot;GPOS&quot; : &quot;GSUB&quot; );</span>
<span class="lineNum">    2587 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    2588 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    2589 </span>            :         }
<span class="lineNum">    2590 </span><span class="lineCov">        601 :         for ( j=0; j&lt;lookups[i].subtabcnt; ++j ) {</span>
<span class="lineNum">    2591 </span><span class="lineCov">        306 :             st = chunkalloc(sizeof(struct lookup_subtable));</span>
<span class="lineNum">    2592 </span><span class="lineCov">        306 :             st-&gt;next = otlookup-&gt;subtables;</span>
<span class="lineNum">    2593 </span><span class="lineCov">        306 :             st-&gt;lookup = otlookup;</span>
<span class="lineNum">    2594 </span><span class="lineCov">        306 :             otlookup-&gt;subtables = st;</span>
<span class="lineNum">    2595 </span>            :         }
<span class="lineNum">    2596 </span>            :     }
<span class="lineNum">    2597 </span><span class="lineCov">         34 :     if ( isgpos==2 ) {</span>
<span class="lineNum">    2598 </span>            :         OTLookup *end;
<span class="lineNum">    2599 </span>            :         /* Add any JSTF lookups to the end of the GPOS list. they have the */
<span class="lineNum">    2600 </span>            :         /*  same format, we'll treat them as GPOS internally, and separate */
<span class="lineNum">    2601 </span>            :         /*  them out when we generate the new font */
<span class="lineNum">    2602 </span><span class="lineNoCov">          0 :         if ( info-&gt;gpos_lookups==NULL )</span>
<span class="lineNum">    2603 </span><span class="lineNoCov">          0 :             info-&gt;gpos_lookups = info-&gt;cur_lookups;</span>
<span class="lineNum">    2604 </span>            :         else {
<span class="lineNum">    2605 </span><span class="lineNoCov">          0 :             for ( end=info-&gt;gpos_lookups; end-&gt;next!=NULL; end = end-&gt;next );</span>
<span class="lineNum">    2606 </span><span class="lineNoCov">          0 :             end-&gt;next = info-&gt;cur_lookups;</span>
<span class="lineNum">    2607 </span>            :         }
<span class="lineNum">    2608 </span><span class="lineCov">         34 :     } else if ( isgpos )</span>
<span class="lineNum">    2609 </span><span class="lineCov">         13 :         info-&gt;gpos_lookups = info-&gt;cur_lookups;</span>
<span class="lineNum">    2610 </span>            :     else
<span class="lineNum">    2611 </span><span class="lineCov">         21 :         info-&gt;gsub_lookups = info-&gt;cur_lookups;</span>
<span class="lineNum">    2612 </span><span class="lineCov">         34 : return( lookups );</span>
<a name="2613"><span class="lineNum">    2613 </span>            : }</a>
<span class="lineNum">    2614 </span>            : 
<span class="lineNum">    2615 </span><span class="lineCov">        431 : static void tagLookupsWithFeature(uint32 script_tag,uint32 lang_tag,</span>
<span class="lineNum">    2616 </span>            :         int required_feature, struct feature *feature, struct lookup *lookups,
<span class="lineNum">    2617 </span>            :         struct ttfinfo *info) {
<span class="lineNum">    2618 </span><span class="lineCov">        431 :     uint32 feature_tag = required_feature ? REQUIRED_FEATURE : feature-&gt;tag;</span>
<span class="lineNum">    2619 </span>            :     int i;
<span class="lineNum">    2620 </span>            :     OTLookup *otlookup;
<span class="lineNum">    2621 </span>            :     FeatureScriptLangList *fl;
<span class="lineNum">    2622 </span>            : 
<span class="lineNum">    2623 </span>            :     /* The otf docs are ambiguous as to the capitalization of the default */
<span class="lineNum">    2624 </span>            :     /*  script. The capitalized version is correct (uncapitalized is used for languages) */
<span class="lineNum">    2625 </span><span class="lineCov">        431 :     if ( script_tag == DEFAULT_LANG )</span>
<span class="lineNum">    2626 </span><span class="lineNoCov">          0 :         script_tag = DEFAULT_SCRIPT;</span>
<span class="lineNum">    2627 </span>            : 
<span class="lineNum">    2628 </span><span class="lineCov">       1235 :     for ( i=0; i &lt; feature-&gt;lcnt; ++i ) {</span>
<span class="lineNum">    2629 </span><span class="lineCov">        804 :         if ( feature-&gt;lookups[i]&gt;=info-&gt;lookup_cnt ) {</span>
<span class="lineNum">    2630 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Lookup out of bounds in feature table.\n&quot;) );</span>
<span class="lineNum">    2631 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    2632 </span>            :         } else {
<span class="lineNum">    2633 </span><span class="lineCov">        804 :             otlookup = lookups[feature-&gt;lookups[i]].otlookup;</span>
<span class="lineNum">    2634 </span><span class="lineCov">        804 :             for ( fl = otlookup-&gt;features; fl!=NULL &amp;&amp; fl-&gt;featuretag!=feature_tag; fl=fl-&gt;next );</span>
<span class="lineNum">    2635 </span><span class="lineCov">        804 :             if ( fl==NULL ) {</span>
<span class="lineNum">    2636 </span><span class="lineCov">        254 :                 fl = chunkalloc(sizeof(FeatureScriptLangList));</span>
<span class="lineNum">    2637 </span><span class="lineCov">        254 :                 fl-&gt;featuretag = feature_tag;</span>
<span class="lineNum">    2638 </span><span class="lineCov">        254 :                 fl-&gt;next = otlookup-&gt;features;</span>
<span class="lineNum">    2639 </span><span class="lineCov">        254 :                 otlookup-&gt;features = fl;</span>
<span class="lineNum">    2640 </span>            :             }
<span class="lineNum">    2641 </span><span class="lineCov">        804 :             FListAppendScriptLang(fl,script_tag,lang_tag);</span>
<span class="lineNum">    2642 </span>            :         }
<span class="lineNum">    2643 </span>            :     }
<a name="2644"><span class="lineNum">    2644 </span><span class="lineCov">        431 : }</span></a>
<span class="lineNum">    2645 </span>            : 
<span class="lineNum">    2646 </span><span class="lineCov">         34 : static void tagLookupsWithScript(struct scripts *scripts,</span>
<span class="lineNum">    2647 </span>            :         struct feature *features, struct lookup *lookups,struct ttfinfo *info ) {
<span class="lineNum">    2648 </span>            :     int i,j;
<span class="lineNum">    2649 </span>            :     struct scripts *s;
<span class="lineNum">    2650 </span>            :     struct language *lang;
<span class="lineNum">    2651 </span>            :     struct lookup *l;
<span class="lineNum">    2652 </span>            : 
<span class="lineNum">    2653 </span><span class="lineCov">         34 :     if ( scripts==NULL || features==NULL )</span>
<span class="lineNum">    2654 </span><span class="lineCov">         34 : return;         /* Legal, I'd guess, but not very interesting. Perhaps all lookups are controlled by the JSTF table or something */</span>
<span class="lineNum">    2655 </span>            : 
<span class="lineNum">    2656 </span>            :     /* First tag every lookup with all script, lang, feature combinations that*/
<span class="lineNum">    2657 </span>            :     /*  invoke it */
<span class="lineNum">    2658 </span><span class="lineCov">        125 :     for ( s=scripts; s-&gt;tag!=0; ++s ) {</span>
<span class="lineNum">    2659 </span><span class="lineCov">        201 :         for ( lang=s-&gt;languages, i=0; i&lt;s-&gt;langcnt; ++i, ++lang ) {</span>
<span class="lineNum">    2660 </span><span class="lineCov">        110 :             if ( lang-&gt;req==0xffff )</span>
<span class="lineNum">    2661 </span>            :                 /* Do Nothing */;
<span class="lineNum">    2662 </span><span class="lineCov">          2 :             else if ( lang-&gt;req&gt;= info-&gt;feature_cnt ) {</span>
<span class="lineNum">    2663 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Required feature out of bounds in script table.\n&quot;) );</span>
<span class="lineNum">    2664 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    2665 </span>            :             } else
<span class="lineNum">    2666 </span><span class="lineCov">          2 :                 tagLookupsWithFeature(s-&gt;tag,lang-&gt;tag,true,&amp;features[lang-&gt;req],</span>
<span class="lineNum">    2667 </span>            :                         lookups,info);
<span class="lineNum">    2668 </span><span class="lineCov">        539 :             for ( j=0; j&lt;lang-&gt;fcnt; ++j ) {</span>
<span class="lineNum">    2669 </span><span class="lineCov">        429 :                 if ( lang-&gt;features[j]&gt;=info-&gt;feature_cnt ) {</span>
<span class="lineNum">    2670 </span><span class="lineNoCov">          0 :                     LogError( _(&quot;Feature out of bounds in script table.\n&quot;) );</span>
<span class="lineNum">    2671 </span><span class="lineNoCov">          0 :                     info-&gt;bad_ot = true;</span>
<span class="lineNum">    2672 </span>            :                 } else
<span class="lineNum">    2673 </span><span class="lineCov">        429 :                     tagLookupsWithFeature(s-&gt;tag,lang-&gt;tag,false,&amp;features[lang-&gt;features[j]],</span>
<span class="lineNum">    2674 </span>            :                             lookups,info);
<span class="lineNum">    2675 </span>            :             }
<span class="lineNum">    2676 </span>            :         }
<span class="lineNum">    2677 </span>            :     }
<span class="lineNum">    2678 </span>            : 
<span class="lineNum">    2679 </span>            :     /* The scripts got added backwards so reverse to put them in */
<span class="lineNum">    2680 </span>            :     /*  alphabetic order again */
<span class="lineNum">    2681 </span><span class="lineCov">        329 :     for ( l=lookups, i=0; l-&gt;offset!=0; ++l, ++i ) {</span>
<span class="lineNum">    2682 </span><span class="lineCov">        295 :         OTLookup *otl = l-&gt;otlookup;</span>
<span class="lineNum">    2683 </span>            :         FeatureScriptLangList *fl;
<span class="lineNum">    2684 </span>            :         struct scriptlanglist *sl, *next, *prev;
<span class="lineNum">    2685 </span><span class="lineCov">        549 :         for ( fl=otl-&gt;features; fl!=NULL; fl=fl-&gt;next ) {</span>
<span class="lineNum">    2686 </span><span class="lineCov">        254 :             prev = NULL;</span>
<span class="lineNum">    2687 </span><span class="lineCov">        802 :             for ( sl=fl-&gt;scripts; sl!=NULL; sl = next ) {</span>
<span class="lineNum">    2688 </span><span class="lineCov">        548 :                 next = sl-&gt;next;</span>
<span class="lineNum">    2689 </span><span class="lineCov">        548 :                 sl-&gt;next = prev;</span>
<span class="lineNum">    2690 </span><span class="lineCov">        548 :                 prev = sl;</span>
<span class="lineNum">    2691 </span>            :             }
<span class="lineNum">    2692 </span><span class="lineCov">        254 :             fl-&gt;scripts = prev;</span>
<span class="lineNum">    2693 </span>            :         }
<span class="lineNum">    2694 </span>            :     }
<a name="2695"><span class="lineNum">    2695 </span>            : }</a>
<span class="lineNum">    2696 </span>            : 
<span class="lineNum">    2697 </span><span class="lineCov">         39 : static void gposExtensionSubTable(FILE *ttf, int stoffset,</span>
<span class="lineNum">    2698 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable,
<span class="lineNum">    2699 </span>            :         struct lookup *alllooks) {
<span class="lineNum">    2700 </span><span class="lineCov">         39 :     uint32 base = ftell(ttf), st, offset;</span>
<span class="lineNum">    2701 </span>            :     int lu_type;
<span class="lineNum">    2702 </span>            : 
<span class="lineNum">    2703 </span><span class="lineCov">         39 :     /* Format = */ getushort(ttf);</span>
<span class="lineNum">    2704 </span><span class="lineCov">         39 :     lu_type = getushort(ttf);</span>
<span class="lineNum">    2705 </span><span class="lineCov">         39 :     offset = getlong(ttf);</span>
<span class="lineNum">    2706 </span>            : 
<span class="lineNum">    2707 </span><span class="lineCov">         39 :     l-&gt;otlookup-&gt;lookup_type = 0x100|lu_type;</span>
<span class="lineNum">    2708 </span>            : 
<span class="lineNum">    2709 </span><span class="lineCov">         39 :     fseek(ttf,st = base+offset,SEEK_SET);</span>
<span class="lineNum">    2710 </span><span class="lineCov">         39 :     switch ( lu_type ) {</span>
<span class="lineNum">    2711 </span>            :       case 1:
<span class="lineNum">    2712 </span><span class="lineNoCov">          0 :         gposSimplePos(ttf,st,info,l,subtable);</span>
<span class="lineNum">    2713 </span><span class="lineNoCov">          0 :       break;  </span>
<span class="lineNum">    2714 </span>            :       case 2:
<span class="lineNum">    2715 </span><span class="lineCov">          6 :         gposKernSubTable(ttf,st,info,l,subtable);</span>
<span class="lineNum">    2716 </span><span class="lineCov">          6 :       break;  </span>
<span class="lineNum">    2717 </span>            :       case 3:
<span class="lineNum">    2718 </span><span class="lineNoCov">          0 :         gposCursiveSubTable(ttf,st,info,subtable);</span>
<span class="lineNum">    2719 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2720 </span>            :       case 4: case 5: case 6:
<span class="lineNum">    2721 </span><span class="lineCov">         33 :         gposMarkSubTable(ttf,st,info,l,subtable);</span>
<span class="lineNum">    2722 </span><span class="lineCov">         33 :       break;</span>
<span class="lineNum">    2723 </span>            :       case 7:
<span class="lineNum">    2724 </span><span class="lineNoCov">          0 :         gposContextSubTable(ttf,st,info,l,subtable,alllooks);</span>
<span class="lineNum">    2725 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2726 </span>            :       case 8:
<span class="lineNum">    2727 </span><span class="lineNoCov">          0 :         gposChainingSubTable(ttf,st,info,l,subtable,alllooks);</span>
<span class="lineNum">    2728 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2729 </span>            :       case 9:
<span class="lineNum">    2730 </span><span class="lineNoCov">          0 :         LogError( _(&quot;This font is erroneous: it has a GPOS extension subtable that points to\nanother extension sub-table.\n&quot;) );</span>
<span class="lineNum">    2731 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2732 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2733 </span>            : /* Any cases added here also need to go in the gposLookupSwitch */
<span class="lineNum">    2734 </span>            :       default:
<span class="lineNum">    2735 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Unknown GPOS sub-table type: %d\n&quot;), lu_type );</span>
<span class="lineNum">    2736 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2737 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2738 </span>            :     }
<span class="lineNum">    2739 </span><span class="lineCov">         39 :     if ( ftell(ttf)&gt;info-&gt;g_bounds ) {</span>
<span class="lineNum">    2740 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Subtable extends beyond end of GPOS table\n&quot;) );</span>
<span class="lineNum">    2741 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2742 </span>            :     }
<a name="2743"><span class="lineNum">    2743 </span><span class="lineCov">         39 : }</span></a>
<span class="lineNum">    2744 </span>            : 
<span class="lineNum">    2745 </span><span class="lineCov">         63 : static void gsubExtensionSubTable(FILE *ttf, int stoffset,</span>
<span class="lineNum">    2746 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, int justinuse,
<span class="lineNum">    2747 </span>            :         struct lookup *alllooks) {
<span class="lineNum">    2748 </span><span class="lineCov">         63 :     uint32 base = ftell(ttf), st, offset;</span>
<span class="lineNum">    2749 </span>            :     int lu_type;
<span class="lineNum">    2750 </span>            : 
<span class="lineNum">    2751 </span><span class="lineCov">         63 :     /* Format = */ getushort(ttf);</span>
<span class="lineNum">    2752 </span><span class="lineCov">         63 :     lu_type = getushort(ttf);</span>
<span class="lineNum">    2753 </span><span class="lineCov">         63 :     offset = getlong(ttf);</span>
<span class="lineNum">    2754 </span>            : 
<span class="lineNum">    2755 </span><span class="lineCov">         63 :     l-&gt;otlookup-&gt;lookup_type = lu_type;</span>
<span class="lineNum">    2756 </span>            : 
<span class="lineNum">    2757 </span><span class="lineCov">         63 :     fseek(ttf,st = base+offset,SEEK_SET);</span>
<span class="lineNum">    2758 </span><span class="lineCov">         63 :     switch ( lu_type ) {</span>
<span class="lineNum">    2759 </span>            :       case 1:
<span class="lineNum">    2760 </span><span class="lineCov">         18 :         gsubSimpleSubTable(ttf,st,info,l,subtable,justinuse);</span>
<span class="lineNum">    2761 </span><span class="lineCov">         18 :       break;</span>
<span class="lineNum">    2762 </span>            :       case 2: case 3:   /* Multiple and alternate have same format, different semantics */
<span class="lineNum">    2763 </span><span class="lineCov">          9 :         gsubMultipleSubTable(ttf,st,info,l,subtable,justinuse);</span>
<span class="lineNum">    2764 </span><span class="lineCov">          9 :       break;</span>
<span class="lineNum">    2765 </span>            :       case 4:
<span class="lineNum">    2766 </span><span class="lineCov">         27 :         gsubLigatureSubTable(ttf,st,info,l,subtable,justinuse);</span>
<span class="lineNum">    2767 </span><span class="lineCov">         27 :       break;</span>
<span class="lineNum">    2768 </span>            :       case 5:
<span class="lineNum">    2769 </span><span class="lineNoCov">          0 :         gsubContextSubTable(ttf,st,info,l,subtable,justinuse,alllooks);</span>
<span class="lineNum">    2770 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2771 </span>            :       case 6:
<span class="lineNum">    2772 </span><span class="lineCov">          9 :         gsubChainingSubTable(ttf,st,info,l,subtable,justinuse,alllooks);</span>
<span class="lineNum">    2773 </span><span class="lineCov">          9 :       break;</span>
<span class="lineNum">    2774 </span>            :       case 7:
<span class="lineNum">    2775 </span><span class="lineNoCov">          0 :         LogError( _(&quot;This font is erroneous: it has a GSUB extension subtable that points to\nanother extension sub-table.\n&quot;) );</span>
<span class="lineNum">    2776 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2777 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2778 </span>            :       case 8:
<span class="lineNum">    2779 </span><span class="lineNoCov">          0 :         gsubReverseChainSubTable(ttf,st,info,l,subtable,justinuse);</span>
<span class="lineNum">    2780 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2781 </span>            : /* Any cases added here also need to go in the gsubLookupSwitch */
<span class="lineNum">    2782 </span>            :       default:
<span class="lineNum">    2783 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Unknown GSUB sub-table type: %d\n&quot;), lu_type );</span>
<span class="lineNum">    2784 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2785 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2786 </span>            :     }
<span class="lineNum">    2787 </span><span class="lineCov">         63 :     if ( ftell(ttf)&gt;info-&gt;gsub_start+info-&gt;gsub_length ) {</span>
<span class="lineNum">    2788 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Subtable extends beyond end of GSUB table\n&quot;) );</span>
<span class="lineNum">    2789 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2790 </span>            :     }
<a name="2791"><span class="lineNum">    2791 </span><span class="lineCov">         63 : }</span></a>
<span class="lineNum">    2792 </span>            : 
<span class="lineNum">    2793 </span><span class="lineCov">         96 : static void gposLookupSwitch(FILE *ttf, int st,</span>
<span class="lineNum">    2794 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable,
<span class="lineNum">    2795 </span>            :         struct lookup *alllooks) {
<span class="lineNum">    2796 </span>            : 
<span class="lineNum">    2797 </span><span class="lineCov">         96 :     switch ( l-&gt;type | 0x100 ) {</span>
<span class="lineNum">    2798 </span>            :       case gpos_single:
<span class="lineNum">    2799 </span><span class="lineCov">          3 :         gposSimplePos(ttf,st,info,l,subtable);</span>
<span class="lineNum">    2800 </span><span class="lineCov">          3 :       break;  </span>
<span class="lineNum">    2801 </span>            :       case gpos_pair:
<span class="lineNum">    2802 </span><span class="lineCov">         22 :         gposKernSubTable(ttf,st,info,l,subtable);</span>
<span class="lineNum">    2803 </span><span class="lineCov">         22 :       break;  </span>
<span class="lineNum">    2804 </span>            :       case gpos_cursive:
<span class="lineNum">    2805 </span><span class="lineNoCov">          0 :         gposCursiveSubTable(ttf,st,info,subtable);</span>
<span class="lineNum">    2806 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2807 </span>            :       case gpos_mark2base: case gpos_mark2ligature: case gpos_mark2mark:
<span class="lineNum">    2808 </span><span class="lineCov">         32 :         gposMarkSubTable(ttf,st,info,l,subtable);</span>
<span class="lineNum">    2809 </span><span class="lineCov">         32 :       break;</span>
<span class="lineNum">    2810 </span>            :       case gpos_context:
<span class="lineNum">    2811 </span><span class="lineNoCov">          0 :         gposContextSubTable(ttf,st,info,l,subtable,alllooks);</span>
<span class="lineNum">    2812 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2813 </span>            :       case gpos_contextchain:
<span class="lineNum">    2814 </span><span class="lineNoCov">          0 :         gposChainingSubTable(ttf,st,info,l,subtable,alllooks);</span>
<span class="lineNum">    2815 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2816 </span>            :       case 0x109:
<span class="lineNum">    2817 </span><span class="lineCov">         39 :         gposExtensionSubTable(ttf,st,info,l,subtable,alllooks);</span>
<span class="lineNum">    2818 </span><span class="lineCov">         39 :       break;</span>
<span class="lineNum">    2819 </span>            : /* Any cases added here also need to go in the gposExtensionSubTable */
<span class="lineNum">    2820 </span>            :       default:
<span class="lineNum">    2821 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Unknown GPOS sub-table type: %d\n&quot;), l-&gt;otlookup-&gt;lookup_type );</span>
<span class="lineNum">    2822 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2823 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2824 </span>            :     }
<span class="lineNum">    2825 </span><span class="lineCov">         96 :     if ( ftell(ttf)&gt;info-&gt;g_bounds ) {</span>
<span class="lineNum">    2826 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Subtable extends beyond end of GPOS table\n&quot;) );</span>
<span class="lineNum">    2827 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2828 </span>            :     }
<a name="2829"><span class="lineNum">    2829 </span><span class="lineCov">         96 : }</span></a>
<span class="lineNum">    2830 </span>            : 
<span class="lineNum">    2831 </span><span class="lineCov">        210 : static void gsubLookupSwitch(FILE *ttf, int st,</span>
<span class="lineNum">    2832 </span>            :         struct ttfinfo *info, struct lookup *l, struct lookup_subtable *subtable, int justinuse,
<span class="lineNum">    2833 </span>            :         struct lookup *alllooks) {
<span class="lineNum">    2834 </span>            : 
<span class="lineNum">    2835 </span><span class="lineCov">        210 :     switch ( l-&gt;type ) {</span>
<span class="lineNum">    2836 </span>            :       case gsub_single:
<span class="lineNum">    2837 </span><span class="lineCov">         59 :         gsubSimpleSubTable(ttf,st,info,l,subtable,justinuse);</span>
<span class="lineNum">    2838 </span><span class="lineCov">         59 :       break;</span>
<span class="lineNum">    2839 </span>            :       case gsub_multiple: case gsub_alternate:  /* Multiple and alternate have same format, different semantics */
<span class="lineNum">    2840 </span><span class="lineNoCov">          0 :         gsubMultipleSubTable(ttf,st,info,l,subtable,justinuse);</span>
<span class="lineNum">    2841 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2842 </span>            :       case gsub_ligature:
<span class="lineNum">    2843 </span><span class="lineCov">         65 :         gsubLigatureSubTable(ttf,st,info,l,subtable,justinuse);</span>
<span class="lineNum">    2844 </span><span class="lineCov">         65 :       break;</span>
<span class="lineNum">    2845 </span>            :       case gsub_context:
<span class="lineNum">    2846 </span><span class="lineCov">         12 :         gsubContextSubTable(ttf,st,info,l,subtable,justinuse,alllooks);</span>
<span class="lineNum">    2847 </span><span class="lineCov">         12 :       break;</span>
<span class="lineNum">    2848 </span>            :       case gsub_contextchain:
<span class="lineNum">    2849 </span><span class="lineCov">         11 :         gsubChainingSubTable(ttf,st,info,l,subtable,justinuse,alllooks);</span>
<span class="lineNum">    2850 </span><span class="lineCov">         11 :       break;</span>
<span class="lineNum">    2851 </span>            :       case 7:
<span class="lineNum">    2852 </span><span class="lineCov">         63 :         gsubExtensionSubTable(ttf,st,info,l,subtable,justinuse,alllooks);</span>
<span class="lineNum">    2853 </span><span class="lineCov">         63 :       break;</span>
<span class="lineNum">    2854 </span>            :       case gsub_reversecchain:
<span class="lineNum">    2855 </span><span class="lineNoCov">          0 :         gsubReverseChainSubTable(ttf,st,info,l,subtable,justinuse);</span>
<span class="lineNum">    2856 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2857 </span>            : /* Any cases added here also need to go in the gsubExtensionSubTable */
<span class="lineNum">    2858 </span>            :       default:
<span class="lineNum">    2859 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Unknown GSUB sub-table type: %d\n&quot;), l-&gt;otlookup-&gt;lookup_type );</span>
<span class="lineNum">    2860 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2861 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2862 </span>            :     }
<span class="lineNum">    2863 </span><span class="lineCov">        210 :     if ( ftell(ttf)&gt;info-&gt;g_bounds ) {</span>
<span class="lineNum">    2864 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Subtable extends beyond end of GSUB table\n&quot; ));</span>
<span class="lineNum">    2865 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    2866 </span>            :     }
<a name="2867"><span class="lineNum">    2867 </span><span class="lineCov">        210 : }</span></a>
<span class="lineNum">    2868 </span>            : 
<span class="lineNum">    2869 </span><span class="lineCov">         35 : static void ScriptsFree(struct scripts *scripts) {</span>
<span class="lineNum">    2870 </span>            :     int i,j;
<span class="lineNum">    2871 </span>            : 
<span class="lineNum">    2872 </span><span class="lineCov">         35 :     if ( scripts==NULL )</span>
<span class="lineNum">    2873 </span><span class="lineCov">         35 : return;</span>
<span class="lineNum">    2874 </span><span class="lineCov">        127 :     for ( i=0; scripts[i].offset!=0 ; ++i ) {</span>
<span class="lineNum">    2875 </span><span class="lineCov">        203 :         for ( j=0; j&lt;scripts[i].langcnt; ++j )</span>
<span class="lineNum">    2876 </span><span class="lineCov">        111 :             free( scripts[i].languages[j].features);</span>
<span class="lineNum">    2877 </span><span class="lineCov">         92 :         free(scripts[i].languages);</span>
<span class="lineNum">    2878 </span>            :     }
<span class="lineNum">    2879 </span><span class="lineCov">         35 :     free(scripts);</span>
<a name="2880"><span class="lineNum">    2880 </span>            : }</a>
<span class="lineNum">    2881 </span>            : 
<span class="lineNum">    2882 </span><span class="lineCov">         35 : static void FeaturesFree(struct feature *features) {</span>
<span class="lineNum">    2883 </span>            :     int i;
<span class="lineNum">    2884 </span>            : 
<span class="lineNum">    2885 </span><span class="lineCov">         35 :     if ( features==NULL )</span>
<span class="lineNum">    2886 </span><span class="lineCov">         36 : return;</span>
<span class="lineNum">    2887 </span><span class="lineCov">        257 :     for ( i=0; features[i].offset!=0 ; ++i )</span>
<span class="lineNum">    2888 </span><span class="lineCov">        223 :         free(features[i].lookups);</span>
<span class="lineNum">    2889 </span><span class="lineCov">         34 :     free(features);</span>
<a name="2890"><span class="lineNum">    2890 </span>            : }</a>
<span class="lineNum">    2891 </span>            : 
<span class="lineNum">    2892 </span><span class="lineCov">         34 : static void LookupsFree(struct lookup *lookups) {</span>
<span class="lineNum">    2893 </span>            :     int i;
<span class="lineNum">    2894 </span>            : 
<span class="lineNum">    2895 </span><span class="lineCov">        329 :     for ( i=0; lookups[i].offset!=0 ; ++i ) {</span>
<span class="lineNum">    2896 </span><span class="lineCov">        295 :         free( lookups[i].subtab_offsets );</span>
<span class="lineNum">    2897 </span>            :     }
<span class="lineNum">    2898 </span><span class="lineCov">         34 :     free(lookups);</span>
<a name="2899"><span class="lineNum">    2899 </span><span class="lineCov">         34 : }</span></a>
<span class="lineNum">    2900 </span>            : 
<span class="lineNum">    2901 </span><span class="lineCov">         35 : static void ProcessGPOSGSUB(FILE *ttf,struct ttfinfo *info,int gpos,int inusetype) {</span>
<span class="lineNum">    2902 </span>            :     int k;
<span class="lineNum">    2903 </span>            :     int32 base, lookup_start, st;
<span class="lineNum">    2904 </span>            :     int32 script_off, feature_off;
<span class="lineNum">    2905 </span>            :     struct scripts *scripts;
<span class="lineNum">    2906 </span>            :     struct feature *features;
<span class="lineNum">    2907 </span>            :     struct lookup *lookups, *l;
<span class="lineNum">    2908 </span>            :     struct lookup_subtable *subtable;
<span class="lineNum">    2909 </span>            : 
<span class="lineNum">    2910 </span><span class="lineCov">         35 :     if ( gpos ) {</span>
<span class="lineNum">    2911 </span><span class="lineCov">         14 :         base = info-&gt;gpos_start;</span>
<span class="lineNum">    2912 </span><span class="lineCov">         14 :         info-&gt;g_bounds = base + info-&gt;gpos_length;</span>
<span class="lineNum">    2913 </span>            :     } else {
<span class="lineNum">    2914 </span><span class="lineCov">         21 :         base = info-&gt;gsub_start;</span>
<span class="lineNum">    2915 </span><span class="lineCov">         21 :         info-&gt;g_bounds = base + info-&gt;gsub_length;</span>
<span class="lineNum">    2916 </span>            :     }
<span class="lineNum">    2917 </span><span class="lineCov">         35 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    2918 </span><span class="lineCov">         35 :     /* version = */ getlong(ttf);</span>
<span class="lineNum">    2919 </span><span class="lineCov">         35 :     script_off = getushort(ttf);</span>
<span class="lineNum">    2920 </span><span class="lineCov">         35 :     feature_off = getushort(ttf);</span>
<span class="lineNum">    2921 </span><span class="lineCov">         35 :     lookup_start = base+getushort(ttf);</span>
<span class="lineNum">    2922 </span>            : 
<span class="lineNum">    2923 </span><span class="lineCov">         35 :     scripts = readttfscripts(ttf,base+script_off,info,gpos);</span>
<span class="lineNum">    2924 </span><span class="lineCov">         35 :     features = readttffeatures(ttf,base+feature_off,gpos,info);</span>
<span class="lineNum">    2925 </span>            :     /* It is legal to have lookups with no features or scripts */
<span class="lineNum">    2926 </span>            :     /* For example if all the lookups were controlled by the JSTF table */
<span class="lineNum">    2927 </span><span class="lineCov">         35 :     lookups = readttflookups(ttf,lookup_start,info,gpos);</span>
<span class="lineNum">    2928 </span><span class="lineCov">         35 :     if ( lookups==NULL ) {</span>
<span class="lineNum">    2929 </span><span class="lineCov">          1 :         ScriptsFree(scripts);</span>
<span class="lineNum">    2930 </span><span class="lineCov">          1 :         FeaturesFree(features);</span>
<span class="lineNum">    2931 </span><span class="lineCov">         36 : return;</span>
<span class="lineNum">    2932 </span>            :     }
<span class="lineNum">    2933 </span><span class="lineCov">         34 :     tagLookupsWithScript(scripts,features,lookups,info);</span>
<span class="lineNum">    2934 </span><span class="lineCov">         34 :     ScriptsFree(scripts); scripts = NULL;</span>
<span class="lineNum">    2935 </span><span class="lineCov">         34 :     FeaturesFree(features); features = NULL;</span>
<span class="lineNum">    2936 </span>            : 
<span class="lineNum">    2937 </span><span class="lineCov">        329 :     for ( l = lookups; l-&gt;offset!=0; ++l ) {</span>
<span class="lineNum">    2938 </span><span class="lineCov">        601 :         for ( k=0, subtable=l-&gt;otlookup-&gt;subtables; k&lt;l-&gt;subtabcnt; ++k, subtable=subtable-&gt;next ) {</span>
<span class="lineNum">    2939 </span><span class="lineCov">        306 :             st = l-&gt;subtab_offsets[k];</span>
<span class="lineNum">    2940 </span><span class="lineCov">        306 :             fseek(ttf,st,SEEK_SET);</span>
<span class="lineNum">    2941 </span><span class="lineCov">        306 :             if ( gpos ) {</span>
<span class="lineNum">    2942 </span><span class="lineCov">         96 :                 gposLookupSwitch(ttf,st,info,l,subtable,lookups);</span>
<span class="lineNum">    2943 </span>            :             } else {
<span class="lineNum">    2944 </span><span class="lineCov">        210 :                 gsubLookupSwitch(ttf,st,info,l,subtable,inusetype,lookups);</span>
<span class="lineNum">    2945 </span>            :             }
<span class="lineNum">    2946 </span>            :         }
<span class="lineNum">    2947 </span>            :     }
<span class="lineNum">    2948 </span>            : 
<span class="lineNum">    2949 </span>            :     /* Then generate some user-friendly names for the all the lookups */
<span class="lineNum">    2950 </span><span class="lineCov">         34 :     if ( inusetype==git_normal )</span>
<span class="lineNum">    2951 </span><span class="lineCov">        274 :         for ( l=lookups; l-&gt;offset!=0; ++l )</span>
<span class="lineNum">    2952 </span><span class="lineCov">        247 :             NameOTLookup(l-&gt;otlookup,NULL);</span>
<span class="lineNum">    2953 </span>            : 
<span class="lineNum">    2954 </span><span class="lineCov">         34 :     LookupsFree(lookups);</span>
<span class="lineNum">    2955 </span><span class="lineCov">         34 :     if ( inusetype!=git_normal &amp;&amp; !gpos ) {</span>
<span class="lineNum">    2956 </span><span class="lineCov">          7 :         OTLookupListFree(info-&gt;gsub_lookups);</span>
<span class="lineNum">    2957 </span><span class="lineCov">          7 :         info-&gt;gsub_lookups = info-&gt;cur_lookups = NULL;</span>
<span class="lineNum">    2958 </span>            :     }
<a name="2959"><span class="lineNum">    2959 </span>            : }</a>
<span class="lineNum">    2960 </span>            : 
<span class="lineNum">    2961 </span><span class="lineCov">          3 : void readttfgsubUsed(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    2962 </span><span class="lineCov">          3 :     ProcessGPOSGSUB(ttf,info,false,git_justinuse);</span>
<span class="lineNum">    2963 </span><span class="lineCov">          3 :     info-&gt;g_bounds = 0;</span>
<a name="2964"><span class="lineNum">    2964 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">    2965 </span>            : 
<span class="lineNum">    2966 </span><span class="lineCov">          4 : void GuessNamesFromGSUB(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    2967 </span><span class="lineCov">          4 :     ProcessGPOSGSUB(ttf,info,false,git_findnames);</span>
<span class="lineNum">    2968 </span><span class="lineCov">          4 :     info-&gt;g_bounds = 0;</span>
<a name="2969"><span class="lineNum">    2969 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">    2970 </span>            : 
<span class="lineNum">    2971 </span><span class="lineCov">         28 : void readttfgpossub(FILE *ttf,struct ttfinfo *info,int gpos) {</span>
<span class="lineNum">    2972 </span><span class="lineCov">         28 :     ProcessGPOSGSUB(ttf,info,gpos,git_normal);</span>
<span class="lineNum">    2973 </span><span class="lineCov">         28 :     info-&gt;g_bounds = 0;</span>
<a name="2974"><span class="lineNum">    2974 </span><span class="lineCov">         28 : }</span></a>
<span class="lineNum">    2975 </span>            : 
<span class="lineNum">    2976 </span><span class="lineCov">         15 : void readttfgdef(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    2977 </span><span class="lineCov">         15 :     int lclo, gclass, mac, mas=0;</span>
<span class="lineNum">    2978 </span>            :     int coverage, cnt, i,j, format;
<span class="lineNum">    2979 </span>            :     int version;
<span class="lineNum">    2980 </span>            :     uint16 *glyphs, *lc_offsets, *offsets;
<span class="lineNum">    2981 </span>            :     uint32 caret_base;
<span class="lineNum">    2982 </span>            :     PST *pst;
<span class="lineNum">    2983 </span>            :     SplineChar *sc;
<span class="lineNum">    2984 </span>            : 
<span class="lineNum">    2985 </span><span class="lineCov">         15 :     fseek(ttf,info-&gt;gdef_start,SEEK_SET);</span>
<span class="lineNum">    2986 </span><span class="lineCov">         15 :     version = getlong(ttf);</span>
<span class="lineNum">    2987 </span><span class="lineCov">         15 :     if ( version!=0x00010000 &amp;&amp; version != 0x00010002 )</span>
<span class="lineNum">    2988 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    2989 </span><span class="lineCov">         15 :     info-&gt;g_bounds = info-&gt;gdef_start + info-&gt;gdef_length;</span>
<span class="lineNum">    2990 </span><span class="lineCov">         15 :     gclass = getushort(ttf);</span>
<span class="lineNum">    2991 </span><span class="lineCov">         15 :     /* attach list = */ getushort(ttf);</span>
<span class="lineNum">    2992 </span><span class="lineCov">         15 :     lclo = getushort(ttf);              /* ligature caret list */</span>
<span class="lineNum">    2993 </span><span class="lineCov">         15 :     mac = getushort(ttf);               /* mark attach class */</span>
<span class="lineNum">    2994 </span><span class="lineCov">         15 :     if ( version==0x00010002 )</span>
<span class="lineNum">    2995 </span><span class="lineNoCov">          0 :         mas = getushort(ttf);</span>
<span class="lineNum">    2996 </span>            : 
<span class="lineNum">    2997 </span><span class="lineCov">         15 :     if ( gclass!=0 ) {</span>
<span class="lineNum">    2998 </span><span class="lineCov">         15 :         uint16 *gclasses = getClassDefTable(ttf,info-&gt;gdef_start+gclass, info);</span>
<span class="lineNum">    2999 </span><span class="lineCov">      16211 :         for ( i=0; i&lt;info-&gt;glyph_cnt; ++i )</span>
<span class="lineNum">    3000 </span><span class="lineCov">      16196 :             if ( info-&gt;chars[i]!=NULL &amp;&amp; gclasses[i]!=0 )</span>
<span class="lineNum">    3001 </span><span class="lineCov">      16171 :                 info-&gt;chars[i]-&gt;glyph_class = gclasses[i]+1;</span>
<span class="lineNum">    3002 </span><span class="lineCov">         15 :         free(gclasses);</span>
<span class="lineNum">    3003 </span>            :     }
<span class="lineNum">    3004 </span>            : 
<span class="lineNum">    3005 </span><span class="lineCov">         15 :     if ( mac!=0 ) {</span>
<span class="lineNum">    3006 </span><span class="lineCov">          3 :         uint16 *mclasses = getClassDefTable(ttf,info-&gt;gdef_start+mac, info);</span>
<span class="lineNum">    3007 </span><span class="lineCov">          3 :         const char *format_spec = _(&quot;MarkClass-%d&quot;);</span>
<span class="lineNum">    3008 </span><span class="lineCov">          3 :         info-&gt;mark_class_cnt = ClassFindCnt(mclasses,info-&gt;glyph_cnt);</span>
<span class="lineNum">    3009 </span><span class="lineCov">          3 :         info-&gt;mark_classes = ClassToNames(info,info-&gt;mark_class_cnt,mclasses,info-&gt;glyph_cnt);</span>
<span class="lineNum">    3010 </span><span class="lineCov">          3 :         info-&gt;mark_class_names = malloc(info-&gt;mark_class_cnt*sizeof(char *));</span>
<span class="lineNum">    3011 </span><span class="lineCov">          3 :         info-&gt;mark_class_names[0] = NULL;</span>
<span class="lineNum">    3012 </span><span class="lineCov">         12 :         for ( i=1; i&lt;info-&gt;mark_class_cnt; ++i ) {</span>
<span class="lineNum">    3013 </span><span class="lineCov">          9 :             info-&gt;mark_class_names[i] = malloc((strlen(format_spec)+10));</span>
<span class="lineNum">    3014 </span><span class="lineCov">          9 :             sprintf( info-&gt;mark_class_names[i], format_spec, i );</span>
<span class="lineNum">    3015 </span>            :         }
<span class="lineNum">    3016 </span><span class="lineCov">          3 :         free(mclasses);</span>
<span class="lineNum">    3017 </span>            :     }
<span class="lineNum">    3018 </span><span class="lineCov">         15 :     if ( mas!=0 ) {</span>
<span class="lineNum">    3019 </span><span class="lineNoCov">          0 :         const char *format_spec = _(&quot;MarkSet-%d&quot;);</span>
<span class="lineNum">    3020 </span><span class="lineNoCov">          0 :         fseek(ttf,info-&gt;gdef_start+mas,SEEK_SET);</span>
<span class="lineNum">    3021 </span><span class="lineNoCov">          0 :         if ( getushort(ttf)==1 ) {      /* Version number of Mark GLyph Sets Table */</span>
<span class="lineNum">    3022 </span>            :             uint32 *offsets;
<span class="lineNum">    3023 </span>            :             uint16 *glyphs;
<span class="lineNum">    3024 </span><span class="lineNoCov">          0 :             info-&gt;mark_set_cnt = getushort(ttf);</span>
<span class="lineNum">    3025 </span><span class="lineNoCov">          0 :             offsets = malloc(info-&gt;mark_set_cnt*sizeof(uint32));</span>
<span class="lineNum">    3026 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;info-&gt;mark_set_cnt; ++i )</span>
<span class="lineNum">    3027 </span><span class="lineNoCov">          0 :                 offsets[i]=getlong(ttf);</span>
<span class="lineNum">    3028 </span><span class="lineNoCov">          0 :             info-&gt;mark_sets = malloc(info-&gt;mark_set_cnt*sizeof(char *));</span>
<span class="lineNum">    3029 </span><span class="lineNoCov">          0 :             info-&gt;mark_set_names = malloc(info-&gt;mark_set_cnt*sizeof(char *));</span>
<span class="lineNum">    3030 </span><span class="lineNoCov">          0 :             info-&gt;mark_set_names[0] = NULL;</span>
<span class="lineNum">    3031 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;info-&gt;mark_set_cnt; ++i ) {</span>
<span class="lineNum">    3032 </span><span class="lineNoCov">          0 :                 info-&gt;mark_set_names[i] = malloc((strlen(format_spec)+10));</span>
<span class="lineNum">    3033 </span><span class="lineNoCov">          0 :                 sprintf( info-&gt;mark_set_names[i], format_spec, i );</span>
<span class="lineNum">    3034 </span><span class="lineNoCov">          0 :                 if ( offsets[i]!=0 ) {</span>
<span class="lineNum">    3035 </span><span class="lineNoCov">          0 :                     glyphs = getCoverageTable(ttf,info-&gt;gdef_start+mas+offsets[i],info);</span>
<span class="lineNum">    3036 </span><span class="lineNoCov">          0 :                     info-&gt;mark_sets[i] = GlyphsToNames(info,glyphs,true);</span>
<span class="lineNum">    3037 </span><span class="lineNoCov">          0 :                     free(glyphs);</span>
<span class="lineNum">    3038 </span>            :                 } else
<span class="lineNum">    3039 </span><span class="lineNoCov">          0 :                     info-&gt;mark_sets[i] = NULL;               /* Should not happen */</span>
<span class="lineNum">    3040 </span>            :             }
<span class="lineNum">    3041 </span><span class="lineNoCov">          0 :             free(offsets);</span>
<span class="lineNum">    3042 </span>            :         }
<span class="lineNum">    3043 </span>            :     }
<span class="lineNum">    3044 </span>            : 
<span class="lineNum">    3045 </span><span class="lineCov">         15 :     if ( lclo!=0 ) {</span>
<span class="lineNum">    3046 </span><span class="lineCov">         15 :         lclo += info-&gt;gdef_start;</span>
<span class="lineNum">    3047 </span><span class="lineCov">         15 :         fseek(ttf,lclo,SEEK_SET);</span>
<span class="lineNum">    3048 </span><span class="lineCov">         15 :         coverage = getushort(ttf);</span>
<span class="lineNum">    3049 </span><span class="lineCov">         15 :         cnt = getushort(ttf);</span>
<span class="lineNum">    3050 </span><span class="lineCov">         15 :         if ( cnt==0 )</span>
<span class="lineNum">    3051 </span><span class="lineCov">         12 : return;</span>
<span class="lineNum">    3052 </span><span class="lineCov">          3 :         lc_offsets = malloc(cnt*sizeof(uint16));</span>
<span class="lineNum">    3053 </span><span class="lineCov">         15 :         for ( i=0; i&lt;cnt; ++i )</span>
<span class="lineNum">    3054 </span><span class="lineCov">         12 :             lc_offsets[i]=getushort(ttf);</span>
<span class="lineNum">    3055 </span><span class="lineCov">          3 :         glyphs = getCoverageTable(ttf,lclo+coverage,info);</span>
<span class="lineNum">    3056 </span><span class="lineCov">          3 :         if ( glyphs==NULL ) {</span>
<span class="lineNum">    3057 </span><span class="lineNoCov">          0 :         free(lc_offsets);</span>
<span class="lineNum">    3058 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    3059 </span>            :     }
<span class="lineNum">    3060 </span><span class="lineCov">         15 :         for ( i=0; i&lt;cnt; ++i ) if ( glyphs[i]&lt;info-&gt;glyph_cnt &amp;&amp; (sc = info-&gt;chars[glyphs[i]])!=NULL ) {</span>
<span class="lineNum">    3061 </span><span class="lineCov">         12 :             fseek(ttf,lclo+lc_offsets[i],SEEK_SET);</span>
<span class="lineNum">    3062 </span><span class="lineCov">         12 :             for ( pst=sc-&gt;possub; pst!=NULL &amp;&amp; pst-&gt;type!=pst_lcaret; pst=pst-&gt;next );</span>
<span class="lineNum">    3063 </span><span class="lineCov">         12 :             if ( pst==NULL ) {</span>
<span class="lineNum">    3064 </span><span class="lineCov">         12 :                 pst = chunkalloc(sizeof(PST));</span>
<span class="lineNum">    3065 </span><span class="lineCov">         12 :                 pst-&gt;next = sc-&gt;possub;</span>
<span class="lineNum">    3066 </span><span class="lineCov">         12 :                 sc-&gt;possub = pst;</span>
<span class="lineNum">    3067 </span><span class="lineCov">         12 :                 pst-&gt;type = pst_lcaret;</span>
<span class="lineNum">    3068 </span><span class="lineCov">         12 :                 pst-&gt;subtable = NULL;</span>
<span class="lineNum">    3069 </span><span class="lineCov">         12 :                 sc-&gt;lig_caret_cnt_fixed = true;</span>
<span class="lineNum">    3070 </span>            :             }
<span class="lineNum">    3071 </span><span class="lineCov">         12 :             caret_base = ftell(ttf);</span>
<span class="lineNum">    3072 </span><span class="lineCov">         12 :             pst-&gt;u.lcaret.cnt = getushort(ttf);</span>
<span class="lineNum">    3073 </span><span class="lineCov">         12 :             free(pst-&gt;u.lcaret.carets);</span>
<span class="lineNum">    3074 </span><span class="lineCov">         12 :             offsets = malloc(pst-&gt;u.lcaret.cnt*sizeof(uint16));</span>
<span class="lineNum">    3075 </span><span class="lineCov">         30 :             for ( j=0; j&lt;pst-&gt;u.lcaret.cnt; ++j )</span>
<span class="lineNum">    3076 </span><span class="lineCov">         18 :                 offsets[j] = getushort(ttf);</span>
<span class="lineNum">    3077 </span><span class="lineCov">         12 :             pst-&gt;u.lcaret.carets = malloc(pst-&gt;u.lcaret.cnt*sizeof(int16));</span>
<span class="lineNum">    3078 </span><span class="lineCov">         30 :             for ( j=0; j&lt;pst-&gt;u.lcaret.cnt; ++j ) {</span>
<span class="lineNum">    3079 </span><span class="lineCov">         18 :                 fseek(ttf,caret_base+offsets[j],SEEK_SET);</span>
<span class="lineNum">    3080 </span><span class="lineCov">         18 :                 format=getushort(ttf);</span>
<span class="lineNum">    3081 </span><span class="lineCov">         18 :                 if ( format==1 ) {</span>
<span class="lineNum">    3082 </span><span class="lineCov">         18 :                     pst-&gt;u.lcaret.carets[j] = getushort(ttf);</span>
<span class="lineNum">    3083 </span><span class="lineNoCov">          0 :                 } else if ( format==2 ) {</span>
<span class="lineNum">    3084 </span><span class="lineNoCov">          0 :                     pst-&gt;u.lcaret.carets[j] = 0;</span>
<span class="lineNum">    3085 </span><span class="lineNoCov">          0 :                     /* point = */ getushort(ttf);</span>
<span class="lineNum">    3086 </span><span class="lineNoCov">          0 :                 } else if ( format==3 ) {</span>
<span class="lineNum">    3087 </span><span class="lineNoCov">          0 :                     pst-&gt;u.lcaret.carets[j] = getushort(ttf);</span>
<span class="lineNum">    3088 </span><span class="lineNoCov">          0 :                     /* in device table = */ getushort(ttf);</span>
<span class="lineNum">    3089 </span>            :                 } else {
<span class="lineNum">    3090 </span><span class="lineNoCov">          0 :                     LogError( _(&quot;!!!! Unknown caret format %d !!!!\n&quot;), format );</span>
<span class="lineNum">    3091 </span><span class="lineNoCov">          0 :                     info-&gt;bad_ot = true;</span>
<span class="lineNum">    3092 </span>            :                 }
<span class="lineNum">    3093 </span>            :             }
<span class="lineNum">    3094 </span><span class="lineCov">         12 :             free(offsets);</span>
<span class="lineNum">    3095 </span>            :         }
<span class="lineNum">    3096 </span><span class="lineCov">          3 :         free(lc_offsets);</span>
<span class="lineNum">    3097 </span><span class="lineCov">          3 :         free(glyphs);</span>
<span class="lineNum">    3098 </span>            :     }
<span class="lineNum">    3099 </span><span class="lineCov">          3 :     info-&gt;g_bounds = 0;</span>
<a name="3100"><span class="lineNum">    3100 </span>            : }</a>
<span class="lineNum">    3101 </span>            : 
<span class="lineNum">    3102 </span><span class="lineCov">          4 : static void readttf_applelookup(FILE *ttf,struct ttfinfo *info,</span>
<span class="lineNum">    3103 </span>            :         void (*apply_values)(struct ttfinfo *info, int gfirst, int glast,FILE *ttf),
<span class="lineNum">    3104 </span>            :         void (*apply_value)(struct ttfinfo *info, int gfirst, int glast,FILE *ttf),
<span class="lineNum">    3105 </span>            :         void (*apply_default)(struct ttfinfo *info, int gfirst, int glast,void *def),
<span class="lineNum">    3106 </span>            :         void *def, int allow_out_of_bounds) {
<span class="lineNum">    3107 </span>            :     int format, i, first, last, data_off, cnt, prev;
<span class="lineNum">    3108 </span>            :     uint32 here;
<span class="lineNum">    3109 </span><span class="lineCov">          4 :     uint32 base = ftell(ttf);</span>
<span class="lineNum">    3110 </span>            : 
<span class="lineNum">    3111 </span><span class="lineCov">          4 :     format = getushort(ttf);</span>
<span class="lineNum">    3112 </span><span class="lineCov">          4 :     switch ( format ) {</span>
<span class="lineNum">    3113 </span>            :       case 0:   /* Simple array */
<span class="lineNum">    3114 </span><span class="lineNoCov">          0 :         apply_values(info,0,info-&gt;glyph_cnt-1,ttf);</span>
<span class="lineNum">    3115 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    3116 </span>            :       case 2:   /* Segment Single */
<span class="lineNum">    3117 </span><span class="lineCov">          1 :         /* Entry size  */ getushort(ttf);</span>
<span class="lineNum">    3118 </span><span class="lineCov">          1 :         cnt = getushort(ttf);</span>
<span class="lineNum">    3119 </span><span class="lineCov">          1 :         /* search range */ getushort(ttf);</span>
<span class="lineNum">    3120 </span><span class="lineCov">          1 :         /* log2(cnt)    */ getushort(ttf);</span>
<span class="lineNum">    3121 </span><span class="lineCov">          1 :         /* range shift  */ getushort(ttf);</span>
<span class="lineNum">    3122 </span><span class="lineCov">          1 :         prev = 0;</span>
<span class="lineNum">    3123 </span><span class="lineCov">         55 :         for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    3124 </span><span class="lineCov">         54 :             last = getushort(ttf);</span>
<span class="lineNum">    3125 </span><span class="lineCov">         54 :             first = getushort(ttf);</span>
<span class="lineNum">    3126 </span><span class="lineCov">         54 :             if ( last&lt;first || last&gt;=0xffff ||</span>
<span class="lineNum">    3127 </span><span class="lineCov">         54 :                     (!allow_out_of_bounds &amp;&amp; last&gt;=info-&gt;glyph_cnt )) {</span>
<span class="lineNum">    3128 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad lookup table: format=2 (%d/%d), first=%d last=%d total glyphs in font=%d\n&quot;),</span>
<span class="lineNum">    3129 </span>            :                         i,cnt,first,last,info-&gt;glyph_cnt );
<span class="lineNum">    3130 </span><span class="lineNoCov">          0 :                 info-&gt;bad_gx = true;</span>
<span class="lineNum">    3131 </span>            :             } else {
<span class="lineNum">    3132 </span><span class="lineCov">         54 :                 if ( apply_default!=NULL )</span>
<span class="lineNum">    3133 </span><span class="lineCov">         54 :                     apply_default(info,prev,first-1,def);</span>
<span class="lineNum">    3134 </span><span class="lineCov">         54 :                 apply_value(info,first,last,ttf);</span>
<span class="lineNum">    3135 </span><span class="lineCov">         54 :                 prev = last+1;</span>
<span class="lineNum">    3136 </span>            :             }
<span class="lineNum">    3137 </span>            :         }
<span class="lineNum">    3138 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    3139 </span>            :       case 4:   /* Segment multiple */
<span class="lineNum">    3140 </span><span class="lineCov">          3 :         /* Entry size  */ getushort(ttf);</span>
<span class="lineNum">    3141 </span><span class="lineCov">          3 :         cnt = getushort(ttf);</span>
<span class="lineNum">    3142 </span><span class="lineCov">          3 :         /* search range */ getushort(ttf);</span>
<span class="lineNum">    3143 </span><span class="lineCov">          3 :         /* log2(cnt)    */ getushort(ttf);</span>
<span class="lineNum">    3144 </span><span class="lineCov">          3 :         /* range shift  */ getushort(ttf);</span>
<span class="lineNum">    3145 </span><span class="lineCov">          3 :         prev = 0;</span>
<span class="lineNum">    3146 </span><span class="lineCov">         14 :         for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    3147 </span><span class="lineCov">         11 :             last = getushort(ttf);</span>
<span class="lineNum">    3148 </span><span class="lineCov">         11 :             first = getushort(ttf);</span>
<span class="lineNum">    3149 </span><span class="lineCov">         11 :             data_off = getushort(ttf);</span>
<span class="lineNum">    3150 </span><span class="lineCov">         11 :             if ( last&lt;first || last&gt;=0xffff ||</span>
<span class="lineNum">    3151 </span><span class="lineNoCov">          0 :                     (!allow_out_of_bounds &amp;&amp; last&gt;=info-&gt;glyph_cnt )) {</span>
<span class="lineNum">    3152 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad lookup table: format=4 (%d/%d), first=%d last=%d total glyphs in font=%d\n&quot;),</span>
<span class="lineNum">    3153 </span>            :                         i,cnt,first,last,info-&gt;glyph_cnt );
<span class="lineNum">    3154 </span><span class="lineNoCov">          0 :                 info-&gt;bad_gx = true;</span>
<span class="lineNum">    3155 </span>            :             } else {
<span class="lineNum">    3156 </span><span class="lineCov">         11 :                 here = ftell(ttf);</span>
<span class="lineNum">    3157 </span><span class="lineCov">         11 :                 if ( apply_default!=NULL )</span>
<span class="lineNum">    3158 </span><span class="lineNoCov">          0 :                     apply_default(info,prev,first-1,def);</span>
<span class="lineNum">    3159 </span><span class="lineCov">         11 :                 fseek(ttf,base+data_off,SEEK_SET);</span>
<span class="lineNum">    3160 </span><span class="lineCov">         11 :                 apply_values(info,first,last,ttf);</span>
<span class="lineNum">    3161 </span><span class="lineCov">         11 :                 fseek(ttf,here,SEEK_SET);</span>
<span class="lineNum">    3162 </span><span class="lineCov">         11 :                 prev = last+1;</span>
<span class="lineNum">    3163 </span>            :             }
<span class="lineNum">    3164 </span>            :         }
<span class="lineNum">    3165 </span><span class="lineCov">          3 :       break;</span>
<span class="lineNum">    3166 </span>            :       case 6:   /* Single table */
<span class="lineNum">    3167 </span><span class="lineNoCov">          0 :         /* Entry size  */ getushort(ttf);</span>
<span class="lineNum">    3168 </span><span class="lineNoCov">          0 :         cnt = getushort(ttf);</span>
<span class="lineNum">    3169 </span><span class="lineNoCov">          0 :         /* search range */ getushort(ttf);</span>
<span class="lineNum">    3170 </span><span class="lineNoCov">          0 :         /* log2(cnt)    */ getushort(ttf);</span>
<span class="lineNum">    3171 </span><span class="lineNoCov">          0 :         /* range shift  */ getushort(ttf);</span>
<span class="lineNum">    3172 </span><span class="lineNoCov">          0 :         prev = 0;</span>
<span class="lineNum">    3173 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    3174 </span><span class="lineNoCov">          0 :             first = getushort(ttf);</span>
<span class="lineNum">    3175 </span><span class="lineNoCov">          0 :             if ( first&gt;=0xffff || (!allow_out_of_bounds &amp;&amp; first&gt;=info-&gt;glyph_cnt )) {</span>
<span class="lineNum">    3176 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad lookup table: format=6, first=%d total glyphs in font=%d\n&quot;),</span>
<span class="lineNum">    3177 </span>            :                         first,info-&gt;glyph_cnt );
<span class="lineNum">    3178 </span><span class="lineNoCov">          0 :                 info-&gt;bad_gx = true;</span>
<span class="lineNum">    3179 </span>            :             } else {
<span class="lineNum">    3180 </span><span class="lineNoCov">          0 :                 if ( apply_default!=NULL )</span>
<span class="lineNum">    3181 </span><span class="lineNoCov">          0 :                     apply_default(info,prev,first-1,def);</span>
<span class="lineNum">    3182 </span><span class="lineNoCov">          0 :                 apply_value(info,first,first,ttf);</span>
<span class="lineNum">    3183 </span><span class="lineNoCov">          0 :                 prev = first+1;</span>
<span class="lineNum">    3184 </span>            :             }
<span class="lineNum">    3185 </span>            :         }
<span class="lineNum">    3186 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    3187 </span>            :       case 8:   /* Simple array */
<span class="lineNum">    3188 </span><span class="lineNoCov">          0 :         first = getushort(ttf);</span>
<span class="lineNum">    3189 </span><span class="lineNoCov">          0 :         cnt = getushort(ttf);</span>
<span class="lineNum">    3190 </span><span class="lineNoCov">          0 :         if ( first+cnt&gt;=0xffff || (!allow_out_of_bounds &amp;&amp; first+cnt&gt;=info-&gt;glyph_cnt )) {</span>
<span class="lineNum">    3191 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Bad lookup table: format=8, first=%d cnt=%d total glyphs in font=%d\n&quot;),</span>
<span class="lineNum">    3192 </span>            :                     first,cnt,info-&gt;glyph_cnt );
<span class="lineNum">    3193 </span><span class="lineNoCov">          0 :             info-&gt;bad_gx = true;</span>
<span class="lineNum">    3194 </span>            :         } else {
<span class="lineNum">    3195 </span><span class="lineNoCov">          0 :             if ( apply_default!=NULL ) {</span>
<span class="lineNum">    3196 </span><span class="lineNoCov">          0 :                 apply_default(info,0,first-1,def);</span>
<span class="lineNum">    3197 </span><span class="lineNoCov">          0 :                 apply_default(info,first+cnt,info-&gt;glyph_cnt-1,def);</span>
<span class="lineNum">    3198 </span>            :             }
<span class="lineNum">    3199 </span><span class="lineNoCov">          0 :             apply_values(info,first,first+cnt-1,ttf);</span>
<span class="lineNum">    3200 </span>            :         }
<span class="lineNum">    3201 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    3202 </span>            :       default:
<span class="lineNum">    3203 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Invalid lookup table format. %d\n&quot;), format );</span>
<span class="lineNum">    3204 </span><span class="lineNoCov">          0 :         info-&gt;bad_gx = true;</span>
<span class="lineNum">    3205 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    3206 </span>            :     }
<a name="3207"><span class="lineNum">    3207 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">    3208 </span>            : 
<span class="lineNum">    3209 </span><span class="lineCov">          5 : static void OTLAppend(struct ttfinfo *info,OTLookup *otl,int gpos) {</span>
<span class="lineNum">    3210 </span>            :     OTLookup *prev;
<span class="lineNum">    3211 </span><span class="lineCov">          5 :     int pos=0;</span>
<span class="lineNum">    3212 </span>            : 
<span class="lineNum">    3213 </span><span class="lineCov">          5 :     if ( gpos &amp;&amp; info-&gt;gpos_lookups == NULL )</span>
<span class="lineNum">    3214 </span><span class="lineCov">          1 :         info-&gt;gpos_lookups = otl;</span>
<span class="lineNum">    3215 </span><span class="lineCov">          4 :     else if ( !gpos &amp;&amp; info-&gt;gsub_lookups == NULL )</span>
<span class="lineNum">    3216 </span><span class="lineCov">          1 :         info-&gt;gsub_lookups = otl;</span>
<span class="lineNum">    3217 </span>            :     else {
<span class="lineNum">    3218 </span><span class="lineCov">          3 :         prev = gpos ? info-&gt;gpos_lookups : info-&gt;gsub_lookups;</span>
<span class="lineNum">    3219 </span><span class="lineCov">          3 :         pos = 1;</span>
<span class="lineNum">    3220 </span><span class="lineCov">         13 :         while ( prev-&gt;next!=NULL ) {</span>
<span class="lineNum">    3221 </span><span class="lineCov">          7 :             prev = prev-&gt;next;</span>
<span class="lineNum">    3222 </span><span class="lineCov">          7 :             ++pos;</span>
<span class="lineNum">    3223 </span>            :         }
<span class="lineNum">    3224 </span><span class="lineCov">          3 :         prev-&gt;next = otl;</span>
<span class="lineNum">    3225 </span>            :     }
<span class="lineNum">    3226 </span><span class="lineCov">          5 :     otl-&gt;lookup_index = pos;</span>
<a name="3227"><span class="lineNum">    3227 </span><span class="lineCov">          5 : }</span></a>
<span class="lineNum">    3228 </span>            : 
<span class="lineNum">    3229 </span><span class="lineNoCov">          0 : static void OTLRemove(struct ttfinfo *info,OTLookup *otl,int gpos) {</span>
<span class="lineNum">    3230 </span>            :     /* Remove the most recent lookup. We got bad data and can't use it */
<span class="lineNum">    3231 </span>            :     OTLookup *prev, **base;
<span class="lineNum">    3232 </span>            : 
<span class="lineNum">    3233 </span><span class="lineNoCov">          0 :     base = gpos ? &amp;info-&gt;gpos_lookups : &amp;info-&gt;gsub_lookups;</span>
<span class="lineNum">    3234 </span><span class="lineNoCov">          0 :     if ( *base==otl )</span>
<span class="lineNum">    3235 </span><span class="lineNoCov">          0 :         *base = NULL;</span>
<span class="lineNum">    3236 </span><span class="lineNoCov">          0 :     else if ( *base!=NULL ) {</span>
<span class="lineNum">    3237 </span><span class="lineNoCov">          0 :         for ( prev = *base; prev-&gt;next!=NULL &amp;&amp; prev-&gt;next!=otl; prev = prev-&gt;next );</span>
<span class="lineNum">    3238 </span><span class="lineNoCov">          0 :         prev-&gt;next = NULL;</span>
<span class="lineNum">    3239 </span>            :     }
<span class="lineNum">    3240 </span><span class="lineNoCov">          0 :     OTLookupFree(otl);</span>
<a name="3241"><span class="lineNum">    3241 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    3242 </span>            : 
<span class="lineNum">    3243 </span><span class="lineCov">          4 : static OTLookup *NewMacLookup(struct ttfinfo *info,int gpos) {</span>
<span class="lineNum">    3244 </span>            :     OTLookup *otl;
<span class="lineNum">    3245 </span>            : 
<span class="lineNum">    3246 </span><span class="lineCov">          4 :     otl = chunkalloc(sizeof(OTLookup));</span>
<span class="lineNum">    3247 </span><span class="lineCov">          4 :     otl-&gt;lookup_type = gpos ? kern_statemachine : morx_context;</span>
<span class="lineNum">    3248 </span><span class="lineCov">          4 :     otl-&gt;subtables = chunkalloc(sizeof(struct lookup_subtable));</span>
<span class="lineNum">    3249 </span><span class="lineCov">          4 :     otl-&gt;subtables-&gt;lookup = otl;</span>
<span class="lineNum">    3250 </span><span class="lineCov">          4 :     otl-&gt;features = chunkalloc(sizeof(FeatureScriptLangList));</span>
<span class="lineNum">    3251 </span><span class="lineCov">          4 :     if ( gpos ) {</span>
<span class="lineNum">    3252 </span><span class="lineCov">          1 :         otl-&gt;features-&gt;featuretag = CHR('k','e','r','n');</span>
<span class="lineNum">    3253 </span>            :     } else {
<span class="lineNum">    3254 </span><span class="lineCov">          3 :         otl-&gt;features-&gt;featuretag = (info-&gt;mort_feat&lt;&lt;16) | (info-&gt;mort_setting);</span>
<span class="lineNum">    3255 </span><span class="lineCov">          3 :         otl-&gt;features-&gt;ismac = true;</span>
<span class="lineNum">    3256 </span>            :     }
<span class="lineNum">    3257 </span><span class="lineCov">          4 :     OTLAppend(info,otl,gpos);</span>
<span class="lineNum">    3258 </span><span class="lineCov">          4 : return( otl );</span>
<a name="3259"><span class="lineNum">    3259 </span>            : }</a>
<span class="lineNum">    3260 </span>            : 
<span class="lineNum">    3261 </span><span class="lineCov">          3 : static OTLookup *NewMacSubsLookup(struct ttfinfo *info,OTLookup *parent,</span>
<span class="lineNum">    3262 </span>            :         int nest_index, OTLookup **subs) {
<span class="lineNum">    3263 </span>            :     OTLookup *otl;
<span class="lineNum">    3264 </span>            :     char *name, *format;
<span class="lineNum">    3265 </span>            : 
<span class="lineNum">    3266 </span><span class="lineCov">          3 :     if ( subs[nest_index]!=NULL )</span>
<span class="lineNum">    3267 </span><span class="lineCov">          2 : return( subs[nest_index] );</span>
<span class="lineNum">    3268 </span>            : 
<span class="lineNum">    3269 </span>            :     /* These are nested lookups, only to be activated by a state machine */
<span class="lineNum">    3270 </span>            :     /*  as such they have no feature tags nor scripts of their own. */
<span class="lineNum">    3271 </span><span class="lineCov">          1 :     otl = chunkalloc(sizeof(OTLookup));</span>
<span class="lineNum">    3272 </span><span class="lineCov">          1 :     otl-&gt;lookup_type = gsub_single;</span>
<span class="lineNum">    3273 </span><span class="lineCov">          1 :     otl-&gt;subtables = chunkalloc(sizeof(struct lookup_subtable));</span>
<span class="lineNum">    3274 </span><span class="lineCov">          1 :     otl-&gt;subtables-&gt;lookup = otl;</span>
<span class="lineNum">    3275 </span>            : /* GT: This is to give the name to a nested substitution lookup invoked by */
<span class="lineNum">    3276 </span>            : /* GT: a statemachine. The %s is the name of the statemachine('s lookup) */
<span class="lineNum">    3277 </span>            : /* GT: and the %d is n, where this lookup is the n'th defined for this state */
<span class="lineNum">    3278 </span>            : /* GT: machine */
<span class="lineNum">    3279 </span><span class="lineCov">          1 :     format = _(&quot;%s nested-substitutions %d&quot;);</span>
<span class="lineNum">    3280 </span><span class="lineCov">          1 :     name = malloc(strlen(parent-&gt;lookup_name)+strlen(format)+10);</span>
<span class="lineNum">    3281 </span><span class="lineCov">          1 :     sprintf( name, format, parent-&gt;lookup_name, nest_index );</span>
<span class="lineNum">    3282 </span><span class="lineCov">          1 :     otl-&gt;lookup_name = name;</span>
<span class="lineNum">    3283 </span><span class="lineCov">          1 :     otl-&gt;subtables-&gt;subtable_name = strconcat3(name,&quot; &quot;,_(&quot;subtable&quot;));</span>
<span class="lineNum">    3284 </span><span class="lineCov">          1 :     OTLAppend(info,otl,false);</span>
<span class="lineNum">    3285 </span><span class="lineCov">          1 :     subs[nest_index] = otl;</span>
<span class="lineNum">    3286 </span><span class="lineCov">          1 : return( otl );</span>
<a name="3287"><span class="lineNum">    3287 </span>            : }</a>
<span class="lineNum">    3288 </span>            : 
<span class="lineNum">    3289 </span><span class="lineCov">          4 : static void InfoNameOTLookup(OTLookup *otl,struct ttfinfo *info) {</span>
<span class="lineNum">    3290 </span>            :     SplineFont sf;
<span class="lineNum">    3291 </span>            : 
<span class="lineNum">    3292 </span><span class="lineCov">          4 :     memset(&amp;sf,0,sizeof(sf));</span>
<span class="lineNum">    3293 </span><span class="lineCov">          4 :     sf.features = info-&gt;features;</span>
<span class="lineNum">    3294 </span><span class="lineCov">          4 :     NameOTLookup(otl,&amp;sf);</span>
<a name="3295"><span class="lineNum">    3295 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">    3296 </span>            : 
<span class="lineNum">    3297 </span><span class="lineCov">        895 : static void TTF_SetProp(struct ttfinfo *info,int gnum, int prop) {</span>
<span class="lineNum">    3298 </span>            :     int offset;
<span class="lineNum">    3299 </span>            :     PST *pst;
<span class="lineNum">    3300 </span>            : 
<span class="lineNum">    3301 </span><span class="lineCov">        895 :     if ( gnum&lt;0 || gnum&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    3302 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Glyph out of bounds in 'prop' table %d\n&quot;), gnum );</span>
<span class="lineNum">    3303 </span><span class="lineNoCov">          0 :         info-&gt;bad_gx = true;</span>
<span class="lineNum">    3304 </span><span class="lineCov">        895 : return;</span>
<span class="lineNum">    3305 </span>            :     }
<span class="lineNum">    3306 </span>            : 
<span class="lineNum">    3307 </span><span class="lineCov">        895 :     if ( prop&amp;0x1000 ) {    /* Mirror */</span>
<span class="lineNum">    3308 </span><span class="lineCov">         10 :         offset = (prop&lt;&lt;20)&gt;&gt;28;</span>
<span class="lineNum">    3309 </span><span class="lineCov">         20 :         if ( gnum+offset&gt;=0 &amp;&amp; gnum+offset&lt;info-&gt;glyph_cnt &amp;&amp;</span>
<span class="lineNum">    3310 </span><span class="lineCov">         20 :                 info-&gt;chars[gnum]!=NULL &amp;&amp;</span>
<span class="lineNum">    3311 </span><span class="lineCov">         20 :                 info-&gt;chars[gnum+offset]!=NULL &amp;&amp;</span>
<span class="lineNum">    3312 </span><span class="lineCov">         10 :                 info-&gt;chars[gnum+offset]-&gt;name!=NULL ) {</span>
<span class="lineNum">    3313 </span><span class="lineCov">         10 :             pst = chunkalloc(sizeof(PST));</span>
<span class="lineNum">    3314 </span><span class="lineCov">         10 :             pst-&gt;type = pst_substitution;</span>
<span class="lineNum">    3315 </span><span class="lineCov">         10 :             pst-&gt;subtable = info-&gt;mort_subs_lookup-&gt;subtables;</span>
<span class="lineNum">    3316 </span><span class="lineCov">         10 :             FListAppendScriptLang(info-&gt;mort_subs_lookup-&gt;features,SCScriptFromUnicode(info-&gt;chars[gnum]),</span>
<span class="lineNum">    3317 </span>            :                     DEFAULT_LANG);
<span class="lineNum">    3318 </span><span class="lineCov">         10 :             pst-&gt;next = info-&gt;chars[gnum]-&gt;possub;</span>
<span class="lineNum">    3319 </span><span class="lineCov">         10 :             info-&gt;chars[gnum]-&gt;possub = pst;</span>
<span class="lineNum">    3320 </span><span class="lineCov">         10 :             pst-&gt;u.subs.variant = copy(info-&gt;chars[gnum+offset]-&gt;name);</span>
<span class="lineNum">    3321 </span>            :         }
<span class="lineNum">    3322 </span>            :     }
<a name="3323"><span class="lineNum">    3323 </span>            : }</a>
<span class="lineNum">    3324 </span>            : 
<span class="lineNum">    3325 </span><span class="lineNoCov">          0 : static void prop_apply_values(struct ttfinfo *info, int gfirst, int glast,FILE *ttf) {</span>
<span class="lineNum">    3326 </span>            :     int i;
<span class="lineNum">    3327 </span>            : 
<span class="lineNum">    3328 </span><span class="lineNoCov">          0 :     for ( i=gfirst; i&lt;=glast; ++i )</span>
<span class="lineNum">    3329 </span><span class="lineNoCov">          0 :         TTF_SetProp(info,i, getushort(ttf));</span>
<a name="3330"><span class="lineNum">    3330 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    3331 </span>            : 
<span class="lineNum">    3332 </span><span class="lineCov">         54 : static void prop_apply_value(struct ttfinfo *info, int gfirst, int glast,FILE *ttf) {</span>
<span class="lineNum">    3333 </span>            :     int i;
<span class="lineNum">    3334 </span>            :     int prop;
<span class="lineNum">    3335 </span>            : 
<span class="lineNum">    3336 </span><span class="lineCov">         54 :     prop = getushort(ttf);</span>
<span class="lineNum">    3337 </span><span class="lineCov">        373 :     for ( i=gfirst; i&lt;=glast; ++i )</span>
<span class="lineNum">    3338 </span><span class="lineCov">        319 :         TTF_SetProp(info,i, prop);</span>
<a name="3339"><span class="lineNum">    3339 </span><span class="lineCov">         54 : }</span></a>
<span class="lineNum">    3340 </span>            : 
<span class="lineNum">    3341 </span><span class="lineCov">         54 : static void prop_apply_default(struct ttfinfo *info, int gfirst, int glast,void *def) {</span>
<span class="lineNum">    3342 </span>            :     int def_prop, i;
<span class="lineNum">    3343 </span>            : 
<span class="lineNum">    3344 </span><span class="lineCov">         54 :     def_prop = (intpt) def;</span>
<span class="lineNum">    3345 </span><span class="lineCov">        630 :     for ( i=gfirst; i&lt;=glast; ++i )</span>
<span class="lineNum">    3346 </span><span class="lineCov">        576 :         TTF_SetProp(info,i, def_prop);</span>
<a name="3347"><span class="lineNum">    3347 </span><span class="lineCov">         54 : }</span></a>
<span class="lineNum">    3348 </span>            : 
<span class="lineNum">    3349 </span><span class="lineCov">          1 : void readttfprop(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    3350 </span>            :     int def;
<span class="lineNum">    3351 </span>            : 
<span class="lineNum">    3352 </span><span class="lineCov">          1 :     fseek(ttf,info-&gt;prop_start,SEEK_SET);</span>
<span class="lineNum">    3353 </span>            :     /* The one example that I've got has a wierd version, so I don't check it */
<span class="lineNum">    3354 </span>            :     /*  the three versions that I know about are all pretty much the same, just a few extra flags */
<span class="lineNum">    3355 </span><span class="lineCov">          1 :     /* version = */ getlong(ttf);</span>
<span class="lineNum">    3356 </span><span class="lineCov">          1 :     /* format = */ getushort(ttf);</span>
<span class="lineNum">    3357 </span><span class="lineCov">          1 :     def = getushort(ttf);</span>
<span class="lineNum">    3358 </span><span class="lineCov">          1 :     info-&gt;mort_subs_lookup = NewMacLookup(info,false);</span>
<span class="lineNum">    3359 </span><span class="lineCov">          1 :     info-&gt;mort_subs_lookup-&gt;lookup_type = gsub_single;</span>
<span class="lineNum">    3360 </span><span class="lineCov">          1 :     info-&gt;mort_subs_lookup-&gt;features-&gt;featuretag = CHR('r','t','l','a');</span>
<span class="lineNum">    3361 </span><span class="lineCov">          1 :     info-&gt;mort_subs_lookup-&gt;features-&gt;ismac = false;</span>
<span class="lineNum">    3362 </span><span class="lineCov">          1 :     info-&gt;mort_subs_lookup-&gt;subtables-&gt;per_glyph_pst_or_kern = true;</span>
<span class="lineNum">    3363 </span><span class="lineCov">          1 :     readttf_applelookup(ttf,info,</span>
<span class="lineNum">    3364 </span>            :             prop_apply_values,prop_apply_value,
<span class="lineNum">    3365 </span><span class="lineCov">          1 :             prop_apply_default,(void *) (intpt) def, false);</span>
<span class="lineNum">    3366 </span><span class="lineCov">          1 :     InfoNameOTLookup(info-&gt;mort_subs_lookup,info);</span>
<a name="3367"><span class="lineNum">    3367 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    3368 </span>            : 
<span class="lineNum">    3369 </span><span class="lineNoCov">          0 : static void TTF_SetLcaret(struct ttfinfo *info, int gnum, int offset, FILE *ttf) {</span>
<span class="lineNum">    3370 </span><span class="lineNoCov">          0 :     uint32 here = ftell(ttf);</span>
<span class="lineNum">    3371 </span>            :     PST *pst;
<span class="lineNum">    3372 </span>            :     SplineChar *sc;
<span class="lineNum">    3373 </span>            :     int cnt, i;
<span class="lineNum">    3374 </span>            : 
<span class="lineNum">    3375 </span><span class="lineNoCov">          0 :     if ( gnum&lt;0 || gnum&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    3376 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Glyph out of bounds in 'lcar' table %d\n&quot;), gnum );</span>
<span class="lineNum">    3377 </span><span class="lineNoCov">          0 :         info-&gt;bad_gx = true;</span>
<span class="lineNum">    3378 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3379 </span><span class="lineNoCov">          0 :     } else if ( (sc=info-&gt;chars[gnum])==NULL )</span>
<span class="lineNum">    3380 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3381 </span>            : 
<span class="lineNum">    3382 </span><span class="lineNoCov">          0 :     fseek(ttf,info-&gt;lcar_start+offset,SEEK_SET);</span>
<span class="lineNum">    3383 </span><span class="lineNoCov">          0 :     cnt = getushort(ttf);</span>
<span class="lineNum">    3384 </span><span class="lineNoCov">          0 :     pst = chunkalloc(sizeof(PST));</span>
<span class="lineNum">    3385 </span><span class="lineNoCov">          0 :     pst-&gt;type = pst_lcaret;</span>
<span class="lineNum">    3386 </span><span class="lineNoCov">          0 :     pst-&gt;subtable = NULL;</span>
<span class="lineNum">    3387 </span><span class="lineNoCov">          0 :     pst-&gt;next = sc-&gt;possub;</span>
<span class="lineNum">    3388 </span><span class="lineNoCov">          0 :     sc-&gt;possub = pst;</span>
<span class="lineNum">    3389 </span><span class="lineNoCov">          0 :     sc-&gt;lig_caret_cnt_fixed = true;</span>
<span class="lineNum">    3390 </span><span class="lineNoCov">          0 :     pst-&gt;u.lcaret.cnt = cnt;</span>
<span class="lineNum">    3391 </span><span class="lineNoCov">          0 :     pst-&gt;u.lcaret.carets = malloc(cnt*sizeof(uint16));</span>
<span class="lineNum">    3392 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cnt; ++i )</span>
<span class="lineNum">    3393 </span><span class="lineNoCov">          0 :         pst-&gt;u.lcaret.carets[i] = getushort(ttf);</span>
<span class="lineNum">    3394 </span><span class="lineNoCov">          0 :     fseek(ttf,here,SEEK_SET);</span>
<a name="3395"><span class="lineNum">    3395 </span>            : }</a>
<span class="lineNum">    3396 </span>            : 
<span class="lineNum">    3397 </span><span class="lineNoCov">          0 : static void lcar_apply_values(struct ttfinfo *info, int gfirst, int glast,FILE *ttf) {</span>
<span class="lineNum">    3398 </span>            :     int i;
<span class="lineNum">    3399 </span>            : 
<span class="lineNum">    3400 </span><span class="lineNoCov">          0 :     for ( i=gfirst; i&lt;=glast; ++i )</span>
<span class="lineNum">    3401 </span><span class="lineNoCov">          0 :         TTF_SetLcaret(info,i, getushort(ttf), ttf);</span>
<a name="3402"><span class="lineNum">    3402 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    3403 </span>            : 
<span class="lineNum">    3404 </span><span class="lineNoCov">          0 : static void lcar_apply_value(struct ttfinfo *info, int gfirst, int glast,FILE *ttf) {</span>
<span class="lineNum">    3405 </span>            :     int i;
<span class="lineNum">    3406 </span>            :     int offset;
<span class="lineNum">    3407 </span>            : 
<span class="lineNum">    3408 </span><span class="lineNoCov">          0 :     offset = getushort(ttf);</span>
<span class="lineNum">    3409 </span><span class="lineNoCov">          0 :     for ( i=gfirst; i&lt;=glast; ++i )</span>
<span class="lineNum">    3410 </span><span class="lineNoCov">          0 :         TTF_SetLcaret(info,i, offset, ttf);</span>
<a name="3411"><span class="lineNum">    3411 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    3412 </span>            :     
<span class="lineNum">    3413 </span><span class="lineNoCov">          0 : void readttflcar(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    3414 </span>            : 
<span class="lineNum">    3415 </span><span class="lineNoCov">          0 :     fseek(ttf,info-&gt;lcar_start,SEEK_SET);</span>
<span class="lineNum">    3416 </span><span class="lineNoCov">          0 :     /* version = */ getlong(ttf);</span>
<span class="lineNum">    3417 </span><span class="lineNoCov">          0 :     if ( getushort(ttf)!=0 )    /* A format type of 1 has the caret locations */</span>
<span class="lineNum">    3418 </span><span class="lineNoCov">          0 : return;                         /*  indicated by points */</span>
<span class="lineNum">    3419 </span><span class="lineNoCov">          0 :     readttf_applelookup(ttf,info,</span>
<span class="lineNum">    3420 </span>            :             lcar_apply_values,lcar_apply_value,NULL,NULL,false);
<a name="3421"><span class="lineNum">    3421 </span>            : }</a>
<span class="lineNum">    3422 </span>            : 
<span class="lineNum">    3423 </span><span class="lineNoCov">          0 : static void TTF_SetOpticalBounds(struct ttfinfo *info, int gnum, int left, int right) {</span>
<span class="lineNum">    3424 </span>            :     PST *pst;
<span class="lineNum">    3425 </span>            :     SplineChar *sc;
<span class="lineNum">    3426 </span>            : 
<span class="lineNum">    3427 </span><span class="lineNoCov">          0 :     if ( left==0 &amp;&amp; right==0 )</span>
<span class="lineNum">    3428 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3429 </span>            : 
<span class="lineNum">    3430 </span><span class="lineNoCov">          0 :     if ( gnum&lt;0 || gnum&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    3431 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Glyph out of bounds in 'opbd' table %d\n&quot;), gnum );</span>
<span class="lineNum">    3432 </span><span class="lineNoCov">          0 :         info-&gt;bad_gx = true;</span>
<span class="lineNum">    3433 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3434 </span><span class="lineNoCov">          0 :     } else if ( (sc=info-&gt;chars[gnum])==NULL )</span>
<span class="lineNum">    3435 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3436 </span>            : 
<span class="lineNum">    3437 </span><span class="lineNoCov">          0 :     if ( left!=0 ) {</span>
<span class="lineNum">    3438 </span><span class="lineNoCov">          0 :         pst = chunkalloc(sizeof(PST));</span>
<span class="lineNum">    3439 </span><span class="lineNoCov">          0 :         pst-&gt;type = pst_position;</span>
<span class="lineNum">    3440 </span><span class="lineNoCov">          0 :         pst-&gt;subtable = info-&gt;mort_subs_lookup-&gt;subtables;</span>
<span class="lineNum">    3441 </span><span class="lineNoCov">          0 :         FListAppendScriptLang(info-&gt;mort_subs_lookup-&gt;features,SCScriptFromUnicode(sc),</span>
<span class="lineNum">    3442 </span>            :                 DEFAULT_LANG);
<span class="lineNum">    3443 </span><span class="lineNoCov">          0 :         pst-&gt;next = sc-&gt;possub;</span>
<span class="lineNum">    3444 </span><span class="lineNoCov">          0 :         sc-&gt;possub = pst;</span>
<span class="lineNum">    3445 </span><span class="lineNoCov">          0 :         pst-&gt;u.pos.xoff = left;</span>
<span class="lineNum">    3446 </span><span class="lineNoCov">          0 :         pst-&gt;u.pos.h_adv_off = left;</span>
<span class="lineNum">    3447 </span>            :     }
<span class="lineNum">    3448 </span><span class="lineNoCov">          0 :     if ( right!=0 ) {</span>
<span class="lineNum">    3449 </span><span class="lineNoCov">          0 :         pst = chunkalloc(sizeof(PST));</span>
<span class="lineNum">    3450 </span><span class="lineNoCov">          0 :         pst-&gt;type = pst_position;</span>
<span class="lineNum">    3451 </span><span class="lineNoCov">          0 :         pst-&gt;subtable = info-&gt;mort_pos_lookup2-&gt;subtables;</span>
<span class="lineNum">    3452 </span><span class="lineNoCov">          0 :         FListAppendScriptLang(info-&gt;mort_pos_lookup2-&gt;features,SCScriptFromUnicode(sc),</span>
<span class="lineNum">    3453 </span>            :                 DEFAULT_LANG);
<span class="lineNum">    3454 </span><span class="lineNoCov">          0 :         pst-&gt;next = sc-&gt;possub;</span>
<span class="lineNum">    3455 </span><span class="lineNoCov">          0 :         sc-&gt;possub = pst;</span>
<span class="lineNum">    3456 </span><span class="lineNoCov">          0 :         pst-&gt;u.pos.h_adv_off = -right;</span>
<span class="lineNum">    3457 </span>            :     }
<a name="3458"><span class="lineNum">    3458 </span>            : }</a>
<span class="lineNum">    3459 </span>            : 
<span class="lineNum">    3460 </span><span class="lineNoCov">          0 : static void opbd_apply_values(struct ttfinfo *info, int gfirst, int glast,FILE *ttf) {</span>
<span class="lineNum">    3461 </span>            :     int i, left, right, offset;
<span class="lineNum">    3462 </span>            :     uint32 here;
<span class="lineNum">    3463 </span>            : 
<span class="lineNum">    3464 </span><span class="lineNoCov">          0 :     for ( i=gfirst; i&lt;=glast; ++i ) {</span>
<span class="lineNum">    3465 </span><span class="lineNoCov">          0 :         offset = getushort(ttf);</span>
<span class="lineNum">    3466 </span><span class="lineNoCov">          0 :         here = ftell(ttf);</span>
<span class="lineNum">    3467 </span><span class="lineNoCov">          0 :         fseek(ttf,info-&gt;opbd_start+6/*opbd header*/+offset,SEEK_SET);</span>
<span class="lineNum">    3468 </span><span class="lineNoCov">          0 :         left = (int16) getushort(ttf);</span>
<span class="lineNum">    3469 </span><span class="lineNoCov">          0 :         /* top = (int16) */ getushort(ttf);</span>
<span class="lineNum">    3470 </span><span class="lineNoCov">          0 :         right = (int16) getushort(ttf);</span>
<span class="lineNum">    3471 </span><span class="lineNoCov">          0 :         /* bottom = (int16) */ getushort(ttf);</span>
<span class="lineNum">    3472 </span><span class="lineNoCov">          0 :         fseek(ttf,here,SEEK_SET);</span>
<span class="lineNum">    3473 </span><span class="lineNoCov">          0 :         TTF_SetOpticalBounds(info,i, left, right);</span>
<span class="lineNum">    3474 </span>            :     }
<a name="3475"><span class="lineNum">    3475 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    3476 </span>            : 
<span class="lineNum">    3477 </span><span class="lineNoCov">          0 : static void opbd_apply_value(struct ttfinfo *info, int gfirst, int glast,FILE *ttf) {</span>
<span class="lineNum">    3478 </span>            :     int i, left, right, offset;
<span class="lineNum">    3479 </span>            :     uint32 here;
<span class="lineNum">    3480 </span>            : 
<span class="lineNum">    3481 </span><span class="lineNoCov">          0 :     offset = getushort(ttf);</span>
<span class="lineNum">    3482 </span><span class="lineNoCov">          0 :     here = ftell(ttf);</span>
<span class="lineNum">    3483 </span><span class="lineNoCov">          0 :     fseek(ttf,info-&gt;opbd_start+offset,SEEK_SET);</span>
<span class="lineNum">    3484 </span><span class="lineNoCov">          0 :     left = (int16) getushort(ttf);</span>
<span class="lineNum">    3485 </span><span class="lineNoCov">          0 :     /* top = (int16) */ getushort(ttf);</span>
<span class="lineNum">    3486 </span><span class="lineNoCov">          0 :     right = (int16) getushort(ttf);</span>
<span class="lineNum">    3487 </span><span class="lineNoCov">          0 :     /* bottom = (int16) */ getushort(ttf);</span>
<span class="lineNum">    3488 </span><span class="lineNoCov">          0 :     fseek(ttf,here,SEEK_SET);</span>
<span class="lineNum">    3489 </span>            : 
<span class="lineNum">    3490 </span><span class="lineNoCov">          0 :     for ( i=gfirst; i&lt;=glast; ++i )</span>
<span class="lineNum">    3491 </span><span class="lineNoCov">          0 :         TTF_SetOpticalBounds(info,i, left, right);</span>
<a name="3492"><span class="lineNum">    3492 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    3493 </span>            :     
<span class="lineNum">    3494 </span><span class="lineNoCov">          0 : void readttfopbd(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    3495 </span>            : 
<span class="lineNum">    3496 </span><span class="lineNoCov">          0 :     fseek(ttf,info-&gt;opbd_start,SEEK_SET);</span>
<span class="lineNum">    3497 </span><span class="lineNoCov">          0 :     /* version = */ getlong(ttf);</span>
<span class="lineNum">    3498 </span><span class="lineNoCov">          0 :     if ( getushort(ttf)!=0 )    /* A format type of 1 has the bounds */</span>
<span class="lineNum">    3499 </span><span class="lineNoCov">          0 : return;                         /*  indicated by points */</span>
<span class="lineNum">    3500 </span><span class="lineNoCov">          0 :     info-&gt;mort_subs_lookup = NewMacLookup(info,true);</span>
<span class="lineNum">    3501 </span><span class="lineNoCov">          0 :     info-&gt;mort_subs_lookup-&gt;lookup_type = gpos_single;</span>
<span class="lineNum">    3502 </span><span class="lineNoCov">          0 :     info-&gt;mort_subs_lookup-&gt;features-&gt;featuretag = CHR('l','f','b','d');</span>
<span class="lineNum">    3503 </span><span class="lineNoCov">          0 :     info-&gt;mort_subs_lookup-&gt;features-&gt;ismac = false;</span>
<span class="lineNum">    3504 </span><span class="lineNoCov">          0 :     info-&gt;mort_subs_lookup-&gt;subtables-&gt;per_glyph_pst_or_kern = true;</span>
<span class="lineNum">    3505 </span>            : 
<span class="lineNum">    3506 </span><span class="lineNoCov">          0 :     info-&gt;mort_pos_lookup2 = NewMacLookup(info,true);</span>
<span class="lineNum">    3507 </span><span class="lineNoCov">          0 :     info-&gt;mort_pos_lookup2-&gt;lookup_type = gpos_single;</span>
<span class="lineNum">    3508 </span><span class="lineNoCov">          0 :     info-&gt;mort_pos_lookup2-&gt;features-&gt;featuretag = CHR('r','t','b','d');</span>
<span class="lineNum">    3509 </span><span class="lineNoCov">          0 :     info-&gt;mort_pos_lookup2-&gt;features-&gt;ismac = false;</span>
<span class="lineNum">    3510 </span><span class="lineNoCov">          0 :     info-&gt;mort_pos_lookup2-&gt;subtables-&gt;per_glyph_pst_or_kern = true;</span>
<span class="lineNum">    3511 </span>            : 
<span class="lineNum">    3512 </span><span class="lineNoCov">          0 :     readttf_applelookup(ttf,info,</span>
<span class="lineNum">    3513 </span>            :             opbd_apply_values,opbd_apply_value,NULL,NULL,false);
<span class="lineNum">    3514 </span><span class="lineNoCov">          0 :     InfoNameOTLookup(info-&gt;mort_subs_lookup,info);</span>
<span class="lineNum">    3515 </span><span class="lineNoCov">          0 :     InfoNameOTLookup(info-&gt;mort_pos_lookup2,info);</span>
<span class="lineNum">    3516 </span>            : }
<span class="lineNum">    3517 </span>            : 
<span class="lineNum">    3518 </span>            : /* Interesting. The mac allows the creation of temporary gids beyond the */
<span class="lineNum">    3519 </span>            : /*  range specified by the font, as long as the user never sees them. So */
<span class="lineNum">    3520 </span>            : /*  it seems perfectly legal for one substitution to use a gid of 1111   */
<span class="lineNum">    3521 </span>            : /*  if that gid never reaches output but will be converted into a real gid */
<a name="3522"><span class="lineNum">    3522 </span>            : /*  by a subsequent substitution. I saw this used in a conditional situation */</a>
<span class="lineNum">    3523 </span>            : /*  to provide a temporary context for a later match. */
<span class="lineNum">    3524 </span><span class="lineNoCov">          0 : static SplineChar *CreateBadGid(struct ttfinfo *info,int badgid) {</span>
<span class="lineNum">    3525 </span>            :     int i;
<span class="lineNum">    3526 </span>            :     SplineChar *fake;
<span class="lineNum">    3527 </span>            :     char name[60];
<span class="lineNum">    3528 </span>            : 
<span class="lineNum">    3529 </span><span class="lineNoCov">          0 :     if ( badgid&lt;0 || badgid&gt;=0xffff )             /* &lt;0 should never happen, 0xffff is the special &quot;deleted&quot; glyph, &gt;0xffff should never happen */</span>
<span class="lineNum">    3530 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    3531 </span>            : 
<span class="lineNum">    3532 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;info-&gt;badgid_cnt; ++i )</span>
<span class="lineNum">    3533 </span><span class="lineNoCov">          0 :         if ( info-&gt;badgids[i]-&gt;orig_pos == badgid )</span>
<span class="lineNum">    3534 </span><span class="lineNoCov">          0 : return( info-&gt;badgids[i] );</span>
<span class="lineNum">    3535 </span>            : 
<span class="lineNum">    3536 </span><span class="lineNoCov">          0 :     if ( info-&gt;badgid_cnt&gt;=info-&gt;badgid_max )</span>
<span class="lineNum">    3537 </span><span class="lineNoCov">          0 :         info-&gt;badgids = realloc(info-&gt;badgids,(info-&gt;badgid_max += 20)*sizeof(SplineChar *));</span>
<span class="lineNum">    3538 </span><span class="lineNoCov">          0 :     fake = SplineCharCreate(2);</span>
<span class="lineNum">    3539 </span><span class="lineNoCov">          0 :     fake-&gt;orig_pos = badgid;</span>
<span class="lineNum">    3540 </span><span class="lineNoCov">          0 :     sprintf( name, &quot;Out-Of-Range-GID-%d&quot;, badgid );</span>
<span class="lineNum">    3541 </span><span class="lineNoCov">          0 :     fake-&gt;name = copy(name);</span>
<span class="lineNum">    3542 </span><span class="lineNoCov">          0 :     fake-&gt;widthset = true;           /* So it doesn't just vanish on us */</span>
<span class="lineNum">    3543 </span><span class="lineNoCov">          0 :     fake-&gt;width = fake-&gt;vwidth = info-&gt;emsize;</span>
<span class="lineNum">    3544 </span><span class="lineNoCov">          0 :     info-&gt;badgids[info-&gt;badgid_cnt++] = fake;</span>
<span class="lineNum">    3545 </span><span class="lineNoCov">          0 : return( fake );</span>
<a name="3546"><span class="lineNum">    3546 </span>            : }</a>
<span class="lineNum">    3547 </span>            : 
<span class="lineNum">    3548 </span><span class="lineCov">         29 : static void TTF_SetMortSubs(struct ttfinfo *info, int gnum, int gsubs) {</span>
<span class="lineNum">    3549 </span>            :     PST *pst;
<span class="lineNum">    3550 </span>            :     SplineChar *sc, *ssc;
<span class="lineNum">    3551 </span>            : 
<span class="lineNum">    3552 </span><span class="lineCov">         29 :     if ( gsubs==0 )</span>
<span class="lineNum">    3553 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3554 </span>            : 
<span class="lineNum">    3555 </span><span class="lineCov">         29 :     if ( gnum&lt;0 || gnum&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    3556 </span><span class="lineNoCov">          0 :         if ( info-&gt;justinuse != git_normal )</span>
<span class="lineNum">    3557 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3558 </span><span class="lineNoCov">          0 :         if ( !info-&gt;warned_morx_out_of_bounds_glyph ) {</span>
<span class="lineNum">    3559 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Glyph out of bounds in 'mort'/'morx' table %d\n&quot;), gnum );</span>
<span class="lineNum">    3560 </span><span class="lineNoCov">          0 :             info-&gt;bad_gx = true;</span>
<span class="lineNum">    3561 </span><span class="lineNoCov">          0 :             info-&gt;warned_morx_out_of_bounds_glyph = true;</span>
<span class="lineNum">    3562 </span>            :         }
<span class="lineNum">    3563 </span><span class="lineNoCov">          0 :         sc = CreateBadGid(info,gnum);</span>
<span class="lineNum">    3564 </span>            :     } else
<span class="lineNum">    3565 </span><span class="lineCov">         29 :         sc = info-&gt;chars[gnum];</span>
<span class="lineNum">    3566 </span><span class="lineCov">         29 :     ssc = NULL;</span>
<span class="lineNum">    3567 </span><span class="lineCov">         29 :     if ( gsubs&lt;0 || (gsubs&gt;=info-&gt;glyph_cnt &amp;&amp; gsubs!=0xffff)) {</span>
<span class="lineNum">    3568 </span><span class="lineNoCov">          0 :         if ( info-&gt;justinuse != git_normal )</span>
<span class="lineNum">    3569 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3570 </span><span class="lineNoCov">          0 :         if ( !info-&gt;warned_morx_out_of_bounds_glyph ) {</span>
<span class="lineNum">    3571 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Substitute glyph out of bounds in 'mort'/'morx' table %d\n&quot;), gsubs );</span>
<span class="lineNum">    3572 </span><span class="lineNoCov">          0 :             info-&gt;bad_gx = true;</span>
<span class="lineNum">    3573 </span><span class="lineNoCov">          0 :             info-&gt;warned_morx_out_of_bounds_glyph = true;</span>
<span class="lineNum">    3574 </span>            :         }
<span class="lineNum">    3575 </span><span class="lineNoCov">          0 :         ssc = CreateBadGid(info,gsubs);</span>
<span class="lineNum">    3576 </span><span class="lineCov">         29 :     } else if ( gsubs!=0xffff ) {</span>
<span class="lineNum">    3577 </span><span class="lineCov">         29 :         if ( info-&gt;justinuse == git_justinuse ) {</span>
<span class="lineNum">    3578 </span><span class="lineNoCov">          0 :             info-&gt;inuse[gsubs] = true;</span>
<span class="lineNum">    3579 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3580 </span>            :         }
<span class="lineNum">    3581 </span><span class="lineCov">         29 :         ssc=info-&gt;chars[gsubs];</span>
<span class="lineNum">    3582 </span>            :     }
<span class="lineNum">    3583 </span><span class="lineCov">         29 :     if ( sc==NULL || (gsubs!=0xffff &amp;&amp; ssc==NULL) )</span>
<span class="lineNum">    3584 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3585 </span>            : 
<span class="lineNum">    3586 </span><span class="lineCov">         29 :     pst = chunkalloc(sizeof(PST));</span>
<span class="lineNum">    3587 </span><span class="lineCov">         29 :     pst-&gt;type = pst_substitution;</span>
<span class="lineNum">    3588 </span><span class="lineCov">         29 :     pst-&gt;subtable = info-&gt;mort_subs_lookup-&gt;subtables;</span>
<span class="lineNum">    3589 </span><span class="lineCov">         29 :     if ( info-&gt;mort_subs_lookup-&gt;features!=NULL )</span>
<span class="lineNum">    3590 </span><span class="lineNoCov">          0 :         FListsAppendScriptLang(info-&gt;mort_subs_lookup-&gt;features,SCScriptFromUnicode(sc),</span>
<span class="lineNum">    3591 </span>            :                 DEFAULT_LANG);
<span class="lineNum">    3592 </span><span class="lineCov">         29 :     pst-&gt;next = sc-&gt;possub;</span>
<span class="lineNum">    3593 </span><span class="lineCov">         29 :     sc-&gt;possub = pst;</span>
<span class="lineNum">    3594 </span><span class="lineCov">         29 :     pst-&gt;u.subs.variant = gsubs!=0xffff ? copy(ssc-&gt;name) : copy(MAC_DELETED_GLYPH_NAME);</span>
<a name="3595"><span class="lineNum">    3595 </span>            : }</a>
<span class="lineNum">    3596 </span>            : 
<span class="lineNum">    3597 </span><span class="lineCov">          3 : static void mort_apply_values(struct ttfinfo *info, int gfirst, int glast,FILE *ttf) {</span>
<span class="lineNum">    3598 </span>            :     uint16 gnum;
<span class="lineNum">    3599 </span>            :     int i;
<span class="lineNum">    3600 </span>            : 
<span class="lineNum">    3601 </span><span class="lineCov">         32 :     for ( i=gfirst; i&lt;=glast; ++i ) {</span>
<span class="lineNum">    3602 </span><span class="lineCov">         29 :         gnum = getushort(ttf);</span>
<span class="lineNum">    3603 </span><span class="lineCov">         29 :         TTF_SetMortSubs(info,i, gnum);</span>
<span class="lineNum">    3604 </span>            :     }
<a name="3605"><span class="lineNum">    3605 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">    3606 </span>            : 
<span class="lineNum">    3607 </span><span class="lineNoCov">          0 : static void mort_apply_value(struct ttfinfo *info, int gfirst, int glast,FILE *ttf) {</span>
<span class="lineNum">    3608 </span>            :     uint16 gnum;
<span class="lineNum">    3609 </span>            :     int i;
<span class="lineNum">    3610 </span>            : 
<span class="lineNum">    3611 </span><span class="lineNoCov">          0 :     gnum = getushort(ttf);</span>
<span class="lineNum">    3612 </span>            : 
<span class="lineNum">    3613 </span><span class="lineNoCov">          0 :     for ( i=gfirst; i&lt;=glast; ++i )</span>
<span class="lineNum">    3614 </span><span class="lineNoCov">          0 :         TTF_SetMortSubs(info,i, gnum );</span>
<a name="3615"><span class="lineNum">    3615 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    3616 </span>            : 
<span class="lineNum">    3617 </span><span class="lineCov">          8 : static void mortclass_apply_values(struct ttfinfo *info, int gfirst, int glast,FILE *ttf) {</span>
<span class="lineNum">    3618 </span>            :     int i;
<span class="lineNum">    3619 </span>            : 
<span class="lineNum">    3620 </span><span class="lineCov">         43 :     for ( i=gfirst; i&lt;=glast; ++i )</span>
<span class="lineNum">    3621 </span><span class="lineCov">         35 :         info-&gt;morx_classes[i] = getushort(ttf);</span>
<a name="3622"><span class="lineNum">    3622 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">    3623 </span>            : 
<span class="lineNum">    3624 </span><span class="lineNoCov">          0 : static void mortclass_apply_value(struct ttfinfo *info, int gfirst, int glast,FILE *ttf) {</span>
<span class="lineNum">    3625 </span>            :     uint16 class;
<span class="lineNum">    3626 </span>            :     int i;
<span class="lineNum">    3627 </span>            : 
<span class="lineNum">    3628 </span><span class="lineNoCov">          0 :     class = getushort(ttf);</span>
<span class="lineNum">    3629 </span>            : 
<span class="lineNum">    3630 </span><span class="lineNoCov">          0 :     for ( i=gfirst; i&lt;=glast; ++i )</span>
<span class="lineNum">    3631 </span><span class="lineNoCov">          0 :         info-&gt;morx_classes[i] = class;</span>
<span class="lineNum">    3632 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3633 </span>            : 
<span class="lineNum">    3634 </span>            : #define MAX_LIG_COMP    16
<span class="lineNum">    3635 </span>            : struct statemachine {
<span class="lineNum">    3636 </span>            :     uint8 *data;
<span class="lineNum">    3637 </span>            :     int length;
<span class="lineNum">    3638 </span>            :     uint32 nClasses;
<span class="lineNum">    3639 </span>            :     uint32 classOffset, stateOffset, entryOffset, ligActOff, compOff, ligOff;
<span class="lineNum">    3640 </span>            :     uint16 *classes;
<span class="lineNum">    3641 </span>            :     uint16 lig_comp_classes[MAX_LIG_COMP];
<span class="lineNum">    3642 </span>            :     uint16 lig_comp_glyphs[MAX_LIG_COMP];
<span class="lineNum">    3643 </span>            :     int lcp;
<span class="lineNum">    3644 </span>            :     uint8 *states_in_use;
<span class="lineNum">    3645 </span>            :     int smax;
<span class="lineNum">    3646 </span>            :     struct ttfinfo *info;
<span class="lineNum">    3647 </span>            :     int cnt;
<a name="3648"><span class="lineNum">    3648 </span>            : };</a>
<span class="lineNum">    3649 </span>            : 
<span class="lineNum">    3650 </span><span class="lineNoCov">          0 : static void mort_figure_ligatures(struct statemachine *sm, int lcp, int off, int32 lig_offset,</span>
<span class="lineNum">    3651 </span>            :         struct ttfinfo *info) {
<span class="lineNum">    3652 </span>            :     uint32 lig;
<span class="lineNum">    3653 </span>            :     int i, j, lig_glyph;
<span class="lineNum">    3654 </span>            :     PST *pst;
<span class="lineNum">    3655 </span>            :     int len;
<span class="lineNum">    3656 </span>            : 
<span class="lineNum">    3657 </span><span class="lineNoCov">          0 :     if ( lcp&lt;0 || off+3&gt;sm-&gt;length )</span>
<span class="lineNum">    3658 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3659 </span>            : 
<span class="lineNum">    3660 </span><span class="lineNoCov">          0 :     lig = memlong(sm-&gt;data,sm-&gt;length, off);</span>
<span class="lineNum">    3661 </span><span class="lineNoCov">          0 :     off += sizeof(int32);</span>
<span class="lineNum">    3662 </span>            : 
<span class="lineNum">    3663 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;sm-&gt;info-&gt;glyph_cnt; ++i ) if ( sm-&gt;classes[i]==sm-&gt;lig_comp_classes[lcp] ) {</span>
<span class="lineNum">    3664 </span><span class="lineNoCov">          0 :         sm-&gt;lig_comp_glyphs[lcp] = i;</span>
<span class="lineNum">    3665 </span><span class="lineNoCov">          0 :         lig_offset += memushort(sm-&gt;data,sm-&gt;length,2*( ((((int32) lig)&lt;&lt;2)&gt;&gt;2) + i ) );</span>
<span class="lineNum">    3666 </span><span class="lineNoCov">          0 :         if ( lig&amp;0xc0000000 ) {</span>
<span class="lineNum">    3667 </span><span class="lineNoCov">          0 :             if ( lig_offset+1 &gt; sm-&gt;length ) {</span>
<span class="lineNum">    3668 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Invalid ligature offset\n&quot;) );</span>
<span class="lineNum">    3669 </span><span class="lineNoCov">          0 :                 info-&gt;bad_gx = true;</span>
<span class="lineNum">    3670 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    3671 </span>            :             }
<span class="lineNum">    3672 </span><span class="lineNoCov">          0 :             lig_glyph = memushort(sm-&gt;data,sm-&gt;length,lig_offset);</span>
<span class="lineNum">    3673 </span><span class="lineNoCov">          0 :             if ( lig_glyph&gt;=sm-&gt;info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    3674 </span><span class="lineNoCov">          0 :                 if ( info-&gt;justinuse != git_normal )</span>
<span class="lineNum">    3675 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3676 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Attempt to make a ligature for glyph %d out of &quot;),</span>
<span class="lineNum">    3677 </span>            :                         lig_glyph );
<span class="lineNum">    3678 </span><span class="lineNoCov">          0 :                 for ( j=lcp; j&lt;sm-&gt;lcp; ++j )</span>
<span class="lineNum">    3679 </span><span class="lineNoCov">          0 :                     LogError(&quot;%d &quot;,sm-&gt;lig_comp_glyphs[j]);</span>
<span class="lineNum">    3680 </span><span class="lineNoCov">          0 :                 LogError(&quot;\n&quot;);</span>
<span class="lineNum">    3681 </span><span class="lineNoCov">          0 :                 info-&gt;bad_gx = true;</span>
<span class="lineNum">    3682 </span><span class="lineNoCov">          0 :             } else if ( info-&gt;justinuse == git_justinuse ) {</span>
<span class="lineNum">    3683 </span><span class="lineNoCov">          0 :                 info-&gt;inuse[lig_glyph] = true;</span>
<span class="lineNum">    3684 </span><span class="lineNoCov">          0 :             } else if ( sm-&gt;info-&gt;chars[lig_glyph]==NULL ) {</span>
<span class="lineNum">    3685 </span>            :                 /* Do Nothing, ttc file probably */
<span class="lineNum">    3686 </span>            :             } else {
<span class="lineNum">    3687 </span>            :                 char *comp;
<span class="lineNum">    3688 </span><span class="lineNoCov">          0 :                 int err=false;</span>
<span class="lineNum">    3689 </span><span class="lineNoCov">          0 :                 for ( len=0, j=lcp; j&lt;sm-&gt;lcp; ++j )</span>
<span class="lineNum">    3690 </span><span class="lineNoCov">          0 :                     if ( sm-&gt;lig_comp_glyphs[j]&lt;sm-&gt;info-&gt;glyph_cnt &amp;&amp;</span>
<span class="lineNum">    3691 </span><span class="lineNoCov">          0 :                             sm-&gt;info-&gt;chars[sm-&gt;lig_comp_glyphs[j]]!=NULL )</span>
<span class="lineNum">    3692 </span><span class="lineNoCov">          0 :                         len += strlen(sm-&gt;info-&gt;chars[sm-&gt;lig_comp_glyphs[j]]-&gt;name)+1;</span>
<span class="lineNum">    3693 </span>            :                     else
<span class="lineNum">    3694 </span><span class="lineNoCov">          0 :                         err = true;</span>
<span class="lineNum">    3695 </span><span class="lineNoCov">          0 :                 if ( sm-&gt;info-&gt;chars[lig_glyph]!=NULL &amp;&amp; !err ) {</span>
<span class="lineNum">    3696 </span><span class="lineNoCov">          0 :                     comp = malloc(len+1);</span>
<span class="lineNum">    3697 </span><span class="lineNoCov">          0 :                     *comp = '\0';</span>
<span class="lineNum">    3698 </span><span class="lineNoCov">          0 :                     for ( j=lcp; j&lt;sm-&gt;lcp; ++j ) {</span>
<span class="lineNum">    3699 </span><span class="lineNoCov">          0 :                         if ( sm-&gt;lig_comp_glyphs[j]&lt;sm-&gt;info-&gt;glyph_cnt &amp;&amp;</span>
<span class="lineNum">    3700 </span><span class="lineNoCov">          0 :                                 sm-&gt;info-&gt;chars[sm-&gt;lig_comp_glyphs[j]]!=NULL ) {</span>
<span class="lineNum">    3701 </span><span class="lineNoCov">          0 :                             if ( *comp!='\0' )</span>
<span class="lineNum">    3702 </span><span class="lineNoCov">          0 :                                 strcat(comp,&quot; &quot;);</span>
<span class="lineNum">    3703 </span><span class="lineNoCov">          0 :                             strcat(comp,sm-&gt;info-&gt;chars[sm-&gt;lig_comp_glyphs[j]]-&gt;name);</span>
<span class="lineNum">    3704 </span>            :                         }
<span class="lineNum">    3705 </span>            :                     }
<span class="lineNum">    3706 </span><span class="lineNoCov">          0 :                     for ( pst=sm-&gt;info-&gt;chars[lig_glyph]-&gt;possub; pst!=NULL; pst=pst-&gt;next )</span>
<span class="lineNum">    3707 </span><span class="lineNoCov">          0 :                         if ( pst-&gt;type==pst_ligature &amp;&amp; pst-&gt;subtable==sm-&gt;info-&gt;mort_subs_lookup-&gt;subtables &amp;&amp;</span>
<span class="lineNum">    3708 </span><span class="lineNoCov">          0 :                                 strcmp(comp,pst-&gt;u.lig.components)==0 )</span>
<span class="lineNum">    3709 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">    3710 </span>            :                     /* There are cases where there will be multiple entries for */
<span class="lineNum">    3711 </span>            :                     /*  the same lig. ie. if we have &quot;ff&quot; and &quot;ffl&quot; then there */
<span class="lineNum">    3712 </span>            :                     /*  will be multiple entries for &quot;ff&quot; */
<span class="lineNum">    3713 </span><span class="lineNoCov">          0 :                     if ( pst == NULL ) {</span>
<span class="lineNum">    3714 </span><span class="lineNoCov">          0 :                         pst = chunkalloc(sizeof(PST));</span>
<span class="lineNum">    3715 </span><span class="lineNoCov">          0 :                         pst-&gt;type = pst_ligature;</span>
<span class="lineNum">    3716 </span><span class="lineNoCov">          0 :                         pst-&gt;subtable = sm-&gt;info-&gt;mort_subs_lookup-&gt;subtables;</span>
<span class="lineNum">    3717 </span><span class="lineNoCov">          0 :                         if ( sm-&gt;info-&gt;mort_subs_lookup-&gt;features!=NULL )</span>
<span class="lineNum">    3718 </span><span class="lineNoCov">          0 :                             FListsAppendScriptLang(sm-&gt;info-&gt;mort_subs_lookup-&gt;features,</span>
<span class="lineNum">    3719 </span><span class="lineNoCov">          0 :                                     SCScriptFromUnicode(sm-&gt;info-&gt;chars[lig_glyph]),</span>
<span class="lineNum">    3720 </span>            :                                     DEFAULT_LANG);
<span class="lineNum">    3721 </span><span class="lineNoCov">          0 :                         pst-&gt;u.lig.components = comp;</span>
<span class="lineNum">    3722 </span><span class="lineNoCov">          0 :                         pst-&gt;u.lig.lig = sm-&gt;info-&gt;chars[lig_glyph];</span>
<span class="lineNum">    3723 </span><span class="lineNoCov">          0 :                         pst-&gt;next = sm-&gt;info-&gt;chars[lig_glyph]-&gt;possub;</span>
<span class="lineNum">    3724 </span><span class="lineNoCov">          0 :                         sm-&gt;info-&gt;chars[lig_glyph]-&gt;possub = pst;</span>
<span class="lineNum">    3725 </span>            :                     } else
<span class="lineNum">    3726 </span><span class="lineNoCov">          0 :                         free(comp);</span>
<span class="lineNum">    3727 </span>            :                 }
<span class="lineNum">    3728 </span>            :             }
<span class="lineNum">    3729 </span>            :         } else
<span class="lineNum">    3730 </span><span class="lineNoCov">          0 :             mort_figure_ligatures(sm,lcp-1,off,lig_offset,info);</span>
<span class="lineNum">    3731 </span><span class="lineNoCov">          0 :         lig_offset -= memushort(sm-&gt;data,sm-&gt;length,2*( ((((int32) lig)&lt;&lt;2)&gt;&gt;2) + i ) );</span>
<span class="lineNum">    3732 </span>            :     }
<a name="3733"><span class="lineNum">    3733 </span>            : }</a>
<span class="lineNum">    3734 </span>            : 
<span class="lineNum">    3735 </span><span class="lineNoCov">          0 : static void follow_mort_state(struct statemachine *sm,int offset,int class,</span>
<span class="lineNum">    3736 </span>            :         struct ttfinfo *info) {
<span class="lineNum">    3737 </span><span class="lineNoCov">          0 :     int state = (offset-sm-&gt;stateOffset)/sm-&gt;nClasses;</span>
<span class="lineNum">    3738 </span>            :     int class_top, class_bottom;
<span class="lineNum">    3739 </span>            : 
<span class="lineNum">    3740 </span><span class="lineNoCov">          0 :     if ( state&lt;0 || state&gt;=sm-&gt;smax || sm-&gt;states_in_use[state] || sm-&gt;lcp&gt;=MAX_LIG_COMP )</span>
<span class="lineNum">    3741 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3742 </span><span class="lineNoCov">          0 :     ++ sm-&gt;cnt;</span>
<span class="lineNum">    3743 </span><span class="lineNoCov">          0 :     if ( sm-&gt;cnt&gt;=10000 ) {</span>
<span class="lineNum">    3744 </span><span class="lineNoCov">          0 :         if ( sm-&gt;cnt==10000 )</span>
<span class="lineNum">    3745 </span>            : /* GT: This is a reference to &quot;Much Ado About Nothing&quot;. The string should read */
<span class="lineNum">    3746 </span>            : /* GT: &quot;A ligature sub-table in Apple's 'mort'/'morx' table is too\ncomplex for me to understand. I shall give up on it.\nYour ligatures may not be complete.&quot; */
<span class="lineNum">    3747 </span><span class="lineNoCov">          0 :             LogError(_(&quot;In an attempt to process the ligatures of this font, I've concluded\nthat the state machine in Apple's mort/morx table is\n(like the learned constable) too cunning to be understood.\nI shall give up on it. Your ligatures may be incomplete.\n&quot;) );</span>
<span class="lineNum">    3748 </span><span class="lineNoCov">          0 :         info-&gt;bad_gx = true;</span>
<span class="lineNum">    3749 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3750 </span>            :     }
<span class="lineNum">    3751 </span><span class="lineNoCov">          0 :     sm-&gt;states_in_use[state] = true;</span>
<span class="lineNum">    3752 </span>            : 
<span class="lineNum">    3753 </span><span class="lineNoCov">          0 :     if ( class==-1 ) { class_bottom = 0; class_top = sm-&gt;nClasses; }</span>
<span class="lineNum">    3754 </span><span class="lineNoCov">          0 :     else { class_bottom = class; class_top = class+1; }</span>
<span class="lineNum">    3755 </span><span class="lineNoCov">          0 :     for ( class=class_bottom; class&lt;class_top; ++class ) {</span>
<span class="lineNum">    3756 </span><span class="lineNoCov">          0 :         int ent = sm-&gt;data[offset+class];</span>
<span class="lineNum">    3757 </span><span class="lineNoCov">          0 :         int newState = memushort(sm-&gt;data,sm-&gt;length,sm-&gt;entryOffset+4*ent);</span>
<span class="lineNum">    3758 </span><span class="lineNoCov">          0 :         int flags = memushort(sm-&gt;data,sm-&gt;length,sm-&gt;entryOffset+4*ent+2);</span>
<span class="lineNum">    3759 </span>            :         /* If we have the same entry as state 0, then presumably we are */
<span class="lineNum">    3760 </span>            :         /*  ignoring the components read so far and starting over with a new */
<span class="lineNum">    3761 </span>            :         /*  lig (similarly for state 1) */
<span class="lineNum">    3762 </span><span class="lineNoCov">          0 :         if (( state!=0 &amp;&amp; sm-&gt;data[sm-&gt;stateOffset+class] == ent ) ||</span>
<span class="lineNum">    3763 </span><span class="lineNoCov">          0 :                 (state&gt;1 &amp;&amp; sm-&gt;data[sm-&gt;stateOffset+sm-&gt;nClasses+class]==ent ))</span>
<span class="lineNum">    3764 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    3765 </span><span class="lineNoCov">          0 :         if ( flags&amp;0x8000 ) /* Set component */</span>
<span class="lineNum">    3766 </span><span class="lineNoCov">          0 :             sm-&gt;lig_comp_classes[sm-&gt;lcp++] = class;</span>
<span class="lineNum">    3767 </span><span class="lineNoCov">          0 :         if ( flags&amp;0x3fff ) {</span>
<span class="lineNum">    3768 </span><span class="lineNoCov">          0 :             mort_figure_ligatures(sm, sm-&gt;lcp-1, flags &amp; 0x3fff, 0,info);</span>
<span class="lineNum">    3769 </span><span class="lineNoCov">          0 :         } else if ( flags&amp;0x8000 )</span>
<span class="lineNum">    3770 </span><span class="lineNoCov">          0 :             follow_mort_state(sm,newState,(flags&amp;0x4000)?class:-1,info);</span>
<span class="lineNum">    3771 </span><span class="lineNoCov">          0 :         if ( flags&amp;0x8000 )</span>
<span class="lineNum">    3772 </span><span class="lineNoCov">          0 :             --sm-&gt;lcp;</span>
<span class="lineNum">    3773 </span>            :     }
<span class="lineNum">    3774 </span><span class="lineNoCov">          0 :     sm-&gt;states_in_use[state] = false;</span>
<a name="3775"><span class="lineNum">    3775 </span>            : }</a>
<span class="lineNum">    3776 </span>            : 
<span class="lineNum">    3777 </span><span class="lineCov">          4 : static void morx_figure_ligatures(struct statemachine *sm, int lcp, int ligindex, int32 lig_offset,</span>
<span class="lineNum">    3778 </span>            :         struct ttfinfo *info) {
<span class="lineNum">    3779 </span>            :     uint32 lig;
<span class="lineNum">    3780 </span>            :     int i, j, lig_glyph;
<span class="lineNum">    3781 </span>            :     PST *pst;
<span class="lineNum">    3782 </span>            :     int len;
<span class="lineNum">    3783 </span>            : 
<span class="lineNum">    3784 </span><span class="lineCov">          4 :     if ( lcp&lt;0 || sm-&gt;ligActOff+4*ligindex+3&gt;sm-&gt;length )</span>
<span class="lineNum">    3785 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3786 </span>            : 
<span class="lineNum">    3787 </span><span class="lineCov">          4 :     lig = memlong(sm-&gt;data,sm-&gt;length, sm-&gt;ligActOff+4*ligindex);</span>
<span class="lineNum">    3788 </span><span class="lineCov">          4 :     ++ligindex;</span>
<span class="lineNum">    3789 </span>            : 
<span class="lineNum">    3790 </span><span class="lineCov">       3588 :     for ( i=0; i&lt;sm-&gt;info-&gt;glyph_cnt; ++i ) if ( sm-&gt;classes[i]==sm-&gt;lig_comp_classes[lcp] ) {</span>
<span class="lineNum">    3791 </span><span class="lineCov">          4 :         sm-&gt;lig_comp_glyphs[lcp] = i;</span>
<span class="lineNum">    3792 </span><span class="lineCov">          4 :         lig_offset += memushort(sm-&gt;data,sm-&gt;length,sm-&gt;compOff + 2*( ((((int32) lig)&lt;&lt;2)&gt;&gt;2) + i ) );</span>
<span class="lineNum">    3793 </span><span class="lineCov">          4 :         if ( lig&amp;0xc0000000 ) {</span>
<span class="lineNum">    3794 </span><span class="lineCov">          2 :             if ( sm-&gt;ligOff+2*lig_offset+1 &gt; sm-&gt;length ) {</span>
<span class="lineNum">    3795 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Invalid ligature offset\n&quot;) );</span>
<span class="lineNum">    3796 </span><span class="lineNoCov">          0 :                 info-&gt;bad_gx = true;</span>
<span class="lineNum">    3797 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    3798 </span>            :             }
<span class="lineNum">    3799 </span><span class="lineCov">          2 :             lig_glyph = memushort(sm-&gt;data,sm-&gt;length,sm-&gt;ligOff+2*lig_offset);</span>
<span class="lineNum">    3800 </span><span class="lineCov">          2 :             if ( lig_glyph&gt;=sm-&gt;info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    3801 </span><span class="lineNoCov">          0 :                 if ( info-&gt;justinuse != git_normal )</span>
<span class="lineNum">    3802 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3803 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Attempt to make a ligature for (non-existent) glyph %d out of &quot;),</span>
<span class="lineNum">    3804 </span>            :                         lig_glyph );
<span class="lineNum">    3805 </span><span class="lineNoCov">          0 :                 info-&gt;bad_gx = true;</span>
<span class="lineNum">    3806 </span><span class="lineNoCov">          0 :                 for ( j=lcp; j&lt;sm-&gt;lcp; ++j )</span>
<span class="lineNum">    3807 </span><span class="lineNoCov">          0 :                     LogError(&quot;%d &quot;,sm-&gt;lig_comp_glyphs[j]);</span>
<span class="lineNum">    3808 </span><span class="lineNoCov">          0 :                 LogError(&quot;\n&quot;);</span>
<span class="lineNum">    3809 </span><span class="lineCov">          2 :             } else if ( info-&gt;justinuse == git_justinuse ) {</span>
<span class="lineNum">    3810 </span><span class="lineNoCov">          0 :                 info-&gt;inuse[lig_glyph] = true;</span>
<span class="lineNum">    3811 </span><span class="lineCov">          2 :             } else if ( sm-&gt;info-&gt;chars[lig_glyph]==NULL ) {</span>
<span class="lineNum">    3812 </span>            :                 /* Nothing to do */
<span class="lineNum">    3813 </span>            :             } else {
<span class="lineNum">    3814 </span>            :                 char *comp;
<span class="lineNum">    3815 </span><span class="lineCov">          2 :                 int err=false;</span>
<span class="lineNum">    3816 </span><span class="lineCov">          6 :                 for ( len=0, j=lcp; j&lt;sm-&gt;lcp; ++j ) {</span>
<span class="lineNum">    3817 </span><span class="lineCov">          8 :                     if ( sm-&gt;lig_comp_glyphs[j]&gt;=sm-&gt;info-&gt;glyph_cnt ||</span>
<span class="lineNum">    3818 </span><span class="lineCov">          4 :                             sm-&gt;info-&gt;chars[ sm-&gt;lig_comp_glyphs[j]]==NULL )</span>
<span class="lineNum">    3819 </span><span class="lineNoCov">          0 :                         err = true;</span>
<span class="lineNum">    3820 </span>            :                     else
<span class="lineNum">    3821 </span><span class="lineCov">          4 :                         len += strlen(sm-&gt;info-&gt;chars[sm-&gt;lig_comp_glyphs[j]]-&gt;name)+1;</span>
<span class="lineNum">    3822 </span>            :                 }
<span class="lineNum">    3823 </span><span class="lineCov">          2 :                 if ( !err ) {</span>
<span class="lineNum">    3824 </span><span class="lineCov">          2 :                     comp = malloc(len);</span>
<span class="lineNum">    3825 </span><span class="lineCov">          2 :                     *comp = '\0';</span>
<span class="lineNum">    3826 </span><span class="lineCov">          6 :                     for ( j=lcp; j&lt;sm-&gt;lcp; ++j ) {</span>
<span class="lineNum">    3827 </span><span class="lineCov">          4 :                         if ( *comp!='\0' )</span>
<span class="lineNum">    3828 </span><span class="lineCov">          2 :                             strcat(comp,&quot; &quot;);</span>
<span class="lineNum">    3829 </span><span class="lineCov">          4 :                         strcat(comp,sm-&gt;info-&gt;chars[sm-&gt;lig_comp_glyphs[j]]-&gt;name);</span>
<span class="lineNum">    3830 </span>            :                     }
<span class="lineNum">    3831 </span><span class="lineCov">          2 :                     for ( pst=sm-&gt;info-&gt;chars[lig_glyph]-&gt;possub; pst!=NULL; pst=pst-&gt;next )</span>
<span class="lineNum">    3832 </span><span class="lineNoCov">          0 :                         if ( pst-&gt;type==pst_ligature &amp;&amp; pst-&gt;subtable==sm-&gt;info-&gt;mort_subs_lookup-&gt;subtables &amp;&amp;</span>
<span class="lineNum">    3833 </span><span class="lineNoCov">          0 :                                 strcmp(comp,pst-&gt;u.lig.components)==0 )</span>
<span class="lineNum">    3834 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">    3835 </span>            :                     /* There are cases where there will be multiple entries for */
<span class="lineNum">    3836 </span>            :                     /*  the same lig. ie. if we have &quot;ff&quot; and &quot;ffl&quot; then there */
<span class="lineNum">    3837 </span>            :                     /*  will be multiple entries for &quot;ff&quot; */
<span class="lineNum">    3838 </span><span class="lineCov">          2 :                     if ( pst == NULL ) {</span>
<span class="lineNum">    3839 </span><span class="lineCov">          2 :                         pst = chunkalloc(sizeof(PST));</span>
<span class="lineNum">    3840 </span><span class="lineCov">          2 :                         pst-&gt;type = pst_ligature;</span>
<span class="lineNum">    3841 </span><span class="lineCov">          2 :                         pst-&gt;subtable = sm-&gt;info-&gt;mort_subs_lookup-&gt;subtables;</span>
<span class="lineNum">    3842 </span><span class="lineCov">          2 :                         if ( sm-&gt;info-&gt;mort_subs_lookup-&gt;features!=NULL )</span>
<span class="lineNum">    3843 </span><span class="lineCov">          2 :                             FListsAppendScriptLang(sm-&gt;info-&gt;mort_subs_lookup-&gt;features,</span>
<span class="lineNum">    3844 </span><span class="lineCov">          2 :                                     SCScriptFromUnicode(sm-&gt;info-&gt;chars[lig_glyph]),</span>
<span class="lineNum">    3845 </span>            :                                     DEFAULT_LANG);
<span class="lineNum">    3846 </span><span class="lineCov">          2 :                         pst-&gt;u.lig.components = comp;</span>
<span class="lineNum">    3847 </span><span class="lineCov">          2 :                         pst-&gt;u.lig.lig = sm-&gt;info-&gt;chars[lig_glyph];</span>
<span class="lineNum">    3848 </span><span class="lineCov">          2 :                         pst-&gt;next = sm-&gt;info-&gt;chars[lig_glyph]-&gt;possub;</span>
<span class="lineNum">    3849 </span><span class="lineCov">          2 :                         sm-&gt;info-&gt;chars[lig_glyph]-&gt;possub = pst;</span>
<span class="lineNum">    3850 </span>            :                     } else
<span class="lineNum">    3851 </span><span class="lineNoCov">          0 :                         free(comp);</span>
<span class="lineNum">    3852 </span>            :                 }
<span class="lineNum">    3853 </span>            :             }
<span class="lineNum">    3854 </span>            :         } else
<span class="lineNum">    3855 </span><span class="lineCov">          2 :             morx_figure_ligatures(sm,lcp-1,ligindex,lig_offset,info);</span>
<span class="lineNum">    3856 </span><span class="lineCov">          4 :         lig_offset -= memushort(sm-&gt;data,sm-&gt;length,sm-&gt;compOff + 2*( ((((int32) lig)&lt;&lt;2)&gt;&gt;2) + i ) );</span>
<span class="lineNum">    3857 </span>            :     }
<a name="3858"><span class="lineNum">    3858 </span>            : }</a>
<span class="lineNum">    3859 </span>            : 
<span class="lineNum">    3860 </span><span class="lineCov">          3 : static void follow_morx_state(struct statemachine *sm,int state,int class,</span>
<span class="lineNum">    3861 </span>            :         struct ttfinfo *info) {
<span class="lineNum">    3862 </span>            :     int class_top, class_bottom;
<span class="lineNum">    3863 </span>            : 
<span class="lineNum">    3864 </span><span class="lineCov">          3 :     if ( state&lt;0 || state&gt;=sm-&gt;smax || sm-&gt;states_in_use[state] || sm-&gt;lcp&gt;=MAX_LIG_COMP )</span>
<span class="lineNum">    3865 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3866 </span><span class="lineCov">          3 :     ++ sm-&gt;cnt;</span>
<span class="lineNum">    3867 </span><span class="lineCov">          3 :     if ( sm-&gt;cnt&gt;=10000 ) {</span>
<span class="lineNum">    3868 </span><span class="lineNoCov">          0 :         if ( sm-&gt;cnt==10000 )</span>
<span class="lineNum">    3869 </span><span class="lineNoCov">          0 :             LogError(_(&quot;In an attempt to process the ligatures of this font, I've concluded\nthat the state machine in Apple's mort/morx table is\n(like the learned constable) too cunning to be understood.\nI shall give up on it. Your ligatures may be incomplete.\n&quot;) );</span>
<span class="lineNum">    3870 </span><span class="lineNoCov">          0 :             info-&gt;bad_gx = true;</span>
<span class="lineNum">    3871 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    3872 </span>            :     }
<span class="lineNum">    3873 </span><span class="lineCov">          3 :     sm-&gt;states_in_use[state] = true;</span>
<span class="lineNum">    3874 </span>            : 
<span class="lineNum">    3875 </span><span class="lineCov">          3 :     if ( class==-1 ) { class_bottom = 0; class_top = sm-&gt;nClasses; }</span>
<span class="lineNum">    3876 </span><span class="lineNoCov">          0 :     else { class_bottom = class; class_top = class+1; }</span>
<span class="lineNum">    3877 </span><span class="lineCov">         27 :     for ( class=class_bottom; class&lt;class_top; ++class ) {</span>
<span class="lineNum">    3878 </span><span class="lineCov">         24 :         int ent = memushort(sm-&gt;data, sm-&gt;length,sm-&gt;stateOffset + 2*(state*sm-&gt;nClasses+class) );</span>
<span class="lineNum">    3879 </span><span class="lineCov">         24 :         int newState = memushort(sm-&gt;data,sm-&gt;length,sm-&gt;entryOffset+6*ent);</span>
<span class="lineNum">    3880 </span><span class="lineCov">         24 :         int flags = memushort(sm-&gt;data,sm-&gt;length,sm-&gt;entryOffset+6*ent+2);</span>
<span class="lineNum">    3881 </span><span class="lineCov">         24 :         int ligindex = memushort(sm-&gt;data,sm-&gt;length,sm-&gt;entryOffset+6*ent+4);</span>
<span class="lineNum">    3882 </span>            :         /* If we have the same entry as state 0, then presumably we are */
<span class="lineNum">    3883 </span>            :         /*  ignoring the components read so far and starting over with a new */
<span class="lineNum">    3884 </span>            :         /*  lig (similarly for state 1) */
<span class="lineNum">    3885 </span><span class="lineCov">         24 :         if (( state!=0 &amp;&amp; memushort(sm-&gt;data, sm-&gt;length,sm-&gt;stateOffset + 2*class) == ent ) ||</span>
<span class="lineNum">    3886 </span><span class="lineCov">          2 :                 (state&gt;1 &amp;&amp; memushort(sm-&gt;data,sm-&gt;length, sm-&gt;stateOffset + 2*(sm-&gt;nClasses+class))==ent ))</span>
<span class="lineNum">    3887 </span><span class="lineCov">         14 :     continue;</span>
<span class="lineNum">    3888 </span><span class="lineCov">         10 :         if ( flags&amp;0x8000 ) /* Set component */</span>
<span class="lineNum">    3889 </span><span class="lineCov">          4 :             sm-&gt;lig_comp_classes[sm-&gt;lcp++] = class;</span>
<span class="lineNum">    3890 </span><span class="lineCov">         10 :         if ( flags&amp;0x2000 ) {</span>
<span class="lineNum">    3891 </span><span class="lineCov">          2 :             morx_figure_ligatures(sm, sm-&gt;lcp-1, ligindex, 0,info);</span>
<span class="lineNum">    3892 </span><span class="lineCov">          8 :         } else if ( flags&amp;0x8000 )</span>
<span class="lineNum">    3893 </span><span class="lineCov">          2 :             follow_morx_state(sm,newState,(flags&amp;0x4000)?class:-1,info);</span>
<span class="lineNum">    3894 </span><span class="lineCov">         10 :         if ( flags&amp;0x8000 )</span>
<span class="lineNum">    3895 </span><span class="lineCov">          4 :             --sm-&gt;lcp;</span>
<span class="lineNum">    3896 </span>            :     }
<span class="lineNum">    3897 </span><span class="lineCov">          3 :     sm-&gt;states_in_use[state] = false;</span>
<a name="3898"><span class="lineNum">    3898 </span>            : }</a>
<span class="lineNum">    3899 </span>            : 
<span class="lineNum">    3900 </span><span class="lineCov">          1 : static void readttf_mortx_lig(FILE *ttf,struct ttfinfo *info,int ismorx,uint32 base,uint32 length) {</span>
<span class="lineNum">    3901 </span>            :     uint32 here;
<span class="lineNum">    3902 </span>            :     struct statemachine sm;
<span class="lineNum">    3903 </span>            :     int first, cnt, i;
<span class="lineNum">    3904 </span>            : 
<span class="lineNum">    3905 </span><span class="lineCov">          1 :     memset(&amp;sm,0,sizeof(sm));</span>
<span class="lineNum">    3906 </span><span class="lineCov">          1 :     sm.info = info;</span>
<span class="lineNum">    3907 </span><span class="lineCov">          1 :     here = ftell(ttf);</span>
<span class="lineNum">    3908 </span><span class="lineCov">          1 :     length -= here-base;</span>
<span class="lineNum">    3909 </span><span class="lineCov">          1 :     sm.data = malloc(length);</span>
<span class="lineNum">    3910 </span><span class="lineCov">          1 :     sm.length = length;</span>
<span class="lineNum">    3911 </span><span class="lineCov">          1 :     if ( fread(sm.data,1,length,ttf)!=length ) {</span>
<span class="lineNum">    3912 </span><span class="lineNoCov">          0 :         free(sm.data);</span>
<span class="lineNum">    3913 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Bad mort ligature table. Not long enough\n&quot;));</span>
<span class="lineNum">    3914 </span><span class="lineNoCov">          0 :         info-&gt;bad_gx = true;</span>
<span class="lineNum">    3915 </span><span class="lineCov">          1 : return;</span>
<span class="lineNum">    3916 </span>            :     }
<span class="lineNum">    3917 </span><span class="lineCov">          1 :     fseek(ttf,here,SEEK_SET);</span>
<span class="lineNum">    3918 </span><span class="lineCov">          1 :     if ( ismorx ) {</span>
<span class="lineNum">    3919 </span><span class="lineCov">          1 :         sm.nClasses = memlong(sm.data,sm.length, 0);</span>
<span class="lineNum">    3920 </span><span class="lineCov">          1 :         sm.classOffset = memlong(sm.data,sm.length, sizeof(int32));</span>
<span class="lineNum">    3921 </span><span class="lineCov">          1 :         sm.stateOffset = memlong(sm.data,sm.length, 2*sizeof(int32));</span>
<span class="lineNum">    3922 </span><span class="lineCov">          1 :         sm.entryOffset = memlong(sm.data,sm.length, 3*sizeof(int32));</span>
<span class="lineNum">    3923 </span><span class="lineCov">          1 :         sm.ligActOff = memlong(sm.data,sm.length, 4*sizeof(int32));</span>
<span class="lineNum">    3924 </span><span class="lineCov">          1 :         sm.compOff = memlong(sm.data,sm.length, 5*sizeof(int32));</span>
<span class="lineNum">    3925 </span><span class="lineCov">          1 :         sm.ligOff = memlong(sm.data,sm.length, 6*sizeof(int32));</span>
<span class="lineNum">    3926 </span><span class="lineCov">          1 :         fseek(ttf,here+sm.classOffset,SEEK_SET);</span>
<span class="lineNum">    3927 </span>            :         /* I used only to allocate space for info-&gt;glyph_cnt entries */
<span class="lineNum">    3928 </span>            :         /*  but some fonts use out of bounds gids as flags to contextual */
<span class="lineNum">    3929 </span>            :         /*  morx subtables, so allocate a full 65536 */
<span class="lineNum">    3930 </span><span class="lineCov">          1 :         sm.classes = info-&gt;morx_classes = malloc(65536*sizeof(uint16));</span>
<span class="lineNum">    3931 </span><span class="lineCov">      65537 :         for ( i=0; i&lt;65536; ++i )</span>
<span class="lineNum">    3932 </span><span class="lineCov">      65536 :             sm.classes[i] = 1;                  /* Out of bounds */</span>
<span class="lineNum">    3933 </span><span class="lineCov">          1 :         readttf_applelookup(ttf,info,</span>
<span class="lineNum">    3934 </span>            :                 mortclass_apply_values,mortclass_apply_value,NULL,NULL,true);
<span class="lineNum">    3935 </span><span class="lineCov">          1 :         sm.smax = length/(2*sm.nClasses);</span>
<span class="lineNum">    3936 </span><span class="lineCov">          1 :         sm.states_in_use = calloc(sm.smax,sizeof(uint8));</span>
<span class="lineNum">    3937 </span><span class="lineCov">          1 :         follow_morx_state(&amp;sm,0,-1,info);</span>
<span class="lineNum">    3938 </span>            :     } else {
<span class="lineNum">    3939 </span><span class="lineNoCov">          0 :         sm.nClasses = memushort(sm.data,sm.length, 0);</span>
<span class="lineNum">    3940 </span><span class="lineNoCov">          0 :         sm.classOffset = memushort(sm.data,sm.length, sizeof(uint16));</span>
<span class="lineNum">    3941 </span><span class="lineNoCov">          0 :         sm.stateOffset = memushort(sm.data,sm.length, 2*sizeof(uint16));</span>
<span class="lineNum">    3942 </span><span class="lineNoCov">          0 :         sm.entryOffset = memushort(sm.data,sm.length, 3*sizeof(uint16));</span>
<span class="lineNum">    3943 </span><span class="lineNoCov">          0 :         sm.ligActOff = memushort(sm.data,sm.length, 4*sizeof(uint16));</span>
<span class="lineNum">    3944 </span><span class="lineNoCov">          0 :         sm.compOff = memushort(sm.data,sm.length, 5*sizeof(uint16));</span>
<span class="lineNum">    3945 </span><span class="lineNoCov">          0 :         sm.ligOff = memushort(sm.data,sm.length, 6*sizeof(uint16));</span>
<span class="lineNum">    3946 </span><span class="lineNoCov">          0 :         sm.classes = malloc(info-&gt;glyph_cnt*sizeof(uint16));</span>
<span class="lineNum">    3947 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;info-&gt;glyph_cnt; ++i )</span>
<span class="lineNum">    3948 </span><span class="lineNoCov">          0 :             sm.classes[i] = 1;                  /* Out of bounds */</span>
<span class="lineNum">    3949 </span><span class="lineNoCov">          0 :         first = memushort(sm.data,sm.length, sm.classOffset);</span>
<span class="lineNum">    3950 </span><span class="lineNoCov">          0 :         cnt = memushort(sm.data,sm.length, sm.classOffset+sizeof(uint16));</span>
<span class="lineNum">    3951 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;cnt; ++i )</span>
<span class="lineNum">    3952 </span><span class="lineNoCov">          0 :             sm.classes[first+i] = sm.data[sm.classOffset+2*sizeof(uint16)+i];</span>
<span class="lineNum">    3953 </span><span class="lineNoCov">          0 :         sm.smax = length/sm.nClasses;</span>
<span class="lineNum">    3954 </span><span class="lineNoCov">          0 :         sm.states_in_use = calloc(sm.smax,sizeof(uint8));</span>
<span class="lineNum">    3955 </span><span class="lineNoCov">          0 :         follow_mort_state(&amp;sm,sm.stateOffset,-1,info);</span>
<span class="lineNum">    3956 </span>            :     }
<span class="lineNum">    3957 </span><span class="lineCov">          1 :     free(sm.data);</span>
<span class="lineNum">    3958 </span><span class="lineCov">          1 :     free(sm.states_in_use);</span>
<span class="lineNum">    3959 </span><span class="lineCov">          1 :     free(sm.classes);</span>
<span class="lineNum">    3960 </span>            : }
<span class="lineNum">    3961 </span>            : 
<span class="lineNum">    3962 </span>            : struct statetable {
<span class="lineNum">    3963 </span>            :     uint32 state_start;
<span class="lineNum">    3964 </span>            :     int nclasses;
<span class="lineNum">    3965 </span>            :     int nstates;
<span class="lineNum">    3966 </span>            :     int nentries;
<span class="lineNum">    3967 </span>            :     int state_offset;
<span class="lineNum">    3968 </span>            :     int entry_size;     /* size of individual entry */
<span class="lineNum">    3969 </span>            :     int entry_extras;   /* Number of extra glyph offsets */
<span class="lineNum">    3970 </span>            :     int first_glyph;    /* that's classifyable */
<span class="lineNum">    3971 </span>            :     int nglyphs;
<span class="lineNum">    3972 </span>            :     uint8 *classes;
<span class="lineNum">    3973 </span>            :     uint8 *state_table; /* state_table[nstates][nclasses], each entry is an */
<span class="lineNum">    3974 </span>            :         /* index into the following array */
<span class="lineNum">    3975 </span>            :     uint16 *state_table2;       /* morx version. States are have 2 byte entries */
<span class="lineNum">    3976 </span>            :     uint16 *classes2;
<span class="lineNum">    3977 </span>            :     uint8 *transitions;
<span class="lineNum">    3978 </span>            :     uint32 extra_offsets[3];
<a name="3979"><span class="lineNum">    3979 </span>            : };</a>
<span class="lineNum">    3980 </span>            : 
<span class="lineNum">    3981 </span><span class="lineCov">          1 : static struct statetable *read_statetable(FILE *ttf, int ent_extras, int ismorx, struct ttfinfo *info) {</span>
<span class="lineNum">    3982 </span><span class="lineCov">          1 :     struct statetable *st = calloc(1,sizeof(struct statetable));</span>
<span class="lineNum">    3983 </span><span class="lineCov">          1 :     uint32 here = ftell(ttf);</span>
<span class="lineNum">    3984 </span>            :     int nclasses, class_off, state_off, entry_off;
<span class="lineNum">    3985 </span>            :     int state_max, ent_max, old_state_max, old_ent_max;
<span class="lineNum">    3986 </span>            :     int i, j, ent, new_state, ent_size;
<span class="lineNum">    3987 </span>            :     int error;
<span class="lineNum">    3988 </span>            : 
<span class="lineNum">    3989 </span><span class="lineCov">          1 :     st-&gt;state_start = here;</span>
<span class="lineNum">    3990 </span>            : 
<span class="lineNum">    3991 </span><span class="lineCov">          1 :     if ( ismorx ) {</span>
<span class="lineNum">    3992 </span><span class="lineCov">          1 :         nclasses = getlong(ttf);</span>
<span class="lineNum">    3993 </span><span class="lineCov">          1 :         class_off = getlong(ttf);</span>
<span class="lineNum">    3994 </span><span class="lineCov">          1 :         state_off = getlong(ttf);</span>
<span class="lineNum">    3995 </span><span class="lineCov">          1 :         entry_off = getlong(ttf);</span>
<span class="lineNum">    3996 </span><span class="lineCov">          1 :         st-&gt;extra_offsets[0] = getlong(ttf);</span>
<span class="lineNum">    3997 </span><span class="lineCov">          1 :         st-&gt;extra_offsets[1] = getlong(ttf);</span>
<span class="lineNum">    3998 </span><span class="lineCov">          1 :         st-&gt;extra_offsets[2] = getlong(ttf);</span>
<span class="lineNum">    3999 </span>            :     } else {
<span class="lineNum">    4000 </span><span class="lineNoCov">          0 :         nclasses = getushort(ttf);      /* Number of bytes per state in state subtable, equal to number of classes */</span>
<span class="lineNum">    4001 </span><span class="lineNoCov">          0 :         class_off = getushort(ttf);</span>
<span class="lineNum">    4002 </span><span class="lineNoCov">          0 :         state_off = getushort(ttf);</span>
<span class="lineNum">    4003 </span><span class="lineNoCov">          0 :         entry_off = getushort(ttf);</span>
<span class="lineNum">    4004 </span><span class="lineNoCov">          0 :         st-&gt;extra_offsets[0] = getushort(ttf);</span>
<span class="lineNum">    4005 </span><span class="lineNoCov">          0 :         st-&gt;extra_offsets[1] = getushort(ttf);</span>
<span class="lineNum">    4006 </span><span class="lineNoCov">          0 :         st-&gt;extra_offsets[2] = getushort(ttf);</span>
<span class="lineNum">    4007 </span>            :     }
<span class="lineNum">    4008 </span><span class="lineCov">          1 :     st-&gt;nclasses = nclasses;</span>
<span class="lineNum">    4009 </span><span class="lineCov">          1 :     st-&gt;state_offset = state_off;</span>
<span class="lineNum">    4010 </span>            : 
<span class="lineNum">    4011 </span>            :         /* parse class subtable */
<span class="lineNum">    4012 </span><span class="lineCov">          1 :     fseek(ttf,here+class_off,SEEK_SET);</span>
<span class="lineNum">    4013 </span><span class="lineCov">          1 :     error = 0;</span>
<span class="lineNum">    4014 </span><span class="lineCov">          1 :     if ( ismorx ) {</span>
<span class="lineNum">    4015 </span>            :         /* I used only to allocate space for info-&gt;glyph_cnt entries */
<span class="lineNum">    4016 </span>            :         /*  but some fonts use out of bounds gids as flags to contextual */
<span class="lineNum">    4017 </span>            :         /*  morx subtables, so allocate a full 65536 */
<span class="lineNum">    4018 </span><span class="lineCov">          1 :         st-&gt;classes2 = info-&gt;morx_classes = malloc(65536*sizeof(uint16));</span>
<span class="lineNum">    4019 </span><span class="lineCov">      65537 :         for ( i=0; i&lt;65536; ++i )</span>
<span class="lineNum">    4020 </span><span class="lineCov">      65536 :             st-&gt;classes2[i] = 1;                     /* Out of bounds */</span>
<span class="lineNum">    4021 </span><span class="lineCov">          1 :         readttf_applelookup(ttf,info,</span>
<span class="lineNum">    4022 </span>            :                 mortclass_apply_values,mortclass_apply_value,NULL,NULL,true);
<span class="lineNum">    4023 </span><span class="lineCov">      65537 :         for ( i=0; i&lt;65536; ++i ) {</span>
<span class="lineNum">    4024 </span><span class="lineCov">      65536 :             if ( /*st-&gt;classes2[i]&lt;0 ||*/ st-&gt;classes2[i]&gt;=st-&gt;nclasses ) {</span>
<span class="lineNum">    4025 </span><span class="lineNoCov">          0 :                 if ( !error )</span>
<span class="lineNum">    4026 </span><span class="lineNoCov">          0 :                     LogError( _(&quot;Bad class in state machine.\n&quot; ));</span>
<span class="lineNum">    4027 </span><span class="lineNoCov">          0 :                 info-&gt;bad_gx = true;</span>
<span class="lineNum">    4028 </span><span class="lineNoCov">          0 :                 error = true;</span>
<span class="lineNum">    4029 </span><span class="lineNoCov">          0 :                 st-&gt;classes2[i] = 1;                 /* Out of bounds */</span>
<span class="lineNum">    4030 </span>            :             }
<span class="lineNum">    4031 </span>            :         }
<span class="lineNum">    4032 </span>            :     } else {
<span class="lineNum">    4033 </span><span class="lineNoCov">          0 :         st-&gt;first_glyph = getushort(ttf);</span>
<span class="lineNum">    4034 </span><span class="lineNoCov">          0 :         st-&gt;nglyphs = getushort(ttf);</span>
<span class="lineNum">    4035 </span><span class="lineNoCov">          0 :         if ( feof(ttf)) {</span>
<span class="lineNum">    4036 </span><span class="lineNoCov">          0 :             LogError(_(&quot;Bad glyph count in mort table.\n&quot;));</span>
<span class="lineNum">    4037 </span><span class="lineNoCov">          0 :             info-&gt;bad_gx = true;</span>
<span class="lineNum">    4038 </span><span class="lineNoCov">          0 :             st-&gt;nglyphs = 0;</span>
<span class="lineNum">    4039 </span>            :         }
<span class="lineNum">    4040 </span><span class="lineNoCov">          0 :         st-&gt;classes = malloc(st-&gt;nglyphs);</span>
<span class="lineNum">    4041 </span><span class="lineNoCov">          0 :         fread(st-&gt;classes,1,st-&gt;nglyphs,ttf);</span>
<span class="lineNum">    4042 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;st-&gt;nglyphs; ++i ) {</span>
<span class="lineNum">    4043 </span><span class="lineNoCov">          0 :             if ( /*st-&gt;classes[i]&lt;0 ||*/ st-&gt;classes[i]&gt;=st-&gt;nclasses ) {</span>
<span class="lineNum">    4044 </span><span class="lineNoCov">          0 :                 if ( !error )</span>
<span class="lineNum">    4045 </span><span class="lineNoCov">          0 :                     LogError( _(&quot;Bad class in state machine.\n&quot; ));</span>
<span class="lineNum">    4046 </span><span class="lineNoCov">          0 :                 info-&gt;bad_gx = true;</span>
<span class="lineNum">    4047 </span><span class="lineNoCov">          0 :                 error = true;</span>
<span class="lineNum">    4048 </span><span class="lineNoCov">          0 :                 st-&gt;classes[i] = 1;                  /* Out of bounds */</span>
<span class="lineNum">    4049 </span>            :             }
<span class="lineNum">    4050 </span>            :         }
<span class="lineNum">    4051 </span>            :     }
<span class="lineNum">    4052 </span>            : 
<span class="lineNum">    4053 </span>            : 
<span class="lineNum">    4054 </span>            :     /* The size of an entry is variable. There are 2 uint16 fields at the begin-*/
<span class="lineNum">    4055 </span>            :     /*  ning of all entries. There may be some number of shorts following these*/
<span class="lineNum">    4056 </span>            :     /*  used for indexing special tables. */
<span class="lineNum">    4057 </span><span class="lineCov">          1 :     ent_size = 4 + 2*ent_extras;</span>
<span class="lineNum">    4058 </span><span class="lineCov">          1 :     st-&gt;entry_size = ent_size;</span>
<span class="lineNum">    4059 </span><span class="lineCov">          1 :     st-&gt;entry_extras = ent_extras;</span>
<span class="lineNum">    4060 </span>            : 
<span class="lineNum">    4061 </span>            :     /* Apple does not provide a way of figuring out the size of either of the */
<span class="lineNum">    4062 </span>            :     /*  state or entry tables, so we must parse both as we go and try to work */
<span class="lineNum">    4063 </span>            :     /*  out the maximum values... */
<span class="lineNum">    4064 </span>            :     /* There are always at least 2 states defined. Parse them and find what */
<span class="lineNum">    4065 </span>            :     /*  is the biggest entry they use, then parse those entries and find what */
<span class="lineNum">    4066 </span>            :     /*  is the biggest state they use, and then repeat until we don't find any*/
<span class="lineNum">    4067 </span>            :     /*  more states or entries */
<span class="lineNum">    4068 </span><span class="lineCov">          1 :     old_state_max = 0; old_ent_max = 0;</span>
<span class="lineNum">    4069 </span><span class="lineCov">          1 :     state_max = 2; ent_max = 0;</span>
<span class="lineNum">    4070 </span><span class="lineCov">          4 :     while ( old_state_max!=state_max ) {</span>
<span class="lineNum">    4071 </span><span class="lineCov">          2 :         i = old_state_max*nclasses;</span>
<span class="lineNum">    4072 </span><span class="lineCov">          2 :         fseek(ttf,here+state_off+(ismorx?i*sizeof(uint16):i),SEEK_SET);</span>
<span class="lineNum">    4073 </span><span class="lineCov">          2 :         old_state_max = state_max;</span>
<span class="lineNum">    4074 </span><span class="lineCov">         23 :         for ( ; i&lt;state_max*nclasses; ++i ) {</span>
<span class="lineNum">    4075 </span><span class="lineCov">         21 :             ent = ismorx ? getushort(ttf) : getc(ttf);</span>
<span class="lineNum">    4076 </span><span class="lineCov">         21 :             if ( ent+1 &gt; ent_max )</span>
<span class="lineNum">    4077 </span><span class="lineCov">          5 :                 ent_max = ent+1;</span>
<span class="lineNum">    4078 </span>            :         }
<span class="lineNum">    4079 </span><span class="lineCov">          2 :         if ( ent_max==old_ent_max )             /* Nothing more */</span>
<span class="lineNum">    4080 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    4081 </span><span class="lineCov">          2 :         if ( ent_max&gt;1000 ) {</span>
<span class="lineNum">    4082 </span><span class="lineNoCov">          0 :             LogError( _(&quot;It looks to me as though there's a morx sub-table with more than 1000\n transitions. Which makes me think there's probably an error\n&quot; ));</span>
<span class="lineNum">    4083 </span><span class="lineNoCov">          0 :             info-&gt;bad_gx = true;</span>
<span class="lineNum">    4084 </span><span class="lineNoCov">          0 :             free(st);</span>
<span class="lineNum">    4085 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    4086 </span>            :         }
<span class="lineNum">    4087 </span><span class="lineCov">          2 :         fseek(ttf,here+entry_off+old_ent_max*ent_size,SEEK_SET);</span>
<span class="lineNum">    4088 </span><span class="lineCov">          2 :         i = old_ent_max;</span>
<span class="lineNum">    4089 </span><span class="lineCov">          2 :         old_ent_max = ent_max;</span>
<span class="lineNum">    4090 </span><span class="lineCov">          7 :         for ( ; i&lt;ent_max; ++i ) {</span>
<span class="lineNum">    4091 </span><span class="lineCov">          5 :             new_state = getushort(ttf);</span>
<span class="lineNum">    4092 </span><span class="lineCov">          5 :             if ( !ismorx )</span>
<span class="lineNum">    4093 </span><span class="lineNoCov">          0 :                 new_state = (new_state-state_off)/nclasses;</span>
<span class="lineNum">    4094 </span><span class="lineCov">          5 :             /* flags = */ getushort(ttf);</span>
<span class="lineNum">    4095 </span><span class="lineCov">         15 :             for ( j=0; j&lt;ent_extras; ++j )</span>
<span class="lineNum">    4096 </span><span class="lineCov">         10 :                 /* glyphOffsets[j] = */ getushort(ttf);</span>
<span class="lineNum">    4097 </span><span class="lineCov">          5 :             if ( new_state+1&gt;state_max )</span>
<span class="lineNum">    4098 </span><span class="lineCov">          1 :                 state_max = new_state+1;</span>
<span class="lineNum">    4099 </span>            :         }
<span class="lineNum">    4100 </span><span class="lineCov">          2 :         if ( state_max&gt;1000 ) {</span>
<span class="lineNum">    4101 </span><span class="lineNoCov">          0 :             LogError( _(&quot;It looks to me as though there's a morx sub-table with more than 1000\n states. Which makes me think there's probably an error\n&quot; ));</span>
<span class="lineNum">    4102 </span><span class="lineNoCov">          0 :             info-&gt;bad_gx = true;</span>
<span class="lineNum">    4103 </span><span class="lineNoCov">          0 :             free(st);</span>
<span class="lineNum">    4104 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    4105 </span>            :         }
<span class="lineNum">    4106 </span>            :     }
<span class="lineNum">    4107 </span>            : 
<span class="lineNum">    4108 </span><span class="lineCov">          1 :     st-&gt;nstates = state_max;</span>
<span class="lineNum">    4109 </span><span class="lineCov">          1 :     st-&gt;nentries = ent_max;</span>
<span class="lineNum">    4110 </span>            :     
<span class="lineNum">    4111 </span><span class="lineCov">          1 :     fseek(ttf,here+state_off,SEEK_SET);</span>
<span class="lineNum">    4112 </span>            :     /* an array of arrays of state transitions, each represented by one byte */
<span class="lineNum">    4113 </span>            :     /*  which is an index into the Entry subtable, which comes next. */
<span class="lineNum">    4114 </span>            :     /* One dimension is the number of states, and the other the */
<span class="lineNum">    4115 </span>            :     /*  number of classes (classes vary faster than states) */
<span class="lineNum">    4116 </span>            :     /* The first two states are predefined, 0 is start of text, 1 start of line*/
<span class="lineNum">    4117 </span><span class="lineCov">          1 :     if ( ismorx ) {</span>
<span class="lineNum">    4118 </span><span class="lineCov">          1 :         st-&gt;state_table2 = malloc(st-&gt;nstates*st-&gt;nclasses*sizeof(uint16));</span>
<span class="lineNum">    4119 </span><span class="lineCov">         22 :         for ( i=0; i&lt;st-&gt;nstates*st-&gt;nclasses; ++i )</span>
<span class="lineNum">    4120 </span><span class="lineCov">         21 :             st-&gt;state_table2[i] = getushort(ttf);</span>
<span class="lineNum">    4121 </span>            :     } else {
<span class="lineNum">    4122 </span><span class="lineNoCov">          0 :         st-&gt;state_table = malloc(st-&gt;nstates*st-&gt;nclasses);</span>
<span class="lineNum">    4123 </span><span class="lineNoCov">          0 :         fread(st-&gt;state_table,1,st-&gt;nstates*st-&gt;nclasses,ttf);</span>
<span class="lineNum">    4124 </span>            :     }
<span class="lineNum">    4125 </span>            : 
<span class="lineNum">    4126 </span>            :         /* parse the entry subtable */
<span class="lineNum">    4127 </span><span class="lineCov">          1 :     fseek(ttf,here+entry_off,SEEK_SET);</span>
<span class="lineNum">    4128 </span><span class="lineCov">          1 :     st-&gt;transitions = malloc(st-&gt;nentries*st-&gt;entry_size);</span>
<span class="lineNum">    4129 </span><span class="lineCov">          1 :     fread(st-&gt;transitions,1,st-&gt;nentries*st-&gt;entry_size,ttf);</span>
<span class="lineNum">    4130 </span><span class="lineCov">          1 : return( st );</span>
<a name="4131"><span class="lineNum">    4131 </span>            : }</a>
<span class="lineNum">    4132 </span>            : 
<span class="lineNum">    4133 </span><span class="lineCov">          1 : static void statetablefree(struct statetable *st) {</span>
<span class="lineNum">    4134 </span><span class="lineCov">          1 :     free( st-&gt;classes );</span>
<span class="lineNum">    4135 </span><span class="lineCov">          1 :     free( st-&gt;state_table );</span>
<span class="lineNum">    4136 </span><span class="lineCov">          1 :     free( st-&gt;classes2 );</span>
<span class="lineNum">    4137 </span><span class="lineCov">          1 :     free( st-&gt;state_table2 );</span>
<span class="lineNum">    4138 </span><span class="lineCov">          1 :     free( st-&gt;transitions );</span>
<span class="lineNum">    4139 </span><span class="lineCov">          1 :     free( st );</span>
<a name="4140"><span class="lineNum">    4140 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    4141 </span>            : 
<span class="lineNum">    4142 </span><span class="lineCov">          1 : static void tagSMWithScriptLang(FeatureScriptLangList *fl,</span>
<span class="lineNum">    4143 </span>            :         struct statetable *st,int ismorx,struct ttfinfo *info) {
<span class="lineNum">    4144 </span>            :     int i;
<span class="lineNum">    4145 </span>            : 
<span class="lineNum">    4146 </span><span class="lineCov">          1 :     if ( ismorx ) {</span>
<span class="lineNum">    4147 </span><span class="lineCov">        166 :         for ( i=0; i&lt;info-&gt;glyph_cnt; ++i )</span>
<span class="lineNum">    4148 </span><span class="lineCov">        165 :             if ( st-&gt;classes2[i]&gt;=4 &amp;&amp; info-&gt;chars[i]!=NULL )</span>
<span class="lineNum">    4149 </span><span class="lineCov">         31 :                 FListsAppendScriptLang(fl,SCScriptFromUnicode(info-&gt;chars[i]),</span>
<span class="lineNum">    4150 </span>            :                         DEFAULT_LANG);
<span class="lineNum">    4151 </span>            :     } else {
<span class="lineNum">    4152 </span><span class="lineNoCov">          0 :         for ( i=st-&gt;first_glyph; i&lt;st-&gt;first_glyph+st-&gt;nglyphs &amp;&amp; i&lt;info-&gt;glyph_cnt; ++i )</span>
<span class="lineNum">    4153 </span><span class="lineNoCov">          0 :             if ( info-&gt;chars[i]!=NULL )</span>
<span class="lineNum">    4154 </span><span class="lineNoCov">          0 :                 FListsAppendScriptLang(fl,SCScriptFromUnicode(info-&gt;chars[i]),</span>
<span class="lineNum">    4155 </span>            :                         DEFAULT_LANG);
<span class="lineNum">    4156 </span>            :     }
<a name="4157"><span class="lineNum">    4157 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    4158 </span>            : 
<span class="lineNum">    4159 </span><span class="lineCov">          1 : static char **ClassesFromStateTable(struct statetable *st,int ismorx,struct ttfinfo *info) {</span>
<span class="lineNum">    4160 </span>            :     /* On the mac the first four classes should be left blank. only class 1 */
<span class="lineNum">    4161 </span>            :     /*  (out of bounds) is supposed to be used in the class array anyway */
<span class="lineNum">    4162 </span><span class="lineCov">          1 :     char **classes = malloc(st-&gt;nclasses*sizeof(char *));</span>
<span class="lineNum">    4163 </span><span class="lineCov">          1 :     int *lens = calloc(st-&gt;nclasses,sizeof(int));</span>
<span class="lineNum">    4164 </span>            :     int i;
<span class="lineNum">    4165 </span>            : 
<span class="lineNum">    4166 </span>            : 
<span class="lineNum">    4167 </span><span class="lineCov">          1 :     if ( ismorx ) {</span>
<span class="lineNum">    4168 </span><span class="lineCov">        166 :         for ( i=0; i&lt;info-&gt;glyph_cnt; ++i ) if ( info-&gt;chars[i]!=NULL )</span>
<span class="lineNum">    4169 </span><span class="lineCov">        165 :             lens[st-&gt;classes2[i]] += strlen( info-&gt;chars[i]-&gt;name )+1;</span>
<span class="lineNum">    4170 </span><span class="lineCov">          1 :         if ( info-&gt;badgids!=NULL )</span>
<span class="lineNum">    4171 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;info-&gt;badgid_cnt; ++i ) if ( info-&gt;badgids[i]!=NULL )</span>
<span class="lineNum">    4172 </span><span class="lineNoCov">          0 :                 lens[st-&gt;classes2[info-&gt;badgids[i]-&gt;orig_pos]] += strlen( info-&gt;badgids[i]-&gt;name )+1;</span>
<span class="lineNum">    4173 </span>            :     } else {
<span class="lineNum">    4174 </span><span class="lineNoCov">          0 :         for ( i=st-&gt;first_glyph; i&lt;st-&gt;first_glyph+st-&gt;nglyphs &amp;&amp; i&lt;info-&gt;glyph_cnt; ++i )</span>
<span class="lineNum">    4175 </span><span class="lineNoCov">          0 :             if ( info-&gt;chars[i]!=NULL )</span>
<span class="lineNum">    4176 </span><span class="lineNoCov">          0 :                 lens[st-&gt;classes[i-st-&gt;first_glyph]] += strlen( info-&gt;chars[i]-&gt;name )+1;</span>
<span class="lineNum">    4177 </span>            :     }
<span class="lineNum">    4178 </span><span class="lineCov">          1 :     classes[0] = classes[1] = classes[2] = classes[3] = NULL;</span>
<span class="lineNum">    4179 </span><span class="lineCov">          4 :     for ( i=4; i&lt;st-&gt;nclasses; ++i ) {</span>
<span class="lineNum">    4180 </span><span class="lineCov">          3 :         classes[i] = malloc(lens[i]+1);</span>
<span class="lineNum">    4181 </span><span class="lineCov">          3 :         *classes[i] = '\0';</span>
<span class="lineNum">    4182 </span>            :     }
<span class="lineNum">    4183 </span><span class="lineCov">          1 :     if ( ismorx ) {</span>
<span class="lineNum">    4184 </span><span class="lineCov">        166 :         for ( i=0; i&lt;info-&gt;glyph_cnt; ++i ) if ( st-&gt;classes2[i]&gt;=4 &amp;&amp; info-&gt;chars[i]!=NULL ) {</span>
<span class="lineNum">    4185 </span><span class="lineCov">         31 :             strcat(classes[st-&gt;classes2[i]],info-&gt;chars[i]-&gt;name );</span>
<span class="lineNum">    4186 </span><span class="lineCov">         31 :             strcat(classes[st-&gt;classes2[i]],&quot; &quot;);</span>
<span class="lineNum">    4187 </span>            :         }
<span class="lineNum">    4188 </span><span class="lineCov">          1 :         if ( info-&gt;badgids!=NULL )</span>
<span class="lineNum">    4189 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;info-&gt;badgid_cnt; ++i ) if ( info-&gt;badgids[i]!=NULL &amp;&amp; st-&gt;classes2[info-&gt;badgids[i]-&gt;orig_pos]&gt;=4) {</span>
<span class="lineNum">    4190 </span><span class="lineNoCov">          0 :                 strcat(classes[st-&gt;classes2[info-&gt;badgids[i]-&gt;orig_pos]],info-&gt;badgids[i]-&gt;name );</span>
<span class="lineNum">    4191 </span><span class="lineNoCov">          0 :                 strcat(classes[st-&gt;classes2[info-&gt;badgids[i]-&gt;orig_pos]],&quot; &quot;);</span>
<span class="lineNum">    4192 </span>            :             }
<span class="lineNum">    4193 </span>            :     } else {
<span class="lineNum">    4194 </span><span class="lineNoCov">          0 :         for ( i=st-&gt;first_glyph; i&lt;st-&gt;first_glyph+st-&gt;nglyphs &amp;&amp; i&lt;info-&gt;glyph_cnt; ++i ) if ( st-&gt;classes[i-st-&gt;first_glyph]&gt;=4 &amp;&amp; info-&gt;chars[i]!=NULL ) {</span>
<span class="lineNum">    4195 </span><span class="lineNoCov">          0 :             strcat(classes[st-&gt;classes[i-st-&gt;first_glyph]],info-&gt;chars[i]-&gt;name );</span>
<span class="lineNum">    4196 </span><span class="lineNoCov">          0 :             strcat(classes[st-&gt;classes[i-st-&gt;first_glyph]],&quot; &quot; );</span>
<span class="lineNum">    4197 </span>            :         }
<span class="lineNum">    4198 </span>            :     }
<span class="lineNum">    4199 </span><span class="lineCov">          4 :     for ( i=4; i&lt;st-&gt;nclasses; ++i ) {</span>
<span class="lineNum">    4200 </span><span class="lineCov">          3 :         int len = strlen(classes[i]);</span>
<span class="lineNum">    4201 </span><span class="lineCov">          3 :         if ( len!=0 )</span>
<span class="lineNum">    4202 </span><span class="lineCov">          3 :             classes[i][len-1] = '\0';   /* Remove trailing space */</span>
<span class="lineNum">    4203 </span>            :     }
<span class="lineNum">    4204 </span><span class="lineCov">          1 :     free(lens);</span>
<span class="lineNum">    4205 </span><span class="lineCov">          1 : return( classes );</span>
<a name="4206"><span class="lineNum">    4206 </span>            : }</a>
<span class="lineNum">    4207 </span>            : 
<span class="lineNum">    4208 </span><span class="lineNoCov">          0 : static char *NamesOfList(uint32 pos,int cnt, FILE *ttf, struct ttfinfo *info) {</span>
<span class="lineNum">    4209 </span>            :     int i, len, glyph;
<span class="lineNum">    4210 </span>            :     char *str;
<span class="lineNum">    4211 </span>            : 
<span class="lineNum">    4212 </span><span class="lineNoCov">          0 :     if ( cnt==0 )</span>
<span class="lineNum">    4213 </span><span class="lineNoCov">          0 : return(NULL);</span>
<span class="lineNum">    4214 </span>            : 
<span class="lineNum">    4215 </span><span class="lineNoCov">          0 :     fseek(ttf,pos,SEEK_SET);</span>
<span class="lineNum">    4216 </span><span class="lineNoCov">          0 :     for ( i=len=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    4217 </span><span class="lineNoCov">          0 :         glyph = getushort(ttf);</span>
<span class="lineNum">    4218 </span><span class="lineNoCov">          0 :         if ( glyph&lt;info-&gt;glyph_cnt )</span>
<span class="lineNum">    4219 </span><span class="lineNoCov">          0 :             len += strlen(info-&gt;chars[glyph]-&gt;name)+1;</span>
<span class="lineNum">    4220 </span>            :     }
<span class="lineNum">    4221 </span><span class="lineNoCov">          0 :     if ( len==0 )</span>
<span class="lineNum">    4222 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    4223 </span><span class="lineNoCov">          0 :     str = malloc(len+1);</span>
<span class="lineNum">    4224 </span><span class="lineNoCov">          0 :     fseek(ttf,pos,SEEK_SET);</span>
<span class="lineNum">    4225 </span><span class="lineNoCov">          0 :     for ( i=len=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    4226 </span><span class="lineNoCov">          0 :         glyph = getushort(ttf);</span>
<span class="lineNum">    4227 </span><span class="lineNoCov">          0 :         if ( glyph&lt;info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    4228 </span><span class="lineNoCov">          0 :             strcpy(str+len,info-&gt;chars[glyph]-&gt;name);</span>
<span class="lineNum">    4229 </span><span class="lineNoCov">          0 :             len += strlen(info-&gt;chars[glyph]-&gt;name);</span>
<span class="lineNum">    4230 </span><span class="lineNoCov">          0 :             str[len++] = ' ';</span>
<span class="lineNum">    4231 </span>            :         }
<span class="lineNum">    4232 </span>            :     }
<span class="lineNum">    4233 </span><span class="lineNoCov">          0 :     str[len-1] = '\0';</span>
<span class="lineNum">    4234 </span><span class="lineNoCov">          0 : return( str );</span>
<a name="4235"><span class="lineNum">    4235 </span>            : }</a>
<span class="lineNum">    4236 </span>            : 
<span class="lineNum">    4237 </span><span class="lineNoCov">          0 : static void KernReadKernList(FILE *ttf,uint32 pos, struct asm_state *trans) {</span>
<span class="lineNum">    4238 </span>            : /* Apple does not document how to detect the end of the list */
<span class="lineNum">    4239 </span>            : /* They say &quot;an odd value that depends on coverage&quot; */
<span class="lineNum">    4240 </span>            : /* They should say &quot;an odd value&quot;. Any odd value terminates the list. */
<span class="lineNum">    4241 </span>            : /*  coverage is irrelevant */
<span class="lineNum">    4242 </span>            : /* Note: List is backwards (glyphs are popped of LIFO so last glyph on */
<span class="lineNum">    4243 </span>            : /*  in stack gets first kern value) */
<span class="lineNum">    4244 </span>            : /*  There are at most 8 glyphs */
<span class="lineNum">    4245 </span>            :     int i,j,k;
<span class="lineNum">    4246 </span>            :     int16 buffer[8];            /* At most 8 kerns are supported */
<span class="lineNum">    4247 </span>            : 
<span class="lineNum">    4248 </span><span class="lineNoCov">          0 :     fseek(ttf,pos,SEEK_SET);</span>
<span class="lineNum">    4249 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;8; ++i ) {</span>
<span class="lineNum">    4250 </span><span class="lineNoCov">          0 :         buffer[i]=(int16) getushort(ttf);</span>
<span class="lineNum">    4251 </span><span class="lineNoCov">          0 :         if ( buffer[i]&amp;1 ) {</span>
<span class="lineNum">    4252 </span><span class="lineNoCov">          0 :             buffer[i] &amp;= ~1;</span>
<span class="lineNum">    4253 </span><span class="lineNoCov">          0 :             ++i;</span>
<span class="lineNum">    4254 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    4255 </span>            :         }
<span class="lineNum">    4256 </span>            :     }
<span class="lineNum">    4257 </span><span class="lineNoCov">          0 :     if ( i==0 ) {</span>
<span class="lineNum">    4258 </span><span class="lineNoCov">          0 :         trans-&gt;u.kern.kerns = NULL;</span>
<span class="lineNum">    4259 </span>            :     } else {
<span class="lineNum">    4260 </span><span class="lineNoCov">          0 :         trans-&gt;u.kern.kerns = malloc(i*sizeof(int16));</span>
<span class="lineNum">    4261 </span><span class="lineNoCov">          0 :         for ( j=i-1, k=0; k&lt;i; ++k, --j )</span>
<span class="lineNum">    4262 </span><span class="lineNoCov">          0 :             trans-&gt;u.kern.kerns[k] = buffer[j];</span>
<span class="lineNum">    4263 </span>            :     }
<span class="lineNum">    4264 </span><span class="lineNoCov">          0 :     trans-&gt;u.kern.kcnt = i;</span>
<a name="4265"><span class="lineNum">    4265 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    4266 </span>            : 
<span class="lineNum">    4267 </span><span class="lineNoCov">          0 : static void read_perglyph_subs(FILE *ttf,struct ttfinfo *info,</span>
<span class="lineNum">    4268 </span>            :         int subs_base,int subs_end,struct statetable *st,
<span class="lineNum">    4269 </span>            :         uint8 *classes_subbed, int evermarked, uint8 *used) {
<span class="lineNum">    4270 </span>            :     /* The file is positioned at the start of a per-glyph substitution table */
<span class="lineNum">    4271 </span>            :     /* Sadly great chunks of this table have been omitted. We are where glyph */
<span class="lineNum">    4272 </span>            :     /*  0 would be if it were present. We've no idea what has been omitted */
<span class="lineNum">    4273 </span>            :     /* Simple checks: if the file pointer is outside of the area devoted to */
<span class="lineNum">    4274 </span>            :     /*   substitutions then we know it is ignorable. */
<span class="lineNum">    4275 </span>            :     /*  If the current glyph is not in the list of glyphs which could ever */
<span class="lineNum">    4276 </span>            :     /*   be substituted then we know it is ignorable. */
<span class="lineNum">    4277 </span>            :     /*  Note: the above list is easily figured for substitutions on the current*/
<span class="lineNum">    4278 </span>            :     /*   glyph, but if a substitution ever happens to a marked glyph then we */
<span class="lineNum">    4279 </span>            :     /*   can't guess. We could check for all classes that get marked, but that*/
<span class="lineNum">    4280 </span>            :     /*   doesn't work if there is a current substitution before the class is */
<span class="lineNum">    4281 </span>            :     /*   marked, after that we don't know what class the glyph might have */
<span class="lineNum">    4282 </span>            :     /*   Instead, for marked subs, we keep track of all locations which were */
<span class="lineNum">    4283 </span>            :     /*   used in a current-only sub, and assume that they aren't valid for us */
<span class="lineNum">    4284 </span>            :     /*  If the putative substitution glyph is not a valid glyph then we know */
<span class="lineNum">    4285 </span>            :     /*   it is ignorable */
<span class="lineNum">    4286 </span><span class="lineNoCov">          0 :     int i, subs, was = info-&gt;mort_tag_mac;</span>
<span class="lineNum">    4287 </span>            :     uint32 here;
<span class="lineNum">    4288 </span>            : 
<span class="lineNum">    4289 </span><span class="lineNoCov">          0 :     info-&gt;mort_tag_mac = false;</span>
<span class="lineNum">    4290 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;info-&gt;glyph_cnt; ++i ) {</span>
<span class="lineNum">    4291 </span><span class="lineNoCov">          0 :         here = ftell(ttf);</span>
<span class="lineNum">    4292 </span><span class="lineNoCov">          0 :         subs = getushort(ttf);</span>
<span class="lineNum">    4293 </span><span class="lineNoCov">          0 :         if ( subs&gt;=info-&gt;glyph_cnt &amp;&amp; subs!=0xffff )      /* 0xffff means delete the substituted glyph */</span>
<span class="lineNum">    4294 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    4295 </span><span class="lineNoCov">          0 :         if ( subs==0 )                  /* A little risky, one could substitute notdef */</span>
<span class="lineNum">    4296 </span><span class="lineNoCov">          0 :     continue;                           /*  but they shouldn't */</span>
<span class="lineNum">    4297 </span><span class="lineNoCov">          0 :         if ( here&lt;subs_base )</span>
<span class="lineNum">    4298 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    4299 </span><span class="lineNoCov">          0 :         if ( here&gt;=subs_end )</span>
<span class="lineNum">    4300 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    4301 </span><span class="lineNoCov">          0 :         if ( evermarked ) {</span>
<span class="lineNum">    4302 </span><span class="lineNoCov">          0 :             if ( used[(here-subs_base)/2] )</span>
<span class="lineNum">    4303 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    4304 </span><span class="lineNoCov">          0 :         } else if ( i&lt;st-&gt;first_glyph || i&gt;=st-&gt;first_glyph+st-&gt;nglyphs ) {</span>
<span class="lineNum">    4305 </span><span class="lineNoCov">          0 :             if ( !classes_subbed[1]) {  /* Out of bounds class */</span>
<span class="lineNum">    4306 </span><span class="lineNoCov">          0 :                 if ( i&gt;=st-&gt;first_glyph+st-&gt;nglyphs )</span>
<span class="lineNum">    4307 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    4308 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    4309 </span>            :             }
<span class="lineNum">    4310 </span>            :         } else {
<span class="lineNum">    4311 </span><span class="lineNoCov">          0 :             if ( !classes_subbed[st-&gt;classes[i-st-&gt;first_glyph]] )</span>
<span class="lineNum">    4312 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    4313 </span>            :         }
<span class="lineNum">    4314 </span>            : 
<span class="lineNum">    4315 </span><span class="lineNoCov">          0 :         if ( !evermarked )</span>
<span class="lineNum">    4316 </span><span class="lineNoCov">          0 :             used[(here-subs_base)/2] = true;</span>
<span class="lineNum">    4317 </span><span class="lineNoCov">          0 :         TTF_SetMortSubs(info, i, subs);</span>
<span class="lineNum">    4318 </span>            :     }
<span class="lineNum">    4319 </span><span class="lineNoCov">          0 :     info-&gt;mort_tag_mac = was;</span>
<a name="4320"><span class="lineNum">    4320 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    4321 </span>            : 
<span class="lineNum">    4322 </span><span class="lineNoCov">          0 : static int sm_lookupfind(int32 *lookups,int *_lm,int off) {</span>
<span class="lineNum">    4323 </span><span class="lineNoCov">          0 :     int lm = *_lm, i;</span>
<span class="lineNum">    4324 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;=lm; ++i )</span>
<span class="lineNum">    4325 </span><span class="lineNoCov">          0 :         if ( lookups[i]==off )</span>
<span class="lineNum">    4326 </span><span class="lineNoCov">          0 : return( i );</span>
<span class="lineNum">    4327 </span><span class="lineNoCov">          0 :     (*_lm)++;</span>
<span class="lineNum">    4328 </span><span class="lineNoCov">          0 :     lookups[i] = off;</span>
<span class="lineNum">    4329 </span><span class="lineNoCov">          0 : return( i );</span>
<a name="4330"><span class="lineNum">    4330 </span>            : }</a>
<span class="lineNum">    4331 </span>            : 
<span class="lineNum">    4332 </span><span class="lineCov">          1 : static ASM *readttf_mortx_asm(FILE *ttf,struct ttfinfo *info,int ismorx,</span>
<span class="lineNum">    4333 </span>            :         uint32 subtab_len,enum asm_type type,int extras,
<span class="lineNum">    4334 </span>            :         uint32 coverage, OTLookup *otl) {
<span class="lineNum">    4335 </span>            :     struct statetable *st;
<span class="lineNum">    4336 </span>            :     ASM *as;
<span class="lineNum">    4337 </span>            :     int i,j;
<span class="lineNum">    4338 </span><span class="lineCov">          1 :     uint32 here = ftell(ttf);</span>
<span class="lineNum">    4339 </span>            : 
<span class="lineNum">    4340 </span><span class="lineCov">          1 :     st = read_statetable(ttf,extras,ismorx,info);</span>
<span class="lineNum">    4341 </span><span class="lineCov">          1 :     if ( st==NULL )</span>
<span class="lineNum">    4342 </span><span class="lineNoCov">          0 : return(NULL);</span>
<span class="lineNum">    4343 </span>            : 
<span class="lineNum">    4344 </span><span class="lineCov">          1 :     as = chunkalloc(sizeof(ASM));</span>
<span class="lineNum">    4345 </span><span class="lineCov">          1 :     as-&gt;type = type;</span>
<span class="lineNum">    4346 </span><span class="lineCov">          1 :     as-&gt;flags = coverage&gt;&gt;16;</span>
<span class="lineNum">    4347 </span><span class="lineCov">          1 :     as-&gt;class_cnt = st-&gt;nclasses;</span>
<span class="lineNum">    4348 </span><span class="lineCov">          1 :     as-&gt;state_cnt = st-&gt;nstates;</span>
<span class="lineNum">    4349 </span><span class="lineCov">          1 :     as-&gt;classes = ClassesFromStateTable(st,ismorx,info);</span>
<span class="lineNum">    4350 </span><span class="lineCov">          1 :     as-&gt;state = malloc(st-&gt;nclasses*st-&gt;nstates*sizeof(struct asm_state));</span>
<span class="lineNum">    4351 </span><span class="lineCov">          1 :     if ( otl==NULL )</span>
<span class="lineNum">    4352 </span><span class="lineCov">          1 :         otl = NewMacLookup(info,false);</span>
<span class="lineNum">    4353 </span><span class="lineCov">          1 :     otl-&gt;lookup_type = type==asm_indic ? morx_indic : type==asm_context ? morx_context : morx_insert;</span>
<span class="lineNum">    4354 </span><span class="lineCov">          1 :     as-&gt;subtable = otl-&gt;subtables; otl-&gt;subtables-&gt;sm = as;</span>
<span class="lineNum">    4355 </span><span class="lineCov">          1 :     tagSMWithScriptLang(otl-&gt;features,st,ismorx,info);</span>
<span class="lineNum">    4356 </span><span class="lineCov">          1 :     InfoNameOTLookup(otl,info);</span>
<span class="lineNum">    4357 </span><span class="lineCov">         22 :     for ( i=0; i&lt;st-&gt;nclasses*st-&gt;nstates; ++i ) {</span>
<span class="lineNum">    4358 </span>            :         int trans;
<span class="lineNum">    4359 </span><span class="lineCov">         21 :         if ( ismorx ) {</span>
<span class="lineNum">    4360 </span><span class="lineCov">         21 :             trans = st-&gt;state_table2[i];</span>
<span class="lineNum">    4361 </span><span class="lineCov">         21 :             as-&gt;state[i].next_state = memushort(st-&gt;transitions,st-&gt;nentries*st-&gt;entry_size,trans*st-&gt;entry_size);</span>
<span class="lineNum">    4362 </span>            :         } else {
<span class="lineNum">    4363 </span><span class="lineNoCov">          0 :             trans = st-&gt;state_table[i];</span>
<span class="lineNum">    4364 </span><span class="lineNoCov">          0 :             as-&gt;state[i].next_state = (memushort(st-&gt;transitions,st-&gt;nentries*st-&gt;entry_size,trans*st-&gt;entry_size)-st-&gt;state_offset)/st-&gt;nclasses;</span>
<span class="lineNum">    4365 </span>            :         }
<span class="lineNum">    4366 </span><span class="lineCov">         21 :         as-&gt;state[i].flags = memushort(st-&gt;transitions,st-&gt;nentries*st-&gt;entry_size,trans*st-&gt;entry_size+2);</span>
<span class="lineNum">    4367 </span><span class="lineCov">         21 :         if ( extras&gt;0 )</span>
<span class="lineNum">    4368 </span><span class="lineCov">         21 :             as-&gt;state[i].u.context.mark_lookup = (void *) (intpt) memushort(st-&gt;transitions,st-&gt;nentries*st-&gt;entry_size, trans*st-&gt;entry_size+2+2);</span>
<span class="lineNum">    4369 </span><span class="lineCov">         21 :         if ( extras&gt;1 )</span>
<span class="lineNum">    4370 </span><span class="lineCov">         21 :             as-&gt;state[i].u.context.cur_lookup = (void *) (intpt) memushort(st-&gt;transitions,st-&gt;nentries*st-&gt;entry_size, trans*st-&gt;entry_size+2+2+2);</span>
<span class="lineNum">    4371 </span>            :     }
<span class="lineNum">    4372 </span>            :     /* Indic tables have no attached subtables, just a verb in the flag field */
<span class="lineNum">    4373 </span>            :     /*  so for them we are done. For the others... */
<span class="lineNum">    4374 </span><span class="lineCov">          1 :     if ( !ismorx &amp;&amp; type==asm_insert ) {</span>
<span class="lineNum">    4375 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;st-&gt;nclasses*st-&gt;nstates; ++i ) {</span>
<span class="lineNum">    4376 </span><span class="lineNoCov">          0 :             char *cur=NULL, *mark=NULL;</span>
<span class="lineNum">    4377 </span><span class="lineNoCov">          0 :             if ( (as-&gt;state[i].flags&amp;0x3e0)!=0 &amp;&amp; as-&gt;state[i].u.context.mark_lookup!=NULL ) {</span>
<span class="lineNum">    4378 </span><span class="lineNoCov">          0 :                 cur = NamesOfList(here+(intpt) as-&gt;state[i].u.context.mark_lookup,</span>
<span class="lineNum">    4379 </span><span class="lineNoCov">          0 :                         (as-&gt;state[i].flags&amp;0x3e0)&gt;&gt;5,ttf,info);</span>
<span class="lineNum">    4380 </span>            :             }
<span class="lineNum">    4381 </span><span class="lineNoCov">          0 :             if ( (as-&gt;state[i].flags&amp;0x01f)!=0 &amp;&amp; as-&gt;state[i].u.context.cur_lookup!=NULL ) {</span>
<span class="lineNum">    4382 </span><span class="lineNoCov">          0 :                 mark = NamesOfList(here+(intpt) as-&gt;state[i].u.context.cur_lookup,</span>
<span class="lineNum">    4383 </span><span class="lineNoCov">          0 :                         as-&gt;state[i].flags&amp;0x01f,ttf,info);</span>
<span class="lineNum">    4384 </span>            :             }
<span class="lineNum">    4385 </span><span class="lineNoCov">          0 :             as-&gt;state[i].u.insert.cur_ins=cur;</span>
<span class="lineNum">    4386 </span><span class="lineNoCov">          0 :             as-&gt;state[i].u.insert.mark_ins=mark;</span>
<span class="lineNum">    4387 </span>            :         }
<span class="lineNum">    4388 </span><span class="lineCov">          1 :     } else if ( ismorx &amp;&amp; type == asm_insert ) {</span>
<span class="lineNum">    4389 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;st-&gt;nclasses*st-&gt;nstates; ++i ) {</span>
<span class="lineNum">    4390 </span><span class="lineNoCov">          0 :             char *cur=NULL, *mark=NULL;</span>
<span class="lineNum">    4391 </span><span class="lineNoCov">          0 :             if ( (as-&gt;state[i].flags&amp;0x3e0)!=0 &amp;&amp; (intpt) as-&gt;state[i].u.context.mark_lookup!=0xffff ) {</span>
<span class="lineNum">    4392 </span><span class="lineNoCov">          0 :                 cur = NamesOfList(here+st-&gt;extra_offsets[0]+((intpt) as-&gt;state[i].u.context.mark_lookup)*2,</span>
<span class="lineNum">    4393 </span><span class="lineNoCov">          0 :                         (as-&gt;state[i].flags&amp;0x3e0)&gt;&gt;5,ttf,info);</span>
<span class="lineNum">    4394 </span>            :             }
<span class="lineNum">    4395 </span><span class="lineNoCov">          0 :             if ( (as-&gt;state[i].flags&amp;0x01f)!=0 &amp;&amp; ((intpt) as-&gt;state[i].u.context.cur_lookup)!=0xffff ) {</span>
<span class="lineNum">    4396 </span><span class="lineNoCov">          0 :                 mark = NamesOfList(here+st-&gt;extra_offsets[0]+((intpt) as-&gt;state[i].u.context.cur_lookup)*2,</span>
<span class="lineNum">    4397 </span><span class="lineNoCov">          0 :                         as-&gt;state[i].flags&amp;0x01f,ttf,info);</span>
<span class="lineNum">    4398 </span>            :             }
<span class="lineNum">    4399 </span><span class="lineNoCov">          0 :             as-&gt;state[i].u.insert.cur_ins=cur;</span>
<span class="lineNum">    4400 </span><span class="lineNoCov">          0 :             as-&gt;state[i].u.insert.mark_ins=mark;</span>
<span class="lineNum">    4401 </span>            :         }
<span class="lineNum">    4402 </span><span class="lineCov">          1 :     } else if ( !ismorx &amp;&amp; type == asm_context ) {</span>
<span class="lineNum">    4403 </span>            :         /* I don't see any good way to parse a per-glyph substitution table */
<span class="lineNum">    4404 </span>            :         /*  the problem being that most of the per-glyph table is missing */
<span class="lineNum">    4405 </span>            :         /*  but I don't know which bits. The offsets I'm given point to */
<span class="lineNum">    4406 </span>            :         /*  where glyph 0 would be if it were present in the table, but */
<span class="lineNum">    4407 </span>            :         /*  mostly only the bit used is present... */
<span class="lineNum">    4408 </span>            :         /* I could walk though the state machine and find all classes that */
<span class="lineNum">    4409 </span>            :         /*  go to a specific substitution (which would tell me what glyphs */
<span class="lineNum">    4410 </span>            :         /*  were active). That's not hard for substitutions of the current */
<span class="lineNum">    4411 </span>            :         /*  glyph, but it is intractibable for marked glyphs. And I can't  */
<span class="lineNum">    4412 </span>            :         /*  do one without the other. So I do neither. */
<span class="lineNum">    4413 </span>            :         /* One thing I could test fairly easily would be to see whether    */
<span class="lineNum">    4414 </span>            :         /*  class 1 (out of bounds) is ever available for a substitution   */
<span class="lineNum">    4415 </span>            :         /*  (if it ever has a mark set on it or has a current substitution)*/
<span class="lineNum">    4416 </span>            :         /*  if not, then I can ignore any putative substitutions for class */
<span class="lineNum">    4417 </span>            :         /*  1 glyphs (actually I should do this for all classes)*/
<span class="lineNum">    4418 </span>            :         /* Damn. That doesn't work for marks. Because a current substitution*/
<span class="lineNum">    4419 </span>            :         /*  may be applied, and then the glyph gets marked. So we've no idea*/
<span class="lineNum">    4420 </span>            :         /*  what class the newly marked glyph might live in                */
<span class="lineNum">    4421 </span>            :         /* Apple's docs say the substitutions are offset from the &quot;state   */
<span class="lineNum">    4422 </span>            :         /*  subtable&quot;, but it seems much more likely that they are offset  */
<span class="lineNum">    4423 </span>            :         /*  from the substitution table (given that Apple's docs are often */
<span class="lineNum">    4424 </span>            :         /*  wrong */ /* Apple's docs are right. not clear why that offset  */
<span class="lineNum">    4425 </span>            :         /*  is there */
<span class="lineNum">    4426 </span><span class="lineNoCov">          0 :         uint8 *classes_subbed = calloc(st-&gt;nclasses,1);</span>
<span class="lineNum">    4427 </span><span class="lineNoCov">          0 :         int lookup_max = -1, index, index_max;</span>
<span class="lineNum">    4428 </span><span class="lineNoCov">          0 :         int32 *lookups = malloc(st-&gt;nclasses*st-&gt;nstates*sizeof(int32));</span>
<span class="lineNum">    4429 </span><span class="lineNoCov">          0 :         uint8 *evermarked = calloc(st-&gt;nclasses*st-&gt;nstates,sizeof(uint8));</span>
<span class="lineNum">    4430 </span>            :         uint8 *used;
<span class="lineNum">    4431 </span>            :         OTLookup **subs;
<span class="lineNum">    4432 </span>            : 
<span class="lineNum">    4433 </span><span class="lineNoCov">          0 :         index_max = 0;</span>
<span class="lineNum">    4434 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;st-&gt;nclasses*st-&gt;nstates; ++i ) {</span>
<span class="lineNum">    4435 </span><span class="lineNoCov">          0 :             if ( as-&gt;state[i].u.context.mark_lookup!=NULL ) {</span>
<span class="lineNum">    4436 </span><span class="lineNoCov">          0 :                 index = sm_lookupfind(lookups,&amp;lookup_max,(int16) (intpt) as-&gt;state[i].u.context.mark_lookup);</span>
<span class="lineNum">    4437 </span><span class="lineNoCov">          0 :                 if ( index&gt;index_max ) index_max = index;</span>
<span class="lineNum">    4438 </span>            :             }
<span class="lineNum">    4439 </span><span class="lineNoCov">          0 :             if ( as-&gt;state[i].u.context.cur_lookup!=NULL ) {</span>
<span class="lineNum">    4440 </span><span class="lineNoCov">          0 :                 index = sm_lookupfind(lookups,&amp;lookup_max,(int16) (intpt) as-&gt;state[i].u.context.cur_lookup);</span>
<span class="lineNum">    4441 </span><span class="lineNoCov">          0 :                 if ( index&gt;index_max ) index_max = index;</span>
<span class="lineNum">    4442 </span>            :             }
<span class="lineNum">    4443 </span>            :         }
<span class="lineNum">    4444 </span><span class="lineNoCov">          0 :         subs = calloc(index_max+1,sizeof(OTLookup *));</span>
<span class="lineNum">    4445 </span>            : 
<span class="lineNum">    4446 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;st-&gt;nclasses*st-&gt;nstates; ++i ) {</span>
<span class="lineNum">    4447 </span><span class="lineNoCov">          0 :             if ( as-&gt;state[i].u.context.mark_lookup!=NULL ) {</span>
<span class="lineNum">    4448 </span><span class="lineNoCov">          0 :                 index = sm_lookupfind(lookups,&amp;lookup_max,(int16) (intpt) as-&gt;state[i].u.context.mark_lookup);</span>
<span class="lineNum">    4449 </span><span class="lineNoCov">          0 :                 evermarked[index] = true;</span>
<span class="lineNum">    4450 </span><span class="lineNoCov">          0 :                 as-&gt;state[i].u.context.mark_lookup = NewMacSubsLookup(info,otl,index,subs);</span>
<span class="lineNum">    4451 </span>            :             }
<span class="lineNum">    4452 </span><span class="lineNoCov">          0 :             if ( as-&gt;state[i].u.context.cur_lookup!=NULL ) {</span>
<span class="lineNum">    4453 </span><span class="lineNoCov">          0 :                 index = sm_lookupfind(lookups,&amp;lookup_max,(int16) (intpt) as-&gt;state[i].u.context.cur_lookup);</span>
<span class="lineNum">    4454 </span><span class="lineNoCov">          0 :                 as-&gt;state[i].u.context.cur_lookup = NewMacSubsLookup(info,otl,index,subs);</span>
<span class="lineNum">    4455 </span>            :             }
<span class="lineNum">    4456 </span>            :         }
<span class="lineNum">    4457 </span><span class="lineNoCov">          0 :         used = calloc((subtab_len-st-&gt;extra_offsets[0]+1)/2,sizeof(uint8));</span>
<span class="lineNum">    4458 </span>            :         /* first figure things that only appear in current subs */
<span class="lineNum">    4459 </span>            :         /*  then go back and work on things that apply to things which are also in marked subs */
<span class="lineNum">    4460 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;2; ++j ) for ( i=0; i&lt;=lookup_max; ++i ) if ( evermarked[i]==j ) {</span>
<span class="lineNum">    4461 </span><span class="lineNoCov">          0 :             info-&gt;mort_subs_lookup = NewMacSubsLookup(info,otl,i,subs);</span>
<span class="lineNum">    4462 </span><span class="lineNoCov">          0 :             info-&gt;mort_is_nested = true;</span>
<span class="lineNum">    4463 </span><span class="lineNoCov">          0 :             if ( !evermarked[i] ) { int k,l;</span>
<span class="lineNum">    4464 </span><span class="lineNoCov">          0 :                 memset(classes_subbed,0,st-&gt;nclasses);</span>
<span class="lineNum">    4465 </span><span class="lineNoCov">          0 :                 for ( k=0; k&lt;st-&gt;nstates; ++k ) for ( l=0; l&lt;st-&gt;nclasses; ++l ) {</span>
<span class="lineNum">    4466 </span><span class="lineNoCov">          0 :                     if ( as-&gt;state[k*st-&gt;nclasses+l].u.context.cur_lookup == info-&gt;mort_subs_lookup )</span>
<span class="lineNum">    4467 </span><span class="lineNoCov">          0 :                         classes_subbed[l] = true;</span>
<span class="lineNum">    4468 </span>            :                 }
<span class="lineNum">    4469 </span>            :             }
<span class="lineNum">    4470 </span><span class="lineNoCov">          0 :             fseek(ttf,here/*+st-&gt;extra_offsets[0]*/+lookups[i]*2,SEEK_SET);</span>
<span class="lineNum">    4471 </span><span class="lineNoCov">          0 :             read_perglyph_subs(ttf,info,here+st-&gt;extra_offsets[0],here+subtab_len,</span>
<span class="lineNum">    4472 </span><span class="lineNoCov">          0 :                     st,classes_subbed,evermarked[i],used);</span>
<span class="lineNum">    4473 </span>            :         }
<span class="lineNum">    4474 </span><span class="lineNoCov">          0 :         info-&gt;mort_is_nested = false;</span>
<span class="lineNum">    4475 </span><span class="lineNoCov">          0 :         free(classes_subbed);</span>
<span class="lineNum">    4476 </span><span class="lineNoCov">          0 :         free(lookups);</span>
<span class="lineNum">    4477 </span><span class="lineNoCov">          0 :         free(used);</span>
<span class="lineNum">    4478 </span><span class="lineNoCov">          0 :         free(evermarked);</span>
<span class="lineNum">    4479 </span><span class="lineNoCov">          0 :         free(subs);</span>
<span class="lineNum">    4480 </span><span class="lineCov">          2 :     } else if ( ismorx &amp;&amp; type == asm_context ) {</span>
<span class="lineNum">    4481 </span><span class="lineCov">          1 :         int lookup_max= -1;</span>
<span class="lineNum">    4482 </span>            :         uint32 *lookups;
<span class="lineNum">    4483 </span>            :         OTLookup **subs;
<span class="lineNum">    4484 </span>            : 
<span class="lineNum">    4485 </span><span class="lineCov">         22 :         for ( i=0; i&lt;st-&gt;nclasses*st-&gt;nstates; ++i ) {</span>
<span class="lineNum">    4486 </span><span class="lineCov">         21 :             if ( (intpt) as-&gt;state[i].u.context.mark_lookup!=0xffff ) {</span>
<span class="lineNum">    4487 </span><span class="lineNoCov">          0 :                 if ( ((int) (intpt) as-&gt;state[i].u.context.mark_lookup)&gt;lookup_max )</span>
<span class="lineNum">    4488 </span><span class="lineNoCov">          0 :                     lookup_max = (intpt) as-&gt;state[i].u.context.mark_lookup;</span>
<span class="lineNum">    4489 </span>            :             }
<span class="lineNum">    4490 </span><span class="lineCov">         21 :             if ( (intpt) as-&gt;state[i].u.context.cur_lookup!=0xffff ) {</span>
<span class="lineNum">    4491 </span><span class="lineCov">          2 :                 if ( ((int) (intpt) as-&gt;state[i].u.context.cur_lookup)&gt;lookup_max )</span>
<span class="lineNum">    4492 </span><span class="lineCov">          1 :                     lookup_max = (intpt) as-&gt;state[i].u.context.cur_lookup;</span>
<span class="lineNum">    4493 </span>            :             }
<span class="lineNum">    4494 </span>            :         }
<span class="lineNum">    4495 </span><span class="lineCov">          1 :         ++lookup_max;</span>
<span class="lineNum">    4496 </span><span class="lineCov">          1 :         subs = calloc(lookup_max,sizeof(OTLookup *));</span>
<span class="lineNum">    4497 </span><span class="lineCov">         22 :         for ( i=0; i&lt;st-&gt;nclasses*st-&gt;nstates; ++i ) {</span>
<span class="lineNum">    4498 </span><span class="lineCov">         21 :             if ( (intpt) as-&gt;state[i].u.context.mark_lookup!=0xffff ) {</span>
<span class="lineNum">    4499 </span><span class="lineNoCov">          0 :                 as-&gt;state[i].u.context.mark_lookup = NewMacSubsLookup(info,otl,(intpt) as-&gt;state[i].u.context.mark_lookup,subs);</span>
<span class="lineNum">    4500 </span>            :             } else
<span class="lineNum">    4501 </span><span class="lineCov">         21 :                 as-&gt;state[i].u.context.mark_lookup = NULL;</span>
<span class="lineNum">    4502 </span><span class="lineCov">         21 :             if ( (intpt) as-&gt;state[i].u.context.cur_lookup!=0xffff ) {</span>
<span class="lineNum">    4503 </span><span class="lineCov">          2 :                 as-&gt;state[i].u.context.cur_lookup = NewMacSubsLookup(info,otl,(intpt) as-&gt;state[i].u.context.cur_lookup,subs);</span>
<span class="lineNum">    4504 </span>            :             } else
<span class="lineNum">    4505 </span><span class="lineCov">         19 :                 as-&gt;state[i].u.context.cur_lookup = NULL;</span>
<span class="lineNum">    4506 </span>            :         }
<span class="lineNum">    4507 </span><span class="lineCov">          1 :         lookups = malloc(lookup_max*sizeof(uint32));</span>
<span class="lineNum">    4508 </span><span class="lineCov">          1 :         fseek(ttf,here+st-&gt;extra_offsets[0],SEEK_SET);</span>
<span class="lineNum">    4509 </span><span class="lineCov">          2 :         for ( i=0; i&lt;lookup_max; ++i )</span>
<span class="lineNum">    4510 </span><span class="lineCov">          1 :             lookups[i] = getlong(ttf) + here+st-&gt;extra_offsets[0];</span>
<span class="lineNum">    4511 </span><span class="lineCov">          2 :         for ( i=0; i&lt;lookup_max; ++i ) {</span>
<span class="lineNum">    4512 </span><span class="lineCov">          1 :             fseek(ttf,lookups[i],SEEK_SET);</span>
<span class="lineNum">    4513 </span><span class="lineCov">          1 :             info-&gt;mort_subs_lookup = NewMacSubsLookup(info,otl,i,subs);</span>
<span class="lineNum">    4514 </span><span class="lineCov">          1 :             info-&gt;mort_is_nested = true;</span>
<span class="lineNum">    4515 </span><span class="lineCov">          1 :             readttf_applelookup(ttf,info,</span>
<span class="lineNum">    4516 </span>            :                     mort_apply_values,mort_apply_value,NULL,NULL,true);
<span class="lineNum">    4517 </span>            :         }
<span class="lineNum">    4518 </span><span class="lineCov">          1 :         info-&gt;mort_is_nested = false;</span>
<span class="lineNum">    4519 </span><span class="lineCov">          1 :         free(subs);</span>
<span class="lineNum">    4520 </span><span class="lineCov">          1 :         free(lookups);</span>
<span class="lineNum">    4521 </span><span class="lineNoCov">          0 :     } else if ( type == asm_kern ) {</span>
<span class="lineNum">    4522 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;st-&gt;nclasses*st-&gt;nstates; ++i ) {</span>
<span class="lineNum">    4523 </span><span class="lineNoCov">          0 :             if ( (as-&gt;state[i].flags&amp;0x3fff)!=0 ) {</span>
<span class="lineNum">    4524 </span><span class="lineNoCov">          0 :                 KernReadKernList(ttf,here+(as-&gt;state[i].flags&amp;0x3fff),</span>
<span class="lineNum">    4525 </span><span class="lineNoCov">          0 :                         &amp;as-&gt;state[i]);</span>
<span class="lineNum">    4526 </span><span class="lineNoCov">          0 :                 as-&gt;state[i].flags &amp;= ~0x3fff;</span>
<span class="lineNum">    4527 </span>            :             } else {
<span class="lineNum">    4528 </span><span class="lineNoCov">          0 :                 as-&gt;state[i].u.kern.kcnt = 0;</span>
<span class="lineNum">    4529 </span><span class="lineNoCov">          0 :                 as-&gt;state[i].u.kern.kerns = NULL;</span>
<span class="lineNum">    4530 </span>            :             }
<span class="lineNum">    4531 </span>            :         }
<span class="lineNum">    4532 </span>            :     }
<span class="lineNum">    4533 </span><span class="lineCov">          1 :     as-&gt;next = info-&gt;sm;</span>
<span class="lineNum">    4534 </span><span class="lineCov">          1 :     info-&gt;sm = as;</span>
<span class="lineNum">    4535 </span><span class="lineCov">          1 :     statetablefree(st);</span>
<span class="lineNum">    4536 </span><span class="lineCov">          1 : return( as );</span>
<a name="4537"><span class="lineNum">    4537 </span>            : }</a>
<span class="lineNum">    4538 </span>            : 
<span class="lineNum">    4539 </span><span class="lineCov">          4 : static int InfoHasGSUBTag(struct ttfinfo *info, uint32 tag, int apple_lookup_type) {</span>
<span class="lineNum">    4540 </span>            :     OTLookup *otl;
<span class="lineNum">    4541 </span>            :     FeatureScriptLangList *feat;
<span class="lineNum">    4542 </span>            : 
<span class="lineNum">    4543 </span><span class="lineCov">          4 :     if ( apple_lookup_type==0 ||                /* Indic rearrangement */</span>
<span class="lineNum">    4544 </span><span class="lineCov">          3 :             apple_lookup_type==1 ||             /* Contextual substitution */</span>
<span class="lineNum">    4545 </span>            :             apple_lookup_type==5 )              /* Contextual insertion */
<span class="lineNum">    4546 </span><span class="lineCov">          1 : return( false ); /* These types can either not be represented in OT */</span>
<span class="lineNum">    4547 </span>            :         /* or not converted to AAT -- so we'd better read them */
<span class="lineNum">    4548 </span>            :     /* We can't really do contextual ligatures either, but we parse that table*/
<span class="lineNum">    4549 </span>            :     /*  for the non-contextual ligs (which is most of them) */
<span class="lineNum">    4550 </span>            : 
<span class="lineNum">    4551 </span><span class="lineCov">          4 :     for ( otl = info-&gt;gsub_lookups; otl!=NULL; otl=otl-&gt;next ) {</span>
<span class="lineNum">    4552 </span><span class="lineCov">          5 :         for ( feat = otl-&gt;features; feat!=NULL; feat=feat-&gt;next ) {</span>
<span class="lineNum">    4553 </span><span class="lineCov">          7 :             if ( feat-&gt;featuretag == tag &amp;&amp;</span>
<span class="lineNum">    4554 </span><span class="lineCov">          3 :                     Macable(NULL,otl))</span>
<span class="lineNum">    4555 </span><span class="lineCov">          3 : return( true );</span>
<span class="lineNum">    4556 </span>            :         }
<span class="lineNum">    4557 </span>            :     }
<span class="lineNum">    4558 </span><span class="lineNoCov">          0 : return( false );</span>
<span class="lineNum">    4559 </span>            : }
<span class="lineNum">    4560 </span>            : 
<span class="lineNum">    4561 </span>            : static void FeatMarkAsEnabled(struct ttfinfo *info,int featureType,
<a name="4562"><span class="lineNum">    4562 </span>            :         int featureSetting);</a>
<span class="lineNum">    4563 </span>            : 
<span class="lineNum">    4564 </span><span class="lineCov">          4 : static uint32 readmortchain(FILE *ttf,struct ttfinfo *info, uint32 base,</span>
<span class="lineNum">    4565 </span>            :         int ismorx) {
<span class="lineNum">    4566 </span>            :     uint32 chain_len, nfeatures, nsubtables, default_flags;
<span class="lineNum">    4567 </span>            :     uint32 enable_flags, disable_flags, flags;
<span class="lineNum">    4568 </span>            :     int featureType, featureSetting;
<span class="lineNum">    4569 </span>            :     int i,j,k;
<span class="lineNum">    4570 </span>            :     uint32 length, coverage;
<span class="lineNum">    4571 </span>            :     uint32 here;
<span class="lineNum">    4572 </span>            :     uint32 tag;
<span class="lineNum">    4573 </span>            :     struct tagmaskfeature { uint32 tag, enable_flags; uint16 ismac, feat, set; } tmf[32];
<span class="lineNum">    4574 </span>            :     int r2l;
<span class="lineNum">    4575 </span>            : 
<span class="lineNum">    4576 </span><span class="lineCov">          4 :     default_flags = getlong(ttf);</span>
<span class="lineNum">    4577 </span><span class="lineCov">          4 :     chain_len = getlong(ttf);</span>
<span class="lineNum">    4578 </span><span class="lineCov">          4 :     if ( ismorx ) {</span>
<span class="lineNum">    4579 </span><span class="lineCov">          4 :         nfeatures = getlong(ttf);</span>
<span class="lineNum">    4580 </span><span class="lineCov">          4 :         nsubtables = getlong(ttf);</span>
<span class="lineNum">    4581 </span>            :     } else {
<span class="lineNum">    4582 </span><span class="lineNoCov">          0 :         nfeatures = getushort(ttf);</span>
<span class="lineNum">    4583 </span><span class="lineNoCov">          0 :         nsubtables = getushort(ttf);</span>
<span class="lineNum">    4584 </span>            :     }
<span class="lineNum">    4585 </span>            : 
<span class="lineNum">    4586 </span><span class="lineCov">          4 :     k = 0;</span>
<span class="lineNum">    4587 </span><span class="lineCov">         22 :     for ( i=0; i&lt;nfeatures; ++i ) {</span>
<span class="lineNum">    4588 </span><span class="lineCov">         18 :         featureType = getushort(ttf);</span>
<span class="lineNum">    4589 </span><span class="lineCov">         18 :         featureSetting = getushort(ttf);</span>
<span class="lineNum">    4590 </span><span class="lineCov">         18 :         enable_flags = getlong(ttf);</span>
<span class="lineNum">    4591 </span><span class="lineCov">         18 :         disable_flags = getlong(ttf);</span>
<span class="lineNum">    4592 </span><span class="lineCov">         18 :         if ( feof(ttf))</span>
<span class="lineNum">    4593 </span><span class="lineNoCov">          0 : return( chain_len );</span>
<span class="lineNum">    4594 </span><span class="lineCov">         18 :         if ( info-&gt;justinuse == git_normal &amp;&amp; ( enable_flags &amp; default_flags ))</span>
<span class="lineNum">    4595 </span><span class="lineCov">          8 :             FeatMarkAsEnabled(info,featureType,featureSetting);</span>
<span class="lineNum">    4596 </span><span class="lineCov">         18 :         tag = MacFeatureToOTTag(featureType,featureSetting);</span>
<span class="lineNum">    4597 </span><span class="lineCov">         18 :         if ( enable_flags!=0 &amp;&amp; k&lt;32 ) {</span>
<span class="lineNum">    4598 </span><span class="lineCov">          9 :             if ( tag==0 ) {</span>
<span class="lineNum">    4599 </span><span class="lineCov">          4 :                 tmf[k].tag = (featureType&lt;&lt;16) | featureSetting;</span>
<span class="lineNum">    4600 </span><span class="lineCov">          4 :                 tmf[k].ismac = true;</span>
<span class="lineNum">    4601 </span>            :             } else {
<span class="lineNum">    4602 </span><span class="lineCov">          5 :                 tmf[k].tag = tag;</span>
<span class="lineNum">    4603 </span><span class="lineCov">          5 :                 tmf[k].ismac = false;</span>
<span class="lineNum">    4604 </span>            :             }
<span class="lineNum">    4605 </span><span class="lineCov">          9 :             tmf[k].feat = featureType;</span>
<span class="lineNum">    4606 </span><span class="lineCov">          9 :             tmf[k].set = featureSetting;</span>
<span class="lineNum">    4607 </span><span class="lineCov">          9 :             tmf[k++].enable_flags = enable_flags;</span>
<span class="lineNum">    4608 </span>            :         }
<span class="lineNum">    4609 </span>            :     }
<span class="lineNum">    4610 </span><span class="lineCov">          4 :     if ( k==0 )</span>
<span class="lineNum">    4611 </span><span class="lineNoCov">          0 : return( chain_len );</span>
<span class="lineNum">    4612 </span>            : 
<span class="lineNum">    4613 </span><span class="lineCov">          9 :     for ( i=0; i&lt;nsubtables; ++i ) {</span>
<span class="lineNum">    4614 </span><span class="lineCov">          5 :         here = ftell(ttf);</span>
<span class="lineNum">    4615 </span><span class="lineCov">          5 :         if ( ismorx ) {</span>
<span class="lineNum">    4616 </span><span class="lineCov">          5 :             length = getlong(ttf);</span>
<span class="lineNum">    4617 </span><span class="lineCov">          5 :             coverage = getlong(ttf);</span>
<span class="lineNum">    4618 </span>            :         } else {
<span class="lineNum">    4619 </span><span class="lineNoCov">          0 :             length = getushort(ttf);</span>
<span class="lineNum">    4620 </span><span class="lineNoCov">          0 :             coverage = getushort(ttf);</span>
<span class="lineNum">    4621 </span><span class="lineNoCov">          0 :             coverage = ((coverage&amp;0xe000)&lt;&lt;16) | (coverage&amp;7);    /* convert to morx format */</span>
<span class="lineNum">    4622 </span>            :         }
<span class="lineNum">    4623 </span><span class="lineCov">          5 :         r2l = (coverage &amp; 0x40000000)? 1 : 0;</span>
<span class="lineNum">    4624 </span><span class="lineCov">          5 :         flags = getlong(ttf);</span>
<span class="lineNum">    4625 </span><span class="lineCov">          5 :         for ( j=k-1; j&gt;=0 &amp;&amp; (!(flags&amp;tmf[j].enable_flags) || (tmf[j].enable_flags&amp;~flags)!=0); --j );</span>
<span class="lineNum">    4626 </span><span class="lineCov">          5 :         if ( j==-1 )</span>
<span class="lineNum">    4627 </span><span class="lineNoCov">          0 :             for ( j=k-1; j&gt;=0 &amp;&amp; (!(flags&amp;tmf[j].enable_flags) || tmf[j].feat==0); --j );</span>
<span class="lineNum">    4628 </span><span class="lineCov">          5 :         if ( j&gt;=0 ) {</span>
<span class="lineNum">    4629 </span><span class="lineCov">         10 :             if ( !tmf[j].ismac &amp;&amp;</span>
<span class="lineNum">    4630 </span><span class="lineCov">         10 :                     ((coverage&amp;0xff)==0 ||</span>
<span class="lineNum">    4631 </span><span class="lineCov">          9 :                      (coverage&amp;0xff)==1 ||</span>
<span class="lineNum">    4632 </span><span class="lineCov">          4 :                      (coverage&amp;0xff)==5 )) {</span>
<span class="lineNum">    4633 </span>            :                 /* Only do the opentype tag conversion if we've got a format */
<span class="lineNum">    4634 </span>            :                 /*  we can convert to opentype. Otherwise it is useless and */
<span class="lineNum">    4635 </span>            :                 /*  confusing */
<span class="lineNum">    4636 </span><span class="lineCov">          1 :                 tmf[j].ismac = true;</span>
<span class="lineNum">    4637 </span><span class="lineCov">          1 :                 tmf[j].tag = (tmf[j].feat&lt;&lt;16) | tmf[j].set;</span>
<span class="lineNum">    4638 </span>            :             }
<span class="lineNum">    4639 </span><span class="lineCov">          5 :             info-&gt;mort_r2l = r2l;</span>
<span class="lineNum">    4640 </span><span class="lineCov">          5 :             info-&gt;mort_tag_mac = tmf[j].ismac;</span>
<span class="lineNum">    4641 </span><span class="lineCov">          5 :             info-&gt;mort_feat = tmf[j].feat; info-&gt;mort_setting = tmf[j].set;</span>
<span class="lineNum">    4642 </span>            :             /* If we've already read gsub. And this feature setting matches */
<span class="lineNum">    4643 </span>            :             /*  and opentype feature tag. And we've got an OpenType lookup  */
<span class="lineNum">    4644 </span>            :             /*  attached to that feature tag. And it's a lookup type we can */
<span class="lineNum">    4645 </span>            :             /*  convert... Then don't parse this sub-table, we shall assume */
<span class="lineNum">    4646 </span>            :             /*  it is simply a duplicate of the OT version */
<span class="lineNum">    4647 </span><span class="lineCov">          9 :             if ( info-&gt;gsub_start!=0 &amp;&amp;</span>
<span class="lineNum">    4648 </span><span class="lineCov">          8 :                     (tag = MacFeatureToOTTag(tmf[j].feat,tmf[j].set))!=0 &amp;&amp;</span>
<span class="lineNum">    4649 </span><span class="lineCov">          4 :                     InfoHasGSUBTag(info,tag,coverage&amp;0xff))</span>
<span class="lineNum">    4650 </span>            :                 /* Skip it */;
<span class="lineNum">    4651 </span><span class="lineCov">          2 :             else switch( coverage&amp;0xff ) {</span>
<span class="lineNum">    4652 </span>            :               case 0:   /* Indic rearangement */
<span class="lineNum">    4653 </span><span class="lineNoCov">          0 :                 if ( info-&gt;justinuse == git_normal )</span>
<span class="lineNum">    4654 </span><span class="lineNoCov">          0 :                     readttf_mortx_asm(ttf,info,ismorx,length,asm_indic,0,</span>
<span class="lineNum">    4655 </span>            :                             coverage,NULL);
<span class="lineNum">    4656 </span><span class="lineNoCov">          0 :               break;</span>
<span class="lineNum">    4657 </span>            :               case 1:   /* contextual glyph substitution */
<span class="lineNum">    4658 </span><span class="lineCov">          1 :                 if ( info-&gt;justinuse == git_normal )</span>
<span class="lineNum">    4659 </span><span class="lineCov">          1 :                     readttf_mortx_asm(ttf,info,ismorx,length,asm_context,2,</span>
<span class="lineNum">    4660 </span>            :                             coverage,NULL);
<span class="lineNum">    4661 </span><span class="lineCov">          1 :               break;</span>
<span class="lineNum">    4662 </span>            :               case 2:   /* ligature substitution */
<span class="lineNum">    4663 </span>            :                 /* Apple's ligature state machines are too weird to be */
<span class="lineNum">    4664 </span>            :                 /*  represented easily, but I can parse them into a set */
<span class="lineNum">    4665 </span>            :                 /*  of ligatures -- assuming they are unconditional */
<span class="lineNum">    4666 </span><span class="lineCov">          1 :                 if ( info-&gt;justinuse == git_normal ) {</span>
<span class="lineNum">    4667 </span><span class="lineCov">          1 :                     info-&gt;mort_subs_lookup = NewMacLookup(info,false);</span>
<span class="lineNum">    4668 </span><span class="lineCov">          1 :                     info-&gt;mort_subs_lookup-&gt;lookup_type = gsub_ligature;</span>
<span class="lineNum">    4669 </span><span class="lineCov">          1 :                     if ( !tmf[j].ismac ) {</span>
<span class="lineNum">    4670 </span><span class="lineCov">          1 :                         info-&gt;mort_subs_lookup-&gt;features-&gt;next = chunkalloc(sizeof(FeatureScriptLangList));</span>
<span class="lineNum">    4671 </span><span class="lineCov">          1 :                         info-&gt;mort_subs_lookup-&gt;features-&gt;next-&gt;featuretag = tmf[j].tag;</span>
<span class="lineNum">    4672 </span><span class="lineCov">          1 :                         info-&gt;mort_subs_lookup-&gt;features-&gt;next-&gt;ismac = false;</span>
<span class="lineNum">    4673 </span>            :                     }
<span class="lineNum">    4674 </span><span class="lineCov">          1 :                     info-&gt;mort_subs_lookup-&gt;subtables-&gt;per_glyph_pst_or_kern = true;</span>
<span class="lineNum">    4675 </span>            :                 }
<span class="lineNum">    4676 </span><span class="lineCov">          1 :                 readttf_mortx_lig(ttf,info,ismorx,here,length);</span>
<span class="lineNum">    4677 </span><span class="lineCov">          1 :                 if ( info-&gt;justinuse == git_normal )</span>
<span class="lineNum">    4678 </span><span class="lineCov">          1 :                     InfoNameOTLookup(info-&gt;mort_subs_lookup,info);</span>
<span class="lineNum">    4679 </span>            :                 /* We can give the lookup a better name after we've made a */
<span class="lineNum">    4680 </span>            :                 /*  guess at what scripts it involves =&gt; substitutions first */
<span class="lineNum">    4681 </span><span class="lineCov">          1 :               break;</span>
<span class="lineNum">    4682 </span>            :               case 4:   /* non-contextual glyph substitutions */
<span class="lineNum">    4683 </span><span class="lineNoCov">          0 :                 if ( info-&gt;justinuse == git_normal ) {</span>
<span class="lineNum">    4684 </span><span class="lineNoCov">          0 :                     info-&gt;mort_subs_lookup = NewMacLookup(info,false);</span>
<span class="lineNum">    4685 </span><span class="lineNoCov">          0 :                     info-&gt;mort_subs_lookup-&gt;lookup_type = gsub_single;</span>
<span class="lineNum">    4686 </span><span class="lineNoCov">          0 :                     if ( !tmf[j].ismac ) {</span>
<span class="lineNum">    4687 </span><span class="lineNoCov">          0 :                         info-&gt;mort_subs_lookup-&gt;features-&gt;next = chunkalloc(sizeof(FeatureScriptLangList));</span>
<span class="lineNum">    4688 </span><span class="lineNoCov">          0 :                         info-&gt;mort_subs_lookup-&gt;features-&gt;next-&gt;featuretag = tmf[j].tag;</span>
<span class="lineNum">    4689 </span><span class="lineNoCov">          0 :                         info-&gt;mort_subs_lookup-&gt;features-&gt;next-&gt;ismac = false;</span>
<span class="lineNum">    4690 </span>            :                     }
<span class="lineNum">    4691 </span><span class="lineNoCov">          0 :                     info-&gt;mort_subs_lookup-&gt;subtables-&gt;per_glyph_pst_or_kern = true;</span>
<span class="lineNum">    4692 </span>            :                 }
<span class="lineNum">    4693 </span><span class="lineNoCov">          0 :                 readttf_applelookup(ttf,info,</span>
<span class="lineNum">    4694 </span>            :                         mort_apply_values,mort_apply_value,NULL,NULL,true);
<span class="lineNum">    4695 </span><span class="lineNoCov">          0 :                 if ( info-&gt;justinuse == git_normal )</span>
<span class="lineNum">    4696 </span><span class="lineNoCov">          0 :                     InfoNameOTLookup(info-&gt;mort_subs_lookup,info);</span>
<span class="lineNum">    4697 </span><span class="lineNoCov">          0 :               break;</span>
<span class="lineNum">    4698 </span>            :               case 5:   /* contextual glyph insertion */
<span class="lineNum">    4699 </span><span class="lineNoCov">          0 :                 if ( info-&gt;justinuse == git_normal )</span>
<span class="lineNum">    4700 </span><span class="lineNoCov">          0 :                     readttf_mortx_asm(ttf,info,ismorx,length,asm_insert,2,</span>
<span class="lineNum">    4701 </span>            :                             coverage,NULL);
<span class="lineNum">    4702 </span><span class="lineNoCov">          0 :               break;</span>
<span class="lineNum">    4703 </span>            :             }
<span class="lineNum">    4704 </span>            :         }
<span class="lineNum">    4705 </span><span class="lineCov">          5 :         fseek(ttf, here+length, SEEK_SET );</span>
<span class="lineNum">    4706 </span>            :     }
<span class="lineNum">    4707 </span>            : 
<span class="lineNum">    4708 </span><span class="lineCov">          4 : return( chain_len );</span>
<a name="4709"><span class="lineNum">    4709 </span>            : }</a>
<span class="lineNum">    4710 </span>            : 
<span class="lineNum">    4711 </span><span class="lineCov">          4 : static void _readttfmort(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    4712 </span><span class="lineCov">          4 :     uint32 base = info-&gt;morx_start!=0 ? info-&gt;morx_start : info-&gt;mort_start;</span>
<span class="lineNum">    4713 </span>            :     uint32 here, len;
<span class="lineNum">    4714 </span>            :     int ismorx;
<span class="lineNum">    4715 </span>            :     int32 version;
<span class="lineNum">    4716 </span>            :     int i, nchains;
<span class="lineNum">    4717 </span>            : 
<span class="lineNum">    4718 </span><span class="lineCov">          4 :     fseek(ttf,base,SEEK_SET);</span>
<span class="lineNum">    4719 </span><span class="lineCov">          4 :     version = getlong(ttf);</span>
<span class="lineNum">    4720 </span><span class="lineCov">          4 :     ismorx = version == 0x00020000;</span>
<span class="lineNum">    4721 </span><span class="lineCov">          4 :     if ( version!=0x00010000 &amp;&amp; version != 0x00020000 )</span>
<span class="lineNum">    4722 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    4723 </span><span class="lineCov">          4 :     nchains = getlong(ttf);</span>
<span class="lineNum">    4724 </span><span class="lineCov">          4 :     if ( feof(ttf)) {</span>
<span class="lineNum">    4725 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Unexpected end of file found in morx chain.\n&quot; ));</span>
<span class="lineNum">    4726 </span><span class="lineNoCov">          0 :         info-&gt;bad_gx = true;</span>
<span class="lineNum">    4727 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    4728 </span>            :     }
<span class="lineNum">    4729 </span><span class="lineCov">          4 :     info-&gt;mort_max = nchains*33;             /* Maximum of one feature per bit ? */</span>
<span class="lineNum">    4730 </span><span class="lineCov">          8 :     for ( i=0; i&lt;nchains; ++i ) {</span>
<span class="lineNum">    4731 </span><span class="lineCov">          4 :         here = ftell(ttf);</span>
<span class="lineNum">    4732 </span><span class="lineCov">          4 :         len = readmortchain(ttf,info,base,ismorx);</span>
<span class="lineNum">    4733 </span><span class="lineCov">          4 :         if ( feof(ttf)) {</span>
<span class="lineNum">    4734 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Unexpected end of file found in morx chain.\n&quot;));</span>
<span class="lineNum">    4735 </span><span class="lineNoCov">          0 :             info-&gt;bad_gx = true;</span>
<span class="lineNum">    4736 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    4737 </span>            :         }
<span class="lineNum">    4738 </span><span class="lineCov">          4 :         fseek(ttf,here+len,SEEK_SET);</span>
<span class="lineNum">    4739 </span>            :     }
<span class="lineNum">    4740 </span>            :     /* Some Apple fonts use out of range gids as flags in conditional substitutions */
<span class="lineNum">    4741 </span>            :     /*  generally to pass information from one sub-table to another which then */
<span class="lineNum">    4742 </span>            :     /*  removes the flag */
<span class="lineNum">    4743 </span><span class="lineCov">          4 :     if ( info-&gt;badgid_cnt!=0 ) {</span>
<span class="lineNum">    4744 </span>            :         /* Merge the fake glyphs in with the real ones */
<span class="lineNum">    4745 </span><span class="lineNoCov">          0 :         int oldgc = info-&gt;glyph_cnt;</span>
<span class="lineNum">    4746 </span><span class="lineNoCov">          0 :         info-&gt;chars = realloc(info-&gt;chars,(info-&gt;glyph_cnt+info-&gt;badgid_cnt)*sizeof(SplineChar *));</span>
<span class="lineNum">    4747 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;info-&gt;badgid_cnt; ++i ) {</span>
<span class="lineNum">    4748 </span><span class="lineNoCov">          0 :             info-&gt;chars[info-&gt;glyph_cnt+i] = info-&gt;badgids[i];</span>
<span class="lineNum">    4749 </span><span class="lineNoCov">          0 :             info-&gt;badgids[i]-&gt;orig_pos = info-&gt;glyph_cnt+i;</span>
<span class="lineNum">    4750 </span>            :         }
<span class="lineNum">    4751 </span><span class="lineNoCov">          0 :         info-&gt;glyph_cnt += info-&gt;badgid_cnt;</span>
<span class="lineNum">    4752 </span><span class="lineNoCov">          0 :         free(info-&gt;badgids);</span>
<span class="lineNum">    4753 </span>            :         /* We also need to adjust the variations. */
<span class="lineNum">    4754 </span><span class="lineNoCov">          0 :         if (info-&gt;variations) {</span>
<span class="lineNum">    4755 </span>            :             int ctup;
<span class="lineNum">    4756 </span><span class="lineNoCov">          0 :             for (ctup = 0; ctup &lt; info-&gt;variations-&gt;tuple_count; ctup++) {</span>
<span class="lineNum">    4757 </span><span class="lineNoCov">          0 :                 SplineChar ** tscs = info-&gt;variations-&gt;tuples[ctup].chars;</span>
<span class="lineNum">    4758 </span><span class="lineNoCov">          0 :                 info-&gt;variations-&gt;tuples[ctup].chars = calloc(info-&gt;glyph_cnt, sizeof(SplineChar *));</span>
<span class="lineNum">    4759 </span><span class="lineNoCov">          0 :                 memcpy(info-&gt;variations-&gt;tuples[ctup].chars, tscs, oldgc * sizeof(SplineChar *));</span>
<span class="lineNum">    4760 </span><span class="lineNoCov">          0 :                 free(tscs);</span>
<span class="lineNum">    4761 </span><span class="lineNoCov">          0 :                 tscs = NULL;</span>
<span class="lineNum">    4762 </span>            :             }
<span class="lineNum">    4763 </span>            :         }
<span class="lineNum">    4764 </span>            :     }
<a name="4765"><span class="lineNum">    4765 </span>            : }</a>
<span class="lineNum">    4766 </span>            : 
<span class="lineNum">    4767 </span><span class="lineCov">          4 : void readttfmort(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    4768 </span><span class="lineCov">          4 :     info-&gt;justinuse = git_normal;</span>
<span class="lineNum">    4769 </span><span class="lineCov">          4 :     _readttfmort(ttf,info);</span>
<a name="4770"><span class="lineNum">    4770 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">    4771 </span>            : 
<span class="lineNum">    4772 </span><span class="lineNoCov">          0 : void readttfmort_glyphsused(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    4773 </span><span class="lineNoCov">          0 :     info-&gt;justinuse = git_justinuse;</span>
<span class="lineNum">    4774 </span><span class="lineNoCov">          0 :     _readttfmort(ttf,info);</span>
<span class="lineNum">    4775 </span><span class="lineNoCov">          0 :     info-&gt;justinuse = git_normal;</span>
<span class="lineNum">    4776 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    4777 </span>            : 
<span class="lineNum">    4778 </span>            : /* Apple's docs imply that kerning info is always provided left to right, even*/
<span class="lineNum">    4779 </span>            : /*  for right to left scripts. My guess is that their docs are wrong, as they */
<span class="lineNum">    4780 </span>            : /*  often are, but if that be so then we need code in here to reverse */
<a name="4781"><span class="lineNum">    4781 </span>            : /*  the order of the characters for right to left since pfaedit's convention */</a>
<span class="lineNum">    4782 </span>            : /*  is to follow writing order rather than to go left to right */
<span class="lineNum">    4783 </span><span class="lineCov">          1 : void readttfkerns(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    4784 </span>            :     int tabcnt, len, coverage,i,j, npairs, version, format, flags_good, tab;
<span class="lineNum">    4785 </span>            :     int left, right, offset, array, rowWidth;
<span class="lineNum">    4786 </span>            :     int header_size;
<span class="lineNum">    4787 </span>            :     KernPair *kp;
<span class="lineNum">    4788 </span>            :     KernClass *kc;
<span class="lineNum">    4789 </span>            :     uint32 begin_table;
<span class="lineNum">    4790 </span>            :     uint16 *class1, *class2;
<span class="lineNum">    4791 </span>            :     int tupleIndex;
<span class="lineNum">    4792 </span>            :     int isv;
<span class="lineNum">    4793 </span>            :     SplineChar **chars;
<span class="lineNum">    4794 </span>            :     OTLookup *otl;
<span class="lineNum">    4795 </span>            : 
<span class="lineNum">    4796 </span><span class="lineCov">          1 :     fseek(ttf,info-&gt;kern_start,SEEK_SET);</span>
<span class="lineNum">    4797 </span><span class="lineCov">          1 :     version = getushort(ttf);</span>
<span class="lineNum">    4798 </span><span class="lineCov">          1 :     tabcnt = getushort(ttf);</span>
<span class="lineNum">    4799 </span><span class="lineCov">          1 :     if ( version!=0 ) {</span>
<span class="lineNum">    4800 </span><span class="lineNoCov">          0 :         fseek(ttf,info-&gt;kern_start,SEEK_SET);</span>
<span class="lineNum">    4801 </span><span class="lineNoCov">          0 :         version = getlong(ttf);</span>
<span class="lineNum">    4802 </span><span class="lineNoCov">          0 :         tabcnt = getlong(ttf);</span>
<span class="lineNum">    4803 </span><span class="lineNoCov">          0 :         if ( version!=0x10000 ) {</span>
<span class="lineNum">    4804 </span><span class="lineNoCov">          0 :             LogError(_(&quot;Invalid or unsupported version (0x%x) for 'kern' table&quot;), version );</span>
<span class="lineNum">    4805 </span><span class="lineNoCov">          0 :             info-&gt;bad_gx = true;</span>
<span class="lineNum">    4806 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    4807 </span>            :         }
<span class="lineNum">    4808 </span>            :     }
<span class="lineNum">    4809 </span><span class="lineCov">          1 :     if ( tabcnt&lt;0 || tabcnt&gt;0x1000 )</span>
<span class="lineNum">    4810 </span><span class="lineNoCov">          0 :         LogError(_(&quot;Warning: Unlikely number of subtables (%d) for 'kern' table&quot;), tabcnt );</span>
<span class="lineNum">    4811 </span><span class="lineCov">          2 :     for ( tab=0; tab&lt;tabcnt; ++tab ) {</span>
<span class="lineNum">    4812 </span><span class="lineCov">          1 :         begin_table = ftell(ttf);</span>
<span class="lineNum">    4813 </span><span class="lineCov">          1 :         if ( version==0 ) {</span>
<span class="lineNum">    4814 </span><span class="lineCov">          1 :             /* version = */ getushort(ttf);</span>
<span class="lineNum">    4815 </span><span class="lineCov">          1 :             len = getushort(ttf);</span>
<span class="lineNum">    4816 </span><span class="lineCov">          1 :             coverage = getushort(ttf);</span>
<span class="lineNum">    4817 </span><span class="lineCov">          1 :             format = coverage&gt;&gt;8;</span>
<span class="lineNum">    4818 </span><span class="lineCov">          1 :             flags_good = ((coverage&amp;7)&lt;=1);</span>
<span class="lineNum">    4819 </span><span class="lineCov">          1 :             isv = !(coverage&amp;1);</span>
<span class="lineNum">    4820 </span><span class="lineCov">          1 :             tupleIndex = -1;</span>
<span class="lineNum">    4821 </span><span class="lineCov">          1 :             header_size = 6;</span>
<span class="lineNum">    4822 </span>            :         } else {
<span class="lineNum">    4823 </span><span class="lineNoCov">          0 :             len = getlong(ttf);</span>
<span class="lineNum">    4824 </span><span class="lineNoCov">          0 :             coverage = getushort(ttf);</span>
<span class="lineNum">    4825 </span>            :             /* Apple has reordered the bits */
<span class="lineNum">    4826 </span><span class="lineNoCov">          0 :             format = (coverage&amp;0xff);</span>
<span class="lineNum">    4827 </span><span class="lineNoCov">          0 :             flags_good = ((coverage&amp;0xdf00)==0 || (coverage&amp;0xdf00)==0x8000);</span>
<span class="lineNum">    4828 </span><span class="lineNoCov">          0 :             isv = coverage&amp;0x8000? 1 : 0;</span>
<span class="lineNum">    4829 </span><span class="lineNoCov">          0 :             tupleIndex = getushort(ttf);</span>
<span class="lineNum">    4830 </span><span class="lineNoCov">          0 :             if ( coverage&amp;0x2000 ) {</span>
<span class="lineNum">    4831 </span><span class="lineNoCov">          0 :                 if ( info-&gt;variations==NULL )</span>
<span class="lineNum">    4832 </span><span class="lineNoCov">          0 :                     flags_good = false; /* Ignore if we failed to load the tuple data */</span>
<span class="lineNum">    4833 </span><span class="lineNoCov">          0 :                 else if ( tupleIndex&gt;=info-&gt;variations-&gt;tuple_count )</span>
<span class="lineNum">    4834 </span><span class="lineNoCov">          0 :                     flags_good = false; /* Bad tuple */</span>
<span class="lineNum">    4835 </span>            :             } else
<span class="lineNum">    4836 </span><span class="lineNoCov">          0 :                 tupleIndex = -1;</span>
<span class="lineNum">    4837 </span><span class="lineNoCov">          0 :             header_size = 8;</span>
<span class="lineNum">    4838 </span>            :         }
<span class="lineNum">    4839 </span><span class="lineCov">          1 :         otl = NULL;</span>
<span class="lineNum">    4840 </span><span class="lineCov">          1 :         if ( flags_good ) {</span>
<span class="lineNum">    4841 </span><span class="lineCov">          1 :             otl = NewMacLookup(info,true);</span>
<span class="lineNum">    4842 </span><span class="lineCov">          1 :             otl-&gt;lookup_type = gpos_pair;</span>
<span class="lineNum">    4843 </span><span class="lineCov">          1 :             if ( isv ) {</span>
<span class="lineNum">    4844 </span><span class="lineNoCov">          0 :                 otl-&gt;features-&gt;featuretag = CHR('v','k','r','n');</span>
<span class="lineNum">    4845 </span><span class="lineNoCov">          0 :                 otl-&gt;features-&gt;ismac = false;</span>
<span class="lineNum">    4846 </span>            :             }
<span class="lineNum">    4847 </span><span class="lineCov">          1 :             otl-&gt;subtables-&gt;per_glyph_pst_or_kern = true;</span>
<span class="lineNum">    4848 </span><span class="lineCov">          1 :             otl-&gt;subtables-&gt;vertical_kerning = isv;</span>
<span class="lineNum">    4849 </span>            :         }
<span class="lineNum">    4850 </span><span class="lineCov">          1 :         if ( flags_good &amp;&amp; format==0 ) {</span>
<span class="lineNum">    4851 </span>            :             /* format 0, horizontal kerning data (as pairs) not perpendicular */
<span class="lineNum">    4852 </span><span class="lineCov">          1 :             chars = tupleIndex==-1 ? info-&gt;chars : info-&gt;variations-&gt;tuples[tupleIndex].chars;</span>
<span class="lineNum">    4853 </span><span class="lineCov">          1 :             npairs = getushort(ttf);</span>
<span class="lineNum">    4854 </span><span class="lineCov">          1 :             if ( version==0 &amp;&amp; (len-14 != 6*npairs || npairs&gt;10920 )) {</span>
<span class="lineNum">    4855 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;In the 'kern' table, a subtable's length does not match the number of kerning pairs.&quot;) );</span>
<span class="lineNum">    4856 </span><span class="lineNoCov">          0 :                 info-&gt;bad_gx = true;</span>
<span class="lineNum">    4857 </span>            :             }
<span class="lineNum">    4858 </span><span class="lineCov">          1 :             /* searchRange = */ getushort(ttf);</span>
<span class="lineNum">    4859 </span><span class="lineCov">          1 :             /* entrySelector = */ getushort(ttf);</span>
<span class="lineNum">    4860 </span><span class="lineCov">          1 :             /* rangeShift = */ getushort(ttf);</span>
<span class="lineNum">    4861 </span><span class="lineCov">          1 :             otl-&gt;subtables[0].per_glyph_pst_or_kern = true;</span>
<span class="lineNum">    4862 </span><span class="lineCov">         58 :             for ( j=0; j&lt;npairs; ++j ) {</span>
<span class="lineNum">    4863 </span><span class="lineCov">         57 :                 left = getushort(ttf);</span>
<span class="lineNum">    4864 </span><span class="lineCov">         57 :                 right = getushort(ttf);</span>
<span class="lineNum">    4865 </span><span class="lineCov">         57 :                 offset = (short) getushort(ttf);</span>
<span class="lineNum">    4866 </span><span class="lineCov">         57 :                 if ( left&lt;0 || right&lt;0 ) {</span>
<span class="lineNum">    4867 </span>            :                     /* We've seen such buggy fonts... */
<span class="lineNum">    4868 </span><span class="lineNoCov">          0 :                     LogError( _(&quot;Bad kern pair: glyphs %d &amp; %d mustn't be negative\n&quot;),</span>
<span class="lineNum">    4869 </span>            :                             left, right );
<span class="lineNum">    4870 </span><span class="lineNoCov">          0 :                     info-&gt;bad_gx = true;</span>
<span class="lineNum">    4871 </span><span class="lineCov">         57 :                 } else if ( left&gt;=info-&gt;glyph_cnt || right&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    4872 </span>            :                     /* Holes happen when reading ttc files. They are probably ok */
<span class="lineNum">    4873 </span><span class="lineNoCov">          0 :                     LogError( _(&quot;Bad kern pair: glyphs %d &amp; %d must be less than %d\n&quot;),</span>
<span class="lineNum">    4874 </span>            :                             left, right, info-&gt;glyph_cnt );
<span class="lineNum">    4875 </span><span class="lineNoCov">          0 :                     info-&gt;bad_gx = true;</span>
<span class="lineNum">    4876 </span><span class="lineCov">         57 :                 } else if (chars[left]==NULL || chars[right]==NULL ) {</span>
<span class="lineNum">    4877 </span>            :                     /* Shouldn't happen. */
<span class="lineNum">    4878 </span><span class="lineNoCov">          0 :                     LogError( _(&quot;Bad kern pair: glyphs at %d &amp; %d are null\n&quot;),</span>
<span class="lineNum">    4879 </span>            :                             left, right);
<span class="lineNum">    4880 </span><span class="lineNoCov">          0 :                     info-&gt;bad_gx = true;</span>
<span class="lineNum">    4881 </span>            :                 } else {
<span class="lineNum">    4882 </span><span class="lineCov">         57 :                     kp = chunkalloc(sizeof(KernPair));</span>
<span class="lineNum">    4883 </span><span class="lineCov">         57 :                     kp-&gt;sc = chars[right];</span>
<span class="lineNum">    4884 </span><span class="lineCov">         57 :                     kp-&gt;off = offset;</span>
<span class="lineNum">    4885 </span><span class="lineCov">         57 :                     kp-&gt;subtable = otl-&gt;subtables;</span>
<span class="lineNum">    4886 </span><span class="lineCov">         57 :                     FListsAppendScriptLang(otl-&gt;features,SCScriptFromUnicode(chars[left]),</span>
<span class="lineNum">    4887 </span>            :                             DEFAULT_LANG);
<span class="lineNum">    4888 </span><span class="lineCov">         57 :                     if ( isv ) {</span>
<span class="lineNum">    4889 </span><span class="lineNoCov">          0 :                         kp-&gt;next = chars[left]-&gt;vkerns;</span>
<span class="lineNum">    4890 </span><span class="lineNoCov">          0 :                         chars[left]-&gt;vkerns = kp;</span>
<span class="lineNum">    4891 </span>            :                     } else {
<span class="lineNum">    4892 </span><span class="lineCov">         57 :                         kp-&gt;next = chars[left]-&gt;kerns;</span>
<span class="lineNum">    4893 </span><span class="lineCov">         57 :                         chars[left]-&gt;kerns = kp;</span>
<span class="lineNum">    4894 </span>            :                     }
<span class="lineNum">    4895 </span>            :                 }
<span class="lineNum">    4896 </span>            :             }
<span class="lineNum">    4897 </span><span class="lineCov">          1 :             InfoNameOTLookup(otl,info);</span>
<span class="lineNum">    4898 </span><span class="lineNoCov">          0 :         } else if ( flags_good &amp;&amp; format==1 ) {</span>
<span class="lineNum">    4899 </span>            :             /* format 1 is an apple state machine which can handle weird cases */
<span class="lineNum">    4900 </span>            :             /*  OpenType's spec doesn't document this */
<span class="lineNum">    4901 </span>            :             /* Apple's docs are wrong about this table, they claim */
<span class="lineNum">    4902 </span>            :             /*  there is a special value which marks the end of the kerning */
<span class="lineNum">    4903 </span>            :             /*  lists. In fact there is no such value, the list is as long */
<span class="lineNum">    4904 </span>            :             /*  as there are things on the kern stack */
<span class="lineNum">    4905 </span><span class="lineNoCov">          0 :             otl-&gt;lookup_type = kern_statemachine;</span>
<span class="lineNum">    4906 </span><span class="lineNoCov">          0 :             readttf_mortx_asm(ttf,info,false,len-header_size,asm_kern,0,</span>
<span class="lineNum">    4907 </span>            :                 isv ? 0x80000000 : 0 /* coverage doesn't really apply */,otl);
<span class="lineNum">    4908 </span><span class="lineNoCov">          0 :             fseek(ttf,begin_table+len,SEEK_SET);</span>
<span class="lineNum">    4909 </span><span class="lineNoCov">          0 :         } else if ( flags_good &amp;&amp; (format==2 || format==3 )) {</span>
<span class="lineNum">    4910 </span>            :             /* two class based formats */
<span class="lineNum">    4911 </span>            :             KernClass **khead, **klast;
<span class="lineNum">    4912 </span><span class="lineNoCov">          0 :             if ( isv &amp;&amp; tupleIndex==-1 ) {</span>
<span class="lineNum">    4913 </span><span class="lineNoCov">          0 :                 khead = &amp;info-&gt;vkhead;</span>
<span class="lineNum">    4914 </span><span class="lineNoCov">          0 :                 klast = &amp;info-&gt;vklast;</span>
<span class="lineNum">    4915 </span><span class="lineNoCov">          0 :             } else if ( tupleIndex==-1 ) {</span>
<span class="lineNum">    4916 </span><span class="lineNoCov">          0 :                 khead = &amp;info-&gt;khead;</span>
<span class="lineNum">    4917 </span><span class="lineNoCov">          0 :                 klast = &amp;info-&gt;klast;</span>
<span class="lineNum">    4918 </span><span class="lineNoCov">          0 :             } else if ( isv ) {</span>
<span class="lineNum">    4919 </span><span class="lineNoCov">          0 :                 khead = &amp;info-&gt;variations-&gt;tuples[tupleIndex].vkhead;</span>
<span class="lineNum">    4920 </span><span class="lineNoCov">          0 :                 klast = &amp;info-&gt;variations-&gt;tuples[tupleIndex].vklast;</span>
<span class="lineNum">    4921 </span>            :             } else {
<span class="lineNum">    4922 </span><span class="lineNoCov">          0 :                 khead = &amp;info-&gt;variations-&gt;tuples[tupleIndex].khead;</span>
<span class="lineNum">    4923 </span><span class="lineNoCov">          0 :                 klast = &amp;info-&gt;variations-&gt;tuples[tupleIndex].klast;</span>
<span class="lineNum">    4924 </span>            :             }
<span class="lineNum">    4925 </span><span class="lineNoCov">          0 :             if ( *khead==NULL )</span>
<span class="lineNum">    4926 </span><span class="lineNoCov">          0 :                 *khead = kc = chunkalloc(sizeof(KernClass));</span>
<span class="lineNum">    4927 </span>            :             else
<span class="lineNum">    4928 </span><span class="lineNoCov">          0 :                 kc = (*klast)-&gt;next = chunkalloc(sizeof(KernClass));</span>
<span class="lineNum">    4929 </span><span class="lineNoCov">          0 :             *klast = kc;</span>
<span class="lineNum">    4930 </span><span class="lineNoCov">          0 :             if ( format==2 ) {</span>
<span class="lineNum">    4931 </span><span class="lineNoCov">          0 :                 rowWidth = getushort(ttf);</span>
<span class="lineNum">    4932 </span><span class="lineNoCov">          0 :                 left = getushort(ttf);</span>
<span class="lineNum">    4933 </span><span class="lineNoCov">          0 :                 right = getushort(ttf);</span>
<span class="lineNum">    4934 </span><span class="lineNoCov">          0 :                 array = getushort(ttf);</span>
<span class="lineNum">    4935 </span><span class="lineNoCov">          0 :                 kc-&gt;second_cnt = rowWidth/sizeof(uint16);</span>
<span class="lineNum">    4936 </span><span class="lineNoCov">          0 :                 class1 = getAppleClassTable(ttf, begin_table+left, info-&gt;glyph_cnt, array, rowWidth, info );</span>
<span class="lineNum">    4937 </span><span class="lineNoCov">          0 :                 class2 = getAppleClassTable(ttf, begin_table+right, info-&gt;glyph_cnt, 0, sizeof(uint16), info );</span>
<span class="lineNum">    4938 </span><span class="lineNoCov">          0 :                 for ( i=0; i&lt;info-&gt;glyph_cnt; ++i )</span>
<span class="lineNum">    4939 </span><span class="lineNoCov">          0 :                     if ( class1[i]&gt;kc-&gt;first_cnt )</span>
<span class="lineNum">    4940 </span><span class="lineNoCov">          0 :                         kc-&gt;first_cnt = class1[i];</span>
<span class="lineNum">    4941 </span><span class="lineNoCov">          0 :                 ++ kc-&gt;first_cnt;</span>
<span class="lineNum">    4942 </span><span class="lineNoCov">          0 :                 kc-&gt;offsets = malloc(kc-&gt;first_cnt*kc-&gt;second_cnt*sizeof(int16));</span>
<span class="lineNum">    4943 </span><span class="lineNoCov">          0 :                 kc-&gt;adjusts = calloc(kc-&gt;first_cnt*kc-&gt;second_cnt,sizeof(DeviceTable));</span>
<span class="lineNum">    4944 </span><span class="lineNoCov">          0 :                 fseek(ttf,begin_table+array,SEEK_SET);</span>
<span class="lineNum">    4945 </span><span class="lineNoCov">          0 :                 for ( i=0; i&lt;kc-&gt;first_cnt*kc-&gt;second_cnt; ++i )</span>
<span class="lineNum">    4946 </span><span class="lineNoCov">          0 :                     kc-&gt;offsets[i] = getushort(ttf);</span>
<span class="lineNum">    4947 </span>            :             } else {
<span class="lineNum">    4948 </span>            :                 /* format 3, horizontal kerning data (as classes limited to 256 entries) */
<span class="lineNum">    4949 </span>            :                 /*  OpenType's spec doesn't document this */
<span class="lineNum">    4950 </span>            :                 int gc, kv, flags;
<span class="lineNum">    4951 </span>            :                 int16 *kvs;
<span class="lineNum">    4952 </span><span class="lineNoCov">          0 :                 gc = getushort(ttf);</span>
<span class="lineNum">    4953 </span><span class="lineNoCov">          0 :                 kv = getc(ttf);</span>
<span class="lineNum">    4954 </span><span class="lineNoCov">          0 :                 kc-&gt;first_cnt = getc(ttf);</span>
<span class="lineNum">    4955 </span><span class="lineNoCov">          0 :                 kc-&gt;second_cnt = getc(ttf);</span>
<span class="lineNum">    4956 </span><span class="lineNoCov">          0 :                 flags = getc(ttf);</span>
<span class="lineNum">    4957 </span><span class="lineNoCov">          0 :                 if ( gc&gt;info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    4958 </span><span class="lineNoCov">          0 :                     LogError( _(&quot;Kerning subtable 3 says the glyph count is %d, but maxp says %d\n&quot;),</span>
<span class="lineNum">    4959 </span>            :                             gc, info-&gt;glyph_cnt );
<span class="lineNum">    4960 </span><span class="lineNoCov">          0 :                     info-&gt;bad_gx = true;</span>
<span class="lineNum">    4961 </span>            :                 }
<span class="lineNum">    4962 </span><span class="lineNoCov">          0 :                 class1 = calloc(gc&gt;info-&gt;glyph_cnt?gc:info-&gt;glyph_cnt,sizeof(uint16));</span>
<span class="lineNum">    4963 </span><span class="lineNoCov">          0 :                 class2 = calloc(gc&gt;info-&gt;glyph_cnt?gc:info-&gt;glyph_cnt,sizeof(uint16));</span>
<span class="lineNum">    4964 </span><span class="lineNoCov">          0 :                 kvs = malloc(kv*sizeof(int16));</span>
<span class="lineNum">    4965 </span><span class="lineNoCov">          0 :                 kc-&gt;offsets = malloc(kc-&gt;first_cnt*kc-&gt;second_cnt*sizeof(int16));</span>
<span class="lineNum">    4966 </span><span class="lineNoCov">          0 :                 kc-&gt;adjusts = calloc(kc-&gt;first_cnt*kc-&gt;second_cnt,sizeof(DeviceTable));</span>
<span class="lineNum">    4967 </span><span class="lineNoCov">          0 :                 for ( i=0; i&lt;kv; ++i )</span>
<span class="lineNum">    4968 </span><span class="lineNoCov">          0 :                     kvs[i] = (int16) getushort(ttf);</span>
<span class="lineNum">    4969 </span><span class="lineNoCov">          0 :                 for ( i=0; i&lt;gc; ++i )</span>
<span class="lineNum">    4970 </span><span class="lineNoCov">          0 :                     class1[i] = getc(ttf);</span>
<span class="lineNum">    4971 </span><span class="lineNoCov">          0 :                 for ( i=0; i&lt;gc; ++i )</span>
<span class="lineNum">    4972 </span><span class="lineNoCov">          0 :                     class2[i] = getc(ttf);</span>
<span class="lineNum">    4973 </span><span class="lineNoCov">          0 :                 for ( i=0; i&lt;kc-&gt;first_cnt*kc-&gt;second_cnt; ++i )</span>
<span class="lineNum">    4974 </span><span class="lineNoCov">          0 :                     kc-&gt;offsets[i] = kvs[getc(ttf)];</span>
<span class="lineNum">    4975 </span><span class="lineNoCov">          0 :                 free(kvs);</span>
<span class="lineNum">    4976 </span>            :             }
<span class="lineNum">    4977 </span><span class="lineNoCov">          0 :             kc-&gt;firsts = ClassToNames(info,kc-&gt;first_cnt,class1,info-&gt;glyph_cnt);</span>
<span class="lineNum">    4978 </span><span class="lineNoCov">          0 :             kc-&gt;seconds = ClassToNames(info,kc-&gt;second_cnt,class2,info-&gt;glyph_cnt);</span>
<span class="lineNum">    4979 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;info-&gt;glyph_cnt; ++i ) {</span>
<span class="lineNum">    4980 </span><span class="lineNoCov">          0 :                 if ( class1[i]&gt;=4 &amp;&amp; info-&gt;chars[i]!=NULL )</span>
<span class="lineNum">    4981 </span><span class="lineNoCov">          0 :                     FListsAppendScriptLang(otl-&gt;features,</span>
<span class="lineNum">    4982 </span><span class="lineNoCov">          0 :                             SCScriptFromUnicode(info-&gt;chars[i]),</span>
<span class="lineNum">    4983 </span>            :                             DEFAULT_LANG);
<span class="lineNum">    4984 </span>            :             }
<span class="lineNum">    4985 </span><span class="lineNoCov">          0 :             free(class1); free(class2);</span>
<span class="lineNum">    4986 </span><span class="lineNoCov">          0 :             fseek(ttf,begin_table+len,SEEK_SET);</span>
<span class="lineNum">    4987 </span><span class="lineNoCov">          0 :             otl-&gt;subtables[0].kc = kc;</span>
<span class="lineNum">    4988 </span><span class="lineNoCov">          0 :             kc-&gt;subtable = otl-&gt;subtables;</span>
<span class="lineNum">    4989 </span><span class="lineNoCov">          0 :             InfoNameOTLookup(otl,info);</span>
<span class="lineNum">    4990 </span>            :         } else {
<span class="lineNum">    4991 </span><span class="lineNoCov">          0 :             LogError(_(&quot;Invalid or unsupported format (%d) for subtable of 'kern' table&quot;), format );</span>
<span class="lineNum">    4992 </span><span class="lineNoCov">          0 :             info-&gt;bad_gx = true;</span>
<span class="lineNum">    4993 </span><span class="lineNoCov">          0 :             fseek(ttf,len-header_size,SEEK_CUR);</span>
<span class="lineNum">    4994 </span><span class="lineNoCov">          0 :             if ( otl!=NULL )</span>
<span class="lineNum">    4995 </span><span class="lineNoCov">          0 :                 OTLRemove(info,otl,true);</span>
<span class="lineNum">    4996 </span><span class="lineNoCov">          0 : return;         /* Give up */</span>
<span class="lineNum">    4997 </span>            :         }
<span class="lineNum">    4998 </span>            :     }
<a name="4999"><span class="lineNum">    4999 </span>            : }</a>
<span class="lineNum">    5000 </span>            : 
<span class="lineNum">    5001 </span><span class="lineCov">          4 : void readmacfeaturemap(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    5002 </span><span class="lineCov">          4 :     MacFeat *last=NULL, *cur;</span>
<span class="lineNum">    5003 </span>            :     struct macsetting *slast, *scur;
<span class="lineNum">    5004 </span>            :     struct fs { int n; int off; } *fs;
<span class="lineNum">    5005 </span>            :     int featcnt, i, j, flags;
<span class="lineNum">    5006 </span>            : 
<span class="lineNum">    5007 </span><span class="lineCov">          4 :     fseek(ttf,info-&gt;feat_start,SEEK_SET);</span>
<span class="lineNum">    5008 </span><span class="lineCov">          4 :     /* version =*/ getfixed(ttf);</span>
<span class="lineNum">    5009 </span><span class="lineCov">          4 :     featcnt = getushort(ttf);</span>
<span class="lineNum">    5010 </span><span class="lineCov">          4 :     /* reserved */ getushort(ttf);</span>
<span class="lineNum">    5011 </span><span class="lineCov">          4 :     /* reserved */ getlong(ttf);</span>
<span class="lineNum">    5012 </span><span class="lineCov">          4 :     if ( feof(ttf)) {</span>
<span class="lineNum">    5013 </span><span class="lineNoCov">          0 :         LogError( _(&quot;End of file in feat table.\n&quot; ));</span>
<span class="lineNum">    5014 </span><span class="lineNoCov">          0 :         info-&gt;bad_gx = true;</span>
<span class="lineNum">    5015 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5016 </span>            :     }
<span class="lineNum">    5017 </span>            : 
<span class="lineNum">    5018 </span><span class="lineCov">          4 :     fs = malloc(featcnt*sizeof(struct fs));</span>
<span class="lineNum">    5019 </span><span class="lineCov">         13 :     for ( i=0; i&lt;featcnt; ++i ) {</span>
<span class="lineNum">    5020 </span><span class="lineCov">          9 :         cur = chunkalloc(sizeof(MacFeat));</span>
<span class="lineNum">    5021 </span><span class="lineCov">          9 :         if ( last==NULL )</span>
<span class="lineNum">    5022 </span><span class="lineCov">          4 :             info-&gt;features = cur;</span>
<span class="lineNum">    5023 </span>            :         else
<span class="lineNum">    5024 </span><span class="lineCov">          5 :             last-&gt;next = cur;</span>
<span class="lineNum">    5025 </span><span class="lineCov">          9 :         last = cur;</span>
<span class="lineNum">    5026 </span>            : 
<span class="lineNum">    5027 </span><span class="lineCov">          9 :         cur-&gt;feature = getushort(ttf);</span>
<span class="lineNum">    5028 </span><span class="lineCov">          9 :         fs[i].n = getushort(ttf);</span>
<span class="lineNum">    5029 </span><span class="lineCov">          9 :         fs[i].off = getlong(ttf);</span>
<span class="lineNum">    5030 </span><span class="lineCov">          9 :         flags = getushort(ttf);</span>
<span class="lineNum">    5031 </span><span class="lineCov">          9 :         cur-&gt;strid = getushort(ttf);</span>
<span class="lineNum">    5032 </span><span class="lineCov">          9 :         if ( flags&amp;0x8000 ) cur-&gt;ismutex = true;</span>
<span class="lineNum">    5033 </span><span class="lineCov">          9 :         if ( flags&amp;0x4000 )</span>
<span class="lineNum">    5034 </span><span class="lineCov">          1 :             cur-&gt;default_setting = flags&amp;0xff;</span>
<span class="lineNum">    5035 </span><span class="lineCov">          9 :         if ( feof(ttf)) {</span>
<span class="lineNum">    5036 </span><span class="lineNoCov">          0 :             free(fs);</span>
<span class="lineNum">    5037 </span><span class="lineNoCov">          0 :             LogError( _(&quot;End of file in feat table.\n&quot; ));</span>
<span class="lineNum">    5038 </span><span class="lineNoCov">          0 :             info-&gt;bad_gx = true;</span>
<span class="lineNum">    5039 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5040 </span>            :         }
<span class="lineNum">    5041 </span>            :     }
<span class="lineNum">    5042 </span>            : 
<span class="lineNum">    5043 </span><span class="lineCov">         13 :     for ( i=0, cur=info-&gt;features; i&lt;featcnt; ++i, cur = cur-&gt;next ) {</span>
<span class="lineNum">    5044 </span><span class="lineCov">          9 :         fseek(ttf,info-&gt;feat_start+fs[i].off,SEEK_SET);</span>
<span class="lineNum">    5045 </span><span class="lineCov">          9 :         slast = NULL;</span>
<span class="lineNum">    5046 </span><span class="lineCov">         19 :         for ( j=0; j&lt;fs[i].n; ++j ) {</span>
<span class="lineNum">    5047 </span><span class="lineCov">         10 :             scur = chunkalloc(sizeof(struct macsetting));</span>
<span class="lineNum">    5048 </span><span class="lineCov">         10 :             if ( slast==NULL )</span>
<span class="lineNum">    5049 </span><span class="lineCov">          9 :                 cur-&gt;settings = scur;</span>
<span class="lineNum">    5050 </span>            :             else
<span class="lineNum">    5051 </span><span class="lineCov">          1 :                 slast-&gt;next = scur;</span>
<span class="lineNum">    5052 </span><span class="lineCov">         10 :             slast = scur;</span>
<span class="lineNum">    5053 </span>            : 
<span class="lineNum">    5054 </span><span class="lineCov">         10 :             scur-&gt;setting = getushort(ttf);</span>
<span class="lineNum">    5055 </span><span class="lineCov">         10 :             scur-&gt;strid = getushort(ttf);</span>
<span class="lineNum">    5056 </span><span class="lineCov">         10 :             if ( feof(ttf)) {</span>
<span class="lineNum">    5057 </span><span class="lineNoCov">          0 :                 free(fs);</span>
<span class="lineNum">    5058 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;End of file in feat table.\n&quot;) );</span>
<span class="lineNum">    5059 </span><span class="lineNoCov">          0 :                 info-&gt;bad_gx = true;</span>
<span class="lineNum">    5060 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5061 </span>            :             }
<span class="lineNum">    5062 </span>            :         }
<span class="lineNum">    5063 </span>            :     }
<span class="lineNum">    5064 </span><span class="lineCov">          4 :     free(fs);</span>
<a name="5065"><span class="lineNum">    5065 </span>            : }</a>
<span class="lineNum">    5066 </span>            : 
<span class="lineNum">    5067 </span><span class="lineCov">          8 : static void FeatMarkAsEnabled(struct ttfinfo *info,int featureType,</span>
<span class="lineNum">    5068 </span>            :         int featureSetting) {
<span class="lineNum">    5069 </span>            :     MacFeat *f;
<span class="lineNum">    5070 </span>            :     struct macsetting *s;
<span class="lineNum">    5071 </span>            : 
<span class="lineNum">    5072 </span><span class="lineCov">          8 :     for ( f = info-&gt;features; f!=NULL &amp;&amp; f-&gt;feature!=featureType; f=f-&gt;next );</span>
<span class="lineNum">    5073 </span><span class="lineCov">          8 :     if ( f==NULL )</span>
<span class="lineNum">    5074 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5075 </span><span class="lineCov">          8 :     if ( f-&gt;ismutex ) {</span>
<span class="lineNum">    5076 </span><span class="lineNoCov">          0 :         for ( s=f-&gt;settings ; s!=NULL; s=s-&gt;next )</span>
<span class="lineNum">    5077 </span><span class="lineNoCov">          0 :             s-&gt;initially_enabled = ( s-&gt;setting==featureSetting );</span>
<span class="lineNum">    5078 </span><span class="lineNoCov">          0 :         f-&gt;default_setting = featureSetting;</span>
<span class="lineNum">    5079 </span>            :     } else {
<span class="lineNum">    5080 </span><span class="lineCov">          8 :         for ( s=f-&gt;settings ; s!=NULL &amp;&amp; s-&gt;setting!=featureSetting; s=s-&gt;next );</span>
<span class="lineNum">    5081 </span><span class="lineCov">          8 :         if ( s!=NULL )</span>
<span class="lineNum">    5082 </span><span class="lineCov">          8 :             s-&gt;initially_enabled = true;</span>
<span class="lineNum">    5083 </span>            :     }
<span class="lineNum">    5084 </span><span class="lineCov">          8 : return;</span>
<span class="lineNum">    5085 </span>            : }
<span class="lineNum">    5086 </span>            : 
<span class="lineNum">    5087 </span>            : /******************************************************************************/
<span class="lineNum">    5088 </span>            : /* ******************************* MATH Table ******************************* */
<span class="lineNum">    5089 </span>            : /* ********************** (Not strictly OpenType yet) *********************** */
<span class="lineNum">    5090 </span>            : /******************************************************************************/
<span class="lineNum">    5091 </span>            : 
<a name="5092"><span class="lineNum">    5092 </span>            : /* ******************************** Read MATH ******************************* */</a>
<span class="lineNum">    5093 </span>            : 
<span class="lineNum">    5094 </span><span class="lineNoCov">          0 : static void ttf_math_read_constants(FILE *ttf,struct ttfinfo *info, uint32 start) {</span>
<span class="lineNum">    5095 </span>            :     struct MATH *math;
<span class="lineNum">    5096 </span>            :     int i;
<span class="lineNum">    5097 </span>            :     uint16 off;
<span class="lineNum">    5098 </span>            : 
<span class="lineNum">    5099 </span><span class="lineNoCov">          0 :     fseek(ttf,start,SEEK_SET);</span>
<span class="lineNum">    5100 </span><span class="lineNoCov">          0 :     info-&gt;math = math = calloc(1,sizeof(struct MATH));</span>
<span class="lineNum">    5101 </span>            : 
<span class="lineNum">    5102 </span><span class="lineNoCov">          0 :     for ( i=0; math_constants_descriptor[i].script_name!=NULL; ++i ) {</span>
<span class="lineNum">    5103 </span><span class="lineNoCov">          0 :         int16 *pos = (int16 *) (((char *) (math)) + math_constants_descriptor[i].offset );</span>
<span class="lineNum">    5104 </span><span class="lineNoCov">          0 :         if ( pos == (int16 *) &amp;math-&gt;MinConnectorOverlap )</span>
<span class="lineNum">    5105 </span><span class="lineNoCov">          0 :     continue;           /* Actually lives in the Variant table, not here */</span>
<span class="lineNum">    5106 </span><span class="lineNoCov">          0 :         *pos = getushort(ttf);</span>
<span class="lineNum">    5107 </span><span class="lineNoCov">          0 :         if ( math_constants_descriptor[i].devtab_offset &gt;= 0 ) {</span>
<span class="lineNum">    5108 </span><span class="lineNoCov">          0 :             DeviceTable **devtab = (DeviceTable **) (((char *) (math)) + math_constants_descriptor[i].devtab_offset );</span>
<span class="lineNum">    5109 </span><span class="lineNoCov">          0 :             off = getushort(ttf);</span>
<span class="lineNum">    5110 </span><span class="lineNoCov">          0 :             if ( off!=0 ) {</span>
<span class="lineNum">    5111 </span><span class="lineNoCov">          0 :                 *devtab = chunkalloc(sizeof(DeviceTable));</span>
<span class="lineNum">    5112 </span><span class="lineNoCov">          0 :                 ReadDeviceTable(ttf,*devtab,start+off,info);</span>
<span class="lineNum">    5113 </span>            :             }
<span class="lineNum">    5114 </span>            :         }
<span class="lineNum">    5115 </span>            :     }
<a name="5116"><span class="lineNum">    5116 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5117 </span>            : 
<span class="lineNum">    5118 </span><span class="lineNoCov">          0 : static void ttf_math_read_icta(FILE *ttf,struct ttfinfo *info, uint32 start, int is_ic) {</span>
<span class="lineNum">    5119 </span>            :     /* The italic correction and top accent sub-tables have the same format */
<span class="lineNum">    5120 </span>            :     int coverage, cnt, i, val, offset;
<span class="lineNum">    5121 </span>            :     uint16 *glyphs;
<span class="lineNum">    5122 </span>            : 
<span class="lineNum">    5123 </span><span class="lineNoCov">          0 :     fseek(ttf,start,SEEK_SET);</span>
<span class="lineNum">    5124 </span><span class="lineNoCov">          0 :     coverage = getushort(ttf);</span>
<span class="lineNum">    5125 </span><span class="lineNoCov">          0 :     cnt = getushort(ttf);</span>
<span class="lineNum">    5126 </span><span class="lineNoCov">          0 :     glyphs = getCoverageTable(ttf,start+coverage,info);</span>
<span class="lineNum">    5127 </span><span class="lineNoCov">          0 :     if ( glyphs==NULL )</span>
<span class="lineNum">    5128 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5129 </span><span class="lineNoCov">          0 :     fseek(ttf,start+4,SEEK_SET);</span>
<span class="lineNum">    5130 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    5131 </span><span class="lineNoCov">          0 :       val = (int16) getushort(ttf);</span>
<span class="lineNum">    5132 </span><span class="lineNoCov">          0 :       offset = getushort(ttf);</span>
<span class="lineNum">    5133 </span><span class="lineNoCov">          0 :       if ( glyphs[i]&lt;info-&gt;glyph_cnt &amp;&amp; info-&gt;chars[ glyphs[i]]!=NULL ) {</span>
<span class="lineNum">    5134 </span><span class="lineNoCov">          0 :         if ( is_ic )</span>
<span class="lineNum">    5135 </span><span class="lineNoCov">          0 :             info-&gt;chars[ glyphs[i] ]-&gt;italic_correction = val;</span>
<span class="lineNum">    5136 </span>            :         else
<span class="lineNum">    5137 </span><span class="lineNoCov">          0 :             info-&gt;chars[ glyphs[i] ]-&gt;top_accent_horiz = val;</span>
<span class="lineNum">    5138 </span><span class="lineNoCov">          0 :         if ( offset!=0 ) {</span>
<span class="lineNum">    5139 </span><span class="lineNoCov">          0 :             DeviceTable *dv = chunkalloc(sizeof(DeviceTable));</span>
<span class="lineNum">    5140 </span><span class="lineNoCov">          0 :             ReadDeviceTable(ttf,dv,start+offset,info);</span>
<span class="lineNum">    5141 </span><span class="lineNoCov">          0 :             if ( is_ic )</span>
<span class="lineNum">    5142 </span><span class="lineNoCov">          0 :                 info-&gt;chars[ glyphs[i] ]-&gt;italic_adjusts = dv;</span>
<span class="lineNum">    5143 </span>            :             else
<span class="lineNum">    5144 </span><span class="lineNoCov">          0 :                 info-&gt;chars[ glyphs[i] ]-&gt;top_accent_adjusts = dv;</span>
<span class="lineNum">    5145 </span>            :         }
<span class="lineNum">    5146 </span>            :       }
<span class="lineNum">    5147 </span>            :     }
<span class="lineNum">    5148 </span><span class="lineNoCov">          0 :     free(glyphs);</span>
<a name="5149"><span class="lineNum">    5149 </span>            : }</a>
<span class="lineNum">    5150 </span>            : 
<span class="lineNum">    5151 </span><span class="lineNoCov">          0 : static void ttf_math_read_extended(FILE *ttf,struct ttfinfo *info, uint32 start) {</span>
<span class="lineNum">    5152 </span>            :     int i;
<span class="lineNum">    5153 </span>            :     uint16 *glyphs;
<span class="lineNum">    5154 </span>            : 
<span class="lineNum">    5155 </span><span class="lineNoCov">          0 :     glyphs = getCoverageTable(ttf,start,info);</span>
<span class="lineNum">    5156 </span><span class="lineNoCov">          0 :     if ( glyphs==NULL )</span>
<span class="lineNum">    5157 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5158 </span><span class="lineNoCov">          0 :     for ( i=0; glyphs[i]!=0xffff; ++i ) if ( glyphs[i]&lt;info-&gt;glyph_cnt &amp;&amp; info-&gt;chars[ glyphs[i]]!=NULL )</span>
<span class="lineNum">    5159 </span><span class="lineNoCov">          0 :         info-&gt;chars[ glyphs[i] ]-&gt;is_extended_shape = true;</span>
<span class="lineNum">    5160 </span><span class="lineNoCov">          0 :     free(glyphs);</span>
<a name="5161"><span class="lineNum">    5161 </span>            : }</a>
<span class="lineNum">    5162 </span>            : 
<span class="lineNum">    5163 </span><span class="lineNoCov">          0 : static void ttf_math_read_mathkernv(FILE *ttf, uint32 start,struct mathkernvertex *mkv,</span>
<span class="lineNum">    5164 </span>            :         SplineChar *sc, int istop, struct ttfinfo *info) {
<span class="lineNum">    5165 </span>            :     int cnt, i;
<span class="lineNum">    5166 </span>            : 
<span class="lineNum">    5167 </span><span class="lineNoCov">          0 :     fseek(ttf,start,SEEK_SET);</span>
<span class="lineNum">    5168 </span>            :     /* There is one more width than height. I store the width count */
<span class="lineNum">    5169 </span>            :     /*  and guess a dummy height later */
<span class="lineNum">    5170 </span><span class="lineNoCov">          0 :     mkv-&gt;cnt = cnt = getushort(ttf)+1;</span>
<span class="lineNum">    5171 </span><span class="lineNoCov">          0 :     mkv-&gt;mkd = calloc(cnt,sizeof(struct mathkerndata));</span>
<span class="lineNum">    5172 </span>            : 
<span class="lineNum">    5173 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cnt-1; ++i ) {</span>
<span class="lineNum">    5174 </span><span class="lineNoCov">          0 :         mkv-&gt;mkd[i].height = getushort(ttf);</span>
<span class="lineNum">    5175 </span><span class="lineNoCov">          0 :         mkv-&gt;mkd[i].height_adjusts = (void *) (intpt) getushort(ttf);</span>
<span class="lineNum">    5176 </span>            :     }
<span class="lineNum">    5177 </span>            : 
<span class="lineNum">    5178 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    5179 </span><span class="lineNoCov">          0 :         mkv-&gt;mkd[i].kern = getushort(ttf);</span>
<span class="lineNum">    5180 </span><span class="lineNoCov">          0 :         mkv-&gt;mkd[i].kern_adjusts = (void *) (intpt) getushort(ttf);</span>
<span class="lineNum">    5181 </span>            :     }
<span class="lineNum">    5182 </span>            : 
<span class="lineNum">    5183 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    5184 </span>            :         DeviceTable *dv;
<span class="lineNum">    5185 </span>            :         uint32 offset;
<span class="lineNum">    5186 </span><span class="lineNoCov">          0 :         if ( mkv-&gt;mkd[i].height_adjusts!=NULL ) {</span>
<span class="lineNum">    5187 </span><span class="lineNoCov">          0 :             offset = start + (intpt) mkv-&gt;mkd[i].height_adjusts;</span>
<span class="lineNum">    5188 </span><span class="lineNoCov">          0 :             mkv-&gt;mkd[i].height_adjusts = dv = chunkalloc(sizeof(DeviceTable));</span>
<span class="lineNum">    5189 </span><span class="lineNoCov">          0 :             ReadDeviceTable(ttf,dv,offset,info);</span>
<span class="lineNum">    5190 </span>            :         }
<span class="lineNum">    5191 </span><span class="lineNoCov">          0 :         if ( mkv-&gt;mkd[i].kern_adjusts!=NULL ) {</span>
<span class="lineNum">    5192 </span><span class="lineNoCov">          0 :             offset = start + (intpt) mkv-&gt;mkd[i].kern_adjusts;</span>
<span class="lineNum">    5193 </span><span class="lineNoCov">          0 :             mkv-&gt;mkd[i].kern_adjusts = dv = chunkalloc(sizeof(DeviceTable));</span>
<span class="lineNum">    5194 </span><span class="lineNoCov">          0 :             ReadDeviceTable(ttf,dv,offset,info);</span>
<span class="lineNum">    5195 </span>            :         }
<span class="lineNum">    5196 </span>            :     }
<span class="lineNum">    5197 </span>            : 
<span class="lineNum">    5198 </span><span class="lineNoCov">          0 :     if ( cnt&gt;=3 )</span>
<span class="lineNum">    5199 </span><span class="lineNoCov">          0 :         mkv-&gt;mkd[cnt-1].height = 2*mkv-&gt;mkd[cnt-2].height - mkv-&gt;mkd[cnt-3].height;</span>
<span class="lineNum">    5200 </span><span class="lineNoCov">          0 :     else if ( cnt&gt;=2 )</span>
<span class="lineNum">    5201 </span><span class="lineNoCov">          0 :         mkv-&gt;mkd[cnt-1].height = mkv-&gt;mkd[cnt-2].height + 100;</span>
<span class="lineNum">    5202 </span><span class="lineNoCov">          0 :     else if ( cnt==1 ) {</span>
<span class="lineNum">    5203 </span><span class="lineNoCov">          0 :         if ( istop ) {</span>
<span class="lineNum">    5204 </span>            :             DBounds b;
<span class="lineNum">    5205 </span><span class="lineNoCov">          0 :             SplineCharQuickBounds(sc,&amp;b);</span>
<span class="lineNum">    5206 </span><span class="lineNoCov">          0 :             mkv-&gt;mkd[cnt-1].height = b.maxy;</span>
<span class="lineNum">    5207 </span>            :         } else
<span class="lineNum">    5208 </span><span class="lineNoCov">          0 :             mkv-&gt;mkd[cnt-1].height = 0;</span>
<span class="lineNum">    5209 </span>            :     }
<a name="5210"><span class="lineNum">    5210 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5211 </span>            : 
<span class="lineNum">    5212 </span><span class="lineNoCov">          0 : static void ttf_math_read_mathkern(FILE *ttf,struct ttfinfo *info, uint32 start) {</span>
<span class="lineNum">    5213 </span>            :     int coverage, cnt, i;
<span class="lineNum">    5214 </span>            :     uint16 *glyphs;
<span class="lineNum">    5215 </span>            :     struct koff { uint16 tr, tl, br, bl; } *koff;
<span class="lineNum">    5216 </span>            : 
<span class="lineNum">    5217 </span><span class="lineNoCov">          0 :     fseek(ttf,start,SEEK_SET);</span>
<span class="lineNum">    5218 </span><span class="lineNoCov">          0 :     coverage = getushort(ttf);</span>
<span class="lineNum">    5219 </span><span class="lineNoCov">          0 :     cnt = getushort(ttf);</span>
<span class="lineNum">    5220 </span><span class="lineNoCov">          0 :     koff = malloc(cnt*sizeof(struct koff));</span>
<span class="lineNum">    5221 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    5222 </span><span class="lineNoCov">          0 :         koff[i].tr = getushort(ttf);</span>
<span class="lineNum">    5223 </span><span class="lineNoCov">          0 :         koff[i].tl = getushort(ttf);</span>
<span class="lineNum">    5224 </span><span class="lineNoCov">          0 :         koff[i].br = getushort(ttf);</span>
<span class="lineNum">    5225 </span><span class="lineNoCov">          0 :         koff[i].bl = getushort(ttf);</span>
<span class="lineNum">    5226 </span>            :     }
<span class="lineNum">    5227 </span><span class="lineNoCov">          0 :     glyphs = getCoverageTable(ttf,start+coverage,info);</span>
<span class="lineNum">    5228 </span><span class="lineNoCov">          0 :     if ( glyphs==NULL ) {</span>
<span class="lineNum">    5229 </span><span class="lineNoCov">          0 :         free(koff);</span>
<span class="lineNum">    5230 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5231 </span>            :     }
<span class="lineNum">    5232 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cnt; ++i ) if ( glyphs[i]&lt;info-&gt;glyph_cnt &amp;&amp; info-&gt;chars[ glyphs[i]]!=NULL ) {</span>
<span class="lineNum">    5233 </span><span class="lineNoCov">          0 :         SplineChar *sc = info-&gt;chars[ glyphs[i]];</span>
<span class="lineNum">    5234 </span><span class="lineNoCov">          0 :         sc-&gt;mathkern = chunkalloc(sizeof(struct mathkern));</span>
<span class="lineNum">    5235 </span><span class="lineNoCov">          0 :         if ( koff[i].tr!=0 )</span>
<span class="lineNum">    5236 </span><span class="lineNoCov">          0 :             ttf_math_read_mathkernv(ttf,start+koff[i].tr,&amp;sc-&gt;mathkern-&gt;top_right,sc,true,info);</span>
<span class="lineNum">    5237 </span><span class="lineNoCov">          0 :         if ( koff[i].tl!=0 )</span>
<span class="lineNum">    5238 </span><span class="lineNoCov">          0 :             ttf_math_read_mathkernv(ttf,start+koff[i].tl,&amp;sc-&gt;mathkern-&gt;top_left,sc,true,info);</span>
<span class="lineNum">    5239 </span><span class="lineNoCov">          0 :         if ( koff[i].br!=0 )</span>
<span class="lineNum">    5240 </span><span class="lineNoCov">          0 :             ttf_math_read_mathkernv(ttf,start+koff[i].br,&amp;sc-&gt;mathkern-&gt;bottom_right,sc,false,info);</span>
<span class="lineNum">    5241 </span><span class="lineNoCov">          0 :         if ( koff[i].bl!=0 )</span>
<span class="lineNum">    5242 </span><span class="lineNoCov">          0 :             ttf_math_read_mathkernv(ttf,start+koff[i].bl,&amp;sc-&gt;mathkern-&gt;bottom_left,sc,false,info);</span>
<span class="lineNum">    5243 </span>            :     }
<span class="lineNum">    5244 </span><span class="lineNoCov">          0 :     free(koff);</span>
<span class="lineNum">    5245 </span><span class="lineNoCov">          0 :     free(glyphs);</span>
<a name="5246"><span class="lineNum">    5246 </span>            : }</a>
<span class="lineNum">    5247 </span>            : 
<span class="lineNum">    5248 </span><span class="lineNoCov">          0 : static void ttf_math_read_glyphinfo(FILE *ttf,struct ttfinfo *info, uint32 start) {</span>
<span class="lineNum">    5249 </span>            :     int icoff,taoff,esoff,kioff;
<span class="lineNum">    5250 </span>            : 
<span class="lineNum">    5251 </span><span class="lineNoCov">          0 :     fseek(ttf,start,SEEK_SET);</span>
<span class="lineNum">    5252 </span><span class="lineNoCov">          0 :     icoff = getushort(ttf);</span>
<span class="lineNum">    5253 </span><span class="lineNoCov">          0 :     taoff = getushort(ttf);</span>
<span class="lineNum">    5254 </span><span class="lineNoCov">          0 :     esoff = getushort(ttf);</span>
<span class="lineNum">    5255 </span><span class="lineNoCov">          0 :     kioff = getushort(ttf);</span>
<span class="lineNum">    5256 </span>            : 
<span class="lineNum">    5257 </span><span class="lineNoCov">          0 :     if ( icoff!=0 )</span>
<span class="lineNum">    5258 </span><span class="lineNoCov">          0 :         ttf_math_read_icta(ttf,info,start+icoff,true);</span>
<span class="lineNum">    5259 </span><span class="lineNoCov">          0 :     if ( taoff!=0 )</span>
<span class="lineNum">    5260 </span><span class="lineNoCov">          0 :         ttf_math_read_icta(ttf,info,start+taoff,false);</span>
<span class="lineNum">    5261 </span><span class="lineNoCov">          0 :     if ( esoff!=0 )</span>
<span class="lineNum">    5262 </span><span class="lineNoCov">          0 :         ttf_math_read_extended(ttf,info,start+esoff);</span>
<span class="lineNum">    5263 </span><span class="lineNoCov">          0 :     if ( kioff!=0 )</span>
<span class="lineNum">    5264 </span><span class="lineNoCov">          0 :         ttf_math_read_mathkern(ttf,info,start+kioff);</span>
<a name="5265"><span class="lineNum">    5265 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5266 </span>            : 
<span class="lineNum">    5267 </span><span class="lineNoCov">          0 : static struct glyphvariants *ttf_math_read_gvtable(FILE *ttf,struct ttfinfo *info, uint32 start,</span>
<span class="lineNum">    5268 </span>            :         enum gsub_inusetype justinuse, SplineChar *basesc, int isv ) {
<span class="lineNum">    5269 </span><span class="lineNoCov">          0 :     struct glyphvariants *gv = chunkalloc(sizeof(struct glyphvariants));</span>
<span class="lineNum">    5270 </span>            :     int ga_offset;
<span class="lineNum">    5271 </span>            :     int vcnt;
<span class="lineNum">    5272 </span>            :     uint16 *glyphs;
<span class="lineNum">    5273 </span>            :     int i, j, len;
<span class="lineNum">    5274 </span>            :     char *pt;
<span class="lineNum">    5275 </span>            :     int ic_offset, pcnt;
<span class="lineNum">    5276 </span>            :     SplineChar *sc;
<span class="lineNum">    5277 </span>            :     char ebuf[10], buffer[50], *ext;
<span class="lineNum">    5278 </span>            : 
<span class="lineNum">    5279 </span><span class="lineNoCov">          0 :     fseek(ttf,start,SEEK_SET);</span>
<span class="lineNum">    5280 </span><span class="lineNoCov">          0 :     ga_offset = getushort(ttf);</span>
<span class="lineNum">    5281 </span><span class="lineNoCov">          0 :     vcnt      = getushort(ttf);</span>
<span class="lineNum">    5282 </span><span class="lineNoCov">          0 :     if ( vcnt!=0 ) {</span>
<span class="lineNum">    5283 </span><span class="lineNoCov">          0 :         if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    5284 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;vcnt; ++i ) {</span>
<span class="lineNum">    5285 </span><span class="lineNoCov">          0 :                 int gid = getushort(ttf);</span>
<span class="lineNum">    5286 </span><span class="lineNoCov">          0 :                 /* sizes[i] = */ getushort(ttf);</span>
<span class="lineNum">    5287 </span><span class="lineNoCov">          0 :                 if ( gid&gt;=0 &amp;&amp; gid&lt;info-&gt;glyph_cnt )</span>
<span class="lineNum">    5288 </span><span class="lineNoCov">          0 :                     info-&gt;inuse[gid] = true;</span>
<span class="lineNum">    5289 </span>            :             }
<span class="lineNum">    5290 </span><span class="lineNoCov">          0 :         } else if ( justinuse==git_findnames ) {</span>
<span class="lineNum">    5291 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;vcnt; ++i ) {</span>
<span class="lineNum">    5292 </span><span class="lineNoCov">          0 :                 int gid = getushort(ttf);</span>
<span class="lineNum">    5293 </span><span class="lineNoCov">          0 :                 /* sizes[i] = */ getushort(ttf);</span>
<span class="lineNum">    5294 </span><span class="lineNoCov">          0 :                 if ( basesc!=NULL &amp;&amp; basesc-&gt;name!=NULL &amp;&amp;</span>
<span class="lineNum">    5295 </span><span class="lineNoCov">          0 :                         gid&gt;=0 &amp;&amp; gid&lt;info-&gt;glyph_cnt &amp;&amp;</span>
<span class="lineNum">    5296 </span><span class="lineNoCov">          0 :                         (sc = info-&gt;chars[gid])!=NULL &amp;&amp; sc-&gt;name==NULL ) {</span>
<span class="lineNum">    5297 </span><span class="lineNoCov">          0 :                     snprintf(buffer,sizeof(buffer),&quot;%.30s.%csize%d&quot;,</span>
<span class="lineNum">    5298 </span>            :                             basesc-&gt;name, isv?'v':'h', i);
<span class="lineNum">    5299 </span><span class="lineNoCov">          0 :                     sc-&gt;name = copy(buffer);</span>
<span class="lineNum">    5300 </span>            :                 }
<span class="lineNum">    5301 </span>            :             }
<span class="lineNum">    5302 </span>            :         } else {
<span class="lineNum">    5303 </span><span class="lineNoCov">          0 :             glyphs    = malloc(vcnt*sizeof(uint16));</span>
<span class="lineNum">    5304 </span><span class="lineNoCov">          0 :             len = 0;</span>
<span class="lineNum">    5305 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;vcnt; ++i ) {</span>
<span class="lineNum">    5306 </span><span class="lineNoCov">          0 :                 glyphs[i]      = getushort(ttf);</span>
<span class="lineNum">    5307 </span><span class="lineNoCov">          0 :                 /* sizes[i] = */ getushort(ttf);</span>
<span class="lineNum">    5308 </span><span class="lineNoCov">          0 :                 if ( glyphs[i]&lt;info-&gt;glyph_cnt &amp;&amp; (sc = info-&gt;chars[ glyphs[i]])!=NULL )</span>
<span class="lineNum">    5309 </span><span class="lineNoCov">          0 :                     len += strlen(sc-&gt;name)+1;</span>
<span class="lineNum">    5310 </span>            :             }
<span class="lineNum">    5311 </span><span class="lineNoCov">          0 :             if ( len!=0 ) {</span>
<span class="lineNum">    5312 </span><span class="lineNoCov">          0 :                 gv-&gt;variants = pt = malloc(len);</span>
<span class="lineNum">    5313 </span><span class="lineNoCov">          0 :                 for ( i=len=0; i&lt;vcnt; ++i ) {</span>
<span class="lineNum">    5314 </span><span class="lineNoCov">          0 :                     if ( glyphs[i]&lt;info-&gt;glyph_cnt &amp;&amp; (sc = info-&gt;chars[ glyphs[i]])!=NULL ) {</span>
<span class="lineNum">    5315 </span><span class="lineNoCov">          0 :                         strcpy(pt+len,sc-&gt;name);</span>
<span class="lineNum">    5316 </span><span class="lineNoCov">          0 :                         len += strlen(sc-&gt;name);</span>
<span class="lineNum">    5317 </span><span class="lineNoCov">          0 :                         pt[len++] = ' ';</span>
<span class="lineNum">    5318 </span>            :                     }
<span class="lineNum">    5319 </span>            :                 }
<span class="lineNum">    5320 </span><span class="lineNoCov">          0 :                 pt[len-1] = '\0';</span>
<span class="lineNum">    5321 </span>            :             }
<span class="lineNum">    5322 </span><span class="lineNoCov">          0 :             free(glyphs);</span>
<span class="lineNum">    5323 </span>            :         }
<span class="lineNum">    5324 </span>            :     }
<span class="lineNum">    5325 </span><span class="lineNoCov">          0 :     if ( ga_offset!=0 ) {</span>
<span class="lineNum">    5326 </span><span class="lineNoCov">          0 :         start += ga_offset;</span>
<span class="lineNum">    5327 </span><span class="lineNoCov">          0 :         fseek(ttf,start,SEEK_SET);</span>
<span class="lineNum">    5328 </span><span class="lineNoCov">          0 :         gv-&gt;italic_correction = getushort(ttf);</span>
<span class="lineNum">    5329 </span><span class="lineNoCov">          0 :         ic_offset = getushort(ttf);</span>
<span class="lineNum">    5330 </span><span class="lineNoCov">          0 :         gv-&gt;part_cnt = pcnt = getushort(ttf);</span>
<span class="lineNum">    5331 </span><span class="lineNoCov">          0 :         if ( justinuse==git_normal )</span>
<span class="lineNum">    5332 </span><span class="lineNoCov">          0 :             gv-&gt;parts = calloc(pcnt,sizeof(struct gv_part));</span>
<span class="lineNum">    5333 </span><span class="lineNoCov">          0 :         for ( i=j=0; i&lt;pcnt; ++i ) {</span>
<span class="lineNum">    5334 </span>            :             int gid, start, end, full, flags;
<span class="lineNum">    5335 </span><span class="lineNoCov">          0 :             gid = getushort(ttf);</span>
<span class="lineNum">    5336 </span><span class="lineNoCov">          0 :             start = getushort(ttf);</span>
<span class="lineNum">    5337 </span><span class="lineNoCov">          0 :             end = getushort(ttf);</span>
<span class="lineNum">    5338 </span><span class="lineNoCov">          0 :             full = getushort(ttf);</span>
<span class="lineNum">    5339 </span><span class="lineNoCov">          0 :             flags = getushort(ttf);</span>
<span class="lineNum">    5340 </span><span class="lineNoCov">          0 :             if ( feof(ttf)) {</span>
<span class="lineNum">    5341 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Bad glyph variant subtable of MATH table.\n&quot;) );</span>
<span class="lineNum">    5342 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    5343 </span><span class="lineNoCov">          0 :                 chunkfree(gv,sizeof(*gv));</span>
<span class="lineNum">    5344 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5345 </span>            :             }
<span class="lineNum">    5346 </span><span class="lineNoCov">          0 :             if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    5347 </span><span class="lineNoCov">          0 :                 if ( gid&lt;info-&gt;glyph_cnt )</span>
<span class="lineNum">    5348 </span><span class="lineNoCov">          0 :                     info-&gt;inuse[gid] = true;</span>
<span class="lineNum">    5349 </span><span class="lineNoCov">          0 :             } else if ( justinuse==git_findnames ) {</span>
<span class="lineNum">    5350 </span><span class="lineNoCov">          0 :                 if ( basesc!=NULL &amp;&amp; basesc-&gt;name!=NULL &amp;&amp;</span>
<span class="lineNum">    5351 </span><span class="lineNoCov">          0 :                         gid&gt;=0 &amp;&amp; gid&lt;info-&gt;glyph_cnt &amp;&amp;</span>
<span class="lineNum">    5352 </span><span class="lineNoCov">          0 :                         (sc = info-&gt;chars[gid])!=NULL &amp;&amp; sc-&gt;name==NULL ) {</span>
<span class="lineNum">    5353 </span><span class="lineNoCov">          0 :                     if ( pcnt==1 )</span>
<span class="lineNum">    5354 </span><span class="lineNoCov">          0 :                         ext = &quot;repeat&quot;;</span>
<span class="lineNum">    5355 </span><span class="lineNoCov">          0 :                     if ( i==0 )</span>
<span class="lineNum">    5356 </span><span class="lineNoCov">          0 :                         ext = isv ? &quot;bot&quot; : &quot;left&quot;;</span>
<span class="lineNum">    5357 </span><span class="lineNoCov">          0 :                     else if ( i==pcnt-1 )</span>
<span class="lineNum">    5358 </span><span class="lineNoCov">          0 :                         ext = isv ? &quot;top&quot; : &quot;right&quot;;</span>
<span class="lineNum">    5359 </span><span class="lineNoCov">          0 :                     else if ( i==1 &amp;&amp; pcnt==3 )</span>
<span class="lineNum">    5360 </span><span class="lineNoCov">          0 :                         ext = &quot;mid&quot;;</span>
<span class="lineNum">    5361 </span>            :                     else {
<span class="lineNum">    5362 </span><span class="lineNoCov">          0 :                         sprintf( ebuf, &quot;%cpart%d&quot;, isv?'v':'h', i );</span>
<span class="lineNum">    5363 </span><span class="lineNoCov">          0 :                         ext = ebuf;</span>
<span class="lineNum">    5364 </span>            :                     }
<span class="lineNum">    5365 </span><span class="lineNoCov">          0 :                     snprintf(buffer,sizeof(buffer),&quot;%.30s.%s&quot;,</span>
<span class="lineNum">    5366 </span>            :                             basesc-&gt;name, ext );
<span class="lineNum">    5367 </span><span class="lineNoCov">          0 :                     sc-&gt;name = copy(buffer);</span>
<span class="lineNum">    5368 </span>            :                 }
<span class="lineNum">    5369 </span>            :             } else {
<span class="lineNum">    5370 </span><span class="lineNoCov">          0 :                 if ( gid&lt;info-&gt;glyph_cnt &amp;&amp; (sc = info-&gt;chars[gid])!=NULL ) {</span>
<span class="lineNum">    5371 </span><span class="lineNoCov">          0 :                     gv-&gt;parts[j].component = copy( sc-&gt;name );</span>
<span class="lineNum">    5372 </span><span class="lineNoCov">          0 :                     gv-&gt;parts[j].startConnectorLength = start;</span>
<span class="lineNum">    5373 </span><span class="lineNoCov">          0 :                     gv-&gt;parts[j].endConnectorLength = end;</span>
<span class="lineNum">    5374 </span><span class="lineNoCov">          0 :                     gv-&gt;parts[j].fullAdvance = full;</span>
<span class="lineNum">    5375 </span><span class="lineNoCov">          0 :                     gv-&gt;parts[j++].is_extender = flags&amp;1;</span>
<span class="lineNum">    5376 </span>            :                 }
<span class="lineNum">    5377 </span>            :             }
<span class="lineNum">    5378 </span>            :         }
<span class="lineNum">    5379 </span><span class="lineNoCov">          0 :         gv-&gt;part_cnt = j;</span>
<span class="lineNum">    5380 </span><span class="lineNoCov">          0 :         if ( ic_offset!=0 &amp;&amp; justinuse==git_normal ) {</span>
<span class="lineNum">    5381 </span><span class="lineNoCov">          0 :             gv-&gt;italic_adjusts = chunkalloc(sizeof(DeviceTable));</span>
<span class="lineNum">    5382 </span><span class="lineNoCov">          0 :             ReadDeviceTable(ttf,gv-&gt;italic_adjusts,start+ic_offset,info);</span>
<span class="lineNum">    5383 </span>            :         }
<span class="lineNum">    5384 </span>            :     }
<span class="lineNum">    5385 </span><span class="lineNoCov">          0 :     if ( justinuse==git_justinuse ) {</span>
<span class="lineNum">    5386 </span><span class="lineNoCov">          0 :         chunkfree(gv,sizeof(*gv));</span>
<span class="lineNum">    5387 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5388 </span>            :     }
<span class="lineNum">    5389 </span><span class="lineNoCov">          0 : return( gv );</span>
<a name="5390"><span class="lineNum">    5390 </span>            : }</a>
<span class="lineNum">    5391 </span>            : 
<span class="lineNum">    5392 </span><span class="lineNoCov">          0 : static void ttf_math_read_variants(FILE *ttf,struct ttfinfo *info, uint32 start,</span>
<span class="lineNum">    5393 </span>            :         enum gsub_inusetype justinuse) {
<span class="lineNum">    5394 </span>            :     int vcoverage, hcoverage, vcnt, hcnt;
<span class="lineNum">    5395 </span>            :     int *hoffs, *voffs;
<span class="lineNum">    5396 </span>            :     uint16 *hglyphs, *vglyphs;
<span class="lineNum">    5397 </span>            :     int i;
<span class="lineNum">    5398 </span>            : 
<span class="lineNum">    5399 </span><span class="lineNoCov">          0 :     fseek(ttf,start,SEEK_SET);</span>
<span class="lineNum">    5400 </span><span class="lineNoCov">          0 :     if ( info-&gt;math==NULL )</span>
<span class="lineNum">    5401 </span><span class="lineNoCov">          0 :         info-&gt;math = calloc(1,sizeof(struct MATH));</span>
<span class="lineNum">    5402 </span><span class="lineNoCov">          0 :     info-&gt;math-&gt;MinConnectorOverlap = getushort(ttf);</span>
<span class="lineNum">    5403 </span><span class="lineNoCov">          0 :     vcoverage = getushort(ttf);</span>
<span class="lineNum">    5404 </span><span class="lineNoCov">          0 :     hcoverage = getushort(ttf);</span>
<span class="lineNum">    5405 </span><span class="lineNoCov">          0 :     vcnt = getushort(ttf);</span>
<span class="lineNum">    5406 </span><span class="lineNoCov">          0 :     hcnt = getushort(ttf);</span>
<span class="lineNum">    5407 </span><span class="lineNoCov">          0 :     hoffs = malloc(hcnt*sizeof(int));</span>
<span class="lineNum">    5408 </span><span class="lineNoCov">          0 :     voffs = malloc(vcnt*sizeof(int));</span>
<span class="lineNum">    5409 </span>            : 
<span class="lineNum">    5410 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;vcnt; ++i )</span>
<span class="lineNum">    5411 </span><span class="lineNoCov">          0 :         voffs[i] = getushort(ttf);</span>
<span class="lineNum">    5412 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;hcnt; ++i )</span>
<span class="lineNum">    5413 </span><span class="lineNoCov">          0 :         hoffs[i] = getushort(ttf);</span>
<span class="lineNum">    5414 </span><span class="lineNoCov">          0 :     vglyphs = hglyphs = NULL;</span>
<span class="lineNum">    5415 </span><span class="lineNoCov">          0 :     if ( vcoverage!=0 )</span>
<span class="lineNum">    5416 </span><span class="lineNoCov">          0 :         vglyphs = getCoverageTable(ttf,start+vcoverage,info);</span>
<span class="lineNum">    5417 </span><span class="lineNoCov">          0 :     if ( hcoverage!=0 )</span>
<span class="lineNum">    5418 </span><span class="lineNoCov">          0 :         hglyphs = getCoverageTable(ttf,start+hcoverage,info);</span>
<span class="lineNum">    5419 </span>            : 
<span class="lineNum">    5420 </span><span class="lineNoCov">          0 :     if ( vglyphs!=NULL ) {</span>
<span class="lineNum">    5421 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;vcnt; ++i ) if ( vglyphs[i]&lt;info-&gt;glyph_cnt &amp;&amp; voffs[i]!=0) {</span>
<span class="lineNum">    5422 </span><span class="lineNoCov">          0 :             if ( justinuse == git_normal || justinuse == git_findnames ) {</span>
<span class="lineNum">    5423 </span><span class="lineNoCov">          0 :                 SplineChar *sc = info-&gt;chars[ vglyphs[i]];</span>
<span class="lineNum">    5424 </span><span class="lineNoCov">          0 :                 if ( sc!=NULL )</span>
<span class="lineNum">    5425 </span><span class="lineNoCov">          0 :                     sc-&gt;vert_variants = ttf_math_read_gvtable(ttf,info,start+voffs[i],justinuse,sc,true);</span>
<span class="lineNum">    5426 </span><span class="lineNoCov">          0 :             } else if ( info-&gt;inuse[ vglyphs[i]])</span>
<span class="lineNum">    5427 </span><span class="lineNoCov">          0 :                 ttf_math_read_gvtable(ttf,info,start+voffs[i],justinuse,NULL,true);</span>
<span class="lineNum">    5428 </span>            :         }
<span class="lineNum">    5429 </span>            :     }
<span class="lineNum">    5430 </span><span class="lineNoCov">          0 :     if ( hglyphs!=NULL ) {</span>
<span class="lineNum">    5431 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;hcnt; ++i ) if ( hglyphs[i]&lt;info-&gt;glyph_cnt &amp;&amp; hoffs[i]!=0) {</span>
<span class="lineNum">    5432 </span><span class="lineNoCov">          0 :             if ( justinuse == git_normal || justinuse == git_findnames ) {</span>
<span class="lineNum">    5433 </span><span class="lineNoCov">          0 :                 SplineChar *sc = info-&gt;chars[ hglyphs[i]];</span>
<span class="lineNum">    5434 </span><span class="lineNoCov">          0 :                 if ( sc!=NULL )</span>
<span class="lineNum">    5435 </span><span class="lineNoCov">          0 :                     sc-&gt;horiz_variants = ttf_math_read_gvtable(ttf,info,start+hoffs[i],justinuse,sc,false);</span>
<span class="lineNum">    5436 </span><span class="lineNoCov">          0 :             } else if ( info-&gt;inuse[ hglyphs[i]])</span>
<span class="lineNum">    5437 </span><span class="lineNoCov">          0 :                     ttf_math_read_gvtable(ttf,info,start+hoffs[i],justinuse,NULL,false);</span>
<span class="lineNum">    5438 </span>            :         }
<span class="lineNum">    5439 </span>            :     }
<span class="lineNum">    5440 </span>            : 
<span class="lineNum">    5441 </span><span class="lineNoCov">          0 :     free(vglyphs); free(voffs);</span>
<span class="lineNum">    5442 </span><span class="lineNoCov">          0 :     free(hglyphs); free(hoffs);</span>
<a name="5443"><span class="lineNum">    5443 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5444 </span>            : 
<span class="lineNum">    5445 </span><span class="lineNoCov">          0 : static void _otf_read_math(FILE *ttf,struct ttfinfo *info,</span>
<span class="lineNum">    5446 </span>            :         enum gsub_inusetype justinuse) {
<span class="lineNum">    5447 </span>            :     int constants, glyphinfo, variants;
<span class="lineNum">    5448 </span><span class="lineNoCov">          0 :     if ( info-&gt;math_start==0 )</span>
<span class="lineNum">    5449 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5450 </span><span class="lineNoCov">          0 :     fseek(ttf,info-&gt;math_start,SEEK_SET);</span>
<span class="lineNum">    5451 </span>            : 
<span class="lineNum">    5452 </span><span class="lineNoCov">          0 :     info-&gt;g_bounds = info-&gt;math_start+info-&gt;math_length;</span>
<span class="lineNum">    5453 </span>            : 
<span class="lineNum">    5454 </span><span class="lineNoCov">          0 :     if ( getlong(ttf)!=0x00010000 )</span>
<span class="lineNum">    5455 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5456 </span><span class="lineNoCov">          0 :     constants = getushort(ttf);</span>
<span class="lineNum">    5457 </span><span class="lineNoCov">          0 :     glyphinfo = getushort(ttf);</span>
<span class="lineNum">    5458 </span><span class="lineNoCov">          0 :     variants = getushort(ttf);</span>
<span class="lineNum">    5459 </span>            : 
<span class="lineNum">    5460 </span><span class="lineNoCov">          0 :     if ( justinuse == git_normal ) {</span>
<span class="lineNum">    5461 </span><span class="lineNoCov">          0 :         if ( constants!=0 )</span>
<span class="lineNum">    5462 </span><span class="lineNoCov">          0 :             ttf_math_read_constants(ttf,info,info-&gt;math_start+constants);</span>
<span class="lineNum">    5463 </span><span class="lineNoCov">          0 :         if ( glyphinfo!=0 )</span>
<span class="lineNum">    5464 </span><span class="lineNoCov">          0 :             ttf_math_read_glyphinfo(ttf,info,info-&gt;math_start+glyphinfo);</span>
<span class="lineNum">    5465 </span>            :     }
<span class="lineNum">    5466 </span><span class="lineNoCov">          0 :     if ( variants!=0 )</span>
<span class="lineNum">    5467 </span><span class="lineNoCov">          0 :         ttf_math_read_variants(ttf,info,info-&gt;math_start+variants,justinuse);</span>
<span class="lineNum">    5468 </span><span class="lineNoCov">          0 :     if ( ftell(ttf)&gt;info-&gt;g_bounds ) {</span>
<span class="lineNum">    5469 </span><span class="lineNoCov">          0 :         LogError(_(&quot;MATH table extends beyond table bounds&quot;));</span>
<span class="lineNum">    5470 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    5471 </span>            :     }
<span class="lineNum">    5472 </span><span class="lineNoCov">          0 :     info-&gt;g_bounds = 0;</span>
<a name="5473"><span class="lineNum">    5473 </span>            : }</a>
<span class="lineNum">    5474 </span>            : 
<span class="lineNum">    5475 </span><span class="lineNoCov">          0 : void otf_read_math(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    5476 </span><span class="lineNoCov">          0 :     _otf_read_math(ttf,info,git_normal);</span>
<a name="5477"><span class="lineNum">    5477 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5478 </span>            : 
<span class="lineNum">    5479 </span><span class="lineNoCov">          0 : void otf_read_math_used(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    5480 </span><span class="lineNoCov">          0 :     _otf_read_math(ttf,info,git_justinuse);</span>
<a name="5481"><span class="lineNum">    5481 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5482 </span>            : 
<span class="lineNum">    5483 </span><span class="lineNoCov">          0 : void GuessNamesFromMATH(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    5484 </span><span class="lineNoCov">          0 :     _otf_read_math(ttf,info,git_findnames);</span>
<a name="5485"><span class="lineNum">    5485 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5486 </span>            : 
<span class="lineNum">    5487 </span><span class="lineNoCov">          0 : static struct baselangextent *readttfbaseminmax(FILE *ttf,uint32 offset,struct ttfinfo *info,</span>
<span class="lineNum">    5488 </span>            :         uint32 script_tag,uint32 lang_tag) {
<span class="lineNum">    5489 </span>            :     int j,feat_cnt;
<span class="lineNum">    5490 </span>            :     struct baselangextent *lang, *cur, *last;
<span class="lineNum">    5491 </span>            : 
<span class="lineNum">    5492 </span><span class="lineNoCov">          0 :     fseek(ttf,offset,SEEK_SET);</span>
<span class="lineNum">    5493 </span><span class="lineNoCov">          0 :     lang = chunkalloc(sizeof(struct baselangextent));</span>
<span class="lineNum">    5494 </span><span class="lineNoCov">          0 :     lang-&gt;lang = lang_tag;</span>
<span class="lineNum">    5495 </span><span class="lineNoCov">          0 :     lang-&gt;descent = (short) getushort(ttf);</span>
<span class="lineNum">    5496 </span><span class="lineNoCov">          0 :     lang-&gt;ascent  = (short) getushort(ttf);</span>
<span class="lineNum">    5497 </span>            : 
<span class="lineNum">    5498 </span><span class="lineNoCov">          0 :     feat_cnt = getushort(ttf);</span>
<span class="lineNum">    5499 </span><span class="lineNoCov">          0 :     last = NULL;</span>
<span class="lineNum">    5500 </span><span class="lineNoCov">          0 :     for ( j=0; j&lt;feat_cnt; ++j ) {</span>
<span class="lineNum">    5501 </span><span class="lineNoCov">          0 :         cur = chunkalloc(sizeof(struct baselangextent));</span>
<span class="lineNum">    5502 </span><span class="lineNoCov">          0 :         if ( last==NULL )</span>
<span class="lineNum">    5503 </span><span class="lineNoCov">          0 :             lang-&gt;features = cur;</span>
<span class="lineNum">    5504 </span>            :         else
<span class="lineNum">    5505 </span><span class="lineNoCov">          0 :             last-&gt;next = cur;</span>
<span class="lineNum">    5506 </span><span class="lineNoCov">          0 :         last = cur;</span>
<span class="lineNum">    5507 </span><span class="lineNoCov">          0 :         cur-&gt;lang = getlong(ttf);            /* Actually feature tag here */</span>
<span class="lineNum">    5508 </span><span class="lineNoCov">          0 :         cur-&gt;descent = (short) getushort(ttf);</span>
<span class="lineNum">    5509 </span><span class="lineNoCov">          0 :         cur-&gt;ascent  = (short) getushort(ttf);</span>
<span class="lineNum">    5510 </span>            :     }
<span class="lineNum">    5511 </span><span class="lineNoCov">          0 : return( lang );</span>
<a name="5512"><span class="lineNum">    5512 </span>            : }</a>
<span class="lineNum">    5513 </span>            : 
<span class="lineNum">    5514 </span><span class="lineNoCov">          0 : void readttfbase(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    5515 </span>            :     int version;
<span class="lineNum">    5516 </span>            :     uint32 axes[2];
<span class="lineNum">    5517 </span>            :     uint32 basetags, basescripts;
<span class="lineNum">    5518 </span>            :     int basescriptcnt;
<span class="lineNum">    5519 </span>            :     struct tagoff { uint32 tag; uint32 offset; } *bs;
<span class="lineNum">    5520 </span>            :     int axis,i,j, tot;
<span class="lineNum">    5521 </span>            :     struct Base *curBase;
<span class="lineNum">    5522 </span>            :     struct basescript *curScript, *last;
<span class="lineNum">    5523 </span>            :     struct baselangextent *cur, *lastLang;
<span class="lineNum">    5524 </span>            :     
<span class="lineNum">    5525 </span><span class="lineNoCov">          0 :     if ( info-&gt;base_start==0 )</span>
<span class="lineNum">    5526 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5527 </span><span class="lineNoCov">          0 :     fseek(ttf,info-&gt;base_start,SEEK_SET);</span>
<span class="lineNum">    5528 </span>            : 
<span class="lineNum">    5529 </span><span class="lineNoCov">          0 :     version = getlong(ttf);</span>
<span class="lineNum">    5530 </span><span class="lineNoCov">          0 :     if ( version!=0x00010000 )</span>
<span class="lineNum">    5531 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5532 </span><span class="lineNoCov">          0 :     axes[0] = getushort(ttf);   /* Horizontal */</span>
<span class="lineNum">    5533 </span><span class="lineNoCov">          0 :     axes[1] = getushort(ttf);   /* Vertical */</span>
<span class="lineNum">    5534 </span>            : 
<span class="lineNum">    5535 </span><span class="lineNoCov">          0 :     for ( axis=0; axis&lt;2; ++axis ) {</span>
<span class="lineNum">    5536 </span><span class="lineNoCov">          0 :         if ( axes[axis]==0 )</span>
<span class="lineNum">    5537 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    5538 </span><span class="lineNoCov">          0 :         fseek(ttf,info-&gt;base_start+axes[axis],SEEK_SET);</span>
<span class="lineNum">    5539 </span><span class="lineNoCov">          0 :         curBase = chunkalloc(sizeof(struct Base));</span>
<span class="lineNum">    5540 </span><span class="lineNoCov">          0 :         if ( axis==0 ) info-&gt;horiz_base = curBase; else info-&gt;vert_base = curBase;</span>
<span class="lineNum">    5541 </span><span class="lineNoCov">          0 :         basetags    = getushort(ttf);</span>
<span class="lineNum">    5542 </span><span class="lineNoCov">          0 :         basescripts = getushort(ttf);</span>
<span class="lineNum">    5543 </span><span class="lineNoCov">          0 :         if ( basetags==0 ) {</span>
<span class="lineNum">    5544 </span><span class="lineNoCov">          0 :             curBase-&gt;baseline_cnt = 0;</span>
<span class="lineNum">    5545 </span><span class="lineNoCov">          0 :             curBase-&gt;baseline_tags = NULL;</span>
<span class="lineNum">    5546 </span>            :         } else {
<span class="lineNum">    5547 </span><span class="lineNoCov">          0 :             fseek(ttf,info-&gt;base_start+axes[axis]+basetags,SEEK_SET);</span>
<span class="lineNum">    5548 </span><span class="lineNoCov">          0 :             curBase-&gt;baseline_cnt = getushort(ttf);</span>
<span class="lineNum">    5549 </span><span class="lineNoCov">          0 :             curBase-&gt;baseline_tags = calloc(curBase-&gt;baseline_cnt,sizeof(uint32));</span>
<span class="lineNum">    5550 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;curBase-&gt;baseline_cnt; ++i )</span>
<span class="lineNum">    5551 </span><span class="lineNoCov">          0 :                 curBase-&gt;baseline_tags[i] = getlong(ttf);</span>
<span class="lineNum">    5552 </span>            :         }
<span class="lineNum">    5553 </span><span class="lineNoCov">          0 :         if ( basescripts!=0 ) {</span>
<span class="lineNum">    5554 </span><span class="lineNoCov">          0 :             fseek(ttf,info-&gt;base_start+axes[axis]+basescripts,SEEK_SET);</span>
<span class="lineNum">    5555 </span><span class="lineNoCov">          0 :             basescriptcnt = getushort(ttf);</span>
<span class="lineNum">    5556 </span><span class="lineNoCov">          0 :             bs = calloc(basescriptcnt,sizeof(struct tagoff));</span>
<span class="lineNum">    5557 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;basescriptcnt; ++i ) {</span>
<span class="lineNum">    5558 </span><span class="lineNoCov">          0 :                 bs[i].tag    = getlong(ttf);</span>
<span class="lineNum">    5559 </span><span class="lineNoCov">          0 :                 bs[i].offset = getushort(ttf);</span>
<span class="lineNum">    5560 </span><span class="lineNoCov">          0 :                 if ( bs[i].offset != 0 )</span>
<span class="lineNum">    5561 </span><span class="lineNoCov">          0 :                     bs[i].offset += info-&gt;base_start+axes[axis]+basescripts;</span>
<span class="lineNum">    5562 </span>            :             }
<span class="lineNum">    5563 </span><span class="lineNoCov">          0 :             last = NULL;</span>
<span class="lineNum">    5564 </span><span class="lineNoCov">          0 :             for ( i=0; i&lt;basescriptcnt; ++i ) if ( bs[i].offset!=0 ) {</span>
<span class="lineNum">    5565 </span>            :                 int basevalues, defminmax;
<span class="lineNum">    5566 </span>            :                 int langsyscnt;
<span class="lineNum">    5567 </span>            :                 struct tagoff *ls;
<span class="lineNum">    5568 </span><span class="lineNoCov">          0 :                 fseek(ttf,bs[i].offset,SEEK_SET);</span>
<span class="lineNum">    5569 </span><span class="lineNoCov">          0 :                 basevalues = getushort(ttf);</span>
<span class="lineNum">    5570 </span><span class="lineNoCov">          0 :                 defminmax  = getushort(ttf);</span>
<span class="lineNum">    5571 </span><span class="lineNoCov">          0 :                 langsyscnt = getushort(ttf);</span>
<span class="lineNum">    5572 </span><span class="lineNoCov">          0 :                 ls = calloc(langsyscnt,sizeof(struct tagoff));</span>
<span class="lineNum">    5573 </span><span class="lineNoCov">          0 :                 for ( j=0; j&lt;langsyscnt; ++j ) {</span>
<span class="lineNum">    5574 </span><span class="lineNoCov">          0 :                     ls[j].tag    = getlong(ttf);</span>
<span class="lineNum">    5575 </span><span class="lineNoCov">          0 :                     ls[j].offset = getushort(ttf);</span>
<span class="lineNum">    5576 </span>            :                 }
<span class="lineNum">    5577 </span><span class="lineNoCov">          0 :                 curScript = chunkalloc(sizeof(struct basescript));</span>
<span class="lineNum">    5578 </span><span class="lineNoCov">          0 :                 if ( last==NULL )</span>
<span class="lineNum">    5579 </span><span class="lineNoCov">          0 :                     curBase-&gt;scripts = curScript;</span>
<span class="lineNum">    5580 </span>            :                 else
<span class="lineNum">    5581 </span><span class="lineNoCov">          0 :                     last-&gt;next = curScript;</span>
<span class="lineNum">    5582 </span><span class="lineNoCov">          0 :                 last = curScript;</span>
<span class="lineNum">    5583 </span><span class="lineNoCov">          0 :                 curScript-&gt;script = bs[i].tag;</span>
<span class="lineNum">    5584 </span><span class="lineNoCov">          0 :                 if ( basevalues!=0 ) {</span>
<span class="lineNum">    5585 </span>            :                     int coordcnt;
<span class="lineNum">    5586 </span>            :                     int *coords;
<span class="lineNum">    5587 </span>            : 
<span class="lineNum">    5588 </span><span class="lineNoCov">          0 :                     fseek( ttf,bs[i].offset+basevalues,SEEK_SET);</span>
<span class="lineNum">    5589 </span><span class="lineNoCov">          0 :                     curScript-&gt;def_baseline = getushort(ttf);</span>
<span class="lineNum">    5590 </span><span class="lineNoCov">          0 :                     tot = coordcnt = getushort(ttf);</span>
<span class="lineNum">    5591 </span><span class="lineNoCov">          0 :                     if ( coordcnt!=curBase-&gt;baseline_cnt ) {</span>
<span class="lineNum">    5592 </span><span class="lineNoCov">          0 :                         info-&gt;bad_ot = true;</span>
<span class="lineNum">    5593 </span><span class="lineNoCov">          0 :                         LogError(_(&quot;!!!!! Coord count (%d) for '%c%c%c%c' script does not match base tag count (%d) in 'BASE' table\n&quot;),</span>
<span class="lineNum">    5594 </span>            :                                 coordcnt,
<span class="lineNum">    5595 </span><span class="lineNoCov">          0 :                                 bs[i].tag&gt;&gt;24, bs[i].tag&gt;&gt;16, bs[i].tag&gt;&gt;8, bs[i].tag,</span>
<span class="lineNum">    5596 </span>            :                                 curBase-&gt;baseline_cnt );
<span class="lineNum">    5597 </span><span class="lineNoCov">          0 :                         if ( tot&lt;curBase-&gt;baseline_cnt )</span>
<span class="lineNum">    5598 </span><span class="lineNoCov">          0 :                             tot = curBase-&gt;baseline_cnt;</span>
<span class="lineNum">    5599 </span>            :                     }
<span class="lineNum">    5600 </span><span class="lineNoCov">          0 :                     coords = calloc(coordcnt,sizeof(int));</span>
<span class="lineNum">    5601 </span><span class="lineNoCov">          0 :                     curScript-&gt;baseline_pos = calloc(tot,sizeof(int16));</span>
<span class="lineNum">    5602 </span><span class="lineNoCov">          0 :                     for ( j=0; j&lt;coordcnt; ++j )</span>
<span class="lineNum">    5603 </span><span class="lineNoCov">          0 :                         coords[j] = getushort(ttf);</span>
<span class="lineNum">    5604 </span><span class="lineNoCov">          0 :                     for ( j=0; j&lt;coordcnt; ++j ) if ( coords[j]!=0 ) {</span>
<span class="lineNum">    5605 </span>            :                         int format;
<span class="lineNum">    5606 </span><span class="lineNoCov">          0 :                         fseek( ttf,bs[i].offset+basevalues+coords[j],SEEK_SET);</span>
<span class="lineNum">    5607 </span><span class="lineNoCov">          0 :                         format = getushort(ttf);</span>
<span class="lineNum">    5608 </span><span class="lineNoCov">          0 :                         curScript-&gt;baseline_pos[j]  = (short) getushort(ttf);</span>
<span class="lineNum">    5609 </span><span class="lineNoCov">          0 :                         if ( format!=1 &amp;&amp; format!=2 &amp;&amp; format!=3 ) {</span>
<span class="lineNum">    5610 </span><span class="lineNoCov">          0 :                             info-&gt;bad_ot = true;</span>
<span class="lineNum">    5611 </span><span class="lineNoCov">          0 :                             LogError(_(&quot;!!!!! Bad Base Coord format (%d) for '%c%c%c%c' in '%c%c%c%c' script in 'BASE' table\n&quot;),</span>
<span class="lineNum">    5612 </span>            :                                         format,
<span class="lineNum">    5613 </span><span class="lineNoCov">          0 :                                         curBase-&gt;baseline_tags[j]&gt;&gt;24, curBase-&gt;baseline_tags[j]&gt;&gt;16, curBase-&gt;baseline_tags[j]&gt;&gt;8, curBase-&gt;baseline_tags[j],</span>
<span class="lineNum">    5614 </span><span class="lineNoCov">          0 :                                         bs[i].tag&gt;&gt;24, bs[i].tag&gt;&gt;16, bs[i].tag&gt;&gt;8, bs[i].tag );</span>
<span class="lineNum">    5615 </span>            :                         }
<span class="lineNum">    5616 </span>            :                     }
<span class="lineNum">    5617 </span><span class="lineNoCov">          0 :                     free(coords);</span>
<span class="lineNum">    5618 </span>            :                 } else {
<span class="lineNum">    5619 </span><span class="lineNoCov">          0 :                     curScript-&gt;baseline_pos = calloc(curBase-&gt;baseline_cnt,sizeof(int16));</span>
<span class="lineNum">    5620 </span>            :                 }
<span class="lineNum">    5621 </span><span class="lineNoCov">          0 :                 lastLang = NULL;</span>
<span class="lineNum">    5622 </span><span class="lineNoCov">          0 :                 if ( defminmax!=0 )</span>
<span class="lineNum">    5623 </span><span class="lineNoCov">          0 :                     curScript-&gt;langs = lastLang = readttfbaseminmax(ttf,bs[i].offset+defminmax,info,bs[i].tag,DEFAULT_LANG);</span>
<span class="lineNum">    5624 </span><span class="lineNoCov">          0 :                 if ( langsyscnt!=0 ) {</span>
<span class="lineNum">    5625 </span><span class="lineNoCov">          0 :                     for ( j=0; j&lt;langsyscnt; ++j ) if ( ls[j].offset!=0 ) {</span>
<span class="lineNum">    5626 </span><span class="lineNoCov">          0 :                         cur = readttfbaseminmax(ttf,bs[i].offset+ls[j].offset,info,bs[i].tag,ls[j].tag);</span>
<span class="lineNum">    5627 </span><span class="lineNoCov">          0 :                         if ( last==NULL )</span>
<span class="lineNum">    5628 </span><span class="lineNoCov">          0 :                             curScript-&gt;langs = cur;</span>
<span class="lineNum">    5629 </span>            :                         else
<span class="lineNum">    5630 </span><span class="lineNoCov">          0 :                             lastLang-&gt;next = cur;</span>
<span class="lineNum">    5631 </span><span class="lineNoCov">          0 :                         lastLang = cur;</span>
<span class="lineNum">    5632 </span>            :                     }
<span class="lineNum">    5633 </span>            :                 }
<span class="lineNum">    5634 </span><span class="lineNoCov">          0 :                 free(ls);</span>
<span class="lineNum">    5635 </span>            :             }
<span class="lineNum">    5636 </span><span class="lineNoCov">          0 :             free(bs);</span>
<span class="lineNum">    5637 </span>            :         }
<span class="lineNum">    5638 </span>            :     }
<a name="5639"><span class="lineNum">    5639 </span>            : }</a>
<span class="lineNum">    5640 </span>            : 
<span class="lineNum">    5641 </span><span class="lineNoCov">          0 : static void bsln_apply_values(struct ttfinfo *info, int gfirst, int glast,FILE *ttf) {</span>
<span class="lineNum">    5642 </span>            :     int i;
<span class="lineNum">    5643 </span>            : 
<span class="lineNum">    5644 </span><span class="lineNoCov">          0 :     for ( i=gfirst; i&lt;=glast; ++i )</span>
<span class="lineNum">    5645 </span><span class="lineNoCov">          0 :         info-&gt;bsln_values[i]= getushort(ttf);</span>
<a name="5646"><span class="lineNum">    5646 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5647 </span>            : 
<span class="lineNum">    5648 </span><span class="lineNoCov">          0 : static void bsln_apply_value(struct ttfinfo *info, int gfirst, int glast,FILE *ttf) {</span>
<span class="lineNum">    5649 </span>            :     int i;
<span class="lineNum">    5650 </span>            :     int bsln;
<span class="lineNum">    5651 </span>            : 
<span class="lineNum">    5652 </span><span class="lineNoCov">          0 :     bsln = getushort(ttf);</span>
<span class="lineNum">    5653 </span><span class="lineNoCov">          0 :     for ( i=gfirst; i&lt;=glast; ++i )</span>
<span class="lineNum">    5654 </span><span class="lineNoCov">          0 :         info-&gt;bsln_values[i]= bsln;</span>
<a name="5655"><span class="lineNum">    5655 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5656 </span>            : 
<span class="lineNum">    5657 </span><span class="lineNoCov">          0 : static void bsln_apply_default(struct ttfinfo *info, int gfirst, int glast,void *def) {</span>
<span class="lineNum">    5658 </span>            :     int def_bsln, i;
<span class="lineNum">    5659 </span>            : 
<span class="lineNum">    5660 </span><span class="lineNoCov">          0 :     def_bsln = (intpt) def;</span>
<span class="lineNum">    5661 </span><span class="lineNoCov">          0 :     for ( i=gfirst; i&lt;=glast; ++i )</span>
<span class="lineNum">    5662 </span><span class="lineNoCov">          0 :         info-&gt;bsln_values[i]= def_bsln;</span>
<a name="5663"><span class="lineNum">    5663 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5664 </span>            : 
<span class="lineNum">    5665 </span><span class="lineNoCov">          0 : void readttfbsln(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    5666 </span>            :     int def, ap_def, version, format;
<span class="lineNum">    5667 </span>            :     uint16 *values;
<span class="lineNum">    5668 </span>            :     int offsets[32];
<span class="lineNum">    5669 </span>            :     SplineChar *sc;
<span class="lineNum">    5670 </span>            :     BasePoint pos;
<span class="lineNum">    5671 </span>            :     int mapping[32];
<span class="lineNum">    5672 </span>            :     int i;
<span class="lineNum">    5673 </span>            :     struct Base *base;
<span class="lineNum">    5674 </span>            :     struct basescript *bs;
<span class="lineNum">    5675 </span>            : 
<span class="lineNum">    5676 </span><span class="lineNoCov">          0 :     fseek(ttf,info-&gt;bsln_start,SEEK_SET);</span>
<span class="lineNum">    5677 </span><span class="lineNoCov">          0 :     version = getlong(ttf);</span>
<span class="lineNum">    5678 </span><span class="lineNoCov">          0 :     if ( version!=0x00010000 )</span>
<span class="lineNum">    5679 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5680 </span><span class="lineNoCov">          0 :     format = getushort(ttf);</span>
<span class="lineNum">    5681 </span><span class="lineNoCov">          0 :     def = getushort(ttf);</span>
<span class="lineNum">    5682 </span><span class="lineNoCov">          0 :     if ( format==0 || format==1 ) {</span>
<span class="lineNum">    5683 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;32; ++i )</span>
<span class="lineNum">    5684 </span><span class="lineNoCov">          0 :             offsets[i] = (int16) getushort(ttf);</span>
<span class="lineNum">    5685 </span><span class="lineNoCov">          0 :     } else if ( format==2 || format==3 ) {</span>
<span class="lineNum">    5686 </span><span class="lineNoCov">          0 :         int stdGID = getushort(ttf);</span>
<span class="lineNum">    5687 </span>            :         int ptnum;
<span class="lineNum">    5688 </span><span class="lineNoCov">          0 :         if ( stdGID&gt;=info-&gt;glyph_cnt || (sc = info-&gt;chars[stdGID])==NULL )</span>
<span class="lineNum">    5689 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5690 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;32; ++i ) {</span>
<span class="lineNum">    5691 </span><span class="lineNoCov">          0 :             ptnum = getushort(ttf);</span>
<span class="lineNum">    5692 </span><span class="lineNoCov">          0 :             if ( ttfFindPointInSC(sc,ly_fore,ptnum,&amp;pos,NULL)!=-1 )</span>
<span class="lineNum">    5693 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    5694 </span><span class="lineNoCov">          0 :             offsets[i] = pos.y;</span>
<span class="lineNum">    5695 </span>            :         }
<span class="lineNum">    5696 </span>            :     }
<span class="lineNum">    5697 </span>            : 
<span class="lineNum">    5698 </span><span class="lineNoCov">          0 :     if ( format&amp;1 ) {</span>
<span class="lineNum">    5699 </span><span class="lineNoCov">          0 :         info-&gt;bsln_values = values = calloc(info-&gt;glyph_cnt,sizeof(uint16));</span>
<span class="lineNum">    5700 </span><span class="lineNoCov">          0 :         readttf_applelookup(ttf,info,</span>
<span class="lineNum">    5701 </span>            :                 bsln_apply_values,bsln_apply_value,
<span class="lineNum">    5702 </span><span class="lineNoCov">          0 :                 bsln_apply_default,(void *) (intpt) def, false);</span>
<span class="lineNum">    5703 </span>            :     } else
<span class="lineNum">    5704 </span><span class="lineNoCov">          0 :         values = NULL;</span>
<span class="lineNum">    5705 </span>            : 
<span class="lineNum">    5706 </span><span class="lineNoCov">          0 :     for ( i=1; i&lt;32; ++i ) mapping[i] = 3;           /* Roman */</span>
<span class="lineNum">    5707 </span>            : 
<span class="lineNum">    5708 </span><span class="lineNoCov">          0 :     info-&gt;horiz_base = base = chunkalloc(sizeof(struct Base));</span>
<span class="lineNum">    5709 </span><span class="lineNoCov">          0 :     base-&gt;baseline_cnt = 4;</span>
<span class="lineNum">    5710 </span><span class="lineNoCov">          0 :     base-&gt;baseline_tags = malloc(4*sizeof(uint32));</span>
<span class="lineNum">    5711 </span><span class="lineNoCov">          0 :     base-&gt;baseline_tags[0] = CHR('h','a','n','g');   /* Apple 3 */</span>
<span class="lineNum">    5712 </span><span class="lineNoCov">          0 :     if ( offsets[1]!= offsets[2] ) {</span>
<span class="lineNum">    5713 </span><span class="lineNoCov">          0 :         base-&gt;baseline_tags[1] = CHR('i','d','e','o');       /* Apple 2 */</span>
<span class="lineNum">    5714 </span><span class="lineNoCov">          0 :         base-&gt;baseline_tags[2] = CHR('m','a','t','h');       /* Apple 4 */</span>
<span class="lineNum">    5715 </span><span class="lineNoCov">          0 :         base-&gt;baseline_tags[3] = CHR('r','o','m','n');       /* Apple 0 */</span>
<span class="lineNum">    5716 </span>            : 
<span class="lineNum">    5717 </span>            :         /* Map from Apple's baseline indeces, to OT tag positions */
<span class="lineNum">    5718 </span><span class="lineNoCov">          0 :         mapping[3] = 0;</span>
<span class="lineNum">    5719 </span><span class="lineNoCov">          0 :         mapping[2] = 1;</span>
<span class="lineNum">    5720 </span><span class="lineNoCov">          0 :         mapping[4] = 2;</span>
<span class="lineNum">    5721 </span><span class="lineNoCov">          0 :         mapping[0] = 3;</span>
<span class="lineNum">    5722 </span>            :         /* Apple baseline 1 does not map to an OT tag */
<span class="lineNum">    5723 </span>            :         /* I assume baseline 1 is the normal baseline for CJK on Macs */
<span class="lineNum">    5724 </span>            :         /* (because baseline 2 often (and wrongly) contains the same value */
<span class="lineNum">    5725 </span>            :     } else {
<span class="lineNum">    5726 </span>            :         /* baseline 1 (centered ideographic) and baseline 2 (low ideographic) */
<span class="lineNum">    5727 </span>            :         /*  are documented to be different. Yet most of the fonts I have looked*/
<span class="lineNum">    5728 </span>            :         /*  at (and I've only got about 4 test cases) have the low ideographic*/
<span class="lineNum">    5729 </span>            :         /*  baseline set to the centered baseline. If I were to copy that to  */
<span class="lineNum">    5730 </span>            :         /*  OT it would be really bad. So even though baseline data is provided*/
<span class="lineNum">    5731 </span>            :         /*  I shall ignore it if it looks WRONG! */
<span class="lineNum">    5732 </span><span class="lineNoCov">          0 :         base-&gt;baseline_cnt = 3;</span>
<span class="lineNum">    5733 </span><span class="lineNoCov">          0 :         base-&gt;baseline_tags[1] = CHR('m','a','t','h');       /* Apple 4 */</span>
<span class="lineNum">    5734 </span><span class="lineNoCov">          0 :         base-&gt;baseline_tags[2] = CHR('r','o','m','n');       /* Apple 0 */</span>
<span class="lineNum">    5735 </span><span class="lineNoCov">          0 :         mapping[3] = 0;</span>
<span class="lineNum">    5736 </span><span class="lineNoCov">          0 :         mapping[4] = 1;</span>
<span class="lineNum">    5737 </span><span class="lineNoCov">          0 :         mapping[0] = 2;</span>
<span class="lineNum">    5738 </span>            :     }
<span class="lineNum">    5739 </span>            : 
<span class="lineNum">    5740 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;info-&gt;glyph_cnt; ++i ) if ( (sc=info-&gt;chars[i])!=NULL ) {</span>
<span class="lineNum">    5741 </span><span class="lineNoCov">          0 :         uint32 script = SCScriptFromUnicode(sc);</span>
<span class="lineNum">    5742 </span><span class="lineNoCov">          0 :         if ( script==DEFAULT_SCRIPT )</span>
<span class="lineNum">    5743 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    5744 </span><span class="lineNoCov">          0 :         for ( bs=base-&gt;scripts; bs!=NULL &amp;&amp; bs-&gt;script!=script; bs=bs-&gt;next );</span>
<span class="lineNum">    5745 </span><span class="lineNoCov">          0 :         if ( bs!=NULL )</span>
<span class="lineNum">    5746 </span><span class="lineNoCov">          0 :     continue;</span>
<span class="lineNum">    5747 </span><span class="lineNoCov">          0 :         bs = chunkalloc(sizeof(struct basescript));</span>
<span class="lineNum">    5748 </span><span class="lineNoCov">          0 :         bs-&gt;script = script;</span>
<span class="lineNum">    5749 </span><span class="lineNoCov">          0 :         ap_def = def;</span>
<span class="lineNum">    5750 </span><span class="lineNoCov">          0 :         if ( values!=NULL )</span>
<span class="lineNum">    5751 </span><span class="lineNoCov">          0 :             ap_def = values[i];</span>
<span class="lineNum">    5752 </span><span class="lineNoCov">          0 :         bs-&gt;def_baseline = mapping[ap_def];</span>
<span class="lineNum">    5753 </span><span class="lineNoCov">          0 :         bs-&gt;baseline_pos = malloc((base-&gt;baseline_cnt&lt;5?5:base-&gt;baseline_cnt)*sizeof(int16));</span>
<span class="lineNum">    5754 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;5; ++i ) if ( i!=1 )</span>
<span class="lineNum">    5755 </span><span class="lineNoCov">          0 :             bs-&gt;baseline_pos[mapping[i]] = offsets[i] - offsets[ap_def];</span>
<span class="lineNum">    5756 </span><span class="lineNoCov">          0 :         bs-&gt;next = base-&gt;scripts;</span>
<span class="lineNum">    5757 </span><span class="lineNoCov">          0 :         base-&gt;scripts = bs;</span>
<span class="lineNum">    5758 </span>            :     }
<a name="5759"><span class="lineNum">    5759 </span>            : }</a>
<span class="lineNum">    5760 </span>            : 
<span class="lineNum">    5761 </span><span class="lineNoCov">          0 : static char *jstf_read_extenders(FILE *ttf,uint32 spos,int extendOff,</span>
<span class="lineNum">    5762 </span>            :         struct ttfinfo *info) {
<span class="lineNum">    5763 </span>            :     uint16 *glyphs;
<span class="lineNum">    5764 </span>            :     int cnt, i;
<span class="lineNum">    5765 </span>            :     char *ret;
<span class="lineNum">    5766 </span>            : 
<span class="lineNum">    5767 </span><span class="lineNoCov">          0 :     if ( extendOff==0 )</span>
<span class="lineNum">    5768 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5769 </span><span class="lineNoCov">          0 :     if ( spos+extendOff+2&gt;info-&gt;g_bounds ) {</span>
<span class="lineNum">    5770 </span><span class="lineNoCov">          0 :         LogError( _(&quot;JSTF table is too long.\n&quot;) );</span>
<span class="lineNum">    5771 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    5772 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5773 </span>            :     }
<span class="lineNum">    5774 </span>            : 
<span class="lineNum">    5775 </span><span class="lineNoCov">          0 :     fseek(ttf,spos+extendOff,SEEK_SET);</span>
<span class="lineNum">    5776 </span><span class="lineNoCov">          0 :     cnt = getushort(ttf);</span>
<span class="lineNum">    5777 </span><span class="lineNoCov">          0 :     if ( spos+extendOff+2+2*cnt&gt;info-&gt;g_bounds || cnt&lt;0 ) {</span>
<span class="lineNum">    5778 </span><span class="lineNoCov">          0 :         LogError( _(&quot;JSTF table is too long.\n&quot;) );</span>
<span class="lineNum">    5779 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    5780 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5781 </span>            :     }
<span class="lineNum">    5782 </span><span class="lineNoCov">          0 :     if ( cnt==0 )</span>
<span class="lineNum">    5783 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5784 </span><span class="lineNoCov">          0 :     glyphs = malloc((cnt+1)*sizeof(uint16));</span>
<span class="lineNum">    5785 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    5786 </span><span class="lineNoCov">          0 :         glyphs[i] = getushort(ttf);</span>
<span class="lineNum">    5787 </span><span class="lineNoCov">          0 :         if ( glyphs[i]&gt;=info-&gt;glyph_cnt ) {</span>
<span class="lineNum">    5788 </span><span class="lineNoCov">          0 :             LogError( _(&quot;Bad GID in JSTF extenser table.\n&quot;) );</span>
<span class="lineNum">    5789 </span><span class="lineNoCov">          0 :             glyphs[i] = 0;</span>
<span class="lineNum">    5790 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    5791 </span>            :         }
<span class="lineNum">    5792 </span>            :     }
<span class="lineNum">    5793 </span><span class="lineNoCov">          0 :     glyphs[i] = 0xffff;</span>
<span class="lineNum">    5794 </span><span class="lineNoCov">          0 :     ret = GlyphsToNames(info,glyphs,false);</span>
<span class="lineNum">    5795 </span><span class="lineNoCov">          0 :     free(glyphs);</span>
<span class="lineNum">    5796 </span><span class="lineNoCov">          0 : return( ret );</span>
<a name="5797"><span class="lineNum">    5797 </span>            : }</a>
<span class="lineNum">    5798 </span>            : 
<span class="lineNum">    5799 </span><span class="lineNoCov">          0 : static OTLookup *findLookupByIndex(OTLookup *lookups,int index) {</span>
<span class="lineNum">    5800 </span>            : 
<span class="lineNum">    5801 </span><span class="lineNoCov">          0 :     while ( index&gt;0 ) {</span>
<span class="lineNum">    5802 </span><span class="lineNoCov">          0 :         if ( lookups==NULL )</span>
<span class="lineNum">    5803 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5804 </span><span class="lineNoCov">          0 :         lookups = lookups-&gt;next;</span>
<span class="lineNum">    5805 </span><span class="lineNoCov">          0 :         --index;</span>
<span class="lineNum">    5806 </span>            :     }
<span class="lineNum">    5807 </span><span class="lineNoCov">          0 : return( lookups );</span>
<a name="5808"><span class="lineNum">    5808 </span>            : }</a>
<span class="lineNum">    5809 </span>            : 
<span class="lineNum">    5810 </span><span class="lineNoCov">          0 : static OTLookup **jstf_subpos(FILE *ttf,uint32 base,int Sub,int Pos,</span>
<span class="lineNum">    5811 </span>            :         struct ttfinfo *info) {
<span class="lineNum">    5812 </span><span class="lineNoCov">          0 :     int scnt=0, pcnt=0;</span>
<span class="lineNum">    5813 </span>            :     OTLookup **ret;
<span class="lineNum">    5814 </span>            :     int i;
<span class="lineNum">    5815 </span>            : 
<span class="lineNum">    5816 </span><span class="lineNoCov">          0 :     if ( Sub&gt;0 ) {</span>
<span class="lineNum">    5817 </span><span class="lineNoCov">          0 :         fseek(ttf,base+Sub,SEEK_SET);</span>
<span class="lineNum">    5818 </span><span class="lineNoCov">          0 :         scnt = getushort(ttf);</span>
<span class="lineNum">    5819 </span><span class="lineNoCov">          0 :         if ( base+Sub+2+scnt*sizeof(int16)&gt;info-&gt;g_bounds || scnt&lt;0 ) {</span>
<span class="lineNum">    5820 </span><span class="lineNoCov">          0 :             LogError( _(&quot;JSTF table is too long.\n&quot;) );</span>
<span class="lineNum">    5821 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    5822 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5823 </span>            :         }
<span class="lineNum">    5824 </span>            :     }
<span class="lineNum">    5825 </span><span class="lineNoCov">          0 :     if ( Pos&gt;0 ) {</span>
<span class="lineNum">    5826 </span><span class="lineNoCov">          0 :         fseek(ttf,base+Pos,SEEK_SET);</span>
<span class="lineNum">    5827 </span><span class="lineNoCov">          0 :         pcnt = getushort(ttf);</span>
<span class="lineNum">    5828 </span><span class="lineNoCov">          0 :         if ( base+Pos+2+pcnt*sizeof(int16)&gt;info-&gt;g_bounds || pcnt&lt;0 ) {</span>
<span class="lineNum">    5829 </span><span class="lineNoCov">          0 :             LogError( _(&quot;JSTF table is too long.\n&quot;) );</span>
<span class="lineNum">    5830 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    5831 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5832 </span>            :         }
<span class="lineNum">    5833 </span>            :     }
<span class="lineNum">    5834 </span><span class="lineNoCov">          0 :     if ( scnt==0 &amp;&amp; pcnt==0 )</span>
<span class="lineNum">    5835 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5836 </span>            : 
<span class="lineNum">    5837 </span><span class="lineNoCov">          0 :     ret = malloc((scnt+pcnt+1)*sizeof(OTLookup *));</span>
<span class="lineNum">    5838 </span><span class="lineNoCov">          0 :     if ( Sub&gt;0 ) {</span>
<span class="lineNum">    5839 </span><span class="lineNoCov">          0 :         fseek(ttf,base+Sub+2,SEEK_SET);</span>
<span class="lineNum">    5840 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;scnt; ++i ) {</span>
<span class="lineNum">    5841 </span><span class="lineNoCov">          0 :             int index = getushort(ttf);</span>
<span class="lineNum">    5842 </span><span class="lineNoCov">          0 :             if ( index&lt;0 ) {</span>
<span class="lineNum">    5843 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;JSTF table is too long.\n&quot;) );</span>
<span class="lineNum">    5844 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    5845 </span><span class="lineNoCov">          0 :                 free(ret);</span>
<span class="lineNum">    5846 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5847 </span>            :             }
<span class="lineNum">    5848 </span><span class="lineNoCov">          0 :             ret[i] = findLookupByIndex(info-&gt;gsub_lookups,index);</span>
<span class="lineNum">    5849 </span><span class="lineNoCov">          0 :             if ( ret[i]==NULL ) {</span>
<span class="lineNum">    5850 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Lookup index (%d) out of bounds in GSUB from JSTF table.\n&quot;), index );</span>
<span class="lineNum">    5851 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    5852 </span><span class="lineNoCov">          0 :                 free(ret);</span>
<span class="lineNum">    5853 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5854 </span>            :             }
<span class="lineNum">    5855 </span>            :         }
<span class="lineNum">    5856 </span><span class="lineNoCov">          0 :         ret[i] = NULL;</span>
<span class="lineNum">    5857 </span>            :     }
<span class="lineNum">    5858 </span><span class="lineNoCov">          0 :     if ( Pos&gt;0 ) {</span>
<span class="lineNum">    5859 </span><span class="lineNoCov">          0 :         fseek(ttf,base+Pos+2,SEEK_SET);</span>
<span class="lineNum">    5860 </span><span class="lineNoCov">          0 :         for ( i=0; i&lt;pcnt; ++i ) {</span>
<span class="lineNum">    5861 </span><span class="lineNoCov">          0 :             int index = getushort(ttf);</span>
<span class="lineNum">    5862 </span><span class="lineNoCov">          0 :             if ( index&lt;0 ) {</span>
<span class="lineNum">    5863 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;JSTF table is too long.\n&quot;) );</span>
<span class="lineNum">    5864 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    5865 </span><span class="lineNoCov">          0 :                 free(ret);</span>
<span class="lineNum">    5866 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5867 </span>            :             }
<span class="lineNum">    5868 </span><span class="lineNoCov">          0 :             ret[i+scnt] = findLookupByIndex(info-&gt;gpos_lookups,index);</span>
<span class="lineNum">    5869 </span><span class="lineNoCov">          0 :             if ( ret[i+scnt]==NULL ) {</span>
<span class="lineNum">    5870 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;Lookup index (%d) out of bounds in GPOS from JSTF table.\n&quot;), index );</span>
<span class="lineNum">    5871 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    5872 </span><span class="lineNoCov">          0 :                 free(ret);</span>
<span class="lineNum">    5873 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5874 </span>            :             }
<span class="lineNum">    5875 </span>            :         }
<span class="lineNum">    5876 </span><span class="lineNoCov">          0 :         ret[i+scnt] = NULL;</span>
<span class="lineNum">    5877 </span>            :     }
<span class="lineNum">    5878 </span><span class="lineNoCov">          0 : return( ret );</span>
<a name="5879"><span class="lineNum">    5879 </span>            : }</a>
<span class="lineNum">    5880 </span>            : 
<span class="lineNum">    5881 </span><span class="lineNoCov">          0 : static void NameOTJSTFLookup(OTLookup *otl,struct ttfinfo *info) {</span>
<span class="lineNum">    5882 </span>            :     char buffer[300], *format;
<span class="lineNum">    5883 </span>            :     struct lookup_subtable *subtable;
<span class="lineNum">    5884 </span>            :     int cnt;
<span class="lineNum">    5885 </span>            : 
<span class="lineNum">    5886 </span><span class="lineNoCov">          0 :     if ( info-&gt;jstf_isShrink )</span>
<span class="lineNum">    5887 </span>            : /* GT: This string is used to generate a name for an OpenType lookup. */
<span class="lineNum">    5888 </span>            : /* GT:  the %c%c... is the language followed by the script (OT tags) */
<span class="lineNum">    5889 </span><span class="lineNoCov">          0 :         snprintf(buffer,sizeof(buffer), _(&quot;JSTF shrinkage max at priority %d #%d for %c%c%c%c in %c%c%c%c&quot;),</span>
<span class="lineNum">    5890 </span><span class="lineNoCov">          0 :                 info-&gt;jstf_prio, info-&gt;jstf_lcnt++,</span>
<span class="lineNum">    5891 </span><span class="lineNoCov">          0 :                 info-&gt;jstf_lang&gt;&gt;24,</span>
<span class="lineNum">    5892 </span><span class="lineNoCov">          0 :                  info-&gt;jstf_lang&gt;&gt;16,</span>
<span class="lineNum">    5893 </span><span class="lineNoCov">          0 :                  info-&gt;jstf_lang&gt;&gt;8,</span>
<span class="lineNum">    5894 </span>            :                  info-&gt;jstf_lang,
<span class="lineNum">    5895 </span><span class="lineNoCov">          0 :                 info-&gt;jstf_script&gt;&gt;24,</span>
<span class="lineNum">    5896 </span><span class="lineNoCov">          0 :                  info-&gt;jstf_script&gt;&gt;16,</span>
<span class="lineNum">    5897 </span><span class="lineNoCov">          0 :                  info-&gt;jstf_script&gt;&gt;8,</span>
<span class="lineNum">    5898 </span>            :                  info-&gt;jstf_script );
<span class="lineNum">    5899 </span>            :      else
<span class="lineNum">    5900 </span><span class="lineNoCov">          0 :         snprintf(buffer,sizeof(buffer), _(&quot;JSTF extension max at priority %d #%d for %c%c%c%c in %c%c%c%c&quot;),</span>
<span class="lineNum">    5901 </span><span class="lineNoCov">          0 :                 info-&gt;jstf_prio, info-&gt;jstf_lcnt++,</span>
<span class="lineNum">    5902 </span><span class="lineNoCov">          0 :                 info-&gt;jstf_lang&gt;&gt;24,</span>
<span class="lineNum">    5903 </span><span class="lineNoCov">          0 :                  info-&gt;jstf_lang&gt;&gt;16,</span>
<span class="lineNum">    5904 </span><span class="lineNoCov">          0 :                  info-&gt;jstf_lang&gt;&gt;8,</span>
<span class="lineNum">    5905 </span>            :                  info-&gt;jstf_lang,
<span class="lineNum">    5906 </span><span class="lineNoCov">          0 :                 info-&gt;jstf_script&gt;&gt;24,</span>
<span class="lineNum">    5907 </span><span class="lineNoCov">          0 :                  info-&gt;jstf_script&gt;&gt;16,</span>
<span class="lineNum">    5908 </span><span class="lineNoCov">          0 :                  info-&gt;jstf_script&gt;&gt;8,</span>
<span class="lineNum">    5909 </span>            :                  info-&gt;jstf_script );
<span class="lineNum">    5910 </span><span class="lineNoCov">          0 :     otl-&gt;lookup_name = copy(buffer);</span>
<span class="lineNum">    5911 </span>            : 
<span class="lineNum">    5912 </span><span class="lineNoCov">          0 :     cnt = 0;</span>
<span class="lineNum">    5913 </span><span class="lineNoCov">          0 :     for ( subtable = otl-&gt;subtables; subtable!=NULL; subtable=subtable-&gt;next, ++cnt ) {</span>
<span class="lineNum">    5914 </span><span class="lineNoCov">          0 :         if ( subtable-&gt;subtable_name==NULL ) {</span>
<span class="lineNum">    5915 </span><span class="lineNoCov">          0 :             if ( subtable==otl-&gt;subtables &amp;&amp; subtable-&gt;next==NULL )</span>
<span class="lineNum">    5916 </span><span class="lineNoCov">          0 :                 format = _(&quot;%s subtable&quot;);</span>
<span class="lineNum">    5917 </span>            :             else
<span class="lineNum">    5918 </span><span class="lineNoCov">          0 :                 format = _(&quot;%s subtable %d&quot;);</span>
<span class="lineNum">    5919 </span><span class="lineNoCov">          0 :             snprintf(buffer,sizeof(buffer),format,otl-&gt;lookup_name,cnt );</span>
<span class="lineNum">    5920 </span><span class="lineNoCov">          0 :             subtable-&gt;subtable_name=copy(buffer);</span>
<span class="lineNum">    5921 </span>            :         }
<span class="lineNum">    5922 </span>            :     }
<a name="5923"><span class="lineNum">    5923 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5924 </span>            : 
<span class="lineNum">    5925 </span><span class="lineNoCov">          0 : static OTLookup **jstf_processlookups(FILE *ttf,uint32 base,int lookup_off,</span>
<span class="lineNum">    5926 </span>            :         struct ttfinfo *info) {
<span class="lineNum">    5927 </span>            :     OTLookup **ret;
<span class="lineNum">    5928 </span>            :     struct lookup *lookups, *l;
<span class="lineNum">    5929 </span>            :     struct lookup_subtable *subtable;
<span class="lineNum">    5930 </span>            :     int cnt,k;
<span class="lineNum">    5931 </span>            :     int32 st;
<span class="lineNum">    5932 </span>            : 
<span class="lineNum">    5933 </span><span class="lineNoCov">          0 :     if ( lookup_off==0 )</span>
<span class="lineNum">    5934 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5935 </span><span class="lineNoCov">          0 :     lookups = readttflookups(ttf,base+lookup_off,info,2);</span>
<span class="lineNum">    5936 </span>            : 
<span class="lineNum">    5937 </span><span class="lineNoCov">          0 :     if ( lookups==NULL )</span>
<span class="lineNum">    5938 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5939 </span>            : 
<span class="lineNum">    5940 </span><span class="lineNoCov">          0 :     for ( l = lookups, cnt=0; l-&gt;offset!=0; ++l, ++cnt ) {</span>
<span class="lineNum">    5941 </span><span class="lineNoCov">          0 :         for ( k=0, subtable=l-&gt;otlookup-&gt;subtables; k&lt;l-&gt;subtabcnt; ++k, subtable=subtable-&gt;next ) {</span>
<span class="lineNum">    5942 </span><span class="lineNoCov">          0 :             st = l-&gt;subtab_offsets[k];</span>
<span class="lineNum">    5943 </span><span class="lineNoCov">          0 :             fseek(ttf,st,SEEK_SET);</span>
<span class="lineNum">    5944 </span><span class="lineNoCov">          0 :             gposLookupSwitch(ttf,st,info,l,subtable,lookups);</span>
<span class="lineNum">    5945 </span>            :         }
<span class="lineNum">    5946 </span>            :     }
<span class="lineNum">    5947 </span><span class="lineNoCov">          0 :     ret = malloc((cnt+1)*sizeof(OTLookup*));</span>
<span class="lineNum">    5948 </span>            : 
<span class="lineNum">    5949 </span><span class="lineNoCov">          0 :     for ( l=lookups, cnt=0; l-&gt;offset!=0; ++l, ++cnt ) {</span>
<span class="lineNum">    5950 </span><span class="lineNoCov">          0 :         NameOTJSTFLookup(l-&gt;otlookup,info);</span>
<span class="lineNum">    5951 </span><span class="lineNoCov">          0 :         ret[cnt] = l-&gt;otlookup;</span>
<span class="lineNum">    5952 </span>            :     }
<span class="lineNum">    5953 </span><span class="lineNoCov">          0 :     ret[cnt] = NULL;</span>
<span class="lineNum">    5954 </span><span class="lineNoCov">          0 :     LookupsFree(lookups);</span>
<span class="lineNum">    5955 </span><span class="lineNoCov">          0 : return( ret );</span>
<a name="5956"><span class="lineNum">    5956 </span>            : }</a>
<span class="lineNum">    5957 </span>            : 
<span class="lineNum">    5958 </span><span class="lineNoCov">          0 : static struct jstf_lang *jstf_lang(FILE *ttf,uint32 base,</span>
<span class="lineNum">    5959 </span>            :         int off, uint32 tag, struct ttfinfo *info) {
<span class="lineNum">    5960 </span>            :     int cnt,i;
<span class="lineNum">    5961 </span>            :     struct jstf_lang *ret;
<span class="lineNum">    5962 </span>            : 
<span class="lineNum">    5963 </span><span class="lineNoCov">          0 :     if ( off&lt;=0 )</span>
<span class="lineNum">    5964 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5965 </span><span class="lineNoCov">          0 :     if ( base+off+2&gt;info-&gt;g_bounds ) {</span>
<span class="lineNum">    5966 </span><span class="lineNoCov">          0 :         LogError( _(&quot;JSTF table is too long.\n&quot;) );</span>
<span class="lineNum">    5967 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    5968 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5969 </span>            :     }
<span class="lineNum">    5970 </span><span class="lineNoCov">          0 :     fseek(ttf,base+off,SEEK_SET);</span>
<span class="lineNum">    5971 </span><span class="lineNoCov">          0 :     cnt = getushort(ttf);</span>
<span class="lineNum">    5972 </span><span class="lineNoCov">          0 :     if ( base+off+2+2*cnt&gt;info-&gt;g_bounds || cnt&lt;0 ) {</span>
<span class="lineNum">    5973 </span><span class="lineNoCov">          0 :         LogError( _(&quot;JSTF table is too long.\n&quot;) );</span>
<span class="lineNum">    5974 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    5975 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5976 </span>            :     }
<span class="lineNum">    5977 </span><span class="lineNoCov">          0 :     if ( cnt==0 )</span>
<span class="lineNum">    5978 </span><span class="lineNoCov">          0 : return( NULL );</span>
<span class="lineNum">    5979 </span>            : 
<span class="lineNum">    5980 </span><span class="lineNoCov">          0 :     ret = chunkalloc(sizeof(struct jstf_lang));</span>
<span class="lineNum">    5981 </span><span class="lineNoCov">          0 :     ret-&gt;lang = info-&gt;jstf_lang = tag;</span>
<span class="lineNum">    5982 </span><span class="lineNoCov">          0 :     ret-&gt;cnt = cnt;</span>
<span class="lineNum">    5983 </span><span class="lineNoCov">          0 :     ret-&gt;prios = calloc(cnt,sizeof(struct jstf_prio));</span>
<span class="lineNum">    5984 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cnt; ++i )</span>
<span class="lineNum">    5985 </span><span class="lineNoCov">          0 :         ret-&gt;prios[i].maxExtend = (void *) (intpt) getushort(ttf);</span>
<span class="lineNum">    5986 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;cnt; ++i ) {</span>
<span class="lineNum">    5987 </span>            :         int enSub, disSub, enPos, disPos, maxShrink, maxExtend;
<span class="lineNum">    5988 </span>            :         int enSub2, disSub2, enPos2, disPos2;
<span class="lineNum">    5989 </span><span class="lineNoCov">          0 :         uint32 pbase = base+off+(intpt) ret-&gt;prios[i].maxExtend;</span>
<span class="lineNum">    5990 </span><span class="lineNoCov">          0 :         fseek(ttf,pbase,SEEK_SET);</span>
<span class="lineNum">    5991 </span><span class="lineNoCov">          0 :         info-&gt;jstf_prio = i;</span>
<span class="lineNum">    5992 </span><span class="lineNoCov">          0 :         enSub = getushort(ttf);</span>
<span class="lineNum">    5993 </span><span class="lineNoCov">          0 :         disSub = getushort(ttf);</span>
<span class="lineNum">    5994 </span><span class="lineNoCov">          0 :         enPos = getushort(ttf);</span>
<span class="lineNum">    5995 </span><span class="lineNoCov">          0 :         disPos = getushort(ttf);</span>
<span class="lineNum">    5996 </span><span class="lineNoCov">          0 :         maxShrink = getushort(ttf);</span>
<span class="lineNum">    5997 </span><span class="lineNoCov">          0 :         enSub2 = getushort(ttf);</span>
<span class="lineNum">    5998 </span><span class="lineNoCov">          0 :         disSub2 = getushort(ttf);</span>
<span class="lineNum">    5999 </span><span class="lineNoCov">          0 :         enPos2 = getushort(ttf);</span>
<span class="lineNum">    6000 </span><span class="lineNoCov">          0 :         disPos2 = getushort(ttf);</span>
<span class="lineNum">    6001 </span><span class="lineNoCov">          0 :         maxExtend = getushort(ttf);</span>
<span class="lineNum">    6002 </span><span class="lineNoCov">          0 :         ret-&gt;prios[i].enableShrink = jstf_subpos(ttf,pbase,enSub,enPos, info);</span>
<span class="lineNum">    6003 </span><span class="lineNoCov">          0 :         ret-&gt;prios[i].disableShrink = jstf_subpos(ttf,pbase,disSub,disPos, info);</span>
<span class="lineNum">    6004 </span><span class="lineNoCov">          0 :         ret-&gt;prios[i].enableExtend = jstf_subpos(ttf,pbase,enSub2,enPos2, info);</span>
<span class="lineNum">    6005 </span><span class="lineNoCov">          0 :         ret-&gt;prios[i].disableExtend = jstf_subpos(ttf,pbase,disSub2,disPos2, info);</span>
<span class="lineNum">    6006 </span>            : 
<span class="lineNum">    6007 </span><span class="lineNoCov">          0 :         info-&gt;jstf_isShrink = true;</span>
<span class="lineNum">    6008 </span><span class="lineNoCov">          0 :         ret-&gt;prios[i].maxShrink = jstf_processlookups(ttf,pbase,maxShrink, info);</span>
<span class="lineNum">    6009 </span><span class="lineNoCov">          0 :         info-&gt;jstf_isShrink = false;</span>
<span class="lineNum">    6010 </span><span class="lineNoCov">          0 :         ret-&gt;prios[i].maxExtend = jstf_processlookups(ttf,pbase,maxExtend, info);</span>
<span class="lineNum">    6011 </span>            :     }
<span class="lineNum">    6012 </span><span class="lineNoCov">          0 : return( ret );</span>
<a name="6013"><span class="lineNum">    6013 </span>            : }</a>
<span class="lineNum">    6014 </span>            : 
<span class="lineNum">    6015 </span><span class="lineNoCov">          0 : void readttfjstf(FILE *ttf,struct ttfinfo *info) {</span>
<span class="lineNum">    6016 </span>            :     int version;
<span class="lineNum">    6017 </span>            :     int scnt, lcnt, lmax;
<span class="lineNum">    6018 </span>            :     int i,j;
<span class="lineNum">    6019 </span>            :     struct tagoff { uint32 tag; int offset; } *soff, *loff;
<span class="lineNum">    6020 </span><span class="lineNoCov">          0 :     Justify *last=NULL, *cur;</span>
<span class="lineNum">    6021 </span>            :     struct jstf_lang *llast, *lcur;
<span class="lineNum">    6022 </span>            :     int extendOff, defOff;
<span class="lineNum">    6023 </span>            :     
<span class="lineNum">    6024 </span><span class="lineNoCov">          0 :     if ( info-&gt;jstf_start==0 )</span>
<span class="lineNum">    6025 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    6026 </span><span class="lineNoCov">          0 :     fseek(ttf,info-&gt;jstf_start,SEEK_SET);</span>
<span class="lineNum">    6027 </span><span class="lineNoCov">          0 :     info-&gt;g_bounds = info-&gt;jstf_start + info-&gt;jstf_length;</span>
<span class="lineNum">    6028 </span>            : 
<span class="lineNum">    6029 </span><span class="lineNoCov">          0 :     version = getlong(ttf);</span>
<span class="lineNum">    6030 </span><span class="lineNoCov">          0 :     if ( version!=0x00010000 )</span>
<span class="lineNum">    6031 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    6032 </span><span class="lineNoCov">          0 :     scnt = getushort(ttf);</span>
<span class="lineNum">    6033 </span><span class="lineNoCov">          0 :     if ( scnt&lt;0 || scnt&gt;1000 ) {</span>
<span class="lineNum">    6034 </span><span class="lineNoCov">          0 :         LogError( _(&quot;Unlikely script count (%d), I suspect the JSTF-\n table is garbage, I'm giving up on it.\n&quot;), scnt );</span>
<span class="lineNum">    6035 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    6036 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    6037 </span>            :     }
<span class="lineNum">    6038 </span><span class="lineNoCov">          0 :     soff = malloc(scnt*sizeof(struct tagoff));</span>
<span class="lineNum">    6039 </span>            : 
<span class="lineNum">    6040 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;scnt; ++i ) {</span>
<span class="lineNum">    6041 </span><span class="lineNoCov">          0 :         soff[i].tag    = getlong(ttf);</span>
<span class="lineNum">    6042 </span><span class="lineNoCov">          0 :         soff[i].offset = getushort(ttf);</span>
<span class="lineNum">    6043 </span><span class="lineNoCov">          0 :         if ( soff[i].offset&lt;0 ) {</span>
<span class="lineNum">    6044 </span><span class="lineNoCov">          0 :             LogError( _(&quot;End of file found in JSTF table.\n&quot;) );</span>
<span class="lineNum">    6045 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    6046 </span><span class="lineNoCov">          0 :             free(soff);</span>
<span class="lineNum">    6047 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    6048 </span>            :         }
<span class="lineNum">    6049 </span>            :     }
<span class="lineNum">    6050 </span><span class="lineNoCov">          0 :     if ( ftell(ttf)&gt;info-&gt;g_bounds ) {</span>
<span class="lineNum">    6051 </span><span class="lineNoCov">          0 :         LogError( _(&quot;JSTF table is too long.\n&quot;) );</span>
<span class="lineNum">    6052 </span><span class="lineNoCov">          0 :         info-&gt;bad_ot = true;</span>
<span class="lineNum">    6053 </span><span class="lineNoCov">          0 :         free(soff);</span>
<span class="lineNum">    6054 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    6055 </span>            :     }
<span class="lineNum">    6056 </span><span class="lineNoCov">          0 :     lmax = 0; loff = NULL;</span>
<span class="lineNum">    6057 </span><span class="lineNoCov">          0 :     for ( i=0; i&lt;scnt; ++i ) {</span>
<span class="lineNum">    6058 </span><span class="lineNoCov">          0 :         fseek(ttf,info-&gt;jstf_start+soff[i].offset,SEEK_SET);</span>
<span class="lineNum">    6059 </span><span class="lineNoCov">          0 :         extendOff = getushort(ttf);</span>
<span class="lineNum">    6060 </span><span class="lineNoCov">          0 :         defOff = getushort(ttf);</span>
<span class="lineNum">    6061 </span><span class="lineNoCov">          0 :         lcnt = getushort(ttf);</span>
<span class="lineNum">    6062 </span><span class="lineNoCov">          0 :         if ( info-&gt;jstf_start+soff[i].offset &gt; info-&gt;g_bounds-6-6*lcnt || lcnt&lt;0 ) {</span>
<span class="lineNum">    6063 </span><span class="lineNoCov">          0 :             LogError( _(&quot;JSTF table is too long.\n&quot;) );</span>
<span class="lineNum">    6064 </span><span class="lineNoCov">          0 :             info-&gt;bad_ot = true;</span>
<span class="lineNum">    6065 </span><span class="lineNoCov">          0 :             free(soff);</span>
<span class="lineNum">    6066 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    6067 </span>            :         }
<span class="lineNum">    6068 </span>            : 
<span class="lineNum">    6069 </span><span class="lineNoCov">          0 :         if ( lcnt&gt;lmax )</span>
<span class="lineNum">    6070 </span><span class="lineNoCov">          0 :             loff = realloc(loff,(lmax=lcnt)*sizeof(struct tagoff));</span>
<span class="lineNum">    6071 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;lcnt; ++j ) {</span>
<span class="lineNum">    6072 </span><span class="lineNoCov">          0 :             loff[j].tag    = getlong(ttf);</span>
<span class="lineNum">    6073 </span><span class="lineNoCov">          0 :             loff[j].offset = getushort(ttf);</span>
<span class="lineNum">    6074 </span><span class="lineNoCov">          0 :             if ( loff[j].offset&lt;0 ) {</span>
<span class="lineNum">    6075 </span><span class="lineNoCov">          0 :                 LogError( _(&quot;End of file found in JSTF table.\n&quot;) );</span>
<span class="lineNum">    6076 </span><span class="lineNoCov">          0 :                 info-&gt;bad_ot = true;</span>
<span class="lineNum">    6077 </span><span class="lineNoCov">          0 :                 free(soff);</span>
<span class="lineNum">    6078 </span><span class="lineNoCov">          0 :                 free(loff);</span>
<span class="lineNum">    6079 </span><span class="lineNoCov">          0 : return;</span>
<span class="lineNum">    6080 </span>            :             }
<span class="lineNum">    6081 </span>            :         }
<span class="lineNum">    6082 </span>            : 
<span class="lineNum">    6083 </span><span class="lineNoCov">          0 :         cur = chunkalloc(sizeof(Justify));</span>
<span class="lineNum">    6084 </span><span class="lineNoCov">          0 :         cur-&gt;script = info-&gt;jstf_script = soff[i].tag;</span>
<span class="lineNum">    6085 </span><span class="lineNoCov">          0 :         if ( last==NULL )</span>
<span class="lineNum">    6086 </span><span class="lineNoCov">          0 :             info-&gt;justify = cur;</span>
<span class="lineNum">    6087 </span>            :         else
<span class="lineNum">    6088 </span><span class="lineNoCov">          0 :             last-&gt;next = cur;</span>
<span class="lineNum">    6089 </span><span class="lineNoCov">          0 :         last = cur;</span>
<span class="lineNum">    6090 </span><span class="lineNoCov">          0 :         cur-&gt;extenders = jstf_read_extenders(ttf,info-&gt;jstf_start+soff[i].offset,extendOff, info);</span>
<span class="lineNum">    6091 </span><span class="lineNoCov">          0 :         llast = NULL;</span>
<span class="lineNum">    6092 </span><span class="lineNoCov">          0 :         if ( defOff!=0 )</span>
<span class="lineNum">    6093 </span><span class="lineNoCov">          0 :             llast = cur-&gt;langs = jstf_lang(ttf,info-&gt;jstf_start+soff[i].offset,defOff,DEFAULT_LANG, info);</span>
<span class="lineNum">    6094 </span><span class="lineNoCov">          0 :         for ( j=0; j&lt;lcnt; ++j ) {</span>
<span class="lineNum">    6095 </span><span class="lineNoCov">          0 :             lcur = jstf_lang(ttf,info-&gt;jstf_start+soff[i].offset,</span>
<span class="lineNum">    6096 </span><span class="lineNoCov">          0 :                     loff[j].offset, loff[j].tag, info);</span>
<span class="lineNum">    6097 </span><span class="lineNoCov">          0 :             if ( lcur!=NULL ) {</span>
<span class="lineNum">    6098 </span><span class="lineNoCov">          0 :                 if ( llast==NULL )</span>
<span class="lineNum">    6099 </span><span class="lineNoCov">          0 :                     cur-&gt;langs = lcur;</span>
<span class="lineNum">    6100 </span>            :                 else
<span class="lineNum">    6101 </span><span class="lineNoCov">          0 :                     llast-&gt;next = lcur;</span>
<span class="lineNum">    6102 </span><span class="lineNoCov">          0 :                 llast = lcur;</span>
<span class="lineNum">    6103 </span>            :             }
<span class="lineNum">    6104 </span>            :         }
<span class="lineNum">    6105 </span>            :     }
<span class="lineNum">    6106 </span>            : 
<span class="lineNum">    6107 </span><span class="lineNoCov">          0 :     free(loff);</span>
<span class="lineNum">    6108 </span><span class="lineNoCov">          0 :     free(soff);</span>
<span class="lineNum">    6109 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
